import{r as g,c as nE,R as ts,_ as sE,g as rE,P as ja,a as C4,b as _4}from"./index-DGvUaqb8.js";import{D as bi,V as Q,a as De,P as jt,O as Ai,b as Nc,c as Xs,M as we,Q as st,d as Fn,S as wa,e as yi,C as We,E as kn,T as S4,f as tt,R as Kh,g as ze,I as Zm,h as Vr,i as Di,F as ri,j as zn,N as ei,B as Vt,k as T4,l as G0,m as oE,n as Gi,o as nn,p as hn,q as Ii,r as Oa,U as Ba,s as Br,t as b4,A as aE,u as yh,v as vh,w as eA,x as w4,y as ha,z as gi,G as $h,H as Cs,L as ga,J as Wn,K as Yi,W as bt,X as ln,Y as jr,Z as lE,_ as Gc,$ as xs,a0 as Mr,a1 as Ua,a2 as mr,a3 as Jt,a4 as Of,a5 as B4,a6 as xi,a7 as Nt,a8 as tA,a9 as R4,aa as Yr,ab as ya,ac as Sn,ad as os,ae as cE,af as Q0,ag as uE,ah as oc,ai as pr,aj as D4,ak as M4,al as Cc,am as L4,an as P4,ao as F4,ap as k4,aq as On,ar as hE,as as eh,at as Yh,au as ac,av as iA,aw as O4,ax as U4,ay as N4,az as fE,aA as z0,aB as G4,aC as dE,aD as lo,aE as tn,aF as H0,aG as lc,aH as Q4,aI as z4,aJ as mE,aK as H4,aL as Uf,aM as nA,aN as AE,aO as V4,aP as K4,aQ as Rr,aR as Wh,aS as pE,aT as $i,aU as Np,aV as Vs,aW as fa,aX as ui,aY as $4,aZ as Y4,a_ as W4,a$ as j4,b0 as q4,b1 as X4,b2 as J4,b3 as Z4,b4 as e_,b5 as gE,b6 as da,b7 as t_,b8 as i_,b9 as yE,ba as Nf,bb as sA,bc as V0,bd as n_,be as K0,bf as $s,bg as s_,bh as r_,bi as vE,bj as o_,bk as a_,bl as l_,bm as EE,bn as xE,bo as ma,bp as c_,bq as IE,br as u_,bs as CE,bt as Eh,bu as ho,bv as jh,bw as qh,bx as _E,by as h_,bz as Wr,bA as SE,bB as rA,bC as f_,bD as TE,bE as oA,bF as Xh,bG as bE,bH as d_,bI as th,bJ as $0,bK as wE,bL as BE,bM as m_,bN as Dn,bO as A_,bP as xh,bQ as p_,bR as Y0,bS as g_,bT as Gp,bU as y_,bV as v_,bW as E_,bX as x_,bY as Gf,bZ as I_,b_ as Qf,b$ as C_,c0 as __,c1 as S_}from"./three.module-Ct5vMUww.js";import{H as ae,A as Ve,n as W0,h as aA,l as Un,F as hi,I as Er,J as T_,K as Jh,e as Ci,p as vo,g as lA}from"./events-776716bd.esm-CpH0TVUg.js";function Ae(){return Ae=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(r[i]=t[i])}return r},Ae.apply(null,arguments)}const _c=new Q,cA=new Q,b_=new Q,Qp=new De;function w_(r,e,t){const i=_c.setFromMatrixPosition(r.matrixWorld);i.project(e);const n=t.width/2,s=t.height/2;return[i.x*n+n,-(i.y*s)+s]}function B_(r,e){const t=_c.setFromMatrixPosition(r.matrixWorld),i=cA.setFromMatrixPosition(e.matrixWorld),n=t.sub(i),s=e.getWorldDirection(b_);return n.angleTo(s)>Math.PI/2}function R_(r,e,t,i){const n=_c.setFromMatrixPosition(r.matrixWorld),s=n.clone();s.project(e),Qp.set(s.x,s.y),t.setFromCamera(Qp,e);const o=t.intersectObjects(i,!0);if(o.length){const a=o[0].distance;return n.distanceTo(t.ray.origin)<a}return!0}function D_(r,e){if(e instanceof Ai)return e.zoom;if(e instanceof jt){const t=_c.setFromMatrixPosition(r.matrixWorld),i=cA.setFromMatrixPosition(e.matrixWorld),n=e.fov*Math.PI/180,s=t.distanceTo(i);return 1/(2*Math.tan(n/2)*s)}else return 1}function M_(r,e,t){if(e instanceof jt||e instanceof Ai){const i=_c.setFromMatrixPosition(r.matrixWorld),n=cA.setFromMatrixPosition(e.matrixWorld),s=i.distanceTo(n),o=(t[1]-t[0])/(e.far-e.near),a=t[1]-o*e.far;return Math.round(o*s+a)}}const j0=r=>Math.abs(r)<1e-10?0:r;function RE(r,e,t=""){let i="matrix3d(";for(let n=0;n!==16;n++)i+=j0(e[n]*r.elements[n])+(n!==15?",":")");return t+i}const L_=(r=>e=>RE(e,r))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),P_=(r=>(e,t)=>RE(e,r(t),"translate(-50%,-50%)"))(r=>[1/r,1/r,1/r,1,-1/r,-1/r,-1/r,-1,1/r,1/r,1/r,1,1,1,1,1]);function F_(r){return r&&typeof r=="object"&&"current"in r}const Zh=g.forwardRef(({children:r,eps:e=.001,style:t,className:i,prepend:n,center:s,fullscreen:o,portal:a,distanceFactor:l,sprite:c=!1,transform:u=!1,occlude:h,onOcclude:f,castShadow:d,receiveShadow:m,material:A,geometry:p,zIndexRange:y=[16777271,0],calculatePosition:v=w_,as:E="div",wrapperClass:x,pointerEvents:I="auto",...C},_)=>{const{gl:S,camera:b,scene:T,size:R,raycaster:w,events:B,viewport:M}=ae(),[O]=g.useState(()=>document.createElement(E)),U=g.useRef(),Y=g.useRef(null),W=g.useRef(0),N=g.useRef([0,0]),K=g.useRef(null),D=g.useRef(null),z=a?.current||B.connected||S.domElement.parentNode,$=g.useRef(null),V=g.useRef(!1),P=g.useMemo(()=>h&&h!=="blending"||Array.isArray(h)&&h.length&&F_(h[0]),[h]);g.useLayoutEffect(()=>{const ne=S.domElement;h&&h==="blending"?(ne.style.zIndex=`${Math.floor(y[0]/2)}`,ne.style.position="absolute",ne.style.pointerEvents="none"):(ne.style.zIndex=null,ne.style.position=null,ne.style.pointerEvents=null)},[h]),g.useLayoutEffect(()=>{if(Y.current){const ne=U.current=nE.createRoot(O);if(T.updateMatrixWorld(),u)O.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const X=v(Y.current,b,R);O.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${X[0]}px,${X[1]}px,0);transform-origin:0 0;`}return z&&(n?z.prepend(O):z.appendChild(O)),()=>{z&&z.removeChild(O),ne.unmount()}}},[z,u]),g.useLayoutEffect(()=>{x&&(O.className=x)},[x]);const G=g.useMemo(()=>u?{position:"absolute",top:0,left:0,width:R.width,height:R.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:s?"translate3d(-50%,-50%,0)":"none",...o&&{top:-R.height/2,left:-R.width/2,width:R.width,height:R.height},...t},[t,s,o,R,u]),F=g.useMemo(()=>({position:"absolute",pointerEvents:I}),[I]);g.useLayoutEffect(()=>{if(V.current=!1,u){var ne;(ne=U.current)==null||ne.render(g.createElement("div",{ref:K,style:G},g.createElement("div",{ref:D,style:F},g.createElement("div",{ref:_,className:i,style:t,children:r}))))}else{var X;(X=U.current)==null||X.render(g.createElement("div",{ref:_,style:G,className:i,children:r}))}});const k=g.useRef(!0);Ve(ne=>{if(Y.current){b.updateMatrixWorld(),Y.current.updateWorldMatrix(!0,!1);const X=u?N.current:v(Y.current,b,R);if(u||Math.abs(W.current-b.zoom)>e||Math.abs(N.current[0]-X[0])>e||Math.abs(N.current[1]-X[1])>e){const te=B_(Y.current,b);let ye=!1;P&&(Array.isArray(h)?ye=h.map(he=>he.current):h!=="blending"&&(ye=[T]));const ve=k.current;if(ye){const he=R_(Y.current,b,w,ye);k.current=he&&!te}else k.current=!te;ve!==k.current&&(f?f(!k.current):O.style.display=k.current?"block":"none");const re=Math.floor(y[0]/2),se=h?P?[y[0],re]:[re-1,0]:y;if(O.style.zIndex=`${M_(Y.current,b,se)}`,u){const[he,le]=[R.width/2,R.height/2],J=b.projectionMatrix.elements[5]*le,{isOrthographicCamera:q,top:oe,left:Ie,bottom:_e,right:Be}=b,Se=L_(b.matrixWorldInverse),Ke=q?`scale(${J})translate(${j0(-(Be+Ie)/2)}px,${j0((oe+_e)/2)}px)`:`translateZ(${J}px)`;let Me=Y.current.matrixWorld;c&&(Me=b.matrixWorldInverse.clone().transpose().copyPosition(Me).scale(Y.current.scale),Me.elements[3]=Me.elements[7]=Me.elements[11]=0,Me.elements[15]=1),O.style.width=R.width+"px",O.style.height=R.height+"px",O.style.perspective=q?"":`${J}px`,K.current&&D.current&&(K.current.style.transform=`${Ke}${Se}translate(${he}px,${le}px)`,D.current.style.transform=P_(Me,1/((l||10)/400)))}else{const he=l===void 0?1:D_(Y.current,b)*l;O.style.transform=`translate3d(${X[0]}px,${X[1]}px,0) scale(${he})`}N.current=X,W.current=b.zoom}}if(!P&&$.current&&!V.current)if(u){if(K.current){const X=K.current.children[0];if(X!=null&&X.clientWidth&&X!=null&&X.clientHeight){const{isOrthographicCamera:te}=b;if(te||p)C.scale&&(Array.isArray(C.scale)?C.scale instanceof Q?$.current.scale.copy(C.scale.clone().divideScalar(1)):$.current.scale.set(1/C.scale[0],1/C.scale[1],1/C.scale[2]):$.current.scale.setScalar(1/C.scale));else{const ye=(l||10)/400,ve=X.clientWidth*ye,re=X.clientHeight*ye;$.current.scale.set(ve,re,1)}V.current=!0}}}else{const X=O.children[0];if(X!=null&&X.clientWidth&&X!=null&&X.clientHeight){const te=1/M.factor,ye=X.clientWidth*te,ve=X.clientHeight*te;$.current.scale.set(ye,ve,1),V.current=!0}$.current.lookAt(ne.camera.position)}});const Z=g.useMemo(()=>({vertexShader:u?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[u]);return g.createElement("group",Ae({},C,{ref:Y}),h&&!P&&g.createElement("mesh",{castShadow:d,receiveShadow:m,ref:$},p||g.createElement("planeGeometry",null),A||g.createElement("shaderMaterial",{side:bi,vertexShader:Z.vertexShader,fragmentShader:Z.fragmentShader})))});function IO({onChanged:r,portal:e,preventDefault:t=!0,scroll:i=!0,keyCode:n=9}){const s=g.useRef(0),o=ae(c=>c.setEvents),a=ae(c=>c.get),l=ae(c=>c.gl);return g.useEffect(()=>{var c;let u=[],h;const f=a().events.filter,d=(c=e?.current)!==null&&c!==void 0?c:l.domElement.parentNode,m=()=>d&&r&&r(u,Math.round(s.current)%u.length);o({filter:(E,x)=>{let I=[...E];(I.length!==u.length||!u.every(C=>I.map(_=>_.object.uuid).includes(C.object.uuid)))&&(s.current=0,u=I,m()),f&&(I=f(I,x));for(let C=0;C<Math.round(s.current)%I.length;C++){const _=I.shift();I=[...I,_]}return I}});const A=E=>{var x,I;s.current=E(s.current),(x=a().events.handlers)==null||x.onPointerCancel(void 0),(I=a().events.handlers)==null||I.onPointerMove(h),m()},p=E=>{(E.keyCode||E.which)===n&&(t&&E.preventDefault(),u.length>1&&A(x=>x+1))},y=E=>{t&&E.preventDefault();let x=0;E||(E=window.event),E.wheelDelta?x=E.wheelDelta/120:E.detail&&(x=-E.detail/3),u.length>1&&A(I=>Math.abs(I-x))},v=E=>h=E;return document.addEventListener("pointermove",v,{passive:!0}),i&&document.addEventListener("wheel",y),n!==void 0&&document.addEventListener("keydown",p),()=>{o({filter:f}),n!==void 0&&document.removeEventListener("keydown",p),i&&document.removeEventListener("wheel",y),document.removeEventListener("pointermove",v)}},[l,a,o,t,i,n]),null}function CO(r,e="pointer",t="auto",i=document.body){g.useEffect(()=>{if(r)return i.style.cursor=e,()=>void(i.style.cursor=t)},[r])}const zp=r=>{let e;const t=new Set,i=(c,u)=>{const h=typeof c=="function"?c(e):c;if(!Object.is(h,e)){const f=e;e=u??(typeof h!="object"||h===null)?h:Object.assign({},e,h),t.forEach(d=>d(e,f))}},n=()=>e,a={setState:i,getState:n,getInitialState:()=>l,subscribe:c=>(t.add(c),()=>t.delete(c))},l=e=r(i,n,a);return a},k_=(r=>r?zp(r):zp),O_=r=>r;function U_(r,e=O_){const t=ts.useSyncExternalStore(r.subscribe,ts.useCallback(()=>e(r.getState()),[r,e]),ts.useCallback(()=>e(r.getInitialState()),[r,e]));return ts.useDebugValue(t),t}const Hp=r=>{const e=k_(r),t=i=>U_(e,i);return Object.assign(t,e),t},DE=(r=>r?Hp(r):Hp);let qa=0;const ME=DE(r=>(Nc.onStart=(e,t,i)=>{r({active:!0,item:e,loaded:t,total:i,progress:(t-qa)/(i-qa)*100})},Nc.onLoad=()=>{r({active:!1})},Nc.onError=e=>r(t=>({errors:[...t.errors,e]})),Nc.onProgress=(e,t,i)=>{t===i&&(qa=i),r({active:!0,item:e,loaded:t,total:i,progress:(t-qa)/(i-qa)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0}));function _O({children:r}){const e=ME();return g.createElement(g.Fragment,null,r?.(e))}const N_=r=>`Loading ${r.toFixed(2)}%`;function SO({containerStyles:r,innerStyles:e,barStyles:t,dataStyles:i,dataInterpolation:n=N_,initialState:s=o=>o}){const{active:o,progress:a}=ME(),l=g.useRef(0),c=g.useRef(0),u=g.useRef(null),[h,f]=g.useState(s(o));g.useEffect(()=>{let m;return o!==h&&(m=setTimeout(()=>f(o),300)),()=>clearTimeout(m)},[h,o]);const d=g.useCallback(()=>{u.current&&(l.current+=(a-l.current)/2,(l.current>.95*a||a===100)&&(l.current=a),u.current.innerText=n(l.current),l.current<a&&(c.current=requestAnimationFrame(d)))},[n,a]);return g.useEffect(()=>(d(),()=>cancelAnimationFrame(c.current)),[d]),h?g.createElement("div",{style:{...Qc.container,opacity:o?1:0,...r}},g.createElement("div",null,g.createElement("div",{style:{...Qc.inner,...e}},g.createElement("div",{style:{...Qc.bar,transform:`scaleX(${a/100})`,...t}}),g.createElement("span",{ref:u,style:{...Qc.data,...i}})))):null}const Qc={container:{position:"absolute",top:0,left:0,width:"100%",height:"100%",background:"#171717",display:"flex",alignItems:"center",justifyContent:"center",transition:"opacity 300ms ease",zIndex:1e3},inner:{width:100,height:3,background:"#272727",textAlign:"center"},bar:{height:3,width:"100%",background:"white",transition:"transform 200ms",transformOrigin:"left center"},data:{display:"inline-block",position:"relative",fontVariantNumeric:"tabular-nums",marginTop:"0.8em",color:"#f0f0f0",fontSize:"0.6em",fontFamily:'-apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, Roboto, Ubuntu, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',whiteSpace:"nowrap"}};function G_(r,e,t){return Math.max(e,Math.min(r,t))}const si={toVector(r,e){return r===void 0&&(r=e),Array.isArray(r)?r:[r,r]},add(r,e){return[r[0]+e[0],r[1]+e[1]]},sub(r,e){return[r[0]-e[0],r[1]-e[1]]},addTo(r,e){r[0]+=e[0],r[1]+=e[1]},subTo(r,e){r[0]-=e[0],r[1]-=e[1]}};function Vp(r,e,t){return e===0||Math.abs(e)===1/0?Math.pow(r,t*5):r*e*t/(e+t*r)}function Kp(r,e,t,i=.15){return i===0?G_(r,e,t):r<e?-Vp(e-r,t-e,i)+e:r>t?+Vp(r-t,t-e,i)+t:r}function Q_(r,[e,t],[i,n]){const[[s,o],[a,l]]=r;return[Kp(e,s,o,i),Kp(t,a,l,n)]}function z_(r,e){if(typeof r!="object"||r===null)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var i=t.call(r,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function H_(r){var e=z_(r,"string");return typeof e=="symbol"?e:String(e)}function Bi(r,e,t){return e=H_(e),e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function $p(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function pi(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$p(Object(t),!0).forEach(function(i){Bi(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):$p(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}const LE={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function Yp(r){return r?r[0].toUpperCase()+r.slice(1):""}const V_=["enter","leave"];function K_(r=!1,e){return r&&!V_.includes(e)}function $_(r,e="",t=!1){const i=LE[r],n=i&&i[e]||e;return"on"+Yp(r)+Yp(n)+(K_(t,n)?"Capture":"")}const Y_=["gotpointercapture","lostpointercapture"];function W_(r){let e=r.substring(2).toLowerCase();const t=!!~e.indexOf("passive");t&&(e=e.replace("passive",""));const i=Y_.includes(e)?"capturecapture":"capture",n=!!~e.indexOf(i);return n&&(e=e.replace("capture","")),{device:e,capture:n,passive:t}}function j_(r,e=""){const t=LE[r],i=t&&t[e]||e;return r+i}function ef(r){return"touches"in r}function PE(r){return ef(r)?"touch":"pointerType"in r?r.pointerType:"mouse"}function q_(r){return Array.from(r.touches).filter(e=>{var t,i;return e.target===r.currentTarget||((t=r.currentTarget)===null||t===void 0||(i=t.contains)===null||i===void 0?void 0:i.call(t,e.target))})}function X_(r){return r.type==="touchend"||r.type==="touchcancel"?r.changedTouches:r.targetTouches}function FE(r){return ef(r)?X_(r)[0]:r}function q0(r,e){try{const t=e.clientX-r.clientX,i=e.clientY-r.clientY,n=(e.clientX+r.clientX)/2,s=(e.clientY+r.clientY)/2,o=Math.hypot(t,i);return{angle:-(Math.atan2(t,i)*180)/Math.PI,distance:o,origin:[n,s]}}catch{}return null}function J_(r){return q_(r).map(e=>e.identifier)}function Wp(r,e){const[t,i]=Array.from(r.touches).filter(n=>e.includes(n.identifier));return q0(t,i)}function zf(r){const e=FE(r);return ef(r)?e.identifier:e.pointerId}function Ra(r){const e=FE(r);return[e.clientX,e.clientY]}const jp=40,qp=800;function kE(r){let{deltaX:e,deltaY:t,deltaMode:i}=r;return i===1?(e*=jp,t*=jp):i===2&&(e*=qp,t*=qp),[e,t]}function Z_(r){var e,t;const{scrollX:i,scrollY:n,scrollLeft:s,scrollTop:o}=r.currentTarget;return[(e=i??s)!==null&&e!==void 0?e:0,(t=n??o)!==null&&t!==void 0?t:0]}function eS(r){const e={};if("buttons"in r&&(e.buttons=r.buttons),"shiftKey"in r){const{shiftKey:t,altKey:i,metaKey:n,ctrlKey:s}=r;Object.assign(e,{shiftKey:t,altKey:i,metaKey:n,ctrlKey:s})}return e}function Ih(r,...e){return typeof r=="function"?r(...e):r}function tS(){}function iS(...r){return r.length===0?tS:r.length===1?r[0]:function(){let e;for(const t of r)e=t.apply(this,arguments)||e;return e}}function Xp(r,e){return Object.assign({},e,r||{})}const nS=32;class OE{constructor(e,t,i){this.ctrl=e,this.args=t,this.key=i,this.state||(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}get state(){return this.ctrl.state[this.key]}set state(e){this.ctrl.state[this.key]=e}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){const{state:e,shared:t,ingKey:i,args:n}=this;t[i]=e._active=e.active=e._blocked=e._force=!1,e._step=[!1,!1],e.intentional=!1,e._movement=[0,0],e._distance=[0,0],e._direction=[0,0],e._delta=[0,0],e._bounds=[[-1/0,1/0],[-1/0,1/0]],e.args=n,e.axis=void 0,e.memo=void 0,e.elapsedTime=e.timeDelta=0,e.direction=[0,0],e.distance=[0,0],e.overflow=[0,0],e._movementBound=[!1,!1],e.velocity=[0,0],e.movement=[0,0],e.delta=[0,0],e.timeStamp=0}start(e){const t=this.state,i=this.config;t._active||(this.reset(),this.computeInitial(),t._active=!0,t.target=e.target,t.currentTarget=e.currentTarget,t.lastOffset=i.from?Ih(i.from,t):t.offset,t.offset=t.lastOffset,t.startTime=t.timeStamp=e.timeStamp)}computeValues(e){const t=this.state;t._values=e,t.values=this.config.transform(e)}computeInitial(){const e=this.state;e._initial=e._values,e.initial=e.values}compute(e){const{state:t,config:i,shared:n}=this;t.args=this.args;let s=0;if(e&&(t.event=e,i.preventDefault&&e.cancelable&&t.event.preventDefault(),t.type=e.type,n.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,n.locked=!!document.pointerLockElement,Object.assign(n,eS(e)),n.down=n.pressed=n.buttons%2===1||n.touches>0,s=e.timeStamp-t.timeStamp,t.timeStamp=e.timeStamp,t.elapsedTime=t.timeStamp-t.startTime),t._active){const C=t._delta.map(Math.abs);si.addTo(t._distance,C)}this.axisIntent&&this.axisIntent(e);const[o,a]=t._movement,[l,c]=i.threshold,{_step:u,values:h}=t;if(i.hasCustomTransform?(u[0]===!1&&(u[0]=Math.abs(o)>=l&&h[0]),u[1]===!1&&(u[1]=Math.abs(a)>=c&&h[1])):(u[0]===!1&&(u[0]=Math.abs(o)>=l&&Math.sign(o)*l),u[1]===!1&&(u[1]=Math.abs(a)>=c&&Math.sign(a)*c)),t.intentional=u[0]!==!1||u[1]!==!1,!t.intentional)return;const f=[0,0];if(i.hasCustomTransform){const[C,_]=h;f[0]=u[0]!==!1?C-u[0]:0,f[1]=u[1]!==!1?_-u[1]:0}else f[0]=u[0]!==!1?o-u[0]:0,f[1]=u[1]!==!1?a-u[1]:0;this.restrictToAxis&&!t._blocked&&this.restrictToAxis(f);const d=t.offset,m=t._active&&!t._blocked||t.active;m&&(t.first=t._active&&!t.active,t.last=!t._active&&t.active,t.active=n[this.ingKey]=t._active,e&&(t.first&&("bounds"in i&&(t._bounds=Ih(i.bounds,t)),this.setup&&this.setup()),t.movement=f,this.computeOffset()));const[A,p]=t.offset,[[y,v],[E,x]]=t._bounds;t.overflow=[A<y?-1:A>v?1:0,p<E?-1:p>x?1:0],t._movementBound[0]=t.overflow[0]?t._movementBound[0]===!1?t._movement[0]:t._movementBound[0]:!1,t._movementBound[1]=t.overflow[1]?t._movementBound[1]===!1?t._movement[1]:t._movementBound[1]:!1;const I=t._active?i.rubberband||[0,0]:[0,0];if(t.offset=Q_(t._bounds,t.offset,I),t.delta=si.sub(t.offset,d),this.computeMovement(),m&&(!t.last||s>nS)){t.delta=si.sub(t.offset,d);const C=t.delta.map(Math.abs);si.addTo(t.distance,C),t.direction=t.delta.map(Math.sign),t._direction=t._delta.map(Math.sign),!t.first&&s>0&&(t.velocity=[C[0]/s,C[1]/s],t.timeDelta=s)}}emit(){const e=this.state,t=this.shared,i=this.config;if(e._active||this.clean(),(e._blocked||!e.intentional)&&!e._force&&!i.triggerAllEvents)return;const n=this.handler(pi(pi(pi({},t),e),{},{[this.aliasKey]:e.values}));n!==void 0&&(e.memo=n)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}}function sS([r,e],t){const i=Math.abs(r),n=Math.abs(e);if(i>n&&i>t)return"x";if(n>i&&n>t)return"y"}class Sc extends OE{constructor(...e){super(...e),Bi(this,"aliasKey","xy")}reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=si.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=si.sub(this.state.offset,this.state.lastOffset)}axisIntent(e){const t=this.state,i=this.config;if(!t.axis&&e){const n=typeof i.axisThreshold=="object"?i.axisThreshold[PE(e)]:i.axisThreshold;t.axis=sS(t._movement,n)}t._blocked=(i.lockDirection||!!i.axis)&&!t.axis||!!i.axis&&i.axis!==t.axis}restrictToAxis(e){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":e[1]=0;break;case"y":e[0]=0;break}}}const rS=r=>r,Jp=.15,UE={enabled(r=!0){return r},eventOptions(r,e,t){return pi(pi({},t.shared.eventOptions),r)},preventDefault(r=!1){return r},triggerAllEvents(r=!1){return r},rubberband(r=0){switch(r){case!0:return[Jp,Jp];case!1:return[0,0];default:return si.toVector(r)}},from(r){if(typeof r=="function")return r;if(r!=null)return si.toVector(r)},transform(r,e,t){const i=r||t.shared.transform;return this.hasCustomTransform=!!i,i||rS},threshold(r){return si.toVector(r,0)}},oS=0,Eo=pi(pi({},UE),{},{axis(r,e,{axis:t}){if(this.lockDirection=t==="lock",!this.lockDirection)return t},axisThreshold(r=oS){return r},bounds(r={}){if(typeof r=="function")return s=>Eo.bounds(r(s));if("current"in r)return()=>r.current;if(typeof HTMLElement=="function"&&r instanceof HTMLElement)return r;const{left:e=-1/0,right:t=1/0,top:i=-1/0,bottom:n=1/0}=r;return[[e,t],[i,n]]}}),Zp={ArrowRight:(r,e=1)=>[r*e,0],ArrowLeft:(r,e=1)=>[-1*r*e,0],ArrowUp:(r,e=1)=>[0,-1*r*e],ArrowDown:(r,e=1)=>[0,r*e]};class aS extends Sc{constructor(...e){super(...e),Bi(this,"ingKey","dragging")}reset(){super.reset();const e=this.state;e._pointerId=void 0,e._pointerActive=!1,e._keyboardActive=!1,e._preventScroll=!1,e._delayed=!1,e.swipe=[0,0],e.tap=!1,e.canceled=!1,e.cancel=this.cancel.bind(this)}setup(){const e=this.state;if(e._bounds instanceof HTMLElement){const t=e._bounds.getBoundingClientRect(),i=e.currentTarget.getBoundingClientRect(),n={left:t.left-i.left+e.offset[0],right:t.right-i.right+e.offset[0],top:t.top-i.top+e.offset[1],bottom:t.bottom-i.bottom+e.offset[1]};e._bounds=Eo.bounds(n)}}cancel(){const e=this.state;e.canceled||(e.canceled=!0,e._active=!1,setTimeout(()=>{this.compute(),this.emit()},0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(e){const t=this.config,i=this.state;if(e.buttons!=null&&(Array.isArray(t.pointerButtons)?!t.pointerButtons.includes(e.buttons):t.pointerButtons!==-1&&t.pointerButtons!==e.buttons))return;const n=this.ctrl.setEventIds(e);t.pointerCapture&&e.target.setPointerCapture(e.pointerId),!(n&&n.size>1&&i._pointerActive)&&(this.start(e),this.setupPointer(e),i._pointerId=zf(e),i._pointerActive=!0,this.computeValues(Ra(e)),this.computeInitial(),t.preventScrollAxis&&PE(e)!=="mouse"?(i._active=!1,this.setupScrollPrevention(e)):t.delay>0?(this.setupDelayTrigger(e),t.triggerAllEvents&&(this.compute(e),this.emit())):this.startPointerDrag(e))}startPointerDrag(e){const t=this.state;t._active=!0,t._preventScroll=!0,t._delayed=!1,this.compute(e),this.emit()}pointerMove(e){const t=this.state,i=this.config;if(!t._pointerActive)return;const n=zf(e);if(t._pointerId!==void 0&&n!==t._pointerId)return;const s=Ra(e);if(document.pointerLockElement===e.target?t._delta=[e.movementX,e.movementY]:(t._delta=si.sub(s,t._values),this.computeValues(s)),si.addTo(t._movement,t._delta),this.compute(e),t._delayed&&t.intentional){this.timeoutStore.remove("dragDelay"),t.active=!1,this.startPointerDrag(e);return}if(i.preventScrollAxis&&!t._preventScroll)if(t.axis)if(t.axis===i.preventScrollAxis||i.preventScrollAxis==="xy"){t._active=!1,this.clean();return}else{this.timeoutStore.remove("startPointerDrag"),this.startPointerDrag(e);return}else return;this.emit()}pointerUp(e){this.ctrl.setEventIds(e);try{this.config.pointerCapture&&e.target.hasPointerCapture(e.pointerId)&&e.target.releasePointerCapture(e.pointerId)}catch{}const t=this.state,i=this.config;if(!t._active||!t._pointerActive)return;const n=zf(e);if(t._pointerId!==void 0&&n!==t._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(e);const[s,o]=t._distance;if(t.tap=s<=i.tapsThreshold&&o<=i.tapsThreshold,t.tap&&i.filterTaps)t._force=!0;else{const[a,l]=t._delta,[c,u]=t._movement,[h,f]=i.swipe.velocity,[d,m]=i.swipe.distance,A=i.swipe.duration;if(t.elapsedTime<A){const p=Math.abs(a/t.timeDelta),y=Math.abs(l/t.timeDelta);p>h&&Math.abs(c)>d&&(t.swipe[0]=Math.sign(a)),y>f&&Math.abs(u)>m&&(t.swipe[1]=Math.sign(l))}}this.emit()}pointerClick(e){!this.state.tap&&e.detail>0&&(e.preventDefault(),e.stopPropagation())}setupPointer(e){const t=this.config,i=t.device;t.pointerLock&&e.currentTarget.requestPointerLock(),t.pointerCapture||(this.eventStore.add(this.sharedConfig.window,i,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(e){this.state._preventScroll&&e.cancelable&&e.preventDefault()}setupScrollPrevention(e){this.state._preventScroll=!1,lS(e);const t=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",t),this.eventStore.add(this.sharedConfig.window,"touch","cancel",t),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,e)}setupDelayTrigger(e){this.state._delayed=!0,this.timeoutStore.add("dragDelay",()=>{this.state._step=[0,0],this.startPointerDrag(e)},this.config.delay)}keyDown(e){const t=Zp[e.key];if(t){const i=this.state,n=e.shiftKey?10:e.altKey?.1:1;this.start(e),i._delta=t(this.config.keyboardDisplacement,n),i._keyboardActive=!0,si.addTo(i._movement,i._delta),this.compute(e),this.emit()}}keyUp(e){e.key in Zp&&(this.state._keyboardActive=!1,this.setActive(),this.compute(e),this.emit())}bind(e){const t=this.config.device;e(t,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(e(t,"change",this.pointerMove.bind(this)),e(t,"end",this.pointerUp.bind(this)),e(t,"cancel",this.pointerUp.bind(this)),e("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(e("key","down",this.keyDown.bind(this)),e("key","up",this.keyUp.bind(this))),this.config.filterTaps&&e("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}}function lS(r){"persist"in r&&typeof r.persist=="function"&&r.persist()}const Tc=typeof window<"u"&&window.document&&window.document.createElement;function NE(){return Tc&&"ontouchstart"in window}function cS(){return NE()||Tc&&window.navigator.maxTouchPoints>1}function uS(){return Tc&&"onpointerdown"in window}function hS(){return Tc&&"exitPointerLock"in window.document}function fS(){try{return"constructor"in GestureEvent}catch{return!1}}const Jn={isBrowser:Tc,gesture:fS(),touch:NE(),touchscreen:cS(),pointer:uS(),pointerLock:hS()},dS=250,mS=180,AS=.5,pS=50,gS=250,yS=10,eg={mouse:0,touch:0,pen:8},vS=pi(pi({},Eo),{},{device(r,e,{pointer:{touch:t=!1,lock:i=!1,mouse:n=!1}={}}){return this.pointerLock=i&&Jn.pointerLock,Jn.touch&&t?"touch":this.pointerLock?"mouse":Jn.pointer&&!n?"pointer":Jn.touch?"touch":"mouse"},preventScrollAxis(r,e,{preventScroll:t}){if(this.preventScrollDelay=typeof t=="number"?t:t||t===void 0&&r?dS:void 0,!(!Jn.touchscreen||t===!1))return r||(t!==void 0?"y":void 0)},pointerCapture(r,e,{pointer:{capture:t=!0,buttons:i=1,keys:n=!0}={}}){return this.pointerButtons=i,this.keys=n,!this.pointerLock&&this.device==="pointer"&&t},threshold(r,e,{filterTaps:t=!1,tapsThreshold:i=3,axis:n=void 0}){const s=si.toVector(r,t?i:n?1:0);return this.filterTaps=t,this.tapsThreshold=i,s},swipe({velocity:r=AS,distance:e=pS,duration:t=gS}={}){return{velocity:this.transform(si.toVector(r)),distance:this.transform(si.toVector(e)),duration:t}},delay(r=0){switch(r){case!0:return mS;case!1:return 0;default:return r}},axisThreshold(r){return r?pi(pi({},eg),r):eg},keyboardDisplacement(r=yS){return r}});function GE(r){const[e,t]=r.overflow,[i,n]=r._delta,[s,o]=r._direction;(e<0&&i>0&&s<0||e>0&&i<0&&s>0)&&(r._movement[0]=r._movementBound[0]),(t<0&&n>0&&o<0||t>0&&n<0&&o>0)&&(r._movement[1]=r._movementBound[1])}const ES=30,xS=100;class IS extends OE{constructor(...e){super(...e),Bi(this,"ingKey","pinching"),Bi(this,"aliasKey","da")}init(){this.state.offset=[1,0],this.state.lastOffset=[1,0],this.state._pointerEvents=new Map}reset(){super.reset();const e=this.state;e._touchIds=[],e.canceled=!1,e.cancel=this.cancel.bind(this),e.turns=0}computeOffset(){const{type:e,movement:t,lastOffset:i}=this.state;e==="wheel"?this.state.offset=si.add(t,i):this.state.offset=[(1+t[0])*i[0],t[1]+i[1]]}computeMovement(){const{offset:e,lastOffset:t}=this.state;this.state.movement=[e[0]/t[0],e[1]-t[1]]}axisIntent(){const e=this.state,[t,i]=e._movement;if(!e.axis){const n=Math.abs(t)*ES-Math.abs(i);n<0?e.axis="angle":n>0&&(e.axis="scale")}}restrictToAxis(e){this.config.lockDirection&&(this.state.axis==="scale"?e[1]=0:this.state.axis==="angle"&&(e[0]=0))}cancel(){const e=this.state;e.canceled||setTimeout(()=>{e.canceled=!0,e._active=!1,this.compute(),this.emit()},0)}touchStart(e){this.ctrl.setEventIds(e);const t=this.state,i=this.ctrl.touchIds;if(t._active&&t._touchIds.every(s=>i.has(s))||i.size<2)return;this.start(e),t._touchIds=Array.from(i).slice(0,2);const n=Wp(e,t._touchIds);n&&this.pinchStart(e,n)}pointerStart(e){if(e.buttons!=null&&e.buttons%2!==1)return;this.ctrl.setEventIds(e),e.target.setPointerCapture(e.pointerId);const t=this.state,i=t._pointerEvents,n=this.ctrl.pointerIds;if(t._active&&Array.from(i.keys()).every(o=>n.has(o))||(i.size<2&&i.set(e.pointerId,e),t._pointerEvents.size<2))return;this.start(e);const s=q0(...Array.from(i.values()));s&&this.pinchStart(e,s)}pinchStart(e,t){const i=this.state;i.origin=t.origin,this.computeValues([t.distance,t.angle]),this.computeInitial(),this.compute(e),this.emit()}touchMove(e){if(!this.state._active)return;const t=Wp(e,this.state._touchIds);t&&this.pinchMove(e,t)}pointerMove(e){const t=this.state._pointerEvents;if(t.has(e.pointerId)&&t.set(e.pointerId,e),!this.state._active)return;const i=q0(...Array.from(t.values()));i&&this.pinchMove(e,i)}pinchMove(e,t){const i=this.state,n=i._values[1],s=t.angle-n;let o=0;Math.abs(s)>270&&(o+=Math.sign(s)),this.computeValues([t.distance,t.angle-360*o]),i.origin=t.origin,i.turns=o,i._movement=[i._values[0]/i._initial[0]-1,i._values[1]-i._initial[1]],this.compute(e),this.emit()}touchEnd(e){this.ctrl.setEventIds(e),this.state._active&&this.state._touchIds.some(t=>!this.ctrl.touchIds.has(t))&&(this.state._active=!1,this.compute(e),this.emit())}pointerEnd(e){const t=this.state;this.ctrl.setEventIds(e);try{e.target.releasePointerCapture(e.pointerId)}catch{}t._pointerEvents.has(e.pointerId)&&t._pointerEvents.delete(e.pointerId),t._active&&t._pointerEvents.size<2&&(t._active=!1,this.compute(e),this.emit())}gestureStart(e){e.cancelable&&e.preventDefault();const t=this.state;t._active||(this.start(e),this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY],this.compute(e),this.emit())}gestureMove(e){if(e.cancelable&&e.preventDefault(),!this.state._active)return;const t=this.state;this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY];const i=t._movement;t._movement=[e.scale-1,e.rotation],t._delta=si.sub(t._movement,i),this.compute(e),this.emit()}gestureEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}wheel(e){const t=this.config.modifierKey;t&&(Array.isArray(t)?!t.find(i=>e[i]):!e[t])||(this.state._active?this.wheelChange(e):this.wheelStart(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this)))}wheelStart(e){this.start(e),this.wheelChange(e)}wheelChange(e){"uv"in e||e.cancelable&&e.preventDefault();const i=this.state;i._delta=[-kE(e)[1]/xS*i.offset[0],0],si.addTo(i._movement,i._delta),GE(i),this.state.origin=[e.clientX,e.clientY],this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){const t=this.config.device;t&&(e(t,"start",this[t+"Start"].bind(this)),e(t,"change",this[t+"Move"].bind(this)),e(t,"end",this[t+"End"].bind(this)),e(t,"cancel",this[t+"End"].bind(this)),e("lostPointerCapture","",this[t+"End"].bind(this))),this.config.pinchOnWheel&&e("wheel","",this.wheel.bind(this),{passive:!1})}}const CS=pi(pi({},UE),{},{device(r,e,{shared:t,pointer:{touch:i=!1}={}}){if(t.target&&!Jn.touch&&Jn.gesture)return"gesture";if(Jn.touch&&i)return"touch";if(Jn.touchscreen){if(Jn.pointer)return"pointer";if(Jn.touch)return"touch"}},bounds(r,e,{scaleBounds:t={},angleBounds:i={}}){const n=o=>{const a=Xp(Ih(t,o),{min:-1/0,max:1/0});return[a.min,a.max]},s=o=>{const a=Xp(Ih(i,o),{min:-1/0,max:1/0});return[a.min,a.max]};return typeof t!="function"&&typeof i!="function"?[n(),s()]:o=>[n(o),s(o)]},threshold(r,e,t){return this.lockDirection=t.axis==="lock",si.toVector(r,this.lockDirection?[.1,3]:0)},modifierKey(r){return r===void 0?"ctrlKey":r},pinchOnWheel(r=!0){return r}});class _S extends Sc{constructor(...e){super(...e),Bi(this,"ingKey","moving")}move(e){this.config.mouseOnly&&e.pointerType!=="mouse"||(this.state._active?this.moveChange(e):this.moveStart(e),this.timeoutStore.add("moveEnd",this.moveEnd.bind(this)))}moveStart(e){this.start(e),this.computeValues(Ra(e)),this.compute(e),this.computeInitial(),this.emit()}moveChange(e){if(!this.state._active)return;const t=Ra(e),i=this.state;i._delta=si.sub(t,i._values),si.addTo(i._movement,i._delta),this.computeValues(t),this.compute(e),this.emit()}moveEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}bind(e){e("pointer","change",this.move.bind(this)),e("pointer","leave",this.moveEnd.bind(this))}}const SS=pi(pi({},Eo),{},{mouseOnly:(r=!0)=>r});class TS extends Sc{constructor(...e){super(...e),Bi(this,"ingKey","scrolling")}scroll(e){this.state._active||this.start(e),this.scrollChange(e),this.timeoutStore.add("scrollEnd",this.scrollEnd.bind(this))}scrollChange(e){e.cancelable&&e.preventDefault();const t=this.state,i=Z_(e);t._delta=si.sub(i,t._values),si.addTo(t._movement,t._delta),this.computeValues(i),this.compute(e),this.emit()}scrollEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("scroll","",this.scroll.bind(this))}}const bS=Eo;class wS extends Sc{constructor(...e){super(...e),Bi(this,"ingKey","wheeling")}wheel(e){this.state._active||this.start(e),this.wheelChange(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this))}wheelChange(e){const t=this.state;t._delta=kE(e),si.addTo(t._movement,t._delta),GE(t),this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("wheel","",this.wheel.bind(this))}}const BS=Eo;class RS extends Sc{constructor(...e){super(...e),Bi(this,"ingKey","hovering")}enter(e){this.config.mouseOnly&&e.pointerType!=="mouse"||(this.start(e),this.computeValues(Ra(e)),this.compute(e),this.emit())}leave(e){if(this.config.mouseOnly&&e.pointerType!=="mouse")return;const t=this.state;if(!t._active)return;t._active=!1;const i=Ra(e);t._movement=t._delta=si.sub(i,t._values),this.computeValues(i),this.compute(e),t.delta=t.movement,this.emit()}bind(e){e("pointer","enter",this.enter.bind(this)),e("pointer","leave",this.leave.bind(this))}}const DS=pi(pi({},Eo),{},{mouseOnly:(r=!0)=>r}),uA=new Map,X0=new Map;function MS(r){uA.set(r.key,r.engine),X0.set(r.key,r.resolver)}const LS={key:"drag",engine:aS,resolver:vS},PS={key:"hover",engine:RS,resolver:DS},FS={key:"move",engine:_S,resolver:SS},kS={key:"pinch",engine:IS,resolver:CS},OS={key:"scroll",engine:TS,resolver:bS},US={key:"wheel",engine:wS,resolver:BS};function NS(r,e){if(r==null)return{};var t={},i=Object.keys(r),n,s;for(s=0;s<i.length;s++)n=i[s],!(e.indexOf(n)>=0)&&(t[n]=r[n]);return t}function GS(r,e){if(r==null)return{};var t=NS(r,e),i,n;if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(r);for(n=0;n<s.length;n++)i=s[n],!(e.indexOf(i)>=0)&&Object.prototype.propertyIsEnumerable.call(r,i)&&(t[i]=r[i])}return t}const QS={target(r){if(r)return()=>"current"in r?r.current:r},enabled(r=!0){return r},window(r=Jn.isBrowser?window:void 0){return r},eventOptions({passive:r=!0,capture:e=!1}={}){return{passive:r,capture:e}},transform(r){return r}},zS=["target","eventOptions","window","enabled","transform"];function ih(r={},e){const t={};for(const[i,n]of Object.entries(e))switch(typeof n){case"function":t[i]=n.call(t,r[i],i,r);break;case"object":t[i]=ih(r[i],n);break;case"boolean":n&&(t[i]=r[i]);break}return t}function HS(r,e,t={}){const i=r,{target:n,eventOptions:s,window:o,enabled:a,transform:l}=i,c=GS(i,zS);if(t.shared=ih({target:n,eventOptions:s,window:o,enabled:a,transform:l},QS),e){const u=X0.get(e);t[e]=ih(pi({shared:t.shared},c),u)}else for(const u in c){const h=X0.get(u);h&&(t[u]=ih(pi({shared:t.shared},c[u]),h))}return t}class QE{constructor(e,t){Bi(this,"_listeners",new Set),this._ctrl=e,this._gestureKey=t}add(e,t,i,n,s){const o=this._listeners,a=j_(t,i),l=this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{},c=pi(pi({},l),s);e.addEventListener(a,n,c);const u=()=>{e.removeEventListener(a,n,c),o.delete(u)};return o.add(u),u}clean(){this._listeners.forEach(e=>e()),this._listeners.clear()}}class VS{constructor(){Bi(this,"_timeouts",new Map)}add(e,t,i=140,...n){this.remove(e),this._timeouts.set(e,window.setTimeout(t,i,...n))}remove(e){const t=this._timeouts.get(e);t&&window.clearTimeout(t)}clean(){this._timeouts.forEach(e=>void window.clearTimeout(e)),this._timeouts.clear()}}let KS=class{constructor(e){Bi(this,"gestures",new Set),Bi(this,"_targetEventStore",new QE(this)),Bi(this,"gestureEventStores",{}),Bi(this,"gestureTimeoutStores",{}),Bi(this,"handlers",{}),Bi(this,"config",{}),Bi(this,"pointerIds",new Set),Bi(this,"touchIds",new Set),Bi(this,"state",{shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}}),$S(this,e)}setEventIds(e){if(ef(e))return this.touchIds=new Set(J_(e)),this.touchIds;if("pointerId"in e)return e.type==="pointerup"||e.type==="pointercancel"?this.pointerIds.delete(e.pointerId):e.type==="pointerdown"&&this.pointerIds.add(e.pointerId),this.pointerIds}applyHandlers(e,t){this.handlers=e,this.nativeHandlers=t}applyConfig(e,t){this.config=HS(e,t,this.config)}clean(){this._targetEventStore.clean();for(const e of this.gestures)this.gestureEventStores[e].clean(),this.gestureTimeoutStores[e].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(...e){const t=this.config.shared,i={};let n;if(!(t.target&&(n=t.target(),!n))){if(t.enabled){for(const o of this.gestures){const a=this.config[o],l=tg(i,a.eventOptions,!!n);if(a.enabled){const c=uA.get(o);new c(this,e,o).bind(l)}}const s=tg(i,t.eventOptions,!!n);for(const o in this.nativeHandlers)s(o,"",a=>this.nativeHandlers[o](pi(pi({},this.state.shared),{},{event:a,args:e})),void 0,!0)}for(const s in i)i[s]=iS(...i[s]);if(!n)return i;for(const s in i){const{device:o,capture:a,passive:l}=W_(s);this._targetEventStore.add(n,o,"",i[s],{capture:a,passive:l})}}}};function So(r,e){r.gestures.add(e),r.gestureEventStores[e]=new QE(r,e),r.gestureTimeoutStores[e]=new VS}function $S(r,e){e.drag&&So(r,"drag"),e.wheel&&So(r,"wheel"),e.scroll&&So(r,"scroll"),e.move&&So(r,"move"),e.pinch&&So(r,"pinch"),e.hover&&So(r,"hover")}const tg=(r,e,t)=>(i,n,s,o={},a=!1)=>{var l,c;const u=(l=o.capture)!==null&&l!==void 0?l:e.capture,h=(c=o.passive)!==null&&c!==void 0?c:e.passive;let f=a?i:$_(i,n,u);t&&h&&(f+="Passive"),r[f]=r[f]||[],r[f].push(s)},YS=/^on(Drag|Wheel|Scroll|Move|Pinch|Hover)/;function WS(r){const e={},t={},i=new Set;for(let n in r)YS.test(n)?(i.add(RegExp.lastMatch),t[n]=r[n]):e[n]=r[n];return[t,e,i]}function To(r,e,t,i,n,s){if(!r.has(t)||!uA.has(i))return;const o=t+"Start",a=t+"End",l=c=>{let u;return c.first&&o in e&&e[o](c),t in e&&(u=e[t](c)),c.last&&a in e&&e[a](c),u};n[i]=l,s[i]=s[i]||{}}function jS(r,e){const[t,i,n]=WS(r),s={};return To(n,t,"onDrag","drag",s,e),To(n,t,"onWheel","wheel",s,e),To(n,t,"onScroll","scroll",s,e),To(n,t,"onPinch","pinch",s,e),To(n,t,"onMove","move",s,e),To(n,t,"onHover","hover",s,e),{handlers:s,config:e,nativeHandlers:i}}function qS(r,e={},t,i){const n=ts.useMemo(()=>new KS(r),[]);if(n.applyHandlers(r,i),n.applyConfig(e,t),ts.useEffect(n.effect.bind(n)),ts.useEffect(()=>n.clean.bind(n),[]),e.target===void 0)return n.bind.bind(n)}function XS(r){return r.forEach(MS),function(t,i){const{handlers:n,nativeHandlers:s,config:o}=jS(t,i||{});return qS(n,o,void 0,s)}}function zE(r,e){return XS([LS,kS,OS,US,FS,PS])(r,e||{})}const Hf=new Q,ig=new De,qr=new Q,zc=new Q,Xa=new Q,ng=new Xs,bO=g.forwardRef(({autoTransform:r=!0,matrix:e,axisLock:t,dragLimits:i,onHover:n,onDragStart:s,onDrag:o,onDragEnd:a,children:l,dragConfig:c,...u},h)=>{const f=ae(E=>E.controls),{camera:d,size:m,raycaster:A,invalidate:p}=ae(),y=g.useRef(null),v=zE({onHover:({hovering:E})=>n&&n(E??!1),onDragStart:({event:E})=>{f&&(f.enabled=!1);const{point:x}=E;y.current.matrix.decompose(Hf,new st,new Q),qr.copy(x),zc.copy(qr).sub(Hf),s&&s(Hf),p()},onDrag:({xy:[E,x],intentional:I})=>{if(!I)return;const C=(E-m.left)/m.width*2-1,_=-((x-m.top)/m.height)*2+1;if(ig.set(C,_),A.setFromCamera(ig,d),!t)d.getWorldDirection(Xa).negate();else switch(t){case"x":Xa.set(1,0,0);break;case"y":Xa.set(0,1,0);break;case"z":Xa.set(0,0,1);break}ng.setFromNormalAndCoplanarPoint(Xa,qr),A.ray.intersectPlane(ng,qr);const S=y.current.matrix.clone(),b=y.current.matrixWorld.clone(),T=new Q(qr.x-zc.x,qr.y-zc.y,qr.z-zc.z);if(i&&(T.x=i[0]?Math.max(Math.min(T.x,i[0][1]),i[0][0]):T.x,T.y=i[1]?Math.max(Math.min(T.y,i[1][1]),i[1][0]):T.y,T.z=i[2]?Math.max(Math.min(T.z,i[2][1]),i[2][0]):T.z),r){y.current.matrix.setPosition(T);const R=y.current.matrix.clone().multiply(S.invert()),w=y.current.matrix.clone().multiply(b.invert());o&&o(y.current.matrix,R,y.current.matrixWorld,w)}else{const R=new we().copy(y.current.matrix);R.setPosition(T);const w=R.clone().multiply(S.invert()),B=R.clone().multiply(b.invert());o&&o(R,w,y.current.matrixWorld,B)}p()},onDragEnd:()=>{f&&(f.enabled=!0),a&&a(),p()}},{drag:{filterTaps:!0,threshold:1,...typeof c=="object"?c:{}}});return g.useImperativeHandle(h,()=>y.current,[]),g.useLayoutEffect(()=>{e&&(y.current.matrix=e)},[e]),g.createElement("group",Ae({ref:y},v(),{matrix:e,matrixAutoUpdate:!1},u),l)});function $l(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function J0(r,e){return J0=Object.setPrototypeOf||function(i,n){return i.__proto__=n,i},J0(r,e)}function JS(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function ZS(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];var i=e[0],n=e[1],s=e[2],o=e[3],a=e[4],l=e[5],c=e[6],u=e[7],h=e[8];return i*a*h+n*l*c+s*o*u-s*a*c-n*o*h-i*l*u}function sg(r,e){for(var t=[],i=r.toArray(),n=e.toArray(),s=0;s<i.length;s++)t[s]=i[s]+n[s];return new Fn().fromArray(t)}function eT(r){if(Array.isArray(r))return r}function tT(r,e){var t=r==null?null:typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(t!=null){var i=[],n=!0,s=!1,o,a;try{for(t=t.call(r);!(n=(o=t.next()).done)&&(i.push(o.value),!(e&&i.length===e));n=!0);}catch(l){s=!0,a=l}finally{try{!n&&t.return!=null&&t.return()}finally{if(s)throw a}}return i}}function Z0(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=r[t];return i}function HE(r,e){if(r){if(typeof r=="string")return Z0(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return Z0(r,e)}}function iT(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ys(r,e){return eT(r)||tT(r,e)||HE(r,e)||iT()}function nT(r){if(Array.isArray(r))return Z0(r)}function sT(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function rT(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ch(r){return nT(r)||sT(r)||HE(r)||rT()}function nh(r,e,t){return JS()?nh=Reflect.construct:nh=function(n,s,o){var a=[null];a.push.apply(a,s);var l=Function.bind.apply(n,a),c=new l;return o&&J0(c,o.prototype),c},nh.apply(null,arguments)}function oT(r){var e=Ys(r[0],2),t=e[0],i=e[1],n=Ys(r[1],2),s=n[0],o=n[1],a=Ys(r[2],2),l=a[0],c=a[1];return ZS(t,i,1,s,o,1,l,c,1)}function aT(r){return oT(r)===0}var lT=new De,cT=new De;function rg(r){var e=r.map(function(c){return Array.isArray(c)?nh(De,Ch(c)):c}),t=Ys(e,3),i=t[0],n=t[1],s=t[2];if(aT(r))return!1;var o=lT.subVectors(n,i),a=cT.subVectors(s,i),l=a.cross(o);return l>0}function VE(r,e,t){return Math.max(e,Math.min(t,r))}function KE(r,e){return VE(r-Math.floor(r/e)*e,0,e)}function $E(r,e){var t=KE(e-r,Math.PI*2);return t>Math.PI&&(t-=Math.PI*2),t}function uT(r){return r/180*Math.PI}function hT(r){return r*180/Math.PI}function fT(r,e){for(var t=e.radius,i=t===void 0?1:t,n=r.length/3,s=2/n,o=Math.PI*(3-2.2360679775),a=0;a<r.length;a+=3){var l=a*s-1+s/2,c=Math.sqrt(1-Math.pow(l,2)),u=a%n*o,h=Math.cos(u)*c,f=Math.sin(u)*c;r[a]=h*i,r[a+1]=l*i,r[a+2]=f*i}}function dT(r,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Number.EPSILON;return Math.abs(r.x-e.x)<t&&Math.abs(r.y-e.y)<t&&Math.abs(r.z-e.z)<t}function YE(r,e){return r.x===e.x?typeof r.z<"u"&&r.y===e.y?r.z-e.z:r.y-e.y:r.x-e.x}function mT(r){for(var e=r.sort(YE),t=[e[0],e[1]],i=2;i<e.length;i++)for(t.push(e[i]);t.length>2&&rg(Ch(t.slice(-3)));)t.splice(t.length-2,1);for(var n=[e[e.length-1],e[e.length-2]],s=e.length-3;s>=0;s--)for(n.push(e[s]);n.length>2&&rg(Ch(n.slice(-3)));)n.splice(n.length-2,1);n.splice(0,1),n.splice(n.length-1,1);var o=[].concat(t,n);return o}function AT(r,e,t){var i=Ys(e,2),n=i[0],s=i[1],o=Ys(t,2),a=o[0],l=o[1];return a+(r-n)*(l-a)/(s-n)}function pT(r){return r*r*r*(r*(r*6-15)+10)}function gT(r,e,t){return r*(1-t)+e*t}function WE(r,e,t){return(t-r)/(e-r)}function yT(r,e,t){var i=Math.sqrt(r*r+e*e+t*t);return[r/i,e/i,t/i]}function vT(r,e,t){var i=r*r,n=e*e,s=t*t,o=r*Math.sqrt(1-(n+s)/2+n*s/3),a=e*Math.sqrt(1-(s+i)/2+s*i/3),l=t*Math.sqrt(1-(i+n)/2+i*n/3);return[o,a,l]}function jE(r,e){var t=new Q().crossVectors(r,e),i=r.dot(e),n=new Fn().identity(),s=new Fn().set(0,-t.z,t.y,t.z,0,-t.x,-t.y,t.x,0),o=new Fn().multiplyMatrices(s,s).multiplyScalar(1/(1+i)),a=sg(sg(n,s),o);return a}function ET(r,e,t){var i=Math.asin(e),n=Math.atan2(r,-t);return[i,n]}function xT(r,e){var t=Math.sin(r),i=Math.cos(r),n=Math.sin(e)*i,s=-Math.cos(e)*i;return[n,t,s]}function IT(r,e){var t=Ys(e,2),i=t[0],n=t[1],s=jE(r.normal,new Q(0,1,0)),o=WE(i.clone().applyMatrix3(s).y,n.clone().applyMatrix3(s).y,0);return new Q().lerpVectors(i,n,o)}function CT(r,e){var t=e.normal.dot(r);return t}function _T(r,e){var t=Ys(r,3),i=t[0],n=t[1],s=t[2],o=Ys(e,2),a=o[0],l=o[1];return s*a*l+n*a+i}function ST(r,e){var t=Ys(e,2),i=t[0],n=t[1],s=i*n,o=r/s,a=r-s*o,l=a/i,c=a%i;return[c,l,o]}function TT(r,e){return r[0]+e[0]*r[1]}function bT(r,e){var t=r%e,i=Math.floor(r/e);return[t,i]}var Hc=Object.freeze({__proto__:null,clamp:VE,repeat:KE,deltaAngle:$E,degToRad:uT,radToDeg:hT,fibonacciOnSphere:fT,vectorEquals:dT,lexicographic:YE,convexHull:mT,remap:AT,fade:pT,lerp:gT,inverseLerp:WE,normalize:yT,pointOnCubeToPointOnSphere:vT,rotateVectorOnVector:jE,pointToCoordinate:ET,coordinateToPoint:xT,planeSegmentIntersection:IT,pointToPlaneDistance:CT,getIndexFrom3D:_T,get3DFromIndex:ST,getIndexFrom2D:TT,get2DFromIndex:bT});function qE(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var Vn=function r(e,t,i){var n=this;qE(this,r),$l(this,"dot2",function(s,o){return n.x*s+n.y*o}),$l(this,"dot3",function(s,o,a){return n.x*s+n.y*o+n.z*a}),this.x=e,this.y=t,this.z=i},wT=[new Vn(1,1,0),new Vn(-1,1,0),new Vn(1,-1,0),new Vn(-1,-1,0),new Vn(1,0,1),new Vn(-1,0,1),new Vn(1,0,-1),new Vn(-1,0,-1),new Vn(0,1,1),new Vn(0,-1,1),new Vn(0,1,-1),new Vn(0,-1,-1)],og=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],ag=new Array(512),lg=new Array(512),BT=function(e){e>0&&e<1&&(e*=65536),e=Math.floor(e),e<256&&(e|=e<<8);for(var t=0;t<256;t++){var i;t&1?i=og[t]^e&255:i=og[t]^e>>8&255,ag[t]=ag[t+256]=i,lg[t]=lg[t+256]=wT[i%12]}};BT(0);function RT(r){if(typeof r=="number")r=Math.abs(r);else if(typeof r=="string"){var e=r;r=0;for(var t=0;t<e.length;t++)r=(r+(t+1)*(e.charCodeAt(t)%96))%2147483647}return r===0&&(r=311),r}function cg(r){var e=RT(r);return function(){var t=e*48271%2147483647;return e=t,t/2147483647}}var DT=function r(e){var t=this;qE(this,r),$l(this,"seed",0),$l(this,"init",function(i){t.seed=i,t.value=cg(i)}),$l(this,"value",cg(this.seed)),this.init(e)};new DT(Math.random());var MT=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.01,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1/(2*Math.PI);return i/Math.atan(1/t)*Math.atan(Math.sin(2*Math.PI*e*n)/t)},XE=function(e){return 1/(1+e+.48*e*e+.235*e*e*e)},LT=function(e){return e},PT={in:function(e){return 1-Math.cos(e*Math.PI/2)},out:function(e){return Math.sin(e*Math.PI/2)},inOut:function(e){return-(Math.cos(Math.PI*e)-1)/2}},FT={in:function(e){return e*e*e},out:function(e){return 1-Math.pow(1-e,3)},inOut:function(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}},kT={in:function(e){return e*e*e*e*e},out:function(e){return 1-Math.pow(1-e,5)},inOut:function(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}},OT={in:function(e){return 1-Math.sqrt(1-Math.pow(e,2))},out:function(e){return Math.sqrt(1-Math.pow(e-1,2))},inOut:function(e){return e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2}},UT={in:function(e){return e*e*e*e},out:function(e){return 1- --e*e*e*e},inOut:function(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}},NT={in:function(e){return e===0?0:Math.pow(2,10*e-10)},out:function(e){return e===1?1:1-Math.pow(2,-10*e)},inOut:function(e){return e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2}};function Qi(r,e,t){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:.25,n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:.01,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:1/0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:XE,a=arguments.length>7&&arguments[7]!==void 0?arguments[7]:.001,l="velocity_"+e;if(r.__damp===void 0&&(r.__damp={}),r.__damp[l]===void 0&&(r.__damp[l]=0),Math.abs(r[e]-t)<=a)return r[e]=t,!1;i=Math.max(1e-4,i);var c=2/i,u=o(c*n),h=r[e]-t,f=t,d=s*i;h=Math.min(Math.max(h,-d),d),t=r[e]-h;var m=(r.__damp[l]+c*h)*n;r.__damp[l]=(r.__damp[l]-c*m)*u;var A=t+(h+m)*u;return f-r[e]>0==A>f&&(A=f,r.__damp[l]=(A-f)/n),r[e]=A,!0}var GT=function(e){return e&&e.isCamera},QT=function(e){return e&&e.isLight},Ja=new Q,ug=new st,hg=new st,Za=new we,Vf=new Q;function zT(r,e,t,i,n,s,o){typeof e=="number"?Ja.setScalar(e):Array.isArray(e)?Ja.set(e[0],e[1],e[2]):Ja.copy(e);var a=r.parent;r.updateWorldMatrix(!0,!1),Vf.setFromMatrixPosition(r.matrixWorld),GT(r)||QT(r)?Za.lookAt(Vf,Ja,r.up):Za.lookAt(Ja,Vf,r.up),_h(r.quaternion,hg.setFromRotationMatrix(Za),t,i,n,s,o),a&&(Za.extractRotation(a.matrixWorld),ug.setFromRotationMatrix(Za),_h(r.quaternion,hg.copy(r.quaternion).premultiply(ug.invert()),t,i,n,s,o))}function va(r,e,t,i,n,s,o,a){return Qi(r,e,r[e]+$E(r[e],t),i,n,s,o,a)}var el=new De,fg,dg;function HT(r,e,t,i,n,s,o){return typeof e=="number"?el.setScalar(e):Array.isArray(e)?el.set(e[0],e[1]):el.copy(e),fg=Qi(r,"x",el.x,t,i,n,s,o),dg=Qi(r,"y",el.y,t,i,n,s,o),fg||dg}var bo=new Q,mg,Ag,pg;function em(r,e,t,i,n,s,o){return typeof e=="number"?bo.setScalar(e):Array.isArray(e)?bo.set(e[0],e[1],e[2]):bo.copy(e),mg=Qi(r,"x",bo.x,t,i,n,s,o),Ag=Qi(r,"y",bo.y,t,i,n,s,o),pg=Qi(r,"z",bo.z,t,i,n,s,o),mg||Ag||pg}var Xr=new yi,gg,yg,vg,Eg;function VT(r,e,t,i,n,s,o){return typeof e=="number"?Xr.setScalar(e):Array.isArray(e)?Xr.set(e[0],e[1],e[2],e[3]):Xr.copy(e),gg=Qi(r,"x",Xr.x,t,i,n,s,o),yg=Qi(r,"y",Xr.y,t,i,n,s,o),vg=Qi(r,"z",Xr.z,t,i,n,s,o),Eg=Qi(r,"w",Xr.w,t,i,n,s,o),gg||yg||vg||Eg}var tl=new kn,xg,Ig,Cg;function KT(r,e,t,i,n,s,o){return Array.isArray(e)?tl.set(e[0],e[1],e[2],e[3]):tl.copy(e),xg=va(r,"x",tl.x,t,i,n,s,o),Ig=va(r,"y",tl.y,t,i,n,s,o),Cg=va(r,"z",tl.z,t,i,n,s,o),xg||Ig||Cg}var wo=new We,_g,Sg,Tg;function $T(r,e,t,i,n,s,o){return e instanceof We?wo.copy(e):Array.isArray(e)?wo.setRGB(e[0],e[1],e[2]):wo.set(e),_g=Qi(r,"r",wo.r,t,i,n,s,o),Sg=Qi(r,"g",wo.g,t,i,n,s,o),Tg=Qi(r,"b",wo.b,t,i,n,s,o),_g||Sg||Tg}var fs=new st,er=new yi,bg=new yi,il=new yi,wg,Bg,Rg,Dg;function _h(r,e,t,i,n,s,o){var a=r;Array.isArray(e)?fs.set(e[0],e[1],e[2],e[3]):fs.copy(e);var l=r.dot(fs)>0?1:-1;return fs.x*=l,fs.y*=l,fs.z*=l,fs.w*=l,wg=Qi(r,"x",fs.x,t,i,n,s,o),Bg=Qi(r,"y",fs.y,t,i,n,s,o),Rg=Qi(r,"z",fs.z,t,i,n,s,o),Dg=Qi(r,"w",fs.w,t,i,n,s,o),er.set(r.x,r.y,r.z,r.w).normalize(),bg.set(a.__damp.velocity_x,a.__damp.velocity_y,a.__damp.velocity_z,a.__damp.velocity_w),il.copy(er).multiplyScalar(bg.dot(er)/er.dot(er)),a.__damp.velocity_x-=il.x,a.__damp.velocity_y-=il.y,a.__damp.velocity_z-=il.z,a.__damp.velocity_w-=il.w,r.set(er.x,er.y,er.z,er.w),wg||Bg||Rg||Dg}var nl=new wa,Mg,Lg,Pg;function YT(r,e,t,i,n,s,o){return Array.isArray(e)?nl.set(e[0],e[1],e[2]):nl.copy(e),Mg=Qi(r,"radius",nl.radius,t,i,n,s,o),Lg=va(r,"phi",nl.phi,t,i,n,s,o),Pg=va(r,"theta",nl.theta,t,i,n,s,o),Mg||Lg||Pg}var Vc=new we,Fg=new Q,kg=new st,Og=new Q,Ug,Ng,Gg;function WT(r,e,t,i,n,s,o){var a=r;return a.__damp===void 0&&(a.__damp={position:new Q,rotation:new st,scale:new Q},r.decompose(a.__damp.position,a.__damp.rotation,a.__damp.scale)),Array.isArray(e)?Vc.set.apply(Vc,Ch(e)):Vc.copy(e),Vc.decompose(Fg,kg,Og),Ug=em(a.__damp.position,Fg,t,i,n,s,o),Ng=_h(a.__damp.rotation,kg,t,i,n,s,o),Gg=em(a.__damp.scale,Og,t,i,n,s,o),r.compose(a.__damp.position,a.__damp.rotation,a.__damp.scale),Ug||Ng||Gg}var Da=Object.freeze({__proto__:null,rsqw:MT,exp:XE,linear:LT,sine:PT,cubic:FT,quint:kT,circ:OT,quart:UT,expo:NT,damp:Qi,dampLookAt:zT,dampAngle:va,damp2:HT,damp3:em,damp4:VT,dampE:KT,dampC:$T,dampQ:_h,dampS:YT,dampM:WT});const hA=g.createContext(null);function JE(){return g.useContext(hA)}function wO({eps:r=1e-5,enabled:e=!0,infinite:t,horizontal:i,pages:n=1,distance:s=1,damping:o=.25,maxSpeed:a=1/0,prepend:l=!1,style:c={},children:u}){const{get:h,setEvents:f,gl:d,size:m,invalidate:A,events:p}=ae(),[y]=g.useState(()=>document.createElement("div")),[v]=g.useState(()=>document.createElement("div")),[E]=g.useState(()=>document.createElement("div")),x=d.domElement.parentNode,I=g.useRef(0),C=g.useMemo(()=>({el:y,eps:r,fill:v,fixed:E,horizontal:i,damping:o,offset:0,delta:0,scroll:I,pages:n,range(b,T,R=0){const w=b-R,B=w+T+R*2;return this.offset<w?0:this.offset>B?1:(this.offset-w)/(B-w)},curve(b,T,R=0){return Math.sin(this.range(b,T,R)*Math.PI)},visible(b,T,R=0){const w=b-R,B=w+T+R*2;return this.offset>=w&&this.offset<=B}}),[r,o,i,n]);g.useEffect(()=>{y.style.position="absolute",y.style.width="100%",y.style.height="100%",y.style[i?"overflowX":"overflowY"]="auto",y.style[i?"overflowY":"overflowX"]="hidden",y.style.top="0px",y.style.left="0px";for(const T in c)y.style[T]=c[T];E.style.position="sticky",E.style.top="0px",E.style.left="0px",E.style.width="100%",E.style.height="100%",E.style.overflow="hidden",y.appendChild(E),v.style.height=i?"100%":`${n*s*100}%`,v.style.width=i?`${n*s*100}%`:"100%",v.style.pointerEvents="none",y.appendChild(v),l?x.prepend(y):x.appendChild(y),y[i?"scrollLeft":"scrollTop"]=1;const S=p.connected||d.domElement;requestAnimationFrame(()=>p.connect==null?void 0:p.connect(y));const b=h().events.compute;return f({compute(T,R){const{left:w,top:B}=x.getBoundingClientRect(),M=T.clientX-w,O=T.clientY-B;R.pointer.set(M/R.size.width*2-1,-(O/R.size.height)*2+1),R.raycaster.setFromCamera(R.pointer,R.camera)}}),()=>{x.removeChild(y),f({compute:b}),p.connect==null||p.connect(S)}},[n,s,i,y,v,E,x]),g.useEffect(()=>{if(p.connected===y){const S=m[i?"width":"height"],b=y[i?"scrollWidth":"scrollHeight"],T=b-S;let R=0,w=!0,B=!0;const M=()=>{if(!(!e||B)&&(A(),R=y[i?"scrollLeft":"scrollTop"],I.current=R/T,t)){if(!w){if(R>=T){const U=1-C.offset;y[i?"scrollLeft":"scrollTop"]=1,I.current=C.offset=-U,w=!0}else if(R<=0){const U=1+C.offset;y[i?"scrollLeft":"scrollTop"]=b,I.current=C.offset=U,w=!0}}w&&setTimeout(()=>w=!1,40)}};y.addEventListener("scroll",M,{passive:!0}),requestAnimationFrame(()=>B=!1);const O=U=>y.scrollLeft+=U.deltaY/2;return i&&y.addEventListener("wheel",O,{passive:!0}),()=>{y.removeEventListener("scroll",M),i&&y.removeEventListener("wheel",O)}}},[y,p,m,t,C,A,i,e]);let _=0;return Ve((S,b)=>{_=C.offset,Da.damp(C,"offset",I.current,o,b,a,void 0,r),Da.damp(C,"delta",Math.abs(_-C.offset),o,b,a,void 0,r),C.delta>r&&A()}),g.createElement(hA.Provider,{value:C},u)}const jT=g.forwardRef(({children:r},e)=>{const t=g.useRef(null);g.useImperativeHandle(e,()=>t.current,[]);const i=JE(),{width:n,height:s}=ae(o=>o.viewport);return Ve(()=>{t.current.position.x=i.horizontal?-n*(i.pages-1)*i.offset:0,t.current.position.y=i.horizontal?0:s*(i.pages-1)*i.offset}),g.createElement("group",{ref:t},r)}),qT=g.forwardRef(({children:r,style:e,...t},i)=>{const n=JE(),s=g.useRef(null);g.useImperativeHandle(i,()=>s.current,[]);const{width:o,height:a}=ae(u=>u.size),l=g.useContext(W0),c=g.useMemo(()=>nE.createRoot(n.fixed),[n.fixed]);return Ve(()=>{n.delta>n.eps&&(s.current.style.transform=`translate3d(${n.horizontal?-o*(n.pages-1)*n.offset:0}px,${n.horizontal?0:a*(n.pages-1)*-n.offset}px,0)`)}),c.render(g.createElement("div",Ae({ref:s,style:{...e,position:"absolute",top:0,left:0,willChange:"transform"}},t),g.createElement(hA.Provider,{value:n},g.createElement(W0.Provider,{value:l},r)))),null}),BO=g.forwardRef(({html:r,...e},t)=>{const i=r?qT:jT;return g.createElement(i,Ae({ref:t},e))});var fA=wc(),At=r=>bc(r,fA),dA=wc();At.write=r=>bc(r,dA);var tf=wc();At.onStart=r=>bc(r,tf);var mA=wc();At.onFrame=r=>bc(r,mA);var AA=wc();At.onFinish=r=>bc(r,AA);var Ea=[];At.setTimeout=(r,e)=>{const t=At.now()+e,i=()=>{const s=Ea.findIndex(o=>o.cancel==i);~s&&Ea.splice(s,1),Or-=~s?1:0},n={time:t,handler:r,cancel:i};return Ea.splice(ZE(t),0,n),Or+=1,e3(),n};var ZE=r=>~(~Ea.findIndex(e=>e.time>r)||~Ea.length);At.cancel=r=>{tf.delete(r),mA.delete(r),AA.delete(r),fA.delete(r),dA.delete(r)};At.sync=r=>{tm=!0,At.batchedUpdates(r),tm=!1};At.throttle=r=>{let e;function t(){try{r(...e)}finally{e=null}}function i(...n){e=n,At.onStart(t)}return i.handler=r,i.cancel=()=>{tf.delete(t),e=null},i};var pA=typeof window<"u"?window.requestAnimationFrame:(()=>{});At.use=r=>pA=r;At.now=typeof performance<"u"?()=>performance.now():Date.now;At.batchedUpdates=r=>r();At.catch=console.error;At.frameLoop="always";At.advance=()=>{At.frameLoop!=="demand"?console.warn("Cannot call the manual advancement of rafz whilst frameLoop is not set as demand"):i3()};var kr=-1,Or=0,tm=!1;function bc(r,e){tm?(e.delete(r),r(0)):(e.add(r),e3())}function e3(){kr<0&&(kr=0,At.frameLoop!=="demand"&&pA(t3))}function XT(){kr=-1}function t3(){~kr&&(pA(t3),At.batchedUpdates(i3))}function i3(){const r=kr;kr=At.now();const e=ZE(kr);if(e&&(n3(Ea.splice(0,e),t=>t.handler()),Or-=e),!Or){XT();return}tf.flush(),fA.flush(r?Math.min(64,kr-r):16.667),mA.flush(),dA.flush(),AA.flush()}function wc(){let r=new Set,e=r;return{add(t){Or+=e==r&&!r.has(t)?1:0,r.add(t)},delete(t){return Or-=e==r&&r.has(t)?1:0,r.delete(t)},flush(t){e.size&&(r=new Set,Or-=e.size,n3(e,i=>i(t)&&r.add(i)),Or+=r.size,e=r)}}}function n3(r,e){r.forEach(t=>{try{e(t)}catch(i){At.catch(i)}})}var JT=Object.defineProperty,ZT=(r,e)=>{for(var t in e)JT(r,t,{get:e[t],enumerable:!0})},Ts={};ZT(Ts,{assign:()=>t5,colors:()=>Gr,createStringInterpolator:()=>yA,skipAnimation:()=>r3,to:()=>s3,willAdvance:()=>vA});function im(){}var e5=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,configurable:!0}),Ne={arr:Array.isArray,obj:r=>!!r&&r.constructor.name==="Object",fun:r=>typeof r=="function",str:r=>typeof r=="string",num:r=>typeof r=="number",und:r=>r===void 0};function lr(r,e){if(Ne.arr(r)){if(!Ne.arr(e)||r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}return r===e}var Ut=(r,e)=>r.forEach(e);function gr(r,e,t){if(Ne.arr(r)){for(let i=0;i<r.length;i++)e.call(t,r[i],`${i}`);return}for(const i in r)r.hasOwnProperty(i)&&e.call(t,r[i],i)}var is=r=>Ne.und(r)?[]:Ne.arr(r)?r:[r];function Yl(r,e){if(r.size){const t=Array.from(r);r.clear(),Ut(t,e)}}var Nl=(r,...e)=>Yl(r,t=>t(...e)),gA=()=>typeof window>"u"||!window.navigator||/ServerSideRendering|^Deno\//.test(window.navigator.userAgent),yA,s3,Gr=null,r3=!1,vA=im,t5=r=>{r.to&&(s3=r.to),r.now&&(At.now=r.now),r.colors!==void 0&&(Gr=r.colors),r.skipAnimation!=null&&(r3=r.skipAnimation),r.createStringInterpolator&&(yA=r.createStringInterpolator),r.requestAnimationFrame&&At.use(r.requestAnimationFrame),r.batchedUpdates&&(At.batchedUpdates=r.batchedUpdates),r.willAdvance&&(vA=r.willAdvance),r.frameLoop&&(At.frameLoop=r.frameLoop)},Wl=new Set,Zn=[],Kf=[],Sh=0,nf={get idle(){return!Wl.size&&!Zn.length},start(r){Sh>r.priority?(Wl.add(r),At.onStart(i5)):(o3(r),At(nm))},advance:nm,sort(r){if(Sh)At.onFrame(()=>nf.sort(r));else{const e=Zn.indexOf(r);~e&&(Zn.splice(e,1),a3(r))}},clear(){Zn=[],Wl.clear()}};function i5(){Wl.forEach(o3),Wl.clear(),At(nm)}function o3(r){Zn.includes(r)||a3(r)}function a3(r){Zn.splice(n5(Zn,e=>e.priority>r.priority),0,r)}function nm(r){const e=Kf;for(let t=0;t<Zn.length;t++){const i=Zn[t];Sh=i.priority,i.idle||(vA(i),i.advance(r),i.idle||e.push(i))}return Sh=0,Kf=Zn,Kf.length=0,Zn=e,Zn.length>0}function n5(r,e){const t=r.findIndex(e);return t<0?r.length:t}var s5={transparent:0,aliceblue:4042850303,antiquewhite:4209760255,aqua:16777215,aquamarine:2147472639,azure:4043309055,beige:4126530815,bisque:4293182719,black:255,blanchedalmond:4293643775,blue:65535,blueviolet:2318131967,brown:2771004159,burlywood:3736635391,burntsienna:3934150143,cadetblue:1604231423,chartreuse:2147418367,chocolate:3530104575,coral:4286533887,cornflowerblue:1687547391,cornsilk:4294499583,crimson:3692313855,cyan:16777215,darkblue:35839,darkcyan:9145343,darkgoldenrod:3095792639,darkgray:2846468607,darkgreen:6553855,darkgrey:2846468607,darkkhaki:3182914559,darkmagenta:2332068863,darkolivegreen:1433087999,darkorange:4287365375,darkorchid:2570243327,darkred:2332033279,darksalmon:3918953215,darkseagreen:2411499519,darkslateblue:1211993087,darkslategray:793726975,darkslategrey:793726975,darkturquoise:13554175,darkviolet:2483082239,deeppink:4279538687,deepskyblue:12582911,dimgray:1768516095,dimgrey:1768516095,dodgerblue:512819199,firebrick:2988581631,floralwhite:4294635775,forestgreen:579543807,fuchsia:4278255615,gainsboro:3705462015,ghostwhite:4177068031,gold:4292280575,goldenrod:3668254975,gray:2155905279,green:8388863,greenyellow:2919182335,grey:2155905279,honeydew:4043305215,hotpink:4285117695,indianred:3445382399,indigo:1258324735,ivory:4294963455,khaki:4041641215,lavender:3873897215,lavenderblush:4293981695,lawngreen:2096890111,lemonchiffon:4294626815,lightblue:2916673279,lightcoral:4034953471,lightcyan:3774873599,lightgoldenrodyellow:4210742015,lightgray:3553874943,lightgreen:2431553791,lightgrey:3553874943,lightpink:4290167295,lightsalmon:4288707327,lightseagreen:548580095,lightskyblue:2278488831,lightslategray:2005441023,lightslategrey:2005441023,lightsteelblue:2965692159,lightyellow:4294959359,lime:16711935,limegreen:852308735,linen:4210091775,magenta:4278255615,maroon:2147483903,mediumaquamarine:1724754687,mediumblue:52735,mediumorchid:3126187007,mediumpurple:2473647103,mediumseagreen:1018393087,mediumslateblue:2070474495,mediumspringgreen:16423679,mediumturquoise:1221709055,mediumvioletred:3340076543,midnightblue:421097727,mintcream:4127193855,mistyrose:4293190143,moccasin:4293178879,navajowhite:4292783615,navy:33023,oldlace:4260751103,olive:2155872511,olivedrab:1804477439,orange:4289003775,orangered:4282712319,orchid:3664828159,palegoldenrod:4008225535,palegreen:2566625535,paleturquoise:2951671551,palevioletred:3681588223,papayawhip:4293907967,peachpuff:4292524543,peru:3448061951,pink:4290825215,plum:3718307327,powderblue:2967529215,purple:2147516671,rebeccapurple:1714657791,red:4278190335,rosybrown:3163525119,royalblue:1097458175,saddlebrown:2336560127,salmon:4202722047,sandybrown:4104413439,seagreen:780883967,seashell:4294307583,sienna:2689740287,silver:3233857791,skyblue:2278484991,slateblue:1784335871,slategray:1887473919,slategrey:1887473919,snow:4294638335,springgreen:16744447,steelblue:1182971135,tan:3535047935,teal:8421631,thistle:3636451583,tomato:4284696575,turquoise:1088475391,violet:4001558271,wheat:4125012991,white:4294967295,whitesmoke:4126537215,yellow:4294902015,yellowgreen:2597139199},_s="[-+]?\\d*\\.?\\d+",Th=_s+"%";function sf(...r){return"\\(\\s*("+r.join(")\\s*,\\s*(")+")\\s*\\)"}var r5=new RegExp("rgb"+sf(_s,_s,_s)),o5=new RegExp("rgba"+sf(_s,_s,_s,_s)),a5=new RegExp("hsl"+sf(_s,Th,Th)),l5=new RegExp("hsla"+sf(_s,Th,Th,_s)),c5=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,u5=/^#([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,h5=/^#([0-9a-fA-F]{6})$/,f5=/^#([0-9a-fA-F]{8})$/;function d5(r){let e;return typeof r=="number"?r>>>0===r&&r>=0&&r<=4294967295?r:null:(e=h5.exec(r))?parseInt(e[1]+"ff",16)>>>0:Gr&&Gr[r]!==void 0?Gr[r]:(e=r5.exec(r))?(Bo(e[1])<<24|Bo(e[2])<<16|Bo(e[3])<<8|255)>>>0:(e=o5.exec(r))?(Bo(e[1])<<24|Bo(e[2])<<16|Bo(e[3])<<8|Hg(e[4]))>>>0:(e=c5.exec(r))?parseInt(e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+"ff",16)>>>0:(e=f5.exec(r))?parseInt(e[1],16)>>>0:(e=u5.exec(r))?parseInt(e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+e[4]+e[4],16)>>>0:(e=a5.exec(r))?(Qg(zg(e[1]),Kc(e[2]),Kc(e[3]))|255)>>>0:(e=l5.exec(r))?(Qg(zg(e[1]),Kc(e[2]),Kc(e[3]))|Hg(e[4]))>>>0:null}function $f(r,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?r+(e-r)*6*t:t<1/2?e:t<2/3?r+(e-r)*(2/3-t)*6:r}function Qg(r,e,t){const i=t<.5?t*(1+e):t+e-t*e,n=2*t-i,s=$f(n,i,r+1/3),o=$f(n,i,r),a=$f(n,i,r-1/3);return Math.round(s*255)<<24|Math.round(o*255)<<16|Math.round(a*255)<<8}function Bo(r){const e=parseInt(r,10);return e<0?0:e>255?255:e}function zg(r){return(parseFloat(r)%360+360)%360/360}function Hg(r){const e=parseFloat(r);return e<0?0:e>1?255:Math.round(e*255)}function Kc(r){const e=parseFloat(r);return e<0?0:e>100?1:e/100}function Vg(r){let e=d5(r);if(e===null)return r;e=e||0;const t=(e&4278190080)>>>24,i=(e&16711680)>>>16,n=(e&65280)>>>8,s=(e&255)/255;return`rgba(${t}, ${i}, ${n}, ${s})`}var cc=(r,e,t)=>{if(Ne.fun(r))return r;if(Ne.arr(r))return cc({range:r,output:e,extrapolate:t});if(Ne.str(r.output[0]))return yA(r);const i=r,n=i.output,s=i.range||[0,1],o=i.extrapolateLeft||i.extrapolate||"extend",a=i.extrapolateRight||i.extrapolate||"extend",l=i.easing||(c=>c);return c=>{const u=A5(c,s);return m5(c,s[u],s[u+1],n[u],n[u+1],l,o,a,i.map)}};function m5(r,e,t,i,n,s,o,a,l){let c=l?l(r):r;if(c<e){if(o==="identity")return c;o==="clamp"&&(c=e)}if(c>t){if(a==="identity")return c;a==="clamp"&&(c=t)}return i===n?i:e===t?r<=e?i:n:(e===-1/0?c=-c:t===1/0?c=c-e:c=(c-e)/(t-e),c=s(c),i===-1/0?c=-c:n===1/0?c=c+i:c=c*(n-i)+i,c)}function A5(r,e){for(var t=1;t<e.length-1&&!(e[t]>=r);++t);return t-1}var p5={linear:r=>r},uc=Symbol.for("FluidValue.get"),Ma=Symbol.for("FluidValue.observers"),Gs=r=>!!(r&&r[uc]),Xn=r=>r&&r[uc]?r[uc]():r,Kg=r=>r[Ma]||null;function g5(r,e){r.eventObserved?r.eventObserved(e):r(e)}function bh(r,e){const t=r[Ma];t&&t.forEach(i=>{g5(i,e)})}var y5=class{constructor(r){if(!r&&!(r=this.get))throw Error("Unknown getter");v5(this,r)}},v5=(r,e)=>l3(r,uc,e);function Bc(r,e){if(r[uc]){let t=r[Ma];t||l3(r,Ma,t=new Set),t.has(e)||(t.add(e),r.observerAdded&&r.observerAdded(t.size,e))}return e}function wh(r,e){const t=r[Ma];if(t&&t.has(e)){const i=t.size-1;i?t.delete(e):r[Ma]=null,r.observerRemoved&&r.observerRemoved(i,e)}}var l3=(r,e,t)=>Object.defineProperty(r,e,{value:t,writable:!0,configurable:!0}),sh=/[+\-]?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,E5=/(#(?:[0-9a-f]{2}){2,4}|(#[0-9a-f]{3})|(rgb|hsl)a?\((-?\d+%?[,\s]+){2,3}\s*[\d\.]+%?\))/gi,$g=new RegExp(`(${sh.source})(%|[a-z]+)`,"i"),x5=/rgba\(([0-9\.-]+), ([0-9\.-]+), ([0-9\.-]+), ([0-9\.-]+)\)/gi,rf=/var\((--[a-zA-Z0-9-_]+),? ?([a-zA-Z0-9 ()%#.,-]+)?\)/,c3=r=>{const[e,t]=I5(r);if(!e||gA())return r;const i=window.getComputedStyle(document.documentElement).getPropertyValue(e);if(i)return i.trim();if(t&&t.startsWith("--")){const n=window.getComputedStyle(document.documentElement).getPropertyValue(t);return n||r}else{if(t&&rf.test(t))return c3(t);if(t)return t}return r},I5=r=>{const e=rf.exec(r);if(!e)return[,];const[,t,i]=e;return[t,i]},Yf,C5=(r,e,t,i,n)=>`rgba(${Math.round(e)}, ${Math.round(t)}, ${Math.round(i)}, ${n})`,u3=r=>{Yf||(Yf=Gr?new RegExp(`(${Object.keys(Gr).join("|")})(?!\\w)`,"g"):/^\b$/);const e=r.output.map(s=>Xn(s).replace(rf,c3).replace(E5,Vg).replace(Yf,Vg)),t=e.map(s=>s.match(sh).map(Number)),n=t[0].map((s,o)=>t.map(a=>{if(!(o in a))throw Error('The arity of each "output" value must be equal');return a[o]})).map(s=>cc({...r,output:s}));return s=>{const o=!$g.test(e[0])&&e.find(l=>$g.test(l))?.replace(sh,"");let a=0;return e[0].replace(sh,()=>`${n[a++](s)}${o||""}`).replace(x5,C5)}},EA="react-spring: ",h3=r=>{const e=r;let t=!1;if(typeof e!="function")throw new TypeError(`${EA}once requires a function parameter`);return(...i)=>{t||(e(...i),t=!0)}},_5=h3(console.warn);function S5(){_5(`${EA}The "interpolate" function is deprecated in v9 (use "to" instead)`)}var T5=h3(console.warn);function b5(){T5(`${EA}Directly calling start instead of using the api object is deprecated in v9 (use ".start" instead), this will be removed in later 0.X.0 versions`)}function of(r){return Ne.str(r)&&(r[0]=="#"||/\d/.test(r)||!gA()&&rf.test(r)||r in(Gr||{}))}var xA=gA()?g.useEffect:g.useLayoutEffect,w5=()=>{const r=g.useRef(!1);return xA(()=>(r.current=!0,()=>{r.current=!1}),[]),r};function f3(){const r=g.useState()[1],e=w5();return()=>{e.current&&r(Math.random())}}function B5(r,e){const[t]=g.useState(()=>({inputs:e,result:r()})),i=g.useRef(),n=i.current;let s=n;return s?e&&s.inputs&&R5(e,s.inputs)||(s={inputs:e,result:r()}):s=t,g.useEffect(()=>{i.current=s,n==t&&(t.inputs=t.result=void 0)},[s]),s.result}function R5(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}var d3=r=>g.useEffect(r,D5),D5=[];function Yg(r){const e=g.useRef();return g.useEffect(()=>{e.current=r}),e.current}var hc=Symbol.for("Animated:node"),M5=r=>!!r&&r[hc]===r,Ns=r=>r&&r[hc],IA=(r,e)=>e5(r,hc,e),af=r=>r&&r[hc]&&r[hc].getPayload(),m3=class{constructor(){IA(this,this)}getPayload(){return this.payload||[]}},Rc=class extends m3{constructor(r){super(),this._value=r,this.done=!0,this.durationProgress=0,Ne.num(this._value)&&(this.lastPosition=this._value)}static create(r){return new Rc(r)}getPayload(){return[this]}getValue(){return this._value}setValue(r,e){return Ne.num(r)&&(this.lastPosition=r,e&&(r=Math.round(r/e)*e,this.done&&(this.lastPosition=r))),this._value===r?!1:(this._value=r,!0)}reset(){const{done:r}=this;this.done=!1,Ne.num(this._value)&&(this.elapsedTime=0,this.durationProgress=0,this.lastPosition=this._value,r&&(this.lastVelocity=null),this.v0=null)}},fc=class extends Rc{constructor(r){super(0),this._string=null,this._toString=cc({output:[r,r]})}static create(r){return new fc(r)}getValue(){const r=this._string;return r??(this._string=this._toString(this._value))}setValue(r){if(Ne.str(r)){if(r==this._string)return!1;this._string=r,this._value=1}else if(super.setValue(r))this._string=null;else return!1;return!0}reset(r){r&&(this._toString=cc({output:[this.getValue(),r]})),this._value=0,super.reset()}},Bh={dependencies:null},CA=class extends m3{constructor(r){super(),this.source=r,this.setValue(r)}getValue(r){const e={};return gr(this.source,(t,i)=>{M5(t)?e[i]=t.getValue(r):Gs(t)?e[i]=Xn(t):r||(e[i]=t)}),e}setValue(r){this.source=r,this.payload=this._makePayload(r)}reset(){this.payload&&Ut(this.payload,r=>r.reset())}_makePayload(r){if(r){const e=new Set;return gr(r,this._addToPayload,e),Array.from(e)}}_addToPayload(r){Bh.dependencies&&Gs(r)&&Bh.dependencies.add(r);const e=af(r);e&&Ut(e,t=>this.add(t))}},A3=class extends CA{constructor(r){super(r)}static create(r){return new A3(r)}getValue(){return this.source.map(r=>r.getValue())}setValue(r){const e=this.getPayload();return r.length==e.length?e.map((t,i)=>t.setValue(r[i])).some(Boolean):(super.setValue(r.map(L5)),!0)}};function L5(r){return(of(r)?fc:Rc).create(r)}function sm(r){const e=Ns(r);return e?e.constructor:Ne.arr(r)?A3:of(r)?fc:Rc}var Wg=(r,e)=>{const t=!Ne.fun(r)||r.prototype&&r.prototype.isReactComponent;return g.forwardRef((i,n)=>{const s=g.useRef(null),o=t&&g.useCallback(m=>{s.current=k5(n,m)},[n]),[a,l]=F5(i,e),c=f3(),u=()=>{const m=s.current;if(t&&!m)return;(m?e.applyAnimatedValues(m,a.getValue(!0)):!1)===!1&&c()},h=new P5(u,l),f=g.useRef();xA(()=>(f.current=h,Ut(l,m=>Bc(m,h)),()=>{f.current&&(Ut(f.current.deps,m=>wh(m,f.current)),At.cancel(f.current.update))})),g.useEffect(u,[]),d3(()=>()=>{const m=f.current;Ut(m.deps,A=>wh(A,m))});const d=e.getComponentProps(a.getValue());return g.createElement(r,{...d,ref:o})})},P5=class{constructor(r,e){this.update=r,this.deps=e}eventObserved(r){r.type=="change"&&At.write(this.update)}};function F5(r,e){const t=new Set;return Bh.dependencies=t,r.style&&(r={...r,style:e.createAnimatedStyle(r.style)}),r=new CA(r),Bh.dependencies=null,[r,t]}function k5(r,e){return r&&(Ne.fun(r)?r(e):r.current=e),e}var jg=Symbol.for("AnimatedComponent"),O5=(r,{applyAnimatedValues:e=()=>!1,createAnimatedStyle:t=n=>new CA(n),getComponentProps:i=n=>n}={})=>{const n={applyAnimatedValues:e,createAnimatedStyle:t,getComponentProps:i},s=o=>{const a=qg(o)||"Anonymous";return Ne.str(o)?o=s[o]||(s[o]=Wg(o,n)):o=o[jg]||(o[jg]=Wg(o,n)),o.displayName=`Animated(${a})`,o};return gr(r,(o,a)=>{Ne.arr(r)&&(a=qg(o)),s[a]=s(o)}),{animated:s}},qg=r=>Ne.str(r)?r:r&&Ne.str(r.displayName)?r.displayName:Ne.fun(r)&&r.name||null;function ao(r,...e){return Ne.fun(r)?r(...e):r}var jl=(r,e)=>r===!0||!!(e&&r&&(Ne.fun(r)?r(e):is(r).includes(e))),p3=(r,e)=>Ne.obj(r)?e&&r[e]:r,g3=(r,e)=>r.default===!0?r[e]:r.default?r.default[e]:void 0,U5=r=>r,_A=(r,e=U5)=>{let t=N5;r.default&&r.default!==!0&&(r=r.default,t=Object.keys(r));const i={};for(const n of t){const s=e(r[n],n);Ne.und(s)||(i[n]=s)}return i},N5=["config","onProps","onStart","onChange","onPause","onResume","onRest"],G5={config:1,from:1,to:1,ref:1,loop:1,reset:1,pause:1,cancel:1,reverse:1,immediate:1,default:1,delay:1,onProps:1,onStart:1,onChange:1,onPause:1,onResume:1,onRest:1,onResolve:1,items:1,trail:1,sort:1,expires:1,initial:1,enter:1,update:1,leave:1,children:1,onDestroyed:1,keys:1,callId:1,parentId:1};function Q5(r){const e={};let t=0;if(gr(r,(i,n)=>{G5[n]||(e[n]=i,t++)}),t)return e}function y3(r){const e=Q5(r);if(e){const t={to:e};return gr(r,(i,n)=>n in e||(t[n]=i)),t}return{...r}}function dc(r){return r=Xn(r),Ne.arr(r)?r.map(dc):of(r)?Ts.createStringInterpolator({range:[0,1],output:[r,r]})(1):r}function z5(r){for(const e in r)return!0;return!1}function rm(r){return Ne.fun(r)||Ne.arr(r)&&Ne.obj(r[0])}function H5(r,e){r.ref?.delete(r),e?.delete(r)}function V5(r,e){e&&r.ref!==e&&(r.ref?.delete(r),e.add(r),r.ref=e)}var K5={default:{tension:170,friction:26}},om={...K5.default,mass:1,damping:1,easing:p5.linear,clamp:!1},$5=class{constructor(){this.velocity=0,Object.assign(this,om)}};function Y5(r,e,t){t&&(t={...t},Xg(t,e),e={...t,...e}),Xg(r,e),Object.assign(r,e);for(const o in om)r[o]==null&&(r[o]=om[o]);let{frequency:i,damping:n}=r;const{mass:s}=r;return Ne.und(i)||(i<.01&&(i=.01),n<0&&(n=0),r.tension=Math.pow(2*Math.PI/i,2)*s,r.friction=4*Math.PI*n*s/i),r}function Xg(r,e){if(!Ne.und(e.decay))r.duration=void 0;else{const t=!Ne.und(e.tension)||!Ne.und(e.friction);(t||!Ne.und(e.frequency)||!Ne.und(e.damping)||!Ne.und(e.mass))&&(r.duration=void 0,r.decay=void 0),t&&(r.frequency=void 0)}}var Jg=[],W5=class{constructor(){this.changed=!1,this.values=Jg,this.toValues=null,this.fromValues=Jg,this.config=new $5,this.immediate=!1}};function v3(r,{key:e,props:t,defaultProps:i,state:n,actions:s}){return new Promise((o,a)=>{let l,c,u=jl(t.cancel??i?.cancel,e);if(u)d();else{Ne.und(t.pause)||(n.paused=jl(t.pause,e));let m=i?.pause;m!==!0&&(m=n.paused||jl(m,e)),l=ao(t.delay||0,e),m?(n.resumeQueue.add(f),s.pause()):(s.resume(),f())}function h(){n.resumeQueue.add(f),n.timeouts.delete(c),c.cancel(),l=c.time-At.now()}function f(){l>0&&!Ts.skipAnimation?(n.delayed=!0,c=At.setTimeout(d,l),n.pauseQueue.add(h),n.timeouts.add(c)):d()}function d(){n.delayed&&(n.delayed=!1),n.pauseQueue.delete(h),n.timeouts.delete(c),r<=(n.cancelId||0)&&(u=!0);try{s.start({...t,callId:r,cancel:u},o)}catch(m){a(m)}}})}var SA=(r,e)=>e.length==1?e[0]:e.some(t=>t.cancelled)?xa(r.get()):e.every(t=>t.noop)?E3(r.get()):Is(r.get(),e.every(t=>t.finished)),E3=r=>({value:r,noop:!0,finished:!0,cancelled:!1}),Is=(r,e,t=!1)=>({value:r,finished:e,cancelled:t}),xa=r=>({value:r,cancelled:!0,finished:!1});function x3(r,e,t,i){const{callId:n,parentId:s,onRest:o}=e,{asyncTo:a,promise:l}=t;return!s&&r===a&&!e.reset?l:t.promise=(async()=>{t.asyncId=n,t.asyncTo=r;const c=_A(e,(p,y)=>y==="onRest"?void 0:p);let u,h;const f=new Promise((p,y)=>(u=p,h=y)),d=p=>{const y=n<=(t.cancelId||0)&&xa(i)||n!==t.asyncId&&Is(i,!1);if(y)throw p.result=y,h(p),p},m=(p,y)=>{const v=new Zg,E=new e1;return(async()=>{if(Ts.skipAnimation)throw mc(t),E.result=Is(i,!1),h(E),E;d(v);const x=Ne.obj(p)?{...p}:{...y,to:p};x.parentId=n,gr(c,(C,_)=>{Ne.und(x[_])&&(x[_]=C)});const I=await i.start(x);return d(v),t.paused&&await new Promise(C=>{t.resumeQueue.add(C)}),I})()};let A;if(Ts.skipAnimation)return mc(t),Is(i,!1);try{let p;Ne.arr(r)?p=(async y=>{for(const v of y)await m(v)})(r):p=Promise.resolve(r(m,i.stop.bind(i))),await Promise.all([p.then(u),f]),A=Is(i.get(),!0,!1)}catch(p){if(p instanceof Zg)A=p.result;else if(p instanceof e1)A=p.result;else throw p}finally{n==t.asyncId&&(t.asyncId=s,t.asyncTo=s?a:void 0,t.promise=s?l:void 0)}return Ne.fun(o)&&At.batchedUpdates(()=>{o(A,i,i.item)}),A})()}function mc(r,e){Yl(r.timeouts,t=>t.cancel()),r.pauseQueue.clear(),r.resumeQueue.clear(),r.asyncId=r.asyncTo=r.promise=void 0,e&&(r.cancelId=e)}var Zg=class extends Error{constructor(){super("An async animation has been interrupted. You see this error because you forgot to use `await` or `.catch(...)` on its returned promise.")}},e1=class extends Error{constructor(){super("SkipAnimationSignal")}},am=r=>r instanceof TA,j5=1,TA=class extends y5{constructor(){super(...arguments),this.id=j5++,this._priority=0}get priority(){return this._priority}set priority(r){this._priority!=r&&(this._priority=r,this._onPriorityChange(r))}get(){const r=Ns(this);return r&&r.getValue()}to(...r){return Ts.to(this,r)}interpolate(...r){return S5(),Ts.to(this,r)}toJSON(){return this.get()}observerAdded(r){r==1&&this._attach()}observerRemoved(r){r==0&&this._detach()}_attach(){}_detach(){}_onChange(r,e=!1){bh(this,{type:"change",parent:this,value:r,idle:e})}_onPriorityChange(r){this.idle||nf.sort(this),bh(this,{type:"priority",parent:this,priority:r})}},go=Symbol.for("SpringPhase"),I3=1,lm=2,cm=4,Wf=r=>(r[go]&I3)>0,Cr=r=>(r[go]&lm)>0,sl=r=>(r[go]&cm)>0,t1=(r,e)=>e?r[go]|=lm|I3:r[go]&=~lm,i1=(r,e)=>e?r[go]|=cm:r[go]&=~cm,q5=class extends TA{constructor(r,e){if(super(),this.animation=new W5,this.defaultProps={},this._state={paused:!1,delayed:!1,pauseQueue:new Set,resumeQueue:new Set,timeouts:new Set},this._pendingCalls=new Set,this._lastCallId=0,this._lastToId=0,this._memoizedDuration=0,!Ne.und(r)||!Ne.und(e)){const t=Ne.obj(r)?{...r}:{...e,from:r};Ne.und(t.default)&&(t.default=!0),this.start(t)}}get idle(){return!(Cr(this)||this._state.asyncTo)||sl(this)}get goal(){return Xn(this.animation.to)}get velocity(){const r=Ns(this);return r instanceof Rc?r.lastVelocity||0:r.getPayload().map(e=>e.lastVelocity||0)}get hasAnimated(){return Wf(this)}get isAnimating(){return Cr(this)}get isPaused(){return sl(this)}get isDelayed(){return this._state.delayed}advance(r){let e=!0,t=!1;const i=this.animation;let{toValues:n}=i;const{config:s}=i,o=af(i.to);!o&&Gs(i.to)&&(n=is(Xn(i.to))),i.values.forEach((c,u)=>{if(c.done)return;const h=c.constructor==fc?1:o?o[u].lastPosition:n[u];let f=i.immediate,d=h;if(!f){if(d=c.lastPosition,s.tension<=0){c.done=!0;return}let m=c.elapsedTime+=r;const A=i.fromValues[u],p=c.v0!=null?c.v0:c.v0=Ne.arr(s.velocity)?s.velocity[u]:s.velocity;let y;const v=s.precision||(A==h?.005:Math.min(1,Math.abs(h-A)*.001));if(Ne.und(s.duration))if(s.decay){const E=s.decay===!0?.998:s.decay,x=Math.exp(-(1-E)*m);d=A+p/(1-E)*(1-x),f=Math.abs(c.lastPosition-d)<=v,y=p*x}else{y=c.lastVelocity==null?p:c.lastVelocity;const E=s.restVelocity||v/10,x=s.clamp?0:s.bounce,I=!Ne.und(x),C=A==h?c.v0>0:A<h;let _,S=!1;const b=1,T=Math.ceil(r/b);for(let R=0;R<T&&(_=Math.abs(y)>E,!(!_&&(f=Math.abs(h-d)<=v,f)));++R){I&&(S=d==h||d>h==C,S&&(y=-y*x,d=h));const w=-s.tension*1e-6*(d-h),B=-s.friction*.001*y,M=(w+B)/s.mass;y=y+M*b,d=d+y*b}}else{let E=1;s.duration>0&&(this._memoizedDuration!==s.duration&&(this._memoizedDuration=s.duration,c.durationProgress>0&&(c.elapsedTime=s.duration*c.durationProgress,m=c.elapsedTime+=r)),E=(s.progress||0)+m/this._memoizedDuration,E=E>1?1:E<0?0:E,c.durationProgress=E),d=A+s.easing(E)*(h-A),y=(d-c.lastPosition)/r,f=E==1}c.lastVelocity=y,Number.isNaN(d)&&(console.warn("Got NaN while animating:",this),f=!0)}o&&!o[u].done&&(f=!1),f?c.done=!0:e=!1,c.setValue(d,s.round)&&(t=!0)});const a=Ns(this),l=a.getValue();if(e){const c=Xn(i.to);(l!==c||t)&&!s.decay?(a.setValue(c),this._onChange(c)):t&&s.decay&&this._onChange(l),this._stop()}else t&&this._onChange(l)}set(r){return At.batchedUpdates(()=>{this._stop(),this._focus(r),this._set(r)}),this}pause(){this._update({pause:!0})}resume(){this._update({pause:!1})}finish(){if(Cr(this)){const{to:r,config:e}=this.animation;At.batchedUpdates(()=>{this._onStart(),e.decay||this._set(r,!1),this._stop()})}return this}update(r){return(this.queue||(this.queue=[])).push(r),this}start(r,e){let t;return Ne.und(r)?(t=this.queue||[],this.queue=[]):t=[Ne.obj(r)?r:{...e,to:r}],Promise.all(t.map(i=>this._update(i))).then(i=>SA(this,i))}stop(r){const{to:e}=this.animation;return this._focus(this.get()),mc(this._state,r&&this._lastCallId),At.batchedUpdates(()=>this._stop(e,r)),this}reset(){this._update({reset:!0})}eventObserved(r){r.type=="change"?this._start():r.type=="priority"&&(this.priority=r.priority+1)}_prepareNode(r){const e=this.key||"";let{to:t,from:i}=r;t=Ne.obj(t)?t[e]:t,(t==null||rm(t))&&(t=void 0),i=Ne.obj(i)?i[e]:i,i==null&&(i=void 0);const n={to:t,from:i};return Wf(this)||(r.reverse&&([t,i]=[i,t]),i=Xn(i),Ne.und(i)?Ns(this)||this._set(t):this._set(i)),n}_update({...r},e){const{key:t,defaultProps:i}=this;r.default&&Object.assign(i,_A(r,(o,a)=>/^on/.test(a)?p3(o,t):o)),s1(this,r,"onProps"),ol(this,"onProps",r,this);const n=this._prepareNode(r);if(Object.isFrozen(this))throw Error("Cannot animate a `SpringValue` object that is frozen. Did you forget to pass your component to `animated(...)` before animating its props?");const s=this._state;return v3(++this._lastCallId,{key:t,props:r,defaultProps:i,state:s,actions:{pause:()=>{sl(this)||(i1(this,!0),Nl(s.pauseQueue),ol(this,"onPause",Is(this,rl(this,this.animation.to)),this))},resume:()=>{sl(this)&&(i1(this,!1),Cr(this)&&this._resume(),Nl(s.resumeQueue),ol(this,"onResume",Is(this,rl(this,this.animation.to)),this))},start:this._merge.bind(this,n)}}).then(o=>{if(r.loop&&o.finished&&!(e&&o.noop)){const a=C3(r);if(a)return this._update(a,!0)}return o})}_merge(r,e,t){if(e.cancel)return this.stop(!0),t(xa(this));const i=!Ne.und(r.to),n=!Ne.und(r.from);if(i||n)if(e.callId>this._lastToId)this._lastToId=e.callId;else return t(xa(this));const{key:s,defaultProps:o,animation:a}=this,{to:l,from:c}=a;let{to:u=l,from:h=c}=r;n&&!i&&(!e.default||Ne.und(u))&&(u=h),e.reverse&&([u,h]=[h,u]);const f=!lr(h,c);f&&(a.from=h),h=Xn(h);const d=!lr(u,l);d&&this._focus(u);const m=rm(e.to),{config:A}=a,{decay:p,velocity:y}=A;(i||n)&&(A.velocity=0),e.config&&!m&&Y5(A,ao(e.config,s),e.config!==o.config?ao(o.config,s):void 0);let v=Ns(this);if(!v||Ne.und(u))return t(Is(this,!0));const E=Ne.und(e.reset)?n&&!e.default:!Ne.und(h)&&jl(e.reset,s),x=E?h:this.get(),I=dc(u),C=Ne.num(I)||Ne.arr(I)||of(I),_=!m&&(!C||jl(o.immediate||e.immediate,s));if(d){const R=sm(u);if(R!==v.constructor)if(_)v=this._set(I);else throw Error(`Cannot animate between ${v.constructor.name} and ${R.name}, as the "to" prop suggests`)}const S=v.constructor;let b=Gs(u),T=!1;if(!b){const R=E||!Wf(this)&&f;(d||R)&&(T=lr(dc(x),I),b=!T),(!lr(a.immediate,_)&&!_||!lr(A.decay,p)||!lr(A.velocity,y))&&(b=!0)}if(T&&Cr(this)&&(a.changed&&!E?b=!0:b||this._stop(l)),!m&&((b||Gs(l))&&(a.values=v.getPayload(),a.toValues=Gs(u)?null:S==fc?[1]:is(I)),a.immediate!=_&&(a.immediate=_,!_&&!E&&this._set(l)),b)){const{onRest:R}=a;Ut(J5,B=>s1(this,e,B));const w=Is(this,rl(this,l));Nl(this._pendingCalls,w),this._pendingCalls.add(t),a.changed&&At.batchedUpdates(()=>{a.changed=!E,R?.(w,this),E?ao(o.onRest,w):a.onStart?.(w,this)})}E&&this._set(x),m?t(x3(e.to,e,this._state,this)):b?this._start():Cr(this)&&!d?this._pendingCalls.add(t):t(E3(x))}_focus(r){const e=this.animation;r!==e.to&&(Kg(this)&&this._detach(),e.to=r,Kg(this)&&this._attach())}_attach(){let r=0;const{to:e}=this.animation;Gs(e)&&(Bc(e,this),am(e)&&(r=e.priority+1)),this.priority=r}_detach(){const{to:r}=this.animation;Gs(r)&&wh(r,this)}_set(r,e=!0){const t=Xn(r);if(!Ne.und(t)){const i=Ns(this);if(!i||!lr(t,i.getValue())){const n=sm(t);!i||i.constructor!=n?IA(this,n.create(t)):i.setValue(t),i&&At.batchedUpdates(()=>{this._onChange(t,e)})}}return Ns(this)}_onStart(){const r=this.animation;r.changed||(r.changed=!0,ol(this,"onStart",Is(this,rl(this,r.to)),this))}_onChange(r,e){e||(this._onStart(),ao(this.animation.onChange,r,this)),ao(this.defaultProps.onChange,r,this),super._onChange(r,e)}_start(){const r=this.animation;Ns(this).reset(Xn(r.to)),r.immediate||(r.fromValues=r.values.map(e=>e.lastPosition)),Cr(this)||(t1(this,!0),sl(this)||this._resume())}_resume(){Ts.skipAnimation?this.finish():nf.start(this)}_stop(r,e){if(Cr(this)){t1(this,!1);const t=this.animation;Ut(t.values,n=>{n.done=!0}),t.toValues&&(t.onChange=t.onPause=t.onResume=void 0),bh(this,{type:"idle",parent:this});const i=e?xa(this.get()):Is(this.get(),rl(this,r??t.to));Nl(this._pendingCalls,i),t.changed&&(t.changed=!1,ol(this,"onRest",i,this))}}};function rl(r,e){const t=dc(e),i=dc(r.get());return lr(i,t)}function C3(r,e=r.loop,t=r.to){const i=ao(e);if(i){const n=i!==!0&&y3(i),s=(n||r).reverse,o=!n||n.reset;return Ac({...r,loop:e,default:!1,pause:void 0,to:!s||rm(t)?t:void 0,from:o?r.from:void 0,reset:o,...n})}}function Ac(r){const{to:e,from:t}=r=y3(r),i=new Set;return Ne.obj(e)&&n1(e,i),Ne.obj(t)&&n1(t,i),r.keys=i.size?Array.from(i):null,r}function X5(r){const e=Ac(r);return Ne.und(e.default)&&(e.default=_A(e)),e}function n1(r,e){gr(r,(t,i)=>t!=null&&e.add(i))}var J5=["onStart","onRest","onChange","onPause","onResume"];function s1(r,e,t){r.animation[t]=e[t]!==g3(e,t)?p3(e[t],r.key):void 0}function ol(r,e,...t){r.animation[e]?.(...t),r.defaultProps[e]?.(...t)}var Z5=["onStart","onChange","onRest"],eb=1,tb=class{constructor(r,e){this.id=eb++,this.springs={},this.queue=[],this._lastAsyncId=0,this._active=new Set,this._changed=new Set,this._started=!1,this._state={paused:!1,pauseQueue:new Set,resumeQueue:new Set,timeouts:new Set},this._events={onStart:new Map,onChange:new Map,onRest:new Map},this._onFrame=this._onFrame.bind(this),e&&(this._flush=e),r&&this.start({default:!0,...r})}get idle(){return!this._state.asyncTo&&Object.values(this.springs).every(r=>r.idle&&!r.isDelayed&&!r.isPaused)}get item(){return this._item}set item(r){this._item=r}get(){const r={};return this.each((e,t)=>r[t]=e.get()),r}set(r){for(const e in r){const t=r[e];Ne.und(t)||this.springs[e].set(t)}}update(r){return r&&this.queue.push(Ac(r)),this}start(r){let{queue:e}=this;return r?e=is(r).map(Ac):this.queue=[],this._flush?this._flush(this,e):(w3(this,e),um(this,e))}stop(r,e){if(r!==!!r&&(e=r),e){const t=this.springs;Ut(is(e),i=>t[i].stop(!!r))}else mc(this._state,this._lastAsyncId),this.each(t=>t.stop(!!r));return this}pause(r){if(Ne.und(r))this.start({pause:!0});else{const e=this.springs;Ut(is(r),t=>e[t].pause())}return this}resume(r){if(Ne.und(r))this.start({pause:!1});else{const e=this.springs;Ut(is(r),t=>e[t].resume())}return this}each(r){gr(this.springs,r)}_onFrame(){const{onStart:r,onChange:e,onRest:t}=this._events,i=this._active.size>0,n=this._changed.size>0;(i&&!this._started||n&&!this._started)&&(this._started=!0,Yl(r,([a,l])=>{l.value=this.get(),a(l,this,this._item)}));const s=!i&&this._started,o=n||s&&t.size?this.get():null;n&&e.size&&Yl(e,([a,l])=>{l.value=o,a(l,this,this._item)}),s&&(this._started=!1,Yl(t,([a,l])=>{l.value=o,a(l,this,this._item)}))}eventObserved(r){if(r.type=="change")this._changed.add(r.parent),r.idle||this._active.add(r.parent);else if(r.type=="idle")this._active.delete(r.parent);else return;At.onFrame(this._onFrame)}};function um(r,e){return Promise.all(e.map(t=>_3(r,t))).then(t=>SA(r,t))}async function _3(r,e,t){const{keys:i,to:n,from:s,loop:o,onRest:a,onResolve:l}=e,c=Ne.obj(e.default)&&e.default;o&&(e.loop=!1),n===!1&&(e.to=null),s===!1&&(e.from=null);const u=Ne.arr(n)||Ne.fun(n)?n:void 0;u?(e.to=void 0,e.onRest=void 0,c&&(c.onRest=void 0)):Ut(Z5,A=>{const p=e[A];if(Ne.fun(p)){const y=r._events[A];e[A]=({finished:v,cancelled:E})=>{const x=y.get(p);x?(v||(x.finished=!1),E&&(x.cancelled=!0)):y.set(p,{value:null,finished:v||!1,cancelled:E||!1})},c&&(c[A]=e[A])}});const h=r._state;e.pause===!h.paused?(h.paused=e.pause,Nl(e.pause?h.pauseQueue:h.resumeQueue)):h.paused&&(e.pause=!0);const f=(i||Object.keys(r.springs)).map(A=>r.springs[A].start(e)),d=e.cancel===!0||g3(e,"cancel")===!0;(u||d&&h.asyncId)&&f.push(v3(++r._lastAsyncId,{props:e,state:h,actions:{pause:im,resume:im,start(A,p){d?(mc(h,r._lastAsyncId),p(xa(r))):(A.onRest=a,p(x3(u,A,h,r)))}}})),h.paused&&await new Promise(A=>{h.resumeQueue.add(A)});const m=SA(r,await Promise.all(f));if(o&&m.finished&&!(t&&m.noop)){const A=C3(e,o,n);if(A)return w3(r,[A]),_3(r,A,!0)}return l&&At.batchedUpdates(()=>l(m,r,r.item)),m}function r1(r,e){const t={...r.springs};return e&&Ut(is(e),i=>{Ne.und(i.keys)&&(i=Ac(i)),Ne.obj(i.to)||(i={...i,to:void 0}),b3(t,i,n=>T3(n))}),S3(r,t),t}function S3(r,e){gr(e,(t,i)=>{r.springs[i]||(r.springs[i]=t,Bc(t,r))})}function T3(r,e){const t=new q5;return t.key=r,e&&Bc(t,e),t}function b3(r,e,t){e.keys&&Ut(e.keys,i=>{(r[i]||(r[i]=t(i)))._prepareNode(e)})}function w3(r,e){Ut(e,t=>{b3(r.springs,t,i=>T3(i,r))})}var lf=({children:r,...e})=>{const t=g.useContext(Rh),i=e.pause||!!t.pause,n=e.immediate||!!t.immediate;e=B5(()=>({pause:i,immediate:n}),[i,n]);const{Provider:s}=Rh;return g.createElement(s,{value:e},r)},Rh=ib(lf,{});lf.Provider=Rh.Provider;lf.Consumer=Rh.Consumer;function ib(r,e){return Object.assign(r,g.createContext(e)),r.Provider._context=r,r.Consumer._context=r,r}var nb=()=>{const r=[],e=function(i){b5();const n=[];return Ut(r,(s,o)=>{if(Ne.und(i))n.push(s.start());else{const a=t(i,s,o);a&&n.push(s.start(a))}}),n};e.current=r,e.add=function(i){r.includes(i)||r.push(i)},e.delete=function(i){const n=r.indexOf(i);~n&&r.splice(n,1)},e.pause=function(){return Ut(r,i=>i.pause(...arguments)),this},e.resume=function(){return Ut(r,i=>i.resume(...arguments)),this},e.set=function(i){Ut(r,(n,s)=>{const o=Ne.fun(i)?i(s,n):i;o&&n.set(o)})},e.start=function(i){const n=[];return Ut(r,(s,o)=>{if(Ne.und(i))n.push(s.start());else{const a=this._getProps(i,s,o);a&&n.push(s.start(a))}}),n},e.stop=function(){return Ut(r,i=>i.stop(...arguments)),this},e.update=function(i){return Ut(r,(n,s)=>n.update(this._getProps(i,n,s))),this};const t=function(i,n,s){return Ne.fun(i)?i(s,n):i};return e._getProps=t,e};function sb(r,e,t){const i=Ne.fun(e)&&e;i&&!t&&(t=[]);const n=g.useMemo(()=>i||arguments.length==3?nb():void 0,[]),s=g.useRef(0),o=f3(),a=g.useMemo(()=>({ctrls:[],queue:[],flush(y,v){const E=r1(y,v);return s.current>0&&!a.queue.length&&!Object.keys(E).some(I=>!y.springs[I])?um(y,v):new Promise(I=>{S3(y,E),a.queue.push(()=>{I(um(y,v))}),o()})}}),[]),l=g.useRef([...a.ctrls]),c=[],u=Yg(r)||0;g.useMemo(()=>{Ut(l.current.slice(r,u),y=>{H5(y,n),y.stop(!0)}),l.current.length=r,h(u,r)},[r]),g.useMemo(()=>{h(0,Math.min(u,r))},t);function h(y,v){for(let E=y;E<v;E++){const x=l.current[E]||(l.current[E]=new tb(null,a.flush)),I=i?i(E,x):e[E];I&&(c[E]=X5(I))}}const f=l.current.map((y,v)=>r1(y,c[v])),d=g.useContext(lf),m=Yg(d),A=d!==m&&z5(d);xA(()=>{s.current++,a.ctrls=l.current;const{queue:y}=a;y.length&&(a.queue=[],Ut(y,v=>v())),Ut(l.current,(v,E)=>{n?.add(v),A&&v.start({default:d});const x=c[E];x&&(V5(v,x.ref),v.ref?v.queue.push(x):v.start(x))})}),d3(()=>()=>{Ut(a.ctrls,y=>y.stop(!0))});const p=f.map(y=>({...y}));return n?[p,n]:p}function rb(r,e){const t=Ne.fun(r),[[i],n]=sb(1,t?r:[r],t?[]:e);return t||arguments.length==2?[i,n]:i}var ob=class extends TA{constructor(r,e){super(),this.source=r,this.idle=!0,this._active=new Set,this.calc=cc(...e);const t=this._get(),i=sm(t);IA(this,i.create(t))}advance(r){const e=this._get(),t=this.get();lr(e,t)||(Ns(this).setValue(e),this._onChange(e,this.idle)),!this.idle&&o1(this._active)&&jf(this)}_get(){const r=Ne.arr(this.source)?this.source.map(Xn):is(Xn(this.source));return this.calc(...r)}_start(){this.idle&&!o1(this._active)&&(this.idle=!1,Ut(af(this),r=>{r.done=!1}),Ts.skipAnimation?(At.batchedUpdates(()=>this.advance()),jf(this)):nf.start(this))}_attach(){let r=1;Ut(is(this.source),e=>{Gs(e)&&Bc(e,this),am(e)&&(e.idle||this._active.add(e),r=Math.max(r,e.priority+1))}),this.priority=r,this._start()}_detach(){Ut(is(this.source),r=>{Gs(r)&&wh(r,this)}),this._active.clear(),jf(this)}eventObserved(r){r.type=="change"?r.idle?this.advance():(this._active.add(r.parent),this._start()):r.type=="idle"?this._active.delete(r.parent):r.type=="priority"&&(this.priority=is(this.source).reduce((e,t)=>Math.max(e,(am(t)?t.priority:0)+1),0))}};function ab(r){return r.idle!==!1}function o1(r){return!r.size||Array.from(r).every(ab)}function jf(r){r.idle||(r.idle=!0,Ut(af(r),e=>{e.done=!0}),bh(r,{type:"idle",parent:r}))}Ts.assign({createStringInterpolator:u3,to:(r,e)=>new ob(r,e)});var lb=["primitive"].concat(Object.keys(S4).filter(r=>/^[A-Z]/.test(r)).map(r=>r[0].toLowerCase()+r.slice(1)));Ts.assign({createStringInterpolator:u3,colors:s5,frameLoop:"demand"});aA(()=>{At.advance()});var cb=O5(lb,{applyAnimatedValues:Un}),ub=cb.animated;function RO({enabled:r=!0,snap:e,global:t,domElement:i,cursor:n=!0,children:s,speed:o=1,rotation:a=[0,0,0],zoom:l=1,polar:c=[0,Math.PI/2],azimuth:u=[-1/0,1/0],config:h={mass:1,tension:170,friction:26}}){const f=ae(C=>C.events),d=ae(C=>C.gl),m=i||f.connected||d.domElement,{size:A}=ae(),p=g.useMemo(()=>[a[0]+c[0],a[0]+c[1]],[a[0],c[0],c[1]]),y=g.useMemo(()=>[a[1]+u[0],a[1]+u[1]],[a[1],u[0],u[1]]),v=g.useMemo(()=>[tt.clamp(a[0],...p),tt.clamp(a[1],...y),a[2]],[a[0],a[1],a[2],p,y]),[E,x]=rb(()=>({scale:1,rotation:v,config:h}));g.useEffect(()=>void x.start({scale:1,rotation:v,config:h}),[v]),g.useEffect(()=>{if(t&&n&&r)return m.style.cursor="grab",d.domElement.style.cursor="",()=>{m.style.cursor="default",d.domElement.style.cursor="default"}},[t,n,m,r]);const I=zE({onHover:({last:C})=>{n&&!t&&r&&(m.style.cursor=C?"auto":"grab")},onDrag:({down:C,delta:[_,S],memo:[b,T]=E.rotation.animation.to||v})=>{if(!r)return[S,_];n&&(m.style.cursor=C?"grabbing":"grab"),_=tt.clamp(T+_/A.width*Math.PI*o,...y),S=tt.clamp(b+S/A.height*Math.PI*o,...p);const R=e&&!C&&typeof e!="boolean"?e:h;return x.start({scale:C&&S>p[1]/2?l:1,rotation:e&&!C?v:[S,_,0],config:w=>w==="scale"?{...R,friction:R.friction*3}:R}),[S,_]}},{target:t?m:void 0});return g.createElement(ub.group,Ae({},I?.(),E),s)}const hb=r=>(e,t,i)=>{const n=i.subscribe;return i.subscribe=((o,a,l)=>{let c=o;if(a){const u=l?.equalityFn||Object.is;let h=o(i.getState());c=f=>{const d=o(f);if(!u(h,d)){const m=h;a(h=d,m)}},l?.fireImmediately&&a(h,h)}return n(c)}),r(e,t,i)},fb=hb,B3=g.createContext(null);function DO({map:r,children:e,onChange:t,domElement:i}){const n=r.map(l=>l.name+l.keys).join("-"),s=g.useMemo(()=>DE(fb(()=>r.reduce((l,c)=>({...l,[c.name]:!1}),{}))),[n]),o=g.useMemo(()=>[s.subscribe,s.getState,s],[n]),a=s.setState;return g.useEffect(()=>{const c=r.map(({name:d,keys:m,up:A})=>({keys:m,up:A,fn:p=>{a({[d]:p}),t&&t(d,p,o[1]())}})).reduce((d,{keys:m,fn:A,up:p=!0})=>(m.forEach(y=>d[y]={fn:A,pressed:!1,up:p}),d),{}),u=({key:d,code:m})=>{const A=c[d]||c[m];if(!A)return;const{fn:p,pressed:y,up:v}=A;A.pressed=!0,(v||!y)&&p(!0)},h=({key:d,code:m})=>{const A=c[d]||c[m];if(!A)return;const{fn:p,up:y}=A;A.pressed=!1,y&&p(!1)},f=i||window;return f.addEventListener("keydown",u,{passive:!0}),f.addEventListener("keyup",h,{passive:!0}),()=>{f.removeEventListener("keydown",u),f.removeEventListener("keyup",h)}},[i,n]),g.createElement(B3.Provider,{value:o,children:e})}function MO(r){const[e,t,i]=g.useContext(B3);return r?i(r):[e,t]}const Na=parseInt(Kh.replace(/\D+/g,"")),bA=Na>=125?"uv1":"uv2";var db=Object.defineProperty,mb=(r,e,t)=>e in r?db(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,al=(r,e,t)=>(mb(r,typeof e!="symbol"?e+"":e,t),t);const la=4,Ia=1024,zs=4,Ab=(r=1)=>{const e=new Float32Array(Ia*zs*r*la),t=new Vr(e,Ia,zs*r,Di,ri);return t.wrapS=zn,t.wrapT=zn,t.magFilter=ei,t.needsUpdate=!0,t},pb=(r,e,t=0)=>{const i=Math.floor(Ia*(zs/4));e.arcLengthDivisions=i/2,e.updateArcLengths();const n=e.getSpacedPoints(i),s=e.computeFrenetFrames(i,!0);for(let o=0;o<i;o++){const a=Math.floor(o/Ia),l=o%Ia;let c=n[o];$c(r,l,c.x,c.y,c.z,0+a+zs*t),c=s.tangents[o],$c(r,l,c.x,c.y,c.z,1+a+zs*t),c=s.normals[o],$c(r,l,c.x,c.y,c.z,2+a+zs*t),c=s.binormals[o],$c(r,l,c.x,c.y,c.z,3+a+zs*t)}r.needsUpdate=!0},$c=(r,e,t,i,n,s)=>{const o=r.image,{data:a}=o,l=la*Ia*s;a[e*la+l+0]=t,a[e*la+l+1]=i,a[e*la+l+2]=n,a[e*la+l+3]=1},gb=r=>({spineTexture:{value:r},pathOffset:{type:"f",value:0},pathSegment:{type:"f",value:1},spineOffset:{type:"f",value:161},spineLength:{type:"f",value:400},flow:{type:"i",value:1}});function yb(r,e,t=1){r.__ok||(r.__ok=!0,r.onBeforeCompile=i=>{if(i.__modified)return;i.__modified=!0,Object.assign(i.uniforms,e);const n=`
		uniform sampler2D spineTexture;
		uniform float pathOffset;
		uniform float pathSegment;
		uniform float spineOffset;
		uniform float spineLength;
		uniform int flow;

		float textureLayers = ${zs*t}.;
		float textureStacks = ${zs/4}.;

		${i.vertexShader}
		`.replace("#include <beginnormal_vertex>","").replace("#include <defaultnormal_vertex>","").replace("#include <begin_vertex>","").replace(/void\s*main\s*\(\)\s*\{/,`
        void main() {
        #include <beginnormal_vertex>

        vec4 worldPos = modelMatrix * vec4(position, 1.);

        bool bend = flow > 0;
        float xWeight = bend ? 0. : 1.;

        #ifdef USE_INSTANCING
        float pathOffsetFromInstanceMatrix = instanceMatrix[3][2];
        float spineLengthFromInstanceMatrix = instanceMatrix[3][0];
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLengthFromInstanceMatrix : 0.;
        float mt = (spinePortion * pathSegment + pathOffset + pathOffsetFromInstanceMatrix)*textureStacks;
        #else
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLength : 0.;
        float mt = (spinePortion * pathSegment + pathOffset)*textureStacks;
        #endif

        mt = mod(mt, textureStacks);
        float rowOffset = floor(mt);

        #ifdef USE_INSTANCING
        rowOffset += instanceMatrix[3][1] * ${zs}.;
        #endif

        vec3 spinePos = texture2D(spineTexture, vec2(mt, (0. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 a =        texture2D(spineTexture, vec2(mt, (1. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 b =        texture2D(spineTexture, vec2(mt, (2. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 c =        texture2D(spineTexture, vec2(mt, (3. + rowOffset + 0.5) / textureLayers)).xyz;
        mat3 basis = mat3(a, b, c);

        vec3 transformed = basis
          * vec3(worldPos.x * xWeight, worldPos.y * 1., worldPos.z * 1.)
          + spinePos;

        vec3 transformedNormal = normalMatrix * (basis * objectNormal);
			`).replace("#include <project_vertex>",`vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );
				gl_Position = projectionMatrix * mvPosition;`);i.vertexShader=n})}class vb{constructor(e,t=1){al(this,"curveArray"),al(this,"curveLengthArray"),al(this,"object3D"),al(this,"splineTexure"),al(this,"uniforms");const i=e.clone(),n=Ab(t),s=gb(n);i.traverse(o=>{(o instanceof ze||o instanceof Zm)&&(o.material=o.material.clone(),yb(o.material,s,t))}),this.curveArray=new Array(t),this.curveLengthArray=new Array(t),this.object3D=i,this.splineTexure=n,this.uniforms=s}updateCurve(e,t){if(e>=this.curveArray.length)throw Error("Index out of range for Flow");const i=t.getLength();this.uniforms.spineLength.value=i,this.curveLengthArray[e]=i,this.curveArray[e]=t,pb(this.splineTexure,t,e)}moveAlongCurve(e){this.uniforms.pathOffset.value+=e}}function Eb(r,e=1e-4){e=Math.max(e,Number.EPSILON);const t={},i=r.getIndex(),n=r.getAttribute("position"),s=i?i.count:n.count;let o=0;const a=Object.keys(r.attributes),l={},c={},u=[],h=["getX","getY","getZ","getW"];for(let A=0,p=a.length;A<p;A++){const y=a[A];l[y]=[];const v=r.morphAttributes[y];v&&(c[y]=new Array(v.length).fill(0).map(()=>[]))}const f=Math.log10(1/e),d=Math.pow(10,f);for(let A=0;A<s;A++){const p=i?i.getX(A):A;let y="";for(let v=0,E=a.length;v<E;v++){const x=a[v],I=r.getAttribute(x),C=I.itemSize;for(let _=0;_<C;_++)y+=`${~~(I[h[_]](p)*d)},`}if(y in t)u.push(t[y]);else{for(let v=0,E=a.length;v<E;v++){const x=a[v],I=r.getAttribute(x),C=r.morphAttributes[x],_=I.itemSize,S=l[x],b=c[x];for(let T=0;T<_;T++){const R=h[T];if(S.push(I[R](p)),C)for(let w=0,B=C.length;w<B;w++)b[w].push(C[w][R](p))}}t[y]=o,u.push(o),o++}}const m=r.clone();for(let A=0,p=a.length;A<p;A++){const y=a[A],v=r.getAttribute(y),E=new v.array.constructor(l[y]),x=new Vt(E,v.itemSize,v.normalized);if(m.setAttribute(y,x),y in c)for(let I=0;I<c[y].length;I++){const C=r.morphAttributes[y][I],_=new C.array.constructor(c[y][I]),S=new Vt(_,C.itemSize,C.normalized);m.morphAttributes[y][I]=S}}return m.setIndex(u),m}function a1(r,e){if(e===T4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),r;if(e===G0||e===oE){let t=r.getIndex();if(t===null){const o=[],a=r.getAttribute("position");if(a!==void 0){for(let l=0;l<a.count;l++)o.push(l);r.setIndex(o),t=r.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),r}const i=t.count-2,n=[];if(t)if(e===G0)for(let o=1;o<=i;o++)n.push(t.getX(0)),n.push(t.getX(o)),n.push(t.getX(o+1));else for(let o=0;o<i;o++)o%2===0?(n.push(t.getX(o)),n.push(t.getX(o+1)),n.push(t.getX(o+2))):(n.push(t.getX(o+2)),n.push(t.getX(o+1)),n.push(t.getX(o)));n.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=r.clone();return s.setIndex(n),s.clearGroups(),s}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),r}function R3(r,e=Math.PI/3){const t=Math.cos(e),i=(1+1e-10)*100,n=[new Q,new Q,new Q],s=new Q,o=new Q,a=new Q,l=new Q;function c(A){const p=~~(A.x*i),y=~~(A.y*i),v=~~(A.z*i);return`${p},${y},${v}`}const u=r.index?r.toNonIndexed():r,h=u.attributes.position,f={};for(let A=0,p=h.count/3;A<p;A++){const y=3*A,v=n[0].fromBufferAttribute(h,y+0),E=n[1].fromBufferAttribute(h,y+1),x=n[2].fromBufferAttribute(h,y+2);s.subVectors(x,E),o.subVectors(v,E);const I=new Q().crossVectors(s,o).normalize();for(let C=0;C<3;C++){const _=n[C],S=c(_);S in f||(f[S]=[]),f[S].push(I)}}const d=new Float32Array(h.count*3),m=new Vt(d,3,!1);for(let A=0,p=h.count/3;A<p;A++){const y=3*A,v=n[0].fromBufferAttribute(h,y+0),E=n[1].fromBufferAttribute(h,y+1),x=n[2].fromBufferAttribute(h,y+2);s.subVectors(x,E),o.subVectors(v,E),a.crossVectors(s,o).normalize();for(let I=0;I<3;I++){const C=n[I],_=c(C),S=f[_];l.set(0,0,0);for(let b=0,T=S.length;b<T;b++){const R=S[b];a.dot(R)>t&&l.add(R)}l.normalize(),m.setXYZ(y+I,l.x,l.y,l.z)}}return u.setAttribute("normal",m),u}var es=Uint8Array,Ur=Uint16Array,hm=Uint32Array,D3=new es([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),M3=new es([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),xb=new es([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),L3=function(r,e){for(var t=new Ur(31),i=0;i<31;++i)t[i]=e+=1<<r[i-1];for(var n=new hm(t[30]),i=1;i<30;++i)for(var s=t[i];s<t[i+1];++s)n[s]=s-t[i]<<5|i;return[t,n]},P3=L3(D3,2),F3=P3[0],Ib=P3[1];F3[28]=258,Ib[258]=28;var Cb=L3(M3,0),_b=Cb[0],fm=new Ur(32768);for(var ni=0;ni<32768;++ni){var _r=(ni&43690)>>>1|(ni&21845)<<1;_r=(_r&52428)>>>2|(_r&13107)<<2,_r=(_r&61680)>>>4|(_r&3855)<<4,fm[ni]=((_r&65280)>>>8|(_r&255)<<8)>>>1}var ql=(function(r,e,t){for(var i=r.length,n=0,s=new Ur(e);n<i;++n)++s[r[n]-1];var o=new Ur(e);for(n=0;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;if(t){a=new Ur(1<<e);var l=15-e;for(n=0;n<i;++n)if(r[n])for(var c=n<<4|r[n],u=e-r[n],h=o[r[n]-1]++<<u,f=h|(1<<u)-1;h<=f;++h)a[fm[h]>>>l]=c}else for(a=new Ur(i),n=0;n<i;++n)r[n]&&(a[n]=fm[o[r[n]-1]++]>>>15-r[n]);return a}),Dc=new es(288);for(var ni=0;ni<144;++ni)Dc[ni]=8;for(var ni=144;ni<256;++ni)Dc[ni]=9;for(var ni=256;ni<280;++ni)Dc[ni]=7;for(var ni=280;ni<288;++ni)Dc[ni]=8;var k3=new es(32);for(var ni=0;ni<32;++ni)k3[ni]=5;var Sb=ql(Dc,9,1),Tb=ql(k3,5,1),qf=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},ds=function(r,e,t){var i=e/8|0;return(r[i]|r[i+1]<<8)>>(e&7)&t},Xf=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},bb=function(r){return(r/8|0)+(r&7&&1)},wb=function(r,e,t){(t==null||t>r.length)&&(t=r.length);var i=new(r instanceof Ur?Ur:r instanceof hm?hm:es)(t-e);return i.set(r.subarray(e,t)),i},Bb=function(r,e,t){var i=r.length;if(!i||t&&!t.l&&i<5)return e||new es(0);var n=!e||t,s=!t||t.i;t||(t={}),e||(e=new es(i*3));var o=function(G){var F=e.length;if(G>F){var k=new es(Math.max(F*2,G));k.set(e),e=k}},a=t.f||0,l=t.p||0,c=t.b||0,u=t.l,h=t.d,f=t.m,d=t.n,m=i*8;do{if(!u){t.f=a=ds(r,l,1);var A=ds(r,l+1,3);if(l+=3,A)if(A==1)u=Sb,h=Tb,f=9,d=5;else if(A==2){var E=ds(r,l,31)+257,x=ds(r,l+10,15)+4,I=E+ds(r,l+5,31)+1;l+=14;for(var C=new es(I),_=new es(19),S=0;S<x;++S)_[xb[S]]=ds(r,l+S*3,7);l+=x*3;for(var b=qf(_),T=(1<<b)-1,R=ql(_,b,1),S=0;S<I;){var w=R[ds(r,l,T)];l+=w&15;var p=w>>>4;if(p<16)C[S++]=p;else{var B=0,M=0;for(p==16?(M=3+ds(r,l,3),l+=2,B=C[S-1]):p==17?(M=3+ds(r,l,7),l+=3):p==18&&(M=11+ds(r,l,127),l+=7);M--;)C[S++]=B}}var O=C.subarray(0,E),U=C.subarray(E);f=qf(O),d=qf(U),u=ql(O,f,1),h=ql(U,d,1)}else throw"invalid block type";else{var p=bb(l)+4,y=r[p-4]|r[p-3]<<8,v=p+y;if(v>i){if(s)throw"unexpected EOF";break}n&&o(c+y),e.set(r.subarray(p,v),c),t.b=c+=y,t.p=l=v*8;continue}if(l>m){if(s)throw"unexpected EOF";break}}n&&o(c+131072);for(var Y=(1<<f)-1,W=(1<<d)-1,N=l;;N=l){var B=u[Xf(r,l)&Y],K=B>>>4;if(l+=B&15,l>m){if(s)throw"unexpected EOF";break}if(!B)throw"invalid length/literal";if(K<256)e[c++]=K;else if(K==256){N=l,u=null;break}else{var D=K-254;if(K>264){var S=K-257,z=D3[S];D=ds(r,l,(1<<z)-1)+F3[S],l+=z}var $=h[Xf(r,l)&W],V=$>>>4;if(!$)throw"invalid distance";l+=$&15;var U=_b[V];if(V>3){var z=M3[V];U+=Xf(r,l)&(1<<z)-1,l+=z}if(l>m){if(s)throw"unexpected EOF";break}n&&o(c+131072);for(var P=c+D;c<P;c+=4)e[c]=e[c-U],e[c+1]=e[c+1-U],e[c+2]=e[c+2-U],e[c+3]=e[c+3-U];c=P}}t.l=u,t.p=N,t.b=c,u&&(a=1,t.m=f,t.d=h,t.n=d)}while(!a);return c==e.length?e:wb(e,0,c)},Rb=new es(0),Db=function(r){if((r[0]&15)!=8||r[0]>>>4>7||(r[0]<<8|r[1])%31)throw"invalid zlib data";if(r[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function Gl(r,e){return Bb((Db(r),r.subarray(2,-4)),e)}var Mb=typeof TextDecoder<"u"&&new TextDecoder,Lb=0;try{Mb.decode(Rb,{stream:!0}),Lb=1}catch{}let Pb=class extends ze{constructor(e,t,i=!1,n=!1,s=1e4){const o=new Gi;super(o,t),this.isMarchingCubes=!0;const a=this,l=new Float32Array(36),c=new Float32Array(36),u=new Float32Array(36);this.enableUvs=i,this.enableColors=n,this.init=function(v){this.resolution=v,this.isolation=80,this.size=v,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(this.size3*3),this.palette=new Float32Array(this.size3*3),this.count=0;const E=s*3;this.positionArray=new Float32Array(E*3);const x=new Vt(this.positionArray,3);x.setUsage(nn),o.setAttribute("position",x),this.normalArray=new Float32Array(E*3);const I=new Vt(this.normalArray,3);if(I.setUsage(nn),o.setAttribute("normal",I),this.enableUvs){this.uvArray=new Float32Array(E*2);const C=new Vt(this.uvArray,2);C.setUsage(nn),o.setAttribute("uv",C)}if(this.enableColors){this.colorArray=new Float32Array(E*3);const C=new Vt(this.colorArray,3);C.setUsage(nn),o.setAttribute("color",C)}o.boundingSphere=new hn(new Q,1)};function h(v,E,x){return v+(E-v)*x}function f(v,E,x,I,C,_,S,b,T,R){const w=(x-S)/(b-S),B=a.normal_cache;l[E+0]=I+w*a.delta,l[E+1]=C,l[E+2]=_,c[E+0]=h(B[v+0],B[v+3],w),c[E+1]=h(B[v+1],B[v+4],w),c[E+2]=h(B[v+2],B[v+5],w),u[E+0]=h(a.palette[T*3+0],a.palette[R*3+0],w),u[E+1]=h(a.palette[T*3+1],a.palette[R*3+1],w),u[E+2]=h(a.palette[T*3+2],a.palette[R*3+2],w)}function d(v,E,x,I,C,_,S,b,T,R){const w=(x-S)/(b-S),B=a.normal_cache;l[E+0]=I,l[E+1]=C+w*a.delta,l[E+2]=_;const M=v+a.yd*3;c[E+0]=h(B[v+0],B[M+0],w),c[E+1]=h(B[v+1],B[M+1],w),c[E+2]=h(B[v+2],B[M+2],w),u[E+0]=h(a.palette[T*3+0],a.palette[R*3+0],w),u[E+1]=h(a.palette[T*3+1],a.palette[R*3+1],w),u[E+2]=h(a.palette[T*3+2],a.palette[R*3+2],w)}function m(v,E,x,I,C,_,S,b,T,R){const w=(x-S)/(b-S),B=a.normal_cache;l[E+0]=I,l[E+1]=C,l[E+2]=_+w*a.delta;const M=v+a.zd*3;c[E+0]=h(B[v+0],B[M+0],w),c[E+1]=h(B[v+1],B[M+1],w),c[E+2]=h(B[v+2],B[M+2],w),u[E+0]=h(a.palette[T*3+0],a.palette[R*3+0],w),u[E+1]=h(a.palette[T*3+1],a.palette[R*3+1],w),u[E+2]=h(a.palette[T*3+2],a.palette[R*3+2],w)}function A(v){const E=v*3;a.normal_cache[E]===0&&(a.normal_cache[E+0]=a.field[v-1]-a.field[v+1],a.normal_cache[E+1]=a.field[v-a.yd]-a.field[v+a.yd],a.normal_cache[E+2]=a.field[v-a.zd]-a.field[v+a.zd])}function p(v,E,x,I,C){const _=I+1,S=I+a.yd,b=I+a.zd,T=_+a.yd,R=_+a.zd,w=I+a.yd+a.zd,B=_+a.yd+a.zd;let M=0;const O=a.field[I],U=a.field[_],Y=a.field[S],W=a.field[T],N=a.field[b],K=a.field[R],D=a.field[w],z=a.field[B];O<C&&(M|=1),U<C&&(M|=2),Y<C&&(M|=8),W<C&&(M|=4),N<C&&(M|=16),K<C&&(M|=32),D<C&&(M|=128),z<C&&(M|=64);const $=Fb[M];if($===0)return 0;const V=a.delta,P=v+V,G=E+V,F=x+V;$&1&&(A(I),A(_),f(I*3,0,C,v,E,x,O,U,I,_)),$&2&&(A(_),A(T),d(_*3,3,C,P,E,x,U,W,_,T)),$&4&&(A(S),A(T),f(S*3,6,C,v,G,x,Y,W,S,T)),$&8&&(A(I),A(S),d(I*3,9,C,v,E,x,O,Y,I,S)),$&16&&(A(b),A(R),f(b*3,12,C,v,E,F,N,K,b,R)),$&32&&(A(R),A(B),d(R*3,15,C,P,E,F,K,z,R,B)),$&64&&(A(w),A(B),f(w*3,18,C,v,G,F,D,z,w,B)),$&128&&(A(b),A(w),d(b*3,21,C,v,E,F,N,D,b,w)),$&256&&(A(I),A(b),m(I*3,24,C,v,E,x,O,N,I,b)),$&512&&(A(_),A(R),m(_*3,27,C,P,E,x,U,K,_,R)),$&1024&&(A(T),A(B),m(T*3,30,C,P,G,x,W,z,T,B)),$&2048&&(A(S),A(w),m(S*3,33,C,v,G,x,Y,D,S,w)),M<<=4;let k,Z,ne,X=0,te=0;for(;Yc[M+te]!=-1;)k=M+te,Z=k+1,ne=k+2,y(l,c,u,3*Yc[k],3*Yc[Z],3*Yc[ne]),te+=3,X++;return X}function y(v,E,x,I,C,_){const S=a.count*3;if(a.positionArray[S+0]=v[I],a.positionArray[S+1]=v[I+1],a.positionArray[S+2]=v[I+2],a.positionArray[S+3]=v[C],a.positionArray[S+4]=v[C+1],a.positionArray[S+5]=v[C+2],a.positionArray[S+6]=v[_],a.positionArray[S+7]=v[_+1],a.positionArray[S+8]=v[_+2],a.material.flatShading===!0){const b=(E[I+0]+E[C+0]+E[_+0])/3,T=(E[I+1]+E[C+1]+E[_+1])/3,R=(E[I+2]+E[C+2]+E[_+2])/3;a.normalArray[S+0]=b,a.normalArray[S+1]=T,a.normalArray[S+2]=R,a.normalArray[S+3]=b,a.normalArray[S+4]=T,a.normalArray[S+5]=R,a.normalArray[S+6]=b,a.normalArray[S+7]=T,a.normalArray[S+8]=R}else a.normalArray[S+0]=E[I+0],a.normalArray[S+1]=E[I+1],a.normalArray[S+2]=E[I+2],a.normalArray[S+3]=E[C+0],a.normalArray[S+4]=E[C+1],a.normalArray[S+5]=E[C+2],a.normalArray[S+6]=E[_+0],a.normalArray[S+7]=E[_+1],a.normalArray[S+8]=E[_+2];if(a.enableUvs){const b=a.count*2;a.uvArray[b+0]=v[I+0],a.uvArray[b+1]=v[I+2],a.uvArray[b+2]=v[C+0],a.uvArray[b+3]=v[C+2],a.uvArray[b+4]=v[_+0],a.uvArray[b+5]=v[_+2]}a.enableColors&&(a.colorArray[S+0]=x[I+0],a.colorArray[S+1]=x[I+1],a.colorArray[S+2]=x[I+2],a.colorArray[S+3]=x[C+0],a.colorArray[S+4]=x[C+1],a.colorArray[S+5]=x[C+2],a.colorArray[S+6]=x[_+0],a.colorArray[S+7]=x[_+1],a.colorArray[S+8]=x[_+2]),a.count+=3}this.addBall=function(v,E,x,I,C,_){const S=Math.sign(I);I=Math.abs(I);const b=_!=null;let T=new We(v,E,x);if(b)try{T=_ instanceof We?_:Array.isArray(_)?new We(Math.min(Math.abs(_[0]),1),Math.min(Math.abs(_[1]),1),Math.min(Math.abs(_[2]),1)):new We(_)}catch{T=new We(v,E,x)}const R=this.size*Math.sqrt(I/C),w=x*this.size,B=E*this.size,M=v*this.size;let O=Math.floor(w-R);O<1&&(O=1);let U=Math.floor(w+R);U>this.size-1&&(U=this.size-1);let Y=Math.floor(B-R);Y<1&&(Y=1);let W=Math.floor(B+R);W>this.size-1&&(W=this.size-1);let N=Math.floor(M-R);N<1&&(N=1);let K=Math.floor(M+R);K>this.size-1&&(K=this.size-1);let D,z,$,V,P,G,F,k,Z,ne,X;for($=O;$<U;$++)for(P=this.size2*$,k=$/this.size-x,Z=k*k,z=Y;z<W;z++)for(V=P+this.size*z,F=z/this.size-E,ne=F*F,D=N;D<K;D++)if(G=D/this.size-v,X=I/(1e-6+G*G+ne+Z)-C,X>0){this.field[V+D]+=X*S;const te=Math.sqrt((D-M)*(D-M)+(z-B)*(z-B)+($-w)*($-w))/R,ye=1-te*te*te*(te*(te*6-15)+10);this.palette[(V+D)*3+0]+=T.r*ye,this.palette[(V+D)*3+1]+=T.g*ye,this.palette[(V+D)*3+2]+=T.b*ye}},this.addPlaneX=function(v,E){const x=this.size,I=this.yd,C=this.zd,_=this.field;let S,b,T,R,w,B,M,O=x*Math.sqrt(v/E);for(O>x&&(O=x),S=0;S<O;S++)if(B=S/x,R=B*B,w=v/(1e-4+R)-E,w>0)for(b=0;b<x;b++)for(M=S+b*I,T=0;T<x;T++)_[C*T+M]+=w},this.addPlaneY=function(v,E){const x=this.size,I=this.yd,C=this.zd,_=this.field;let S,b,T,R,w,B,M,O,U=x*Math.sqrt(v/E);for(U>x&&(U=x),b=0;b<U;b++)if(B=b/x,R=B*B,w=v/(1e-4+R)-E,w>0)for(M=b*I,S=0;S<x;S++)for(O=M+S,T=0;T<x;T++)_[C*T+O]+=w},this.addPlaneZ=function(v,E){const x=this.size,I=this.yd,C=this.zd,_=this.field;let S,b,T,R,w,B,M,O,U=x*Math.sqrt(v/E);for(U>x&&(U=x),T=0;T<U;T++)if(B=T/x,R=B*B,w=v/(1e-4+R)-E,w>0)for(M=C*T,b=0;b<x;b++)for(O=M+b*I,S=0;S<x;S++)_[O+S]+=w},this.setCell=function(v,E,x,I){const C=this.size2*x+this.size*E+v;this.field[C]=I},this.getCell=function(v,E,x){const I=this.size2*x+this.size*E+v;return this.field[I]},this.blur=function(v=1){const E=this.field,x=E.slice(),I=this.size,C=this.size2;for(let _=0;_<I;_++)for(let S=0;S<I;S++)for(let b=0;b<I;b++){const T=C*b+I*S+_;let R=x[T],w=1;for(let B=-1;B<=1;B+=2){const M=B+_;if(!(M<0||M>=I))for(let O=-1;O<=1;O+=2){const U=O+S;if(!(U<0||U>=I))for(let Y=-1;Y<=1;Y+=2){const W=Y+b;if(W<0||W>=I)continue;const N=C*W+I*U+M,K=x[N];w++,R+=v*(K-R)/w}}}E[T]=R}},this.reset=function(){for(let v=0;v<this.size3;v++)this.normal_cache[v*3]=0,this.field[v]=0,this.palette[v*3]=this.palette[v*3+1]=this.palette[v*3+2]=0},this.update=function(){this.count=0;const v=this.size-2;for(let E=1;E<v;E++){const x=this.size2*E,I=(E-this.halfsize)/this.halfsize;for(let C=1;C<v;C++){const _=x+this.size*C,S=(C-this.halfsize)/this.halfsize;for(let b=1;b<v;b++){const T=(b-this.halfsize)/this.halfsize,R=_+b;p(T,S,I,R,this.isolation)}}}this.geometry.setDrawRange(0,this.count),o.getAttribute("position").needsUpdate=!0,o.getAttribute("normal").needsUpdate=!0,this.enableUvs&&(o.getAttribute("uv").needsUpdate=!0),this.enableColors&&(o.getAttribute("color").needsUpdate=!0),this.count/3>s&&console.warn("THREE.MarchingCubes: Geometry buffers too small for rendering. Please create an instance with a higher poly count.")},this.init(e)}};const Fb=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),Yc=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]);var kb=Object.defineProperty,Ob=(r,e,t)=>e in r?kb(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ms=(r,e,t)=>(Ob(r,typeof e!="symbol"?e+"":e,t),t);class Jf{constructor(e=Math){ms(this,"grad3",[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]]),ms(this,"grad4",[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]]),ms(this,"p",[]),ms(this,"perm",[]),ms(this,"simplex",[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]),ms(this,"dot",(t,i,n)=>t[0]*i+t[1]*n),ms(this,"dot3",(t,i,n,s)=>t[0]*i+t[1]*n+t[2]*s),ms(this,"dot4",(t,i,n,s,o)=>t[0]*i+t[1]*n+t[2]*s+t[3]*o),ms(this,"noise",(t,i)=>{let n,s,o;const a=.5*(Math.sqrt(3)-1),l=(t+i)*a,c=Math.floor(t+l),u=Math.floor(i+l),h=(3-Math.sqrt(3))/6,f=(c+u)*h,d=c-f,m=u-f,A=t-d,p=i-m;let y=0,v=1;A>p&&(y=1,v=0);const E=A-y+h,x=p-v+h,I=A-1+2*h,C=p-1+2*h,_=c&255,S=u&255,b=this.perm[_+this.perm[S]]%12,T=this.perm[_+y+this.perm[S+v]]%12,R=this.perm[_+1+this.perm[S+1]]%12;let w=.5-A*A-p*p;w<0?n=0:(w*=w,n=w*w*this.dot(this.grad3[b],A,p));let B=.5-E*E-x*x;B<0?s=0:(B*=B,s=B*B*this.dot(this.grad3[T],E,x));let M=.5-I*I-C*C;return M<0?o=0:(M*=M,o=M*M*this.dot(this.grad3[R],I,C)),70*(n+s+o)}),ms(this,"noise3d",(t,i,n)=>{let s,o,a,l;const u=(t+i+n)*.3333333333333333,h=Math.floor(t+u),f=Math.floor(i+u),d=Math.floor(n+u),m=1/6,A=(h+f+d)*m,p=h-A,y=f-A,v=d-A,E=t-p,x=i-y,I=n-v;let C,_,S,b,T,R;E>=x?x>=I?(C=1,_=0,S=0,b=1,T=1,R=0):E>=I?(C=1,_=0,S=0,b=1,T=0,R=1):(C=0,_=0,S=1,b=1,T=0,R=1):x<I?(C=0,_=0,S=1,b=0,T=1,R=1):E<I?(C=0,_=1,S=0,b=0,T=1,R=1):(C=0,_=1,S=0,b=1,T=1,R=0);const w=E-C+m,B=x-_+m,M=I-S+m,O=E-b+2*m,U=x-T+2*m,Y=I-R+2*m,W=E-1+3*m,N=x-1+3*m,K=I-1+3*m,D=h&255,z=f&255,$=d&255,V=this.perm[D+this.perm[z+this.perm[$]]]%12,P=this.perm[D+C+this.perm[z+_+this.perm[$+S]]]%12,G=this.perm[D+b+this.perm[z+T+this.perm[$+R]]]%12,F=this.perm[D+1+this.perm[z+1+this.perm[$+1]]]%12;let k=.6-E*E-x*x-I*I;k<0?s=0:(k*=k,s=k*k*this.dot3(this.grad3[V],E,x,I));let Z=.6-w*w-B*B-M*M;Z<0?o=0:(Z*=Z,o=Z*Z*this.dot3(this.grad3[P],w,B,M));let ne=.6-O*O-U*U-Y*Y;ne<0?a=0:(ne*=ne,a=ne*ne*this.dot3(this.grad3[G],O,U,Y));let X=.6-W*W-N*N-K*K;return X<0?l=0:(X*=X,l=X*X*this.dot3(this.grad3[F],W,N,K)),32*(s+o+a+l)}),ms(this,"noise4d",(t,i,n,s)=>{const o=this.grad4,a=this.simplex,l=this.perm,c=(Math.sqrt(5)-1)/4,u=(5-Math.sqrt(5))/20;let h,f,d,m,A;const p=(t+i+n+s)*c,y=Math.floor(t+p),v=Math.floor(i+p),E=Math.floor(n+p),x=Math.floor(s+p),I=(y+v+E+x)*u,C=y-I,_=v-I,S=E-I,b=x-I,T=t-C,R=i-_,w=n-S,B=s-b,M=T>R?32:0,O=T>w?16:0,U=R>w?8:0,Y=T>B?4:0,W=R>B?2:0,N=w>B?1:0,K=M+O+U+Y+W+N;let D,z,$,V,P,G,F,k,Z,ne,X,te;D=a[K][0]>=3?1:0,z=a[K][1]>=3?1:0,$=a[K][2]>=3?1:0,V=a[K][3]>=3?1:0,P=a[K][0]>=2?1:0,G=a[K][1]>=2?1:0,F=a[K][2]>=2?1:0,k=a[K][3]>=2?1:0,Z=a[K][0]>=1?1:0,ne=a[K][1]>=1?1:0,X=a[K][2]>=1?1:0,te=a[K][3]>=1?1:0;const ye=T-D+u,ve=R-z+u,re=w-$+u,se=B-V+u,he=T-P+2*u,le=R-G+2*u,J=w-F+2*u,q=B-k+2*u,oe=T-Z+3*u,Ie=R-ne+3*u,_e=w-X+3*u,Be=B-te+3*u,Se=T-1+4*u,Ke=R-1+4*u,Me=w-1+4*u,Ge=B-1+4*u,Qe=y&255,qe=v&255,rt=E&255,gt=x&255,nt=l[Qe+l[qe+l[rt+l[gt]]]]%32,Xe=l[Qe+D+l[qe+z+l[rt+$+l[gt+V]]]]%32,je=l[Qe+P+l[qe+G+l[rt+F+l[gt+k]]]]%32,ie=l[Qe+Z+l[qe+ne+l[rt+X+l[gt+te]]]]%32,be=l[Qe+1+l[qe+1+l[rt+1+l[gt+1]]]]%32;let Le=.6-T*T-R*R-w*w-B*B;Le<0?h=0:(Le*=Le,h=Le*Le*this.dot4(o[nt],T,R,w,B));let Ye=.6-ye*ye-ve*ve-re*re-se*se;Ye<0?f=0:(Ye*=Ye,f=Ye*Ye*this.dot4(o[Xe],ye,ve,re,se));let pe=.6-he*he-le*le-J*J-q*q;pe<0?d=0:(pe*=pe,d=pe*pe*this.dot4(o[je],he,le,J,q));let at=.6-oe*oe-Ie*Ie-_e*_e-Be*Be;at<0?m=0:(at*=at,m=at*at*this.dot4(o[ie],oe,Ie,_e,Be));let ti=.6-Se*Se-Ke*Ke-Me*Me-Ge*Ge;return ti<0?A=0:(ti*=ti,A=ti*ti*this.dot4(o[be],Se,Ke,Me,Ge)),27*(h+f+d+m+A)});for(let t=0;t<256;t++)this.p[t]=Math.floor(e.random()*256);for(let t=0;t<512;t++)this.perm[t]=this.p[t&255]}}var Ub=Object.defineProperty,Nb=(r,e,t)=>e in r?Ub(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,l1=(r,e,t)=>(Nb(r,typeof e!="symbol"?e+"":e,t),t);const Gb=(()=>{const r={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new Q},up:{value:new Q(0,1,0)}},vertexShader:`
      uniform vec3 sunPosition;
      uniform float rayleigh;
      uniform float turbidity;
      uniform float mieCoefficient;
      uniform vec3 up;

      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      // constants for atmospheric scattering
      const float e = 2.71828182845904523536028747135266249775724709369995957;
      const float pi = 3.141592653589793238462643383279502884197169;

      // wavelength of used primaries, according to preetham
      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

      // mie stuff
      // K coefficient for the primaries
      const float v = 4.0;
      const vec3 K = vec3( 0.686, 0.678, 0.666 );
      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

      // earth shadow hack
      // cutoffAngle = pi / 1.95;
      const float cutoffAngle = 1.6110731556870734;
      const float steepness = 1.5;
      const float EE = 1000.0;

      float sunIntensity( float zenithAngleCos ) {
        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
      }

      vec3 totalMie( float T ) {
        float c = ( 0.2 * T ) * 10E-18;
        return 0.434 * c * MieConst;
      }

      void main() {

        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
        vWorldPosition = worldPosition.xyz;

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        gl_Position.z = gl_Position.w; // set z to camera.far

        vSunDirection = normalize( sunPosition );

        vSunE = sunIntensity( dot( vSunDirection, up ) );

        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

      // extinction (absorbtion + out scattering)
      // rayleigh coefficients
        vBetaR = totalRayleigh * rayleighCoefficient;

      // mie coefficients
        vBetaM = totalMie( turbidity ) * mieCoefficient;

      }
    `,fragmentShader:`
      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      uniform float mieDirectionalG;
      uniform vec3 up;

      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

      // constants for atmospheric scattering
      const float pi = 3.141592653589793238462643383279502884197169;

      const float n = 1.0003; // refractive index of air
      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

      // optical length at zenith for molecules
      const float rayleighZenithLength = 8.4E3;
      const float mieZenithLength = 1.25E3;
      // 66 arc seconds -> degrees, and the cosine of that
      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

      // 3.0 / ( 16.0 * pi )
      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
      // 1.0 / ( 4.0 * pi )
      const float ONE_OVER_FOURPI = 0.07957747154594767;

      float rayleighPhase( float cosTheta ) {
        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
      }

      float hgPhase( float cosTheta, float g ) {
        float g2 = pow( g, 2.0 );
        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
      }

      void main() {

        vec3 direction = normalize( vWorldPosition - cameraPos );

      // optical length
      // cutoff angle at 90 to avoid singularity in next formula.
        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
        float sR = rayleighZenithLength * inverse;
        float sM = mieZenithLength * inverse;

      // combined extinction factor
        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

      // in scattering
        float cosTheta = dot( direction, vSunDirection );

        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
        vec3 betaRTheta = vBetaR * rPhase;

        float mPhase = hgPhase( cosTheta, mieDirectionalG );
        vec3 betaMTheta = vBetaM * mPhase;

        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

      // nightsky
        float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
        float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
        vec3 L0 = vec3( 0.1 ) * Fex;

      // composition + solar disc
        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

        gl_FragColor = vec4( retColor, 1.0 );

      #include <tonemapping_fragment>
      #include <${Na>=154?"colorspace_fragment":"encodings_fragment"}>

      }
    `},e=new Ii({name:"SkyShader",fragmentShader:r.fragmentShader,vertexShader:r.vertexShader,uniforms:Ba.clone(r.uniforms),side:Oa,depthWrite:!1});class t extends ze{constructor(){super(new Br(1,1,1),e)}}return l1(t,"SkyShader",r),l1(t,"material",e),t})(),Qb=r=>r&&r.isCubeTexture;class zb extends ze{constructor(e,t){var i,n;const s=Qb(e),a=((n=s?(i=e.image[0])==null?void 0:i.width:e.image.width)!=null?n:1024)/4,l=Math.floor(Math.log2(a)),c=Math.pow(2,l),u=3*Math.max(c,112),h=4*c,f=[s?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/u}`,`#define CUBEUV_TEXEL_HEIGHT ${1/h}`,`#define CUBEUV_MAX_MIP ${l}.0`],d=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,m=f.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${Na>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,A={map:{value:e},height:{value:t?.height||15},radius:{value:t?.radius||100}},p=new b4(1,16),y=new Ii({uniforms:A,fragmentShader:m,vertexShader:d,side:bi});super(p,y)}set radius(e){this.material.uniforms.radius.value=e}get radius(){return this.material.uniforms.radius.value}set height(e){this.material.uniforms.height.value=e}get height(){return this.material.uniforms.height.value}}function O3(r,e,t={}){const i=new Q,n=new st,s=new Q,o=new we,a=new we,l=new we;t.preserveMatrix=t.preserveMatrix!==void 0?t.preserveMatrix:!0,t.preservePosition=t.preservePosition!==void 0?t.preservePosition:!0,t.preserveHipPosition=t.preserveHipPosition!==void 0?t.preserveHipPosition:!1,t.useTargetMatrix=t.useTargetMatrix!==void 0?t.useTargetMatrix:!1,t.hip=t.hip!==void 0?t.hip:"hip",t.names=t.names||{};const c=e.isObject3D?e.skeleton.bones:Dh(e),u=r.isObject3D?r.skeleton.bones:Dh(r);let h,f,d,m,A;if(r.isObject3D?r.skeleton.pose():(t.useTargetMatrix=!0,t.preserveMatrix=!1),t.preservePosition){A=[];for(let p=0;p<u.length;p++)A.push(u[p].position.clone())}if(t.preserveMatrix){r.updateMatrixWorld(),r.matrixWorld.identity();for(let p=0;p<r.children.length;++p)r.children[p].updateMatrixWorld(!0)}if(t.offsets){h=[];for(let p=0;p<u.length;++p)f=u[p],d=t.names[f.name]||f.name,t.offsets[d]&&(f.matrix.multiply(t.offsets[d]),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()),h.push(f.matrixWorld.clone())}for(let p=0;p<u.length;++p){if(f=u[p],d=t.names[f.name]||f.name,m=U3(d,c),l.copy(f.matrixWorld),m){if(m.updateMatrixWorld(),t.useTargetMatrix?a.copy(m.matrixWorld):(a.copy(r.matrixWorld).invert(),a.multiply(m.matrixWorld)),s.setFromMatrixScale(a),a.scale(s.set(1/s.x,1/s.y,1/s.z)),l.makeRotationFromQuaternion(n.setFromRotationMatrix(a)),r.isObject3D){const y=u.indexOf(f),v=h?h[y]:o.copy(r.skeleton.boneInverses[y]).invert();l.multiply(v)}l.copyPosition(a)}f.parent&&f.parent.isBone?(f.matrix.copy(f.parent.matrixWorld).invert(),f.matrix.multiply(l)):f.matrix.copy(l),t.preserveHipPosition&&d===t.hip&&f.matrix.setPosition(i.set(0,f.position.y,0)),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()}if(t.preservePosition)for(let p=0;p<u.length;++p)f=u[p],d=t.names[f.name]||f.name,d!==t.hip&&f.position.copy(A[p]);t.preserveMatrix&&r.updateMatrixWorld(!0)}function Hb(r,e,t,i={}){i.useFirstFramePosition=i.useFirstFramePosition!==void 0?i.useFirstFramePosition:!1,i.fps=i.fps!==void 0?i.fps:30,i.names=i.names||[],e.isObject3D||(e=Kb(e));const n=Math.round(t.duration*(i.fps/1e3)*1e3),s=1/i.fps,o=[],a=new aE(e),l=Dh(r.skeleton),c=[];let u,h,f,d,m;a.clipAction(t).play(),a.update(0),e.updateMatrixWorld();for(let A=0;A<n;++A){const p=A*s;O3(r,e,i);for(let y=0;y<l.length;++y)m=i.names[l[y].name]||l[y].name,f=U3(m,e.skeleton),f&&(h=l[y],d=c[y]=c[y]||{bone:h},i.hip===m&&(d.pos||(d.pos={times:new Float32Array(n),values:new Float32Array(n*3)}),i.useFirstFramePosition&&(A===0&&(u=h.position.clone()),h.position.sub(u)),d.pos.times[A]=p,h.position.toArray(d.pos.values,A*3)),d.quat||(d.quat={times:new Float32Array(n),values:new Float32Array(n*4)}),d.quat.times[A]=p,h.quaternion.toArray(d.quat.values,A*4));a.update(s),e.updateMatrixWorld()}for(let A=0;A<c.length;++A)d=c[A],d&&(d.pos&&o.push(new yh(".bones["+d.bone.name+"].position",d.pos.times,d.pos.values)),o.push(new vh(".bones["+d.bone.name+"].quaternion",d.quat.times,d.quat.values)));return a.uncacheAction(t),new eA(t.name,-1,o)}function Vb(r){const e=new Map,t=new Map,i=r.clone();return N3(r,i,function(n,s){e.set(s,n),t.set(n,s)}),i.traverse(function(n){if(!n.isSkinnedMesh)return;const s=n,o=e.get(n),a=o.skeleton.bones;s.skeleton=o.skeleton.clone(),s.bindMatrix.copy(o.bindMatrix),s.skeleton.bones=a.map(function(l){return t.get(l)}),s.bind(s.skeleton,s.bindMatrix)}),i}function U3(r,e){for(let t=0,i=Dh(e);t<i.length;t++)if(r===i[t].name)return i[t]}function Dh(r){return Array.isArray(r)?r:r.bones}function Kb(r){const e=new w4(r.bones[0]);return e.skeleton=r,e}function N3(r,e,t){t(r,e);for(let i=0;i<r.children.length;i++)N3(r.children[i],e.children[i],t)}const $b={retarget:O3,retargetClip:Hb,clone:Vb},ji=new ha,Wc=new Q;class Yb{constructor(e){let t=e.geometry;t.index&&(console.warn("THREE.MeshSurfaceSampler: Converting geometry to non-indexed BufferGeometry."),t=t.toNonIndexed()),this.geometry=t,this.randomFunction=Math.random,this.positionAttribute=this.geometry.getAttribute("position"),this.colorAttribute=this.geometry.getAttribute("color"),this.weightAttribute=null,this.distribution=null}setWeightAttribute(e){return this.weightAttribute=e?this.geometry.getAttribute(e):null,this}build(){const e=this.positionAttribute,t=this.weightAttribute,i=new Float32Array(e.count/3);for(let s=0;s<e.count;s+=3){let o=1;t&&(o=t.getX(s)+t.getX(s+1)+t.getX(s+2)),ji.a.fromBufferAttribute(e,s),ji.b.fromBufferAttribute(e,s+1),ji.c.fromBufferAttribute(e,s+2),o*=ji.getArea(),i[s/3]=o}this.distribution=new Float32Array(e.count/3);let n=0;for(let s=0;s<i.length;s++)n+=i[s],this.distribution[s]=n;return this}setRandomGenerator(e){return this.randomFunction=e,this}sample(e,t,i){const n=this.sampleFaceIndex();return this.sampleFace(n,e,t,i)}sampleFaceIndex(){const e=this.distribution[this.distribution.length-1];return this.binarySearch(this.randomFunction()*e)}binarySearch(e){const t=this.distribution;let i=0,n=t.length-1,s=-1;for(;i<=n;){const o=Math.ceil((i+n)/2);if(o===0||t[o-1]<=e&&t[o]>e){s=o;break}else e<t[o]?n=o-1:i=o+1}return s}sampleFace(e,t,i,n){let s=this.randomFunction(),o=this.randomFunction();return s+o>1&&(s=1-s,o=1-o),ji.a.fromBufferAttribute(this.positionAttribute,e*3),ji.b.fromBufferAttribute(this.positionAttribute,e*3+1),ji.c.fromBufferAttribute(this.positionAttribute,e*3+2),t.set(0,0,0).addScaledVector(ji.a,s).addScaledVector(ji.b,o).addScaledVector(ji.c,1-(s+o)),i!==void 0&&ji.getNormal(i),n!==void 0&&this.colorAttribute!==void 0&&(ji.a.fromBufferAttribute(this.colorAttribute,e*3),ji.b.fromBufferAttribute(this.colorAttribute,e*3+1),ji.c.fromBufferAttribute(this.colorAttribute,e*3+2),Wc.set(0,0,0).addScaledVector(ji.a,s).addScaledVector(ji.b,o).addScaledVector(ji.c,1-(s+o)),n.r=Wc.x,n.g=Wc.y,n.b=Wc.z),this}}var Wb=Object.defineProperty,jb=(r,e,t)=>e in r?Wb(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,qb=(r,e,t)=>(jb(r,e+"",t),t);let xo=class{constructor(){qb(this,"_listeners")}addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){if(this._listeners===void 0)return!1;const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){if(this._listeners===void 0)return;const n=this._listeners[e];if(n!==void 0){const s=n.indexOf(t);s!==-1&&n.splice(s,1)}}dispatchEvent(e){if(this._listeners===void 0)return;const i=this._listeners[e.type];if(i!==void 0){e.target=this;const n=i.slice(0);for(let s=0,o=n.length;s<o;s++)n[s].call(this,e);e.target=null}}};var Xb=Object.defineProperty,Jb=(r,e,t)=>e in r?Xb(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,mt=(r,e,t)=>(Jb(r,typeof e!="symbol"?e+"":e,t),t);const c1=new Q;let Zb=class extends xo{constructor(e,t){super(),mt(this,"object"),mt(this,"domElement"),mt(this,"enabled",!0),mt(this,"movementSpeed",1),mt(this,"lookSpeed",.005),mt(this,"lookVertical",!0),mt(this,"autoForward",!1),mt(this,"activeLook",!0),mt(this,"heightSpeed",!1),mt(this,"heightCoef",1),mt(this,"heightMin",0),mt(this,"heightMax",1),mt(this,"constrainVertical",!1),mt(this,"verticalMin",0),mt(this,"verticalMax",Math.PI),mt(this,"mouseDragOn",!1),mt(this,"autoSpeedFactor",0),mt(this,"mouseX",0),mt(this,"mouseY",0),mt(this,"moveForward",!1),mt(this,"moveBackward",!1),mt(this,"moveLeft",!1),mt(this,"moveRight",!1),mt(this,"moveUp",!1),mt(this,"moveDown",!1),mt(this,"viewHalfX",0),mt(this,"viewHalfY",0),mt(this,"lat",0),mt(this,"lon",0),mt(this,"lookDirection",new Q),mt(this,"spherical",new wa),mt(this,"target",new Q),mt(this,"connect",i=>{i.setAttribute("tabindex","-1"),i.style.touchAction="none",i.addEventListener("contextmenu",this.contextmenu),i.addEventListener("mousemove",this.onMouseMove),i.addEventListener("mousedown",this.onMouseDown),i.addEventListener("mouseup",this.onMouseUp),this.domElement=i,window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.handleResize()}),mt(this,"dispose",()=>{var i,n,s,o;(i=this.domElement)==null||i.removeEventListener("contextmenu",this.contextmenu),(n=this.domElement)==null||n.removeEventListener("mousedown",this.onMouseDown),(s=this.domElement)==null||s.removeEventListener("mousemove",this.onMouseMove),(o=this.domElement)==null||o.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}),mt(this,"handleResize",()=>{this.domElement&&(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)}),mt(this,"onMouseDown",i=>{var n;if((n=this.domElement)==null||n.focus(),this.activeLook)switch(i.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0;break}this.mouseDragOn=!0}),mt(this,"onMouseUp",i=>{if(this.activeLook)switch(i.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1;break}this.mouseDragOn=!1}),mt(this,"onMouseMove",i=>{this.domElement&&(this.mouseX=i.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=i.pageY-this.domElement.offsetTop-this.viewHalfY)}),mt(this,"onKeyDown",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyR":this.moveUp=!0;break;case"KeyF":this.moveDown=!0;break}}),mt(this,"onKeyUp",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyR":this.moveUp=!1;break;case"KeyF":this.moveDown=!1;break}}),mt(this,"lookAt",(i,n,s)=>(i instanceof Q?this.target.copy(i):n&&s&&this.target.set(i,n,s),this.object.lookAt(this.target),this.setOrientation(),this)),mt(this,"update",i=>{if(!this.enabled)return;if(this.heightSpeed){const h=tt.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=i*(h*this.heightCoef)}else this.autoSpeedFactor=0;const n=i*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(n+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(n),this.moveLeft&&this.object.translateX(-n),this.moveRight&&this.object.translateX(n),this.moveUp&&this.object.translateY(n),this.moveDown&&this.object.translateY(-n);let s=i*this.lookSpeed;this.activeLook||(s=0);let o=1;this.constrainVertical&&(o=Math.PI/(this.verticalMax-this.verticalMin)),this.lon-=this.mouseX*s,this.lookVertical&&(this.lat-=this.mouseY*s*o),this.lat=Math.max(-85,Math.min(85,this.lat));let a=tt.degToRad(90-this.lat);const l=tt.degToRad(this.lon);this.constrainVertical&&(a=tt.mapLinear(a,0,Math.PI,this.verticalMin,this.verticalMax));const c=this.object.position;c1.setFromSphericalCoords(1,a,l).add(c),this.object.lookAt(c1)}),mt(this,"contextmenu",i=>i.preventDefault()),mt(this,"setOrientation",()=>{this.lookDirection.set(0,0,-1).applyQuaternion(this.object.quaternion),this.spherical.setFromVector3(this.lookDirection),this.lat=90-tt.radToDeg(this.spherical.phi),this.lon=tt.radToDeg(this.spherical.theta)}),this.object=e,this.domElement=t,this.setOrientation(),t&&this.connect(t)}};var e6=Object.defineProperty,t6=(r,e,t)=>e in r?e6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ce=(r,e,t)=>(t6(r,typeof e!="symbol"?e+"":e,t),t);let i6=class extends gi{constructor(e,t){super(),Ce(this,"isTransformControls",!0),Ce(this,"visible",!1),Ce(this,"domElement"),Ce(this,"raycaster",new $h),Ce(this,"gizmo"),Ce(this,"plane"),Ce(this,"tempVector",new Q),Ce(this,"tempVector2",new Q),Ce(this,"tempQuaternion",new st),Ce(this,"unit",{X:new Q(1,0,0),Y:new Q(0,1,0),Z:new Q(0,0,1)}),Ce(this,"pointStart",new Q),Ce(this,"pointEnd",new Q),Ce(this,"offset",new Q),Ce(this,"rotationAxis",new Q),Ce(this,"startNorm",new Q),Ce(this,"endNorm",new Q),Ce(this,"rotationAngle",0),Ce(this,"cameraPosition",new Q),Ce(this,"cameraQuaternion",new st),Ce(this,"cameraScale",new Q),Ce(this,"parentPosition",new Q),Ce(this,"parentQuaternion",new st),Ce(this,"parentQuaternionInv",new st),Ce(this,"parentScale",new Q),Ce(this,"worldPositionStart",new Q),Ce(this,"worldQuaternionStart",new st),Ce(this,"worldScaleStart",new Q),Ce(this,"worldPosition",new Q),Ce(this,"worldQuaternion",new st),Ce(this,"worldQuaternionInv",new st),Ce(this,"worldScale",new Q),Ce(this,"eye",new Q),Ce(this,"positionStart",new Q),Ce(this,"quaternionStart",new st),Ce(this,"scaleStart",new Q),Ce(this,"camera"),Ce(this,"object"),Ce(this,"enabled",!0),Ce(this,"axis",null),Ce(this,"mode","translate"),Ce(this,"translationSnap",null),Ce(this,"rotationSnap",null),Ce(this,"scaleSnap",null),Ce(this,"space","world"),Ce(this,"size",1),Ce(this,"dragging",!1),Ce(this,"showX",!0),Ce(this,"showY",!0),Ce(this,"showZ",!0),Ce(this,"changeEvent",{type:"change"}),Ce(this,"mouseDownEvent",{type:"mouseDown",mode:this.mode}),Ce(this,"mouseUpEvent",{type:"mouseUp",mode:this.mode}),Ce(this,"objectChangeEvent",{type:"objectChange"}),Ce(this,"intersectObjectWithRay",(n,s,o)=>{const a=s.intersectObject(n,!0);for(let l=0;l<a.length;l++)if(a[l].object.visible||o)return a[l];return!1}),Ce(this,"attach",n=>(this.object=n,this.visible=!0,this)),Ce(this,"detach",()=>(this.object=void 0,this.visible=!1,this.axis=null,this)),Ce(this,"reset",()=>this.enabled?(this.dragging&&this.object!==void 0&&(this.object.position.copy(this.positionStart),this.object.quaternion.copy(this.quaternionStart),this.object.scale.copy(this.scaleStart),this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent),this.pointStart.copy(this.pointEnd)),this):this),Ce(this,"updateMatrixWorld",()=>{this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this.parentPosition,this.parentQuaternion,this.parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this.worldScale),this.parentQuaternionInv.copy(this.parentQuaternion).invert(),this.worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this.cameraScale),this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld()}),Ce(this,"pointerHover",n=>{if(this.object===void 0||this.dragging===!0)return;this.raycaster.setFromCamera(n,this.camera);const s=this.intersectObjectWithRay(this.gizmo.picker[this.mode],this.raycaster);s?this.axis=s.object.name:this.axis=null}),Ce(this,"pointerDown",n=>{if(!(this.object===void 0||this.dragging===!0||n.button!==0)&&this.axis!==null){this.raycaster.setFromCamera(n,this.camera);const s=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(s){let o=this.space;if(this.mode==="scale"?o="local":(this.axis==="E"||this.axis==="XYZE"||this.axis==="XYZ")&&(o="world"),o==="local"&&this.mode==="rotate"){const a=this.rotationSnap;this.axis==="X"&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),this.axis==="Y"&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),this.axis==="Z"&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent&&this.object.parent.updateMatrixWorld(),this.positionStart.copy(this.object.position),this.quaternionStart.copy(this.object.quaternion),this.scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this.worldScaleStart),this.pointStart.copy(s.point).sub(this.worldPositionStart)}this.dragging=!0,this.mouseDownEvent.mode=this.mode,this.dispatchEvent(this.mouseDownEvent)}}),Ce(this,"pointerMove",n=>{const s=this.axis,o=this.mode,a=this.object;let l=this.space;if(o==="scale"?l="local":(s==="E"||s==="XYZE"||s==="XYZ")&&(l="world"),a===void 0||s===null||this.dragging===!1||n.button!==-1)return;this.raycaster.setFromCamera(n,this.camera);const c=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(c){if(this.pointEnd.copy(c.point).sub(this.worldPositionStart),o==="translate")this.offset.copy(this.pointEnd).sub(this.pointStart),l==="local"&&s!=="XYZ"&&this.offset.applyQuaternion(this.worldQuaternionInv),s.indexOf("X")===-1&&(this.offset.x=0),s.indexOf("Y")===-1&&(this.offset.y=0),s.indexOf("Z")===-1&&(this.offset.z=0),l==="local"&&s!=="XYZ"?this.offset.applyQuaternion(this.quaternionStart).divide(this.parentScale):this.offset.applyQuaternion(this.parentQuaternionInv).divide(this.parentScale),a.position.copy(this.offset).add(this.positionStart),this.translationSnap&&(l==="local"&&(a.position.applyQuaternion(this.tempQuaternion.copy(this.quaternionStart).invert()),s.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),s.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),s.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.position.applyQuaternion(this.quaternionStart)),l==="world"&&(a.parent&&a.position.add(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld)),s.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),s.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),s.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.parent&&a.position.sub(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld))));else if(o==="scale"){if(s.search("XYZ")!==-1){let u=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(u*=-1),this.tempVector2.set(u,u,u)}else this.tempVector.copy(this.pointStart),this.tempVector2.copy(this.pointEnd),this.tempVector.applyQuaternion(this.worldQuaternionInv),this.tempVector2.applyQuaternion(this.worldQuaternionInv),this.tempVector2.divide(this.tempVector),s.search("X")===-1&&(this.tempVector2.x=1),s.search("Y")===-1&&(this.tempVector2.y=1),s.search("Z")===-1&&(this.tempVector2.z=1);a.scale.copy(this.scaleStart).multiply(this.tempVector2),this.scaleSnap&&this.object&&(s.search("X")!==-1&&(this.object.scale.x=Math.round(a.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),s.search("Y")!==-1&&(a.scale.y=Math.round(a.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),s.search("Z")!==-1&&(a.scale.z=Math.round(a.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(o==="rotate"){this.offset.copy(this.pointEnd).sub(this.pointStart);const u=20/this.worldPosition.distanceTo(this.tempVector.setFromMatrixPosition(this.camera.matrixWorld));s==="E"?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this.startNorm.copy(this.pointStart).normalize(),this.endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this.endNorm.cross(this.startNorm).dot(this.eye)<0?1:-1):s==="XYZE"?(this.rotationAxis.copy(this.offset).cross(this.eye).normalize(),this.rotationAngle=this.offset.dot(this.tempVector.copy(this.rotationAxis).cross(this.eye))*u):(s==="X"||s==="Y"||s==="Z")&&(this.rotationAxis.copy(this.unit[s]),this.tempVector.copy(this.unit[s]),l==="local"&&this.tempVector.applyQuaternion(this.worldQuaternion),this.rotationAngle=this.offset.dot(this.tempVector.cross(this.eye).normalize())*u),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),l==="local"&&s!=="E"&&s!=="XYZE"?(a.quaternion.copy(this.quaternionStart),a.quaternion.multiply(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this.parentQuaternionInv),a.quaternion.copy(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),a.quaternion.multiply(this.quaternionStart).normalize())}this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent)}}),Ce(this,"pointerUp",n=>{n.button===0&&(this.dragging&&this.axis!==null&&(this.mouseUpEvent.mode=this.mode,this.dispatchEvent(this.mouseUpEvent)),this.dragging=!1,this.axis=null)}),Ce(this,"getPointer",n=>{var s;if(this.domElement&&((s=this.domElement.ownerDocument)!=null&&s.pointerLockElement))return{x:0,y:0,button:n.button};{const o=n.changedTouches?n.changedTouches[0]:n,a=this.domElement.getBoundingClientRect();return{x:(o.clientX-a.left)/a.width*2-1,y:-(o.clientY-a.top)/a.height*2+1,button:n.button}}}),Ce(this,"onPointerHover",n=>{if(this.enabled)switch(n.pointerType){case"mouse":case"pen":this.pointerHover(this.getPointer(n));break}}),Ce(this,"onPointerDown",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="none",this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.pointerHover(this.getPointer(n)),this.pointerDown(this.getPointer(n)))}),Ce(this,"onPointerMove",n=>{this.enabled&&this.pointerMove(this.getPointer(n))}),Ce(this,"onPointerUp",n=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="",this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.pointerUp(this.getPointer(n)))}),Ce(this,"getMode",()=>this.mode),Ce(this,"setMode",n=>{this.mode=n}),Ce(this,"setTranslationSnap",n=>{this.translationSnap=n}),Ce(this,"setRotationSnap",n=>{this.rotationSnap=n}),Ce(this,"setScaleSnap",n=>{this.scaleSnap=n}),Ce(this,"setSize",n=>{this.size=n}),Ce(this,"setSpace",n=>{this.space=n}),Ce(this,"update",()=>{console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}),Ce(this,"connect",n=>{n===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointermove",this.onPointerHover),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp)}),Ce(this,"dispose",()=>{var n,s,o,a,l,c;(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(s=this.domElement)==null||s.removeEventListener("pointermove",this.onPointerHover),(a=(o=this.domElement)==null?void 0:o.ownerDocument)==null||a.removeEventListener("pointermove",this.onPointerMove),(c=(l=this.domElement)==null?void 0:l.ownerDocument)==null||c.removeEventListener("pointerup",this.onPointerUp),this.traverse(u=>{const h=u;h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()})}),this.domElement=t,this.camera=e,this.gizmo=new n6,this.add(this.gizmo),this.plane=new s6,this.add(this.plane);const i=(n,s)=>{let o=s;Object.defineProperty(this,n,{get:function(){return o!==void 0?o:s},set:function(a){o!==a&&(o=a,this.plane[n]=a,this.gizmo[n]=a,this.dispatchEvent({type:n+"-changed",value:a}),this.dispatchEvent(this.changeEvent))}}),this[n]=s,this.plane[n]=s,this.gizmo[n]=s};i("camera",this.camera),i("object",this.object),i("enabled",this.enabled),i("axis",this.axis),i("mode",this.mode),i("translationSnap",this.translationSnap),i("rotationSnap",this.rotationSnap),i("scaleSnap",this.scaleSnap),i("space",this.space),i("size",this.size),i("dragging",this.dragging),i("showX",this.showX),i("showY",this.showY),i("showZ",this.showZ),i("worldPosition",this.worldPosition),i("worldPositionStart",this.worldPositionStart),i("worldQuaternion",this.worldQuaternion),i("worldQuaternionStart",this.worldQuaternionStart),i("cameraPosition",this.cameraPosition),i("cameraQuaternion",this.cameraQuaternion),i("pointStart",this.pointStart),i("pointEnd",this.pointEnd),i("rotationAxis",this.rotationAxis),i("rotationAngle",this.rotationAngle),i("eye",this.eye),t!==void 0&&this.connect(t)}};class n6 extends gi{constructor(){super(),Ce(this,"isTransformControlsGizmo",!0),Ce(this,"type","TransformControlsGizmo"),Ce(this,"tempVector",new Q(0,0,0)),Ce(this,"tempEuler",new kn),Ce(this,"alignVector",new Q(0,1,0)),Ce(this,"zeroVector",new Q(0,0,0)),Ce(this,"lookAtMatrix",new we),Ce(this,"tempQuaternion",new st),Ce(this,"tempQuaternion2",new st),Ce(this,"identityQuaternion",new st),Ce(this,"unitX",new Q(1,0,0)),Ce(this,"unitY",new Q(0,1,0)),Ce(this,"unitZ",new Q(0,0,1)),Ce(this,"gizmo"),Ce(this,"picker"),Ce(this,"helper"),Ce(this,"rotationAxis",new Q),Ce(this,"cameraPosition",new Q),Ce(this,"worldPositionStart",new Q),Ce(this,"worldQuaternionStart",new st),Ce(this,"worldPosition",new Q),Ce(this,"worldQuaternion",new st),Ce(this,"eye",new Q),Ce(this,"camera",null),Ce(this,"enabled",!0),Ce(this,"axis",null),Ce(this,"mode","translate"),Ce(this,"space","world"),Ce(this,"size",1),Ce(this,"dragging",!1),Ce(this,"showX",!0),Ce(this,"showY",!0),Ce(this,"showZ",!0),Ce(this,"updateMatrixWorld",()=>{let K=this.space;this.mode==="scale"&&(K="local");const D=K==="local"?this.worldQuaternion:this.identityQuaternion;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let z=[];z=z.concat(this.picker[this.mode].children),z=z.concat(this.gizmo[this.mode].children),z=z.concat(this.helper[this.mode].children);for(let $=0;$<z.length;$++){const V=z[$];V.visible=!0,V.rotation.set(0,0,0),V.position.copy(this.worldPosition);let P;if(this.camera.isOrthographicCamera?P=(this.camera.top-this.camera.bottom)/this.camera.zoom:P=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),V.scale.set(1,1,1).multiplyScalar(P*this.size/7),V.tag==="helper"){V.visible=!1,V.name==="AXIS"?(V.position.copy(this.worldPositionStart),V.visible=!!this.axis,this.axis==="X"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,0)),V.quaternion.copy(D).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(D).dot(this.eye))>.9&&(V.visible=!1)),this.axis==="Y"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,Math.PI/2)),V.quaternion.copy(D).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(D).dot(this.eye))>.9&&(V.visible=!1)),this.axis==="Z"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),V.quaternion.copy(D).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(D).dot(this.eye))>.9&&(V.visible=!1)),this.axis==="XYZE"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),this.alignVector.copy(this.rotationAxis),V.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.zeroVector,this.alignVector,this.unitY)),V.quaternion.multiply(this.tempQuaternion),V.visible=this.dragging),this.axis==="E"&&(V.visible=!1)):V.name==="START"?(V.position.copy(this.worldPositionStart),V.visible=this.dragging):V.name==="END"?(V.position.copy(this.worldPosition),V.visible=this.dragging):V.name==="DELTA"?(V.position.copy(this.worldPositionStart),V.quaternion.copy(this.worldQuaternionStart),this.tempVector.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),this.tempVector.applyQuaternion(this.worldQuaternionStart.clone().invert()),V.scale.copy(this.tempVector),V.visible=this.dragging):(V.quaternion.copy(D),this.dragging?V.position.copy(this.worldPositionStart):V.position.copy(this.worldPosition),this.axis&&(V.visible=this.axis.search(V.name)!==-1));continue}V.quaternion.copy(D),this.mode==="translate"||this.mode==="scale"?((V.name==="X"||V.name==="XYZX")&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(D).dot(this.eye))>.99&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),(V.name==="Y"||V.name==="XYZY")&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(D).dot(this.eye))>.99&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),(V.name==="Z"||V.name==="XYZZ")&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(D).dot(this.eye))>.99&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name==="XY"&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(D).dot(this.eye))<.2&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name==="YZ"&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(D).dot(this.eye))<.2&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name==="XZ"&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(D).dot(this.eye))<.2&&(V.scale.set(1e-10,1e-10,1e-10),V.visible=!1),V.name.search("X")!==-1&&(this.alignVector.copy(this.unitX).applyQuaternion(D).dot(this.eye)<0?V.tag==="fwd"?V.visible=!1:V.scale.x*=-1:V.tag==="bwd"&&(V.visible=!1)),V.name.search("Y")!==-1&&(this.alignVector.copy(this.unitY).applyQuaternion(D).dot(this.eye)<0?V.tag==="fwd"?V.visible=!1:V.scale.y*=-1:V.tag==="bwd"&&(V.visible=!1)),V.name.search("Z")!==-1&&(this.alignVector.copy(this.unitZ).applyQuaternion(D).dot(this.eye)<0?V.tag==="fwd"?V.visible=!1:V.scale.z*=-1:V.tag==="bwd"&&(V.visible=!1))):this.mode==="rotate"&&(this.tempQuaternion2.copy(D),this.alignVector.copy(this.eye).applyQuaternion(this.tempQuaternion.copy(D).invert()),V.name.search("E")!==-1&&V.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.eye,this.zeroVector,this.unitY)),V.name==="X"&&(this.tempQuaternion.setFromAxisAngle(this.unitX,Math.atan2(-this.alignVector.y,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),V.quaternion.copy(this.tempQuaternion)),V.name==="Y"&&(this.tempQuaternion.setFromAxisAngle(this.unitY,Math.atan2(this.alignVector.x,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),V.quaternion.copy(this.tempQuaternion)),V.name==="Z"&&(this.tempQuaternion.setFromAxisAngle(this.unitZ,Math.atan2(this.alignVector.y,this.alignVector.x)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),V.quaternion.copy(this.tempQuaternion))),V.visible=V.visible&&(V.name.indexOf("X")===-1||this.showX),V.visible=V.visible&&(V.name.indexOf("Y")===-1||this.showY),V.visible=V.visible&&(V.name.indexOf("Z")===-1||this.showZ),V.visible=V.visible&&(V.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),V.material.tempOpacity=V.material.tempOpacity||V.material.opacity,V.material.tempColor=V.material.tempColor||V.material.color.clone(),V.material.color.copy(V.material.tempColor),V.material.opacity=V.material.tempOpacity,this.enabled?this.axis&&(V.name===this.axis?(V.material.opacity=1,V.material.color.lerp(new We(1,1,1),.5)):this.axis.split("").some(function(G){return V.name===G})?(V.material.opacity=1,V.material.color.lerp(new We(1,1,1),.5)):(V.material.opacity*=.25,V.material.color.lerp(new We(1,1,1),.5))):(V.material.opacity*=.5,V.material.color.lerp(new We(1,1,1),.5))}super.updateMatrixWorld()});const e=new Cs({depthTest:!1,depthWrite:!1,transparent:!0,side:bi,fog:!1,toneMapped:!1}),t=new ga({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),i=e.clone();i.opacity=.15;const n=e.clone();n.opacity=.33;const s=e.clone();s.color.set(16711680);const o=e.clone();o.color.set(65280);const a=e.clone();a.color.set(255);const l=e.clone();l.opacity=.25;const c=l.clone();c.color.set(16776960);const u=l.clone();u.color.set(65535);const h=l.clone();h.color.set(16711935),e.clone().color.set(16776960);const d=t.clone();d.color.set(16711680);const m=t.clone();m.color.set(65280);const A=t.clone();A.color.set(255);const p=t.clone();p.color.set(65535);const y=t.clone();y.color.set(16711935);const v=t.clone();v.color.set(16776960);const E=t.clone();E.color.set(7895160);const x=v.clone();x.opacity=.25;const I=new Wn(0,.05,.2,12,1,!1),C=new Br(.125,.125,.125),_=new Gi;_.setAttribute("position",new Yi([0,0,0,1,0,0],3));const S=(K,D)=>{const z=new Gi,$=[];for(let V=0;V<=64*D;++V)$.push(0,Math.cos(V/32*Math.PI)*K,Math.sin(V/32*Math.PI)*K);return z.setAttribute("position",new Yi($,3)),z},b=()=>{const K=new Gi;return K.setAttribute("position",new Yi([0,0,0,1,1,1],3)),K},T={X:[[new ze(I,s),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new ze(I,s),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new bt(_,d)]],Y:[[new ze(I,o),[0,1,0],null,null,"fwd"],[new ze(I,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new bt(_,m),null,[0,0,Math.PI/2]]],Z:[[new ze(I,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new ze(I,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new bt(_,A),null,[0,-Math.PI/2,0]]],XYZ:[[new ze(new jr(.1,0),l.clone()),[0,0,0],[0,0,0]]],XY:[[new ze(new ln(.295,.295),c.clone()),[.15,.15,0]],[new bt(_,v),[.18,.3,0],null,[.125,1,1]],[new bt(_,v),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new ze(new ln(.295,.295),u.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new bt(_,p),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new bt(_,p),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new ze(new ln(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new bt(_,y),[.18,0,.3],null,[.125,1,1]],[new bt(_,y),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},R={X:[[new ze(new Wn(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new ze(new Wn(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new ze(new Wn(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new ze(new jr(.2,0),i)]],XY:[[new ze(new ln(.4,.4),i),[.2,.2,0]]],YZ:[[new ze(new ln(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new ze(new ln(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},w={START:[[new ze(new jr(.01,2),n),null,null,null,"helper"]],END:[[new ze(new jr(.01,2),n),null,null,null,"helper"]],DELTA:[[new bt(b(),n),null,null,null,"helper"]],X:[[new bt(_,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new bt(_,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new bt(_,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},B={X:[[new bt(S(1,.5),d)],[new ze(new jr(.04,0),s),[0,0,.99],null,[1,3,1]]],Y:[[new bt(S(1,.5),m),null,[0,0,-Math.PI/2]],[new ze(new jr(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new bt(S(1,.5),A),null,[0,Math.PI/2,0]],[new ze(new jr(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new bt(S(1.25,1),x),null,[0,Math.PI/2,0]],[new ze(new Wn(.03,0,.15,4,1,!1),x),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new ze(new Wn(.03,0,.15,4,1,!1),x),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new ze(new Wn(.03,0,.15,4,1,!1),x),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new ze(new Wn(.03,0,.15,4,1,!1),x),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new bt(S(1,1),E),null,[0,Math.PI/2,0]]]},M={AXIS:[[new bt(_,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},O={X:[[new ze(new Gc(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new ze(new Gc(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new ze(new Gc(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new ze(new Gc(1.25,.1,2,24),i)]],XYZE:[[new ze(new lE(.7,10,8),i)]]},U={X:[[new ze(C,s),[.8,0,0],[0,0,-Math.PI/2]],[new bt(_,d),null,null,[.8,1,1]]],Y:[[new ze(C,o),[0,.8,0]],[new bt(_,m),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new ze(C,a),[0,0,.8],[Math.PI/2,0,0]],[new bt(_,A),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new ze(C,c),[.85,.85,0],null,[2,2,.2]],[new bt(_,v),[.855,.98,0],null,[.125,1,1]],[new bt(_,v),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new ze(C,u),[0,.85,.85],null,[.2,2,2]],[new bt(_,p),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new bt(_,p),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new ze(C,h),[.85,0,.85],null,[2,.2,2]],[new bt(_,y),[.855,0,.98],null,[.125,1,1]],[new bt(_,y),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new ze(new Br(.125,.125,.125),l.clone()),[1.1,0,0]]],XYZY:[[new ze(new Br(.125,.125,.125),l.clone()),[0,1.1,0]]],XYZZ:[[new ze(new Br(.125,.125,.125),l.clone()),[0,0,1.1]]]},Y={X:[[new ze(new Wn(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new ze(new Wn(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new ze(new Wn(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new ze(C,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new ze(C,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new ze(C,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new ze(new Br(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new ze(new Br(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new ze(new Br(.2,.2,.2),i),[0,0,1.1]]]},W={X:[[new bt(_,n.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new bt(_,n.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new bt(_,n.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},N=K=>{const D=new gi;for(let z in K)for(let $=K[z].length;$--;){const V=K[z][$][0].clone(),P=K[z][$][1],G=K[z][$][2],F=K[z][$][3],k=K[z][$][4];V.name=z,V.tag=k,P&&V.position.set(P[0],P[1],P[2]),G&&V.rotation.set(G[0],G[1],G[2]),F&&V.scale.set(F[0],F[1],F[2]),V.updateMatrix();const Z=V.geometry.clone();Z.applyMatrix4(V.matrix),V.geometry=Z,V.renderOrder=1/0,V.position.set(0,0,0),V.rotation.set(0,0,0),V.scale.set(1,1,1),D.add(V)}return D};this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=N(T)),this.add(this.gizmo.rotate=N(B)),this.add(this.gizmo.scale=N(U)),this.add(this.picker.translate=N(R)),this.add(this.picker.rotate=N(O)),this.add(this.picker.scale=N(Y)),this.add(this.helper.translate=N(w)),this.add(this.helper.rotate=N(M)),this.add(this.helper.scale=N(W)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}}class s6 extends ze{constructor(){super(new ln(1e5,1e5,2,2),new Cs({visible:!1,wireframe:!0,side:bi,transparent:!0,opacity:.1,toneMapped:!1})),Ce(this,"isTransformControlsPlane",!0),Ce(this,"type","TransformControlsPlane"),Ce(this,"unitX",new Q(1,0,0)),Ce(this,"unitY",new Q(0,1,0)),Ce(this,"unitZ",new Q(0,0,1)),Ce(this,"tempVector",new Q),Ce(this,"dirVector",new Q),Ce(this,"alignVector",new Q),Ce(this,"tempMatrix",new we),Ce(this,"identityQuaternion",new st),Ce(this,"cameraQuaternion",new st),Ce(this,"worldPosition",new Q),Ce(this,"worldQuaternion",new st),Ce(this,"eye",new Q),Ce(this,"axis",null),Ce(this,"mode","translate"),Ce(this,"space","world"),Ce(this,"updateMatrixWorld",()=>{let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),this.unitX.set(1,0,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitY.set(0,1,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitZ.set(0,0,1).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.alignVector.copy(this.unitY),this.mode){case"translate":case"scale":switch(this.axis){case"X":this.alignVector.copy(this.eye).cross(this.unitX),this.dirVector.copy(this.unitX).cross(this.alignVector);break;case"Y":this.alignVector.copy(this.eye).cross(this.unitY),this.dirVector.copy(this.unitY).cross(this.alignVector);break;case"Z":this.alignVector.copy(this.eye).cross(this.unitZ),this.dirVector.copy(this.unitZ).cross(this.alignVector);break;case"XY":this.dirVector.copy(this.unitZ);break;case"YZ":this.dirVector.copy(this.unitX);break;case"XZ":this.alignVector.copy(this.unitZ),this.dirVector.copy(this.unitY);break;case"XYZ":case"E":this.dirVector.set(0,0,0);break}break;case"rotate":default:this.dirVector.set(0,0,0)}this.dirVector.length()===0?this.quaternion.copy(this.cameraQuaternion):(this.tempMatrix.lookAt(this.tempVector.set(0,0,0),this.dirVector,this.alignVector),this.quaternion.setFromRotationMatrix(this.tempMatrix)),super.updateMatrixWorld()})}}var r6=Object.defineProperty,o6=(r,e,t)=>e in r?r6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Fi=(r,e,t)=>(o6(r,typeof e!="symbol"?e+"":e,t),t);const Ro=new kn(0,0,0,"YXZ"),Do=new Q,a6={type:"change"},l6={type:"lock"},c6={type:"unlock"},u1=.002,h1=Math.PI/2;let u6=class extends xo{constructor(e,t){super(),Fi(this,"camera"),Fi(this,"domElement"),Fi(this,"isLocked"),Fi(this,"minPolarAngle"),Fi(this,"maxPolarAngle"),Fi(this,"pointerSpeed"),Fi(this,"onMouseMove",i=>{!this.domElement||this.isLocked===!1||(Ro.setFromQuaternion(this.camera.quaternion),Ro.y-=i.movementX*u1*this.pointerSpeed,Ro.x-=i.movementY*u1*this.pointerSpeed,Ro.x=Math.max(h1-this.maxPolarAngle,Math.min(h1-this.minPolarAngle,Ro.x)),this.camera.quaternion.setFromEuler(Ro),this.dispatchEvent(a6))}),Fi(this,"onPointerlockChange",()=>{this.domElement&&(this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(l6),this.isLocked=!0):(this.dispatchEvent(c6),this.isLocked=!1))}),Fi(this,"onPointerlockError",()=>{console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}),Fi(this,"connect",i=>{this.domElement=i||this.domElement,this.domElement&&(this.domElement.ownerDocument.addEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this.onPointerlockError))}),Fi(this,"disconnect",()=>{this.domElement&&(this.domElement.ownerDocument.removeEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this.onPointerlockError))}),Fi(this,"dispose",()=>{this.disconnect()}),Fi(this,"getObject",()=>this.camera),Fi(this,"direction",new Q(0,0,-1)),Fi(this,"getDirection",i=>i.copy(this.direction).applyQuaternion(this.camera.quaternion)),Fi(this,"moveForward",i=>{Do.setFromMatrixColumn(this.camera.matrix,0),Do.crossVectors(this.camera.up,Do),this.camera.position.addScaledVector(Do,i)}),Fi(this,"moveRight",i=>{Do.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(Do,i)}),Fi(this,"lock",()=>{this.domElement&&this.domElement.requestPointerLock()}),Fi(this,"unlock",()=>{this.domElement&&this.domElement.ownerDocument.exitPointerLock()}),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,t&&this.connect(t)}};var h6=Object.defineProperty,f6=(r,e,t)=>e in r?h6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ki=(r,e,t)=>(f6(r,typeof e!="symbol"?e+"":e,t),t);let d6=class extends xo{constructor(e){super(),ki(this,"object"),ki(this,"changeEvent",{type:"change"}),ki(this,"EPS",1e-6),ki(this,"enabled",!0),ki(this,"deviceOrientation",{alpha:0,beta:0,gamma:0}),ki(this,"screenOrientation",0),ki(this,"alphaOffset",0),ki(this,"onDeviceOrientationChangeEvent",t=>{this.deviceOrientation=t}),ki(this,"onScreenOrientationChangeEvent",()=>{this.screenOrientation=window.orientation||0}),ki(this,"zee",new Q(0,0,1)),ki(this,"euler",new kn),ki(this,"q0",new st),ki(this,"q1",new st(-Math.sqrt(.5),0,0,Math.sqrt(.5))),ki(this,"setObjectQuaternion",(t,i,n,s,o)=>{this.euler.set(n,i,-s,"YXZ"),t.setFromEuler(this.euler),t.multiply(this.q1),t.multiply(this.q0.setFromAxisAngle(this.zee,-o))}),ki(this,"connect",()=>{this.onScreenOrientationChangeEvent(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(t=>{t=="granted"&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent))}).catch(t=>{console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",t)}):(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent)),this.enabled=!0}),ki(this,"disconnect",()=>{window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this.enabled=!1}),ki(this,"lastQuaternion",new st),ki(this,"update",()=>{if(this.enabled===!1)return;const t=this.deviceOrientation;if(t){const i=t.alpha?tt.degToRad(t.alpha)+this.alphaOffset:0,n=t.beta?tt.degToRad(t.beta):0,s=t.gamma?tt.degToRad(t.gamma):0,o=this.screenOrientation?tt.degToRad(this.screenOrientation):0;this.setObjectQuaternion(this.object.quaternion,i,n,s,o),8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS&&(this.lastQuaternion.copy(this.object.quaternion),this.dispatchEvent(this.changeEvent))}}),ki(this,"dispose",()=>this.disconnect()),this.object=e,this.object.rotation.reorder("YXZ"),this.connect()}};var m6=Object.defineProperty,A6=(r,e,t)=>e in r?m6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Ue=(r,e,t)=>(A6(r,typeof e!="symbol"?e+"":e,t),t);let p6=class extends xo{constructor(e,t){super(),Ue(this,"enabled",!0),Ue(this,"screen",{left:0,top:0,width:0,height:0}),Ue(this,"rotateSpeed",1),Ue(this,"zoomSpeed",1.2),Ue(this,"panSpeed",.3),Ue(this,"noRotate",!1),Ue(this,"noZoom",!1),Ue(this,"noPan",!1),Ue(this,"staticMoving",!1),Ue(this,"dynamicDampingFactor",.2),Ue(this,"minDistance",0),Ue(this,"maxDistance",1/0),Ue(this,"keys",["KeyA","KeyS","KeyD"]),Ue(this,"mouseButtons",{LEFT:xs.ROTATE,MIDDLE:xs.DOLLY,RIGHT:xs.PAN}),Ue(this,"object"),Ue(this,"domElement"),Ue(this,"cursorZoom",!1),Ue(this,"target",new Q),Ue(this,"mousePosition",new De),Ue(this,"STATE",{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4}),Ue(this,"EPS",1e-6),Ue(this,"lastZoom",1),Ue(this,"lastPosition",new Q),Ue(this,"cursorVector",new Q),Ue(this,"targetVector",new Q),Ue(this,"_state",this.STATE.NONE),Ue(this,"_keyState",this.STATE.NONE),Ue(this,"_eye",new Q),Ue(this,"_movePrev",new De),Ue(this,"_moveCurr",new De),Ue(this,"_lastAxis",new Q),Ue(this,"_lastAngle",0),Ue(this,"_zoomStart",new De),Ue(this,"_zoomEnd",new De),Ue(this,"_touchZoomDistanceStart",0),Ue(this,"_touchZoomDistanceEnd",0),Ue(this,"_panStart",new De),Ue(this,"_panEnd",new De),Ue(this,"target0"),Ue(this,"position0"),Ue(this,"up0"),Ue(this,"zoom0"),Ue(this,"changeEvent",{type:"change"}),Ue(this,"startEvent",{type:"start"}),Ue(this,"endEvent",{type:"end"}),Ue(this,"onScreenVector",new De),Ue(this,"getMouseOnScreen",(i,n)=>(this.onScreenVector.set((i-this.screen.left)/this.screen.width,(n-this.screen.top)/this.screen.height),this.onScreenVector)),Ue(this,"onCircleVector",new De),Ue(this,"getMouseOnCircle",(i,n)=>(this.onCircleVector.set((i-this.screen.width*.5-this.screen.left)/(this.screen.width*.5),(this.screen.height+2*(this.screen.top-n))/this.screen.width),this.onCircleVector)),Ue(this,"axis",new Q),Ue(this,"quaternion",new st),Ue(this,"eyeDirection",new Q),Ue(this,"objectUpDirection",new Q),Ue(this,"objectSidewaysDirection",new Q),Ue(this,"moveDirection",new Q),Ue(this,"angle",0),Ue(this,"rotateCamera",()=>{this.moveDirection.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0),this.angle=this.moveDirection.length(),this.angle?(this._eye.copy(this.object.position).sub(this.target),this.eyeDirection.copy(this._eye).normalize(),this.objectUpDirection.copy(this.object.up).normalize(),this.objectSidewaysDirection.crossVectors(this.objectUpDirection,this.eyeDirection).normalize(),this.objectUpDirection.setLength(this._moveCurr.y-this._movePrev.y),this.objectSidewaysDirection.setLength(this._moveCurr.x-this._movePrev.x),this.moveDirection.copy(this.objectUpDirection.add(this.objectSidewaysDirection)),this.axis.crossVectors(this.moveDirection,this._eye).normalize(),this.angle*=this.rotateSpeed,this.quaternion.setFromAxisAngle(this.axis,this.angle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion),this._lastAxis.copy(this.axis),this._lastAngle=this.angle):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),this.quaternion.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion)),this._movePrev.copy(this._moveCurr)}),Ue(this,"zoomCamera",()=>{let i;if(this._state===this.STATE.TOUCH_ZOOM_PAN)i=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(i):this.object.isOrthographicCamera?(this.object.zoom/=i,this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type");else{if(i=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,Math.abs(i-1)>this.EPS&&i>0&&(this.object.isPerspectiveCamera?(i>1&&this._eye.length()>=this.maxDistance-this.EPS&&(i=1),this._eye.multiplyScalar(i)):this.object.isOrthographicCamera?(i>1&&this.object.zoom<this.maxDistance*this.maxDistance&&(i=1),this.object.zoom/=i):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor,this.cursorZoom){this.targetVector.copy(this.target).project(this.object);let n=this.cursorVector.set(this.mousePosition.x,this.mousePosition.y,this.targetVector.z).unproject(this.object);this.target.lerpVectors(n,this.target,i)}this.object.isOrthographicCamera&&this.object.updateProjectionMatrix()}}),Ue(this,"mouseChange",new De),Ue(this,"objectUp",new Q),Ue(this,"pan",new Q),Ue(this,"panCamera",()=>{if(this.domElement&&(this.mouseChange.copy(this._panEnd).sub(this._panStart),this.mouseChange.lengthSq()>this.EPS)){if(this.object.isOrthographicCamera){const i=this.object,n=(i.right-i.left)/this.object.zoom,s=(i.top-i.bottom)/this.object.zoom;this.mouseChange.x*=n,this.mouseChange.y*=s}else this.mouseChange.multiplyScalar(this._eye.length()*this.panSpeed);this.pan.copy(this._eye).cross(this.object.up).setLength(this.mouseChange.x),this.pan.add(this.objectUp.copy(this.object.up).setLength(this.mouseChange.y)),this.object.position.add(this.pan),this.target.add(this.pan),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(this.mouseChange.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}),Ue(this,"checkDistances",()=>{(!this.noZoom||!this.noPan)&&(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}),Ue(this,"handleResize",()=>{if(!this.domElement)return;const i=this.domElement.getBoundingClientRect(),n=this.domElement.ownerDocument.documentElement;this.screen.left=i.left+window.pageXOffset-n.clientLeft,this.screen.top=i.top+window.pageYOffset-n.clientTop,this.screen.width=i.width,this.screen.height=i.height}),Ue(this,"update",()=>{this._eye.subVectors(this.object.position,this.target),this.noRotate||this.rotateCamera(),this.noZoom||this.zoomCamera(),this.noPan||this.panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this.checkDistances(),this.object.lookAt(this.target),this.lastPosition.distanceToSquared(this.object.position)>this.EPS&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||this.lastZoom!==this.object.zoom)&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")}),Ue(this,"reset",()=>{this._state=this.STATE.NONE,this._keyState=this.STATE.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.up.copy(this.up0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom}),Ue(this,"keydown",i=>{this.enabled!==!1&&(window.removeEventListener("keydown",this.keydown),this._keyState===this.STATE.NONE&&(i.code===this.keys[this.STATE.ROTATE]&&!this.noRotate?this._keyState=this.STATE.ROTATE:i.code===this.keys[this.STATE.ZOOM]&&!this.noZoom?this._keyState=this.STATE.ZOOM:i.code===this.keys[this.STATE.PAN]&&!this.noPan&&(this._keyState=this.STATE.PAN)))}),Ue(this,"onPointerDown",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseDown(i);break}}),Ue(this,"onPointerMove",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseMove(i);break}}),Ue(this,"onPointerUp",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseUp();break}}),Ue(this,"keyup",()=>{this.enabled!==!1&&(this._keyState=this.STATE.NONE,window.addEventListener("keydown",this.keydown))}),Ue(this,"onMouseDown",i=>{if(!this.domElement)return;if(this._state===this.STATE.NONE)switch(i.button){case this.mouseButtons.LEFT:this._state=this.STATE.ROTATE;break;case this.mouseButtons.MIDDLE:this._state=this.STATE.ZOOM;break;case this.mouseButtons.RIGHT:this._state=this.STATE.PAN;break}const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY)),this._movePrev.copy(this._moveCurr)):n===this.STATE.ZOOM&&!this.noZoom?(this._zoomStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._zoomEnd.copy(this._zoomStart)):n===this.STATE.PAN&&!this.noPan&&(this._panStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._panEnd.copy(this._panStart)),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.startEvent)}),Ue(this,"onMouseMove",i=>{if(this.enabled===!1)return;const n=this._keyState!==this.STATE.NONE?this._keyState:this._state;n===this.STATE.ROTATE&&!this.noRotate?(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY))):n===this.STATE.ZOOM&&!this.noZoom?this._zoomEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY)):n===this.STATE.PAN&&!this.noPan&&this._panEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY))}),Ue(this,"onMouseUp",()=>{this.domElement&&this.enabled!==!1&&(this._state=this.STATE.NONE,this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.endEvent))}),Ue(this,"mousewheel",i=>{if(this.enabled!==!1&&this.noZoom!==!0){switch(i.preventDefault(),i.deltaMode){case 2:this._zoomStart.y-=i.deltaY*.025;break;case 1:this._zoomStart.y-=i.deltaY*.01;break;default:this._zoomStart.y-=i.deltaY*25e-5;break}this.mousePosition.x=i.offsetX/this.screen.width*2-1,this.mousePosition.y=-(i.offsetY/this.screen.height)*2+1,this.dispatchEvent(this.startEvent),this.dispatchEvent(this.endEvent)}}),Ue(this,"touchstart",i=>{if(this.enabled!==!1){switch(i.preventDefault(),i.touches.length){case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break;default:this._state=this.STATE.TOUCH_ZOOM_PAN;const n=i.touches[0].pageX-i.touches[1].pageX,s=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(n*n+s*s);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panStart.copy(this.getMouseOnScreen(o,a)),this._panEnd.copy(this._panStart);break}this.dispatchEvent(this.startEvent)}}),Ue(this,"touchmove",i=>{if(this.enabled!==!1)switch(i.preventDefault(),i.touches.length){case 1:this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY));break;default:const n=i.touches[0].pageX-i.touches[1].pageX,s=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=Math.sqrt(n*n+s*s);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panEnd.copy(this.getMouseOnScreen(o,a));break}}),Ue(this,"touchend",i=>{if(this.enabled!==!1){switch(i.touches.length){case 0:this._state=this.STATE.NONE;break;case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break}this.dispatchEvent(this.endEvent)}}),Ue(this,"contextmenu",i=>{this.enabled!==!1&&i.preventDefault()}),Ue(this,"connect",i=>{i===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=i,this.domElement.addEventListener("contextmenu",this.contextmenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("wheel",this.mousewheel),this.domElement.addEventListener("touchstart",this.touchstart),this.domElement.addEventListener("touchend",this.touchend),this.domElement.addEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup),this.handleResize()}),Ue(this,"dispose",()=>{this.domElement&&(this.domElement.removeEventListener("contextmenu",this.contextmenu),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("wheel",this.mousewheel),this.domElement.removeEventListener("touchstart",this.touchstart),this.domElement.removeEventListener("touchend",this.touchend),this.domElement.removeEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup))}),this.object=e,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,t!==void 0&&this.connect(t),this.update()}};var g6=Object.defineProperty,y6=(r,e,t)=>e in r?g6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ot=(r,e,t)=>(y6(r,typeof e!="symbol"?e+"":e,t),t);const jc=new Ua,f1=new Xs,v6=Math.cos(70*(Math.PI/180)),d1=(r,e)=>(r%e+e)%e;let G3=class extends xo{constructor(e,t){super(),ot(this,"object"),ot(this,"domElement"),ot(this,"enabled",!0),ot(this,"target",new Q),ot(this,"minDistance",0),ot(this,"maxDistance",1/0),ot(this,"minZoom",0),ot(this,"maxZoom",1/0),ot(this,"minPolarAngle",0),ot(this,"maxPolarAngle",Math.PI),ot(this,"minAzimuthAngle",-1/0),ot(this,"maxAzimuthAngle",1/0),ot(this,"enableDamping",!1),ot(this,"dampingFactor",.05),ot(this,"enableZoom",!0),ot(this,"zoomSpeed",1),ot(this,"enableRotate",!0),ot(this,"rotateSpeed",1),ot(this,"enablePan",!0),ot(this,"panSpeed",1),ot(this,"screenSpacePanning",!0),ot(this,"keyPanSpeed",7),ot(this,"zoomToCursor",!1),ot(this,"autoRotate",!1),ot(this,"autoRotateSpeed",2),ot(this,"reverseOrbit",!1),ot(this,"reverseHorizontalOrbit",!1),ot(this,"reverseVerticalOrbit",!1),ot(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),ot(this,"mouseButtons",{LEFT:xs.ROTATE,MIDDLE:xs.DOLLY,RIGHT:xs.PAN}),ot(this,"touches",{ONE:Mr.ROTATE,TWO:Mr.DOLLY_PAN}),ot(this,"target0"),ot(this,"position0"),ot(this,"zoom0"),ot(this,"_domElementKeyEvents",null),ot(this,"getPolarAngle"),ot(this,"getAzimuthalAngle"),ot(this,"setPolarAngle"),ot(this,"setAzimuthalAngle"),ot(this,"getDistance"),ot(this,"getZoomScale"),ot(this,"listenToKeyEvents"),ot(this,"stopListenToKeyEvents"),ot(this,"saveState"),ot(this,"reset"),ot(this,"update"),ot(this,"connect"),ot(this,"dispose"),ot(this,"dollyIn"),ot(this,"dollyOut"),ot(this,"getScale"),ot(this,"setScale"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>u.phi,this.getAzimuthalAngle=()=>u.theta,this.setPolarAngle=ie=>{let be=d1(ie,2*Math.PI),Le=u.phi;Le<0&&(Le+=2*Math.PI),be<0&&(be+=2*Math.PI);let Ye=Math.abs(be-Le);2*Math.PI-Ye<Ye&&(be<Le?be+=2*Math.PI:Le+=2*Math.PI),h.phi=be-Le,i.update()},this.setAzimuthalAngle=ie=>{let be=d1(ie,2*Math.PI),Le=u.theta;Le<0&&(Le+=2*Math.PI),be<0&&(be+=2*Math.PI);let Ye=Math.abs(be-Le);2*Math.PI-Ye<Ye&&(be<Le?be+=2*Math.PI:Le+=2*Math.PI),h.theta=be-Le,i.update()},this.getDistance=()=>i.object.position.distanceTo(i.target),this.listenToKeyEvents=ie=>{ie.addEventListener("keydown",Ge),this._domElementKeyEvents=ie},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",Ge),this._domElementKeyEvents=null},this.saveState=()=>{i.target0.copy(i.target),i.position0.copy(i.object.position),i.zoom0=i.object.zoom},this.reset=()=>{i.target.copy(i.target0),i.object.position.copy(i.position0),i.object.zoom=i.zoom0,i.object.updateProjectionMatrix(),i.dispatchEvent(n),i.update(),l=a.NONE},this.update=(()=>{const ie=new Q,be=new Q(0,1,0),Le=new st().setFromUnitVectors(e.up,be),Ye=Le.clone().invert(),pe=new Q,at=new st,ti=2*Math.PI;return function(){const yt=i.object.position;Le.setFromUnitVectors(e.up,be),Ye.copy(Le).invert(),ie.copy(yt).sub(i.target),ie.applyQuaternion(Le),u.setFromVector3(ie),i.autoRotate&&l===a.NONE&&M(w()),i.enableDamping?(u.theta+=h.theta*i.dampingFactor,u.phi+=h.phi*i.dampingFactor):(u.theta+=h.theta,u.phi+=h.phi);let wt=i.minAzimuthAngle,Tt=i.maxAzimuthAngle;isFinite(wt)&&isFinite(Tt)&&(wt<-Math.PI?wt+=ti:wt>Math.PI&&(wt-=ti),Tt<-Math.PI?Tt+=ti:Tt>Math.PI&&(Tt-=ti),wt<=Tt?u.theta=Math.max(wt,Math.min(Tt,u.theta)):u.theta=u.theta>(wt+Tt)/2?Math.max(wt,u.theta):Math.min(Tt,u.theta)),u.phi=Math.max(i.minPolarAngle,Math.min(i.maxPolarAngle,u.phi)),u.makeSafe(),i.enableDamping===!0?i.target.addScaledVector(d,i.dampingFactor):i.target.add(d),i.zoomToCursor&&b||i.object.isOrthographicCamera?u.radius=$(u.radius):u.radius=$(u.radius*f),ie.setFromSpherical(u),ie.applyQuaternion(Ye),yt.copy(i.target).add(ie),i.object.matrixAutoUpdate||i.object.updateMatrix(),i.object.lookAt(i.target),i.enableDamping===!0?(h.theta*=1-i.dampingFactor,h.phi*=1-i.dampingFactor,d.multiplyScalar(1-i.dampingFactor)):(h.set(0,0,0),d.set(0,0,0));let lt=!1;if(i.zoomToCursor&&b){let Bt=null;if(i.object instanceof jt&&i.object.isPerspectiveCamera){const fi=ie.length();Bt=$(fi*f);const di=fi-Bt;i.object.position.addScaledVector(_,di),i.object.updateMatrixWorld()}else if(i.object.isOrthographicCamera){const fi=new Q(S.x,S.y,0);fi.unproject(i.object),i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/f)),i.object.updateProjectionMatrix(),lt=!0;const di=new Q(S.x,S.y,0);di.unproject(i.object),i.object.position.sub(di).add(fi),i.object.updateMatrixWorld(),Bt=ie.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),i.zoomToCursor=!1;Bt!==null&&(i.screenSpacePanning?i.target.set(0,0,-1).transformDirection(i.object.matrix).multiplyScalar(Bt).add(i.object.position):(jc.origin.copy(i.object.position),jc.direction.set(0,0,-1).transformDirection(i.object.matrix),Math.abs(i.object.up.dot(jc.direction))<v6?e.lookAt(i.target):(f1.setFromNormalAndCoplanarPoint(i.object.up,i.target),jc.intersectPlane(f1,i.target))))}else i.object instanceof Ai&&i.object.isOrthographicCamera&&(lt=f!==1,lt&&(i.object.zoom=Math.max(i.minZoom,Math.min(i.maxZoom,i.object.zoom/f)),i.object.updateProjectionMatrix()));return f=1,b=!1,lt||pe.distanceToSquared(i.object.position)>c||8*(1-at.dot(i.object.quaternion))>c?(i.dispatchEvent(n),pe.copy(i.object.position),at.copy(i.object.quaternion),lt=!1,!0):!1}})(),this.connect=ie=>{i.domElement=ie,i.domElement.style.touchAction="none",i.domElement.addEventListener("contextmenu",rt),i.domElement.addEventListener("pointerdown",Ie),i.domElement.addEventListener("pointercancel",Be),i.domElement.addEventListener("wheel",Me)},this.dispose=()=>{var ie,be,Le,Ye,pe,at;i.domElement&&(i.domElement.style.touchAction="auto"),(ie=i.domElement)==null||ie.removeEventListener("contextmenu",rt),(be=i.domElement)==null||be.removeEventListener("pointerdown",Ie),(Le=i.domElement)==null||Le.removeEventListener("pointercancel",Be),(Ye=i.domElement)==null||Ye.removeEventListener("wheel",Me),(pe=i.domElement)==null||pe.ownerDocument.removeEventListener("pointermove",_e),(at=i.domElement)==null||at.ownerDocument.removeEventListener("pointerup",Be),i._domElementKeyEvents!==null&&i._domElementKeyEvents.removeEventListener("keydown",Ge)};const i=this,n={type:"change"},s={type:"start"},o={type:"end"},a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let l=a.NONE;const c=1e-6,u=new wa,h=new wa;let f=1;const d=new Q,m=new De,A=new De,p=new De,y=new De,v=new De,E=new De,x=new De,I=new De,C=new De,_=new Q,S=new De;let b=!1;const T=[],R={};function w(){return 2*Math.PI/60/60*i.autoRotateSpeed}function B(){return Math.pow(.95,i.zoomSpeed)}function M(ie){i.reverseOrbit||i.reverseHorizontalOrbit?h.theta+=ie:h.theta-=ie}function O(ie){i.reverseOrbit||i.reverseVerticalOrbit?h.phi+=ie:h.phi-=ie}const U=(()=>{const ie=new Q;return function(Le,Ye){ie.setFromMatrixColumn(Ye,0),ie.multiplyScalar(-Le),d.add(ie)}})(),Y=(()=>{const ie=new Q;return function(Le,Ye){i.screenSpacePanning===!0?ie.setFromMatrixColumn(Ye,1):(ie.setFromMatrixColumn(Ye,0),ie.crossVectors(i.object.up,ie)),ie.multiplyScalar(Le),d.add(ie)}})(),W=(()=>{const ie=new Q;return function(Le,Ye){const pe=i.domElement;if(pe&&i.object instanceof jt&&i.object.isPerspectiveCamera){const at=i.object.position;ie.copy(at).sub(i.target);let ti=ie.length();ti*=Math.tan(i.object.fov/2*Math.PI/180),U(2*Le*ti/pe.clientHeight,i.object.matrix),Y(2*Ye*ti/pe.clientHeight,i.object.matrix)}else pe&&i.object instanceof Ai&&i.object.isOrthographicCamera?(U(Le*(i.object.right-i.object.left)/i.object.zoom/pe.clientWidth,i.object.matrix),Y(Ye*(i.object.top-i.object.bottom)/i.object.zoom/pe.clientHeight,i.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),i.enablePan=!1)}})();function N(ie){i.object instanceof jt&&i.object.isPerspectiveCamera||i.object instanceof Ai&&i.object.isOrthographicCamera?f=ie:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),i.enableZoom=!1)}function K(ie){N(f/ie)}function D(ie){N(f*ie)}function z(ie){if(!i.zoomToCursor||!i.domElement)return;b=!0;const be=i.domElement.getBoundingClientRect(),Le=ie.clientX-be.left,Ye=ie.clientY-be.top,pe=be.width,at=be.height;S.x=Le/pe*2-1,S.y=-(Ye/at)*2+1,_.set(S.x,S.y,1).unproject(i.object).sub(i.object.position).normalize()}function $(ie){return Math.max(i.minDistance,Math.min(i.maxDistance,ie))}function V(ie){m.set(ie.clientX,ie.clientY)}function P(ie){z(ie),x.set(ie.clientX,ie.clientY)}function G(ie){y.set(ie.clientX,ie.clientY)}function F(ie){A.set(ie.clientX,ie.clientY),p.subVectors(A,m).multiplyScalar(i.rotateSpeed);const be=i.domElement;be&&(M(2*Math.PI*p.x/be.clientHeight),O(2*Math.PI*p.y/be.clientHeight)),m.copy(A),i.update()}function k(ie){I.set(ie.clientX,ie.clientY),C.subVectors(I,x),C.y>0?K(B()):C.y<0&&D(B()),x.copy(I),i.update()}function Z(ie){v.set(ie.clientX,ie.clientY),E.subVectors(v,y).multiplyScalar(i.panSpeed),W(E.x,E.y),y.copy(v),i.update()}function ne(ie){z(ie),ie.deltaY<0?D(B()):ie.deltaY>0&&K(B()),i.update()}function X(ie){let be=!1;switch(ie.code){case i.keys.UP:W(0,i.keyPanSpeed),be=!0;break;case i.keys.BOTTOM:W(0,-i.keyPanSpeed),be=!0;break;case i.keys.LEFT:W(i.keyPanSpeed,0),be=!0;break;case i.keys.RIGHT:W(-i.keyPanSpeed,0),be=!0;break}be&&(ie.preventDefault(),i.update())}function te(){if(T.length==1)m.set(T[0].pageX,T[0].pageY);else{const ie=.5*(T[0].pageX+T[1].pageX),be=.5*(T[0].pageY+T[1].pageY);m.set(ie,be)}}function ye(){if(T.length==1)y.set(T[0].pageX,T[0].pageY);else{const ie=.5*(T[0].pageX+T[1].pageX),be=.5*(T[0].pageY+T[1].pageY);y.set(ie,be)}}function ve(){const ie=T[0].pageX-T[1].pageX,be=T[0].pageY-T[1].pageY,Le=Math.sqrt(ie*ie+be*be);x.set(0,Le)}function re(){i.enableZoom&&ve(),i.enablePan&&ye()}function se(){i.enableZoom&&ve(),i.enableRotate&&te()}function he(ie){if(T.length==1)A.set(ie.pageX,ie.pageY);else{const Le=je(ie),Ye=.5*(ie.pageX+Le.x),pe=.5*(ie.pageY+Le.y);A.set(Ye,pe)}p.subVectors(A,m).multiplyScalar(i.rotateSpeed);const be=i.domElement;be&&(M(2*Math.PI*p.x/be.clientHeight),O(2*Math.PI*p.y/be.clientHeight)),m.copy(A)}function le(ie){if(T.length==1)v.set(ie.pageX,ie.pageY);else{const be=je(ie),Le=.5*(ie.pageX+be.x),Ye=.5*(ie.pageY+be.y);v.set(Le,Ye)}E.subVectors(v,y).multiplyScalar(i.panSpeed),W(E.x,E.y),y.copy(v)}function J(ie){const be=je(ie),Le=ie.pageX-be.x,Ye=ie.pageY-be.y,pe=Math.sqrt(Le*Le+Ye*Ye);I.set(0,pe),C.set(0,Math.pow(I.y/x.y,i.zoomSpeed)),K(C.y),x.copy(I)}function q(ie){i.enableZoom&&J(ie),i.enablePan&&le(ie)}function oe(ie){i.enableZoom&&J(ie),i.enableRotate&&he(ie)}function Ie(ie){var be,Le;i.enabled!==!1&&(T.length===0&&((be=i.domElement)==null||be.ownerDocument.addEventListener("pointermove",_e),(Le=i.domElement)==null||Le.ownerDocument.addEventListener("pointerup",Be)),gt(ie),ie.pointerType==="touch"?Qe(ie):Se(ie))}function _e(ie){i.enabled!==!1&&(ie.pointerType==="touch"?qe(ie):Ke(ie))}function Be(ie){var be,Le,Ye;nt(ie),T.length===0&&((be=i.domElement)==null||be.releasePointerCapture(ie.pointerId),(Le=i.domElement)==null||Le.ownerDocument.removeEventListener("pointermove",_e),(Ye=i.domElement)==null||Ye.ownerDocument.removeEventListener("pointerup",Be)),i.dispatchEvent(o),l=a.NONE}function Se(ie){let be;switch(ie.button){case 0:be=i.mouseButtons.LEFT;break;case 1:be=i.mouseButtons.MIDDLE;break;case 2:be=i.mouseButtons.RIGHT;break;default:be=-1}switch(be){case xs.DOLLY:if(i.enableZoom===!1)return;P(ie),l=a.DOLLY;break;case xs.ROTATE:if(ie.ctrlKey||ie.metaKey||ie.shiftKey){if(i.enablePan===!1)return;G(ie),l=a.PAN}else{if(i.enableRotate===!1)return;V(ie),l=a.ROTATE}break;case xs.PAN:if(ie.ctrlKey||ie.metaKey||ie.shiftKey){if(i.enableRotate===!1)return;V(ie),l=a.ROTATE}else{if(i.enablePan===!1)return;G(ie),l=a.PAN}break;default:l=a.NONE}l!==a.NONE&&i.dispatchEvent(s)}function Ke(ie){if(i.enabled!==!1)switch(l){case a.ROTATE:if(i.enableRotate===!1)return;F(ie);break;case a.DOLLY:if(i.enableZoom===!1)return;k(ie);break;case a.PAN:if(i.enablePan===!1)return;Z(ie);break}}function Me(ie){i.enabled===!1||i.enableZoom===!1||l!==a.NONE&&l!==a.ROTATE||(ie.preventDefault(),i.dispatchEvent(s),ne(ie),i.dispatchEvent(o))}function Ge(ie){i.enabled===!1||i.enablePan===!1||X(ie)}function Qe(ie){switch(Xe(ie),T.length){case 1:switch(i.touches.ONE){case Mr.ROTATE:if(i.enableRotate===!1)return;te(),l=a.TOUCH_ROTATE;break;case Mr.PAN:if(i.enablePan===!1)return;ye(),l=a.TOUCH_PAN;break;default:l=a.NONE}break;case 2:switch(i.touches.TWO){case Mr.DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;re(),l=a.TOUCH_DOLLY_PAN;break;case Mr.DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;se(),l=a.TOUCH_DOLLY_ROTATE;break;default:l=a.NONE}break;default:l=a.NONE}l!==a.NONE&&i.dispatchEvent(s)}function qe(ie){switch(Xe(ie),l){case a.TOUCH_ROTATE:if(i.enableRotate===!1)return;he(ie),i.update();break;case a.TOUCH_PAN:if(i.enablePan===!1)return;le(ie),i.update();break;case a.TOUCH_DOLLY_PAN:if(i.enableZoom===!1&&i.enablePan===!1)return;q(ie),i.update();break;case a.TOUCH_DOLLY_ROTATE:if(i.enableZoom===!1&&i.enableRotate===!1)return;oe(ie),i.update();break;default:l=a.NONE}}function rt(ie){i.enabled!==!1&&ie.preventDefault()}function gt(ie){T.push(ie)}function nt(ie){delete R[ie.pointerId];for(let be=0;be<T.length;be++)if(T[be].pointerId==ie.pointerId){T.splice(be,1);return}}function Xe(ie){let be=R[ie.pointerId];be===void 0&&(be=new De,R[ie.pointerId]=be),be.set(ie.pageX,ie.pageY)}function je(ie){const be=ie.pointerId===T[0].pointerId?T[1]:T[0];return R[be.pointerId]}this.dollyIn=(ie=B())=>{D(ie),i.update()},this.dollyOut=(ie=B())=>{K(ie),i.update()},this.getScale=()=>f,this.setScale=ie=>{N(ie),i.update()},this.getZoomScale=()=>B(),t!==void 0&&this.connect(t),this.update()}},E6=class extends G3{constructor(e,t){super(e,t),this.screenSpacePanning=!1,this.mouseButtons.LEFT=xs.PAN,this.mouseButtons.RIGHT=xs.ROTATE,this.touches.ONE=Mr.PAN,this.touches.TWO=Mr.DOLLY_ROTATE}};var x6=Object.defineProperty,I6=(r,e,t)=>e in r?x6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,fe=(r,e,t)=>(I6(r,typeof e!="symbol"?e+"":e,t),t);const it={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},zt={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},pt={x:0,y:0},Mn={camera:new we,gizmos:new we},ii={type:"change"},As={type:"start"},Kn={type:"end"};let C6=class extends xo{constructor(e,t=null,i=null){super(),fe(this,"camera"),fe(this,"domElement"),fe(this,"scene"),fe(this,"mouseActions"),fe(this,"_mouseOp"),fe(this,"_v2_1"),fe(this,"_v3_1"),fe(this,"_v3_2"),fe(this,"_m4_1"),fe(this,"_m4_2"),fe(this,"_quat"),fe(this,"_translationMatrix"),fe(this,"_rotationMatrix"),fe(this,"_scaleMatrix"),fe(this,"_rotationAxis"),fe(this,"_cameraMatrixState"),fe(this,"_cameraProjectionState"),fe(this,"_fovState"),fe(this,"_upState"),fe(this,"_zoomState"),fe(this,"_nearPos"),fe(this,"_farPos"),fe(this,"_gizmoMatrixState"),fe(this,"_up0"),fe(this,"_zoom0"),fe(this,"_fov0"),fe(this,"_initialNear"),fe(this,"_nearPos0"),fe(this,"_initialFar"),fe(this,"_farPos0"),fe(this,"_cameraMatrixState0"),fe(this,"_gizmoMatrixState0"),fe(this,"_button"),fe(this,"_touchStart"),fe(this,"_touchCurrent"),fe(this,"_input"),fe(this,"_switchSensibility"),fe(this,"_startFingerDistance"),fe(this,"_currentFingerDistance"),fe(this,"_startFingerRotation"),fe(this,"_currentFingerRotation"),fe(this,"_devPxRatio"),fe(this,"_downValid"),fe(this,"_nclicks"),fe(this,"_downEvents"),fe(this,"_clickStart"),fe(this,"_maxDownTime"),fe(this,"_maxInterval"),fe(this,"_posThreshold"),fe(this,"_movementThreshold"),fe(this,"_currentCursorPosition"),fe(this,"_startCursorPosition"),fe(this,"_grid"),fe(this,"_gridPosition"),fe(this,"_gizmos"),fe(this,"_curvePts"),fe(this,"_timeStart"),fe(this,"_animationId"),fe(this,"focusAnimationTime"),fe(this,"_timePrev"),fe(this,"_timeCurrent"),fe(this,"_anglePrev"),fe(this,"_angleCurrent"),fe(this,"_cursorPosPrev"),fe(this,"_cursorPosCurr"),fe(this,"_wPrev"),fe(this,"_wCurr"),fe(this,"adjustNearFar"),fe(this,"scaleFactor"),fe(this,"dampingFactor"),fe(this,"wMax"),fe(this,"enableAnimations"),fe(this,"enableGrid"),fe(this,"cursorZoom"),fe(this,"minFov"),fe(this,"maxFov"),fe(this,"enabled"),fe(this,"enablePan"),fe(this,"enableRotate"),fe(this,"enableZoom"),fe(this,"minDistance"),fe(this,"maxDistance"),fe(this,"minZoom"),fe(this,"maxZoom"),fe(this,"target"),fe(this,"_currentTarget"),fe(this,"_tbRadius"),fe(this,"_state"),fe(this,"onWindowResize",()=>{const n=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3;if(this.camera){const c=this.calculateTbRadius(this.camera);c!==void 0&&(this._tbRadius=c)}const s=this._tbRadius/n,a=new Of(0,0,s,s).getPoints(this._curvePts),l=new Gi().setFromPoints(a);for(const c in this._gizmos.children){const u=this._gizmos.children[c];u.geometry=l}this.dispatchEvent(ii)}),fe(this,"onContextMenu",n=>{if(this.enabled){for(let s=0;s<this.mouseActions.length;s++)if(this.mouseActions[s].mouse==2){n.preventDefault();break}}}),fe(this,"onPointerCancel",()=>{this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=zt.NONE}),fe(this,"onPointerDown",n=>{if(n.button==0&&n.isPrimary?(this._downValid=!0,this._downEvents.push(n)):this._downValid=!1,n.pointerType=="touch"&&this._input!=zt.CURSOR)switch(this._touchStart.push(n),this._touchCurrent.push(n),this._input){case zt.NONE:this._input=zt.ONE_FINGER,this.onSinglePanStart(n,"ROTATE"),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp);break;case zt.ONE_FINGER:case zt.ONE_FINGER_SWITCHED:this._input=zt.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case zt.TWO_FINGER:this._input=zt.MULT_FINGER,this.onTriplePanStart();break}else if(n.pointerType!="touch"&&this._input==zt.NONE){let s=null;n.ctrlKey||n.metaKey?s="CTRL":n.shiftKey&&(s="SHIFT"),this._mouseOp=this.getOpFromAction(n.button,s),this._mouseOp&&(window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this._input=zt.CURSOR,this._button=n.button,this.onSinglePanStart(n,this._mouseOp))}}),fe(this,"onPointerMove",n=>{if(n.pointerType=="touch"&&this._input!=zt.CURSOR)switch(this._input){case zt.ONE_FINGER:this.updateTouchEvent(n),this.onSinglePanMove(n,it.ROTATE);break;case zt.ONE_FINGER_SWITCHED:if(this.calculatePointersDistance(this._touchCurrent[0],n)*this._devPxRatio>=this._switchSensibility){this._input=zt.ONE_FINGER,this.updateTouchEvent(n),this.onSinglePanStart(n,"ROTATE");break}break;case zt.TWO_FINGER:this.updateTouchEvent(n),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case zt.MULT_FINGER:this.updateTouchEvent(n),this.onTriplePanMove();break}else if(n.pointerType!="touch"&&this._input==zt.CURSOR){let s=null;n.ctrlKey||n.metaKey?s="CTRL":n.shiftKey&&(s="SHIFT");const o=this.getOpStateFromAction(this._button,s);o&&this.onSinglePanMove(n,o)}this._downValid&&this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],n)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)}),fe(this,"onPointerUp",n=>{if(n.pointerType=="touch"&&this._input!=zt.CURSOR){const s=this._touchCurrent.length;for(let o=0;o<s;o++)if(this._touchCurrent[o].pointerId==n.pointerId){this._touchCurrent.splice(o,1),this._touchStart.splice(o,1);break}switch(this._input){case zt.ONE_FINGER:case zt.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=zt.NONE,this.onSinglePanEnd();break;case zt.TWO_FINGER:this.onDoublePanEnd(),this.onPinchEnd(),this.onRotateEnd(),this._input=zt.ONE_FINGER_SWITCHED;break;case zt.MULT_FINGER:this._touchCurrent.length==0&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=zt.NONE,this.onTriplePanEnd());break}}else n.pointerType!="touch"&&this._input==zt.CURSOR&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=zt.NONE,this.onSinglePanEnd(),this._button=-1);if(n.isPrimary)if(this._downValid)if(n.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime)if(this._nclicks==0)this._nclicks=1,this._clickStart=performance.now();else{const o=n.timeStamp-this._clickStart,a=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio;o<=this._maxInterval&&a<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(n)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())}else this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length);else this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)}),fe(this,"onWheel",n=>{var s,o;if(this.enabled&&this.enableZoom&&this.domElement){let a=null;n.ctrlKey||n.metaKey?a="CTRL":n.shiftKey&&(a="SHIFT");const l=this.getOpFromAction("WHEEL",a);if(l){n.preventDefault(),this.dispatchEvent(As);const c=125;let u=n.deltaY/c,h=1;switch(u>0?h=1/this.scaleFactor:u<0&&(h=this.scaleFactor),l){case"ZOOM":if(this.updateTbState(it.SCALE,!0),u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u)),this.cursorZoom&&this.enablePan){let f;this.camera instanceof Ai&&(f=(s=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position)),this.camera instanceof jt&&(f=(o=this.unprojectOnTbPlane(this.camera,n.clientX,n.clientY,this.domElement))==null?void 0:o.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),f!==void 0&&this.applyTransformMatrix(this.applyScale(h,f))}else this.applyTransformMatrix(this.applyScale(h,this._gizmos.position));this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(it.IDLE,!1),this.dispatchEvent(ii),this.dispatchEvent(Kn);break;case"FOV":if(this.camera instanceof jt){this.updateTbState(it.FOV,!0),n.deltaX!=0&&(u=n.deltaX/c,h=1,u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const f=this._v3_1.distanceTo(this._gizmos.position);let d=f/h;d=tt.clamp(d,this.minDistance,this.maxDistance);const m=f*Math.tan(tt.DEG2RAD*this.camera.fov*.5);let A=tt.RAD2DEG*(Math.atan(m/d)*2);A>this.maxFov?A=this.maxFov:A<this.minFov&&(A=this.minFov);const p=m/Math.tan(tt.DEG2RAD*(A/2));h=f/p,this.setFov(A),this.applyTransformMatrix(this.applyScale(h,this._gizmos.position,!1))}this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(it.IDLE,!1),this.dispatchEvent(ii),this.dispatchEvent(Kn);break}}}}),fe(this,"onSinglePanStart",(n,s)=>{if(this.enabled&&this.domElement)switch(this.dispatchEvent(As),this.setCenter(n.clientX,n.clientY),s){case"PAN":if(!this.enablePan)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(ii)),this.camera){this.updateTbState(it.PAN,!0);const o=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement);o!==void 0&&this._startCursorPosition.copy(o),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(ii))}break;case"ROTATE":if(!this.enableRotate)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.camera){this.updateTbState(it.ROTATE,!0);const o=this.unprojectOnTbSurface(this.camera,pt.x,pt.y,this.domElement,this._tbRadius);o!==void 0&&this._startCursorPosition.copy(o),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr)}this.dispatchEvent(ii);break;case"FOV":if(!this.enableZoom)return;this.camera instanceof jt&&(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(ii)),this.updateTbState(it.FOV,!0),this._startCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition));break;case"ZOOM":if(!this.enableZoom)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(ii)),this.updateTbState(it.SCALE,!0),this._startCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition);break}}),fe(this,"onSinglePanMove",(n,s)=>{if(this.enabled&&this.domElement){const o=s!=this._state;switch(this.setCenter(n.clientX,n.clientY),s){case it.PAN:if(this.enablePan&&this.camera)if(o){this.dispatchEvent(Kn),this.dispatchEvent(As),this.updateTbState(s,!0);const a=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)}else{const a=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement);a!==void 0&&this._currentCursorPosition.copy(a),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))}break;case it.ROTATE:if(this.enableRotate&&this.camera)if(o){this.dispatchEvent(Kn),this.dispatchEvent(As),this.updateTbState(s,!0);const a=this.unprojectOnTbSurface(this.camera,pt.x,pt.y,this.domElement,this._tbRadius);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0)}else{const a=this.unprojectOnTbSurface(this.camera,pt.x,pt.y,this.domElement,this._tbRadius);a!==void 0&&this._currentCursorPosition.copy(a);const l=this._startCursorPosition.distanceTo(this._currentCursorPosition),c=this._startCursorPosition.angleTo(this._currentCursorPosition),u=Math.max(l/this._tbRadius,c);this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),u)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=u,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))}break;case it.SCALE:if(this.enableZoom)if(o)this.dispatchEvent(Kn),this.dispatchEvent(As),this.updateTbState(s,!0),this._startCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*8):l>0&&(c=Math.pow(this.scaleFactor,l*8)),this.applyTransformMatrix(this.applyScale(c,this._gizmos.position))}break;case it.FOV:if(this.enableZoom&&this.camera instanceof jt)if(o)this.dispatchEvent(Kn),this.dispatchEvent(As),this.updateTbState(s,!0),this._startCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*8):l>0&&(c=Math.pow(this.scaleFactor,l*8)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/c;h=tt.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(tt.DEG2RAD*this._fovState*.5);let d=tt.RAD2DEG*(Math.atan(f/h)*2);d=tt.clamp(d,this.minFov,this.maxFov);const m=f/Math.tan(tt.DEG2RAD*(d/2));c=u/m,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(c,this._v3_2,!1));const A=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(m/u);this._m4_1.makeTranslation(A.x,A.y,A.z)}break}this.dispatchEvent(ii)}}),fe(this,"onSinglePanEnd",()=>{if(this._state==it.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations)if(performance.now()-this._timeCurrent<120){const s=Math.abs((this._wPrev+this._wCurr)/2),o=this;this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(it.ANIMATION_ROTATE,!0);const l=o.calculateRotationAxis(o._cursorPosPrev,o._cursorPosCurr);o.onRotationAnim(a,l,Math.min(s,o.wMax))})}else this.updateTbState(it.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ii);else this.updateTbState(it.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ii)}else(this._state==it.PAN||this._state==it.IDLE)&&(this.updateTbState(it.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(ii));this.dispatchEvent(Kn)}),fe(this,"onDoubleTap",n=>{if(this.enabled&&this.enablePan&&this.scene&&this.camera&&this.domElement){this.dispatchEvent(As),this.setCenter(n.clientX,n.clientY);const s=this.unprojectOnObj(this.getCursorNDC(pt.x,pt.y,this.domElement),this.camera);if(s&&this.enableAnimations){const o=this;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(it.ANIMATION_FOCUS,!0),o.onFocusAnim(a,s,o._cameraMatrixState,o._gizmoMatrixState)})}else s&&!this.enableAnimations&&(this.updateTbState(it.FOCUS,!0),this.focus(s,this.scaleFactor),this.updateTbState(it.IDLE,!1),this.dispatchEvent(ii))}this.dispatchEvent(Kn)}),fe(this,"onDoublePanStart",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.dispatchEvent(As),this.updateTbState(it.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const n=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement,!0);n!==void 0&&this._startCursorPosition.copy(n),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1)}}),fe(this,"onDoublePanMove",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=it.PAN&&(this.updateTbState(it.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition));const n=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement,!0);n!==void 0&&this._currentCursorPosition.copy(n),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(ii)}}),fe(this,"onDoublePanEnd",()=>{this.updateTbState(it.IDLE,!1),this.dispatchEvent(Kn)}),fe(this,"onRotateStart",()=>{var n;this.enabled&&this.enableRotate&&(this.dispatchEvent(As),this.updateTbState(it.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,(n=this.camera)==null||n.getWorldDirection(this._rotationAxis),!this.enablePan&&!this.enableZoom&&this.activateGizmos(!0))}),fe(this,"onRotateMove",()=>{var n;if(this.enabled&&this.enableRotate&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);let s;this._state!=it.ZROTATE&&(this.updateTbState(it.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this.enablePan?this.camera&&(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),s=(n=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):s=new Q().setFromMatrixPosition(this._gizmoMatrixState);const o=tt.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);s!==void 0&&this.applyTransformMatrix(this.zRotate(s,o)),this.dispatchEvent(ii)}}),fe(this,"onRotateEnd",()=>{this.updateTbState(it.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(Kn)}),fe(this,"onPinchStart",()=>{this.enabled&&this.enableZoom&&(this.dispatchEvent(As),this.updateTbState(it.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))}),fe(this,"onPinchMove",()=>{var n,s;if(this.enabled&&this.enableZoom&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const o=12;this._state!=it.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState(it.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),o*this._devPxRatio);const a=this._currentFingerDistance/this._startFingerDistance;let l;this.enablePan?this.camera instanceof Ai?l=(n=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement))==null?void 0:n.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera instanceof jt&&(l=(s=this.unprojectOnTbPlane(this.camera,pt.x,pt.y,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):l=this._gizmos.position,l!==void 0&&this.applyTransformMatrix(this.applyScale(a,l)),this.dispatchEvent(ii)}}),fe(this,"onPinchEnd",()=>{this.updateTbState(it.IDLE,!1),this.dispatchEvent(Kn)}),fe(this,"onTriplePanStart",()=>{if(this.enabled&&this.enableZoom&&this.domElement){this.dispatchEvent(As),this.updateTbState(it.SCALE,!0);let n=0,s=0;const o=this._touchCurrent.length;for(let a=0;a<o;a++)n+=this._touchCurrent[a].clientX,s+=this._touchCurrent[a].clientY;this.setCenter(n/o,s/o),this._startCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition)}}),fe(this,"onTriplePanMove",()=>{if(this.enabled&&this.enableZoom&&this.camera&&this.domElement){let n=0,s=0;const o=this._touchCurrent.length;for(let p=0;p<o;p++)n+=this._touchCurrent[p].clientX,s+=this._touchCurrent[p].clientY;this.setCenter(n/o,s/o);const a=8;this._currentCursorPosition.setY(this.getCursorNDC(pt.x,pt.y,this.domElement).y*.5);const l=this._currentCursorPosition.y-this._startCursorPosition.y;let c=1;l<0?c=1/Math.pow(this.scaleFactor,-l*a):l>0&&(c=Math.pow(this.scaleFactor,l*a)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/c;h=tt.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(tt.DEG2RAD*this._fovState*.5);let d=tt.RAD2DEG*(Math.atan(f/h)*2);d=tt.clamp(d,this.minFov,this.maxFov);const m=f/Math.tan(tt.DEG2RAD*(d/2));c=u/m,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(c,this._v3_2,!1));const A=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(m/u);this._m4_1.makeTranslation(A.x,A.y,A.z),this.dispatchEvent(ii)}}),fe(this,"onTriplePanEnd",()=>{this.updateTbState(it.IDLE,!1),this.dispatchEvent(Kn)}),fe(this,"setCenter",(n,s)=>{pt.x=n,pt.y=s}),fe(this,"initializeMouseActions",()=>{this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")}),fe(this,"setMouseAction",(n,s,o=null)=>{const a=["PAN","ROTATE","ZOOM","FOV"],l=[0,1,2,"WHEEL"],c=["CTRL","SHIFT",null];let u;if(!a.includes(n)||!l.includes(s)||!c.includes(o)||s=="WHEEL"&&n!="ZOOM"&&n!="FOV")return!1;switch(n){case"PAN":u=it.PAN;break;case"ROTATE":u=it.ROTATE;break;case"ZOOM":u=it.SCALE;break;case"FOV":u=it.FOV;break}const h={operation:n,mouse:s,key:o,state:u};for(let f=0;f<this.mouseActions.length;f++)if(this.mouseActions[f].mouse==h.mouse&&this.mouseActions[f].key==h.key)return this.mouseActions.splice(f,1,h),!0;return this.mouseActions.push(h),!0}),fe(this,"getOpFromAction",(n,s)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==s)return o.operation;if(s){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.operation}return null}),fe(this,"getOpStateFromAction",(n,s)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==s)return o.state;if(s){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==n&&o.key==null)return o.state}return null}),fe(this,"getAngle",(n,s)=>Math.atan2(s.clientY-n.clientY,s.clientX-n.clientX)*180/Math.PI),fe(this,"updateTouchEvent",n=>{for(let s=0;s<this._touchCurrent.length;s++)if(this._touchCurrent[s].pointerId==n.pointerId){this._touchCurrent.splice(s,1,n);break}}),fe(this,"calculateAngularSpeed",(n,s,o,a)=>{const l=s-n,c=(a-o)/1e3;return c==0?0:l/c}),fe(this,"calculatePointersDistance",(n,s)=>Math.sqrt(Math.pow(s.clientX-n.clientX,2)+Math.pow(s.clientY-n.clientY,2))),fe(this,"calculateRotationAxis",(n,s)=>(this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(n,s).applyQuaternion(this._quat),this._rotationAxis.normalize().clone())),fe(this,"calculateTbRadius",n=>{const o=n.position.distanceTo(this._gizmos.position);if(n instanceof jt){const a=tt.DEG2RAD*n.fov*.5,l=Math.atan(n.aspect*Math.tan(a));return Math.tan(Math.min(a,l))*o*.67}else if(n instanceof Ai)return Math.min(n.top,n.right)*.67}),fe(this,"focus",(n,s,o=1)=>{if(this.camera){const a=n.clone();a.sub(this._gizmos.position).multiplyScalar(o),this._translationMatrix.makeTranslation(a.x,a.y,a.z);const l=this._gizmoMatrixState.clone();this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale);const c=this._cameraMatrixState.clone();this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.applyScale(s,this._gizmos.position)),this._gizmoMatrixState.copy(l),this._cameraMatrixState.copy(c)}}),fe(this,"drawGrid",()=>{if(this.scene){let o,a,l,c;if(this.camera instanceof Ai){const u=this.camera.right-this.camera.left,h=this.camera.bottom-this.camera.top;l=Math.max(u,h),c=l/20,o=l/this.camera.zoom*3,a=o/c*this.camera.zoom}else if(this.camera instanceof jt){const u=this.camera.position.distanceTo(this._gizmos.position),h=tt.DEG2RAD*this.camera.fov*.5,f=Math.atan(this.camera.aspect*Math.tan(h));l=Math.tan(Math.max(h,f))*u*2,c=l/20,o=l*3,a=o/c}this._grid==null&&this.camera&&(this._grid=new B4(o,a,8947848,8947848),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(Math.PI*.5),this.scene.add(this._grid))}}),fe(this,"connect",n=>{n===document&&console.error('THREE.ArcballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=n,this.domElement.style.touchAction="none",this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointercancel",this.onPointerCancel),this.domElement.addEventListener("wheel",this.onWheel)}),fe(this,"dispose",()=>{var n,s,o,a,l;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),(n=this.domElement)==null||n.removeEventListener("pointerdown",this.onPointerDown),(s=this.domElement)==null||s.removeEventListener("pointercancel",this.onPointerCancel),(o=this.domElement)==null||o.removeEventListener("wheel",this.onWheel),(a=this.domElement)==null||a.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onWindowResize),(l=this.scene)==null||l.remove(this._gizmos),this.disposeGrid()}),fe(this,"disposeGrid",()=>{this._grid&&this.scene&&(this.scene.remove(this._grid),this._grid=null)}),fe(this,"easeOutCubic",n=>1-Math.pow(1-n,3)),fe(this,"activateGizmos",n=>{for(const s of this._gizmos.children)s.material.setValues({opacity:n?1:.6})}),fe(this,"getCursorNDC",(n,s,o)=>{const a=o.getBoundingClientRect();return this._v2_1.setX((n-a.left)/a.width*2-1),this._v2_1.setY((a.bottom-s)/a.height*2-1),this._v2_1.clone()}),fe(this,"getCursorPosition",(n,s,o)=>(this._v2_1.copy(this.getCursorNDC(n,s,o)),this.camera instanceof Ai&&(this._v2_1.x*=(this.camera.right-this.camera.left)*.5,this._v2_1.y*=(this.camera.top-this.camera.bottom)*.5),this._v2_1.clone())),fe(this,"setCamera",n=>{if(n){n.lookAt(this.target),n.updateMatrix(),n instanceof jt&&(this._fov0=n.fov,this._fovState=n.fov),this._cameraMatrixState0.copy(n.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(n.projectionMatrix),this._zoom0=n.zoom,this._zoomState=this._zoom0,this._initialNear=n.near,this._nearPos0=n.position.distanceTo(this.target)-n.near,this._nearPos=this._initialNear,this._initialFar=n.far,this._farPos0=n.position.distanceTo(this.target)-n.far,this._farPos=this._initialFar,this._up0.copy(n.up),this._upState.copy(n.up),this.camera=n,this.camera.updateProjectionMatrix();const s=this.calculateTbRadius(n);s!==void 0&&(this._tbRadius=s),this.makeGizmos(this.target,this._tbRadius)}}),fe(this,"makeGizmos",(n,s)=>{const a=new Of(0,0,s,s).getPoints(this._curvePts),l=new Gi().setFromPoints(a),c=new ga({color:16744576,fog:!1,transparent:!0,opacity:.6}),u=new ga({color:8454016,fog:!1,transparent:!0,opacity:.6}),h=new ga({color:8421631,fog:!1,transparent:!0,opacity:.6}),f=new bt(l,c),d=new bt(l,u),m=new bt(l,h),A=Math.PI*.5;if(f.rotation.x=A,d.rotation.y=A,this._gizmoMatrixState0.identity().setPosition(n),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this.camera&&this.camera.zoom!=1){const p=1/this.camera.zoom;this._scaleMatrix.makeScale(p,p,p),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(n.x,n.y,n.z),this._gizmoMatrixState.premultiply(this._translationMatrix)}this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.clear(),this._gizmos.add(f),this._gizmos.add(d),this._gizmos.add(m)}),fe(this,"onFocusAnim",(n,s,o,a)=>{if(this._timeStart==-1&&(this._timeStart=n),this._state==it.ANIMATION_FOCUS){const c=(n-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(a),c>=1)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(s,this.scaleFactor),this._timeStart=-1,this.updateTbState(it.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ii);else{const u=this.easeOutCubic(c),h=1-u+this.scaleFactor*u;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(s,h,u),this.dispatchEvent(ii);const f=this;this._animationId=window.requestAnimationFrame(function(d){f.onFocusAnim(d,s,o,a.clone())})}}else this._animationId=-1,this._timeStart=-1}),fe(this,"onRotationAnim",(n,s,o)=>{if(this._timeStart==-1&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=n),this._state==it.ANIMATION_ROTATE){const a=(n-this._timeStart)/1e3;if(o+-this.dampingFactor*a>0){this._angleCurrent=.5*-this.dampingFactor*Math.pow(a,2)+o*a+0,this.applyTransformMatrix(this.rotate(s,this._angleCurrent)),this.dispatchEvent(ii);const c=this;this._animationId=window.requestAnimationFrame(function(u){c.onRotationAnim(u,s,o)})}else this._animationId=-1,this._timeStart=-1,this.updateTbState(it.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(ii)}else this._animationId=-1,this._timeStart=-1,this._state!=it.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(ii))}),fe(this,"pan",(n,s,o=!1)=>{if(this.camera){const a=n.clone().sub(s);if(this.camera instanceof Ai&&a.multiplyScalar(1/this.camera.zoom),this.camera instanceof jt&&o){this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0);const l=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position);a.multiplyScalar(1/l)}this._v3_1.set(a.x,a.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1)}return Mn}),fe(this,"reset",()=>{if(this.camera){this.camera.zoom=this._zoom0,this.camera instanceof jt&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix();const n=this.calculateTbRadius(this.camera);n!==void 0&&(this._tbRadius=n),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState(it.IDLE,!1),this.dispatchEvent(ii)}}),fe(this,"rotate",(n,s)=>{const o=this._gizmos.position;return this._translationMatrix.makeTranslation(-o.x,-o.y,-o.z),this._rotationMatrix.makeRotationAxis(n,-s),this._m4_1.makeTranslation(o.x,o.y,o.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),Mn}),fe(this,"copyState",()=>{if(this.camera){const n=JSON.stringify(this.camera instanceof Ai?{arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}:{arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}});navigator.clipboard.writeText(n)}}),fe(this,"pasteState",()=>{const n=this;navigator.clipboard.readText().then(function(o){n.setStateFromJSON(o)})}),fe(this,"saveState",()=>{this.camera&&(this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera instanceof jt&&(this._fov0=this.camera.fov))}),fe(this,"applyScale",(n,s,o=!0)=>{if(!this.camera)return;const a=s.clone();let l=1/n;if(this.camera instanceof Ai){this.camera.zoom=this._zoomState,this.camera.zoom*=n,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,l=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,l=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(l,l,l),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),a.sub(this._v3_1);const c=a.clone().multiplyScalar(l);return a.sub(c),this._m4_1.makeTranslation(a.x,a.y,a.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),Mn}if(this.camera instanceof jt){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);let c=this._v3_1.distanceTo(a),u=c-c*l;const h=c-u;h<this.minDistance?(l=this.minDistance/c,u=c-c*l):h>this.maxDistance&&(l=this.maxDistance/c,u=c-c*l);let f=a.clone().sub(this._v3_1).normalize().multiplyScalar(u);if(this._m4_1.makeTranslation(f.x,f.y,f.z),o){const d=this._v3_2;c=d.distanceTo(a),u=c-c*l,f=a.clone().sub(this._v3_2).normalize().multiplyScalar(u),this._translationMatrix.makeTranslation(d.x,d.y,d.z),this._scaleMatrix.makeScale(l,l,l),this._m4_2.makeTranslation(f.x,f.y,f.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-d.x,-d.y,-d.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)}else this.setTransformationMatrices(this._m4_1);return Mn}}),fe(this,"setFov",n=>{this.camera instanceof jt&&(this.camera.fov=tt.clamp(n,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())}),fe(this,"setTarget",(n,s,o)=>{if(this.camera){this.target.set(n,s,o),this._gizmos.position.set(n,s,o);const a=this.calculateTbRadius(this.camera);a!==void 0&&(this._tbRadius=a),this.makeGizmos(this.target,this._tbRadius),this.camera.lookAt(this.target)}}),fe(this,"zRotate",(n,s)=>(this._rotationMatrix.makeRotationAxis(this._rotationAxis,s),this._translationMatrix.makeTranslation(-n.x,-n.y,-n.z),this._m4_1.makeTranslation(n.x,n.y,n.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(n),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,s),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),Mn)),fe(this,"unprojectOnObj",(n,s)=>{if(!this.scene)return null;const o=new $h;o.near=s.near,o.far=s.far,o.setFromCamera(n,s);const a=o.intersectObjects(this.scene.children,!0);for(let l=0;l<a.length;l++)if(a[l].object.uuid!=this._gizmos.uuid&&a[l].face)return a[l].point.clone();return null}),fe(this,"unprojectOnTbSurface",(n,s,o,a,l)=>{if(n instanceof Ai){this._v2_1.copy(this.getCursorPosition(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0);const c=Math.pow(this._v2_1.x,2),u=Math.pow(this._v2_1.y,2),h=Math.pow(this._tbRadius,2);return c+u<=h*.5?this._v3_1.setZ(Math.sqrt(h-(c+u))):this._v3_1.setZ(h*.5/Math.sqrt(c+u)),this._v3_1}if(n instanceof jt){this._v2_1.copy(this.getCursorNDC(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const c=this._v3_1.clone().normalize(),u=n.position.distanceTo(this._gizmos.position),h=Math.pow(l,2),f=this._v3_1.z,d=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(d==0)return c.set(this._v3_1.x,this._v3_1.y,l),c;const m=f/d,A=u;let p=Math.pow(m,2)+1,y=2*m*A,v=Math.pow(A,2)-h,E=Math.pow(y,2)-4*p*v;if(E>=0&&(this._v2_1.setX((-y-Math.sqrt(E))/(2*p)),this._v2_1.setY(m*this._v2_1.x+A),tt.RAD2DEG*this._v2_1.angle()>=45)){const C=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return c.multiplyScalar(C),c.z+=u,c}p=m,y=A,v=-h*.5,E=Math.pow(y,2)-4*p*v,this._v2_1.setX((-y-Math.sqrt(E))/(2*p)),this._v2_1.setY(m*this._v2_1.x+A);const x=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return c.multiplyScalar(x),c.z+=u,c}}),fe(this,"unprojectOnTbPlane",(n,s,o,a,l=!1)=>{if(n instanceof Ai)return this._v2_1.copy(this.getCursorPosition(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if(n instanceof jt){this._v2_1.copy(this.getCursorNDC(s,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(n.projectionMatrixInverse);const c=this._v3_1.clone().normalize(),u=this._v3_1.z,h=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let f;if(l?f=this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):f=n.position.distanceTo(this._gizmos.position),h==0)return c.set(0,0,0),c;const d=u/h,m=f,A=-m/d,p=Math.sqrt(Math.pow(m,2)+Math.pow(A,2));return c.multiplyScalar(p),c.z=0,c}}),fe(this,"updateMatrixState",()=>{this.camera&&(this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera instanceof Ai&&(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom),this.camera instanceof jt&&(this._fovState=this.camera.fov))}),fe(this,"updateTbState",(n,s)=>{this._state=n,s&&this.updateMatrixState()}),fe(this,"update",()=>{if(!this.target.equals(this._currentTarget)&&this.camera){this._gizmos.position.set(this.target.x,this.target.y,this.target.z);const s=this.calculateTbRadius(this.camera);s!==void 0&&(this._tbRadius=s),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)}if(this.camera){if(this.camera instanceof Ai&&(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom)){const s=tt.clamp(this.camera.zoom,this.minZoom,this.maxZoom);this.applyTransformMatrix(this.applyScale(s/this.camera.zoom,this._gizmos.position,!0))}if(this.camera instanceof jt){const s=this.camera.position.distanceTo(this._gizmos.position);if(s>this.maxDistance+1e-6||s<this.minDistance-1e-6){const l=tt.clamp(s,this.minDistance,this.maxDistance);this.applyTransformMatrix(this.applyScale(l/s,this._gizmos.position)),this.updateMatrixState()}(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=tt.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix());const o=this._tbRadius,a=this.calculateTbRadius(this.camera);if(a!==void 0&&(this._tbRadius=a),o<this._tbRadius-1e-6||o>this._tbRadius+1e-6){const l=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,c=this._tbRadius/l,h=new Of(0,0,c,c).getPoints(this._curvePts),f=new Gi().setFromPoints(h);for(const d in this._gizmos.children){const m=this._gizmos.children[d];m.geometry=f}}}this.camera.lookAt(this._gizmos.position)}}),fe(this,"setStateFromJSON",n=>{const s=JSON.parse(n);if(s.arcballState&&this.camera){this._cameraMatrixState.fromArray(s.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(s.arcballState.cameraUp),this.camera.near=s.arcballState.cameraNear,this.camera.far=s.arcballState.cameraFar,this.camera.zoom=s.arcballState.cameraZoom,this.camera instanceof jt&&(this.camera.fov=s.arcballState.cameraFov),this._gizmoMatrixState.fromArray(s.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix();const o=this.calculateTbRadius(this.camera);o!==void 0&&(this._tbRadius=o);const a=new we().copy(this._gizmoMatrixState0);this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(a),this.camera.lookAt(this._gizmos.position),this.updateTbState(it.IDLE,!1),this.dispatchEvent(ii)}}),this.camera=null,this.domElement=t,this.scene=i,this.mouseActions=[],this._mouseOp=null,this._v2_1=new De,this._v3_1=new Q,this._v3_2=new Q,this._m4_1=new we,this._m4_2=new we,this._quat=new st,this._translationMatrix=new we,this._rotationMatrix=new we,this._scaleMatrix=new we,this._rotationAxis=new Q,this._cameraMatrixState=new we,this._cameraProjectionState=new we,this._fovState=1,this._upState=new Q,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new we,this._up0=new Q,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new we,this._gizmoMatrixState0=new we,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=zt.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new Q,this._startCursorPosition=new Q,this._grid=null,this._gridPosition=new Q,this._gizmos=new mr,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new Q,this._cursorPosCurr=new Q,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.target=new Q(0,0,0),this._currentTarget=new Q(0,0,0),this._tbRadius=1,this._state=it.IDLE,this.setCamera(e),this.scene&&this.scene.add(this._gizmos),this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this.domElement&&this.connect(this.domElement),window.addEventListener("resize",this.onWindowResize)}applyTransformMatrix(e){if(e?.camera&&this.camera&&(this._m4_1.copy(this._cameraMatrixState).premultiply(e.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),(this._state==it.ROTATE||this._state==it.ZROTATE||this._state==it.ANIMATION_ROTATE)&&this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),e?.gizmos&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(e.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),(this._state==it.SCALE||this._state==it.FOCUS||this._state==it.ANIMATION_FOCUS)&&this.camera){const t=this.calculateTbRadius(this.camera);if(t!==void 0&&(this._tbRadius=t),this.adjustNearFar){const i=this.camera.position.distanceTo(this._gizmos.position),n=new Jt;n.setFromObject(this._gizmos);const s=new hn;n.getBoundingSphere(s);const o=Math.max(this._nearPos0,s.radius+s.center.length()),a=i-this._initialNear,l=Math.min(o,a);this.camera.near=i-l;const c=Math.min(this._farPos0,-s.radius+s.center.length()),u=i-this._initialFar,h=Math.min(c,u);this.camera.far=i-h,this.camera.updateProjectionMatrix()}else{let i=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,i=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,i=!0),i&&this.camera.updateProjectionMatrix()}}}setGizmosVisible(e){this._gizmos.visible=e,this.dispatchEvent(ii)}setTransformationMatrices(e=null,t=null){e?Mn.camera?Mn.camera.copy(e):Mn.camera=e.clone():Mn.camera=null,t?Mn.gizmos?Mn.gizmos.copy(t):Mn.gizmos=t.clone():Mn.gizmos=null}};var _6=Object.defineProperty,S6=(r,e,t)=>e in r?_6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Wt=(r,e,t)=>(S6(r,typeof e!="symbol"?e+"":e,t),t);function m1(r){r.preventDefault()}let T6=class extends xo{constructor(e,t){super(),Wt(this,"object"),Wt(this,"domElement",null),Wt(this,"movementSpeed",1),Wt(this,"rollSpeed",.005),Wt(this,"dragToLook",!1),Wt(this,"autoForward",!1),Wt(this,"changeEvent",{type:"change"}),Wt(this,"EPS",1e-6),Wt(this,"tmpQuaternion",new st),Wt(this,"mouseStatus",0),Wt(this,"movementSpeedMultiplier",1),Wt(this,"moveState",{up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}),Wt(this,"moveVector",new Q(0,0,0)),Wt(this,"rotationVector",new Q(0,0,0)),Wt(this,"keydown",i=>{if(!i.altKey){switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this.moveState.forward=1;break;case"KeyS":this.moveState.back=1;break;case"KeyA":this.moveState.left=1;break;case"KeyD":this.moveState.right=1;break;case"KeyR":this.moveState.up=1;break;case"KeyF":this.moveState.down=1;break;case"ArrowUp":this.moveState.pitchUp=1;break;case"ArrowDown":this.moveState.pitchDown=1;break;case"ArrowLeft":this.moveState.yawLeft=1;break;case"ArrowRight":this.moveState.yawRight=1;break;case"KeyQ":this.moveState.rollLeft=1;break;case"KeyE":this.moveState.rollRight=1;break}this.updateMovementVector(),this.updateRotationVector()}}),Wt(this,"keyup",i=>{switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this.moveState.forward=0;break;case"KeyS":this.moveState.back=0;break;case"KeyA":this.moveState.left=0;break;case"KeyD":this.moveState.right=0;break;case"KeyR":this.moveState.up=0;break;case"KeyF":this.moveState.down=0;break;case"ArrowUp":this.moveState.pitchUp=0;break;case"ArrowDown":this.moveState.pitchDown=0;break;case"ArrowLeft":this.moveState.yawLeft=0;break;case"ArrowRight":this.moveState.yawRight=0;break;case"KeyQ":this.moveState.rollLeft=0;break;case"KeyE":this.moveState.rollRight=0;break}this.updateMovementVector(),this.updateRotationVector()}),Wt(this,"pointerdown",i=>{if(this.dragToLook)this.mouseStatus++;else{switch(i.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1;break}this.updateMovementVector()}}),Wt(this,"pointermove",i=>{if(!this.dragToLook||this.mouseStatus>0){const n=this.getContainerDimensions(),s=n.size[0]/2,o=n.size[1]/2;this.moveState.yawLeft=-(i.pageX-n.offset[0]-s)/s,this.moveState.pitchDown=(i.pageY-n.offset[1]-o)/o,this.updateRotationVector()}}),Wt(this,"pointerup",i=>{if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(i.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0;break}this.updateMovementVector()}this.updateRotationVector()}),Wt(this,"lastQuaternion",new st),Wt(this,"lastPosition",new Q),Wt(this,"update",i=>{const n=i*this.movementSpeed,s=i*this.rollSpeed;this.object.translateX(this.moveVector.x*n),this.object.translateY(this.moveVector.y*n),this.object.translateZ(this.moveVector.z*n),this.tmpQuaternion.set(this.rotationVector.x*s,this.rotationVector.y*s,this.rotationVector.z*s,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS)&&(this.dispatchEvent(this.changeEvent),this.lastQuaternion.copy(this.object.quaternion),this.lastPosition.copy(this.object.position))}),Wt(this,"updateMovementVector",()=>{const i=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-i+this.moveState.back}),Wt(this,"updateRotationVector",()=>{this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft}),Wt(this,"getContainerDimensions",()=>this.domElement!=document&&!(this.domElement instanceof Document)?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}),Wt(this,"connect",i=>{this.domElement=i,i instanceof Document||i.setAttribute("tabindex",-1),this.domElement.addEventListener("contextmenu",m1),this.domElement.addEventListener("pointermove",this.pointermove),this.domElement.addEventListener("pointerdown",this.pointerdown),this.domElement.addEventListener("pointerup",this.pointerup),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}),Wt(this,"dispose",()=>{this.domElement.removeEventListener("contextmenu",m1),this.domElement.removeEventListener("pointermove",this.pointermove),this.domElement.removeEventListener("pointerdown",this.pointerdown),this.domElement.removeEventListener("pointerup",this.pointerup),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup)}),this.object=e,t!==void 0&&this.connect(t),this.updateMovementVector(),this.updateRotationVector()}};var b6=Object.defineProperty,w6=(r,e,t)=>e in r?b6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,co=(r,e,t)=>(w6(r,typeof e!="symbol"?e+"":e,t),t);class cf{constructor(){co(this,"enabled",!0),co(this,"needsSwap",!0),co(this,"clear",!1),co(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,i,n,s){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}class fr{constructor(e){co(this,"camera",new Ai(-1,1,1,-1,0,1)),co(this,"geometry",new ln(2,2)),co(this,"mesh"),this.mesh=new ze(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}var B6=Object.defineProperty,R6=(r,e,t)=>e in r?B6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,qc=(r,e,t)=>(R6(r,typeof e!="symbol"?e+"":e,t),t);class dm extends cf{constructor(e,t="tDiffuse"){super(),qc(this,"textureID"),qc(this,"uniforms"),qc(this,"material"),qc(this,"fsQuad"),this.textureID=t,e instanceof Ii?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=Ba.clone(e.uniforms),this.material=new Ii({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new fr(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.fsQuad.dispose(),this.material.dispose()}}const A1={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform float opacity;

    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 texel = texture2D( tDiffuse, vUv );
    	gl_FragColor = opacity * texel;

    }
  `};var D6=Object.defineProperty,M6=(r,e,t)=>e in r?D6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Zf=(r,e,t)=>(M6(r,typeof e!="symbol"?e+"":e,t),t);class p1 extends cf{constructor(e,t){super(),Zf(this,"scene"),Zf(this,"camera"),Zf(this,"inverse"),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){const n=e.getContext(),s=e.state;s.buffers.color.setMask(!1),s.buffers.depth.setMask(!1),s.buffers.color.setLocked(!0),s.buffers.depth.setLocked(!0);let o,a;this.inverse?(o=0,a=1):(o=1,a=0),s.buffers.stencil.setTest(!0),s.buffers.stencil.setOp(n.REPLACE,n.REPLACE,n.REPLACE),s.buffers.stencil.setFunc(n.ALWAYS,o,4294967295),s.buffers.stencil.setClear(a),s.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),s.buffers.color.setLocked(!1),s.buffers.depth.setLocked(!1),s.buffers.stencil.setLocked(!1),s.buffers.stencil.setFunc(n.EQUAL,1,4294967295),s.buffers.stencil.setOp(n.KEEP,n.KEEP,n.KEEP),s.buffers.stencil.setLocked(!0)}}class L6 extends cf{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}var P6=Object.defineProperty,F6=(r,e,t)=>e in r?P6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,$n=(r,e,t)=>(F6(r,typeof e!="symbol"?e+"":e,t),t);class k6{constructor(e,t){if($n(this,"renderer"),$n(this,"_pixelRatio"),$n(this,"_width"),$n(this,"_height"),$n(this,"renderTarget1"),$n(this,"renderTarget2"),$n(this,"writeBuffer"),$n(this,"readBuffer"),$n(this,"renderToScreen"),$n(this,"passes",[]),$n(this,"copyPass"),$n(this,"clock"),this.renderer=e,t===void 0){const i={minFilter:Nt,magFilter:Nt,format:Di},n=e.getSize(new De);this._pixelRatio=e.getPixelRatio(),this._width=n.width,this._height=n.height,t=new xi(this._width*this._pixelRatio,this._height*this._pixelRatio,i),t.texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,A1===void 0&&console.error("THREE.EffectComposer relies on CopyShader"),dm===void 0&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new dm(A1),this.copyPass.material.blending=tA,this.clock=new R4}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let i=!1;const n=this.passes.length;for(let s=0;s<n;s++){const o=this.passes[s];if(o.enabled!==!1){if(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),o.needsSwap){if(i){const a=this.renderer.getContext(),l=this.renderer.state.buffers.stencil;l.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),l.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}p1!==void 0&&(o instanceof p1?i=!0:o instanceof L6&&(i=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new De);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const i=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget1.setSize(i,n),this.renderTarget2.setSize(i,n);for(let s=0;s<this.passes.length;s++)this.passes[s].setSize(i,n)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}var O6=Object.defineProperty,U6=(r,e,t)=>e in r?O6(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Jr=(r,e,t)=>(U6(r,typeof e!="symbol"?e+"":e,t),t);class N6 extends cf{constructor(e,t,i,n,s=0){super(),Jr(this,"scene"),Jr(this,"camera"),Jr(this,"overrideMaterial"),Jr(this,"clearColor"),Jr(this,"clearAlpha"),Jr(this,"clearDepth",!1),Jr(this,"_oldClearColor",new We),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=s,this.clear=!0,this.needsSwap=!1}render(e,t,i){let n=e.autoClear;e.autoClear=!1;let s,o=null;this.overrideMaterial!==void 0&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),s=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,s),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=o),e.autoClear=n}}function La(r){if(typeof TextDecoder<"u")return new TextDecoder().decode(r);let e="";for(let t=0,i=r.length;t<i;t++)e+=String.fromCharCode(r[t]);try{return decodeURIComponent(escape(e))}catch{return e}}const uo="srgb",Ar="srgb-linear",g1=3001,G6=3e3;class wA extends Yr{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new K6(t)}),this.register(function(t){return new $6(t)}),this.register(function(t){return new tw(t)}),this.register(function(t){return new iw(t)}),this.register(function(t){return new nw(t)}),this.register(function(t){return new W6(t)}),this.register(function(t){return new j6(t)}),this.register(function(t){return new q6(t)}),this.register(function(t){return new X6(t)}),this.register(function(t){return new V6(t)}),this.register(function(t){return new J6(t)}),this.register(function(t){return new Y6(t)}),this.register(function(t){return new ew(t)}),this.register(function(t){return new Z6(t)}),this.register(function(t){return new z6(t)}),this.register(function(t){return new sw(t)}),this.register(function(t){return new rw(t)})}load(e,t,i,n){const s=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const c=ya.extractUrlBase(e);o=ya.resolveURL(c,this.path)}else o=ya.extractUrlBase(e);this.manager.itemStart(e);const a=function(c){n?n(c):console.error(c),s.manager.itemError(e),s.manager.itemEnd(e)},l=new Sn(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,function(c){try{s.parse(c,o,function(u){t(u),s.manager.itemEnd(e)},a)}catch(u){a(u)}},i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,n){let s;const o={},a={};if(typeof e=="string")s=JSON.parse(e);else if(e instanceof ArrayBuffer)if(La(new Uint8Array(e.slice(0,4)))===Q3){try{o[St.KHR_BINARY_GLTF]=new ow(e)}catch(u){n&&n(u);return}s=JSON.parse(o[St.KHR_BINARY_GLTF].content)}else s=JSON.parse(La(new Uint8Array(e)));else s=e;if(s.asset===void 0||s.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new vw(s,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let c=0;c<this.pluginCallbacks.length;c++){const u=this.pluginCallbacks[c](l);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[u.name]=u,o[u.name]=!0}if(s.extensionsUsed)for(let c=0;c<s.extensionsUsed.length;++c){const u=s.extensionsUsed[c],h=s.extensionsRequired||[];switch(u){case St.KHR_MATERIALS_UNLIT:o[u]=new H6;break;case St.KHR_DRACO_MESH_COMPRESSION:o[u]=new aw(s,this.dracoLoader);break;case St.KHR_TEXTURE_TRANSFORM:o[u]=new lw;break;case St.KHR_MESH_QUANTIZATION:o[u]=new cw;break;default:h.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}l.setExtensions(o),l.setPlugins(a),l.parse(i,n)}parseAsync(e,t){const i=this;return new Promise(function(n,s){i.parse(e,t,n,s)})}}function Q6(){let r={};return{get:function(e){return r[e]},add:function(e,t){r[e]=t},remove:function(e){delete r[e]},removeAll:function(){r={}}}}const St={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class z6{constructor(e){this.parser=e,this.name=St.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,n=t.length;i<n;i++){const s=t[i];s.extensions&&s.extensions[this.name]&&s.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let n=t.cache.get(i);if(n)return n;const s=t.json,l=((s.extensions&&s.extensions[this.name]||{}).lights||[])[e];let c;const u=new We(16777215);l.color!==void 0&&u.setRGB(l.color[0],l.color[1],l.color[2],Ar);const h=l.range!==void 0?l.range:0;switch(l.type){case"directional":c=new uE(u),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new Q0(u),c.distance=h;break;case"spot":c=new cE(u),c.distance=h,l.spot=l.spot||{},l.spot.innerConeAngle=l.spot.innerConeAngle!==void 0?l.spot.innerConeAngle:0,l.spot.outerConeAngle=l.spot.outerConeAngle!==void 0?l.spot.outerConeAngle:Math.PI/4,c.angle=l.spot.outerConeAngle,c.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return c.position.set(0,0,0),c.decay=2,cr(c,l),l.intensity!==void 0&&(c.intensity=l.intensity),c.name=t.createUniqueName(l.name||"light_"+e),n=Promise.resolve(c),t.cache.add(i,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,s=i.json.nodes[e],a=(s.extensions&&s.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(l){return i._getNodeRef(t.cache,a,l)})}}class H6{constructor(){this.name=St.KHR_MATERIALS_UNLIT}getMaterialType(){return Cs}extendParams(e,t,i){const n=[];e.color=new We(1,1,1),e.opacity=1;const s=t.pbrMetallicRoughness;if(s){if(Array.isArray(s.baseColorFactor)){const o=s.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],Ar),e.opacity=o[3]}s.baseColorTexture!==void 0&&n.push(i.assignTexture(e,"map",s.baseColorTexture,uo))}return Promise.all(n)}}class V6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name].emissiveStrength;return s!==void 0&&(t.emissiveIntensity=s),Promise.resolve()}}class K6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&s.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&s.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(s.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new De(a,a)}return Promise.all(s)}}class $6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_DISPERSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.dispersion=s.dispersion!==void 0?s.dispersion:0,Promise.resolve()}}class Y6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&s.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&s.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(s)}}class W6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_SHEEN}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[];t.sheenColor=new We(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=n.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],Ar)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&s.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,uo)),o.sheenRoughnessTexture!==void 0&&s.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(s)}}class j6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&s.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(s)}}class q6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_VOLUME}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&s.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new We().setRGB(a[0],a[1],a[2],Ar),Promise.all(s)}}class X6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_IOR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=n.extensions[this.name];return t.ior=s.ior!==void 0?s.ior:1.5,Promise.resolve()}}class J6{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_SPECULAR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&s.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new We().setRGB(a[0],a[1],a[2],Ar),o.specularColorTexture!==void 0&&s.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,uo)),Promise.all(s)}}class Z6{constructor(e){this.parser=e,this.name=St.EXT_MATERIALS_BUMP}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&s.push(i.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(s)}}class ew{constructor(e){this.parser=e,this.name=St.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:os}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const s=[],o=n.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&s.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(s)}}class tw{constructor(e){this.parser=e,this.name=St.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const s=n.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s.source,o)}}class iw{constructor(e){this.parser=e,this.name=St.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return i.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class nw{constructor(e){this.parser=e,this.name=St.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,s=n.textures[e];if(!s.extensions||!s.extensions[t])return null;const o=s.extensions[t],a=n.images[o.source];let l=i.textureLoader;if(a.uri){const c=i.options.manager.getHandler(a.uri);c!==null&&(l=c)}return this.detectSupport().then(function(c){if(c)return i.loadTextureImage(e,o.source,l);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class sw{constructor(e){this.name=St.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const n=i.extensions[this.name],s=this.parser.getDependency("buffer",n.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return s.then(function(a){const l=n.byteOffset||0,c=n.byteLength||0,u=n.count,h=n.byteStride,f=new Uint8Array(a,l,c);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(u,h,f,n.mode,n.filter).then(function(d){return d.buffer}):o.ready.then(function(){const d=new ArrayBuffer(u*h);return o.decodeGltfBuffer(new Uint8Array(d),u,h,f,n.mode,n.filter),d})})}else return null}}class rw{constructor(e){this.name=St.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const n=t.meshes[i.mesh];for(const c of n.primitives)if(c.mode!==qn.TRIANGLES&&c.mode!==qn.TRIANGLE_STRIP&&c.mode!==qn.TRIANGLE_FAN&&c.mode!==void 0)return null;const o=i.extensions[this.name].attributes,a=[],l={};for(const c in o)a.push(this.parser.getDependency("accessor",o[c]).then(u=>(l[c]=u,l[c])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(c=>{const u=c.pop(),h=u.isGroup?u.children:[u],f=c[0].count,d=[];for(const m of h){const A=new we,p=new Q,y=new st,v=new Q(1,1,1),E=new Zm(m.geometry,m.material,f);for(let x=0;x<f;x++)l.TRANSLATION&&p.fromBufferAttribute(l.TRANSLATION,x),l.ROTATION&&y.fromBufferAttribute(l.ROTATION,x),l.SCALE&&v.fromBufferAttribute(l.SCALE,x),E.setMatrixAt(x,A.compose(p,y,v));for(const x in l)if(x==="_COLOR_0"){const I=l[x];E.instanceColor=new oc(I.array,I.itemSize,I.normalized)}else x!=="TRANSLATION"&&x!=="ROTATION"&&x!=="SCALE"&&m.geometry.setAttribute(x,l[x]);gi.prototype.copy.call(E,m),this.parser.assignFinalMaterial(E),d.push(E)}return u.isGroup?(u.clear(),u.add(...d),u):d[0]}))}}const Q3="glTF",ll=12,y1={JSON:1313821514,BIN:5130562};class ow{constructor(e){this.name=St.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,ll);if(this.header={magic:La(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Q3)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-ll,n=new DataView(e,ll);let s=0;for(;s<i;){const o=n.getUint32(s,!0);s+=4;const a=n.getUint32(s,!0);if(s+=4,a===y1.JSON){const l=new Uint8Array(e,ll+s,o);this.content=La(l)}else if(a===y1.BIN){const l=ll+s;this.body=e.slice(l,l+o)}s+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class aw{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=St.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,n=this.dracoLoader,s=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},l={},c={};for(const u in o){const h=mm[u]||u.toLowerCase();a[h]=o[u]}for(const u in e.attributes){const h=mm[u]||u.toLowerCase();if(o[u]!==void 0){const f=i.accessors[e.attributes[u]],d=Ca[f.componentType];c[h]=d.name,l[h]=f.normalized===!0}}return t.getDependency("bufferView",s).then(function(u){return new Promise(function(h,f){n.decodeDracoFile(u,function(d){for(const m in d.attributes){const A=d.attributes[m],p=l[m];p!==void 0&&(A.normalized=p)}h(d)},a,c,Ar,f)})})}}class lw{constructor(){this.name=St.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class cw{constructor(){this.name=St.KHR_MESH_QUANTIZATION}}class z3 extends Q4{constructor(e,t,i,n){super(e,t,i,n)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=e*n*3+n;for(let o=0;o!==n;o++)t[o]=i[s+o];return t}interpolate_(e,t,i,n){const s=this.resultBuffer,o=this.sampleValues,a=this.valueSize,l=a*2,c=a*3,u=n-t,h=(i-t)/u,f=h*h,d=f*h,m=e*c,A=m-c,p=-2*d+3*f,y=d-f,v=1-p,E=y-f+h;for(let x=0;x!==a;x++){const I=o[A+x+a],C=o[A+x+l]*u,_=o[m+x+a],S=o[m+x]*u;s[x]=v*I+E*C+p*_+y*S}return s}}const uw=new st;class hw extends z3{interpolate_(e,t,i,n){const s=super.interpolate_(e,t,i,n);return uw.fromArray(s).normalize().toArray(s),s}}const qn={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},Ca={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},v1={9728:ei,9729:Nt,9984:F4,9985:P4,9986:L4,9987:Cc},E1={33071:On,33648:k4,10497:zn},ed={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},mm={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...Na>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Sr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},fw={CUBICSPLINE:void 0,LINEAR:dE,STEP:G4},td={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function dw(r){return r.DefaultMaterial===void 0&&(r.DefaultMaterial=new Yh({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:lc})),r.DefaultMaterial}function Zr(r,e,t){for(const i in t.extensions)r[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function cr(r,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(r.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function mw(r,e,t){let i=!1,n=!1,s=!1;for(let c=0,u=e.length;c<u;c++){const h=e[c];if(h.POSITION!==void 0&&(i=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(s=!0),i&&n&&s)break}if(!i&&!n&&!s)return Promise.resolve(r);const o=[],a=[],l=[];for(let c=0,u=e.length;c<u;c++){const h=e[c];if(i){const f=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):r.attributes.position;o.push(f)}if(n){const f=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):r.attributes.normal;a.push(f)}if(s){const f=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):r.attributes.color;l.push(f)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(c){const u=c[0],h=c[1],f=c[2];return i&&(r.morphAttributes.position=u),n&&(r.morphAttributes.normal=h),s&&(r.morphAttributes.color=f),r.morphTargetsRelative=!0,r})}function Aw(r,e){if(r.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)r.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(r.morphTargetInfluences.length===t.length){r.morphTargetDictionary={};for(let i=0,n=t.length;i<n;i++)r.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function pw(r){let e;const t=r.extensions&&r.extensions[St.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+id(t.attributes):e=r.indices+":"+id(r.attributes)+":"+r.mode,r.targets!==void 0)for(let i=0,n=r.targets.length;i<n;i++)e+=":"+id(r.targets[i]);return e}function id(r){let e="";const t=Object.keys(r).sort();for(let i=0,n=t.length;i<n;i++)e+=t[i]+":"+r[t[i]]+";";return e}function Am(r){switch(r){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function gw(r){return r.search(/\.jpe?g($|\?)/i)>0||r.search(/^data\:image\/jpeg/)===0?"image/jpeg":r.search(/\.webp($|\?)/i)>0||r.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const yw=new we;class vw{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Q6,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,n=!1,s=-1;typeof navigator<"u"&&typeof navigator.userAgent<"u"&&(i=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,n=navigator.userAgent.indexOf("Firefox")>-1,s=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||i||n&&s<98?this.textureLoader=new pr(this.options.manager):this.textureLoader=new D4(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Sn(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,n=this.json,s=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(o){const a={scene:o[0][n.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:n.asset,parser:i,userData:{}};return Zr(s,a,n),cr(a,n),Promise.all(i._invokeAll(function(l){return l.afterRoot&&l.afterRoot(a)})).then(function(){for(const l of a.scenes)l.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let n=0,s=t.length;n<s;n++){const o=t[n].joints;for(let a=0,l=o.length;a<l;a++)e[o[a]].isBone=!0}for(let n=0,s=e.length;n<s;n++){const o=e[n];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(i[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const n=i.clone(),s=(o,a)=>{const l=this.associations.get(o);l!=null&&this.associations.set(a,l);for(const[c,u]of o.children.entries())s(u,a.children[c])};return s(i,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const n=e(t[i]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let n=0;n<t.length;n++){const s=e(t[n]);s&&i.push(s)}return i}getDependency(e,t){const i=e+":"+t;let n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(s){return s.loadNode&&s.loadNode(t)});break;case"mesh":n=this._invokeOne(function(s){return s.loadMesh&&s.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(s){return s.loadBufferView&&s.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(s){return s.loadMaterial&&s.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(s){return s.loadTexture&&s.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(s){return s.loadAnimation&&s.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(i,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(s,o){return i.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[St.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(s,o){i.load(ya.resolveURL(t.uri,n.path),s,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const n=t.byteLength||0,s=t.byteOffset||0;return i.slice(s,s+n)})}loadAccessor(e){const t=this,i=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const o=ed[n.type],a=Ca[n.componentType],l=n.normalized===!0,c=new a(n.count*o);return Promise.resolve(new Vt(c,o,l))}const s=[];return n.bufferView!==void 0?s.push(this.getDependency("bufferView",n.bufferView)):s.push(null),n.sparse!==void 0&&(s.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),s.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(s).then(function(o){const a=o[0],l=ed[n.type],c=Ca[n.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,f=n.byteOffset||0,d=n.bufferView!==void 0?i.bufferViews[n.bufferView].byteStride:void 0,m=n.normalized===!0;let A,p;if(d&&d!==h){const y=Math.floor(f/d),v="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+y+":"+n.count;let E=t.cache.get(v);E||(A=new c(a,y*d,n.count*d/u),E=new M4(A,d/u),t.cache.add(v,E)),p=new lo(E,l,f%d/u,m)}else a===null?A=new c(n.count*l):A=new c(a,f,n.count*l),p=new Vt(A,l,m);if(n.sparse!==void 0){const y=ed.SCALAR,v=Ca[n.sparse.indices.componentType],E=n.sparse.indices.byteOffset||0,x=n.sparse.values.byteOffset||0,I=new v(o[1],E,n.sparse.count*y),C=new c(o[2],x,n.sparse.count*l);a!==null&&(p=new Vt(p.array.slice(),p.itemSize,p.normalized));for(let _=0,S=I.length;_<S;_++){const b=I[_];if(p.setX(b,C[_*l]),l>=2&&p.setY(b,C[_*l+1]),l>=3&&p.setZ(b,C[_*l+2]),l>=4&&p.setW(b,C[_*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p})}loadTexture(e){const t=this.json,i=this.options,s=t.textures[e].source,o=t.images[s];let a=this.textureLoader;if(o.uri){const l=i.manager.getHandler(o.uri);l!==null&&(a=l)}return this.loadTextureImage(e,s,a)}loadTextureImage(e,t,i){const n=this,s=this.json,o=s.textures[e],a=s.images[t],l=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,i).then(function(u){u.flipY=!1,u.name=o.name||a.name||"",u.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(u.name=a.uri);const f=(s.samplers||{})[o.sampler]||{};return u.magFilter=v1[f.magFilter]||Nt,u.minFilter=v1[f.minFilter]||Cc,u.wrapS=E1[f.wrapS]||zn,u.wrapT=E1[f.wrapT]||zn,n.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[l]=c,c}loadImageSource(e,t){const i=this,n=this.json,s=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const o=n.images[e],a=self.URL||self.webkitURL;let l=o.uri||"",c=!1;if(o.bufferView!==void 0)l=i.getDependency("bufferView",o.bufferView).then(function(h){c=!0;const f=new Blob([h],{type:o.mimeType});return l=a.createObjectURL(f),l});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(l).then(function(h){return new Promise(function(f,d){let m=f;t.isImageBitmapLoader===!0&&(m=function(A){const p=new tn(A);p.needsUpdate=!0,f(p)}),t.load(ya.resolveURL(h,s.path),m,void 0,d)})}).then(function(h){return c===!0&&a.revokeObjectURL(l),cr(h,o),h.userData.mimeType=o.mimeType||gw(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),h});return this.sourceCache[e]=u,u}assignTexture(e,t,i,n){const s=this;return this.getDependency("texture",i.index).then(function(o){if(!o)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(o=o.clone(),o.channel=i.texCoord),s.extensions[St.KHR_TEXTURE_TRANSFORM]){const a=i.extensions!==void 0?i.extensions[St.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const l=s.associations.get(o);o=s.extensions[St.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),s.associations.set(o,l)}}return n!==void 0&&(typeof n=="number"&&(n=n===g1?uo:Ar),"colorSpace"in o?o.colorSpace=n:o.encoding=n===uo?g1:G6),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const n=t.attributes.tangent===void 0,s=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+i.uuid;let l=this.cache.get(a);l||(l=new hE,eh.prototype.copy.call(l,i),l.color.copy(i.color),l.map=i.map,l.sizeAttenuation=!1,this.cache.add(a,l)),i=l}else if(e.isLine){const a="LineBasicMaterial:"+i.uuid;let l=this.cache.get(a);l||(l=new ga,eh.prototype.copy.call(l,i),l.color.copy(i.color),l.map=i.map,this.cache.add(a,l)),i=l}if(n||s||o){let a="ClonedMaterial:"+i.uuid+":";n&&(a+="derivative-tangents:"),s&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let l=this.cache.get(a);l||(l=i.clone(),s&&(l.vertexColors=!0),o&&(l.flatShading=!0),n&&(l.normalScale&&(l.normalScale.y*=-1),l.clearcoatNormalScale&&(l.clearcoatNormalScale.y*=-1)),this.cache.add(a,l),this.associations.set(l,this.associations.get(i))),i=l}e.material=i}getMaterialType(){return Yh}loadMaterial(e){const t=this,i=this.json,n=this.extensions,s=i.materials[e];let o;const a={},l=s.extensions||{},c=[];if(l[St.KHR_MATERIALS_UNLIT]){const h=n[St.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),c.push(h.extendParams(a,s,t))}else{const h=s.pbrMetallicRoughness||{};if(a.color=new We(1,1,1),a.opacity=1,Array.isArray(h.baseColorFactor)){const f=h.baseColorFactor;a.color.setRGB(f[0],f[1],f[2],Ar),a.opacity=f[3]}h.baseColorTexture!==void 0&&c.push(t.assignTexture(a,"map",h.baseColorTexture,uo)),a.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,a.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(a,"metalnessMap",h.metallicRoughnessTexture)),c.push(t.assignTexture(a,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(e,a)})))}s.doubleSided===!0&&(a.side=bi);const u=s.alphaMode||td.OPAQUE;if(u===td.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,u===td.MASK&&(a.alphaTest=s.alphaCutoff!==void 0?s.alphaCutoff:.5)),s.normalTexture!==void 0&&o!==Cs&&(c.push(t.assignTexture(a,"normalMap",s.normalTexture)),a.normalScale=new De(1,1),s.normalTexture.scale!==void 0)){const h=s.normalTexture.scale;a.normalScale.set(h,h)}if(s.occlusionTexture!==void 0&&o!==Cs&&(c.push(t.assignTexture(a,"aoMap",s.occlusionTexture)),s.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=s.occlusionTexture.strength)),s.emissiveFactor!==void 0&&o!==Cs){const h=s.emissiveFactor;a.emissive=new We().setRGB(h[0],h[1],h[2],Ar)}return s.emissiveTexture!==void 0&&o!==Cs&&c.push(t.assignTexture(a,"emissiveMap",s.emissiveTexture,uo)),Promise.all(c).then(function(){const h=new o(a);return s.name&&(h.name=s.name),cr(h,s),t.associations.set(h,{materials:e}),s.extensions&&Zr(n,h,s),h})}createUniqueName(e){const t=ac.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,n=this.primitiveCache;function s(a){return i[St.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(l){return x1(l,a,t)})}const o=[];for(let a=0,l=e.length;a<l;a++){const c=e[a],u=pw(c),h=n[u];if(h)o.push(h.promise);else{let f;c.extensions&&c.extensions[St.KHR_DRACO_MESH_COMPRESSION]?f=s(c):f=x1(new Gi,c,t),n[u]={primitive:c,promise:f},o.push(f)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,n=this.extensions,s=i.meshes[e],o=s.primitives,a=[];for(let l=0,c=o.length;l<c;l++){const u=o[l].material===void 0?dw(this.cache):this.getDependency("material",o[l].material);a.push(u)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(l){const c=l.slice(0,l.length-1),u=l[l.length-1],h=[];for(let d=0,m=u.length;d<m;d++){const A=u[d],p=o[d];let y;const v=c[d];if(p.mode===qn.TRIANGLES||p.mode===qn.TRIANGLE_STRIP||p.mode===qn.TRIANGLE_FAN||p.mode===void 0)y=s.isSkinnedMesh===!0?new iA(A,v):new ze(A,v),y.isSkinnedMesh===!0&&y.normalizeSkinWeights(),p.mode===qn.TRIANGLE_STRIP?y.geometry=a1(y.geometry,oE):p.mode===qn.TRIANGLE_FAN&&(y.geometry=a1(y.geometry,G0));else if(p.mode===qn.LINES)y=new O4(A,v);else if(p.mode===qn.LINE_STRIP)y=new bt(A,v);else if(p.mode===qn.LINE_LOOP)y=new U4(A,v);else if(p.mode===qn.POINTS)y=new N4(A,v);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+p.mode);Object.keys(y.geometry.morphAttributes).length>0&&Aw(y,s),y.name=t.createUniqueName(s.name||"mesh_"+e),cr(y,s),p.extensions&&Zr(n,y,p),t.assignFinalMaterial(y),h.push(y)}for(let d=0,m=h.length;d<m;d++)t.associations.set(h[d],{meshes:e,primitives:d});if(h.length===1)return s.extensions&&Zr(n,h[0],s),h[0];const f=new mr;s.extensions&&Zr(n,f,s),t.associations.set(f,{meshes:e});for(let d=0,m=h.length;d<m;d++)f.add(h[d]);return f})}loadCamera(e){let t;const i=this.json.cameras[e],n=i[i.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new jt(tt.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):i.type==="orthographic"&&(t=new Ai(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),cr(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let n=0,s=t.joints.length;n<s;n++)i.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(n){const s=n.pop(),o=n,a=[],l=[];for(let c=0,u=o.length;c<u;c++){const h=o[c];if(h){a.push(h);const f=new we;s!==null&&f.fromArray(s.array,c*16),l.push(f)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new fE(a,l)})}loadAnimation(e){const t=this.json,i=this,n=t.animations[e],s=n.name?n.name:"animation_"+e,o=[],a=[],l=[],c=[],u=[];for(let h=0,f=n.channels.length;h<f;h++){const d=n.channels[h],m=n.samplers[d.sampler],A=d.target,p=A.node,y=n.parameters!==void 0?n.parameters[m.input]:m.input,v=n.parameters!==void 0?n.parameters[m.output]:m.output;A.node!==void 0&&(o.push(this.getDependency("node",p)),a.push(this.getDependency("accessor",y)),l.push(this.getDependency("accessor",v)),c.push(m),u.push(A))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then(function(h){const f=h[0],d=h[1],m=h[2],A=h[3],p=h[4],y=[];for(let v=0,E=f.length;v<E;v++){const x=f[v],I=d[v],C=m[v],_=A[v],S=p[v];if(x===void 0)continue;x.updateMatrix&&x.updateMatrix();const b=i._createAnimationTracks(x,I,C,_,S);if(b)for(let T=0;T<b.length;T++)y.push(b[T])}return new eA(s,void 0,y)})}createNodeMesh(e){const t=this.json,i=this,n=t.nodes[e];return n.mesh===void 0?null:i.getDependency("mesh",n.mesh).then(function(s){const o=i._getNodeRef(i.meshCache,n.mesh,s);return n.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let l=0,c=n.weights.length;l<c;l++)a.morphTargetInfluences[l]=n.weights[l]}),o})}loadNode(e){const t=this.json,i=this,n=t.nodes[e],s=i._loadNodeShallow(e),o=[],a=n.children||[];for(let c=0,u=a.length;c<u;c++)o.push(i.getDependency("node",a[c]));const l=n.skin===void 0?Promise.resolve(null):i.getDependency("skin",n.skin);return Promise.all([s,Promise.all(o),l]).then(function(c){const u=c[0],h=c[1],f=c[2];f!==null&&u.traverse(function(d){d.isSkinnedMesh&&d.bind(f,yw)});for(let d=0,m=h.length;d<m;d++)u.add(h[d]);return u})}_loadNodeShallow(e){const t=this.json,i=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const s=t.nodes[e],o=s.name?n.createUniqueName(s.name):"",a=[],l=n._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return l&&a.push(l),s.camera!==void 0&&a.push(n.getDependency("camera",s.camera).then(function(c){return n._getNodeRef(n.cameraCache,s.camera,c)})),n._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){a.push(c)}),this.nodeCache[e]=Promise.all(a).then(function(c){let u;if(s.isBone===!0?u=new z0:c.length>1?u=new mr:c.length===1?u=c[0]:u=new gi,u!==c[0])for(let h=0,f=c.length;h<f;h++)u.add(c[h]);if(s.name&&(u.userData.name=s.name,u.name=o),cr(u,s),s.extensions&&Zr(i,u,s),s.matrix!==void 0){const h=new we;h.fromArray(s.matrix),u.applyMatrix4(h)}else s.translation!==void 0&&u.position.fromArray(s.translation),s.rotation!==void 0&&u.quaternion.fromArray(s.rotation),s.scale!==void 0&&u.scale.fromArray(s.scale);return n.associations.has(u)||n.associations.set(u,{}),n.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],n=this,s=new mr;i.name&&(s.name=n.createUniqueName(i.name)),cr(s,i),i.extensions&&Zr(t,s,i);const o=i.nodes||[],a=[];for(let l=0,c=o.length;l<c;l++)a.push(n.getDependency("node",o[l]));return Promise.all(a).then(function(l){for(let u=0,h=l.length;u<h;u++)s.add(l[u]);const c=u=>{const h=new Map;for(const[f,d]of n.associations)(f instanceof eh||f instanceof tn)&&h.set(f,d);return u.traverse(f=>{const d=n.associations.get(f);d!=null&&h.set(f,d)}),h};return n.associations=c(s),s})}_createAnimationTracks(e,t,i,n,s){const o=[],a=e.name?e.name:e.uuid,l=[];Sr[s.path]===Sr.weights?e.traverse(function(f){f.morphTargetInfluences&&l.push(f.name?f.name:f.uuid)}):l.push(a);let c;switch(Sr[s.path]){case Sr.weights:c=H0;break;case Sr.rotation:c=vh;break;case Sr.position:case Sr.scale:c=yh;break;default:switch(i.itemSize){case 1:c=H0;break;case 2:case 3:default:c=yh;break}break}const u=n.interpolation!==void 0?fw[n.interpolation]:dE,h=this._getArrayFromAccessor(i);for(let f=0,d=l.length;f<d;f++){const m=new c(l[f]+"."+Sr[s.path],t.array,h,u);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(m),o.push(m)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=Am(t.constructor),n=new Float32Array(t.length);for(let s=0,o=t.length;s<o;s++)n[s]=t[s]*i;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const n=this instanceof vh?hw:z3;return new n(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Ew(r,e,t){const i=e.attributes,n=new Jt;if(i.POSITION!==void 0){const a=t.json.accessors[i.POSITION],l=a.min,c=a.max;if(l!==void 0&&c!==void 0){if(n.set(new Q(l[0],l[1],l[2]),new Q(c[0],c[1],c[2])),a.normalized){const u=Am(Ca[a.componentType]);n.min.multiplyScalar(u),n.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const s=e.targets;if(s!==void 0){const a=new Q,l=new Q;for(let c=0,u=s.length;c<u;c++){const h=s[c];if(h.POSITION!==void 0){const f=t.json.accessors[h.POSITION],d=f.min,m=f.max;if(d!==void 0&&m!==void 0){if(l.setX(Math.max(Math.abs(d[0]),Math.abs(m[0]))),l.setY(Math.max(Math.abs(d[1]),Math.abs(m[1]))),l.setZ(Math.max(Math.abs(d[2]),Math.abs(m[2]))),f.normalized){const A=Am(Ca[f.componentType]);l.multiplyScalar(A)}a.max(l)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(a)}r.boundingBox=n;const o=new hn;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,r.boundingSphere=o}function x1(r,e,t){const i=e.attributes,n=[];function s(o,a){return t.getDependency("accessor",o).then(function(l){r.setAttribute(a,l)})}for(const o in i){const a=mm[o]||o.toLowerCase();a in r.attributes||n.push(s(i[o],a))}if(e.indices!==void 0&&!r.index){const o=t.getDependency("accessor",e.indices).then(function(a){r.setIndex(a)});n.push(o)}return cr(r,e),Ew(r,e,t),Promise.all(n).then(function(){return e.targets!==void 0?mw(r,e.targets,t):r})}class xw extends Gi{constructor(e,t,i,n){super();const s=[],o=[],a=[],l=new Q,c=new we;c.makeRotationFromEuler(i),c.setPosition(t);const u=new we;u.copy(c).invert(),h(),this.setAttribute("position",new Yi(s,3)),this.setAttribute("normal",new Yi(o,3)),this.setAttribute("uv",new Yi(a,2));function h(){let A,p=[];const y=new Q,v=new Q;if(e.geometry.isGeometry===!0){console.error("THREE.DecalGeometry no longer supports THREE.Geometry. Use BufferGeometry instead.");return}const E=e.geometry,x=E.attributes.position,I=E.attributes.normal;if(E.index!==null){const C=E.index;for(A=0;A<C.count;A++)y.fromBufferAttribute(x,C.getX(A)),v.fromBufferAttribute(I,C.getX(A)),f(p,y,v)}else for(A=0;A<x.count;A++)y.fromBufferAttribute(x,A),v.fromBufferAttribute(I,A),f(p,y,v);for(p=d(p,l.set(1,0,0)),p=d(p,l.set(-1,0,0)),p=d(p,l.set(0,1,0)),p=d(p,l.set(0,-1,0)),p=d(p,l.set(0,0,1)),p=d(p,l.set(0,0,-1)),A=0;A<p.length;A++){const C=p[A];a.push(.5+C.position.x/n.x,.5+C.position.y/n.y),C.position.applyMatrix4(c),s.push(C.position.x,C.position.y,C.position.z),o.push(C.normal.x,C.normal.y,C.normal.z)}}function f(A,p,y){p.applyMatrix4(e.matrixWorld),p.applyMatrix4(u),y.transformDirection(e.matrixWorld),A.push(new I1(p.clone(),y.clone()))}function d(A,p){const y=[],v=.5*Math.abs(n.dot(p));for(let E=0;E<A.length;E+=3){let x,I,C,_=0,S,b,T,R;const w=A[E+0].position.dot(p)-v,B=A[E+1].position.dot(p)-v,M=A[E+2].position.dot(p)-v;switch(x=w>0,I=B>0,C=M>0,_=(x?1:0)+(I?1:0)+(C?1:0),_){case 0:{y.push(A[E]),y.push(A[E+1]),y.push(A[E+2]);break}case 1:{if(x&&(S=A[E+1],b=A[E+2],T=m(A[E],S,p,v),R=m(A[E],b,p,v)),I){S=A[E],b=A[E+2],T=m(A[E+1],S,p,v),R=m(A[E+1],b,p,v),y.push(T),y.push(b.clone()),y.push(S.clone()),y.push(b.clone()),y.push(T.clone()),y.push(R);break}C&&(S=A[E],b=A[E+1],T=m(A[E+2],S,p,v),R=m(A[E+2],b,p,v)),y.push(S.clone()),y.push(b.clone()),y.push(T),y.push(R),y.push(T.clone()),y.push(b.clone());break}case 2:{x||(S=A[E].clone(),b=m(S,A[E+1],p,v),T=m(S,A[E+2],p,v),y.push(S),y.push(b),y.push(T)),I||(S=A[E+1].clone(),b=m(S,A[E+2],p,v),T=m(S,A[E],p,v),y.push(S),y.push(b),y.push(T)),C||(S=A[E+2].clone(),b=m(S,A[E],p,v),T=m(S,A[E+1],p,v),y.push(S),y.push(b),y.push(T));break}}}return y}function m(A,p,y,v){const E=A.position.dot(y)-v,x=p.position.dot(y)-v,I=E/(E-x);return new I1(new Q(A.position.x+I*(p.position.x-A.position.x),A.position.y+I*(p.position.y-A.position.y),A.position.z+I*(p.position.z-A.position.z)),new Q(A.normal.x+I*(p.normal.x-A.normal.x),A.normal.y+I*(p.normal.y-A.normal.y),A.normal.z+I*(p.normal.z-A.normal.z)))}}}class I1{constructor(e,t){this.position=e,this.normal=t}clone(){return new this.constructor(this.position.clone(),this.normal.clone())}}class Iw extends z4{constructor(e,t={}){const{bevelEnabled:i=!1,bevelSize:n=8,bevelThickness:s=10,font:o,height:a=50,size:l=100,lineHeight:c=1,letterSpacing:u=0,...h}=t;if(o===void 0)super();else{const f=o.generateShapes(e,l,{lineHeight:c,letterSpacing:u});super(f,{...h,bevelEnabled:i,bevelSize:n,bevelThickness:s,depth:a})}this.type="TextGeometry"}}const Cw={uniforms:{tDiffuse:{value:null}},vertexShader:`
    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;

    varying vec2 vUv;

    void main() {

    	vec4 tex = texture2D( tDiffuse, vUv );

    	#ifdef LinearTosRGB
    		gl_FragColor = LinearTosRGB( tex );
    	#else
    		gl_FragColor = sRGBTransferOETF( tex );
    	#endif

    }
  `},_w={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`
      varying vec2 vUv;

      void main() {

        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

      }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float h;

    varying vec2 vUv;

    void main() {

    	vec4 sum = vec4( 0.0 );

    	sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

    	gl_FragColor = sum;

    }
  `},Sw={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`

  uniform sampler2D tDiffuse;
  uniform float v;

  varying vec2 vUv;

  void main() {

    vec4 sum = vec4( 0.0 );

    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

    gl_FragColor = sum;

  }
  `},nd=new mE,sd=new Q,Mo=new Q,ps=new Q,tr=new Q,Bs=new Q,ir=new Q,nr=new Q,cl=new Q,ul=new Q,hl=new Q,Xc=new Q,fl=new Q,dl=new Q,ml=new Q;class Tw{constructor(e,t,i){this.camera=e,this.scene=t,this.startPoint=new Q,this.endPoint=new Q,this.collection=[],this.deep=i||Number.MAX_VALUE}select(e,t){return this.startPoint=e||this.startPoint,this.endPoint=t||this.endPoint,this.collection=[],this.updateFrustum(this.startPoint,this.endPoint),this.searchChildInFrustum(nd,this.scene),this.collection}updateFrustum(e,t){if(e=e||this.startPoint,t=t||this.endPoint,e.x===t.x&&(t.x+=Number.EPSILON),e.y===t.y&&(t.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld(),this.camera.isPerspectiveCamera){Mo.copy(e),Mo.x=Math.min(e.x,t.x),Mo.y=Math.max(e.y,t.y),t.x=Math.max(e.x,t.x),t.y=Math.min(e.y,t.y),ps.setFromMatrixPosition(this.camera.matrixWorld),tr.copy(Mo),Bs.set(t.x,Mo.y,0),ir.copy(t),nr.set(Mo.x,t.y,0),tr.unproject(this.camera),Bs.unproject(this.camera),ir.unproject(this.camera),nr.unproject(this.camera),fl.copy(tr).sub(ps),dl.copy(Bs).sub(ps),ml.copy(ir).sub(ps),fl.normalize(),dl.normalize(),ml.normalize(),fl.multiplyScalar(this.deep),dl.multiplyScalar(this.deep),ml.multiplyScalar(this.deep),fl.add(ps),dl.add(ps),ml.add(ps);var i=nd.planes;i[0].setFromCoplanarPoints(ps,tr,Bs),i[1].setFromCoplanarPoints(ps,Bs,ir),i[2].setFromCoplanarPoints(ir,nr,ps),i[3].setFromCoplanarPoints(nr,tr,ps),i[4].setFromCoplanarPoints(Bs,ir,nr),i[5].setFromCoplanarPoints(ml,dl,fl),i[5].normal.multiplyScalar(-1)}else if(this.camera.isOrthographicCamera){const n=Math.min(e.x,t.x),s=Math.max(e.y,t.y),o=Math.max(e.x,t.x),a=Math.min(e.y,t.y);tr.set(n,s,-1),Bs.set(o,s,-1),ir.set(o,a,-1),nr.set(n,a,-1),cl.set(n,s,1),ul.set(o,s,1),hl.set(o,a,1),Xc.set(n,a,1),tr.unproject(this.camera),Bs.unproject(this.camera),ir.unproject(this.camera),nr.unproject(this.camera),cl.unproject(this.camera),ul.unproject(this.camera),hl.unproject(this.camera),Xc.unproject(this.camera);var i=nd.planes;i[0].setFromCoplanarPoints(tr,cl,ul),i[1].setFromCoplanarPoints(Bs,ul,hl),i[2].setFromCoplanarPoints(hl,Xc,nr),i[3].setFromCoplanarPoints(Xc,cl,tr),i[4].setFromCoplanarPoints(Bs,ir,nr),i[5].setFromCoplanarPoints(hl,ul,cl),i[5].normal.multiplyScalar(-1)}else console.error("THREE.SelectionBox: Unsupported camera type.")}searchChildInFrustum(e,t){if((t.isMesh||t.isLine||t.isPoints)&&t.material!==void 0&&(t.geometry.boundingSphere===null&&t.geometry.computeBoundingSphere(),sd.copy(t.geometry.boundingSphere.center),sd.applyMatrix4(t.matrixWorld),e.containsPoint(sd)&&this.collection.push(t)),t.children.length>0)for(let i=0;i<t.children.length;i++)this.searchChildInFrustum(e,t.children[i])}}class bw{constructor(e,t=" .:-=+*#%@",i={}){const n=i.resolution||.15,s=i.scale||1,o=i.color||!1,a=i.alpha||!1,l=i.block||!1,c=i.invert||!1,u=i.strResolution||"low";let h,f;const d=document.createElement("div");d.style.cursor="default";const m=document.createElement("table");d.appendChild(m);let A,p,y;this.setSize=function(M,O){h=M,f=O,e.setSize(M,O),v()},this.render=function(M,O){e.render(M,O),B(m)},this.domElement=d;function v(){A=Math.floor(h*n),p=Math.floor(f*n),_.width=A,_.height=p,y=e.domElement,y.style.backgroundColor&&(m.rows[0].cells[0].style.backgroundColor=y.style.backgroundColor,m.rows[0].cells[0].style.color=y.style.color),m.cellSpacing=0,m.cellPadding=0;const M=m.style;M.whiteSpace="pre",M.margin="0px",M.padding="0px",M.letterSpacing=w+"px",M.fontFamily=I,M.fontSize=T+"px",M.lineHeight=R+"px",M.textAlign="left",M.textDecoration="none"}const E=" .,:;i1tfLCG08@".split(""),x=" CGO08@".split(""),I="courier new, monospace",C=e.domElement,_=document.createElement("canvas");if(!_.getContext)return;const S=_.getContext("2d");if(!S.getImageData)return;let b=o?x:E;t&&(b=t);const T=2/n*s,R=2/n*s;let w=0;if(u=="low")switch(s){case 1:w=-1;break;case 2:case 3:w=-2.1;break;case 4:w=-3.1;break;case 5:w=-4.15;break}if(u=="medium")switch(s){case 1:w=0;break;case 2:w=-1;break;case 3:w=-1.04;break;case 4:case 5:w=-2.1;break}if(u=="high")switch(s){case 1:case 2:w=0;break;case 3:case 4:case 5:w=-1;break}function B(M){S.clearRect(0,0,A,p),S.drawImage(C,0,0,A,p);const O=S.getImageData(0,0,A,p).data;let U="";for(let Y=0;Y<p;Y+=2){for(let W=0;W<A;W++){const N=(Y*A+W)*4,K=O[N],D=O[N+1],z=O[N+2],$=O[N+3];let V,P;P=(.3*K+.59*D+.11*z)/255,$==0&&(P=1),V=Math.floor((1-P)*(b.length-1)),c&&(V=b.length-V-1);let G=b[V];(G===void 0||G==" ")&&(G="&nbsp;"),o?U+="<span style='color:rgb("+K+","+D+","+z+");"+(l?"background-color:rgb("+K+","+D+","+z+");":"")+(a?"opacity:"+$/255+";":"")+"'>"+G+"</span>":U+=G}U+="<br/>"}M.innerHTML=`<tr><td style="display:block;width:${h}px;height:${f}px;overflow:hidden">${U}</td></tr>`}}}function H3(r,e,t){const i=t.length-r-1;if(e>=t[i])return i-1;if(e<=t[r])return r;let n=r,s=i,o=Math.floor((n+s)/2);for(;e<t[o]||e>=t[o+1];)e<t[o]?s=o:n=o,o=Math.floor((n+s)/2);return o}function ww(r,e,t,i){const n=[],s=[],o=[];n[0]=1;for(let a=1;a<=t;++a){s[a]=e-i[r+1-a],o[a]=i[r+a]-e;let l=0;for(let c=0;c<a;++c){const u=o[c+1],h=s[a-c],f=n[c]/(u+h);n[c]=l+u*f,l=h*f}n[a]=l}return n}function Bw(r,e,t,i){const n=H3(r,i,e),s=ww(n,i,r,e),o=new yi(0,0,0,0);for(let a=0;a<=r;++a){const l=t[n-r+a],c=s[a],u=l.w*c;o.x+=l.x*u,o.y+=l.y*u,o.z+=l.z*u,o.w+=l.w*c}return o}function Rw(r,e,t,i,n){const s=[];for(let h=0;h<=t;++h)s[h]=0;const o=[];for(let h=0;h<=i;++h)o[h]=s.slice(0);const a=[];for(let h=0;h<=t;++h)a[h]=s.slice(0);a[0][0]=1;const l=s.slice(0),c=s.slice(0);for(let h=1;h<=t;++h){l[h]=e-n[r+1-h],c[h]=n[r+h]-e;let f=0;for(let d=0;d<h;++d){const m=c[d+1],A=l[h-d];a[h][d]=m+A;const p=a[d][h-1]/a[h][d];a[d][h]=f+m*p,f=A*p}a[h][h]=f}for(let h=0;h<=t;++h)o[0][h]=a[h][t];for(let h=0;h<=t;++h){let f=0,d=1;const m=[];for(let A=0;A<=t;++A)m[A]=s.slice(0);m[0][0]=1;for(let A=1;A<=i;++A){let p=0;const y=h-A,v=t-A;h>=A&&(m[d][0]=m[f][0]/a[v+1][y],p=m[d][0]*a[y][v]);const E=y>=-1?1:-y,x=h-1<=v?A-1:t-h;for(let C=E;C<=x;++C)m[d][C]=(m[f][C]-m[f][C-1])/a[v+1][y+C],p+=m[d][C]*a[y+C][v];h<=v&&(m[d][A]=-m[f][A-1]/a[v+1][h],p+=m[d][A]*a[h][v]),o[A][h]=p;const I=f;f=d,d=I}}let u=t;for(let h=1;h<=i;++h){for(let f=0;f<=t;++f)o[h][f]*=u;u*=t-h}return o}function Dw(r,e,t,i,n){const s=n<r?n:r,o=[],a=H3(r,i,e),l=Rw(a,i,r,s,e),c=[];for(let u=0;u<t.length;++u){const h=t[u].clone(),f=h.w;h.x*=f,h.y*=f,h.z*=f,c[u]=h}for(let u=0;u<=s;++u){const h=c[a-r].clone().multiplyScalar(l[u][0]);for(let f=1;f<=r;++f)h.add(c[a-r+f].clone().multiplyScalar(l[u][f]));o[u]=h}for(let u=s+1;u<=n+1;++u)o[u]=new yi(0,0,0);return o}function Mw(r,e){let t=1;for(let n=2;n<=r;++n)t*=n;let i=1;for(let n=2;n<=e;++n)i*=n;for(let n=2;n<=r-e;++n)i*=n;return t/i}function Lw(r){const e=r.length,t=[],i=[];for(let s=0;s<e;++s){const o=r[s];t[s]=new Q(o.x,o.y,o.z),i[s]=o.w}const n=[];for(let s=0;s<e;++s){const o=t[s].clone();for(let a=1;a<=s;++a)o.sub(n[s-a].clone().multiplyScalar(Mw(s,a)*i[a]));n[s]=o.divideScalar(i[0])}return n}function Pw(r,e,t,i,n){const s=Dw(r,e,t,i,n);return Lw(s)}class C1 extends H4{constructor(e,t,i,n,s){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=n||0,this.endKnot=s||this.knots.length-1;for(let o=0;o<i.length;++o){const a=i[o];this.controlPoints[o]=new yi(a.x,a.y,a.z,a.w)}}getPoint(e,t){const i=t||new Q,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),s=Bw(this.degree,this.knots,this.controlPoints,n);return s.w!=1&&s.divideScalar(s.w),i.set(s.x,s.y,s.z)}getTangent(e,t){const i=t||new Q,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),s=Pw(this.degree,this.knots,this.controlPoints,n,1);return i.copy(s[1]).normalize(),i}}let _t,Ti,vn;class BA extends Yr{constructor(e){super(e)}load(e,t,i,n){const s=this,o=s.path===""?ya.extractUrlBase(e):s.path,a=new Sn(this.manager);a.setPath(s.path),a.setResponseType("arraybuffer"),a.setRequestHeader(s.requestHeader),a.setWithCredentials(s.withCredentials),a.load(e,function(l){try{t(s.parse(l,o))}catch(c){n?n(c):console.error(c),s.manager.itemError(e)}},i,n)}parse(e,t){if(Gw(e))_t=new Nw().parse(e);else{const n=Y3(e);if(!Qw(n))throw new Error("THREE.FBXLoader: Unknown format.");if(S1(n)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+S1(n));_t=new Uw().parse(n)}const i=new pr(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new Fw(i,this.manager).parse(_t)}}class Fw{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Ti=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),i=this.parseMaterials(t),n=this.parseDeformers(),s=new kw().parse(n);return this.parseScene(n,s,i),vn}parseConnections(){const e=new Map;return"Connections"in _t&&_t.Connections.connections.forEach(function(i){const n=i[0],s=i[1],o=i[2];e.has(n)||e.set(n,{parents:[],children:[]});const a={ID:s,relationship:o};e.get(n).parents.push(a),e.has(s)||e.set(s,{parents:[],children:[]});const l={ID:n,relationship:o};e.get(s).children.push(l)}),e}parseImages(){const e={},t={};if("Video"in _t.Objects){const i=_t.Objects.Video;for(const n in i){const s=i[n],o=parseInt(n);if(e[o]=s.RelativeFilename||s.Filename,"Content"in s){const a=s.Content instanceof ArrayBuffer&&s.Content.byteLength>0,l=typeof s.Content=="string"&&s.Content!=="";if(a||l){const c=this.parseImage(i[n]);t[s.RelativeFilename||s.Filename]=c}}}}for(const i in e){const n=e[i];t[n]!==void 0?e[i]=t[n]:e[i]=e[i].split("\\").pop()}return e}parseImage(e){const t=e.Content,i=e.RelativeFilename||e.Filename,n=i.slice(i.lastIndexOf(".")+1).toLowerCase();let s;switch(n){case"bmp":s="image/bmp";break;case"jpg":case"jpeg":s="image/jpeg";break;case"png":s="image/png";break;case"tif":s="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",i),s="image/tga";break;default:console.warn('FBXLoader: Image type "'+n+'" is not supported.');return}if(typeof t=="string")return"data:"+s+";base64,"+t;{const o=new Uint8Array(t);return window.URL.createObjectURL(new Blob([o],{type:s}))}}parseTextures(e){const t=new Map;if("Texture"in _t.Objects){const i=_t.Objects.Texture;for(const n in i){const s=this.parseTexture(i[n],e);t.set(parseInt(n),s)}}return t}parseTexture(e,t){const i=this.loadTexture(e,t);i.ID=e.id,i.name=e.attrName;const n=e.WrapModeU,s=e.WrapModeV,o=n!==void 0?n.value:0,a=s!==void 0?s.value:0;if(i.wrapS=o===0?zn:On,i.wrapT=a===0?zn:On,"Scaling"in e){const l=e.Scaling.value;i.repeat.x=l[0],i.repeat.y=l[1]}return i}loadTexture(e,t){let i;const n=this.textureLoader.path,s=Ti.get(e.id).children;s!==void 0&&s.length>0&&t[s[0].ID]!==void 0&&(i=t[s[0].ID],(i.indexOf("blob:")===0||i.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let o;const a=e.FileName.slice(-3).toLowerCase();if(a==="tga"){const l=this.manager.getHandler(".tga");l===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),o=new tn):(l.setPath(this.textureLoader.path),o=l.load(i))}else a==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),o=new tn):o=this.textureLoader.load(i);return this.textureLoader.setPath(n),o}parseMaterials(e){const t=new Map;if("Material"in _t.Objects){const i=_t.Objects.Material;for(const n in i){const s=this.parseMaterial(i[n],e);s!==null&&t.set(parseInt(n),s)}}return t}parseMaterial(e,t){const i=e.id,n=e.attrName;let s=e.ShadingModel;if(typeof s=="object"&&(s=s.value),!Ti.has(i))return null;const o=this.parseParameters(e,t,i);let a;switch(s.toLowerCase()){case"phong":a=new Uf;break;case"lambert":a=new nA;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',s),a=new Uf;break}return a.setValues(o),a.name=n,a}parseParameters(e,t,i){const n={};e.BumpFactor&&(n.bumpScale=e.BumpFactor.value),e.Diffuse?n.color=new We().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(n.color=new We().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(n.displacementScale=e.DisplacementFactor.value),e.Emissive?n.emissive=new We().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(n.emissive=new We().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(n.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(n.opacity=parseFloat(e.Opacity.value)),n.opacity<1&&(n.transparent=!0),e.ReflectionFactor&&(n.reflectivity=e.ReflectionFactor.value),e.Shininess&&(n.shininess=e.Shininess.value),e.Specular?n.specular=new We().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(n.specular=new We().fromArray(e.SpecularColor.value));const s=this;return Ti.get(i).children.forEach(function(o){const a=o.relationship;switch(a){case"Bump":n.bumpMap=s.getTexture(t,o.ID);break;case"Maya|TEX_ao_map":n.aoMap=s.getTexture(t,o.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=s.getTexture(t,o.ID),n.map!==void 0&&("colorSpace"in n.map?n.map.colorSpace="srgb":n.map.encoding=3001);break;case"DisplacementColor":n.displacementMap=s.getTexture(t,o.ID);break;case"EmissiveColor":n.emissiveMap=s.getTexture(t,o.ID),n.emissiveMap!==void 0&&("colorSpace"in n.emissiveMap?n.emissiveMap.colorSpace="srgb":n.emissiveMap.encoding=3001);break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=s.getTexture(t,o.ID);break;case"ReflectionColor":n.envMap=s.getTexture(t,o.ID),n.envMap!==void 0&&(n.envMap.mapping=AE,"colorSpace"in n.envMap?n.envMap.colorSpace="srgb":n.envMap.encoding=3001);break;case"SpecularColor":n.specularMap=s.getTexture(t,o.ID),n.specularMap!==void 0&&("colorSpace"in n.specularMap?n.specularMap.colorSpace="srgb":n.specularMap.encoding=3001);break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=s.getTexture(t,o.ID),n.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",a);break}}),n}getTexture(e,t){return"LayeredTexture"in _t.Objects&&t in _t.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Ti.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in _t.Objects){const i=_t.Objects.Deformer;for(const n in i){const s=i[n],o=Ti.get(parseInt(n));if(s.attrType==="Skin"){const a=this.parseSkeleton(o,i);a.ID=n,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),a.geometryID=o.parents[0].ID,e[n]=a}else if(s.attrType==="BlendShape"){const a={id:n};a.rawTargets=this.parseMorphTargets(o,i),a.id=n,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[n]=a}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const i=[];return e.children.forEach(function(n){const s=t[n.ID];if(s.attrType!=="Cluster")return;const o={ID:n.ID,indices:[],weights:[],transformLink:new we().fromArray(s.TransformLink.a)};"Indexes"in s&&(o.indices=s.Indexes.a,o.weights=s.Weights.a),i.push(o)}),{rawBones:i,bones:[]}}parseMorphTargets(e,t){const i=[];for(let n=0;n<e.children.length;n++){const s=e.children[n],o=t[s.ID],a={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if(o.attrType!=="BlendShapeChannel")return;a.geoID=Ti.get(parseInt(s.ID)).children.filter(function(l){return l.relationship===void 0})[0].ID,i.push(a)}return i}parseScene(e,t,i){vn=new mr;const n=this.parseModels(e.skeletons,t,i),s=_t.Objects.Model,o=this;n.forEach(function(l){const c=s[l.ID];o.setLookAtProperties(l,c),Ti.get(l.ID).parents.forEach(function(h){const f=n.get(h.ID);f!==void 0&&f.add(l)}),l.parent===null&&vn.add(l)}),this.bindSkeleton(e.skeletons,t,n),this.createAmbientLight(),vn.traverse(function(l){if(l.userData.transformData){l.parent&&(l.userData.transformData.parentMatrix=l.parent.matrix,l.userData.transformData.parentMatrixWorld=l.parent.matrixWorld);const c=K3(l.userData.transformData);l.applyMatrix4(c),l.updateWorldMatrix()}});const a=new Ow().parse();vn.children.length===1&&vn.children[0].isGroup&&(vn.children[0].animations=a,vn=vn.children[0]),vn.animations=a}parseModels(e,t,i){const n=new Map,s=_t.Objects.Model;for(const o in s){const a=parseInt(o),l=s[o],c=Ti.get(a);let u=this.buildSkeleton(c,e,a,l.attrName);if(!u){switch(l.attrType){case"Camera":u=this.createCamera(c);break;case"Light":u=this.createLight(c);break;case"Mesh":u=this.createMesh(c,t,i);break;case"NurbsCurve":u=this.createCurve(c,t);break;case"LimbNode":case"Root":u=new z0;break;case"Null":default:u=new mr;break}u.name=l.attrName?ac.sanitizeNodeName(l.attrName):"",u.ID=a}this.getTransformData(u,l),n.set(a,u)}return n}buildSkeleton(e,t,i,n){let s=null;return e.parents.forEach(function(o){for(const a in t){const l=t[a];l.rawBones.forEach(function(c,u){if(c.ID===o.ID){const h=s;s=new z0,s.matrixWorld.copy(c.transformLink),s.name=n?ac.sanitizeNodeName(n):"",s.ID=i,l.bones[u]=s,h!==null&&s.add(h)}})}}),s}createCamera(e){let t,i;if(e.children.forEach(function(n){const s=_t.Objects.NodeAttribute[n.ID];s!==void 0&&(i=s)}),i===void 0)t=new gi;else{let n=0;i.CameraProjectionType!==void 0&&i.CameraProjectionType.value===1&&(n=1);let s=1;i.NearPlane!==void 0&&(s=i.NearPlane.value/1e3);let o=1e3;i.FarPlane!==void 0&&(o=i.FarPlane.value/1e3);let a=window.innerWidth,l=window.innerHeight;i.AspectWidth!==void 0&&i.AspectHeight!==void 0&&(a=i.AspectWidth.value,l=i.AspectHeight.value);const c=a/l;let u=45;i.FieldOfView!==void 0&&(u=i.FieldOfView.value);const h=i.FocalLength?i.FocalLength.value:null;switch(n){case 0:t=new jt(u,c,s,o),h!==null&&t.setFocalLength(h);break;case 1:t=new Ai(-a/2,a/2,l/2,-l/2,s,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+n+"."),t=new gi;break}}return t}createLight(e){let t,i;if(e.children.forEach(function(n){const s=_t.Objects.NodeAttribute[n.ID];s!==void 0&&(i=s)}),i===void 0)t=new gi;else{let n;i.LightType===void 0?n=0:n=i.LightType.value;let s=16777215;i.Color!==void 0&&(s=new We().fromArray(i.Color.value));let o=i.Intensity===void 0?1:i.Intensity.value/100;i.CastLightOnObject!==void 0&&i.CastLightOnObject.value===0&&(o=0);let a=0;i.FarAttenuationEnd!==void 0&&(i.EnableFarAttenuation!==void 0&&i.EnableFarAttenuation.value===0?a=0:a=i.FarAttenuationEnd.value);const l=1;switch(n){case 0:t=new Q0(s,o,a,l);break;case 1:t=new uE(s,o);break;case 2:let c=Math.PI/3;i.InnerAngle!==void 0&&(c=tt.degToRad(i.InnerAngle.value));let u=0;i.OuterAngle!==void 0&&(u=tt.degToRad(i.OuterAngle.value),u=Math.max(u,1)),t=new cE(s,o,a,c,u,l);break;default:console.warn("THREE.FBXLoader: Unknown light type "+i.LightType.value+", defaulting to a PointLight."),t=new Q0(s,o);break}i.CastShadows!==void 0&&i.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,i){let n,s=null,o=null;const a=[];return e.children.forEach(function(l){t.has(l.ID)&&(s=t.get(l.ID)),i.has(l.ID)&&a.push(i.get(l.ID))}),a.length>1?o=a:a.length>0?o=a[0]:(o=new Uf({color:13421772}),a.push(o)),"color"in s.attributes&&a.forEach(function(l){l.vertexColors=!0}),s.FBX_Deformer?(n=new iA(s,o),n.normalizeSkinWeights()):n=new ze(s,o),n}createCurve(e,t){const i=e.children.reduce(function(s,o){return t.has(o.ID)&&(s=t.get(o.ID)),s},null),n=new ga({color:3342591,linewidth:1});return new bt(i,n)}getTransformData(e,t){const i={};"InheritType"in t&&(i.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?i.eulerOrder=$3(t.RotationOrder.value):i.eulerOrder="ZYX","Lcl_Translation"in t&&(i.translation=t.Lcl_Translation.value),"PreRotation"in t&&(i.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(i.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(i.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(i.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(i.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(i.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(i.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(i.rotationPivot=t.RotationPivot.value),e.userData.transformData=i}setLookAtProperties(e,t){"LookAtProperty"in t&&Ti.get(e.ID).children.forEach(function(n){if(n.relationship==="LookAtProperty"){const s=_t.Objects.Model[n.ID];if("Lcl_Translation"in s){const o=s.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(o),vn.add(e.target)):e.lookAt(new Q().fromArray(o))}}})}bindSkeleton(e,t,i){const n=this.parsePoseNodes();for(const s in e){const o=e[s];Ti.get(parseInt(o.ID)).parents.forEach(function(l){if(t.has(l.ID)){const c=l.ID;Ti.get(c).parents.forEach(function(h){i.has(h.ID)&&i.get(h.ID).bind(new fE(o.bones),n[h.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in _t.Objects){const t=_t.Objects.Pose;for(const i in t)if(t[i].attrType==="BindPose"&&t[i].NbPoseNodes>0){const n=t[i].PoseNode;Array.isArray(n)?n.forEach(function(s){e[s.Node]=new we().fromArray(s.Matrix.a)}):e[n.Node]=new we().fromArray(n.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in _t&&"AmbientColor"in _t.GlobalSettings){const e=_t.GlobalSettings.AmbientColor.value,t=e[0],i=e[1],n=e[2];if(t!==0||i!==0||n!==0){const s=new We(t,i,n);vn.add(new V4(s,1))}}}}class kw{parse(e){const t=new Map;if("Geometry"in _t.Objects){const i=_t.Objects.Geometry;for(const n in i){const s=Ti.get(parseInt(n)),o=this.parseGeometry(s,i[n],e);t.set(parseInt(n),o)}}return t}parseGeometry(e,t,i){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,i);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,i){const n=i.skeletons,s=[],o=e.parents.map(function(h){return _t.Objects.Model[h.ID]});if(o.length===0)return;const a=e.children.reduce(function(h,f){return n[f.ID]!==void 0&&(h=n[f.ID]),h},null);e.children.forEach(function(h){i.morphTargets[h.ID]!==void 0&&s.push(i.morphTargets[h.ID])});const l=o[0],c={};"RotationOrder"in l&&(c.eulerOrder=$3(l.RotationOrder.value)),"InheritType"in l&&(c.inheritType=parseInt(l.InheritType.value)),"GeometricTranslation"in l&&(c.translation=l.GeometricTranslation.value),"GeometricRotation"in l&&(c.rotation=l.GeometricRotation.value),"GeometricScaling"in l&&(c.scale=l.GeometricScaling.value);const u=K3(c);return this.genGeometry(t,a,s,u)}genGeometry(e,t,i,n){const s=new Gi;e.attrName&&(s.name=e.attrName);const o=this.parseGeoNode(e,t),a=this.genBuffers(o),l=new Yi(a.vertex,3);if(l.applyMatrix4(n),s.setAttribute("position",l),a.colors.length>0&&s.setAttribute("color",new Yi(a.colors,3)),t&&(s.setAttribute("skinIndex",new K4(a.weightsIndices,4)),s.setAttribute("skinWeight",new Yi(a.vertexWeights,4)),s.FBX_Deformer=t),a.normal.length>0){const c=new Fn().getNormalMatrix(n),u=new Yi(a.normal,3);u.applyNormalMatrix(c),s.setAttribute("normal",u)}if(a.uvs.forEach(function(c,u){bA==="uv2"&&u++;const h=u===0?"uv":`uv${u}`;s.setAttribute(h,new Yi(a.uvs[u],2))}),o.material&&o.material.mappingType!=="AllSame"){let c=a.materialIndex[0],u=0;if(a.materialIndex.forEach(function(h,f){h!==c&&(s.addGroup(u,f-u,c),c=h,u=f)}),s.groups.length>0){const h=s.groups[s.groups.length-1],f=h.start+h.count;f!==a.materialIndex.length&&s.addGroup(f,a.materialIndex.length-f,c)}s.groups.length===0&&s.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(s,e,i,n),s}parseGeoNode(e,t){const i={};if(i.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],i.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(i.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(i.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(i.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){i.uv=[];let n=0;for(;e.LayerElementUV[n];)e.LayerElementUV[n].UV&&i.uv.push(this.parseUVs(e.LayerElementUV[n])),n++}return i.weightTable={},t!==null&&(i.skeleton=t,t.rawBones.forEach(function(n,s){n.indices.forEach(function(o,a){i.weightTable[o]===void 0&&(i.weightTable[o]=[]),i.weightTable[o].push({id:s,weight:n.weights[a]})})})),i}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let i=0,n=0,s=!1,o=[],a=[],l=[],c=[],u=[],h=[];const f=this;return e.vertexIndices.forEach(function(d,m){let A,p=!1;d<0&&(d=d^-1,p=!0);let y=[],v=[];if(o.push(d*3,d*3+1,d*3+2),e.color){const E=Jc(m,i,d,e.color);l.push(E[0],E[1],E[2])}if(e.skeleton){if(e.weightTable[d]!==void 0&&e.weightTable[d].forEach(function(E){v.push(E.weight),y.push(E.id)}),v.length>4){s||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),s=!0);const E=[0,0,0,0],x=[0,0,0,0];v.forEach(function(I,C){let _=I,S=y[C];x.forEach(function(b,T,R){if(_>b){R[T]=_,_=b;const w=E[T];E[T]=S,S=w}})}),y=E,v=x}for(;v.length<4;)v.push(0),y.push(0);for(let E=0;E<4;++E)u.push(v[E]),h.push(y[E])}if(e.normal){const E=Jc(m,i,d,e.normal);a.push(E[0],E[1],E[2])}e.material&&e.material.mappingType!=="AllSame"&&(A=Jc(m,i,d,e.material)[0]),e.uv&&e.uv.forEach(function(E,x){const I=Jc(m,i,d,E);c[x]===void 0&&(c[x]=[]),c[x].push(I[0]),c[x].push(I[1])}),n++,p&&(f.genFace(t,e,o,A,a,l,c,u,h,n),i++,n=0,o=[],a=[],l=[],c=[],u=[],h=[])}),t}genFace(e,t,i,n,s,o,a,l,c,u){for(let h=2;h<u;h++)e.vertex.push(t.vertexPositions[i[0]]),e.vertex.push(t.vertexPositions[i[1]]),e.vertex.push(t.vertexPositions[i[2]]),e.vertex.push(t.vertexPositions[i[(h-1)*3]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+1]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+2]]),e.vertex.push(t.vertexPositions[i[h*3]]),e.vertex.push(t.vertexPositions[i[h*3+1]]),e.vertex.push(t.vertexPositions[i[h*3+2]]),t.skeleton&&(e.vertexWeights.push(l[0]),e.vertexWeights.push(l[1]),e.vertexWeights.push(l[2]),e.vertexWeights.push(l[3]),e.vertexWeights.push(l[(h-1)*4]),e.vertexWeights.push(l[(h-1)*4+1]),e.vertexWeights.push(l[(h-1)*4+2]),e.vertexWeights.push(l[(h-1)*4+3]),e.vertexWeights.push(l[h*4]),e.vertexWeights.push(l[h*4+1]),e.vertexWeights.push(l[h*4+2]),e.vertexWeights.push(l[h*4+3]),e.weightsIndices.push(c[0]),e.weightsIndices.push(c[1]),e.weightsIndices.push(c[2]),e.weightsIndices.push(c[3]),e.weightsIndices.push(c[(h-1)*4]),e.weightsIndices.push(c[(h-1)*4+1]),e.weightsIndices.push(c[(h-1)*4+2]),e.weightsIndices.push(c[(h-1)*4+3]),e.weightsIndices.push(c[h*4]),e.weightsIndices.push(c[h*4+1]),e.weightsIndices.push(c[h*4+2]),e.weightsIndices.push(c[h*4+3])),t.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[(h-1)*3]),e.colors.push(o[(h-1)*3+1]),e.colors.push(o[(h-1)*3+2]),e.colors.push(o[h*3]),e.colors.push(o[h*3+1]),e.colors.push(o[h*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(n),e.materialIndex.push(n),e.materialIndex.push(n)),t.normal&&(e.normal.push(s[0]),e.normal.push(s[1]),e.normal.push(s[2]),e.normal.push(s[(h-1)*3]),e.normal.push(s[(h-1)*3+1]),e.normal.push(s[(h-1)*3+2]),e.normal.push(s[h*3]),e.normal.push(s[h*3+1]),e.normal.push(s[h*3+2])),t.uv&&t.uv.forEach(function(f,d){e.uvs[d]===void 0&&(e.uvs[d]=[]),e.uvs[d].push(a[d][0]),e.uvs[d].push(a[d][1]),e.uvs[d].push(a[d][(h-1)*2]),e.uvs[d].push(a[d][(h-1)*2+1]),e.uvs[d].push(a[d][h*2]),e.uvs[d].push(a[d][h*2+1])})}addMorphTargets(e,t,i,n){if(i.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const s=this;i.forEach(function(o){o.rawTargets.forEach(function(a){const l=_t.Objects.Geometry[a.geoID];l!==void 0&&s.genMorphGeometry(e,t,l,n,a.name)})})}genMorphGeometry(e,t,i,n,s){const o=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],a=i.Vertices!==void 0?i.Vertices.a:[],l=i.Indexes!==void 0?i.Indexes.a:[],c=e.attributes.position.count*3,u=new Float32Array(c);for(let m=0;m<l.length;m++){const A=l[m]*3;u[A]=a[m*3],u[A+1]=a[m*3+1],u[A+2]=a[m*3+2]}const h={vertexIndices:o,vertexPositions:u},f=this.genBuffers(h),d=new Yi(f.vertex,3);d.name=s||i.attrName,d.applyMatrix4(n),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Normals.a;let s=[];return i==="IndexToDirect"&&("NormalIndex"in e?s=e.NormalIndex.a:"NormalsIndex"in e&&(s=e.NormalsIndex.a)),{dataSize:3,buffer:n,indices:s,mappingType:t,referenceType:i}}parseUVs(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.UV.a;let s=[];return i==="IndexToDirect"&&(s=e.UVIndex.a),{dataSize:2,buffer:n,indices:s,mappingType:t,referenceType:i}}parseVertexColors(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,n=e.Colors.a;let s=[];return i==="IndexToDirect"&&(s=e.ColorIndex.a),{dataSize:4,buffer:n,indices:s,mappingType:t,referenceType:i}}parseMaterialIndices(e){const t=e.MappingInformationType,i=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};const n=e.Materials.a,s=[];for(let o=0;o<n.length;++o)s.push(o);return{dataSize:1,buffer:n,indices:s,mappingType:t,referenceType:i}}parseNurbsGeometry(e){if(C1===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new Gi;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new Gi;const i=t-1,n=e.KnotVector.a,s=[],o=e.Points.a;for(let h=0,f=o.length;h<f;h+=4)s.push(new yi().fromArray(o,h));let a,l;if(e.Form==="Closed")s.push(s[0]);else if(e.Form==="Periodic"){a=i,l=n.length-1-a;for(let h=0;h<i;++h)s.push(s[h])}const u=new C1(i,n,s,a,l).getPoints(s.length*12);return new Gi().setFromPoints(u)}}class Ow{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const i in t){const n=t[i],s=this.addClip(n);e.push(s)}return e}parseClips(){if(_t.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=_t.Objects.AnimationCurveNode,t=new Map;for(const i in e){const n=e[i];if(n.attrName.match(/S|R|T|DeformPercent/)!==null){const s={id:n.id,attr:n.attrName,curves:{}};t.set(s.id,s)}}return t}parseAnimationCurves(e){const t=_t.Objects.AnimationCurve;for(const i in t){const n={id:t[i].id,times:t[i].KeyTime.a.map(zw),values:t[i].KeyValueFloat.a},s=Ti.get(n.id);if(s!==void 0){const o=s.parents[0].ID,a=s.parents[0].relationship;a.match(/X/)?e.get(o).curves.x=n:a.match(/Y/)?e.get(o).curves.y=n:a.match(/Z/)?e.get(o).curves.z=n:a.match(/d|DeformPercent/)&&e.has(o)&&(e.get(o).curves.morph=n)}}}parseAnimationLayers(e){const t=_t.Objects.AnimationLayer,i=new Map;for(const n in t){const s=[],o=Ti.get(parseInt(n));o!==void 0&&(o.children.forEach(function(l,c){if(e.has(l.ID)){const u=e.get(l.ID);if(u.curves.x!==void 0||u.curves.y!==void 0||u.curves.z!==void 0){if(s[c]===void 0){const h=Ti.get(l.ID).parents.filter(function(f){return f.relationship!==void 0})[0].ID;if(h!==void 0){const f=_t.Objects.Model[h.toString()];if(f===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",l);return}const d={modelName:f.attrName?ac.sanitizeNodeName(f.attrName):"",ID:f.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};vn.traverse(function(m){m.ID===f.id&&(d.transform=m.matrix,m.userData.transformData&&(d.eulerOrder=m.userData.transformData.eulerOrder))}),d.transform||(d.transform=new we),"PreRotation"in f&&(d.preRotation=f.PreRotation.value),"PostRotation"in f&&(d.postRotation=f.PostRotation.value),s[c]=d}}s[c]&&(s[c][u.attr]=u)}else if(u.curves.morph!==void 0){if(s[c]===void 0){const h=Ti.get(l.ID).parents.filter(function(y){return y.relationship!==void 0})[0].ID,f=Ti.get(h).parents[0].ID,d=Ti.get(f).parents[0].ID,m=Ti.get(d).parents[0].ID,A=_t.Objects.Model[m],p={modelName:A.attrName?ac.sanitizeNodeName(A.attrName):"",morphName:_t.Objects.Deformer[h].attrName};s[c]=p}s[c][u.attr]=u}}}),i.set(parseInt(n),s))}return i}parseAnimStacks(e){const t=_t.Objects.AnimationStack,i={};for(const n in t){const s=Ti.get(parseInt(n)).children;s.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(s[0].ID);i[n]={name:t[n].attrName,layer:o}}return i}addClip(e){let t=[];const i=this;return e.layer.forEach(function(n){t=t.concat(i.generateTracks(n))}),new eA(e.name,-1,t)}generateTracks(e){const t=[];let i=new Q,n=new st,s=new Q;if(e.transform&&e.transform.decompose(i,n,s),i=i.toArray(),n=new kn().setFromQuaternion(n,e.eulerOrder).toArray(),s=s.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,i,"position");o!==void 0&&t.push(o)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const o=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder);o!==void 0&&t.push(o)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.S.curves,s,"scale");o!==void 0&&t.push(o)}if(e.DeformPercent!==void 0){const o=this.generateMorphTrack(e);o!==void 0&&t.push(o)}return t}generateVectorTrack(e,t,i,n){const s=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(s,t,i);return new yh(e+"."+n,s,o)}generateRotationTrack(e,t,i,n,s,o){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(tt.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(tt.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(tt.degToRad));const a=this.getTimesForAllAxes(t),l=this.getKeyframeTrackValues(a,t,i);n!==void 0&&(n=n.map(tt.degToRad),n.push(o),n=new kn().fromArray(n),n=new st().setFromEuler(n)),s!==void 0&&(s=s.map(tt.degToRad),s.push(o),s=new kn().fromArray(s),s=new st().setFromEuler(s).invert());const c=new st,u=new kn,h=[];for(let f=0;f<l.length;f+=3)u.set(l[f],l[f+1],l[f+2],o),c.setFromEuler(u),n!==void 0&&c.premultiply(n),s!==void 0&&c.multiply(s),c.toArray(h,f/3*4);return new vh(e+".quaternion",a,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,i=t.values.map(function(s){return s/100}),n=vn.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new H0(e.modelName+".morphTargetInfluences["+n+"]",t.times,i)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(i,n){return i-n}),t.length>1){let i=1,n=t[0];for(let s=1;s<t.length;s++){const o=t[s];o!==n&&(t[i]=o,n=o,i++)}t=t.slice(0,i)}return t}getKeyframeTrackValues(e,t,i){const n=i,s=[];let o=-1,a=-1,l=-1;return e.forEach(function(c){if(t.x&&(o=t.x.times.indexOf(c)),t.y&&(a=t.y.times.indexOf(c)),t.z&&(l=t.z.times.indexOf(c)),o!==-1){const u=t.x.values[o];s.push(u),n[0]=u}else s.push(n[0]);if(a!==-1){const u=t.y.values[a];s.push(u),n[1]=u}else s.push(n[1]);if(l!==-1){const u=t.z.values[l];s.push(u),n[2]=u}else s.push(n[2])}),s}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const i=e.values[t-1],n=e.values[t]-i,s=Math.abs(n);if(s>=180){const o=s/180,a=n/o;let l=i+a;const c=e.times[t-1],h=(e.times[t]-c)/o;let f=c+h;const d=[],m=[];for(;f<e.times[t];)d.push(f),f+=h,m.push(l),l+=a;e.times=T1(e.times,t,d),e.values=T1(e.values,t,m)}}}}class Uw{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new V3,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,i=e.split(/[\r\n]+/);return i.forEach(function(n,s){const o=n.match(/^[\s\t]*;/),a=n.match(/^[\s\t]*$/);if(o||a)return;const l=n.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),c=n.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),u=n.match("^\\t{"+(t.currentIndent-1)+"}}");l?t.parseNodeBegin(n,l):c?t.parseNodeProperty(n,c,i[++s]):u?t.popStack():n.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(n)}),this.allNodes}parseNodeBegin(e,t){const i=t[1].trim().replace(/^"/,"").replace(/"$/,""),n=t[2].split(",").map(function(l){return l.trim().replace(/^"/,"").replace(/"$/,"")}),s={name:i},o=this.parseNodeAttr(n),a=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(i,s):i in a?(i==="PoseNode"?a.PoseNode.push(s):a[i].id!==void 0&&(a[i]={},a[i][a[i].id]=a[i]),o.id!==""&&(a[i][o.id]=s)):typeof o.id=="number"?(a[i]={},a[i][o.id]=s):i!=="Properties70"&&(i==="PoseNode"?a[i]=[s]:a[i]=s),typeof o.id=="number"&&(s.id=o.id),o.name!==""&&(s.attrName=o.name),o.type!==""&&(s.attrType=o.type),this.pushStack(s)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let i="",n="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),n=e[2]),{id:t,name:i,type:n}}parseNodeProperty(e,t,i){let n=t[1].replace(/^"/,"").replace(/"$/,"").trim(),s=t[2].replace(/^"/,"").replace(/"$/,"").trim();n==="Content"&&s===","&&(s=i.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if(o.name==="Properties70"){this.parseNodeSpecialProperty(e,n,s);return}if(n==="C"){const l=s.split(",").slice(1),c=parseInt(l[0]),u=parseInt(l[1]);let h=s.split(",").slice(3);h=h.map(function(f){return f.trim().replace(/^"/,"")}),n="connections",s=[c,u],Vw(s,h),o[n]===void 0&&(o[n]=[])}n==="Node"&&(o.id=s),n in o&&Array.isArray(o[n])?o[n].push(s):n!=="a"?o[n]=s:o.a=s,this.setCurrentProp(o,n),n==="a"&&s.slice(-1)!==","&&(o.a=od(s))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=od(t.a))}parseNodeSpecialProperty(e,t,i){const n=i.split('",').map(function(u){return u.trim().replace(/^\"/,"").replace(/\s/,"_")}),s=n[0],o=n[1],a=n[2],l=n[3];let c=n[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":c=parseFloat(c);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":c=od(c);break}this.getPrevNode()[s]={type:o,type2:a,flag:l,value:c},this.setCurrentProp(this.getPrevNode(),s)}}class Nw{parse(e){const t=new _1(e);t.skip(23);const i=t.getUint32();if(i<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+i);const n=new V3;for(;!this.endOfContent(t);){const s=this.parseNode(t,i);s!==null&&n.add(s.name,s)}return n}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const i={},n=t>=7500?e.getUint64():e.getUint32(),s=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),a=e.getString(o);if(n===0)return null;const l=[];for(let f=0;f<s;f++)l.push(this.parseProperty(e));const c=l.length>0?l[0]:"",u=l.length>1?l[1]:"",h=l.length>2?l[2]:"";for(i.singleProperty=s===1&&e.getOffset()===n;n>e.getOffset();){const f=this.parseNode(e,t);f!==null&&this.parseSubNode(a,i,f)}return i.propertyList=l,typeof c=="number"&&(i.id=c),u!==""&&(i.attrName=u),h!==""&&(i.attrType=h),a!==""&&(i.name=a),i}parseSubNode(e,t,i){if(i.singleProperty===!0){const n=i.propertyList[0];Array.isArray(n)?(t[i.name]=i,i.a=n):t[i.name]=n}else if(e==="Connections"&&i.name==="C"){const n=[];i.propertyList.forEach(function(s,o){o!==0&&n.push(s)}),t.connections===void 0&&(t.connections=[]),t.connections.push(n)}else if(i.name==="Properties70")Object.keys(i).forEach(function(s){t[s]=i[s]});else if(e==="Properties70"&&i.name==="P"){let n=i.propertyList[0],s=i.propertyList[1];const o=i.propertyList[2],a=i.propertyList[3];let l;n.indexOf("Lcl ")===0&&(n=n.replace("Lcl ","Lcl_")),s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),s==="Color"||s==="ColorRGB"||s==="Vector"||s==="Vector3D"||s.indexOf("Lcl_")===0?l=[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:l=i.propertyList[4],t[n]={type:s,type2:o,flag:a,value:l}}else t[i.name]===void 0?typeof i.id=="number"?(t[i.name]={},t[i.name][i.id]=i):t[i.name]=i:i.name==="PoseNode"?(Array.isArray(t[i.name])||(t[i.name]=[t[i.name]]),t[i.name].push(i)):t[i.name][i.id]===void 0&&(t[i.name][i.id]=i)}parseProperty(e){const t=e.getString(1);let i;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return i=e.getUint32(),e.getArrayBuffer(i);case"S":return i=e.getUint32(),e.getString(i);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const n=e.getUint32(),s=e.getUint32(),o=e.getUint32();if(s===0)switch(t){case"b":case"c":return e.getBooleanArray(n);case"d":return e.getFloat64Array(n);case"f":return e.getFloat32Array(n);case"i":return e.getInt32Array(n);case"l":return e.getInt64Array(n)}const a=Gl(new Uint8Array(e.getArrayBuffer(o))),l=new _1(a.buffer);switch(t){case"b":case"c":return l.getBooleanArray(n);case"d":return l.getFloat64Array(n);case"f":return l.getFloat32Array(n);case"i":return l.getInt32Array(n);case"l":return l.getInt64Array(n)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class _1{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let i=0;i<e;i++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let n=0;n<e;n++)t[n]=this.getUint8();const i=t.indexOf(0);return i>=0&&(t=t.slice(0,i)),La(new Uint8Array(t))}}class V3{add(e,t){this[e]=t}}function Gw(r){const e="Kaydara FBX Binary  \0";return r.byteLength>=e.length&&e===Y3(r,0,e.length)}function Qw(r){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function i(n){const s=r[n-1];return r=r.slice(t+n),t++,s}for(let n=0;n<e.length;++n)if(i(1)===e[n])return!1;return!0}function S1(r){const e=/FBXVersion: (\d+)/,t=r.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function zw(r){return r/46186158e3}const Hw=[];function Jc(r,e,t,i){let n;switch(i.mappingType){case"ByPolygonVertex":n=r;break;case"ByPolygon":n=e;break;case"ByVertice":n=t;break;case"AllSame":n=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}i.referenceType==="IndexToDirect"&&(n=i.indices[n]);const s=n*i.dataSize,o=s+i.dataSize;return Kw(Hw,i.buffer,s,o)}const rd=new kn,Lo=new Q;function K3(r){const e=new we,t=new we,i=new we,n=new we,s=new we,o=new we,a=new we,l=new we,c=new we,u=new we,h=new we,f=new we,d=r.inheritType?r.inheritType:0;if(r.translation&&e.setPosition(Lo.fromArray(r.translation)),r.preRotation){const T=r.preRotation.map(tt.degToRad);T.push(r.eulerOrder),t.makeRotationFromEuler(rd.fromArray(T))}if(r.rotation){const T=r.rotation.map(tt.degToRad);T.push(r.eulerOrder),i.makeRotationFromEuler(rd.fromArray(T))}if(r.postRotation){const T=r.postRotation.map(tt.degToRad);T.push(r.eulerOrder),n.makeRotationFromEuler(rd.fromArray(T)),n.invert()}r.scale&&s.scale(Lo.fromArray(r.scale)),r.scalingOffset&&a.setPosition(Lo.fromArray(r.scalingOffset)),r.scalingPivot&&o.setPosition(Lo.fromArray(r.scalingPivot)),r.rotationOffset&&l.setPosition(Lo.fromArray(r.rotationOffset)),r.rotationPivot&&c.setPosition(Lo.fromArray(r.rotationPivot)),r.parentMatrixWorld&&(h.copy(r.parentMatrix),u.copy(r.parentMatrixWorld));const m=t.clone().multiply(i).multiply(n),A=new we;A.extractRotation(u);const p=new we;p.copyPosition(u);const y=p.clone().invert().multiply(u),v=A.clone().invert().multiply(y),E=s,x=new we;if(d===0)x.copy(A).multiply(m).multiply(v).multiply(E);else if(d===1)x.copy(A).multiply(v).multiply(m).multiply(E);else{const R=new we().scale(new Q().setFromMatrixScale(h)).clone().invert(),w=v.clone().multiply(R);x.copy(A).multiply(m).multiply(w).multiply(E)}const I=c.clone().invert(),C=o.clone().invert();let _=e.clone().multiply(l).multiply(c).multiply(t).multiply(i).multiply(n).multiply(I).multiply(a).multiply(o).multiply(s).multiply(C);const S=new we().copyPosition(_),b=u.clone().multiply(S);return f.copyPosition(b),_=f.clone().multiply(x),_.premultiply(u.invert()),_}function $3(r){r=r||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return r===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[r]}function od(r){return r.split(",").map(function(t){return parseFloat(t)})}function Y3(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=r.byteLength),La(new Uint8Array(r,e,t))}function Vw(r,e){for(let t=0,i=r.length,n=e.length;t<n;t++,i++)r[i]=e[t]}function Kw(r,e,t,i){for(let n=t,s=0;n<i;n++,s++)r[s]=e[n];return r}function T1(r,e,t){return r.slice(0,e).concat(t).concat(r.slice(e))}var $w=Object.defineProperty,Yw=(r,e,t)=>e in r?$w(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,ad=(r,e,t)=>(Yw(r,typeof e!="symbol"?e+"":e,t),t);class Ww extends Yr{constructor(e){super(e)}load(e,t,i,n){const s=new Sn(this.manager);s.setPath(this.path),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,o=>{if(typeof o!="string")throw new Error("unsupported data type");const a=JSON.parse(o),l=this.parse(a);t&&t(l)},i,n)}loadAsync(e,t){return super.loadAsync(e,t)}parse(e){return new jw(e)}}class jw{constructor(e){ad(this,"data"),ad(this,"isFont",!0),ad(this,"type","Font"),this.data=e}generateShapes(e,t=100,i){const n=[],s={letterSpacing:0,lineHeight:1,...i},o=qw(e,t,this.data,s);for(let a=0,l=o.length;a<l;a++)Array.prototype.push.apply(n,o[a].toShapes(!1));return n}}function qw(r,e,t,i){const n=Array.from(r),s=e/t.resolution,o=(t.boundingBox.yMax-t.boundingBox.yMin+t.underlineThickness)*s,a=[];let l=0,c=0;for(let u=0;u<n.length;u++){const h=n[u];if(h===`
`)l=0,c-=o*i.lineHeight;else{const f=Xw(h,s,l,c,t);f&&(l+=f.offsetX+i.letterSpacing,a.push(f.path))}}return a}function Xw(r,e,t,i,n){const s=n.glyphs[r]||n.glyphs["?"];if(!s){console.error('THREE.Font: character "'+r+'" does not exists in font family '+n.familyName+".");return}const o=new Rr;let a,l,c,u,h,f,d,m;if(s.o){const A=s._cachedOutline||(s._cachedOutline=s.o.split(" "));for(let p=0,y=A.length;p<y;)switch(A[p++]){case"m":a=parseInt(A[p++])*e+t,l=parseInt(A[p++])*e+i,o.moveTo(a,l);break;case"l":a=parseInt(A[p++])*e+t,l=parseInt(A[p++])*e+i,o.lineTo(a,l);break;case"q":c=parseInt(A[p++])*e+t,u=parseInt(A[p++])*e+i,h=parseInt(A[p++])*e+t,f=parseInt(A[p++])*e+i,o.quadraticCurveTo(h,f,c,u);break;case"b":c=parseInt(A[p++])*e+t,u=parseInt(A[p++])*e+i,h=parseInt(A[p++])*e+t,f=parseInt(A[p++])*e+i,d=parseInt(A[p++])*e+t,m=parseInt(A[p++])*e+i,o.bezierCurveTo(h,f,d,m,c,u);break}}return{offsetX:s.ha*e,path:o}}class Jw extends tn{constructor(e=null,t=1,i=1,n=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:n},this.magFilter=ei,this.minFilter=ei,this.wrapR=On,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Zw{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:n,msg:s,transfer:o}=this.queue.shift();this.workersResolve[e]=n,this.workers[e].postMessage(s,o)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(i=>{const n=this._getIdleWorker();n!==-1?(this._initWorker(n),this.workerStatus|=1<<n,this.workersResolve[n]=i,this.workers[n].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const W3=0,b1=2,e8=0,t8=0,i8=2,n8=0,s8=0,r8=1,pm=2,o8=0,j3=1,a8=10,l8=64,q3=0,X3=9,J3=15,Z3=16,ex=22,tx=37,ix=43,nx=76,sx=83,rx=97,ox=100,ax=103,lx=109,cx=165,ux=166;class c8{constructor(){this.vkFormat=q3,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=W3,this.levels=[],this.dataFormatDescriptor=[{vendorId:t8,descriptorType:e8,descriptorBlockSize:0,versionNumber:i8,colorModel:n8,colorPrimaries:j3,transferFunction:pm,flags:s8,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class Al{constructor(e,t,i,n){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,i),this._littleEndian=n,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),i=e+2**32*t;return this._offset+=8,i}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){t===void 0&&(t=0);const i=this._offset;let n=0;for(;this._dataView.getUint8(this._offset)!==t&&n<e;)n++,this._offset++;return n<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,n)}}const on=[171,75,84,88,32,50,48,187,13,10,26,10];function w1(r){return typeof TextDecoder<"u"?new TextDecoder().decode(r):Buffer.from(r).toString("utf8")}function u8(r){const e=new Uint8Array(r.buffer,r.byteOffset,on.length);if(e[0]!==on[0]||e[1]!==on[1]||e[2]!==on[2]||e[3]!==on[3]||e[4]!==on[4]||e[5]!==on[5]||e[6]!==on[6]||e[7]!==on[7]||e[8]!==on[8]||e[9]!==on[9]||e[10]!==on[10]||e[11]!==on[11])throw new Error("Missing KTX 2.0 identifier.");const t=new c8,i=17*Uint32Array.BYTES_PER_ELEMENT,n=new Al(r,on.length,i,!0);t.vkFormat=n._nextUint32(),t.typeSize=n._nextUint32(),t.pixelWidth=n._nextUint32(),t.pixelHeight=n._nextUint32(),t.pixelDepth=n._nextUint32(),t.layerCount=n._nextUint32(),t.faceCount=n._nextUint32();const s=n._nextUint32();t.supercompressionScheme=n._nextUint32();const o=n._nextUint32(),a=n._nextUint32(),l=n._nextUint32(),c=n._nextUint32(),u=n._nextUint64(),h=n._nextUint64(),f=s*3*8,d=new Al(r,on.length+i,f,!0);for(let K=0;K<s;K++)t.levels.push({levelData:new Uint8Array(r.buffer,r.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const m=new Al(r,o,a,!0),A={vendorId:m._skip(4)._nextUint16(),descriptorType:m._nextUint16(),versionNumber:m._nextUint16(),descriptorBlockSize:m._nextUint16(),colorModel:m._nextUint8(),colorPrimaries:m._nextUint8(),transferFunction:m._nextUint8(),flags:m._nextUint8(),texelBlockDimension:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],bytesPlane:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],samples:[]},v=(A.descriptorBlockSize/4-6)/4;for(let K=0;K<v;K++){const D={bitOffset:m._nextUint16(),bitLength:m._nextUint8(),channelType:m._nextUint8(),samplePosition:[m._nextUint8(),m._nextUint8(),m._nextUint8(),m._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};D.channelType&l8?(D.sampleLower=m._nextInt32(),D.sampleUpper=m._nextInt32()):(D.sampleLower=m._nextUint32(),D.sampleUpper=m._nextUint32()),A.samples[K]=D}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(A);const E=new Al(r,l,c,!0);for(;E._offset<c;){const K=E._nextUint32(),D=E._scan(K),z=w1(D);if(t.keyValue[z]=E._nextUint8Array(K-D.byteLength-1),z.match(/^ktx/i)){const V=w1(t.keyValue[z]);t.keyValue[z]=V.substring(0,V.lastIndexOf("\0"))}const $=K%4?4-K%4:0;E._skip($)}if(h<=0)return t;const x=new Al(r,u,h,!0),I=x._nextUint16(),C=x._nextUint16(),_=x._nextUint32(),S=x._nextUint32(),b=x._nextUint32(),T=x._nextUint32(),R=[];for(let K=0;K<s;K++)R.push({imageFlags:x._nextUint32(),rgbSliceByteOffset:x._nextUint32(),rgbSliceByteLength:x._nextUint32(),alphaSliceByteOffset:x._nextUint32(),alphaSliceByteLength:x._nextUint32()});const w=u+x._offset,B=w+_,M=B+S,O=M+b,U=new Uint8Array(r.buffer,r.byteOffset+w,_),Y=new Uint8Array(r.buffer,r.byteOffset+B,S),W=new Uint8Array(r.buffer,r.byteOffset+M,b),N=new Uint8Array(r.buffer,r.byteOffset+O,T);return t.globalData={endpointCount:I,selectorCount:C,imageDescs:R,endpointsData:U,selectorsData:Y,tablesData:W,extendedData:N},t}let pl,or,gm;const ld={env:{emscripten_notify_memory_growth:function(r){gm=new Uint8Array(or.exports.memory.buffer)}}};class h8{init(){return pl||(typeof fetch<"u"?pl=fetch("data:application/wasm;base64,"+B1).then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,ld)).then(this._init):pl=WebAssembly.instantiate(Buffer.from(B1,"base64"),ld).then(this._init),pl)}_init(e){or=e.instance,ld.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!or)throw new Error("ZSTDDecoder: Await .init() before decoding.");const i=e.byteLength,n=or.exports.malloc(i);gm.set(e,n),t=t||Number(or.exports.ZSTD_findDecompressedSize(n,i));const s=or.exports.malloc(t),o=or.exports.ZSTD_decompress(s,t,n,i),a=gm.slice(s,s+o);return or.exports.free(n),or.exports.free(s),a}}const B1="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ";class f8 extends Wh{constructor(e,t,i){super(void 0,e[0].width,e[0].height,t,i,pE),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class d8 extends Wh{constructor(e,t,i,n,s,o){super(e,t,i,s,o),this.isCompressedArrayTexture=!0,this.image.depth=n,this.wrapR=On}}var m8=Object.defineProperty,A8=(r,e,t)=>e in r?m8(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Zc=(r,e,t)=>(A8(r,typeof e!="symbol"?e+"":e,t),t);const hx=3e3,fx=3001,R1="",p8="display-p3",g8="display-p3-linear",y8="srgb-linear",RA="srgb",cd=new WeakMap;let ud=0,hd;const DA=(()=>{const r=class extends Yr{constructor(t){super(t),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new Zw,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(t){return this.transcoderPath=t,this}setWorkerLimit(t){return this.workerPool.setWorkerLimit(t),this}detectSupport(t){return this.workerConfig={astcSupported:t.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:t.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:t.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:t.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:t.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:t.extensions.has("WEBGL_compressed_texture_pvrtc")||t.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},t.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){const t=new Sn(this.manager);t.setPath(this.transcoderPath),t.setWithCredentials(this.withCredentials);const i=t.loadAsync("basis_transcoder.js"),n=new Sn(this.manager);n.setPath(this.transcoderPath),n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);const s=n.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([i,s]).then(([o,a])=>{const l=r.BasisWorker.toString(),c=["/* constants */","let _EngineFormat = "+JSON.stringify(r.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(r.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(r.BasisFormat),"/* basis_transcoder.js */",o,"/* worker */",l.substring(l.indexOf("{")+1,l.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([c])),this.transcoderBinary=a,this.workerPool.setWorkerCreator(()=>{const u=new Worker(this.workerSourceURL),h=this.transcoderBinary.slice(0);return u.postMessage({type:"init",config:this.workerConfig,transcoderBinary:h},[h]),u})}),ud>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),ud++}return this.transcoderPending}load(t,i,n,s){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const o=new Sn(this.manager);o.setResponseType("arraybuffer"),o.setWithCredentials(this.withCredentials),o.load(t,a=>{if(cd.has(a))return cd.get(a).promise.then(i).catch(s);this._createTexture(a).then(l=>i?i(l):null).catch(s)},n,s)}_createTextureFrom(t,i){const{faces:n,width:s,height:o,format:a,type:l,error:c,dfdFlags:u}=t;if(l==="error")return Promise.reject(c);let h;if(i.faceCount===6)h=new f8(n,a,$i);else{const d=n[0].mipmaps;h=i.layerCount>1?new d8(d,s,o,i.layerCount,a,$i):new Wh(d,s,o,a,$i)}h.minFilter=n[0].mipmaps.length===1?Nt:Cc,h.magFilter=Nt,h.generateMipmaps=!1,h.needsUpdate=!0;const f=dx(i);return"colorSpace"in h?h.colorSpace=f:h.encoding=f===RA?fx:hx,h.premultiplyAlpha=!!(u&r8),h}async _createTexture(t,i={}){const n=u8(new Uint8Array(t));if(n.vkFormat!==q3)return E8(n);const s=i,o=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:t,taskConfig:s},[t])).then(a=>this._createTextureFrom(a.data,n));return cd.set(t,{promise:o}),o}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),ud--,this}};let e=r;return Zc(e,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),Zc(e,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),Zc(e,"EngineFormat",{RGBAFormat:Di,RGBA_ASTC_4x4_Format:e_,RGBA_BPTC_Format:Z4,RGBA_ETC2_EAC_Format:J4,RGBA_PVRTC_4BPPV1_Format:X4,RGBA_S3TC_DXT5_Format:q4,RGB_ETC1_Format:j4,RGB_ETC2_Format:W4,RGB_PVRTC_4BPPV1_Format:Y4,RGB_S3TC_DXT1_Format:$4}),Zc(e,"BasisWorker",function(){let t,i,n;const s=_EngineFormat,o=_TranscoderFormat,a=_BasisFormat;self.addEventListener("message",function(p){const y=p.data;switch(y.type){case"init":t=y.config,l(y.transcoderBinary);break;case"transcode":i.then(()=>{try{const{faces:v,buffers:E,width:x,height:I,hasAlpha:C,format:_,dfdFlags:S}=c(y.buffer);self.postMessage({type:"transcode",id:y.id,faces:v,width:x,height:I,hasAlpha:C,format:_,dfdFlags:S},E)}catch(v){console.error(v),self.postMessage({type:"error",id:y.id,error:v.message})}});break}});function l(p){i=new Promise(y=>{n={wasmBinary:p,onRuntimeInitialized:y},BASIS(n)}).then(()=>{n.initializeBasis(),n.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function c(p){const y=new n.KTX2File(new Uint8Array(p));function v(){y.close(),y.delete()}if(!y.isValid())throw v(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");const E=y.isUASTC()?a.UASTC_4x4:a.ETC1S,x=y.getWidth(),I=y.getHeight(),C=y.getLayers()||1,_=y.getLevels(),S=y.getFaces(),b=y.getHasAlpha(),T=y.getDFDFlags(),{transcoderFormat:R,engineFormat:w}=d(E,x,I,b);if(!x||!I||!_)throw v(),new Error("THREE.KTX2Loader:	Invalid texture");if(!y.startTranscoding())throw v(),new Error("THREE.KTX2Loader: .startTranscoding failed");const B=[],M=[];for(let O=0;O<S;O++){const U=[];for(let Y=0;Y<_;Y++){const W=[];let N,K;for(let z=0;z<C;z++){const $=y.getImageLevelInfo(Y,z,O);O===0&&Y===0&&z===0&&($.origWidth%4!==0||$.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),_>1?(N=$.origWidth,K=$.origHeight):(N=$.width,K=$.height);const V=new Uint8Array(y.getImageTranscodedSizeInBytes(Y,z,0,R));if(!y.transcodeImage(V,Y,z,O,R,0,-1,-1))throw v(),new Error("THREE.KTX2Loader: .transcodeImage failed.");W.push(V)}const D=A(W);U.push({data:D,width:N,height:K}),M.push(D.buffer)}B.push({mipmaps:U,width:x,height:I,format:w})}return v(),{faces:B,buffers:M,width:x,height:I,hasAlpha:b,format:w,dfdFlags:T}}const u=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[o.ASTC_4x4,o.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.BC7_M5,o.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.BC1,o.BC3],engineFormat:[s.RGB_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.ETC1,o.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.ETC1],engineFormat:[s.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[o.PVRTC1_4_RGB,o.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],h=u.sort(function(p,y){return p.priorityETC1S-y.priorityETC1S}),f=u.sort(function(p,y){return p.priorityUASTC-y.priorityUASTC});function d(p,y,v,E){let x,I;const C=p===a.ETC1S?h:f;for(let _=0;_<C.length;_++){const S=C[_];if(t[S.if]&&S.basisFormat.includes(p)&&!(E&&S.transcoderFormat.length<2)&&!(S.needsPowerOfTwo&&!(m(y)&&m(v))))return x=S.transcoderFormat[E?1:0],I=S.engineFormat[E?1:0],{transcoderFormat:x,engineFormat:I}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),x=o.RGBA32,I=s.RGBAFormat,{transcoderFormat:x,engineFormat:I}}function m(p){return p<=2?!0:(p&p-1)===0&&p!==0}function A(p){if(p.length===1)return p[0];let y=0;for(let x=0;x<p.length;x++){const I=p[x];y+=I.byteLength}const v=new Uint8Array(y);let E=0;for(let x=0;x<p.length;x++){const I=p[x];v.set(I,E),E+=I.byteLength}return v}}),e})(),v8=new Set([Di,fa,Vs]),fd={[lx]:Di,[rx]:Di,[tx]:Di,[ix]:Di,[ax]:fa,[sx]:fa,[Z3]:fa,[ex]:fa,[ox]:Vs,[nx]:Vs,[J3]:Vs,[X3]:Vs,[ux]:Np,[cx]:Np},dd={[lx]:ri,[rx]:ui,[tx]:$i,[ix]:$i,[ax]:ri,[sx]:ui,[Z3]:$i,[ex]:$i,[ox]:ri,[nx]:ui,[J3]:$i,[X3]:$i,[ux]:$i,[cx]:$i};async function E8(r){const{vkFormat:e}=r;if(fd[e]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let t;r.supercompressionScheme===b1&&(hd||(hd=new Promise(async o=>{const a=new h8;await a.init(),o(a)})),t=await hd);const i=[];for(let o=0;o<r.levels.length;o++){const a=Math.max(1,r.pixelWidth>>o),l=Math.max(1,r.pixelHeight>>o),c=r.pixelDepth?Math.max(1,r.pixelDepth>>o):0,u=r.levels[o];let h;if(r.supercompressionScheme===W3)h=u.levelData;else if(r.supercompressionScheme===b1)h=t.decode(u.levelData,u.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let f;dd[e]===ri?f=new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):dd[e]===ui?f=new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):f=h,i.push({data:f,width:a,height:l,depth:c})}let n;if(v8.has(fd[e]))n=r.pixelDepth===0?new Vr(i[0].data,r.pixelWidth,r.pixelHeight):new Jw(i[0].data,r.pixelWidth,r.pixelHeight,r.pixelDepth);else{if(r.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");n=new Wh(i,r.pixelWidth,r.pixelHeight)}n.mipmaps=i,n.type=dd[e],n.format=fd[e],n.needsUpdate=!0;const s=dx(r);return"colorSpace"in n?n.colorSpace=s:n.encoding=s===RA?fx:hx,Promise.resolve(n)}function dx(r){const e=r.dataFormatDescriptor[0];return e.colorPrimaries===j3?e.transferFunction===pm?RA:y8:e.colorPrimaries===a8?e.transferFunction===pm?p8:g8:(e.colorPrimaries===o8||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${e.colorPrimaries}"`),R1)}class x8 extends gE{constructor(e){super(e),this.type=ui}parse(e){const o=function(S,b){switch(S){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(b||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(b||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(b||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(b||""))}},h=function(S,b,T){b=b||1024;let w=S.pos,B=-1,M=0,O="",U=String.fromCharCode.apply(null,new Uint16Array(S.subarray(w,w+128)));for(;0>(B=U.indexOf(`
`))&&M<b&&w<S.byteLength;)O+=U,M+=U.length,w+=128,U+=String.fromCharCode.apply(null,new Uint16Array(S.subarray(w,w+128)));return-1<B?(S.pos+=M+B+1,O+U.slice(0,B)):!1},f=function(S){const b=/^#\?(\S+)/,T=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,R=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,w=/^\s*FORMAT=(\S+)\s*$/,B=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,M={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let O,U;for((S.pos>=S.byteLength||!(O=h(S)))&&o(1,"no header found"),(U=O.match(b))||o(3,"bad initial token"),M.valid|=1,M.programtype=U[1],M.string+=O+`
`;O=h(S),O!==!1;){if(M.string+=O+`
`,O.charAt(0)==="#"){M.comments+=O+`
`;continue}if((U=O.match(T))&&(M.gamma=parseFloat(U[1])),(U=O.match(R))&&(M.exposure=parseFloat(U[1])),(U=O.match(w))&&(M.valid|=2,M.format=U[1]),(U=O.match(B))&&(M.valid|=4,M.height=parseInt(U[1],10),M.width=parseInt(U[2],10)),M.valid&2&&M.valid&4)break}return M.valid&2||o(3,"missing format specifier"),M.valid&4||o(3,"missing image size specifier"),M},d=function(S,b,T){const R=b;if(R<8||R>32767||S[0]!==2||S[1]!==2||S[2]&128)return new Uint8Array(S);R!==(S[2]<<8|S[3])&&o(3,"wrong scanline width");const w=new Uint8Array(4*b*T);w.length||o(4,"unable to allocate buffer space");let B=0,M=0;const O=4*R,U=new Uint8Array(4),Y=new Uint8Array(O);let W=T;for(;W>0&&M<S.byteLength;){M+4>S.byteLength&&o(1),U[0]=S[M++],U[1]=S[M++],U[2]=S[M++],U[3]=S[M++],(U[0]!=2||U[1]!=2||(U[2]<<8|U[3])!=R)&&o(3,"bad rgbe scanline format");let N=0,K;for(;N<O&&M<S.byteLength;){K=S[M++];const z=K>128;if(z&&(K-=128),(K===0||N+K>O)&&o(3,"bad scanline data"),z){const $=S[M++];for(let V=0;V<K;V++)Y[N++]=$}else Y.set(S.subarray(M,M+K),N),N+=K,M+=K}const D=R;for(let z=0;z<D;z++){let $=0;w[B]=Y[z+$],$+=R,w[B+1]=Y[z+$],$+=R,w[B+2]=Y[z+$],$+=R,w[B+3]=Y[z+$],B+=4}W--}return w},m=function(S,b,T,R){const w=S[b+3],B=Math.pow(2,w-128)/255;T[R+0]=S[b+0]*B,T[R+1]=S[b+1]*B,T[R+2]=S[b+2]*B,T[R+3]=1},A=function(S,b,T,R){const w=S[b+3],B=Math.pow(2,w-128)/255;T[R+0]=da.toHalfFloat(Math.min(S[b+0]*B,65504)),T[R+1]=da.toHalfFloat(Math.min(S[b+1]*B,65504)),T[R+2]=da.toHalfFloat(Math.min(S[b+2]*B,65504)),T[R+3]=da.toHalfFloat(1)},p=new Uint8Array(e);p.pos=0;const y=f(p),v=y.width,E=y.height,x=d(p.subarray(p.pos),v,E);let I,C,_;switch(this.type){case ri:_=x.length/4;const S=new Float32Array(_*4);for(let T=0;T<_;T++)m(x,T*4,S,T*4);I=S,C=ri;break;case ui:_=x.length/4;const b=new Uint16Array(_*4);for(let T=0;T<_;T++)A(x,T*4,b,T*4);I=b,C=ui;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:v,height:E,data:I,header:y.string,gamma:y.gamma,exposure:y.exposure,type:C}}setDataType(e){return this.type=e,this}load(e,t,i,n){function s(o,a){switch(o.type){case ri:case ui:"colorSpace"in o?o.colorSpace="srgb-linear":o.encoding=3e3,o.minFilter=Nt,o.magFilter=Nt,o.generateMipmaps=!1,o.flipY=!0;break}t&&t(o,a)}return super.load(e,s,i,n)}}const gl=Na>=152;class I8 extends gE{constructor(e){super(e),this.type=ui}parse(e){const b=Math.pow(2.7182818,2.2);function T(H,j){for(var ee=0,me=0;me<65536;++me)(me==0||H[me>>3]&1<<(me&7))&&(j[ee++]=me);for(var Ee=ee-1;ee<65536;)j[ee++]=0;return Ee}function R(H){for(var j=0;j<16384;j++)H[j]={},H[j].len=0,H[j].lit=0,H[j].p=null}const w={l:0,c:0,lc:0};function B(H,j,ee,me,Ee){for(;ee<H;)j=j<<8|je(me,Ee),ee+=8;ee-=H,w.l=j>>ee&(1<<H)-1,w.c=j,w.lc=ee}const M=new Array(59);function O(H){for(var j=0;j<=58;++j)M[j]=0;for(var j=0;j<65537;++j)M[H[j]]+=1;for(var ee=0,j=58;j>0;--j){var me=ee+M[j]>>1;M[j]=ee,ee=me}for(var j=0;j<65537;++j){var Ee=H[j];Ee>0&&(H[j]=Ee|M[Ee]++<<6)}}function U(H,j,ee,me,Ee,xe,Pe){for(var Re=ee,Fe=0,ke=0;Ee<=xe;Ee++){if(Re.value-ee.value>me)return!1;B(6,Fe,ke,H,Re);var Oe=w.l;if(Fe=w.c,ke=w.lc,Pe[Ee]=Oe,Oe==63){if(Re.value-ee.value>me)throw"Something wrong with hufUnpackEncTable";B(8,Fe,ke,H,Re);var ge=w.l+6;if(Fe=w.c,ke=w.lc,Ee+ge>xe+1)throw"Something wrong with hufUnpackEncTable";for(;ge--;)Pe[Ee++]=0;Ee--}else if(Oe>=59){var ge=Oe-59+2;if(Ee+ge>xe+1)throw"Something wrong with hufUnpackEncTable";for(;ge--;)Pe[Ee++]=0;Ee--}}O(Pe)}function Y(H){return H&63}function W(H){return H>>6}function N(H,j,ee,me){for(;j<=ee;j++){var Ee=W(H[j]),xe=Y(H[j]);if(Ee>>xe)throw"Invalid table entry";if(xe>14){var Pe=me[Ee>>xe-14];if(Pe.len)throw"Invalid table entry";if(Pe.lit++,Pe.p){var Re=Pe.p;Pe.p=new Array(Pe.lit);for(var Fe=0;Fe<Pe.lit-1;++Fe)Pe.p[Fe]=Re[Fe]}else Pe.p=new Array(1);Pe.p[Pe.lit-1]=j}else if(xe)for(var ke=0,Fe=1<<14-xe;Fe>0;Fe--){var Pe=me[(Ee<<14-xe)+ke];if(Pe.len||Pe.p)throw"Invalid table entry";Pe.len=xe,Pe.lit=j,ke++}}return!0}const K={c:0,lc:0};function D(H,j,ee,me){H=H<<8|je(ee,me),j+=8,K.c=H,K.lc=j}const z={c:0,lc:0};function $(H,j,ee,me,Ee,xe,Pe,Re,Fe,ke){if(H==j){me<8&&(D(ee,me,Ee,Pe),ee=K.c,me=K.lc),me-=8;var Oe=ee>>me,Oe=new Uint8Array([Oe])[0];if(Fe.value+Oe>ke)return!1;for(var ge=Re[Fe.value-1];Oe-- >0;)Re[Fe.value++]=ge}else if(Fe.value<ke)Re[Fe.value++]=H;else return!1;z.c=ee,z.lc=me}function V(H){return H&65535}function P(H){var j=V(H);return j>32767?j-65536:j}const G={a:0,b:0};function F(H,j){var ee=P(H),me=P(j),Ee=me,xe=ee+(Ee&1)+(Ee>>1),Pe=xe,Re=xe-Ee;G.a=Pe,G.b=Re}function k(H,j){var ee=V(H),me=V(j),Ee=ee-(me>>1)&65535,xe=me+Ee-32768&65535;G.a=xe,G.b=Ee}function Z(H,j,ee,me,Ee,xe,Pe){for(var Re=Pe<16384,Fe=ee>Ee?Ee:ee,ke=1,Oe;ke<=Fe;)ke<<=1;for(ke>>=1,Oe=ke,ke>>=1;ke>=1;){for(var ge=0,Gt=ge+xe*(Ee-Oe),et=xe*ke,Ze=xe*Oe,ct=me*ke,vt=me*Oe,Mt,Lt,ai,Vi;ge<=Gt;ge+=Ze){for(var Pt=ge,Bn=ge+me*(ee-Oe);Pt<=Bn;Pt+=vt){var Qt=Pt+ct,Si=Pt+et,rn=Si+ct;Re?(F(H[Pt+j],H[Si+j]),Mt=G.a,ai=G.b,F(H[Qt+j],H[rn+j]),Lt=G.a,Vi=G.b,F(Mt,Lt),H[Pt+j]=G.a,H[Qt+j]=G.b,F(ai,Vi),H[Si+j]=G.a,H[rn+j]=G.b):(k(H[Pt+j],H[Si+j]),Mt=G.a,ai=G.b,k(H[Qt+j],H[rn+j]),Lt=G.a,Vi=G.b,k(Mt,Lt),H[Pt+j]=G.a,H[Qt+j]=G.b,k(ai,Vi),H[Si+j]=G.a,H[rn+j]=G.b)}if(ee&ke){var Si=Pt+et;Re?F(H[Pt+j],H[Si+j]):k(H[Pt+j],H[Si+j]),Mt=G.a,H[Si+j]=G.b,H[Pt+j]=Mt}}if(Ee&ke)for(var Pt=ge,Bn=ge+me*(ee-Oe);Pt<=Bn;Pt+=vt){var Qt=Pt+ct;Re?F(H[Pt+j],H[Qt+j]):k(H[Pt+j],H[Qt+j]),Mt=G.a,H[Qt+j]=G.b,H[Pt+j]=Mt}Oe=ke,ke>>=1}return ge}function ne(H,j,ee,me,Ee,xe,Pe,Re,Fe,ke){for(var Oe=0,ge=0,Gt=Re,et=Math.trunc(Ee.value+(xe+7)/8);Ee.value<et;)for(D(Oe,ge,ee,Ee),Oe=K.c,ge=K.lc;ge>=14;){var Ze=Oe>>ge-14&16383,ct=j[Ze];if(ct.len)ge-=ct.len,$(ct.lit,Pe,Oe,ge,ee,me,Ee,Fe,ke,Gt),Oe=z.c,ge=z.lc;else{if(!ct.p)throw"hufDecode issues";var vt;for(vt=0;vt<ct.lit;vt++){for(var Mt=Y(H[ct.p[vt]]);ge<Mt&&Ee.value<et;)D(Oe,ge,ee,Ee),Oe=K.c,ge=K.lc;if(ge>=Mt&&W(H[ct.p[vt]])==(Oe>>ge-Mt&(1<<Mt)-1)){ge-=Mt,$(ct.p[vt],Pe,Oe,ge,ee,me,Ee,Fe,ke,Gt),Oe=z.c,ge=z.lc;break}}if(vt==ct.lit)throw"hufDecode issues"}}var Lt=8-xe&7;for(Oe>>=Lt,ge-=Lt;ge>0;){var ct=j[Oe<<14-ge&16383];if(ct.len)ge-=ct.len,$(ct.lit,Pe,Oe,ge,ee,me,Ee,Fe,ke,Gt),Oe=z.c,ge=z.lc;else throw"hufDecode issues"}return!0}function X(H,j,ee,me,Ee,xe){var Pe={value:0},Re=ee.value,Fe=Xe(j,ee),ke=Xe(j,ee);ee.value+=4;var Oe=Xe(j,ee);if(ee.value+=4,Fe<0||Fe>=65537||ke<0||ke>=65537)throw"Something wrong with HUF_ENCSIZE";var ge=new Array(65537),Gt=new Array(16384);R(Gt);var et=me-(ee.value-Re);if(U(H,j,ee,et,Fe,ke,ge),Oe>8*(me-(ee.value-Re)))throw"Something wrong with hufUncompress";N(ge,Fe,ke,Gt),ne(ge,Gt,H,j,ee,Oe,ke,xe,Ee,Pe)}function te(H,j,ee){for(var me=0;me<ee;++me)j[me]=H[j[me]]}function ye(H){for(var j=1;j<H.length;j++){var ee=H[j-1]+H[j]-128;H[j]=ee}}function ve(H,j){for(var ee=0,me=Math.floor((H.length+1)/2),Ee=0,xe=H.length-1;!(Ee>xe||(j[Ee++]=H[ee++],Ee>xe));)j[Ee++]=H[me++]}function re(H){for(var j=H.byteLength,ee=new Array,me=0,Ee=new DataView(H);j>0;){var xe=Ee.getInt8(me++);if(xe<0){var Pe=-xe;j-=Pe+1;for(var Re=0;Re<Pe;Re++)ee.push(Ee.getUint8(me++))}else{var Pe=xe;j-=2;for(var Fe=Ee.getUint8(me++),Re=0;Re<Pe+1;Re++)ee.push(Fe)}}return ee}function se(H,j,ee,me,Ee,xe){var Qt=new DataView(xe.buffer),Pe=ee[H.idx[0]].width,Re=ee[H.idx[0]].height,Fe=3,ke=Math.floor(Pe/8),Oe=Math.ceil(Pe/8),ge=Math.ceil(Re/8),Gt=Pe-(Oe-1)*8,et=Re-(ge-1)*8,Ze={value:0},ct=new Array(Fe),vt=new Array(Fe),Mt=new Array(Fe),Lt=new Array(Fe),ai=new Array(Fe);for(let Ft=0;Ft<Fe;++Ft)ai[Ft]=j[H.idx[Ft]],ct[Ft]=Ft<1?0:ct[Ft-1]+Oe*ge,vt[Ft]=new Float32Array(64),Mt[Ft]=new Uint16Array(64),Lt[Ft]=new Uint16Array(Oe*64);for(let Ft=0;Ft<ge;++Ft){var Vi=8;Ft==ge-1&&(Vi=et);var Pt=8;for(let $t=0;$t<Oe;++$t){$t==Oe-1&&(Pt=Gt);for(let xt=0;xt<Fe;++xt)Mt[xt].fill(0),Mt[xt][0]=Ee[ct[xt]++],he(Ze,me,Mt[xt]),le(Mt[xt],vt[xt]),J(vt[xt]);q(vt);for(let xt=0;xt<Fe;++xt)oe(vt[xt],Lt[xt],$t*64)}let wi=0;for(let $t=0;$t<Fe;++$t){const xt=ee[H.idx[$t]].type;for(let mn=8*Ft;mn<8*Ft+Vi;++mn){wi=ai[$t][mn];for(let Hn=0;Hn<ke;++Hn){const Pi=Hn*64+(mn&7)*8;Qt.setUint16(wi+0*xt,Lt[$t][Pi+0],!0),Qt.setUint16(wi+2*xt,Lt[$t][Pi+1],!0),Qt.setUint16(wi+4*xt,Lt[$t][Pi+2],!0),Qt.setUint16(wi+6*xt,Lt[$t][Pi+3],!0),Qt.setUint16(wi+8*xt,Lt[$t][Pi+4],!0),Qt.setUint16(wi+10*xt,Lt[$t][Pi+5],!0),Qt.setUint16(wi+12*xt,Lt[$t][Pi+6],!0),Qt.setUint16(wi+14*xt,Lt[$t][Pi+7],!0),wi+=16*xt}}if(ke!=Oe)for(let mn=8*Ft;mn<8*Ft+Vi;++mn){const Hn=ai[$t][mn]+8*ke*2*xt,Pi=ke*64+(mn&7)*8;for(let cs=0;cs<Pt;++cs)Qt.setUint16(Hn+cs*2*xt,Lt[$t][Pi+cs],!0)}}}for(var Bn=new Uint16Array(Pe),Qt=new DataView(xe.buffer),Si=0;Si<Fe;++Si){ee[H.idx[Si]].decoded=!0;var rn=ee[H.idx[Si]].type;if(ee[Si].type==2)for(var Zs=0;Zs<Re;++Zs){const Ft=ai[Si][Zs];for(var Li=0;Li<Pe;++Li)Bn[Li]=Qt.getUint16(Ft+Li*2*rn,!0);for(var Li=0;Li<Pe;++Li)Qt.setFloat32(Ft+Li*2*rn,pe(Bn[Li]),!0)}}}function he(H,j,ee){for(var me,Ee=1;Ee<64;)me=j[H.value],me==65280?Ee=64:me>>8==255?Ee+=me&255:(ee[Ee]=me,Ee++),H.value++}function le(H,j){j[0]=pe(H[0]),j[1]=pe(H[1]),j[2]=pe(H[5]),j[3]=pe(H[6]),j[4]=pe(H[14]),j[5]=pe(H[15]),j[6]=pe(H[27]),j[7]=pe(H[28]),j[8]=pe(H[2]),j[9]=pe(H[4]),j[10]=pe(H[7]),j[11]=pe(H[13]),j[12]=pe(H[16]),j[13]=pe(H[26]),j[14]=pe(H[29]),j[15]=pe(H[42]),j[16]=pe(H[3]),j[17]=pe(H[8]),j[18]=pe(H[12]),j[19]=pe(H[17]),j[20]=pe(H[25]),j[21]=pe(H[30]),j[22]=pe(H[41]),j[23]=pe(H[43]),j[24]=pe(H[9]),j[25]=pe(H[11]),j[26]=pe(H[18]),j[27]=pe(H[24]),j[28]=pe(H[31]),j[29]=pe(H[40]),j[30]=pe(H[44]),j[31]=pe(H[53]),j[32]=pe(H[10]),j[33]=pe(H[19]),j[34]=pe(H[23]),j[35]=pe(H[32]),j[36]=pe(H[39]),j[37]=pe(H[45]),j[38]=pe(H[52]),j[39]=pe(H[54]),j[40]=pe(H[20]),j[41]=pe(H[22]),j[42]=pe(H[33]),j[43]=pe(H[38]),j[44]=pe(H[46]),j[45]=pe(H[51]),j[46]=pe(H[55]),j[47]=pe(H[60]),j[48]=pe(H[21]),j[49]=pe(H[34]),j[50]=pe(H[37]),j[51]=pe(H[47]),j[52]=pe(H[50]),j[53]=pe(H[56]),j[54]=pe(H[59]),j[55]=pe(H[61]),j[56]=pe(H[35]),j[57]=pe(H[36]),j[58]=pe(H[48]),j[59]=pe(H[49]),j[60]=pe(H[57]),j[61]=pe(H[58]),j[62]=pe(H[62]),j[63]=pe(H[63])}function J(H){const j=.5*Math.cos(.7853975),ee=.5*Math.cos(3.14159/16),me=.5*Math.cos(3.14159/8),Ee=.5*Math.cos(3*3.14159/16),xe=.5*Math.cos(5*3.14159/16),Pe=.5*Math.cos(3*3.14159/8),Re=.5*Math.cos(7*3.14159/16);for(var Fe=new Array(4),ke=new Array(4),Oe=new Array(4),ge=new Array(4),Gt=0;Gt<8;++Gt){var et=Gt*8;Fe[0]=me*H[et+2],Fe[1]=Pe*H[et+2],Fe[2]=me*H[et+6],Fe[3]=Pe*H[et+6],ke[0]=ee*H[et+1]+Ee*H[et+3]+xe*H[et+5]+Re*H[et+7],ke[1]=Ee*H[et+1]-Re*H[et+3]-ee*H[et+5]-xe*H[et+7],ke[2]=xe*H[et+1]-ee*H[et+3]+Re*H[et+5]+Ee*H[et+7],ke[3]=Re*H[et+1]-xe*H[et+3]+Ee*H[et+5]-ee*H[et+7],Oe[0]=j*(H[et+0]+H[et+4]),Oe[3]=j*(H[et+0]-H[et+4]),Oe[1]=Fe[0]+Fe[3],Oe[2]=Fe[1]-Fe[2],ge[0]=Oe[0]+Oe[1],ge[1]=Oe[3]+Oe[2],ge[2]=Oe[3]-Oe[2],ge[3]=Oe[0]-Oe[1],H[et+0]=ge[0]+ke[0],H[et+1]=ge[1]+ke[1],H[et+2]=ge[2]+ke[2],H[et+3]=ge[3]+ke[3],H[et+4]=ge[3]-ke[3],H[et+5]=ge[2]-ke[2],H[et+6]=ge[1]-ke[1],H[et+7]=ge[0]-ke[0]}for(var Ze=0;Ze<8;++Ze)Fe[0]=me*H[16+Ze],Fe[1]=Pe*H[16+Ze],Fe[2]=me*H[48+Ze],Fe[3]=Pe*H[48+Ze],ke[0]=ee*H[8+Ze]+Ee*H[24+Ze]+xe*H[40+Ze]+Re*H[56+Ze],ke[1]=Ee*H[8+Ze]-Re*H[24+Ze]-ee*H[40+Ze]-xe*H[56+Ze],ke[2]=xe*H[8+Ze]-ee*H[24+Ze]+Re*H[40+Ze]+Ee*H[56+Ze],ke[3]=Re*H[8+Ze]-xe*H[24+Ze]+Ee*H[40+Ze]-ee*H[56+Ze],Oe[0]=j*(H[Ze]+H[32+Ze]),Oe[3]=j*(H[Ze]-H[32+Ze]),Oe[1]=Fe[0]+Fe[3],Oe[2]=Fe[1]-Fe[2],ge[0]=Oe[0]+Oe[1],ge[1]=Oe[3]+Oe[2],ge[2]=Oe[3]-Oe[2],ge[3]=Oe[0]-Oe[1],H[0+Ze]=ge[0]+ke[0],H[8+Ze]=ge[1]+ke[1],H[16+Ze]=ge[2]+ke[2],H[24+Ze]=ge[3]+ke[3],H[32+Ze]=ge[3]-ke[3],H[40+Ze]=ge[2]-ke[2],H[48+Ze]=ge[1]-ke[1],H[56+Ze]=ge[0]-ke[0]}function q(H){for(var j=0;j<64;++j){var ee=H[0][j],me=H[1][j],Ee=H[2][j];H[0][j]=ee+1.5747*Ee,H[1][j]=ee-.1873*me-.4682*Ee,H[2][j]=ee+1.8556*me}}function oe(H,j,ee){for(var me=0;me<64;++me)j[ee+me]=da.toHalfFloat(Ie(H[me]))}function Ie(H){return H<=1?Math.sign(H)*Math.pow(Math.abs(H),2.2):Math.sign(H)*Math.pow(b,Math.abs(H)-1)}function _e(H){return new DataView(H.array.buffer,H.offset.value,H.size)}function Be(H){var j=H.viewer.buffer.slice(H.offset.value,H.offset.value+H.size),ee=new Uint8Array(re(j)),me=new Uint8Array(ee.length);return ye(ee),ve(ee,me),new DataView(me.buffer)}function Se(H){var j=H.array.slice(H.offset.value,H.offset.value+H.size),ee=Gl(j),me=new Uint8Array(ee.length);return ye(ee),ve(ee,me),new DataView(me.buffer)}function Ke(H){for(var j=H.viewer,ee={value:H.offset.value},me=new Uint16Array(H.width*H.scanlineBlockSize*(H.channels*H.type)),Ee=new Uint8Array(8192),xe=0,Pe=new Array(H.channels),Re=0;Re<H.channels;Re++)Pe[Re]={},Pe[Re].start=xe,Pe[Re].end=Pe[Re].start,Pe[Re].nx=H.width,Pe[Re].ny=H.lines,Pe[Re].size=H.type,xe+=Pe[Re].nx*Pe[Re].ny*Pe[Re].size;var Fe=at(j,ee),ke=at(j,ee);if(ke>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(Fe<=ke)for(var Re=0;Re<ke-Fe+1;Re++)Ee[Re+Fe]=ie(j,ee);var Oe=new Uint16Array(65536),ge=T(Ee,Oe),Gt=Xe(j,ee);X(H.array,j,ee,Gt,me,xe);for(var Re=0;Re<H.channels;++Re)for(var et=Pe[Re],Ze=0;Ze<Pe[Re].size;++Ze)Z(me,et.start+Ze,et.nx,et.size,et.ny,et.nx*et.size,ge);te(Oe,me,xe);for(var ct=0,vt=new Uint8Array(me.buffer.byteLength),Mt=0;Mt<H.lines;Mt++)for(var Lt=0;Lt<H.channels;Lt++){var et=Pe[Lt],ai=et.nx*et.size,Vi=new Uint8Array(me.buffer,et.end*2,ai*2);vt.set(Vi,ct),ct+=ai*2,et.end+=ai}return new DataView(vt.buffer)}function Me(H){var j=H.array.slice(H.offset.value,H.offset.value+H.size),ee=Gl(j);const me=H.lines*H.channels*H.width,Ee=H.type==1?new Uint16Array(me):new Uint32Array(me);let xe=0,Pe=0;const Re=new Array(4);for(let Fe=0;Fe<H.lines;Fe++)for(let ke=0;ke<H.channels;ke++){let Oe=0;switch(H.type){case 1:Re[0]=xe,Re[1]=Re[0]+H.width,xe=Re[1]+H.width;for(let ge=0;ge<H.width;++ge){const Gt=ee[Re[0]++]<<8|ee[Re[1]++];Oe+=Gt,Ee[Pe]=Oe,Pe++}break;case 2:Re[0]=xe,Re[1]=Re[0]+H.width,Re[2]=Re[1]+H.width,xe=Re[2]+H.width;for(let ge=0;ge<H.width;++ge){const Gt=ee[Re[0]++]<<24|ee[Re[1]++]<<16|ee[Re[2]++]<<8;Oe+=Gt,Ee[Pe]=Oe,Pe++}break}}return new DataView(Ee.buffer)}function Ge(H){var j=H.viewer,ee={value:H.offset.value},me=new Uint8Array(H.width*H.lines*(H.channels*H.type*2)),Ee={version:be(j,ee),unknownUncompressedSize:be(j,ee),unknownCompressedSize:be(j,ee),acCompressedSize:be(j,ee),dcCompressedSize:be(j,ee),rleCompressedSize:be(j,ee),rleUncompressedSize:be(j,ee),rleRawSize:be(j,ee),totalAcUncompressedCount:be(j,ee),totalDcUncompressedCount:be(j,ee),acCompression:be(j,ee)};if(Ee.version<2)throw"EXRLoader.parse: "+wn.compression+" version "+Ee.version+" is unsupported";for(var xe=new Array,Pe=at(j,ee)-2;Pe>0;){var Re=Qe(j.buffer,ee),Fe=ie(j,ee),ke=Fe>>2&3,Oe=(Fe>>4)-1,ge=new Int8Array([Oe])[0],Gt=ie(j,ee);xe.push({name:Re,index:ge,type:Gt,compression:ke}),Pe-=Re.length+3}for(var et=wn.channels,Ze=new Array(H.channels),ct=0;ct<H.channels;++ct){var vt=Ze[ct]={},Mt=et[ct];vt.name=Mt.name,vt.compression=0,vt.decoded=!1,vt.type=Mt.pixelType,vt.pLinear=Mt.pLinear,vt.width=H.width,vt.height=H.lines}for(var Lt={idx:new Array(3)},ai=0;ai<H.channels;++ai)for(var vt=Ze[ai],ct=0;ct<xe.length;++ct){var Vi=xe[ct];vt.name==Vi.name&&(vt.compression=Vi.compression,Vi.index>=0&&(Lt.idx[Vi.index]=ai),vt.offset=ai)}if(Ee.acCompressedSize>0)switch(Ee.acCompression){case 0:var Qt=new Uint16Array(Ee.totalAcUncompressedCount);X(H.array,j,ee,Ee.acCompressedSize,Qt,Ee.totalAcUncompressedCount);break;case 1:var Pt=H.array.slice(ee.value,ee.value+Ee.totalAcUncompressedCount),Bn=Gl(Pt),Qt=new Uint16Array(Bn.buffer);ee.value+=Ee.totalAcUncompressedCount;break}if(Ee.dcCompressedSize>0){var Si={array:H.array,offset:ee,size:Ee.dcCompressedSize},rn=new Uint16Array(Se(Si).buffer);ee.value+=Ee.dcCompressedSize}if(Ee.rleRawSize>0){var Pt=H.array.slice(ee.value,ee.value+Ee.rleCompressedSize),Bn=Gl(Pt),Zs=re(Bn.buffer);ee.value+=Ee.rleCompressedSize}for(var Li=0,Ft=new Array(Ze.length),ct=0;ct<Ft.length;++ct)Ft[ct]=new Array;for(var wi=0;wi<H.lines;++wi)for(var $t=0;$t<Ze.length;++$t)Ft[$t].push(Li),Li+=Ze[$t].width*H.type*2;se(Lt,Ft,Ze,Qt,rn,me);for(var ct=0;ct<Ze.length;++ct){var vt=Ze[ct];if(!vt.decoded)switch(vt.compression){case 2:for(var xt=0,mn=0,wi=0;wi<H.lines;++wi){for(var Hn=Ft[ct][xt],Pi=0;Pi<vt.width;++Pi){for(var cs=0;cs<2*vt.type;++cs)me[Hn++]=Zs[mn+cs*vt.width*vt.height];mn++}xt++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(me.buffer)}function Qe(H,j){for(var ee=new Uint8Array(H),me=0;ee[j.value+me]!=0;)me+=1;var Ee=new TextDecoder().decode(ee.slice(j.value,j.value+me));return j.value=j.value+me+1,Ee}function qe(H,j,ee){var me=new TextDecoder().decode(new Uint8Array(H).slice(j.value,j.value+ee));return j.value=j.value+ee,me}function rt(H,j){var ee=nt(H,j),me=Xe(H,j);return[ee,me]}function gt(H,j){var ee=Xe(H,j),me=Xe(H,j);return[ee,me]}function nt(H,j){var ee=H.getInt32(j.value,!0);return j.value=j.value+4,ee}function Xe(H,j){var ee=H.getUint32(j.value,!0);return j.value=j.value+4,ee}function je(H,j){var ee=H[j.value];return j.value=j.value+1,ee}function ie(H,j){var ee=H.getUint8(j.value);return j.value=j.value+1,ee}const be=function(H,j){let ee;return"getBigInt64"in DataView.prototype?ee=Number(H.getBigInt64(j.value,!0)):ee=H.getUint32(j.value+4,!0)+Number(H.getUint32(j.value,!0)<<32),j.value+=8,ee};function Le(H,j){var ee=H.getFloat32(j.value,!0);return j.value+=4,ee}function Ye(H,j){return da.toHalfFloat(Le(H,j))}function pe(H){var j=(H&31744)>>10,ee=H&1023;return(H>>15?-1:1)*(j?j===31?ee?NaN:1/0:Math.pow(2,j-15)*(1+ee/1024):6103515625e-14*(ee/1024))}function at(H,j){var ee=H.getUint16(j.value,!0);return j.value+=2,ee}function ti(H,j){return pe(at(H,j))}function Dt(H,j,ee,me){for(var Ee=ee.value,xe=[];ee.value<Ee+me-1;){var Pe=Qe(j,ee),Re=nt(H,ee),Fe=ie(H,ee);ee.value+=3;var ke=nt(H,ee),Oe=nt(H,ee);xe.push({name:Pe,pixelType:Re,pLinear:Fe,xSampling:ke,ySampling:Oe})}return ee.value+=1,xe}function yt(H,j){var ee=Le(H,j),me=Le(H,j),Ee=Le(H,j),xe=Le(H,j),Pe=Le(H,j),Re=Le(H,j),Fe=Le(H,j),ke=Le(H,j);return{redX:ee,redY:me,greenX:Ee,greenY:xe,blueX:Pe,blueY:Re,whiteX:Fe,whiteY:ke}}function wt(H,j){var ee=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],me=ie(H,j);return ee[me]}function Tt(H,j){var ee=Xe(H,j),me=Xe(H,j),Ee=Xe(H,j),xe=Xe(H,j);return{xMin:ee,yMin:me,xMax:Ee,yMax:xe}}function lt(H,j){var ee=["INCREASING_Y"],me=ie(H,j);return ee[me]}function Bt(H,j){var ee=Le(H,j),me=Le(H,j);return[ee,me]}function fi(H,j){var ee=Le(H,j),me=Le(H,j),Ee=Le(H,j);return[ee,me,Ee]}function di(H,j,ee,me,Ee){if(me==="string"||me==="stringvector"||me==="iccProfile")return qe(j,ee,Ee);if(me==="chlist")return Dt(H,j,ee,Ee);if(me==="chromaticities")return yt(H,ee);if(me==="compression")return wt(H,ee);if(me==="box2i")return Tt(H,ee);if(me==="lineOrder")return lt(H,ee);if(me==="float")return Le(H,ee);if(me==="v2f")return Bt(H,ee);if(me==="v3f")return fi(H,ee);if(me==="int")return nt(H,ee);if(me==="rational")return rt(H,ee);if(me==="timecode")return gt(H,ee);if(me==="preview")return ee.value+=Ee,"skipped";ee.value+=Ee}function _i(H,j,ee){const me={};if(H.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";me.version=H.getUint8(4);const Ee=H.getUint8(5);me.spec={singleTile:!!(Ee&2),longName:!!(Ee&4),deepFormat:!!(Ee&8),multiPart:!!(Ee&16)},ee.value=8;for(var xe=!0;xe;){var Pe=Qe(j,ee);if(Pe==0)xe=!1;else{var Re=Qe(j,ee),Fe=Xe(H,ee),ke=di(H,j,ee,Re,Fe);ke===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${Re}'.`):me[Pe]=ke}}if((Ee&-5)!=0)throw console.error("EXRHeader:",me),"THREE.EXRLoader: provided file is currently unsupported.";return me}function Tn(H,j,ee,me,Ee){const xe={size:0,viewer:j,array:ee,offset:me,width:H.dataWindow.xMax-H.dataWindow.xMin+1,height:H.dataWindow.yMax-H.dataWindow.yMin+1,channels:H.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:H.channels[0].pixelType,uncompress:null,getter:null,format:null,[gl?"colorSpace":"encoding"]:null};switch(H.compression){case"NO_COMPRESSION":xe.lines=1,xe.uncompress=_e;break;case"RLE_COMPRESSION":xe.lines=1,xe.uncompress=Be;break;case"ZIPS_COMPRESSION":xe.lines=1,xe.uncompress=Se;break;case"ZIP_COMPRESSION":xe.lines=16,xe.uncompress=Se;break;case"PIZ_COMPRESSION":xe.lines=32,xe.uncompress=Ke;break;case"PXR24_COMPRESSION":xe.lines=16,xe.uncompress=Me;break;case"DWAA_COMPRESSION":xe.lines=32,xe.uncompress=Ge;break;case"DWAB_COMPRESSION":xe.lines=256,xe.uncompress=Ge;break;default:throw"EXRLoader.parse: "+H.compression+" is unsupported"}if(xe.scanlineBlockSize=xe.lines,xe.type==1)switch(Ee){case ri:xe.getter=ti,xe.inputSize=2;break;case ui:xe.getter=at,xe.inputSize=2;break}else if(xe.type==2)switch(Ee){case ri:xe.getter=Le,xe.inputSize=4;break;case ui:xe.getter=Ye,xe.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+xe.type+" for "+H.compression+".";xe.blockCount=(H.dataWindow.yMax+1)/xe.scanlineBlockSize;for(var Pe=0;Pe<xe.blockCount;Pe++)be(j,me);xe.outputChannels=xe.channels==3?4:xe.channels;const Re=xe.width*xe.height*xe.outputChannels;switch(Ee){case ri:xe.byteArray=new Float32Array(Re),xe.channels<xe.outputChannels&&xe.byteArray.fill(1,0,Re);break;case ui:xe.byteArray=new Uint16Array(Re),xe.channels<xe.outputChannels&&xe.byteArray.fill(15360,0,Re);break;default:console.error("THREE.EXRLoader: unsupported type: ",Ee);break}return xe.bytesPerLine=xe.width*xe.inputSize*xe.channels,xe.outputChannels==4?xe.format=Di:xe.format=Vs,gl?xe.colorSpace="srgb-linear":xe.encoding=3e3,xe}const bn=new DataView(e),ls=new Uint8Array(e),dn={value:0},wn=_i(bn,e,dn),ft=Tn(wn,bn,ls,dn,this.type),Hi={value:0},Js={R:0,G:1,B:2,A:3,Y:0};for(let H=0;H<ft.height/ft.scanlineBlockSize;H++){const j=Xe(bn,dn);ft.size=Xe(bn,dn),ft.lines=j+ft.scanlineBlockSize>ft.height?ft.height-j:ft.scanlineBlockSize;const me=ft.size<ft.lines*ft.bytesPerLine?ft.uncompress(ft):_e(ft);dn.value+=ft.size;for(let Ee=0;Ee<ft.scanlineBlockSize;Ee++){const xe=Ee+H*ft.scanlineBlockSize;if(xe>=ft.height)break;for(let Pe=0;Pe<ft.channels;Pe++){const Re=Js[wn.channels[Pe].name];for(let Fe=0;Fe<ft.width;Fe++){Hi.value=(Ee*(ft.channels*ft.width)+Pe*ft.width+Fe)*ft.inputSize;const ke=(ft.height-1-xe)*(ft.width*ft.outputChannels)+Fe*ft.outputChannels+Re;ft.byteArray[ke]=ft.getter(me,Hi)}}}}return{header:wn,width:ft.width,height:ft.height,data:ft.byteArray,format:ft.format,[gl?"colorSpace":"encoding"]:ft[gl?"colorSpace":"encoding"],type:this.type}}setDataType(e){return this.type=e,this}load(e,t,i,n){function s(o,a){gl?o.colorSpace=a.colorSpace:o.encoding=a.encoding,o.minFilter=Nt,o.magFilter=Nt,o.generateMipmaps=!1,o.flipY=!1,t&&t(o,a)}return super.load(e,s,i,n)}}const C8="srgb",md=(()=>{class r extends Yr{constructor(t){super(t),this.defaultDPI=90,this.defaultUnit="px"}load(t,i,n,s){const o=this,a=new Sn(o.manager);a.setPath(o.path),a.setRequestHeader(o.requestHeader),a.setWithCredentials(o.withCredentials),a.load(t,function(l){try{i(o.parse(l))}catch(c){s?s(c):console.error(c),o.manager.itemError(t)}},n,s)}parse(t){const i=this;function n(P,G){if(P.nodeType!==1)return;const F=I(P);let k=!1,Z=null;switch(P.nodeName){case"svg":G=A(P,G);break;case"style":o(P);break;case"g":G=A(P,G);break;case"path":G=A(P,G),P.hasAttribute("d")&&(Z=s(P));break;case"rect":G=A(P,G),Z=c(P);break;case"polygon":G=A(P,G),Z=u(P);break;case"polyline":G=A(P,G),Z=h(P);break;case"circle":G=A(P,G),Z=f(P);break;case"ellipse":G=A(P,G),Z=d(P);break;case"line":G=A(P,G),Z=m(P);break;case"defs":k=!0;break;case"use":G=A(P,G);const te=(P.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),ye=P.viewportElement.getElementById(te);ye?n(ye,G):console.warn("SVGLoader: 'use node' references non-existent node id: "+te);break}Z&&(G.fill!==void 0&&G.fill!=="none"&&Z.color.setStyle(G.fill,C8),_(Z,z),B.push(Z),Z.userData={node:P,style:G});const ne=P.childNodes;for(let X=0;X<ne.length;X++){const te=ne[X];k&&te.nodeName!=="style"&&te.nodeName!=="defs"||n(te,G)}F&&(O.pop(),O.length>0?z.copy(O[O.length-1]):z.identity())}function s(P){const G=new Rr,F=new De,k=new De,Z=new De;let ne=!0,X=!1;const te=P.getAttribute("d");if(te===""||te==="none")return null;const ye=te.match(/[a-df-z][^a-df-z]*/gi);for(let ve=0,re=ye.length;ve<re;ve++){const se=ye[ve],he=se.charAt(0),le=se.slice(1).trim();ne===!0&&(X=!0,ne=!1);let J;switch(he){case"M":J=y(le);for(let q=0,oe=J.length;q<oe;q+=2)F.x=J[q+0],F.y=J[q+1],k.x=F.x,k.y=F.y,q===0?G.moveTo(F.x,F.y):G.lineTo(F.x,F.y),q===0&&Z.copy(F);break;case"H":J=y(le);for(let q=0,oe=J.length;q<oe;q++)F.x=J[q],k.x=F.x,k.y=F.y,G.lineTo(F.x,F.y),q===0&&X===!0&&Z.copy(F);break;case"V":J=y(le);for(let q=0,oe=J.length;q<oe;q++)F.y=J[q],k.x=F.x,k.y=F.y,G.lineTo(F.x,F.y),q===0&&X===!0&&Z.copy(F);break;case"L":J=y(le);for(let q=0,oe=J.length;q<oe;q+=2)F.x=J[q+0],F.y=J[q+1],k.x=F.x,k.y=F.y,G.lineTo(F.x,F.y),q===0&&X===!0&&Z.copy(F);break;case"C":J=y(le);for(let q=0,oe=J.length;q<oe;q+=6)G.bezierCurveTo(J[q+0],J[q+1],J[q+2],J[q+3],J[q+4],J[q+5]),k.x=J[q+2],k.y=J[q+3],F.x=J[q+4],F.y=J[q+5],q===0&&X===!0&&Z.copy(F);break;case"S":J=y(le);for(let q=0,oe=J.length;q<oe;q+=4)G.bezierCurveTo(p(F.x,k.x),p(F.y,k.y),J[q+0],J[q+1],J[q+2],J[q+3]),k.x=J[q+0],k.y=J[q+1],F.x=J[q+2],F.y=J[q+3],q===0&&X===!0&&Z.copy(F);break;case"Q":J=y(le);for(let q=0,oe=J.length;q<oe;q+=4)G.quadraticCurveTo(J[q+0],J[q+1],J[q+2],J[q+3]),k.x=J[q+0],k.y=J[q+1],F.x=J[q+2],F.y=J[q+3],q===0&&X===!0&&Z.copy(F);break;case"T":J=y(le);for(let q=0,oe=J.length;q<oe;q+=2){const Ie=p(F.x,k.x),_e=p(F.y,k.y);G.quadraticCurveTo(Ie,_e,J[q+0],J[q+1]),k.x=Ie,k.y=_e,F.x=J[q+0],F.y=J[q+1],q===0&&X===!0&&Z.copy(F)}break;case"A":J=y(le,[3,4],7);for(let q=0,oe=J.length;q<oe;q+=7){if(J[q+5]==F.x&&J[q+6]==F.y)continue;const Ie=F.clone();F.x=J[q+5],F.y=J[q+6],k.x=F.x,k.y=F.y,a(G,J[q],J[q+1],J[q+2],J[q+3],J[q+4],Ie,F),q===0&&X===!0&&Z.copy(F)}break;case"m":J=y(le);for(let q=0,oe=J.length;q<oe;q+=2)F.x+=J[q+0],F.y+=J[q+1],k.x=F.x,k.y=F.y,q===0?G.moveTo(F.x,F.y):G.lineTo(F.x,F.y),q===0&&Z.copy(F);break;case"h":J=y(le);for(let q=0,oe=J.length;q<oe;q++)F.x+=J[q],k.x=F.x,k.y=F.y,G.lineTo(F.x,F.y),q===0&&X===!0&&Z.copy(F);break;case"v":J=y(le);for(let q=0,oe=J.length;q<oe;q++)F.y+=J[q],k.x=F.x,k.y=F.y,G.lineTo(F.x,F.y),q===0&&X===!0&&Z.copy(F);break;case"l":J=y(le);for(let q=0,oe=J.length;q<oe;q+=2)F.x+=J[q+0],F.y+=J[q+1],k.x=F.x,k.y=F.y,G.lineTo(F.x,F.y),q===0&&X===!0&&Z.copy(F);break;case"c":J=y(le);for(let q=0,oe=J.length;q<oe;q+=6)G.bezierCurveTo(F.x+J[q+0],F.y+J[q+1],F.x+J[q+2],F.y+J[q+3],F.x+J[q+4],F.y+J[q+5]),k.x=F.x+J[q+2],k.y=F.y+J[q+3],F.x+=J[q+4],F.y+=J[q+5],q===0&&X===!0&&Z.copy(F);break;case"s":J=y(le);for(let q=0,oe=J.length;q<oe;q+=4)G.bezierCurveTo(p(F.x,k.x),p(F.y,k.y),F.x+J[q+0],F.y+J[q+1],F.x+J[q+2],F.y+J[q+3]),k.x=F.x+J[q+0],k.y=F.y+J[q+1],F.x+=J[q+2],F.y+=J[q+3],q===0&&X===!0&&Z.copy(F);break;case"q":J=y(le);for(let q=0,oe=J.length;q<oe;q+=4)G.quadraticCurveTo(F.x+J[q+0],F.y+J[q+1],F.x+J[q+2],F.y+J[q+3]),k.x=F.x+J[q+0],k.y=F.y+J[q+1],F.x+=J[q+2],F.y+=J[q+3],q===0&&X===!0&&Z.copy(F);break;case"t":J=y(le);for(let q=0,oe=J.length;q<oe;q+=2){const Ie=p(F.x,k.x),_e=p(F.y,k.y);G.quadraticCurveTo(Ie,_e,F.x+J[q+0],F.y+J[q+1]),k.x=Ie,k.y=_e,F.x=F.x+J[q+0],F.y=F.y+J[q+1],q===0&&X===!0&&Z.copy(F)}break;case"a":J=y(le,[3,4],7);for(let q=0,oe=J.length;q<oe;q+=7){if(J[q+5]==0&&J[q+6]==0)continue;const Ie=F.clone();F.x+=J[q+5],F.y+=J[q+6],k.x=F.x,k.y=F.y,a(G,J[q],J[q+1],J[q+2],J[q+3],J[q+4],Ie,F),q===0&&X===!0&&Z.copy(F)}break;case"Z":case"z":G.currentPath.autoClose=!0,G.currentPath.curves.length>0&&(F.copy(Z),G.currentPath.currentPoint.copy(F),ne=!0);break;default:console.warn(se)}X=!1}return G}function o(P){if(!(!P.sheet||!P.sheet.cssRules||!P.sheet.cssRules.length))for(let G=0;G<P.sheet.cssRules.length;G++){const F=P.sheet.cssRules[G];if(F.type!==1)continue;const k=F.selectorText.split(/,/gm).filter(Boolean).map(Z=>Z.trim());for(let Z=0;Z<k.length;Z++){const ne=Object.fromEntries(Object.entries(F.style).filter(([,X])=>X!==""));M[k[Z]]=Object.assign(M[k[Z]]||{},ne)}}}function a(P,G,F,k,Z,ne,X,te){if(G==0||F==0){P.lineTo(te.x,te.y);return}k=k*Math.PI/180,G=Math.abs(G),F=Math.abs(F);const ye=(X.x-te.x)/2,ve=(X.y-te.y)/2,re=Math.cos(k)*ye+Math.sin(k)*ve,se=-Math.sin(k)*ye+Math.cos(k)*ve;let he=G*G,le=F*F;const J=re*re,q=se*se,oe=J/he+q/le;if(oe>1){const rt=Math.sqrt(oe);G=rt*G,F=rt*F,he=G*G,le=F*F}const Ie=he*q+le*J,_e=(he*le-Ie)/Ie;let Be=Math.sqrt(Math.max(0,_e));Z===ne&&(Be=-Be);const Se=Be*G*se/F,Ke=-Be*F*re/G,Me=Math.cos(k)*Se-Math.sin(k)*Ke+(X.x+te.x)/2,Ge=Math.sin(k)*Se+Math.cos(k)*Ke+(X.y+te.y)/2,Qe=l(1,0,(re-Se)/G,(se-Ke)/F),qe=l((re-Se)/G,(se-Ke)/F,(-re-Se)/G,(-se-Ke)/F)%(Math.PI*2);P.currentPath.absellipse(Me,Ge,G,F,Qe,Qe+qe,ne===0,k)}function l(P,G,F,k){const Z=P*F+G*k,ne=Math.sqrt(P*P+G*G)*Math.sqrt(F*F+k*k);let X=Math.acos(Math.max(-1,Math.min(1,Z/ne)));return P*k-G*F<0&&(X=-X),X}function c(P){const G=x(P.getAttribute("x")||0),F=x(P.getAttribute("y")||0),k=x(P.getAttribute("rx")||P.getAttribute("ry")||0),Z=x(P.getAttribute("ry")||P.getAttribute("rx")||0),ne=x(P.getAttribute("width")),X=x(P.getAttribute("height")),te=1-.551915024494,ye=new Rr;return ye.moveTo(G+k,F),ye.lineTo(G+ne-k,F),(k!==0||Z!==0)&&ye.bezierCurveTo(G+ne-k*te,F,G+ne,F+Z*te,G+ne,F+Z),ye.lineTo(G+ne,F+X-Z),(k!==0||Z!==0)&&ye.bezierCurveTo(G+ne,F+X-Z*te,G+ne-k*te,F+X,G+ne-k,F+X),ye.lineTo(G+k,F+X),(k!==0||Z!==0)&&ye.bezierCurveTo(G+k*te,F+X,G,F+X-Z*te,G,F+X-Z),ye.lineTo(G,F+Z),(k!==0||Z!==0)&&ye.bezierCurveTo(G,F+Z*te,G+k*te,F,G+k,F),ye}function u(P){function G(ne,X,te){const ye=x(X),ve=x(te);Z===0?k.moveTo(ye,ve):k.lineTo(ye,ve),Z++}const F=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,k=new Rr;let Z=0;return P.getAttribute("points").replace(F,G),k.currentPath.autoClose=!0,k}function h(P){function G(ne,X,te){const ye=x(X),ve=x(te);Z===0?k.moveTo(ye,ve):k.lineTo(ye,ve),Z++}const F=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,k=new Rr;let Z=0;return P.getAttribute("points").replace(F,G),k.currentPath.autoClose=!1,k}function f(P){const G=x(P.getAttribute("cx")||0),F=x(P.getAttribute("cy")||0),k=x(P.getAttribute("r")||0),Z=new Nf;Z.absarc(G,F,k,0,Math.PI*2);const ne=new Rr;return ne.subPaths.push(Z),ne}function d(P){const G=x(P.getAttribute("cx")||0),F=x(P.getAttribute("cy")||0),k=x(P.getAttribute("rx")||0),Z=x(P.getAttribute("ry")||0),ne=new Nf;ne.absellipse(G,F,k,Z,0,Math.PI*2);const X=new Rr;return X.subPaths.push(ne),X}function m(P){const G=x(P.getAttribute("x1")||0),F=x(P.getAttribute("y1")||0),k=x(P.getAttribute("x2")||0),Z=x(P.getAttribute("y2")||0),ne=new Rr;return ne.moveTo(G,F),ne.lineTo(k,Z),ne.currentPath.autoClose=!1,ne}function A(P,G){G=Object.assign({},G);let F={};if(P.hasAttribute("class")){const X=P.getAttribute("class").split(/\s/).filter(Boolean).map(te=>te.trim());for(let te=0;te<X.length;te++)F=Object.assign(F,M["."+X[te]])}P.hasAttribute("id")&&(F=Object.assign(F,M["#"+P.getAttribute("id")]));function k(X,te,ye){ye===void 0&&(ye=function(re){return re.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),re}),P.hasAttribute(X)&&(G[te]=ye(P.getAttribute(X))),F[X]&&(G[te]=ye(F[X])),P.style&&P.style[X]!==""&&(G[te]=ye(P.style[X]))}function Z(X){return Math.max(0,Math.min(1,x(X)))}function ne(X){return Math.max(0,x(X))}return k("fill","fill"),k("fill-opacity","fillOpacity",Z),k("fill-rule","fillRule"),k("opacity","opacity",Z),k("stroke","stroke"),k("stroke-opacity","strokeOpacity",Z),k("stroke-width","strokeWidth",ne),k("stroke-linejoin","strokeLineJoin"),k("stroke-linecap","strokeLineCap"),k("stroke-miterlimit","strokeMiterLimit",ne),k("visibility","visibility"),G}function p(P,G){return P-(G-P)}function y(P,G,F){if(typeof P!="string")throw new TypeError("Invalid input: "+typeof P);const k={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/},Z=0,ne=1,X=2,te=3;let ye=Z,ve=!0,re="",se="";const he=[];function le(Ie,_e,Be){const Se=new SyntaxError('Unexpected character "'+Ie+'" at index '+_e+".");throw Se.partial=Be,Se}function J(){re!==""&&(se===""?he.push(Number(re)):he.push(Number(re)*Math.pow(10,Number(se)))),re="",se=""}let q;const oe=P.length;for(let Ie=0;Ie<oe;Ie++){if(q=P[Ie],Array.isArray(G)&&G.includes(he.length%F)&&k.FLAGS.test(q)){ye=ne,re=q,J();continue}if(ye===Z){if(k.WHITESPACE.test(q))continue;if(k.DIGIT.test(q)||k.SIGN.test(q)){ye=ne,re=q;continue}if(k.POINT.test(q)){ye=X,re=q;continue}k.COMMA.test(q)&&(ve&&le(q,Ie,he),ve=!0)}if(ye===ne){if(k.DIGIT.test(q)){re+=q;continue}if(k.POINT.test(q)){re+=q,ye=X;continue}if(k.EXP.test(q)){ye=te;continue}k.SIGN.test(q)&&re.length===1&&k.SIGN.test(re[0])&&le(q,Ie,he)}if(ye===X){if(k.DIGIT.test(q)){re+=q;continue}if(k.EXP.test(q)){ye=te;continue}k.POINT.test(q)&&re[re.length-1]==="."&&le(q,Ie,he)}if(ye===te){if(k.DIGIT.test(q)){se+=q;continue}if(k.SIGN.test(q)){if(se===""){se+=q;continue}se.length===1&&k.SIGN.test(se)&&le(q,Ie,he)}}k.WHITESPACE.test(q)?(J(),ye=Z,ve=!1):k.COMMA.test(q)?(J(),ye=Z,ve=!0):k.SIGN.test(q)?(J(),ye=ne,re=q):k.POINT.test(q)?(J(),ye=X,re=q):le(q,Ie,he)}return J(),he}const v=["mm","cm","in","pt","pc","px"],E={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:72/6,pc:1,px:-1},px:{px:1}};function x(P){let G="px";if(typeof P=="string"||P instanceof String)for(let k=0,Z=v.length;k<Z;k++){const ne=v[k];if(P.endsWith(ne)){G=ne,P=P.substring(0,P.length-ne.length);break}}let F;return G==="px"&&i.defaultUnit!=="px"?F=E.in[i.defaultUnit]/i.defaultDPI:(F=E[G][i.defaultUnit],F<0&&(F=E[G].in*i.defaultDPI)),F*parseFloat(P)}function I(P){if(!(P.hasAttribute("transform")||P.nodeName==="use"&&(P.hasAttribute("x")||P.hasAttribute("y"))))return null;const G=C(P);return O.length>0&&G.premultiply(O[O.length-1]),z.copy(G),O.push(G),G}function C(P){const G=new Fn,F=U;if(P.nodeName==="use"&&(P.hasAttribute("x")||P.hasAttribute("y"))){const k=x(P.getAttribute("x")),Z=x(P.getAttribute("y"));G.translate(k,Z)}if(P.hasAttribute("transform")){const k=P.getAttribute("transform").split(")");for(let Z=k.length-1;Z>=0;Z--){const ne=k[Z].trim();if(ne==="")continue;const X=ne.indexOf("("),te=ne.length;if(X>0&&X<te){const ye=ne.slice(0,X),ve=y(ne.slice(X+1));switch(F.identity(),ye){case"translate":if(ve.length>=1){const re=ve[0];let se=0;ve.length>=2&&(se=ve[1]),F.translate(re,se)}break;case"rotate":if(ve.length>=1){let re=0,se=0,he=0;re=ve[0]*Math.PI/180,ve.length>=3&&(se=ve[1],he=ve[2]),Y.makeTranslation(-se,-he),W.makeRotation(re),N.multiplyMatrices(W,Y),Y.makeTranslation(se,he),F.multiplyMatrices(Y,N)}break;case"scale":if(ve.length>=1){const re=ve[0];let se=re;ve.length>=2&&(se=ve[1]),F.scale(re,se)}break;case"skewX":ve.length===1&&F.set(1,Math.tan(ve[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":ve.length===1&&F.set(1,0,0,Math.tan(ve[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":ve.length===6&&F.set(ve[0],ve[2],ve[4],ve[1],ve[3],ve[5],0,0,1);break}}G.premultiply(F)}}return G}function _(P,G){function F(X){D.set(X.x,X.y,1).applyMatrix3(G),X.set(D.x,D.y)}function k(X){const te=X.xRadius,ye=X.yRadius,ve=Math.cos(X.aRotation),re=Math.sin(X.aRotation),se=new Q(te*ve,te*re,0),he=new Q(-ye*re,ye*ve,0),le=se.applyMatrix3(G),J=he.applyMatrix3(G),q=U.set(le.x,J.x,0,le.y,J.y,0,0,0,1),oe=Y.copy(q).invert(),Be=W.copy(oe).transpose().multiply(oe).elements,Se=w(Be[0],Be[1],Be[4]),Ke=Math.sqrt(Se.rt1),Me=Math.sqrt(Se.rt2);if(X.xRadius=1/Ke,X.yRadius=1/Me,X.aRotation=Math.atan2(Se.sn,Se.cs),!((X.aEndAngle-X.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const Qe=Y.set(Ke,0,0,0,Me,0,0,0,1),qe=W.set(Se.cs,Se.sn,0,-Se.sn,Se.cs,0,0,0,1),rt=Qe.multiply(qe).multiply(q),gt=nt=>{const{x:Xe,y:je}=new Q(Math.cos(nt),Math.sin(nt),0).applyMatrix3(rt);return Math.atan2(je,Xe)};X.aStartAngle=gt(X.aStartAngle),X.aEndAngle=gt(X.aEndAngle),S(G)&&(X.aClockwise=!X.aClockwise)}}function Z(X){const te=T(G),ye=R(G);X.xRadius*=te,X.yRadius*=ye;const ve=te>Number.EPSILON?Math.atan2(G.elements[1],G.elements[0]):Math.atan2(-G.elements[3],G.elements[4]);X.aRotation+=ve,S(G)&&(X.aStartAngle*=-1,X.aEndAngle*=-1,X.aClockwise=!X.aClockwise)}const ne=P.subPaths;for(let X=0,te=ne.length;X<te;X++){const ve=ne[X].curves;for(let re=0;re<ve.length;re++){const se=ve[re];se.isLineCurve?(F(se.v1),F(se.v2)):se.isCubicBezierCurve?(F(se.v0),F(se.v1),F(se.v2),F(se.v3)):se.isQuadraticBezierCurve?(F(se.v0),F(se.v1),F(se.v2)):se.isEllipseCurve&&(K.set(se.aX,se.aY),F(K),se.aX=K.x,se.aY=K.y,b(G)?k(se):Z(se))}}}function S(P){const G=P.elements;return G[0]*G[4]-G[1]*G[3]<0}function b(P){const G=P.elements,F=G[0]*G[3]+G[1]*G[4];if(F===0)return!1;const k=T(P),Z=R(P);return Math.abs(F/(k*Z))>Number.EPSILON}function T(P){const G=P.elements;return Math.sqrt(G[0]*G[0]+G[1]*G[1])}function R(P){const G=P.elements;return Math.sqrt(G[3]*G[3]+G[4]*G[4])}function w(P,G,F){let k,Z,ne,X,te;const ye=P+F,ve=P-F,re=Math.sqrt(ve*ve+4*G*G);return ye>0?(k=.5*(ye+re),te=1/k,Z=P*te*F-G*te*G):ye<0?Z=.5*(ye-re):(k=.5*re,Z=-.5*re),ve>0?ne=ve+re:ne=ve-re,Math.abs(ne)>2*Math.abs(G)?(te=-2*G/ne,X=1/Math.sqrt(1+te*te),ne=te*X):Math.abs(G)===0?(ne=1,X=0):(te=-.5*ne/G,ne=1/Math.sqrt(1+te*te),X=te*ne),ve>0&&(te=ne,ne=-X,X=te),{rt1:k,rt2:Z,cs:ne,sn:X}}const B=[],M={},O=[],U=new Fn,Y=new Fn,W=new Fn,N=new Fn,K=new De,D=new Q,z=new Fn,$=new DOMParser().parseFromString(t,"image/svg+xml");return n($.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:B,xml:$.documentElement}}static createShapes(t){const n={ORIGIN:0,DESTINATION:1,BETWEEN:2,LEFT:3,RIGHT:4,BEHIND:5,BEYOND:6},s={loc:n.ORIGIN,t:0};function o(p,y,v,E){const x=p.x,I=y.x,C=v.x,_=E.x,S=p.y,b=y.y,T=v.y,R=E.y,w=(_-C)*(S-T)-(R-T)*(x-C),B=(I-x)*(S-T)-(b-S)*(x-C),M=(R-T)*(I-x)-(_-C)*(b-S),O=w/M,U=B/M;if(M===0&&w!==0||O<=0||O>=1||U<0||U>1)return null;if(w===0&&M===0){for(let Y=0;Y<2;Y++)if(a(Y===0?v:E,p,y),s.loc==n.ORIGIN){const W=Y===0?v:E;return{x:W.x,y:W.y,t:s.t}}else if(s.loc==n.BETWEEN){const W=+(x+s.t*(I-x)).toPrecision(10),N=+(S+s.t*(b-S)).toPrecision(10);return{x:W,y:N,t:s.t}}return null}else{for(let N=0;N<2;N++)if(a(N===0?v:E,p,y),s.loc==n.ORIGIN){const K=N===0?v:E;return{x:K.x,y:K.y,t:s.t}}const Y=+(x+O*(I-x)).toPrecision(10),W=+(S+O*(b-S)).toPrecision(10);return{x:Y,y:W,t:O}}}function a(p,y,v){const E=v.x-y.x,x=v.y-y.y,I=p.x-y.x,C=p.y-y.y,_=E*C-I*x;if(p.x===y.x&&p.y===y.y){s.loc=n.ORIGIN,s.t=0;return}if(p.x===v.x&&p.y===v.y){s.loc=n.DESTINATION,s.t=1;return}if(_<-Number.EPSILON){s.loc=n.LEFT;return}if(_>Number.EPSILON){s.loc=n.RIGHT;return}if(E*I<0||x*C<0){s.loc=n.BEHIND;return}if(Math.sqrt(E*E+x*x)<Math.sqrt(I*I+C*C)){s.loc=n.BEYOND;return}let S;E!==0?S=I/E:S=C/x,s.loc=n.BETWEEN,s.t=S}function l(p,y){const v=[],E=[];for(let x=1;x<p.length;x++){const I=p[x-1],C=p[x];for(let _=1;_<y.length;_++){const S=y[_-1],b=y[_],T=o(I,C,S,b);T!==null&&v.find(R=>R.t<=T.t+Number.EPSILON&&R.t>=T.t-Number.EPSILON)===void 0&&(v.push(T),E.push(new De(T.x,T.y)))}}return E}function c(p,y,v){const E=new De;y.getCenter(E);const x=[];return v.forEach(I=>{I.boundingBox.containsPoint(E)&&l(p,I.points).forEach(_=>{x.push({identifier:I.identifier,isCW:I.isCW,point:_})})}),x.sort((I,C)=>I.point.x-C.point.x),x}function u(p,y,v,E,x){(x==null||x==="")&&(x="nonzero");const I=new De;p.boundingBox.getCenter(I);const C=[new De(v,I.y),new De(E,I.y)],_=c(C,p.boundingBox,y);_.sort((B,M)=>B.point.x-M.point.x);const S=[],b=[];_.forEach(B=>{B.identifier===p.identifier?S.push(B):b.push(B)});const T=S[0].point.x,R=[];let w=0;for(;w<b.length&&b[w].point.x<T;)R.length>0&&R[R.length-1]===b[w].identifier?R.pop():R.push(b[w].identifier),w++;if(R.push(p.identifier),x==="evenodd"){const B=R.length%2===0,M=R[R.length-2];return{identifier:p.identifier,isHole:B,for:M}}else if(x==="nonzero"){let B=!0,M=null,O=null;for(let U=0;U<R.length;U++){const Y=R[U];B?(O=y[Y].isCW,B=!1,M=Y):O!==y[Y].isCW&&(O=y[Y].isCW,B=!0)}return{identifier:p.identifier,isHole:B,for:M}}else console.warn('fill-rule: "'+x+'" is currently not implemented.')}let h=999999999,f=-999999999,d=t.subPaths.map(p=>{const y=p.getPoints();let v=-999999999,E=999999999,x=-999999999,I=999999999;for(let C=0;C<y.length;C++){const _=y[C];_.y>v&&(v=_.y),_.y<E&&(E=_.y),_.x>x&&(x=_.x),_.x<I&&(I=_.x)}return f<=x&&(f=x+1),h>=I&&(h=I-1),{curves:p.curves,points:y,isCW:i_.isClockWise(y),identifier:-1,boundingBox:new t_(new De(I,E),new De(x,v))}});d=d.filter(p=>p.points.length>1);for(let p=0;p<d.length;p++)d[p].identifier=p;const m=d.map(p=>u(p,d,h,f,t.userData?t.userData.style.fillRule:void 0)),A=[];return d.forEach(p=>{if(!m[p.identifier].isHole){const v=new yE;v.curves=p.curves,m.filter(x=>x.isHole&&x.for===p.identifier).forEach(x=>{const I=d[x.identifier],C=new Nf;C.curves=I.curves,v.holes.push(C)}),A.push(v)}}),A}static getStrokeStyle(t,i,n,s,o){return t=t!==void 0?t:1,i=i!==void 0?i:"#000",n=n!==void 0?n:"miter",s=s!==void 0?s:"butt",o=o!==void 0?o:4,{strokeColor:i,strokeWidth:t,strokeLineJoin:n,strokeLineCap:s,strokeMiterLimit:o}}static pointsToStroke(t,i,n,s){const o=[],a=[],l=[];if(r.pointsToStrokeWithBuffers(t,i,n,s,o,a,l)===0)return null;const c=new Gi;return c.setAttribute("position",new Yi(o,3)),c.setAttribute("normal",new Yi(a,3)),c.setAttribute("uv",new Yi(l,2)),c}static pointsToStrokeWithBuffers(t,i,n,s,o,a,l,c){const u=new De,h=new De,f=new De,d=new De,m=new De,A=new De,p=new De,y=new De,v=new De,E=new De,x=new De,I=new De,C=new De,_=new De,S=new De,b=new De,T=new De;n=n!==void 0?n:12,s=s!==void 0?s:.001,c=c!==void 0?c:0,t=ve(t);const R=t.length;if(R<2)return 0;const w=t[0].equals(t[R-1]);let B,M=t[0],O;const U=i.strokeWidth/2,Y=1/(R-1);let W=0,N,K,D,z,$=!1,V=0,P=c*3,G=c*2;F(t[0],t[1],u).multiplyScalar(U),y.copy(t[0]).sub(u),v.copy(t[0]).add(u),E.copy(y),x.copy(v);for(let re=1;re<R;re++){B=t[re],re===R-1?w?O=t[1]:O=void 0:O=t[re+1];const se=u;if(F(M,B,se),f.copy(se).multiplyScalar(U),I.copy(B).sub(f),C.copy(B).add(f),N=W+Y,K=!1,O!==void 0){F(B,O,h),f.copy(h).multiplyScalar(U),_.copy(B).sub(f),S.copy(B).add(f),D=!0,f.subVectors(O,M),se.dot(f)<0&&(D=!1),re===1&&($=D),f.subVectors(O,B),f.normalize();const he=Math.abs(se.dot(f));if(he>Number.EPSILON){const le=U/he;f.multiplyScalar(-le),d.subVectors(B,M),m.copy(d).setLength(le).add(f),b.copy(m).negate();const J=m.length(),q=d.length();d.divideScalar(q),A.subVectors(O,B);const oe=A.length();switch(A.divideScalar(oe),d.dot(b)<q&&A.dot(b)<oe&&(K=!0),T.copy(m).add(B),b.add(B),z=!1,K?D?(S.copy(b),C.copy(b)):(_.copy(b),I.copy(b)):ne(),i.strokeLineJoin){case"bevel":X(D,K,N);break;case"round":te(D,K),D?Z(B,I,_,N,0):Z(B,S,C,N,1);break;case"miter":case"miter-clip":default:const Ie=U*i.strokeMiterLimit/J;if(Ie<1)if(i.strokeLineJoin!=="miter-clip"){X(D,K,N);break}else te(D,K),D?(A.subVectors(T,I).multiplyScalar(Ie).add(I),p.subVectors(T,_).multiplyScalar(Ie).add(_),k(I,N,0),k(A,N,0),k(B,N,.5),k(B,N,.5),k(A,N,0),k(p,N,0),k(B,N,.5),k(p,N,0),k(_,N,0)):(A.subVectors(T,C).multiplyScalar(Ie).add(C),p.subVectors(T,S).multiplyScalar(Ie).add(S),k(C,N,1),k(A,N,1),k(B,N,.5),k(B,N,.5),k(A,N,1),k(p,N,1),k(B,N,.5),k(p,N,1),k(S,N,1));else K?(D?(k(v,W,1),k(y,W,0),k(T,N,0),k(v,W,1),k(T,N,0),k(b,N,1)):(k(v,W,1),k(y,W,0),k(T,N,1),k(y,W,0),k(b,N,0),k(T,N,1)),D?_.copy(T):S.copy(T)):D?(k(I,N,0),k(T,N,0),k(B,N,.5),k(B,N,.5),k(T,N,0),k(_,N,0)):(k(C,N,1),k(T,N,1),k(B,N,.5),k(B,N,.5),k(T,N,1),k(S,N,1)),z=!0;break}}else ne()}else ne();!w&&re===R-1&&ye(t[0],E,x,D,!0,W),W=N,M=B,y.copy(_),v.copy(S)}if(!w)ye(B,I,C,D,!1,N);else if(K&&o){let re=T,se=b;$!==D&&(re=b,se=T),D?(z||$)&&(se.toArray(o,0),se.toArray(o,9),z&&re.toArray(o,3)):(z||!$)&&(se.toArray(o,3),se.toArray(o,9),z&&re.toArray(o,0))}return V;function F(re,se,he){return he.subVectors(se,re),he.set(-he.y,he.x).normalize()}function k(re,se,he){o&&(o[P]=re.x,o[P+1]=re.y,o[P+2]=0,a&&(a[P]=0,a[P+1]=0,a[P+2]=1),P+=3,l&&(l[G]=se,l[G+1]=he,G+=2)),V+=3}function Z(re,se,he,le,J){u.copy(se).sub(re).normalize(),h.copy(he).sub(re).normalize();let q=Math.PI;const oe=u.dot(h);Math.abs(oe)<1&&(q=Math.abs(Math.acos(oe))),q/=n,f.copy(se);for(let Ie=0,_e=n-1;Ie<_e;Ie++)d.copy(f).rotateAround(re,q),k(f,le,J),k(d,le,J),k(re,le,.5),f.copy(d);k(d,le,J),k(he,le,J),k(re,le,.5)}function ne(){k(v,W,1),k(y,W,0),k(I,N,0),k(v,W,1),k(I,N,0),k(C,N,1)}function X(re,se,he){se?re?(k(v,W,1),k(y,W,0),k(I,N,0),k(v,W,1),k(I,N,0),k(b,N,1),k(I,he,0),k(_,he,0),k(b,he,.5)):(k(v,W,1),k(y,W,0),k(C,N,1),k(y,W,0),k(b,N,0),k(C,N,1),k(C,he,1),k(b,he,0),k(S,he,1)):re?(k(I,he,0),k(_,he,0),k(B,he,.5)):(k(C,he,1),k(S,he,0),k(B,he,.5))}function te(re,se){se&&(re?(k(v,W,1),k(y,W,0),k(I,N,0),k(v,W,1),k(I,N,0),k(b,N,1),k(I,W,0),k(B,N,.5),k(b,N,1),k(B,N,.5),k(_,W,0),k(b,N,1)):(k(v,W,1),k(y,W,0),k(C,N,1),k(y,W,0),k(b,N,0),k(C,N,1),k(C,W,1),k(b,N,0),k(B,N,.5),k(B,N,.5),k(b,N,0),k(S,W,1)))}function ye(re,se,he,le,J,q){switch(i.strokeLineCap){case"round":J?Z(re,he,se,q,.5):Z(re,se,he,q,.5);break;case"square":if(J)u.subVectors(se,re),h.set(u.y,-u.x),f.addVectors(u,h).add(re),d.subVectors(h,u).add(re),le?(f.toArray(o,3),d.toArray(o,0),d.toArray(o,9)):(f.toArray(o,3),l[7]===1?d.toArray(o,9):f.toArray(o,9),d.toArray(o,0));else{u.subVectors(he,re),h.set(u.y,-u.x),f.addVectors(u,h).add(re),d.subVectors(h,u).add(re);const oe=o.length;le?(f.toArray(o,oe-3),d.toArray(o,oe-6),d.toArray(o,oe-12)):(d.toArray(o,oe-6),f.toArray(o,oe-3),d.toArray(o,oe-12))}break}}function ve(re){let se=!1;for(let le=1,J=re.length-1;le<J;le++)if(re[le].distanceTo(re[le+1])<s){se=!0;break}if(!se)return re;const he=[];he.push(re[0]);for(let le=1,J=re.length-1;le<J;le++)re[le].distanceTo(re[le+1])>=s&&he.push(re[le]);return he.push(re[re.length-1]),he}}}return r})(),Ad=new WeakMap;class _8 extends Yr{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,n){const s=new Sn(this.manager);s.setPath(this.path),s.setResponseType("arraybuffer"),s.setRequestHeader(this.requestHeader),s.setWithCredentials(this.withCredentials),s.load(e,o=>{const a={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(o,a).then(t).catch(n)},i,n)}decodeDracoFile(e,t,i,n){const s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,s).then(t)}decodeGeometry(e,t){for(const l in t.attributeTypes){const c=t.attributeTypes[l];c.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[l]=c.name)}const i=JSON.stringify(t);if(Ad.has(e)){const l=Ad.get(e);if(l.key===i)return l.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const s=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(s,o).then(l=>(n=l,new Promise((c,u)=>{n._callbacks[s]={resolve:c,reject:u},n.postMessage({type:"decode",id:s,taskConfig:t,buffer:e},[e])}))).then(l=>this._createGeometry(l.geometry));return a.catch(()=>!0).then(()=>{n&&s&&this._releaseTask(n,s)}),Ad.set(e,{key:i,promise:a}),a}_createGeometry(e){const t=new Gi;e.index&&t.setIndex(new Vt(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const n=e.attributes[i],s=n.name,o=n.array,a=n.itemSize;t.setAttribute(s,new Vt(o,a))}return t}_loadLibrary(e,t){const i=new Sn(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise((n,s)=>{i.load(e,n,void 0,s)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(i=>{const n=i[0];e||(this.decoderConfig.wasmBinary=i[1]);const s=S8.toString(),o=["/* draco decoder */",n,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const n=new Worker(this.workerSourceURL);n._callbacks={},n._taskCosts={},n._taskLoad=0,n.postMessage({type:"init",decoderConfig:this.decoderConfig}),n.onmessage=function(s){const o=s.data;switch(o.type){case"decode":n._callbacks[o.id].resolve(o);break;case"error":n._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(n)}else this.workerPool.sort(function(n,s){return n._taskLoad>s._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function S8(){let r,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":r=a.decoderConfig,e=new Promise(function(u){r.onModuleLoaded=function(h){u({draco:h})},DracoDecoderModule(r)});break;case"decode":const l=a.buffer,c=a.taskConfig;e.then(u=>{const h=u.draco,f=new h.Decoder,d=new h.DecoderBuffer;d.Init(new Int8Array(l),l.byteLength);try{const m=t(h,f,d,c),A=m.attributes.map(p=>p.array.buffer);m.index&&A.push(m.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:m},A)}catch(m){console.error(m),self.postMessage({type:"error",id:a.id,error:m.message})}finally{h.destroy(d),h.destroy(f)}});break}};function t(o,a,l,c){const u=c.attributeIDs,h=c.attributeTypes;let f,d;const m=a.GetEncodedGeometryType(l);if(m===o.TRIANGULAR_MESH)f=new o.Mesh,d=a.DecodeBufferToMesh(l,f);else if(m===o.POINT_CLOUD)f=new o.PointCloud,d=a.DecodeBufferToPointCloud(l,f);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!d.ok()||f.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+d.error_msg());const A={index:null,attributes:[]};for(const p in u){const y=self[h[p]];let v,E;if(c.useUniqueIDs)E=u[p],v=a.GetAttributeByUniqueId(f,E);else{if(E=a.GetAttributeId(f,o[u[p]]),E===-1)continue;v=a.GetAttribute(f,E)}A.attributes.push(n(o,a,f,p,y,v))}return m===o.TRIANGULAR_MESH&&(A.index=i(o,a,f)),o.destroy(f),A}function i(o,a,l){const u=l.num_faces()*3,h=u*4,f=o._malloc(h);a.GetTrianglesUInt32Array(l,h,f);const d=new Uint32Array(o.HEAPF32.buffer,f,u).slice();return o._free(f),{array:d,itemSize:1}}function n(o,a,l,c,u,h){const f=h.num_components(),m=l.num_points()*f,A=m*u.BYTES_PER_ELEMENT,p=s(o,u),y=o._malloc(A);a.GetAttributeDataArrayForAllPoints(l,h,p,A,y);const v=new u(o.HEAPF32.buffer,y,m).slice();return o._free(y),{name:c,array:v,itemSize:f}}function s(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}const D1=new Jt,eu=new Q;class uf extends sA{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],i=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(i),this.setAttribute("position",new Yi(e,3)),this.setAttribute("uv",new Yi(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new V0(t,6,1);return this.setAttribute("instanceStart",new lo(i,3,0)),this.setAttribute("instanceEnd",new lo(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let i;e instanceof Float32Array?i=e:Array.isArray(e)&&(i=new Float32Array(e));const n=new V0(i,t*2,1);return this.setAttribute("instanceColorStart",new lo(n,t,0)),this.setAttribute("instanceColorEnd",new lo(n,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new n_(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Jt);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),D1.setFromBufferAttribute(t),this.boundingBox.union(D1))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new hn),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const i=this.boundingSphere.center;this.boundingBox.getCenter(i);let n=0;for(let s=0,o=e.count;s<o;s++)eu.fromBufferAttribute(e,s),n=Math.max(n,i.distanceToSquared(eu)),eu.fromBufferAttribute(t,s),n=Math.max(n,i.distanceToSquared(eu));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}class mx extends uf{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,i=new Float32Array(2*t);for(let n=0;n<t;n+=3)i[2*n]=e[n],i[2*n+1]=e[n+1],i[2*n+2]=e[n+2],i[2*n+3]=e[n+3],i[2*n+4]=e[n+4],i[2*n+5]=e[n+5];return super.setPositions(i),this}setColors(e,t=3){const i=e.length-t,n=new Float32Array(2*i);if(t===3)for(let s=0;s<i;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5];else for(let s=0;s<i;s+=t)n[2*s]=e[s],n[2*s+1]=e[s+1],n[2*s+2]=e[s+2],n[2*s+3]=e[s+3],n[2*s+4]=e[s+4],n[2*s+5]=e[s+5],n[2*s+6]=e[s+6],n[2*s+7]=e[s+7];return super.setColors(n,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class hf extends Ii{constructor(e){super({type:"LineMaterial",uniforms:Ba.clone(Ba.merge([K0.common,K0.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new De(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:`
				#include <common>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>

				uniform float linewidth;
				uniform vec2 resolution;

				attribute vec3 instanceStart;
				attribute vec3 instanceEnd;

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
						attribute vec4 instanceColorStart;
						attribute vec4 instanceColorEnd;
					#else
						varying vec3 vLineColor;
						attribute vec3 instanceColorStart;
						attribute vec3 instanceColorEnd;
					#endif
				#endif

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#ifdef USE_DASH

					uniform float dashScale;
					attribute float instanceDistanceStart;
					attribute float instanceDistanceEnd;
					varying float vLineDistance;

				#endif

				void trimSegment( const in vec4 start, inout vec4 end ) {

					// trim end segment so it terminates between the camera plane and the near plane

					// conservative estimate of the near plane
					float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
					float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
					float nearEstimate = - 0.5 * b / a;

					float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

					end.xyz = mix( start.xyz, end.xyz, alpha );

				}

				void main() {

					#ifdef USE_COLOR

						vLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

					#endif

					#ifdef USE_DASH

						vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
						vUv = uv;

					#endif

					float aspect = resolution.x / resolution.y;

					// camera space
					vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
					vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

					#ifdef WORLD_UNITS

						worldStart = start.xyz;
						worldEnd = end.xyz;

					#else

						vUv = uv;

					#endif

					// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
					// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
					// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
					// perhaps there is a more elegant solution -- WestLangley

					bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

					if ( perspective ) {

						if ( start.z < 0.0 && end.z >= 0.0 ) {

							trimSegment( start, end );

						} else if ( end.z < 0.0 && start.z >= 0.0 ) {

							trimSegment( end, start );

						}

					}

					// clip space
					vec4 clipStart = projectionMatrix * start;
					vec4 clipEnd = projectionMatrix * end;

					// ndc space
					vec3 ndcStart = clipStart.xyz / clipStart.w;
					vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

					// direction
					vec2 dir = ndcEnd.xy - ndcStart.xy;

					// account for clip-space aspect ratio
					dir.x *= aspect;
					dir = normalize( dir );

					#ifdef WORLD_UNITS

						// get the offset direction as perpendicular to the view vector
						vec3 worldDir = normalize( end.xyz - start.xyz );
						vec3 offset;
						if ( position.y < 0.5 ) {

							offset = normalize( cross( start.xyz, worldDir ) );

						} else {

							offset = normalize( cross( end.xyz, worldDir ) );

						}

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

						// don't extend the line if we're rendering dashes because we
						// won't be rendering the endcaps
						#ifndef USE_DASH

							// extend the line bounds to encompass  endcaps
							start.xyz += - worldDir * linewidth * 0.5;
							end.xyz += worldDir * linewidth * 0.5;

							// shift the position of the quad so it hugs the forward edge of the line
							offset.xy -= dir * forwardOffset;
							offset.z += 0.5;

						#endif

						// endcaps
						if ( position.y > 1.0 || position.y < 0.0 ) {

							offset.xy += dir * 2.0 * forwardOffset;

						}

						// adjust for linewidth
						offset *= linewidth * 0.5;

						// set the world position
						worldPos = ( position.y < 0.5 ) ? start : end;
						worldPos.xyz += offset;

						// project the worldpos
						vec4 clip = projectionMatrix * worldPos;

						// shift the depth of the projected points so the line
						// segments overlap neatly
						vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
						clip.z = clipPose.z * clip.w;

					#else

						vec2 offset = vec2( dir.y, - dir.x );
						// undo aspect ratio adjustment
						dir.x /= aspect;
						offset.x /= aspect;

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						// endcaps
						if ( position.y < 0.0 ) {

							offset += - dir;

						} else if ( position.y > 1.0 ) {

							offset += dir;

						}

						// adjust for linewidth
						offset *= linewidth;

						// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
						offset /= resolution.y;

						// select end
						vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

						// back to clip space
						offset *= clip.w;

						clip.xy += offset;

					#endif

					gl_Position = clip;

					vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>

				}
			`,fragmentShader:`
				uniform vec3 diffuse;
				uniform float opacity;
				uniform float linewidth;

				#ifdef USE_DASH

					uniform float dashOffset;
					uniform float dashSize;
					uniform float gapSize;

				#endif

				varying float vLineDistance;

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#include <common>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <clipping_planes_pars_fragment>

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
					#else
						varying vec3 vLineColor;
					#endif
				#endif

				vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

					float mua;
					float mub;

					vec3 p13 = p1 - p3;
					vec3 p43 = p4 - p3;

					vec3 p21 = p2 - p1;

					float d1343 = dot( p13, p43 );
					float d4321 = dot( p43, p21 );
					float d1321 = dot( p13, p21 );
					float d4343 = dot( p43, p43 );
					float d2121 = dot( p21, p21 );

					float denom = d2121 * d4343 - d4321 * d4321;

					float numer = d1343 * d4321 - d1321 * d4343;

					mua = numer / denom;
					mua = clamp( mua, 0.0, 1.0 );
					mub = ( d1343 + d4321 * ( mua ) ) / d4343;
					mub = clamp( mub, 0.0, 1.0 );

					return vec2( mua, mub );

				}

				void main() {

					#include <clipping_planes_fragment>

					#ifdef USE_DASH

						if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

						if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

					#endif

					float alpha = opacity;

					#ifdef WORLD_UNITS

						// Find the closest points on the view ray and the line segment
						vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
						vec3 lineDir = worldEnd - worldStart;
						vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

						vec3 p1 = worldStart + lineDir * params.x;
						vec3 p2 = rayEnd * params.y;
						vec3 delta = p1 - p2;
						float len = length( delta );
						float norm = len / linewidth;

						#ifndef USE_DASH

							#ifdef USE_ALPHA_TO_COVERAGE

								float dnorm = fwidth( norm );
								alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

							#else

								if ( norm > 0.5 ) {

									discard;

								}

							#endif

						#endif

					#else

						#ifdef USE_ALPHA_TO_COVERAGE

							// artifacts appear on some hardware if a derivative is taken within a conditional
							float a = vUv.x;
							float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
							float len2 = a * a + b * b;
							float dlen = fwidth( len2 );

							if ( abs( vUv.y ) > 1.0 ) {

								alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

							}

						#else

							if ( abs( vUv.y ) > 1.0 ) {

								float a = vUv.x;
								float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
								float len2 = a * a + b * b;

								if ( len2 > 1.0 ) discard;

							}

						#endif

					#endif

					vec4 diffuseColor = vec4( diffuse, alpha );
					#ifdef USE_COLOR
						#ifdef USE_LINE_COLOR_ALPHA
							diffuseColor *= vLineColor;
						#else
							diffuseColor.rgb *= vLineColor;
						#endif
					#endif

					#include <logdepthbuf_fragment>

					gl_FragColor = diffuseColor;

					#include <tonemapping_fragment>
					#include <${Na>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>
					#include <premultiplied_alpha_fragment>

				}
			`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(t){!!t!="USE_DASH"in this.defines&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(t){!!t!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),t===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const pd=new yi,M1=new Q,L1=new Q,qi=new yi,Xi=new yi,Rs=new yi,gd=new Q,yd=new we,en=new $s,P1=new Q,tu=new Jt,iu=new hn,Ds=new yi;let Hs,fo;function F1(r,e,t){return Ds.set(0,0,-e,1).applyMatrix4(r.projectionMatrix),Ds.multiplyScalar(1/Ds.w),Ds.x=fo/t.width,Ds.y=fo/t.height,Ds.applyMatrix4(r.projectionMatrixInverse),Ds.multiplyScalar(1/Ds.w),Math.abs(Math.max(Ds.x,Ds.y))}function T8(r,e){const t=r.matrixWorld,i=r.geometry,n=i.attributes.instanceStart,s=i.attributes.instanceEnd,o=Math.min(i.instanceCount,n.count);for(let a=0,l=o;a<l;a++){en.start.fromBufferAttribute(n,a),en.end.fromBufferAttribute(s,a),en.applyMatrix4(t);const c=new Q,u=new Q;Hs.distanceSqToSegment(en.start,en.end,u,c),u.distanceTo(c)<fo*.5&&e.push({point:u,pointOnLine:c,distance:Hs.origin.distanceTo(u),object:r,face:null,faceIndex:a,uv:null,[bA]:null})}}function b8(r,e,t){const i=e.projectionMatrix,s=r.material.resolution,o=r.matrixWorld,a=r.geometry,l=a.attributes.instanceStart,c=a.attributes.instanceEnd,u=Math.min(a.instanceCount,l.count),h=-e.near;Hs.at(1,Rs),Rs.w=1,Rs.applyMatrix4(e.matrixWorldInverse),Rs.applyMatrix4(i),Rs.multiplyScalar(1/Rs.w),Rs.x*=s.x/2,Rs.y*=s.y/2,Rs.z=0,gd.copy(Rs),yd.multiplyMatrices(e.matrixWorldInverse,o);for(let f=0,d=u;f<d;f++){if(qi.fromBufferAttribute(l,f),Xi.fromBufferAttribute(c,f),qi.w=1,Xi.w=1,qi.applyMatrix4(yd),Xi.applyMatrix4(yd),qi.z>h&&Xi.z>h)continue;if(qi.z>h){const E=qi.z-Xi.z,x=(qi.z-h)/E;qi.lerp(Xi,x)}else if(Xi.z>h){const E=Xi.z-qi.z,x=(Xi.z-h)/E;Xi.lerp(qi,x)}qi.applyMatrix4(i),Xi.applyMatrix4(i),qi.multiplyScalar(1/qi.w),Xi.multiplyScalar(1/Xi.w),qi.x*=s.x/2,qi.y*=s.y/2,Xi.x*=s.x/2,Xi.y*=s.y/2,en.start.copy(qi),en.start.z=0,en.end.copy(Xi),en.end.z=0;const A=en.closestPointToPointParameter(gd,!0);en.at(A,P1);const p=tt.lerp(qi.z,Xi.z,A),y=p>=-1&&p<=1,v=gd.distanceTo(P1)<fo*.5;if(y&&v){en.start.fromBufferAttribute(l,f),en.end.fromBufferAttribute(c,f),en.start.applyMatrix4(o),en.end.applyMatrix4(o);const E=new Q,x=new Q;Hs.distanceSqToSegment(en.start,en.end,x,E),t.push({point:x,pointOnLine:E,distance:Hs.origin.distanceTo(x),object:r,face:null,faceIndex:f,uv:null,[bA]:null})}}}class Ax extends ze{constructor(e=new uf,t=new hf({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,i=e.attributes.instanceEnd,n=new Float32Array(2*t.count);for(let o=0,a=0,l=t.count;o<l;o++,a+=2)M1.fromBufferAttribute(t,o),L1.fromBufferAttribute(i,o),n[a]=a===0?0:n[a-1],n[a+1]=n[a]+M1.distanceTo(L1);const s=new V0(n,2,1);return e.setAttribute("instanceDistanceStart",new lo(s,1,0)),e.setAttribute("instanceDistanceEnd",new lo(s,1,1)),this}raycast(e,t){const i=this.material.worldUnits,n=e.camera;n===null&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const s=e.params.Line2!==void 0&&e.params.Line2.threshold||0;Hs=e.ray;const o=this.matrixWorld,a=this.geometry,l=this.material;fo=l.linewidth+s,a.boundingSphere===null&&a.computeBoundingSphere(),iu.copy(a.boundingSphere).applyMatrix4(o);let c;if(i)c=fo*.5;else{const h=Math.max(n.near,iu.distanceToPoint(Hs.origin));c=F1(n,h,l.resolution)}if(iu.radius+=c,Hs.intersectsSphere(iu)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),tu.copy(a.boundingBox).applyMatrix4(o);let u;if(i)u=fo*.5;else{const h=Math.max(n.near,tu.distanceToPoint(Hs.origin));u=F1(n,h,l.resolution)}tu.expandByScalar(u),Hs.intersectsBox(tu)!==!1&&(i?T8(this,t):b8(this,n,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(pd),this.material.uniforms.resolution.value.set(pd.z,pd.w))}}class px extends Ax{constructor(e=new mx,t=new hf({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}let nu;const vd=()=>{if(nu)return nu;const r="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",e="B9h9z9tFBBBFiI9gBB9gLaaaaaFa9gEaaaB9gFaFaEMcBBFBFFGGGEILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBOn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBNI9z9iqlBVc+N9IcIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMk8lLbaE97F9+FaL978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAeDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAeDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBReCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBH8ZCFD9tA8ZAPD9OD9hD9RH8ZDQBTFtGmEYIPLdKeOnHpAIAQJDBIBHyCFD9tAyAPD9OD9hD9RHyAIASJDBIBH8cCFD9tA8cAPD9OD9hD9RH8cDQBTFtGmEYIPLdKeOnH8dDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAeD9uHeDyBjGBAEAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeApA8dDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNiV8ZcpMyS8cQ8df8eb8fHdAyA8cDQNiV8ZcpMyS8cQ8df8eb8fH8ZDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/dLEK97FaF97GXGXAGCI9HQBAF9FQFCBRGEXABABDBBBHECiD+rFCiD+sFD/6FHIAECND+rFCiD+sFD/6FAID/gFAECTD+rFCiD+sFD/6FHLD/gFD/kFD/lFHKCBDtD+2FHOAICUUUU94DtHND9OD9RD/kFHI9DBB/+hDYAIAID/mFAKAKD/mFALAOALAND9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHLD/mF9DBBX9LDYHOD/kFCgFDtD9OAECUUU94DtD9OD9QAIALD/mFAOD/kFCND+rFCU/+EDtD9OD9QAKALD/mFAOD/kFCTD+rFCUU/8ODtD9OD9QDMBBABCTJRBAGCIJHGAF9JQBSGMMAF9FQBCBRGEXABCTJHVAVDBBBHECBDtHOCUU98D8cFCUU98D8cEHND9OABDBBBHKAEDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAKAEDQBFGENVcMTtmYi8ZpyHECTD+sFD/6FHID/gFAECTD+rFCTD+sFD/6FHLD/gFD/kFD/lFHE9DB/+g6DYALAEAOD+2FHOALCUUUU94DtHcD9OD9RD/kFHLALD/mFAEAED/mFAIAOAIAcD9OD9RD/kFHEAED/mFD/kFD/kFD/jFD/nFHID/mF9DBBX9LDYHOD/kFCTD+rFALAID/mFAOD/kFCggEDtD9OD9QHLAEAID/mFAOD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHEDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAKAND9OALAEDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM/hEIGaF97FaL978jUUUUBCTlREGXAF9FQBCBRIEXAEABDBBBHLABCTJHKDBBBHODQILKOSQfbPden8c8d8e8fHNCTD+sFHVCID+rFDMIBAB9DBBU8/DY9D/zI818/DYAVCEDtD9QD/6FD/nFHVALAODQBFGENVcMTtmYi8ZpyHLCTD+rFCTD+sFD/6FD/mFHOAOD/mFAVALCTD+sFD/6FD/mFHcAcD/mFAVANCTD+rFCTD+sFD/6FD/mFHNAND/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHVD/mF9DBBX9LDYHLD/kFCggEDtHMD9OAcAVD/mFALD/kFCTD+rFD9QHcANAVD/mFALD/kFCTD+rFAOAVD/mFALD/kFAMD9OD9QHVDQBFTtGEmYILPdKOenHLD8dBAEDBIBDyB+t+J83EBABCNJALD8dFAEDBIBDyF+t+J83EBAKAcAVDQNVi8ZcMpySQ8c8dfb8e8fHVD8dBAEDBIBDyG+t+J83EBABCiJAVD8dFAEDBIBDyE+t+J83EBABCAJRBAICIJHIAF9JQBMMM9jFF97GXAGCGrAF9sHG9FQBCBRFEXABABDBBBHECND+rFCND+sFD/6FAECiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBABCTJRBAFCIJHFAG9JQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]);if(typeof WebAssembly!="object")return{supported:!1};let n=r;WebAssembly.validate(t)&&(n=e);let s;const o=WebAssembly.instantiate(a(n),{}).then(h=>{s=h.instance,s.exports.__wasm_call_ctors()});function a(h){const f=new Uint8Array(h.length);for(let m=0;m<h.length;++m){const A=h.charCodeAt(m);f[m]=A>96?A-71:A>64?A-65:A>47?A+4:A>46?63:62}let d=0;for(let m=0;m<h.length;++m)f[d++]=f[m]<60?i[f[m]]:(f[m]-60)*64+f[++m];return f.buffer.slice(0,d)}function l(h,f,d,m,A,p){const y=s.exports.sbrk,v=d+3&-4,E=y(v*m),x=y(A.length),I=new Uint8Array(s.exports.memory.buffer);I.set(A,x);const C=h(E,d,m,x,A.length);if(C===0&&p&&p(E,v,m),f.set(I.subarray(E,E+d*m)),y(E-y(0)),C!==0)throw new Error(`Malformed buffer data: ${C}`)}const c={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},u={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return nu={ready:o,supported:!0,decodeVertexBuffer(h,f,d,m,A){l(s.exports.meshopt_decodeVertexBuffer,h,f,d,m,s.exports[c[A]])},decodeIndexBuffer(h,f,d,m){l(s.exports.meshopt_decodeIndexBuffer,h,f,d,m)},decodeIndexSequence(h,f,d,m){l(s.exports.meshopt_decodeIndexSequence,h,f,d,m)},decodeGltfBuffer(h,f,d,m,A,p){l(s.exports[u[A]],h,f,d,m,s.exports[c[p]])}},nu},k1=r=>Symbol.iterator in r,O1=r=>"entries"in r,U1=(r,e)=>{const t=r instanceof Map?r:new Map(r.entries()),i=e instanceof Map?e:new Map(e.entries());if(t.size!==i.size)return!1;for(const[n,s]of t)if(!i.has(n)||!Object.is(s,i.get(n)))return!1;return!0},w8=(r,e)=>{const t=r[Symbol.iterator](),i=e[Symbol.iterator]();let n=t.next(),s=i.next();for(;!n.done&&!s.done;){if(!Object.is(n.value,s.value))return!1;n=t.next(),s=i.next()}return!!n.done&&!!s.done};function B8(r,e){return Object.is(r,e)?!0:typeof r!="object"||r===null||typeof e!="object"||e===null||Object.getPrototypeOf(r)!==Object.getPrototypeOf(e)?!1:k1(r)&&k1(e)?O1(r)&&O1(e)?U1(r,e):w8(r,e):U1({entries:()=>Object.entries(r)},{entries:()=>Object.entries(e)})}const gx=g.createContext([]);function VO({box:r,multiple:e,children:t,onChange:i,onChangePointerUp:n,border:s="1px solid #55aaff",backgroundColor:o="rgba(75, 160, 255, 0.1)",filter:a=c=>c,...l}){const[c,u]=g.useState(!1),{setEvents:h,camera:f,raycaster:d,gl:m,controls:A,size:p,get:y}=ae(),[v,E]=g.useState(!1),[x,I]=g.useReducer((b,{object:T,shift:R})=>T===void 0?[]:Array.isArray(T)?T:R?b.includes(T)?b.filter(w=>w!==T):[T,...b]:b[0]===T?[]:[T],[]);g.useEffect(()=>{c?i?.(x):n?.(x)},[x,c]);const C=g.useCallback(b=>{b.stopPropagation(),I({object:a([b.object])[0],shift:e&&b.shiftKey})},[]),_=g.useCallback(b=>!v&&I({}),[v]),S=g.useRef(null);return g.useEffect(()=>{if(!r||!e)return;const b=new Tw(f,S.current),T=document.createElement("div");T.style.pointerEvents="none",T.style.border=s,T.style.backgroundColor=o,T.style.position="fixed";const R=new De,w=new De,B=new De,M=y().events.enabled,O=A?.enabled;let U=!1;function Y(P,G){const{offsetX:F,offsetY:k}=P,{width:Z,height:ne}=p;G.set(F/Z*2-1,-(k/ne)*2+1)}function W(P){var G;A&&(A.enabled=!1),h({enabled:!1}),u(U=!0),(G=m.domElement.parentElement)==null||G.appendChild(T),T.style.left=`${P.clientX}px`,T.style.top=`${P.clientY}px`,T.style.width="0px",T.style.height="0px",R.x=P.clientX,R.y=P.clientY}function N(P){B.x=Math.max(R.x,P.clientX),B.y=Math.max(R.y,P.clientY),w.x=Math.min(R.x,P.clientX),w.y=Math.min(R.y,P.clientY),T.style.left=`${w.x}px`,T.style.top=`${w.y}px`,T.style.width=`${B.x-w.x}px`,T.style.height=`${B.y-w.y}px`}function K(){if(U){var P;A&&(A.enabled=O),h({enabled:M}),u(U=!1),(P=T.parentElement)==null||P.removeChild(T)}}function D(P){P.shiftKey&&(W(P),Y(P,b.startPoint))}let z=[];function $(P){if(U){N(P),Y(P,b.endPoint);const G=b.select().sort(F=>F.uuid).filter(F=>F.isMesh);B8(G,z)||(z=G,I({object:a(G)}))}}function V(P){U&&K()}return document.addEventListener("pointerdown",D,{passive:!0}),document.addEventListener("pointermove",$,{passive:!0,capture:!0}),document.addEventListener("pointerup",V,{passive:!0}),()=>{document.removeEventListener("pointerdown",D),document.removeEventListener("pointermove",$,!0),document.removeEventListener("pointerup",V)}},[p.width,p.height,d,f,A,m]),g.createElement("group",Ae({ref:S,onClick:C,onPointerOver:()=>E(!0),onPointerOut:()=>E(!1),onPointerMissed:_},l),g.createElement(gx.Provider,{value:x},t))}function KO(){return g.useContext(gx)}const R8=g.forwardRef(function({children:e,follow:t=!0,lockX:i=!1,lockY:n=!1,lockZ:s=!1,...o},a){const l=g.useRef(null),c=g.useRef(null),u=new st;return Ve(({camera:h})=>{if(!t||!c.current)return;const f=l.current.rotation.clone();c.current.updateMatrix(),c.current.updateWorldMatrix(!1,!1),c.current.getWorldQuaternion(u),h.getWorldQuaternion(l.current.quaternion).premultiply(u.invert()),i&&(l.current.rotation.x=f.x),n&&(l.current.rotation.y=f.y),s&&(l.current.rotation.z=f.z)}),g.useImperativeHandle(a,()=>c.current,[]),g.createElement("group",Ae({ref:c},o),g.createElement("group",{ref:l},e))}),$O=g.forwardRef(({children:r,depth:e=-1,...t},i)=>{const n=g.useRef(null);return g.useImperativeHandle(i,()=>n.current,[]),Ve(({camera:s})=>{n.current.quaternion.copy(s.quaternion),n.current.position.copy(s.position)}),g.createElement("group",Ae({ref:n},t),g.createElement("group",{"position-z":-e},r))}),D8=new Q,M8=new Q,L8=new Q,P8=(r,e,t)=>{const i=t.width/2,n=t.height/2;e.updateMatrixWorld(!1);const s=r.project(e);return s.x=s.x*i+i,s.y=-(s.y*n)+n,s},F8=(r,e,t,i=1)=>{const n=D8.set(r.x/t.width*2-1,-(r.y/t.height)*2+1,i);return n.unproject(e),n},MA=(r,e,t,i)=>{const n=P8(L8.copy(r),t,i);let s=0;for(let o=0;o<2;++o){const a=M8.copy(n).setComponent(o,n.getComponent(o)+e),l=F8(a,t,i,a.z);s=Math.max(s,r.distanceTo(l))}return s},k8=new Q,YO=g.forwardRef(({scale:r=1,...e},t)=>{const i=g.useRef(null);return g.useImperativeHandle(t,()=>i.current,[]),Ve(n=>{const s=i.current;if(!s)return;const o=MA(s.getWorldPosition(k8),r,n.camera,n.size);s.scale.setScalar(o*r)}),g.createElement("object3D",Ae({ref:i},e))}),Ws=g.forwardRef(function({points:e,color:t=16777215,vertexColors:i,linewidth:n,lineWidth:s,segments:o,dashed:a,...l},c){var u,h;const f=ae(y=>y.size),d=g.useMemo(()=>o?new Ax:new px,[o]),[m]=g.useState(()=>new hf),A=(i==null||(u=i[0])==null?void 0:u.length)===4?4:3,p=g.useMemo(()=>{const y=o?new uf:new mx,v=e.map(E=>{const x=Array.isArray(E);return E instanceof Q||E instanceof yi?[E.x,E.y,E.z]:E instanceof De?[E.x,E.y,0]:x&&E.length===3?[E[0],E[1],E[2]]:x&&E.length===2?[E[0],E[1],0]:E});if(y.setPositions(v.flat()),i){t=16777215;const E=i.map(x=>x instanceof We?x.toArray():x);y.setColors(E.flat(),A)}return y},[e,o,i,A]);return g.useLayoutEffect(()=>{d.computeLineDistances()},[e,d]),g.useLayoutEffect(()=>{a?m.defines.USE_DASH="":delete m.defines.USE_DASH,m.needsUpdate=!0},[a,m]),g.useEffect(()=>()=>{p.dispose(),m.dispose()},[p]),g.createElement("primitive",Ae({object:d,ref:c},l),g.createElement("primitive",{object:p,attach:"geometry"}),g.createElement("primitive",Ae({object:m,attach:"material",color:t,vertexColors:!!i,resolution:[f.width,f.height],linewidth:(h=n??s)!==null&&h!==void 0?h:1,dashed:a,transparent:A===4},l)))}),O8=new Q,WO=g.forwardRef(function({start:e=[0,0,0],end:t=[0,0,0],mid:i,segments:n=20,...s},o){const a=g.useRef(null);g.useImperativeHandle(o,()=>a.current);const[l]=g.useState(()=>new s_(void 0,void 0,void 0)),c=g.useCallback((h,f,d,m=20)=>(h instanceof Q?l.v0.copy(h):l.v0.set(...h),f instanceof Q?l.v2.copy(f):l.v2.set(...f),d instanceof Q?l.v1.copy(d):Array.isArray(d)?l.v1.set(...d):l.v1.copy(l.v0.clone().add(l.v2.clone().sub(l.v0)).add(O8.set(0,l.v0.y-l.v2.y,0))),l.getPoints(m)),[]);g.useLayoutEffect(()=>{a.current.setPoints=(h,f,d)=>{const m=c(h,f,d);a.current.geometry&&a.current.geometry.setPositions(m.map(A=>A.toArray()).flat())}},[]);const u=g.useMemo(()=>c(e,t,i,n),[e,t,i,n]);return g.createElement(Ws,Ae({ref:a,points:u},s))}),jO=g.forwardRef(function({start:e,end:t,midA:i,midB:n,segments:s=20,...o},a){const l=g.useMemo(()=>{const c=e instanceof Q?e:new Q(...e),u=t instanceof Q?t:new Q(...t),h=i instanceof Q?i:new Q(...i),f=n instanceof Q?n:new Q(...n);return new r_(c,h,f,u).getPoints(s)},[e,t,i,n,s]);return g.createElement(Ws,Ae({ref:a,points:l},o))}),qO=g.forwardRef(function({points:e,closed:t=!1,curveType:i="centripetal",tension:n=.5,segments:s=20,vertexColors:o,...a},l){const c=g.useMemo(()=>{const f=e.map(d=>d instanceof Q?d:new Q(...d));return new vE(f,t,i,n)},[e,t,i,n]),u=g.useMemo(()=>c.getPoints(s),[c,s]),h=g.useMemo(()=>{if(!o||o.length<2)return;if(o.length===s+1)return o;const f=o.map(A=>A instanceof We?A:new We(...A));t&&f.push(f[0].clone());const d=[f[0]],m=s/(f.length-1);for(let A=1;A<s;A++){const p=A%m/m,y=Math.floor(A/m);d.push(f[y].clone().lerp(f[y+1],p))}return d.push(f[f.length-1]),d},[o,s]);return g.createElement(Ws,Ae({ref:l,points:u,vertexColors:h},a))}),XO=g.forwardRef(({url:r,distance:e=1,loop:t=!0,autoplay:i,...n},s)=>{const o=g.useRef(null);g.useImperativeHandle(s,()=>o.current,[]);const a=ae(({camera:u})=>u),[l]=g.useState(()=>new o_),c=hi(a_,r);return g.useEffect(()=>{const u=o.current;u&&(u.setBuffer(c),u.setRefDistance(e),u.setLoop(t),i&&!u.isPlaying&&u.play())},[c,a,e,t]),g.useEffect(()=>{const u=o.current;return a.add(l),()=>{a.remove(l),u&&(u.isPlaying&&u.stop(),u.source&&u.source._connected&&u.disconnect())}},[]),g.createElement("positionalAudio",Ae({ref:o,args:[l]},n))});function U8(){var r=Object.create(null);function e(n,s){var o=n.id,a=n.name,l=n.dependencies;l===void 0&&(l=[]);var c=n.init;c===void 0&&(c=function(){});var u=n.getTransferables;if(u===void 0&&(u=null),!r[o])try{l=l.map(function(f){return f&&f.isWorkerModule&&(e(f,function(d){if(d instanceof Error)throw d}),f=r[f.id].value),f}),c=i("<"+a+">.init",c),u&&(u=i("<"+a+">.getTransferables",u));var h=null;typeof c=="function"?h=c.apply(void 0,l):console.error("worker module init function failed to rehydrate"),r[o]={id:o,value:h,getTransferables:u},s(h)}catch(f){f&&f.noLog||console.error(f),s(f)}}function t(n,s){var o,a=n.id,l=n.args;(!r[a]||typeof r[a].value!="function")&&s(new Error("Worker module "+a+": not found or its 'init' did not return a function"));try{var c=(o=r[a]).value.apply(o,l);c&&typeof c.then=="function"?c.then(u,function(h){return s(h instanceof Error?h:new Error(""+h))}):u(c)}catch(h){s(h)}function u(h){try{var f=r[a].getTransferables&&r[a].getTransferables(h);(!f||!Array.isArray(f)||!f.length)&&(f=void 0),s(h,f)}catch(d){console.error(d),s(d)}}}function i(n,s){var o=void 0;self.troikaDefine=function(l){return o=l};var a=URL.createObjectURL(new Blob(["/** "+n.replace(/\*/g,"")+` **/

troikaDefine(
`+s+`
)`],{type:"application/javascript"}));try{importScripts(a)}catch(l){console.error(l)}return URL.revokeObjectURL(a),delete self.troikaDefine,o}self.addEventListener("message",function(n){var s=n.data,o=s.messageId,a=s.action,l=s.data;try{a==="registerModule"&&e(l,function(c){c instanceof Error?postMessage({messageId:o,success:!1,error:c.message}):postMessage({messageId:o,success:!0,result:{isCallable:typeof c=="function"}})}),a==="callModule"&&t(l,function(c,u){c instanceof Error?postMessage({messageId:o,success:!1,error:c.message}):postMessage({messageId:o,success:!0,result:c},u||void 0)})}catch(c){postMessage({messageId:o,success:!1,error:c.stack})}})}function N8(r){var e=function(){for(var t=[],i=arguments.length;i--;)t[i]=arguments[i];return e._getInitResult().then(function(n){if(typeof n=="function")return n.apply(void 0,t);throw new Error("Worker module function was called but `init` did not return a callable function")})};return e._getInitResult=function(){var t=r.dependencies,i=r.init;t=Array.isArray(t)?t.map(function(s){return s&&(s=s.onMainThread||s,s._getInitResult&&(s=s._getInitResult())),s}):[];var n=Promise.all(t).then(function(s){return i.apply(null,s)});return e._getInitResult=function(){return n},n},e}var yx=function(){var r=!1;if(typeof window<"u"&&typeof window.document<"u")try{var e=new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"})));e.terminate(),r=!0}catch(t){console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+t.message+"]")}return yx=function(){return r},r},G8=0,Q8=0,Ed=!1,Xl=Object.create(null),Jl=Object.create(null),ym=Object.create(null);function Ga(r){if((!r||typeof r.init!="function")&&!Ed)throw new Error("requires `options.init` function");var e=r.dependencies,t=r.init,i=r.getTransferables,n=r.workerId,s=N8(r);n==null&&(n="#default");var o="workerModule"+ ++G8,a=r.name||o,l=null;e=e&&e.map(function(u){return typeof u=="function"&&!u.workerModuleData&&(Ed=!0,u=Ga({workerId:n,name:"<"+a+"> function dependency: "+u.name,init:`function(){return (
`+rh(u)+`
)}`}),Ed=!1),u&&u.workerModuleData&&(u=u.workerModuleData),u});function c(){for(var u=[],h=arguments.length;h--;)u[h]=arguments[h];if(!yx())return s.apply(void 0,u);if(!l){l=N1(n,"registerModule",c.workerModuleData);var f=function(){l=null,Jl[n].delete(f)};(Jl[n]||(Jl[n]=new Set)).add(f)}return l.then(function(d){var m=d.isCallable;if(m)return N1(n,"callModule",{id:o,args:u});throw new Error("Worker module function was called but `init` did not return a callable function")})}return c.workerModuleData={isWorkerModule:!0,id:o,name:a,dependencies:e,init:rh(t),getTransferables:i&&rh(i)},c.onMainThread=s,c}function z8(r){Jl[r]&&Jl[r].forEach(function(e){e()}),Xl[r]&&(Xl[r].terminate(),delete Xl[r])}function rh(r){var e=r.toString();return!/^function/.test(e)&&/^\w+\s*\(/.test(e)&&(e="function "+e),e}function H8(r){var e=Xl[r];if(!e){var t=rh(U8);e=Xl[r]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+r.replace(/\*/g,"")+` **/

;(`+t+")()"],{type:"application/javascript"}))),e.onmessage=function(i){var n=i.data,s=n.messageId,o=ym[s];if(!o)throw new Error("WorkerModule response with empty or unknown messageId");delete ym[s],o(n)}}return e}function N1(r,e,t){return new Promise(function(i,n){var s=++Q8;ym[s]=function(o){o.success?i(o.result):n(new Error("Error in worker "+e+" call: "+o.error))},H8(r).postMessage({messageId:s,action:e,data:t})})}function vx(){var r=(function(e){function t(N,K,D,z,$,V,P,G){var F=1-P;G.x=F*F*N+2*F*P*D+P*P*$,G.y=F*F*K+2*F*P*z+P*P*V}function i(N,K,D,z,$,V,P,G,F,k){var Z=1-F;k.x=Z*Z*Z*N+3*Z*Z*F*D+3*Z*F*F*$+F*F*F*P,k.y=Z*Z*Z*K+3*Z*Z*F*z+3*Z*F*F*V+F*F*F*G}function n(N,K){for(var D=/([MLQCZ])([^MLQCZ]*)/g,z,$,V,P,G;z=D.exec(N);){var F=z[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map(function(k){return parseFloat(k)});switch(z[1]){case"M":P=$=F[0],G=V=F[1];break;case"L":(F[0]!==P||F[1]!==G)&&K("L",P,G,P=F[0],G=F[1]);break;case"Q":{K("Q",P,G,P=F[2],G=F[3],F[0],F[1]);break}case"C":{K("C",P,G,P=F[4],G=F[5],F[0],F[1],F[2],F[3]);break}case"Z":(P!==$||G!==V)&&K("L",P,G,$,V);break}}}function s(N,K,D){D===void 0&&(D=16);var z={x:0,y:0};n(N,function($,V,P,G,F,k,Z,ne,X){switch($){case"L":K(V,P,G,F);break;case"Q":{for(var te=V,ye=P,ve=1;ve<D;ve++)t(V,P,k,Z,G,F,ve/(D-1),z),K(te,ye,z.x,z.y),te=z.x,ye=z.y;break}case"C":{for(var re=V,se=P,he=1;he<D;he++)i(V,P,k,Z,ne,X,G,F,he/(D-1),z),K(re,se,z.x,z.y),re=z.x,se=z.y;break}}})}var o="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",a="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",l=new WeakMap,c={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function u(N,K){var D=N.getContext?N.getContext("webgl",c):N,z=l.get(D);if(!z){let Z=function(re){var se=V[re];if(!se&&(se=V[re]=D.getExtension(re),!se))throw new Error(re+" not supported");return se},ne=function(re,se){var he=D.createShader(se);return D.shaderSource(he,re),D.compileShader(he),he},X=function(re,se,he,le){if(!P[re]){var J={},q={},oe=D.createProgram();D.attachShader(oe,ne(se,D.VERTEX_SHADER)),D.attachShader(oe,ne(he,D.FRAGMENT_SHADER)),D.linkProgram(oe),P[re]={program:oe,transaction:function(_e){D.useProgram(oe),_e({setUniform:function(Se,Ke){for(var Me=[],Ge=arguments.length-2;Ge-- >0;)Me[Ge]=arguments[Ge+2];var Qe=q[Ke]||(q[Ke]=D.getUniformLocation(oe,Ke));D["uniform"+Se].apply(D,[Qe].concat(Me))},setAttribute:function(Se,Ke,Me,Ge,Qe){var qe=J[Se];qe||(qe=J[Se]={buf:D.createBuffer(),loc:D.getAttribLocation(oe,Se),data:null}),D.bindBuffer(D.ARRAY_BUFFER,qe.buf),D.vertexAttribPointer(qe.loc,Ke,D.FLOAT,!1,0,0),D.enableVertexAttribArray(qe.loc),$?D.vertexAttribDivisor(qe.loc,Ge):Z("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(qe.loc,Ge),Qe!==qe.data&&(D.bufferData(D.ARRAY_BUFFER,Qe,Me),qe.data=Qe)}})}}}P[re].transaction(le)},te=function(re,se){F++;try{D.activeTexture(D.TEXTURE0+F);var he=G[re];he||(he=G[re]=D.createTexture(),D.bindTexture(D.TEXTURE_2D,he),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,D.NEAREST),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,D.NEAREST)),D.bindTexture(D.TEXTURE_2D,he),se(he,F)}finally{F--}},ye=function(re,se,he){var le=D.createFramebuffer();k.push(le),D.bindFramebuffer(D.FRAMEBUFFER,le),D.activeTexture(D.TEXTURE0+se),D.bindTexture(D.TEXTURE_2D,re),D.framebufferTexture2D(D.FRAMEBUFFER,D.COLOR_ATTACHMENT0,D.TEXTURE_2D,re,0);try{he(le)}finally{D.deleteFramebuffer(le),D.bindFramebuffer(D.FRAMEBUFFER,k[--k.length-1]||null)}},ve=function(){V={},P={},G={},F=-1,k.length=0};var $=typeof WebGL2RenderingContext<"u"&&D instanceof WebGL2RenderingContext,V={},P={},G={},F=-1,k=[];D.canvas.addEventListener("webglcontextlost",function(re){ve(),re.preventDefault()},!1),l.set(D,z={gl:D,isWebGL2:$,getExtension:Z,withProgram:X,withTexture:te,withTextureFramebuffer:ye,handleContextLoss:ve})}K(z)}function h(N,K,D,z,$,V,P,G){P===void 0&&(P=15),G===void 0&&(G=null),u(N,function(F){var k=F.gl,Z=F.withProgram,ne=F.withTexture;ne("copy",function(X,te){k.texImage2D(k.TEXTURE_2D,0,k.RGBA,$,V,0,k.RGBA,k.UNSIGNED_BYTE,K),Z("copy",o,a,function(ye){var ve=ye.setUniform,re=ye.setAttribute;re("aUV",2,k.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),ve("1i","image",te),k.bindFramebuffer(k.FRAMEBUFFER,G||null),k.disable(k.BLEND),k.colorMask(P&8,P&4,P&2,P&1),k.viewport(D,z,$,V),k.scissor(D,z,$,V),k.drawArrays(k.TRIANGLES,0,3)})})})}function f(N,K,D){var z=N.width,$=N.height;u(N,function(V){var P=V.gl,G=new Uint8Array(z*$*4);P.readPixels(0,0,z,$,P.RGBA,P.UNSIGNED_BYTE,G),N.width=K,N.height=D,h(P,G,0,0,z,$)})}var d=Object.freeze({__proto__:null,withWebGLContext:u,renderImageData:h,resizeWebGLCanvasWithoutClearing:f});function m(N,K,D,z,$,V){V===void 0&&(V=1);var P=new Uint8Array(N*K),G=z[2]-z[0],F=z[3]-z[1],k=[];s(D,function(re,se,he,le){k.push({x1:re,y1:se,x2:he,y2:le,minX:Math.min(re,he),minY:Math.min(se,le),maxX:Math.max(re,he),maxY:Math.max(se,le)})}),k.sort(function(re,se){return re.maxX-se.maxX});for(var Z=0;Z<N;Z++)for(var ne=0;ne<K;ne++){var X=ye(z[0]+G*(Z+.5)/N,z[1]+F*(ne+.5)/K),te=Math.pow(1-Math.abs(X)/$,V)/2;X<0&&(te=1-te),te=Math.max(0,Math.min(255,Math.round(te*255))),P[ne*N+Z]=te}return P;function ye(re,se){for(var he=1/0,le=1/0,J=k.length;J--;){var q=k[J];if(q.maxX+le<=re)break;if(re+le>q.minX&&se-le<q.maxY&&se+le>q.minY){var oe=y(re,se,q.x1,q.y1,q.x2,q.y2);oe<he&&(he=oe,le=Math.sqrt(he))}}return ve(re,se)&&(le=-le),le}function ve(re,se){for(var he=0,le=k.length;le--;){var J=k[le];if(J.maxX<=re)break;var q=J.y1>se!=J.y2>se&&re<(J.x2-J.x1)*(se-J.y1)/(J.y2-J.y1)+J.x1;q&&(he+=J.y1<J.y2?1:-1)}return he!==0}}function A(N,K,D,z,$,V,P,G,F,k){V===void 0&&(V=1),G===void 0&&(G=0),F===void 0&&(F=0),k===void 0&&(k=0),p(N,K,D,z,$,V,P,null,G,F,k)}function p(N,K,D,z,$,V,P,G,F,k,Z){V===void 0&&(V=1),F===void 0&&(F=0),k===void 0&&(k=0),Z===void 0&&(Z=0);for(var ne=m(N,K,D,z,$,V),X=new Uint8Array(ne.length*4),te=0;te<ne.length;te++)X[te*4+Z]=ne[te];h(P,X,F,k,N,K,1<<3-Z,G)}function y(N,K,D,z,$,V){var P=$-D,G=V-z,F=P*P+G*G,k=F?Math.max(0,Math.min(1,((N-D)*P+(K-z)*G)/F)):0,Z=N-(D+k*P),ne=K-(z+k*G);return Z*Z+ne*ne}var v=Object.freeze({__proto__:null,generate:m,generateIntoCanvas:A,generateIntoFramebuffer:p}),E="precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",x="precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",I="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",C=new Float32Array([0,0,2,0,0,2]),_=null,S=!1,b={},T=new WeakMap;function R(N){if(!S&&!O(N))throw new Error("WebGL generation not supported")}function w(N,K,D,z,$,V,P){if(V===void 0&&(V=1),P===void 0&&(P=null),!P&&(P=_,!P)){var G=typeof OffscreenCanvas=="function"?new OffscreenCanvas(1,1):typeof document<"u"?document.createElement("canvas"):null;if(!G)throw new Error("OffscreenCanvas or DOM canvas not supported");P=_=G.getContext("webgl",{depth:!1})}R(P);var F=new Uint8Array(N*K*4);u(P,function(X){var te=X.gl,ye=X.withTexture,ve=X.withTextureFramebuffer;ye("readable",function(re,se){te.texImage2D(te.TEXTURE_2D,0,te.RGBA,N,K,0,te.RGBA,te.UNSIGNED_BYTE,null),ve(re,se,function(he){M(N,K,D,z,$,V,te,he,0,0,0),te.readPixels(0,0,N,K,te.RGBA,te.UNSIGNED_BYTE,F)})})});for(var k=new Uint8Array(N*K),Z=0,ne=0;Z<F.length;Z+=4)k[ne++]=F[Z];return k}function B(N,K,D,z,$,V,P,G,F,k){V===void 0&&(V=1),G===void 0&&(G=0),F===void 0&&(F=0),k===void 0&&(k=0),M(N,K,D,z,$,V,P,null,G,F,k)}function M(N,K,D,z,$,V,P,G,F,k,Z){V===void 0&&(V=1),F===void 0&&(F=0),k===void 0&&(k=0),Z===void 0&&(Z=0),R(P);var ne=[];s(D,function(X,te,ye,ve){ne.push(X,te,ye,ve)}),ne=new Float32Array(ne),u(P,function(X){var te=X.gl,ye=X.isWebGL2,ve=X.getExtension,re=X.withProgram,se=X.withTexture,he=X.withTextureFramebuffer,le=X.handleContextLoss;if(se("rawDistances",function(J,q){(N!==J._lastWidth||K!==J._lastHeight)&&te.texImage2D(te.TEXTURE_2D,0,te.RGBA,J._lastWidth=N,J._lastHeight=K,0,te.RGBA,te.UNSIGNED_BYTE,null),re("main",E,x,function(oe){var Ie=oe.setAttribute,_e=oe.setUniform,Be=!ye&&ve("ANGLE_instanced_arrays"),Se=!ye&&ve("EXT_blend_minmax");Ie("aUV",2,te.STATIC_DRAW,0,C),Ie("aLineSegment",4,te.DYNAMIC_DRAW,1,ne),_e.apply(void 0,["4f","uGlyphBounds"].concat(z)),_e("1f","uMaxDistance",$),_e("1f","uExponent",V),he(J,q,function(Ke){te.enable(te.BLEND),te.colorMask(!0,!0,!0,!0),te.viewport(0,0,N,K),te.scissor(0,0,N,K),te.blendFunc(te.ONE,te.ONE),te.blendEquationSeparate(te.FUNC_ADD,ye?te.MAX:Se.MAX_EXT),te.clear(te.COLOR_BUFFER_BIT),ye?te.drawArraysInstanced(te.TRIANGLES,0,3,ne.length/4):Be.drawArraysInstancedANGLE(te.TRIANGLES,0,3,ne.length/4)})}),re("post",o,I,function(oe){oe.setAttribute("aUV",2,te.STATIC_DRAW,0,C),oe.setUniform("1i","tex",q),te.bindFramebuffer(te.FRAMEBUFFER,G),te.disable(te.BLEND),te.colorMask(Z===0,Z===1,Z===2,Z===3),te.viewport(F,k,N,K),te.scissor(F,k,N,K),te.drawArrays(te.TRIANGLES,0,3)})}),te.isContextLost())throw le(),new Error("webgl context lost")})}function O(N){var K=!N||N===_?b:N.canvas||N,D=T.get(K);if(D===void 0){S=!0;var z=null;try{var $=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],V=w(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,N);D=V&&$.length===V.length&&V.every(function(P,G){return P===$[G]}),D||(z="bad trial run results",console.info($,V))}catch(P){D=!1,z=P.message}z&&console.warn("WebGL SDF generation not supported:",z),S=!1,T.set(K,D)}return D}var U=Object.freeze({__proto__:null,generate:w,generateIntoCanvas:B,generateIntoFramebuffer:M,isSupported:O});function Y(N,K,D,z,$,V){$===void 0&&($=Math.max(z[2]-z[0],z[3]-z[1])/2),V===void 0&&(V=1);try{return w.apply(U,arguments)}catch(P){return console.info("WebGL SDF generation failed, falling back to JS",P),m.apply(v,arguments)}}function W(N,K,D,z,$,V,P,G,F,k){$===void 0&&($=Math.max(z[2]-z[0],z[3]-z[1])/2),V===void 0&&(V=1),G===void 0&&(G=0),F===void 0&&(F=0),k===void 0&&(k=0);try{return B.apply(U,arguments)}catch(Z){return console.info("WebGL SDF generation failed, falling back to JS",Z),A.apply(v,arguments)}}return e.forEachPathCommand=n,e.generate=Y,e.generateIntoCanvas=W,e.javascript=v,e.pathToLineSegments=s,e.webgl=U,e.webglUtils=d,Object.defineProperty(e,"__esModule",{value:!0}),e})({});return r}function V8(){var r=(function(e){var t={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},i={},n={};i.L=1,n[1]="L",Object.keys(t).forEach(function(le,J){i[le]=1<<J+1,n[i[le]]=le}),Object.freeze(i);var s=i.LRI|i.RLI|i.FSI,o=i.L|i.R|i.AL,a=i.B|i.S|i.WS|i.ON|i.FSI|i.LRI|i.RLI|i.PDI,l=i.BN|i.RLE|i.LRE|i.RLO|i.LRO|i.PDF,c=i.S|i.WS|i.B|s|i.PDI|l,u=null;function h(){if(!u){u=new Map;var le=function(q){if(t.hasOwnProperty(q)){var oe=0;t[q].split(",").forEach(function(Ie){var _e=Ie.split("+"),Be=_e[0],Se=_e[1];Be=parseInt(Be,36),Se=Se?parseInt(Se,36):0,u.set(oe+=Be,i[q]);for(var Ke=0;Ke<Se;Ke++)u.set(++oe,i[q])})}};for(var J in t)le(J)}}function f(le){return h(),u.get(le.codePointAt(0))||i.L}function d(le){return n[f(le)]}var m={pairs:"14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",canonical:"6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"};function A(le,J){var q=36,oe=0,Ie=new Map,_e=J&&new Map,Be;return le.split(",").forEach(function Se(Ke){if(Ke.indexOf("+")!==-1)for(var Me=+Ke;Me--;)Se(Be);else{Be=Ke;var Ge=Ke.split(">"),Qe=Ge[0],qe=Ge[1];Qe=String.fromCodePoint(oe+=parseInt(Qe,q)),qe=String.fromCodePoint(oe+=parseInt(qe,q)),Ie.set(Qe,qe),J&&_e.set(qe,Qe)}}),{map:Ie,reverseMap:_e}}var p,y,v;function E(){if(!p){var le=A(m.pairs,!0),J=le.map,q=le.reverseMap;p=J,y=q,v=A(m.canonical,!1).map}}function x(le){return E(),p.get(le)||null}function I(le){return E(),y.get(le)||null}function C(le){return E(),v.get(le)||null}var _=i.L,S=i.R,b=i.EN,T=i.ES,R=i.ET,w=i.AN,B=i.CS,M=i.B,O=i.S,U=i.ON,Y=i.BN,W=i.NSM,N=i.AL,K=i.LRO,D=i.RLO,z=i.LRE,$=i.RLE,V=i.PDF,P=i.LRI,G=i.RLI,F=i.FSI,k=i.PDI;function Z(le,J){for(var q=125,oe=new Uint32Array(le.length),Ie=0;Ie<le.length;Ie++)oe[Ie]=f(le[Ie]);var _e=new Map;function Be(An,hs){var pn=oe[An];oe[An]=hs,_e.set(pn,_e.get(pn)-1),pn&a&&_e.set(a,_e.get(a)-1),_e.set(hs,(_e.get(hs)||0)+1),hs&a&&_e.set(a,(_e.get(a)||0)+1)}for(var Se=new Uint8Array(le.length),Ke=new Map,Me=[],Ge=null,Qe=0;Qe<le.length;Qe++)Ge||Me.push(Ge={start:Qe,end:le.length-1,level:J==="rtl"?1:J==="ltr"?0:Op(Qe,!1)}),oe[Qe]&M&&(Ge.end=Qe,Ge=null);for(var qe=$|z|D|K|s|k|V|M,rt=function(An){return An+(An&1?1:2)},gt=function(An){return An+(An&1?2:1)},nt=0;nt<Me.length;nt++){Ge=Me[nt];var Xe=[{_level:Ge.level,_override:0,_isolate:0}],je=void 0,ie=0,be=0,Le=0;_e.clear();for(var Ye=Ge.start;Ye<=Ge.end;Ye++){var pe=oe[Ye];if(je=Xe[Xe.length-1],_e.set(pe,(_e.get(pe)||0)+1),pe&a&&_e.set(a,(_e.get(a)||0)+1),pe&qe)if(pe&($|z)){Se[Ye]=je._level;var at=(pe===$?gt:rt)(je._level);at<=q&&!ie&&!be?Xe.push({_level:at,_override:0,_isolate:0}):ie||be++}else if(pe&(D|K)){Se[Ye]=je._level;var ti=(pe===D?gt:rt)(je._level);ti<=q&&!ie&&!be?Xe.push({_level:ti,_override:pe&D?S:_,_isolate:0}):ie||be++}else if(pe&s){pe&F&&(pe=Op(Ye+1,!0)===1?G:P),Se[Ye]=je._level,je._override&&Be(Ye,je._override);var Dt=(pe===G?gt:rt)(je._level);Dt<=q&&ie===0&&be===0?(Le++,Xe.push({_level:Dt,_override:0,_isolate:1,_isolInitIndex:Ye})):ie++}else if(pe&k){if(ie>0)ie--;else if(Le>0){for(be=0;!Xe[Xe.length-1]._isolate;)Xe.pop();var yt=Xe[Xe.length-1]._isolInitIndex;yt!=null&&(Ke.set(yt,Ye),Ke.set(Ye,yt)),Xe.pop(),Le--}je=Xe[Xe.length-1],Se[Ye]=je._level,je._override&&Be(Ye,je._override)}else pe&V?(ie===0&&(be>0?be--:!je._isolate&&Xe.length>1&&(Xe.pop(),je=Xe[Xe.length-1])),Se[Ye]=je._level):pe&M&&(Se[Ye]=Ge.level);else Se[Ye]=je._level,je._override&&pe!==Y&&Be(Ye,je._override)}for(var wt=[],Tt=null,lt=Ge.start;lt<=Ge.end;lt++){var Bt=oe[lt];if(!(Bt&l)){var fi=Se[lt],di=Bt&s,_i=Bt===k;Tt&&fi===Tt._level?(Tt._end=lt,Tt._endsWithIsolInit=di):wt.push(Tt={_start:lt,_end:lt,_level:fi,_startsWithPDI:_i,_endsWithIsolInit:di})}}for(var Tn=[],bn=0;bn<wt.length;bn++){var ls=wt[bn];if(!ls._startsWithPDI||ls._startsWithPDI&&!Ke.has(ls._start)){for(var dn=[Tt=ls],wn=void 0;Tt&&Tt._endsWithIsolInit&&(wn=Ke.get(Tt._end))!=null;)for(var ft=bn+1;ft<wt.length;ft++)if(wt[ft]._start===wn){dn.push(Tt=wt[ft]);break}for(var Hi=[],Js=0;Js<dn.length;Js++)for(var H=dn[Js],j=H._start;j<=H._end;j++)Hi.push(j);for(var ee=Se[Hi[0]],me=Ge.level,Ee=Hi[0]-1;Ee>=0;Ee--)if(!(oe[Ee]&l)){me=Se[Ee];break}var xe=Hi[Hi.length-1],Pe=Se[xe],Re=Ge.level;if(!(oe[xe]&s)){for(var Fe=xe+1;Fe<=Ge.end;Fe++)if(!(oe[Fe]&l)){Re=Se[Fe];break}}Tn.push({_seqIndices:Hi,_sosType:Math.max(me,ee)%2?S:_,_eosType:Math.max(Re,Pe)%2?S:_})}}for(var ke=0;ke<Tn.length;ke++){var Oe=Tn[ke],ge=Oe._seqIndices,Gt=Oe._sosType,et=Oe._eosType,Ze=Se[ge[0]]&1?S:_;if(_e.get(W))for(var ct=0;ct<ge.length;ct++){var vt=ge[ct];if(oe[vt]&W){for(var Mt=Gt,Lt=ct-1;Lt>=0;Lt--)if(!(oe[ge[Lt]]&l)){Mt=oe[ge[Lt]];break}Be(vt,Mt&(s|k)?U:Mt)}}if(_e.get(b))for(var ai=0;ai<ge.length;ai++){var Vi=ge[ai];if(oe[Vi]&b)for(var Pt=ai-1;Pt>=-1;Pt--){var Bn=Pt===-1?Gt:oe[ge[Pt]];if(Bn&o){Bn===N&&Be(Vi,w);break}}}if(_e.get(N))for(var Qt=0;Qt<ge.length;Qt++){var Si=ge[Qt];oe[Si]&N&&Be(Si,S)}if(_e.get(T)||_e.get(B))for(var rn=1;rn<ge.length-1;rn++){var Zs=ge[rn];if(oe[Zs]&(T|B)){for(var Li=0,Ft=0,wi=rn-1;wi>=0&&(Li=oe[ge[wi]],!!(Li&l));wi--);for(var $t=rn+1;$t<ge.length&&(Ft=oe[ge[$t]],!!(Ft&l));$t++);Li===Ft&&(oe[Zs]===T?Li===b:Li&(b|w))&&Be(Zs,Li)}}if(_e.get(b))for(var xt=0;xt<ge.length;xt++){var mn=ge[xt];if(oe[mn]&b){for(var Hn=xt-1;Hn>=0&&oe[ge[Hn]]&(R|l);Hn--)Be(ge[Hn],b);for(xt++;xt<ge.length&&oe[ge[xt]]&(R|l|b);xt++)oe[ge[xt]]!==b&&Be(ge[xt],b)}}if(_e.get(R)||_e.get(T)||_e.get(B))for(var Pi=0;Pi<ge.length;Pi++){var cs=ge[Pi];if(oe[cs]&(R|T|B)){Be(cs,U);for(var Lc=Pi-1;Lc>=0&&oe[ge[Lc]]&l;Lc--)Be(ge[Lc],U);for(var Pc=Pi+1;Pc<ge.length&&oe[ge[Pc]]&l;Pc++)Be(ge[Pc],U)}}if(_e.get(b))for(var bf=0,Sp=Gt;bf<ge.length;bf++){var Tp=ge[bf],wf=oe[Tp];wf&b?Sp===_&&Be(Tp,_):wf&o&&(Sp=wf)}if(_e.get(a)){var za=S|b|w,bp=za|_,Fc=[];{for(var Co=[],_o=0;_o<ge.length;_o++)if(oe[ge[_o]]&a){var Ha=le[ge[_o]],wp=void 0;if(x(Ha)!==null)if(Co.length<63)Co.push({char:Ha,seqIndex:_o});else break;else if((wp=I(Ha))!==null)for(var Va=Co.length-1;Va>=0;Va--){var Bf=Co[Va].char;if(Bf===wp||Bf===I(C(Ha))||x(C(Bf))===Ha){Fc.push([Co[Va].seqIndex,_o]),Co.length=Va;break}}}Fc.sort(function(An,hs){return An[0]-hs[0]})}for(var Rf=0;Rf<Fc.length;Rf++){for(var Bp=Fc[Rf],kc=Bp[0],Df=Bp[1],Rp=!1,us=0,Mf=kc+1;Mf<Df;Mf++){var Dp=ge[Mf];if(oe[Dp]&bp){Rp=!0;var Mp=oe[Dp]&za?S:_;if(Mp===Ze){us=Mp;break}}}if(Rp&&!us){us=Gt;for(var Lf=kc-1;Lf>=0;Lf--){var Lp=ge[Lf];if(oe[Lp]&bp){var Pp=oe[Lp]&za?S:_;Pp!==Ze?us=Pp:us=Ze;break}}}if(us){if(oe[ge[kc]]=oe[ge[Df]]=us,us!==Ze){for(var Ka=kc+1;Ka<ge.length;Ka++)if(!(oe[ge[Ka]]&l)){f(le[ge[Ka]])&W&&(oe[ge[Ka]]=us);break}}if(us!==Ze){for(var $a=Df+1;$a<ge.length;$a++)if(!(oe[ge[$a]]&l)){f(le[ge[$a]])&W&&(oe[ge[$a]]=us);break}}}}for(var xr=0;xr<ge.length;xr++)if(oe[ge[xr]]&a){for(var Fp=xr,Pf=xr,Ff=Gt,Ya=xr-1;Ya>=0;Ya--)if(oe[ge[Ya]]&l)Fp=Ya;else{Ff=oe[ge[Ya]]&za?S:_;break}for(var kp=et,Wa=xr+1;Wa<ge.length;Wa++)if(oe[ge[Wa]]&(a|l))Pf=Wa;else{kp=oe[ge[Wa]]&za?S:_;break}for(var kf=Fp;kf<=Pf;kf++)oe[ge[kf]]=Ff===kp?Ff:Ze;xr=Pf}}}for(var Rn=Ge.start;Rn<=Ge.end;Rn++){var x4=Se[Rn],Oc=oe[Rn];if(x4&1?Oc&(_|b|w)&&Se[Rn]++:Oc&S?Se[Rn]++:Oc&(w|b)&&(Se[Rn]+=2),Oc&l&&(Se[Rn]=Rn===0?Ge.level:Se[Rn-1]),Rn===Ge.end||f(le[Rn])&(O|M))for(var Uc=Rn;Uc>=0&&f(le[Uc])&c;Uc--)Se[Uc]=Ge.level}}return{levels:Se,paragraphs:Me};function Op(An,hs){for(var pn=An;pn<le.length;pn++){var Ir=oe[pn];if(Ir&(S|N))return 1;if(Ir&(M|_)||hs&&Ir===k)return 0;if(Ir&s){var Up=I4(pn);pn=Up===-1?le.length:Up}}return 0}function I4(An){for(var hs=1,pn=An+1;pn<le.length;pn++){var Ir=oe[pn];if(Ir&M)break;if(Ir&k){if(--hs===0)return pn}else Ir&s&&hs++}return-1}}var ne="14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1",X;function te(){if(!X){var le=A(ne,!0),J=le.map,q=le.reverseMap;q.forEach(function(oe,Ie){J.set(Ie,oe)}),X=J}}function ye(le){return te(),X.get(le)||null}function ve(le,J,q,oe){var Ie=le.length;q=Math.max(0,q==null?0:+q),oe=Math.min(Ie-1,oe==null?Ie-1:+oe);for(var _e=new Map,Be=q;Be<=oe;Be++)if(J[Be]&1){var Se=ye(le[Be]);Se!==null&&_e.set(Be,Se)}return _e}function re(le,J,q,oe){var Ie=le.length;q=Math.max(0,q==null?0:+q),oe=Math.min(Ie-1,oe==null?Ie-1:+oe);var _e=[];return J.paragraphs.forEach(function(Be){var Se=Math.max(q,Be.start),Ke=Math.min(oe,Be.end);if(Se<Ke){for(var Me=J.levels.slice(Se,Ke+1),Ge=Ke;Ge>=Se&&f(le[Ge])&c;Ge--)Me[Ge]=Be.level;for(var Qe=Be.level,qe=1/0,rt=0;rt<Me.length;rt++){var gt=Me[rt];gt>Qe&&(Qe=gt),gt<qe&&(qe=gt|1)}for(var nt=Qe;nt>=qe;nt--)for(var Xe=0;Xe<Me.length;Xe++)if(Me[Xe]>=nt){for(var je=Xe;Xe+1<Me.length&&Me[Xe+1]>=nt;)Xe++;Xe>je&&_e.push([je+Se,Xe+Se])}}}),_e}function se(le,J,q,oe){var Ie=he(le,J,q,oe),_e=[].concat(le);return Ie.forEach(function(Be,Se){_e[Se]=(J.levels[Be]&1?ye(le[Be]):null)||le[Be]}),_e.join("")}function he(le,J,q,oe){for(var Ie=re(le,J,q,oe),_e=[],Be=0;Be<le.length;Be++)_e[Be]=Be;return Ie.forEach(function(Se){for(var Ke=Se[0],Me=Se[1],Ge=_e.slice(Ke,Me+1),Qe=Ge.length;Qe--;)_e[Me-Qe]=Ge[Qe]}),_e}return e.closingToOpeningBracket=I,e.getBidiCharType=f,e.getBidiCharTypeName=d,e.getCanonicalBracket=C,e.getEmbeddingLevels=Z,e.getMirroredCharacter=ye,e.getMirroredCharactersMap=ve,e.getReorderSegments=re,e.getReorderedIndices=he,e.getReorderedString=se,e.openingToClosingBracket=x,Object.defineProperty(e,"__esModule",{value:!0}),e})({});return r}const Ex=/\bvoid\s+main\s*\(\s*\)\s*{/g;function vm(r){const e=/^[ \t]*#include +<([\w\d./]+)>/gm;function t(i,n){let s=ma[n];return s?vm(s):i}return r.replace(e,t)}const Zi=[];for(let r=0;r<256;r++)Zi[r]=(r<16?"0":"")+r.toString(16);function K8(){const r=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return(Zi[r&255]+Zi[r>>8&255]+Zi[r>>16&255]+Zi[r>>24&255]+"-"+Zi[e&255]+Zi[e>>8&255]+"-"+Zi[e>>16&15|64]+Zi[e>>24&255]+"-"+Zi[t&63|128]+Zi[t>>8&255]+"-"+Zi[t>>16&255]+Zi[t>>24&255]+Zi[i&255]+Zi[i>>8&255]+Zi[i>>16&255]+Zi[i>>24&255]).toUpperCase()}const eo=Object.assign||function(){let r=arguments[0];for(let e=1,t=arguments.length;e<t;e++){let i=arguments[e];if(i)for(let n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r[n]=i[n])}return r},$8=Date.now(),G1=new WeakMap,Q1=new Map;let Y8=1e10;function Em(r,e){const t=X8(e);let i=G1.get(r);if(i||G1.set(r,i=Object.create(null)),i[t])return new i[t];const n=`_onBeforeCompile${t}`,s=function(c,u){r.onBeforeCompile.call(this,c,u);const h=this.customProgramCacheKey()+"|"+c.vertexShader+"|"+c.fragmentShader;let f=Q1[h];if(!f){const d=W8(this,c,e,t);f=Q1[h]=d}c.vertexShader=f.vertexShader,c.fragmentShader=f.fragmentShader,eo(c.uniforms,this.uniforms),e.timeUniform&&(c.uniforms[e.timeUniform]={get value(){return Date.now()-$8}}),this[n]&&this[n](c)},o=function(){return a(e.chained?r:r.clone())},a=function(c){const u=Object.create(c,l);return Object.defineProperty(u,"baseMaterial",{value:r}),Object.defineProperty(u,"id",{value:Y8++}),u.uuid=K8(),u.uniforms=eo({},c.uniforms,e.uniforms),u.defines=eo({},c.defines,e.defines),u.defines[`TROIKA_DERIVED_MATERIAL_${t}`]="",u.extensions=eo({},c.extensions,e.extensions),u._listeners=void 0,u},l={constructor:{value:o},isDerivedMaterial:{value:!0},type:{get:()=>r.type,set:c=>{r.type=c}},isDerivedFrom:{writable:!0,configurable:!0,value:function(c){const u=this.baseMaterial;return c===u||u.isDerivedMaterial&&u.isDerivedFrom(c)||!1}},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return r.customProgramCacheKey()+"|"+t}},onBeforeCompile:{get(){return s},set(c){this[n]=c}},copy:{writable:!0,configurable:!0,value:function(c){return r.copy.call(this,c),!r.isShaderMaterial&&!r.isDerivedMaterial&&(eo(this.extensions,c.extensions),eo(this.defines,c.defines),eo(this.uniforms,Ba.clone(c.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const c=new r.constructor;return a(c).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let c=this._depthMaterial;return c||(c=this._depthMaterial=Em(r.isDerivedMaterial?r.getDepthMaterial():new EE({depthPacking:xE}),e),c.defines.IS_DEPTH_MATERIAL="",c.uniforms=this.uniforms),c}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let c=this._distanceMaterial;return c||(c=this._distanceMaterial=Em(r.isDerivedMaterial?r.getDistanceMaterial():new l_,e),c.defines.IS_DISTANCE_MATERIAL="",c.uniforms=this.uniforms),c}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:c,_distanceMaterial:u}=this;c&&c.dispose(),u&&u.dispose(),r.dispose.call(this)}}};return i[t]=o,new o}function W8(r,{vertexShader:e,fragmentShader:t},i,n){let{vertexDefs:s,vertexMainIntro:o,vertexMainOutro:a,vertexTransform:l,fragmentDefs:c,fragmentMainIntro:u,fragmentMainOutro:h,fragmentColorTransform:f,customRewriter:d,timeUniform:m}=i;if(s=s||"",o=o||"",a=a||"",c=c||"",u=u||"",h=h||"",(l||d)&&(e=vm(e)),(f||d)&&(t=t.replace(/^[ \t]*#include <((?:tonemapping|encodings|colorspace|fog|premultiplied_alpha|dithering)_fragment)>/gm,`
//!BEGIN_POST_CHUNK $1
$&
//!END_POST_CHUNK
`),t=vm(t)),d){let A=d({vertexShader:e,fragmentShader:t});e=A.vertexShader,t=A.fragmentShader}if(f){let A=[];t=t.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,p=>(A.push(p),"")),h=`${f}
${A.join(`
`)}
${h}`}if(m){const A=`
uniform float ${m};
`;s=A+s,c=A+c}return l&&(e=`vec3 troika_position_${n};
vec3 troika_normal_${n};
vec2 troika_uv_${n};
${e}
`,s=`${s}
void troikaVertexTransform${n}(inout vec3 position, inout vec3 normal, inout vec2 uv) {
  ${l}
}
`,o=`
troika_position_${n} = vec3(position);
troika_normal_${n} = vec3(normal);
troika_uv_${n} = vec2(uv);
troikaVertexTransform${n}(troika_position_${n}, troika_normal_${n}, troika_uv_${n});
${o}
`,e=e.replace(/\b(position|normal|uv)\b/g,(A,p,y,v)=>/\battribute\s+vec[23]\s+$/.test(v.substr(0,y))?p:`troika_${p}_${n}`),r.map&&r.map.channel>0||(e=e.replace(/\bMAP_UV\b/g,`troika_uv_${n}`))),e=z1(e,n,s,o,a),t=z1(t,n,c,u,h),{vertexShader:e,fragmentShader:t}}function z1(r,e,t,i,n){return(i||n||t)&&(r=r.replace(Ex,`
${t}
void troikaOrigMain${e}() {`),r+=`
void main() {
  ${i}
  troikaOrigMain${e}();
  ${n}
}`),r}function j8(r,e){return r==="uniforms"?void 0:typeof e=="function"?e.toString():e}let q8=0;const H1=new Map;function X8(r){const e=JSON.stringify(r,j8);let t=H1.get(e);return t==null&&H1.set(e,t=++q8),t}/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/function J8(){return typeof window>"u"&&(self.window=self),(function(r){var e={parse:function(n){var s=e._bin,o=new Uint8Array(n);if(s.readASCII(o,0,4)=="ttcf"){var a=4;s.readUshort(o,a),a+=2,s.readUshort(o,a),a+=2;var l=s.readUint(o,a);a+=4;for(var c=[],u=0;u<l;u++){var h=s.readUint(o,a);a+=4,c.push(e._readFont(o,h))}return c}return[e._readFont(o,0)]},_readFont:function(n,s){var o=e._bin,a=s;o.readFixed(n,s),s+=4;var l=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2;for(var c=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],u={_data:n,_offset:a},h={},f=0;f<l;f++){var d=o.readASCII(n,s,4);s+=4,o.readUint(n,s),s+=4;var m=o.readUint(n,s);s+=4;var A=o.readUint(n,s);s+=4,h[d]={offset:m,length:A}}for(f=0;f<c.length;f++){var p=c[f];h[p]&&(u[p.trim()]=e[p.trim()].parse(n,h[p].offset,h[p].length,u))}return u},_tabOffset:function(n,s,o){for(var a=e._bin,l=a.readUshort(n,o+4),c=o+12,u=0;u<l;u++){var h=a.readASCII(n,c,4);c+=4,a.readUint(n,c),c+=4;var f=a.readUint(n,c);if(c+=4,a.readUint(n,c),c+=4,h==s)return f}return 0}};e._bin={readFixed:function(n,s){return(n[s]<<8|n[s+1])+(n[s+2]<<8|n[s+3])/65540},readF2dot14:function(n,s){return e._bin.readShort(n,s)/16384},readInt:function(n,s){return e._bin._view(n).getInt32(s)},readInt8:function(n,s){return e._bin._view(n).getInt8(s)},readShort:function(n,s){return e._bin._view(n).getInt16(s)},readUshort:function(n,s){return e._bin._view(n).getUint16(s)},readUshorts:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(e._bin.readUshort(n,s+2*l));return a},readUint:function(n,s){return e._bin._view(n).getUint32(s)},readUint64:function(n,s){return 4294967296*e._bin.readUint(n,s)+e._bin.readUint(n,s+4)},readASCII:function(n,s,o){for(var a="",l=0;l<o;l++)a+=String.fromCharCode(n[s+l]);return a},readUnicode:function(n,s,o){for(var a="",l=0;l<o;l++){var c=n[s++]<<8|n[s++];a+=String.fromCharCode(c)}return a},_tdec:typeof window<"u"&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(n,s,o){var a=e._bin._tdec;return a&&s==0&&o==n.length?a.decode(n):e._bin.readASCII(n,s,o)},readBytes:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(n[s+l]);return a},readASCIIArray:function(n,s,o){for(var a=[],l=0;l<o;l++)a.push(String.fromCharCode(n[s+l]));return a},_view:function(n){return n._dataView||(n._dataView=n.buffer?new DataView(n.buffer,n.byteOffset,n.byteLength):new DataView(new Uint8Array(n).buffer))}},e._lctf={},e._lctf.parse=function(n,s,o,a,l){var c=e._bin,u={},h=s;c.readFixed(n,s),s+=4;var f=c.readUshort(n,s);s+=2;var d=c.readUshort(n,s);s+=2;var m=c.readUshort(n,s);return s+=2,u.scriptList=e._lctf.readScriptList(n,h+f),u.featureList=e._lctf.readFeatureList(n,h+d),u.lookupList=e._lctf.readLookupList(n,h+m,l),u},e._lctf.readLookupList=function(n,s,o){var a=e._bin,l=s,c=[],u=a.readUshort(n,s);s+=2;for(var h=0;h<u;h++){var f=a.readUshort(n,s);s+=2;var d=e._lctf.readLookupTable(n,l+f,o);c.push(d)}return c},e._lctf.readLookupTable=function(n,s,o){var a=e._bin,l=s,c={tabs:[]};c.ltype=a.readUshort(n,s),s+=2,c.flag=a.readUshort(n,s),s+=2;var u=a.readUshort(n,s);s+=2;for(var h=c.ltype,f=0;f<u;f++){var d=a.readUshort(n,s);s+=2;var m=o(n,h,l+d,c);c.tabs.push(m)}return c},e._lctf.numOfOnes=function(n){for(var s=0,o=0;o<32;o++)(n>>>o&1)!=0&&s++;return s},e._lctf.readClassDef=function(n,s){var o=e._bin,a=[],l=o.readUshort(n,s);if(s+=2,l==1){var c=o.readUshort(n,s);s+=2;var u=o.readUshort(n,s);s+=2;for(var h=0;h<u;h++)a.push(c+h),a.push(c+h),a.push(o.readUshort(n,s)),s+=2}if(l==2){var f=o.readUshort(n,s);for(s+=2,h=0;h<f;h++)a.push(o.readUshort(n,s)),s+=2,a.push(o.readUshort(n,s)),s+=2,a.push(o.readUshort(n,s)),s+=2}return a},e._lctf.getInterval=function(n,s){for(var o=0;o<n.length;o+=3){var a=n[o],l=n[o+1];if(n[o+2],a<=s&&s<=l)return o}return-1},e._lctf.readCoverage=function(n,s){var o=e._bin,a={};a.fmt=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);return s+=2,a.fmt==1&&(a.tab=o.readUshorts(n,s,l)),a.fmt==2&&(a.tab=o.readUshorts(n,s,3*l)),a},e._lctf.coverageIndex=function(n,s){var o=n.tab;if(n.fmt==1)return o.indexOf(s);if(n.fmt==2){var a=e._lctf.getInterval(o,s);if(a!=-1)return o[a+2]+(s-o[a])}return-1},e._lctf.readFeatureList=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readASCII(n,s,4);s+=4;var f=o.readUshort(n,s);s+=2;var d=e._lctf.readFeatureTable(n,a+f);d.tag=h.trim(),l.push(d)}return l},e._lctf.readFeatureTable=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2,c>0&&(l.featureParams=a+c);var u=o.readUshort(n,s);s+=2,l.tab=[];for(var h=0;h<u;h++)l.tab.push(o.readUshort(n,s+2*h));return l},e._lctf.readScriptList=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readASCII(n,s,4);s+=4;var f=o.readUshort(n,s);s+=2,l[h.trim()]=e._lctf.readScriptTable(n,a+f)}return l},e._lctf.readScriptTable=function(n,s){var o=e._bin,a=s,l={},c=o.readUshort(n,s);s+=2,c>0&&(l.default=e._lctf.readLangSysTable(n,a+c));var u=o.readUshort(n,s);s+=2;for(var h=0;h<u;h++){var f=o.readASCII(n,s,4);s+=4;var d=o.readUshort(n,s);s+=2,l[f.trim()]=e._lctf.readLangSysTable(n,a+d)}return l},e._lctf.readLangSysTable=function(n,s){var o=e._bin,a={};o.readUshort(n,s),s+=2,a.reqFeature=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);return s+=2,a.features=o.readUshorts(n,s,l),a},e.CFF={},e.CFF.parse=function(n,s,o){var a=e._bin;(n=new Uint8Array(n.buffer,s,o))[s=0],n[++s],n[++s],n[++s],s++;var l=[];s=e.CFF.readIndex(n,s,l);for(var c=[],u=0;u<l.length-1;u++)c.push(a.readASCII(n,s+l[u],l[u+1]-l[u]));s+=l[l.length-1];var h=[];s=e.CFF.readIndex(n,s,h);var f=[];for(u=0;u<h.length-1;u++)f.push(e.CFF.readDict(n,s+h[u],s+h[u+1]));s+=h[h.length-1];var d=f[0],m=[];s=e.CFF.readIndex(n,s,m);var A=[];for(u=0;u<m.length-1;u++)A.push(a.readASCII(n,s+m[u],m[u+1]-m[u]));if(s+=m[m.length-1],e.CFF.readSubrs(n,s,d),d.CharStrings){s=d.CharStrings,m=[],s=e.CFF.readIndex(n,s,m);var p=[];for(u=0;u<m.length-1;u++)p.push(a.readBytes(n,s+m[u],m[u+1]-m[u]));d.CharStrings=p}if(d.ROS){s=d.FDArray;var y=[];for(s=e.CFF.readIndex(n,s,y),d.FDArray=[],u=0;u<y.length-1;u++){var v=e.CFF.readDict(n,s+y[u],s+y[u+1]);e.CFF._readFDict(n,v,A),d.FDArray.push(v)}s+=y[y.length-1],s=d.FDSelect,d.FDSelect=[];var E=n[s];if(s++,E!=3)throw E;var x=a.readUshort(n,s);for(s+=2,u=0;u<x+1;u++)d.FDSelect.push(a.readUshort(n,s),n[s+2]),s+=3}return d.Encoding&&(d.Encoding=e.CFF.readEncoding(n,d.Encoding,d.CharStrings.length)),d.charset&&(d.charset=e.CFF.readCharset(n,d.charset,d.CharStrings.length)),e.CFF._readFDict(n,d,A),d},e.CFF._readFDict=function(n,s,o){var a;for(var l in s.Private&&(a=s.Private[1],s.Private=e.CFF.readDict(n,a,a+s.Private[0]),s.Private.Subrs&&e.CFF.readSubrs(n,a+s.Private.Subrs,s.Private)),s)["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(l)!=-1&&(s[l]=o[s[l]-426+35])},e.CFF.readSubrs=function(n,s,o){var a=e._bin,l=[];s=e.CFF.readIndex(n,s,l);var c,u=l.length;c=u<1240?107:u<33900?1131:32768,o.Bias=c,o.Subrs=[];for(var h=0;h<l.length-1;h++)o.Subrs.push(a.readBytes(n,s+l[h],l[h+1]-l[h]))},e.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],e.CFF.glyphByUnicode=function(n,s){for(var o=0;o<n.charset.length;o++)if(n.charset[o]==s)return o;return-1},e.CFF.glyphBySE=function(n,s){return s<0||s>255?-1:e.CFF.glyphByUnicode(n,e.CFF.tableSE[s])},e.CFF.readEncoding=function(n,s,o){e._bin;var a=[".notdef"],l=n[s];if(s++,l!=0)throw"error: unknown encoding format: "+l;var c=n[s];s++;for(var u=0;u<c;u++)a.push(n[s+u]);return a},e.CFF.readCharset=function(n,s,o){var a=e._bin,l=[".notdef"],c=n[s];if(s++,c==0)for(var u=0;u<o;u++){var h=a.readUshort(n,s);s+=2,l.push(h)}else{if(c!=1&&c!=2)throw"error: format: "+c;for(;l.length<o;){h=a.readUshort(n,s),s+=2;var f=0;for(c==1?(f=n[s],s++):(f=a.readUshort(n,s),s+=2),u=0;u<=f;u++)l.push(h),h++}}return l},e.CFF.readIndex=function(n,s,o){var a=e._bin,l=a.readUshort(n,s)+1,c=n[s+=2];if(s++,c==1)for(var u=0;u<l;u++)o.push(n[s+u]);else if(c==2)for(u=0;u<l;u++)o.push(a.readUshort(n,s+2*u));else if(c==3)for(u=0;u<l;u++)o.push(16777215&a.readUint(n,s+3*u-1));else if(l!=1)throw"unsupported offset size: "+c+", count: "+l;return(s+=l*c)-1},e.CFF.getCharString=function(n,s,o){var a=e._bin,l=n[s],c=n[s+1];n[s+2],n[s+3],n[s+4];var u=1,h=null,f=null;l<=20&&(h=l,u=1),l==12&&(h=100*l+c,u=2),21<=l&&l<=27&&(h=l,u=1),l==28&&(f=a.readShort(n,s+1),u=3),29<=l&&l<=31&&(h=l,u=1),32<=l&&l<=246&&(f=l-139,u=1),247<=l&&l<=250&&(f=256*(l-247)+c+108,u=2),251<=l&&l<=254&&(f=256*-(l-251)-c-108,u=2),l==255&&(f=a.readInt(n,s+1)/65535,u=5),o.val=f??"o"+h,o.size=u},e.CFF.readCharString=function(n,s,o){for(var a=s+o,l=e._bin,c=[];s<a;){var u=n[s],h=n[s+1];n[s+2],n[s+3],n[s+4];var f=1,d=null,m=null;u<=20&&(d=u,f=1),u==12&&(d=100*u+h,f=2),u!=19&&u!=20||(d=u,f=2),21<=u&&u<=27&&(d=u,f=1),u==28&&(m=l.readShort(n,s+1),f=3),29<=u&&u<=31&&(d=u,f=1),32<=u&&u<=246&&(m=u-139,f=1),247<=u&&u<=250&&(m=256*(u-247)+h+108,f=2),251<=u&&u<=254&&(m=256*-(u-251)-h-108,f=2),u==255&&(m=l.readInt(n,s+1)/65535,f=5),c.push(m??"o"+d),s+=f}return c},e.CFF.readDict=function(n,s,o){for(var a=e._bin,l={},c=[];s<o;){var u=n[s],h=n[s+1];n[s+2],n[s+3],n[s+4];var f=1,d=null,m=null;if(u==28&&(m=a.readShort(n,s+1),f=3),u==29&&(m=a.readInt(n,s+1),f=5),32<=u&&u<=246&&(m=u-139,f=1),247<=u&&u<=250&&(m=256*(u-247)+h+108,f=2),251<=u&&u<=254&&(m=256*-(u-251)-h-108,f=2),u==255)throw m=a.readInt(n,s+1)/65535,f=5,"unknown number";if(u==30){var A=[];for(f=1;;){var p=n[s+f];f++;var y=p>>4,v=15&p;if(y!=15&&A.push(y),v!=15&&A.push(v),v==15)break}for(var E="",x=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],I=0;I<A.length;I++)E+=x[A[I]];m=parseFloat(E)}u<=21&&(d=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][u],f=1,u==12&&(d=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][h],f=2)),d!=null?(l[d]=c.length==1?c[0]:c,c=[]):c.push(m),s+=f}return l},e.cmap={},e.cmap.parse=function(n,s,o){n=new Uint8Array(n.buffer,s,o),s=0;var a=e._bin,l={};a.readUshort(n,s),s+=2;var c=a.readUshort(n,s);s+=2;var u=[];l.tables=[];for(var h=0;h<c;h++){var f=a.readUshort(n,s);s+=2;var d=a.readUshort(n,s);s+=2;var m=a.readUint(n,s);s+=4;var A="p"+f+"e"+d,p=u.indexOf(m);if(p==-1){var y;p=l.tables.length,u.push(m);var v=a.readUshort(n,m);v==0?y=e.cmap.parse0(n,m):v==4?y=e.cmap.parse4(n,m):v==6?y=e.cmap.parse6(n,m):v==12?y=e.cmap.parse12(n,m):console.debug("unknown format: "+v,f,d,m),l.tables.push(y)}if(l[A]!=null)throw"multiple tables for one platform+encoding";l[A]=p}return l},e.cmap.parse0=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2,a.map=[];for(var c=0;c<l-6;c++)a.map.push(n[s+c]);return a},e.cmap.parse4=function(n,s){var o=e._bin,a=s,l={};l.format=o.readUshort(n,s),s+=2;var c=o.readUshort(n,s);s+=2,o.readUshort(n,s),s+=2;var u=o.readUshort(n,s);s+=2;var h=u/2;l.searchRange=o.readUshort(n,s),s+=2,l.entrySelector=o.readUshort(n,s),s+=2,l.rangeShift=o.readUshort(n,s),s+=2,l.endCount=o.readUshorts(n,s,h),s+=2*h,s+=2,l.startCount=o.readUshorts(n,s,h),s+=2*h,l.idDelta=[];for(var f=0;f<h;f++)l.idDelta.push(o.readShort(n,s)),s+=2;for(l.idRangeOffset=o.readUshorts(n,s,h),s+=2*h,l.glyphIdArray=[];s<a+c;)l.glyphIdArray.push(o.readUshort(n,s)),s+=2;return l},e.cmap.parse6=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,o.readUshort(n,s),s+=2,a.firstCode=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2,a.glyphIdArray=[];for(var c=0;c<l;c++)a.glyphIdArray.push(o.readUshort(n,s)),s+=2;return a},e.cmap.parse12=function(n,s){var o=e._bin,a={};a.format=o.readUshort(n,s),s+=2,s+=2,o.readUint(n,s),s+=4,o.readUint(n,s),s+=4;var l=o.readUint(n,s);s+=4,a.groups=[];for(var c=0;c<l;c++){var u=s+12*c,h=o.readUint(n,u+0),f=o.readUint(n,u+4),d=o.readUint(n,u+8);a.groups.push([h,f,d])}return a},e.glyf={},e.glyf.parse=function(n,s,o,a){for(var l=[],c=0;c<a.maxp.numGlyphs;c++)l.push(null);return l},e.glyf._parseGlyf=function(n,s){var o=e._bin,a=n._data,l=e._tabOffset(a,"glyf",n._offset)+n.loca[s];if(n.loca[s]==n.loca[s+1])return null;var c={};if(c.noc=o.readShort(a,l),l+=2,c.xMin=o.readShort(a,l),l+=2,c.yMin=o.readShort(a,l),l+=2,c.xMax=o.readShort(a,l),l+=2,c.yMax=o.readShort(a,l),l+=2,c.xMin>=c.xMax||c.yMin>=c.yMax)return null;if(c.noc>0){c.endPts=[];for(var u=0;u<c.noc;u++)c.endPts.push(o.readUshort(a,l)),l+=2;var h=o.readUshort(a,l);if(l+=2,a.length-l<h)return null;c.instructions=o.readBytes(a,l,h),l+=h;var f=c.endPts[c.noc-1]+1;for(c.flags=[],u=0;u<f;u++){var d=a[l];if(l++,c.flags.push(d),(8&d)!=0){var m=a[l];l++;for(var A=0;A<m;A++)c.flags.push(d),u++}}for(c.xs=[],u=0;u<f;u++){var p=(2&c.flags[u])!=0,y=(16&c.flags[u])!=0;p?(c.xs.push(y?a[l]:-a[l]),l++):y?c.xs.push(0):(c.xs.push(o.readShort(a,l)),l+=2)}for(c.ys=[],u=0;u<f;u++)p=(4&c.flags[u])!=0,y=(32&c.flags[u])!=0,p?(c.ys.push(y?a[l]:-a[l]),l++):y?c.ys.push(0):(c.ys.push(o.readShort(a,l)),l+=2);var v=0,E=0;for(u=0;u<f;u++)v+=c.xs[u],E+=c.ys[u],c.xs[u]=v,c.ys[u]=E}else{var x;c.parts=[];do{x=o.readUshort(a,l),l+=2;var I={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(c.parts.push(I),I.glyphIndex=o.readUshort(a,l),l+=2,1&x){var C=o.readShort(a,l);l+=2;var _=o.readShort(a,l);l+=2}else C=o.readInt8(a,l),l++,_=o.readInt8(a,l),l++;2&x?(I.m.tx=C,I.m.ty=_):(I.p1=C,I.p2=_),8&x?(I.m.a=I.m.d=o.readF2dot14(a,l),l+=2):64&x?(I.m.a=o.readF2dot14(a,l),l+=2,I.m.d=o.readF2dot14(a,l),l+=2):128&x&&(I.m.a=o.readF2dot14(a,l),l+=2,I.m.b=o.readF2dot14(a,l),l+=2,I.m.c=o.readF2dot14(a,l),l+=2,I.m.d=o.readF2dot14(a,l),l+=2)}while(32&x);if(256&x){var S=o.readUshort(a,l);for(l+=2,c.instr=[],u=0;u<S;u++)c.instr.push(a[l]),l++}}return c},e.GDEF={},e.GDEF.parse=function(n,s,o,a){var l=s;s+=4;var c=e._bin.readUshort(n,s);return{glyphClassDef:c===0?null:e._lctf.readClassDef(n,l+c)}},e.GPOS={},e.GPOS.parse=function(n,s,o,a){return e._lctf.parse(n,s,o,a,e.GPOS.subt)},e.GPOS.subt=function(n,s,o,a){var l=e._bin,c=o,u={};if(u.fmt=l.readUshort(n,o),o+=2,s==1||s==2||s==3||s==7||s==8&&u.fmt<=2){var h=l.readUshort(n,o);o+=2,u.coverage=e._lctf.readCoverage(n,h+c)}if(s==1&&u.fmt==1){var f=l.readUshort(n,o);o+=2,f!=0&&(u.pos=e.GPOS.readValueRecord(n,o,f))}else if(s==2&&u.fmt>=1&&u.fmt<=2){f=l.readUshort(n,o),o+=2;var d=l.readUshort(n,o);o+=2;var m=e._lctf.numOfOnes(f),A=e._lctf.numOfOnes(d);if(u.fmt==1){u.pairsets=[];var p=l.readUshort(n,o);o+=2;for(var y=0;y<p;y++){var v=c+l.readUshort(n,o);o+=2;var E=l.readUshort(n,v);v+=2;for(var x=[],I=0;I<E;I++){var C=l.readUshort(n,v);v+=2,f!=0&&(w=e.GPOS.readValueRecord(n,v,f),v+=2*m),d!=0&&(B=e.GPOS.readValueRecord(n,v,d),v+=2*A),x.push({gid2:C,val1:w,val2:B})}u.pairsets.push(x)}}if(u.fmt==2){var _=l.readUshort(n,o);o+=2;var S=l.readUshort(n,o);o+=2;var b=l.readUshort(n,o);o+=2;var T=l.readUshort(n,o);for(o+=2,u.classDef1=e._lctf.readClassDef(n,c+_),u.classDef2=e._lctf.readClassDef(n,c+S),u.matrix=[],y=0;y<b;y++){var R=[];for(I=0;I<T;I++){var w=null,B=null;f!=0&&(w=e.GPOS.readValueRecord(n,o,f),o+=2*m),d!=0&&(B=e.GPOS.readValueRecord(n,o,d),o+=2*A),R.push({val1:w,val2:B})}u.matrix.push(R)}}}else if(s==4&&u.fmt==1)u.markCoverage=e._lctf.readCoverage(n,l.readUshort(n,o)+c),u.baseCoverage=e._lctf.readCoverage(n,l.readUshort(n,o+2)+c),u.markClassCount=l.readUshort(n,o+4),u.markArray=e.GPOS.readMarkArray(n,l.readUshort(n,o+6)+c),u.baseArray=e.GPOS.readBaseArray(n,l.readUshort(n,o+8)+c,u.markClassCount);else if(s==6&&u.fmt==1)u.mark1Coverage=e._lctf.readCoverage(n,l.readUshort(n,o)+c),u.mark2Coverage=e._lctf.readCoverage(n,l.readUshort(n,o+2)+c),u.markClassCount=l.readUshort(n,o+4),u.mark1Array=e.GPOS.readMarkArray(n,l.readUshort(n,o+6)+c),u.mark2Array=e.GPOS.readBaseArray(n,l.readUshort(n,o+8)+c,u.markClassCount);else{if(s==9&&u.fmt==1){var M=l.readUshort(n,o);o+=2;var O=l.readUint(n,o);if(o+=4,a.ltype==9)a.ltype=M;else if(a.ltype!=M)throw"invalid extension substitution";return e.GPOS.subt(n,a.ltype,c+O)}console.debug("unsupported GPOS table LookupType",s,"format",u.fmt)}return u},e.GPOS.readValueRecord=function(n,s,o){var a=e._bin,l=[];return l.push(1&o?a.readShort(n,s):0),s+=1&o?2:0,l.push(2&o?a.readShort(n,s):0),s+=2&o?2:0,l.push(4&o?a.readShort(n,s):0),s+=4&o?2:0,l.push(8&o?a.readShort(n,s):0),s+=8&o?2:0,l},e.GPOS.readBaseArray=function(n,s,o){var a=e._bin,l=[],c=s,u=a.readUshort(n,s);s+=2;for(var h=0;h<u;h++){for(var f=[],d=0;d<o;d++)f.push(e.GPOS.readAnchorRecord(n,c+a.readUshort(n,s))),s+=2;l.push(f)}return l},e.GPOS.readMarkArray=function(n,s){var o=e._bin,a=[],l=s,c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=e.GPOS.readAnchorRecord(n,o.readUshort(n,s+2)+l);h.markClass=o.readUshort(n,s),a.push(h),s+=4}return a},e.GPOS.readAnchorRecord=function(n,s){var o=e._bin,a={};return a.fmt=o.readUshort(n,s),a.x=o.readShort(n,s+2),a.y=o.readShort(n,s+4),a},e.GSUB={},e.GSUB.parse=function(n,s,o,a){return e._lctf.parse(n,s,o,a,e.GSUB.subt)},e.GSUB.subt=function(n,s,o,a){var l=e._bin,c=o,u={};if(u.fmt=l.readUshort(n,o),o+=2,s!=1&&s!=2&&s!=4&&s!=5&&s!=6)return null;if(s==1||s==2||s==4||s==5&&u.fmt<=2||s==6&&u.fmt<=2){var h=l.readUshort(n,o);o+=2,u.coverage=e._lctf.readCoverage(n,c+h)}if(s==1&&u.fmt>=1&&u.fmt<=2){if(u.fmt==1)u.delta=l.readShort(n,o),o+=2;else if(u.fmt==2){var f=l.readUshort(n,o);o+=2,u.newg=l.readUshorts(n,o,f),o+=2*u.newg.length}}else if(s==2&&u.fmt==1){f=l.readUshort(n,o),o+=2,u.seqs=[];for(var d=0;d<f;d++){var m=l.readUshort(n,o)+c;o+=2;var A=l.readUshort(n,m);u.seqs.push(l.readUshorts(n,m+2,A))}}else if(s==4)for(u.vals=[],f=l.readUshort(n,o),o+=2,d=0;d<f;d++){var p=l.readUshort(n,o);o+=2,u.vals.push(e.GSUB.readLigatureSet(n,c+p))}else if(s==5&&u.fmt==2){if(u.fmt==2){var y=l.readUshort(n,o);o+=2,u.cDef=e._lctf.readClassDef(n,c+y),u.scset=[];var v=l.readUshort(n,o);for(o+=2,d=0;d<v;d++){var E=l.readUshort(n,o);o+=2,u.scset.push(E==0?null:e.GSUB.readSubClassSet(n,c+E))}}}else if(s==6&&u.fmt==3){if(u.fmt==3){for(d=0;d<3;d++){f=l.readUshort(n,o),o+=2;for(var x=[],I=0;I<f;I++)x.push(e._lctf.readCoverage(n,c+l.readUshort(n,o+2*I)));o+=2*f,d==0&&(u.backCvg=x),d==1&&(u.inptCvg=x),d==2&&(u.ahedCvg=x)}f=l.readUshort(n,o),o+=2,u.lookupRec=e.GSUB.readSubstLookupRecords(n,o,f)}}else{if(s==7&&u.fmt==1){var C=l.readUshort(n,o);o+=2;var _=l.readUint(n,o);if(o+=4,a.ltype==9)a.ltype=C;else if(a.ltype!=C)throw"invalid extension substitution";return e.GSUB.subt(n,a.ltype,c+_)}console.debug("unsupported GSUB table LookupType",s,"format",u.fmt)}return u},e.GSUB.readSubClassSet=function(n,s){var o=e._bin.readUshort,a=s,l=[],c=o(n,s);s+=2;for(var u=0;u<c;u++){var h=o(n,s);s+=2,l.push(e.GSUB.readSubClassRule(n,a+h))}return l},e.GSUB.readSubClassRule=function(n,s){var o=e._bin.readUshort,a={},l=o(n,s),c=o(n,s+=2);s+=2,a.input=[];for(var u=0;u<l-1;u++)a.input.push(o(n,s)),s+=2;return a.substLookupRecords=e.GSUB.readSubstLookupRecords(n,s,c),a},e.GSUB.readSubstLookupRecords=function(n,s,o){for(var a=e._bin.readUshort,l=[],c=0;c<o;c++)l.push(a(n,s),a(n,s+2)),s+=4;return l},e.GSUB.readChainSubClassSet=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readUshort(n,s);s+=2,l.push(e.GSUB.readChainSubClassRule(n,a+h))}return l},e.GSUB.readChainSubClassRule=function(n,s){for(var o=e._bin,a={},l=["backtrack","input","lookahead"],c=0;c<l.length;c++){var u=o.readUshort(n,s);s+=2,c==1&&u--,a[l[c]]=o.readUshorts(n,s,u),s+=2*a[l[c]].length}return u=o.readUshort(n,s),s+=2,a.subst=o.readUshorts(n,s,2*u),s+=2*a.subst.length,a},e.GSUB.readLigatureSet=function(n,s){var o=e._bin,a=s,l=[],c=o.readUshort(n,s);s+=2;for(var u=0;u<c;u++){var h=o.readUshort(n,s);s+=2,l.push(e.GSUB.readLigature(n,a+h))}return l},e.GSUB.readLigature=function(n,s){var o=e._bin,a={chain:[]};a.nglyph=o.readUshort(n,s),s+=2;var l=o.readUshort(n,s);s+=2;for(var c=0;c<l-1;c++)a.chain.push(o.readUshort(n,s)),s+=2;return a},e.head={},e.head.parse=function(n,s,o){var a=e._bin,l={};return a.readFixed(n,s),s+=4,l.fontRevision=a.readFixed(n,s),s+=4,a.readUint(n,s),s+=4,a.readUint(n,s),s+=4,l.flags=a.readUshort(n,s),s+=2,l.unitsPerEm=a.readUshort(n,s),s+=2,l.created=a.readUint64(n,s),s+=8,l.modified=a.readUint64(n,s),s+=8,l.xMin=a.readShort(n,s),s+=2,l.yMin=a.readShort(n,s),s+=2,l.xMax=a.readShort(n,s),s+=2,l.yMax=a.readShort(n,s),s+=2,l.macStyle=a.readUshort(n,s),s+=2,l.lowestRecPPEM=a.readUshort(n,s),s+=2,l.fontDirectionHint=a.readShort(n,s),s+=2,l.indexToLocFormat=a.readShort(n,s),s+=2,l.glyphDataFormat=a.readShort(n,s),s+=2,l},e.hhea={},e.hhea.parse=function(n,s,o){var a=e._bin,l={};return a.readFixed(n,s),s+=4,l.ascender=a.readShort(n,s),s+=2,l.descender=a.readShort(n,s),s+=2,l.lineGap=a.readShort(n,s),s+=2,l.advanceWidthMax=a.readUshort(n,s),s+=2,l.minLeftSideBearing=a.readShort(n,s),s+=2,l.minRightSideBearing=a.readShort(n,s),s+=2,l.xMaxExtent=a.readShort(n,s),s+=2,l.caretSlopeRise=a.readShort(n,s),s+=2,l.caretSlopeRun=a.readShort(n,s),s+=2,l.caretOffset=a.readShort(n,s),s+=2,s+=8,l.metricDataFormat=a.readShort(n,s),s+=2,l.numberOfHMetrics=a.readUshort(n,s),s+=2,l},e.hmtx={},e.hmtx.parse=function(n,s,o,a){for(var l=e._bin,c={aWidth:[],lsBearing:[]},u=0,h=0,f=0;f<a.maxp.numGlyphs;f++)f<a.hhea.numberOfHMetrics&&(u=l.readUshort(n,s),s+=2,h=l.readShort(n,s),s+=2),c.aWidth.push(u),c.lsBearing.push(h);return c},e.kern={},e.kern.parse=function(n,s,o,a){var l=e._bin,c=l.readUshort(n,s);if(s+=2,c==1)return e.kern.parseV1(n,s-2,o,a);var u=l.readUshort(n,s);s+=2;for(var h={glyph1:[],rval:[]},f=0;f<u;f++){s+=2,o=l.readUshort(n,s),s+=2;var d=l.readUshort(n,s);s+=2;var m=d>>>8;if((m&=15)!=0)throw"unknown kern table format: "+m;s=e.kern.readFormat0(n,s,h)}return h},e.kern.parseV1=function(n,s,o,a){var l=e._bin;l.readFixed(n,s),s+=4;var c=l.readUint(n,s);s+=4;for(var u={glyph1:[],rval:[]},h=0;h<c;h++){l.readUint(n,s),s+=4;var f=l.readUshort(n,s);s+=2,l.readUshort(n,s),s+=2;var d=f>>>8;if((d&=15)!=0)throw"unknown kern table format: "+d;s=e.kern.readFormat0(n,s,u)}return u},e.kern.readFormat0=function(n,s,o){var a=e._bin,l=-1,c=a.readUshort(n,s);s+=2,a.readUshort(n,s),s+=2,a.readUshort(n,s),s+=2,a.readUshort(n,s),s+=2;for(var u=0;u<c;u++){var h=a.readUshort(n,s);s+=2;var f=a.readUshort(n,s);s+=2;var d=a.readShort(n,s);s+=2,h!=l&&(o.glyph1.push(h),o.rval.push({glyph2:[],vals:[]}));var m=o.rval[o.rval.length-1];m.glyph2.push(f),m.vals.push(d),l=h}return s},e.loca={},e.loca.parse=function(n,s,o,a){var l=e._bin,c=[],u=a.head.indexToLocFormat,h=a.maxp.numGlyphs+1;if(u==0)for(var f=0;f<h;f++)c.push(l.readUshort(n,s+(f<<1))<<1);if(u==1)for(f=0;f<h;f++)c.push(l.readUint(n,s+(f<<2)));return c},e.maxp={},e.maxp.parse=function(n,s,o){var a=e._bin,l={},c=a.readUint(n,s);return s+=4,l.numGlyphs=a.readUshort(n,s),s+=2,c==65536&&(l.maxPoints=a.readUshort(n,s),s+=2,l.maxContours=a.readUshort(n,s),s+=2,l.maxCompositePoints=a.readUshort(n,s),s+=2,l.maxCompositeContours=a.readUshort(n,s),s+=2,l.maxZones=a.readUshort(n,s),s+=2,l.maxTwilightPoints=a.readUshort(n,s),s+=2,l.maxStorage=a.readUshort(n,s),s+=2,l.maxFunctionDefs=a.readUshort(n,s),s+=2,l.maxInstructionDefs=a.readUshort(n,s),s+=2,l.maxStackElements=a.readUshort(n,s),s+=2,l.maxSizeOfInstructions=a.readUshort(n,s),s+=2,l.maxComponentElements=a.readUshort(n,s),s+=2,l.maxComponentDepth=a.readUshort(n,s),s+=2),l},e.name={},e.name.parse=function(n,s,o){var a=e._bin,l={};a.readUshort(n,s),s+=2;var c=a.readUshort(n,s);s+=2,a.readUshort(n,s);for(var u,h=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],f=s+=2,d=0;d<c;d++){var m=a.readUshort(n,s);s+=2;var A=a.readUshort(n,s);s+=2;var p=a.readUshort(n,s);s+=2;var y=a.readUshort(n,s);s+=2;var v=a.readUshort(n,s);s+=2;var E=a.readUshort(n,s);s+=2;var x,I=h[y],C=f+12*c+E;if(m==0)x=a.readUnicode(n,C,v/2);else if(m==3&&A==0)x=a.readUnicode(n,C,v/2);else if(A==0)x=a.readASCII(n,C,v);else if(A==1)x=a.readUnicode(n,C,v/2);else if(A==3)x=a.readUnicode(n,C,v/2);else{if(m!=1)throw"unknown encoding "+A+", platformID: "+m;x=a.readASCII(n,C,v),console.debug("reading unknown MAC encoding "+A+" as ASCII")}var _="p"+m+","+p.toString(16);l[_]==null&&(l[_]={}),l[_][I!==void 0?I:y]=x,l[_]._lang=p}for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==1033)return l[S];for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==0)return l[S];for(var S in l)if(l[S].postScriptName!=null&&l[S]._lang==3084)return l[S];for(var S in l)if(l[S].postScriptName!=null)return l[S];for(var S in l){u=S;break}return console.debug("returning name table with languageID "+l[u]._lang),l[u]},e["OS/2"]={},e["OS/2"].parse=function(n,s,o){var a=e._bin.readUshort(n,s);s+=2;var l={};if(a==0)e["OS/2"].version0(n,s,l);else if(a==1)e["OS/2"].version1(n,s,l);else if(a==2||a==3||a==4)e["OS/2"].version2(n,s,l);else{if(a!=5)throw"unknown OS/2 table version: "+a;e["OS/2"].version5(n,s,l)}return l},e["OS/2"].version0=function(n,s,o){var a=e._bin;return o.xAvgCharWidth=a.readShort(n,s),s+=2,o.usWeightClass=a.readUshort(n,s),s+=2,o.usWidthClass=a.readUshort(n,s),s+=2,o.fsType=a.readUshort(n,s),s+=2,o.ySubscriptXSize=a.readShort(n,s),s+=2,o.ySubscriptYSize=a.readShort(n,s),s+=2,o.ySubscriptXOffset=a.readShort(n,s),s+=2,o.ySubscriptYOffset=a.readShort(n,s),s+=2,o.ySuperscriptXSize=a.readShort(n,s),s+=2,o.ySuperscriptYSize=a.readShort(n,s),s+=2,o.ySuperscriptXOffset=a.readShort(n,s),s+=2,o.ySuperscriptYOffset=a.readShort(n,s),s+=2,o.yStrikeoutSize=a.readShort(n,s),s+=2,o.yStrikeoutPosition=a.readShort(n,s),s+=2,o.sFamilyClass=a.readShort(n,s),s+=2,o.panose=a.readBytes(n,s,10),s+=10,o.ulUnicodeRange1=a.readUint(n,s),s+=4,o.ulUnicodeRange2=a.readUint(n,s),s+=4,o.ulUnicodeRange3=a.readUint(n,s),s+=4,o.ulUnicodeRange4=a.readUint(n,s),s+=4,o.achVendID=[a.readInt8(n,s),a.readInt8(n,s+1),a.readInt8(n,s+2),a.readInt8(n,s+3)],s+=4,o.fsSelection=a.readUshort(n,s),s+=2,o.usFirstCharIndex=a.readUshort(n,s),s+=2,o.usLastCharIndex=a.readUshort(n,s),s+=2,o.sTypoAscender=a.readShort(n,s),s+=2,o.sTypoDescender=a.readShort(n,s),s+=2,o.sTypoLineGap=a.readShort(n,s),s+=2,o.usWinAscent=a.readUshort(n,s),s+=2,o.usWinDescent=a.readUshort(n,s),s+=2},e["OS/2"].version1=function(n,s,o){var a=e._bin;return s=e["OS/2"].version0(n,s,o),o.ulCodePageRange1=a.readUint(n,s),s+=4,o.ulCodePageRange2=a.readUint(n,s),s+=4},e["OS/2"].version2=function(n,s,o){var a=e._bin;return s=e["OS/2"].version1(n,s,o),o.sxHeight=a.readShort(n,s),s+=2,o.sCapHeight=a.readShort(n,s),s+=2,o.usDefault=a.readUshort(n,s),s+=2,o.usBreak=a.readUshort(n,s),s+=2,o.usMaxContext=a.readUshort(n,s),s+=2},e["OS/2"].version5=function(n,s,o){var a=e._bin;return s=e["OS/2"].version2(n,s,o),o.usLowerOpticalPointSize=a.readUshort(n,s),s+=2,o.usUpperOpticalPointSize=a.readUshort(n,s),s+=2},e.post={},e.post.parse=function(n,s,o){var a=e._bin,l={};return l.version=a.readFixed(n,s),s+=4,l.italicAngle=a.readFixed(n,s),s+=4,l.underlinePosition=a.readShort(n,s),s+=2,l.underlineThickness=a.readShort(n,s),s+=2,l},e==null&&(e={}),e.U==null&&(e.U={}),e.U.codeToGlyph=function(n,s){var o=n.cmap,a=-1;if(o.p0e4!=null?a=o.p0e4:o.p3e1!=null?a=o.p3e1:o.p1e0!=null?a=o.p1e0:o.p0e3!=null&&(a=o.p0e3),a==-1)throw"no familiar platform and encoding!";var l=o.tables[a];if(l.format==0)return s>=l.map.length?0:l.map[s];if(l.format==4){for(var c=-1,u=0;u<l.endCount.length;u++)if(s<=l.endCount[u]){c=u;break}return c==-1||l.startCount[c]>s?0:65535&(l.idRangeOffset[c]!=0?l.glyphIdArray[s-l.startCount[c]+(l.idRangeOffset[c]>>1)-(l.idRangeOffset.length-c)]:s+l.idDelta[c])}if(l.format==12){if(s>l.groups[l.groups.length-1][1])return 0;for(u=0;u<l.groups.length;u++){var h=l.groups[u];if(h[0]<=s&&s<=h[1])return h[2]+(s-h[0])}return 0}throw"unknown cmap table format "+l.format},e.U.glyphToPath=function(n,s){var o={cmds:[],crds:[]};if(n.SVG&&n.SVG.entries[s]){var a=n.SVG.entries[s];return a==null?o:(typeof a=="string"&&(a=e.SVG.toPath(a),n.SVG.entries[s]=a),a)}if(n.CFF){var l={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:n.CFF.Private?n.CFF.Private.defaultWidthX:0,open:!1},c=n.CFF,u=n.CFF.Private;if(c.ROS){for(var h=0;c.FDSelect[h+2]<=s;)h+=2;u=c.FDArray[c.FDSelect[h+1]].Private}e.U._drawCFF(n.CFF.CharStrings[s],l,c,u,o)}else n.glyf&&e.U._drawGlyf(s,n,o);return o},e.U._drawGlyf=function(n,s,o){var a=s.glyf[n];a==null&&(a=s.glyf[n]=e.glyf._parseGlyf(s,n)),a!=null&&(a.noc>-1?e.U._simpleGlyph(a,o):e.U._compoGlyph(a,s,o))},e.U._simpleGlyph=function(n,s){for(var o=0;o<n.noc;o++){for(var a=o==0?0:n.endPts[o-1]+1,l=n.endPts[o],c=a;c<=l;c++){var u=c==a?l:c-1,h=c==l?a:c+1,f=1&n.flags[c],d=1&n.flags[u],m=1&n.flags[h],A=n.xs[c],p=n.ys[c];if(c==a)if(f){if(!d){e.U.P.moveTo(s,A,p);continue}e.U.P.moveTo(s,n.xs[u],n.ys[u])}else d?e.U.P.moveTo(s,n.xs[u],n.ys[u]):e.U.P.moveTo(s,(n.xs[u]+A)/2,(n.ys[u]+p)/2);f?d&&e.U.P.lineTo(s,A,p):m?e.U.P.qcurveTo(s,A,p,n.xs[h],n.ys[h]):e.U.P.qcurveTo(s,A,p,(A+n.xs[h])/2,(p+n.ys[h])/2)}e.U.P.closePath(s)}},e.U._compoGlyph=function(n,s,o){for(var a=0;a<n.parts.length;a++){var l={cmds:[],crds:[]},c=n.parts[a];e.U._drawGlyf(c.glyphIndex,s,l);for(var u=c.m,h=0;h<l.crds.length;h+=2){var f=l.crds[h],d=l.crds[h+1];o.crds.push(f*u.a+d*u.b+u.tx),o.crds.push(f*u.c+d*u.d+u.ty)}for(h=0;h<l.cmds.length;h++)o.cmds.push(l.cmds[h])}},e.U._getGlyphClass=function(n,s){var o=e._lctf.getInterval(s,n);return o==-1?0:s[o+2]},e.U._applySubs=function(n,s,o,a){for(var l=n.length-s-1,c=0;c<o.tabs.length;c++)if(o.tabs[c]!=null){var u,h=o.tabs[c];if(!h.coverage||(u=e._lctf.coverageIndex(h.coverage,n[s]))!=-1){if(o.ltype==1)n[s],h.fmt==1?n[s]=n[s]+h.delta:n[s]=h.newg[u];else if(o.ltype==4)for(var f=h.vals[u],d=0;d<f.length;d++){var m=f[d],A=m.chain.length;if(!(A>l)){for(var p=!0,y=0,v=0;v<A;v++){for(;n[s+y+(1+v)]==-1;)y++;m.chain[v]!=n[s+y+(1+v)]&&(p=!1)}if(p){for(n[s]=m.nglyph,v=0;v<A+y;v++)n[s+v+1]=-1;break}}}else if(o.ltype==5&&h.fmt==2)for(var E=e._lctf.getInterval(h.cDef,n[s]),x=h.cDef[E+2],I=h.scset[x],C=0;C<I.length;C++){var _=I[C],S=_.input;if(!(S.length>l)){for(p=!0,v=0;v<S.length;v++){var b=e._lctf.getInterval(h.cDef,n[s+1+v]);if(E==-1&&h.cDef[b+2]!=S[v]){p=!1;break}}if(p){var T=_.substLookupRecords;for(d=0;d<T.length;d+=2)T[d],T[d+1]}}}else if(o.ltype==6&&h.fmt==3){if(!e.U._glsCovered(n,h.backCvg,s-h.backCvg.length)||!e.U._glsCovered(n,h.inptCvg,s)||!e.U._glsCovered(n,h.ahedCvg,s+h.inptCvg.length))continue;var R=h.lookupRec;for(C=0;C<R.length;C+=2){E=R[C];var w=a[R[C+1]];e.U._applySubs(n,s+E,w,a)}}}}},e.U._glsCovered=function(n,s,o){for(var a=0;a<s.length;a++)if(e._lctf.coverageIndex(s[a],n[o+a])==-1)return!1;return!0},e.U.glyphsToPath=function(n,s,o){for(var a={cmds:[],crds:[]},l=0,c=0;c<s.length;c++){var u=s[c];if(u!=-1){for(var h=c<s.length-1&&s[c+1]!=-1?s[c+1]:0,f=e.U.glyphToPath(n,u),d=0;d<f.crds.length;d+=2)a.crds.push(f.crds[d]+l),a.crds.push(f.crds[d+1]);for(o&&a.cmds.push(o),d=0;d<f.cmds.length;d++)a.cmds.push(f.cmds[d]);o&&a.cmds.push("X"),l+=n.hmtx.aWidth[u],c<s.length-1&&(l+=e.U.getPairAdjustment(n,u,h))}}return a},e.U.P={},e.U.P.moveTo=function(n,s,o){n.cmds.push("M"),n.crds.push(s,o)},e.U.P.lineTo=function(n,s,o){n.cmds.push("L"),n.crds.push(s,o)},e.U.P.curveTo=function(n,s,o,a,l,c,u){n.cmds.push("C"),n.crds.push(s,o,a,l,c,u)},e.U.P.qcurveTo=function(n,s,o,a,l){n.cmds.push("Q"),n.crds.push(s,o,a,l)},e.U.P.closePath=function(n){n.cmds.push("Z")},e.U._drawCFF=function(n,s,o,a,l){for(var c=s.stack,u=s.nStems,h=s.haveWidth,f=s.width,d=s.open,m=0,A=s.x,p=s.y,y=0,v=0,E=0,x=0,I=0,C=0,_=0,S=0,b=0,T=0,R={val:0,size:0};m<n.length;){e.CFF.getCharString(n,m,R);var w=R.val;if(m+=R.size,w=="o1"||w=="o18")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0;else if(w=="o3"||w=="o23")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0;else if(w=="o4")c.length>1&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),d&&e.U.P.closePath(l),p+=c.pop(),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o5")for(;c.length>0;)A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p);else if(w=="o6"||w=="o7")for(var B=c.length,M=w=="o6",O=0;O<B;O++){var U=c.shift();M?A+=U:p+=U,M=!M,e.U.P.lineTo(l,A,p)}else if(w=="o8"||w=="o24"){B=c.length;for(var Y=0;Y+6<=B;)y=A+c.shift(),v=p+c.shift(),E=y+c.shift(),x=v+c.shift(),A=E+c.shift(),p=x+c.shift(),e.U.P.curveTo(l,y,v,E,x,A,p),Y+=6;w=="o24"&&(A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p))}else{if(w=="o11")break;if(w=="o1234"||w=="o1235"||w=="o1236"||w=="o1237")w=="o1234"&&(v=p,E=(y=A+c.shift())+c.shift(),T=x=v+c.shift(),C=x,S=p,A=(_=(I=(b=E+c.shift())+c.shift())+c.shift())+c.shift(),e.U.P.curveTo(l,y,v,E,x,b,T),e.U.P.curveTo(l,I,C,_,S,A,p)),w=="o1235"&&(y=A+c.shift(),v=p+c.shift(),E=y+c.shift(),x=v+c.shift(),b=E+c.shift(),T=x+c.shift(),I=b+c.shift(),C=T+c.shift(),_=I+c.shift(),S=C+c.shift(),A=_+c.shift(),p=S+c.shift(),c.shift(),e.U.P.curveTo(l,y,v,E,x,b,T),e.U.P.curveTo(l,I,C,_,S,A,p)),w=="o1236"&&(y=A+c.shift(),v=p+c.shift(),E=y+c.shift(),T=x=v+c.shift(),C=x,_=(I=(b=E+c.shift())+c.shift())+c.shift(),S=C+c.shift(),A=_+c.shift(),e.U.P.curveTo(l,y,v,E,x,b,T),e.U.P.curveTo(l,I,C,_,S,A,p)),w=="o1237"&&(y=A+c.shift(),v=p+c.shift(),E=y+c.shift(),x=v+c.shift(),b=E+c.shift(),T=x+c.shift(),I=b+c.shift(),C=T+c.shift(),_=I+c.shift(),S=C+c.shift(),Math.abs(_-A)>Math.abs(S-p)?A=_+c.shift():p=S+c.shift(),e.U.P.curveTo(l,y,v,E,x,b,T),e.U.P.curveTo(l,I,C,_,S,A,p));else if(w=="o14"){if(c.length>0&&!h&&(f=c.shift()+o.nominalWidthX,h=!0),c.length==4){var W=c.shift(),N=c.shift(),K=c.shift(),D=c.shift(),z=e.CFF.glyphBySE(o,K),$=e.CFF.glyphBySE(o,D);e.U._drawCFF(o.CharStrings[z],s,o,a,l),s.x=W,s.y=N,e.U._drawCFF(o.CharStrings[$],s,o,a,l)}d&&(e.U.P.closePath(l),d=!1)}else if(w=="o19"||w=="o20")c.length%2!=0&&!h&&(f=c.shift()+a.nominalWidthX),u+=c.length>>1,c.length=0,h=!0,m+=u+7>>3;else if(w=="o21")c.length>2&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),p+=c.pop(),A+=c.pop(),d&&e.U.P.closePath(l),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o22")c.length>1&&!h&&(f=c.shift()+a.nominalWidthX,h=!0),A+=c.pop(),d&&e.U.P.closePath(l),e.U.P.moveTo(l,A,p),d=!0;else if(w=="o25"){for(;c.length>6;)A+=c.shift(),p+=c.shift(),e.U.P.lineTo(l,A,p);y=A+c.shift(),v=p+c.shift(),E=y+c.shift(),x=v+c.shift(),A=E+c.shift(),p=x+c.shift(),e.U.P.curveTo(l,y,v,E,x,A,p)}else if(w=="o26")for(c.length%2&&(A+=c.shift());c.length>0;)y=A,v=p+c.shift(),A=E=y+c.shift(),p=(x=v+c.shift())+c.shift(),e.U.P.curveTo(l,y,v,E,x,A,p);else if(w=="o27")for(c.length%2&&(p+=c.shift());c.length>0;)v=p,E=(y=A+c.shift())+c.shift(),x=v+c.shift(),A=E+c.shift(),p=x,e.U.P.curveTo(l,y,v,E,x,A,p);else if(w=="o10"||w=="o29"){var V=w=="o10"?a:o;if(c.length==0)console.debug("error: empty stack");else{var P=c.pop(),G=V.Subrs[P+V.Bias];s.x=A,s.y=p,s.nStems=u,s.haveWidth=h,s.width=f,s.open=d,e.U._drawCFF(G,s,o,a,l),A=s.x,p=s.y,u=s.nStems,h=s.haveWidth,f=s.width,d=s.open}}else if(w=="o30"||w=="o31"){var F=c.length,k=(Y=0,w=="o31");for(Y+=F-(B=-3&F);Y<B;)k?(v=p,E=(y=A+c.shift())+c.shift(),p=(x=v+c.shift())+c.shift(),B-Y==5?(A=E+c.shift(),Y++):A=E,k=!1):(y=A,v=p+c.shift(),E=y+c.shift(),x=v+c.shift(),A=E+c.shift(),B-Y==5?(p=x+c.shift(),Y++):p=x,k=!0),e.U.P.curveTo(l,y,v,E,x,A,p),Y+=4}else{if((w+"").charAt(0)=="o")throw console.debug("Unknown operation: "+w,n),w;c.push(w)}}}s.x=A,s.y=p,s.nStems=u,s.haveWidth=h,s.width=f,s.open=d};var t=e,i={Typr:t};return r.Typr=t,r.default=i,Object.defineProperty(r,"__esModule",{value:!0}),r})({}).Typr}/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/function Z8(){return(function(r){var e=Uint8Array,t=Uint16Array,i=Uint32Array,n=new e([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),s=new e([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),o=new e([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),a=function(w,B){for(var M=new t(31),O=0;O<31;++O)M[O]=B+=1<<w[O-1];var U=new i(M[30]);for(O=1;O<30;++O)for(var Y=M[O];Y<M[O+1];++Y)U[Y]=Y-M[O]<<5|O;return[M,U]},l=a(n,2),c=l[0],u=l[1];c[28]=258,u[258]=28;for(var h=a(s,0)[0],f=new t(32768),d=0;d<32768;++d){var m=(43690&d)>>>1|(21845&d)<<1;m=(61680&(m=(52428&m)>>>2|(13107&m)<<2))>>>4|(3855&m)<<4,f[d]=((65280&m)>>>8|(255&m)<<8)>>>1}var A=function(w,B,M){for(var O=w.length,U=0,Y=new t(B);U<O;++U)++Y[w[U]-1];var W,N=new t(B);for(U=0;U<B;++U)N[U]=N[U-1]+Y[U-1]<<1;{W=new t(1<<B);var K=15-B;for(U=0;U<O;++U)if(w[U])for(var D=U<<4|w[U],z=B-w[U],$=N[w[U]-1]++<<z,V=$|(1<<z)-1;$<=V;++$)W[f[$]>>>K]=D}return W},p=new e(288);for(d=0;d<144;++d)p[d]=8;for(d=144;d<256;++d)p[d]=9;for(d=256;d<280;++d)p[d]=7;for(d=280;d<288;++d)p[d]=8;var y=new e(32);for(d=0;d<32;++d)y[d]=5;var v=A(p,9),E=A(y,5),x=function(w){for(var B=w[0],M=1;M<w.length;++M)w[M]>B&&(B=w[M]);return B},I=function(w,B,M){var O=B/8|0;return(w[O]|w[O+1]<<8)>>(7&B)&M},C=function(w,B){var M=B/8|0;return(w[M]|w[M+1]<<8|w[M+2]<<16)>>(7&B)},_=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],S=function(w,B,M){var O=new Error(B||_[w]);if(O.code=w,Error.captureStackTrace&&Error.captureStackTrace(O,S),!M)throw O;return O},b=function(w,B,M){var O=w.length;if(!O||M&&!M.l&&O<5)return B||new e(0);var U=!B||M,Y=!M||M.i;M||(M={}),B||(B=new e(3*O));var W,N=function(je){var ie=B.length;if(je>ie){var be=new e(Math.max(2*ie,je));be.set(B),B=be}},K=M.f||0,D=M.p||0,z=M.b||0,$=M.l,V=M.d,P=M.m,G=M.n,F=8*O;do{if(!$){M.f=K=I(w,D,1);var k=I(w,D+1,3);if(D+=3,!k){var Z=w[(q=((W=D)/8|0)+(7&W&&1)+4)-4]|w[q-3]<<8,ne=q+Z;if(ne>O){Y&&S(0);break}U&&N(z+Z),B.set(w.subarray(q,ne),z),M.b=z+=Z,M.p=D=8*ne;continue}if(k==1)$=v,V=E,P=9,G=5;else if(k==2){var X=I(w,D,31)+257,te=I(w,D+10,15)+4,ye=X+I(w,D+5,31)+1;D+=14;for(var ve=new e(ye),re=new e(19),se=0;se<te;++se)re[o[se]]=I(w,D+3*se,7);D+=3*te;var he=x(re),le=(1<<he)-1,J=A(re,he);for(se=0;se<ye;){var q,oe=J[I(w,D,le)];if(D+=15&oe,(q=oe>>>4)<16)ve[se++]=q;else{var Ie=0,_e=0;for(q==16?(_e=3+I(w,D,3),D+=2,Ie=ve[se-1]):q==17?(_e=3+I(w,D,7),D+=3):q==18&&(_e=11+I(w,D,127),D+=7);_e--;)ve[se++]=Ie}}var Be=ve.subarray(0,X),Se=ve.subarray(X);P=x(Be),G=x(Se),$=A(Be,P),V=A(Se,G)}else S(1);if(D>F){Y&&S(0);break}}U&&N(z+131072);for(var Ke=(1<<P)-1,Me=(1<<G)-1,Ge=D;;Ge=D){var Qe=(Ie=$[C(w,D)&Ke])>>>4;if((D+=15&Ie)>F){Y&&S(0);break}if(Ie||S(2),Qe<256)B[z++]=Qe;else{if(Qe==256){Ge=D,$=null;break}var qe=Qe-254;if(Qe>264){var rt=n[se=Qe-257];qe=I(w,D,(1<<rt)-1)+c[se],D+=rt}var gt=V[C(w,D)&Me],nt=gt>>>4;if(gt||S(3),D+=15&gt,Se=h[nt],nt>3&&(rt=s[nt],Se+=C(w,D)&(1<<rt)-1,D+=rt),D>F){Y&&S(0);break}U&&N(z+131072);for(var Xe=z+qe;z<Xe;z+=4)B[z]=B[z-Se],B[z+1]=B[z+1-Se],B[z+2]=B[z+2-Se],B[z+3]=B[z+3-Se];z=Xe}}M.l=$,M.p=Ge,M.b=z,$&&(K=1,M.m=P,M.d=V,M.n=G)}while(!K);return z==B.length?B:(function(je,ie,be){(be==null||be>je.length)&&(be=je.length);var Le=new(je instanceof t?t:je instanceof i?i:e)(be-ie);return Le.set(je.subarray(ie,be)),Le})(B,0,z)},T=new e(0),R=typeof TextDecoder<"u"&&new TextDecoder;try{R.decode(T,{stream:!0})}catch{}return r.convert_streams=function(w){var B=new DataView(w),M=0;function O(){var X=B.getUint16(M);return M+=2,X}function U(){var X=B.getUint32(M);return M+=4,X}function Y(X){Z.setUint16(ne,X),ne+=2}function W(X){Z.setUint32(ne,X),ne+=4}for(var N={signature:U(),flavor:U(),length:U(),numTables:O(),reserved:O(),totalSfntSize:U(),majorVersion:O(),minorVersion:O(),metaOffset:U(),metaLength:U(),metaOrigLength:U(),privOffset:U(),privLength:U()},K=0;Math.pow(2,K)<=N.numTables;)K++;K--;for(var D=16*Math.pow(2,K),z=16*N.numTables-D,$=12,V=[],P=0;P<N.numTables;P++)V.push({tag:U(),offset:U(),compLength:U(),origLength:U(),origChecksum:U()}),$+=16;var G,F=new Uint8Array(12+16*V.length+V.reduce((function(X,te){return X+te.origLength+4}),0)),k=F.buffer,Z=new DataView(k),ne=0;return W(N.flavor),Y(N.numTables),Y(D),Y(K),Y(z),V.forEach((function(X){W(X.tag),W(X.origChecksum),W($),W(X.origLength),X.outOffset=$,($+=X.origLength)%4!=0&&($+=4-$%4)})),V.forEach((function(X){var te,ye=w.slice(X.offset,X.offset+X.compLength);if(X.compLength!=X.origLength){var ve=new Uint8Array(X.origLength);te=new Uint8Array(ye,2),b(te,ve)}else ve=new Uint8Array(ye);F.set(ve,X.outOffset);var re=0;($=X.outOffset+X.origLength)%4!=0&&(re=4-$%4),F.set(new Uint8Array(re).buffer,X.outOffset+X.origLength),G=$+re})),k.slice(0,G)},Object.defineProperty(r,"__esModule",{value:!0}),r})({}).convert_streams}function eB(r,e){const t={M:2,L:2,Q:4,C:6,Z:0},i={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},n=1,s=2,o=4,a=8,l=16,c=32;let u;function h(_){if(!u){const S={R:s,L:n,D:o,C:l,U:c,T:a};u=new Map;for(let b in i){let T=0;i[b].split(",").forEach(R=>{let[w,B]=R.split("+");w=parseInt(w,36),B=B?parseInt(B,36):0,u.set(T+=w,S[b]);for(let M=B;M--;)u.set(++T,S[b])})}}return u.get(_)||c}const f=1,d=2,m=3,A=4,p=[null,"isol","init","fina","medi"];function y(_){const S=new Uint8Array(_.length);let b=c,T=f,R=-1;for(let w=0;w<_.length;w++){const B=_.codePointAt(w);let M=h(B)|0,O=f;M&a||(b&(n|o|l)?M&(s|o|l)?(O=m,(T===f||T===m)&&S[R]++):M&(n|c)&&(T===d||T===A)&&S[R]--:b&(s|c)&&(T===d||T===A)&&S[R]--,T=S[w]=O,b=M,R=w,B>65535&&w++)}return S}function v(_,S){const b=[];for(let R=0;R<S.length;R++){const w=S.codePointAt(R);w>65535&&R++,b.push(r.U.codeToGlyph(_,w))}const T=_.GSUB;if(T){const{lookupList:R,featureList:w}=T;let B;const M=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,O=[];w.forEach(U=>{if(M.test(U.tag))for(let Y=0;Y<U.tab.length;Y++){if(O[U.tab[Y]])continue;O[U.tab[Y]]=!0;const W=R[U.tab[Y]],N=/^(isol|init|fina|medi)$/.test(U.tag);N&&!B&&(B=y(S));for(let K=0;K<b.length;K++)(!B||!N||p[B[K]]===U.tag)&&r.U._applySubs(b,K,W,R)}})}return b}function E(_,S){const b=new Int16Array(S.length*3);let T=0;for(;T<S.length;T++){const M=S[T];if(M===-1)continue;b[T*3+2]=_.hmtx.aWidth[M];const O=_.GPOS;if(O){const U=O.lookupList;for(let Y=0;Y<U.length;Y++){const W=U[Y];for(let N=0;N<W.tabs.length;N++){const K=W.tabs[N];if(W.ltype===1){if(r._lctf.coverageIndex(K.coverage,M)!==-1&&K.pos){B(K.pos,T);break}}else if(W.ltype===2){let D=null,z=R();if(z!==-1){const $=r._lctf.coverageIndex(K.coverage,S[z]);if($!==-1){if(K.fmt===1){const V=K.pairsets[$];for(let P=0;P<V.length;P++)V[P].gid2===M&&(D=V[P])}else if(K.fmt===2){const V=r.U._getGlyphClass(S[z],K.classDef1),P=r.U._getGlyphClass(M,K.classDef2);D=K.matrix[V][P]}if(D){D.val1&&B(D.val1,z),D.val2&&B(D.val2,T);break}}}}else if(W.ltype===4){const D=r._lctf.coverageIndex(K.markCoverage,M);if(D!==-1){const z=R(w),$=z===-1?-1:r._lctf.coverageIndex(K.baseCoverage,S[z]);if($!==-1){const V=K.markArray[D],P=K.baseArray[$][V.markClass];b[T*3]=P.x-V.x+b[z*3]-b[z*3+2],b[T*3+1]=P.y-V.y+b[z*3+1];break}}}else if(W.ltype===6){const D=r._lctf.coverageIndex(K.mark1Coverage,M);if(D!==-1){const z=R();if(z!==-1){const $=S[z];if(x(_,$)===3){const V=r._lctf.coverageIndex(K.mark2Coverage,$);if(V!==-1){const P=K.mark1Array[D],G=K.mark2Array[V][P.markClass];b[T*3]=G.x-P.x+b[z*3]-b[z*3+2],b[T*3+1]=G.y-P.y+b[z*3+1];break}}}}}}}}else if(_.kern&&!_.cff){const U=R();if(U!==-1){const Y=_.kern.glyph1.indexOf(S[U]);if(Y!==-1){const W=_.kern.rval[Y].glyph2.indexOf(M);W!==-1&&(b[U*3+2]+=_.kern.rval[Y].vals[W])}}}}return b;function R(M){for(let O=T-1;O>=0;O--)if(S[O]!==-1&&(!M||M(S[O])))return O;return-1}function w(M){return x(_,M)===1}function B(M,O){for(let U=0;U<3;U++)b[O*3+U]+=M[U]||0}}function x(_,S){const b=_.GDEF&&_.GDEF.glyphClassDef;return b?r.U._getGlyphClass(S,b):0}function I(..._){for(let S=0;S<_.length;S++)if(typeof _[S]=="number")return _[S]}function C(_){const S=Object.create(null),b=_["OS/2"],T=_.hhea,R=_.head.unitsPerEm,w=I(b&&b.sTypoAscender,T&&T.ascender,R),B={unitsPerEm:R,ascender:w,descender:I(b&&b.sTypoDescender,T&&T.descender,0),capHeight:I(b&&b.sCapHeight,w),xHeight:I(b&&b.sxHeight,w),lineGap:I(b&&b.sTypoLineGap,T&&T.lineGap),supportsCodePoint(M){return r.U.codeToGlyph(_,M)>0},forEachGlyph(M,O,U,Y){let W=0;const N=1/B.unitsPerEm*O,K=v(_,M);let D=0;const z=E(_,K);return K.forEach(($,V)=>{if($!==-1){let P=S[$];if(!P){const{cmds:G,crds:F}=r.U.glyphToPath(_,$);let k="",Z=0;for(let ve=0,re=G.length;ve<re;ve++){const se=t[G[ve]];k+=G[ve];for(let he=1;he<=se;he++)k+=(he>1?",":"")+F[Z++]}let ne,X,te,ye;if(F.length){ne=X=1/0,te=ye=-1/0;for(let ve=0,re=F.length;ve<re;ve+=2){let se=F[ve],he=F[ve+1];se<ne&&(ne=se),he<X&&(X=he),se>te&&(te=se),he>ye&&(ye=he)}}else ne=te=X=ye=0;P=S[$]={index:$,advanceWidth:_.hmtx.aWidth[$],xMin:ne,yMin:X,xMax:te,yMax:ye,path:k}}Y.call(null,P,W+z[V*3]*N,z[V*3+1]*N,D),W+=z[V*3+2]*N,U&&(W+=U*O)}D+=M.codePointAt(D)>65535?2:1}),W}};return B}return function(S){const b=new Uint8Array(S,0,4),T=r._bin.readASCII(b,0,4);if(T==="wOFF")S=e(S);else if(T==="wOF2")throw new Error("woff2 fonts not supported");return C(r.parse(S)[0])}}const tB=Ga({name:"Typr Font Parser",dependencies:[J8,Z8,eB],init(r,e,t){const i=r(),n=e();return t(i,n)}});/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/function iB(){return(function(r){var e=function(){this.buckets=new Map};e.prototype.add=function(E){var x=E>>5;this.buckets.set(x,(this.buckets.get(x)||0)|1<<(31&E))},e.prototype.has=function(E){var x=this.buckets.get(E>>5);return x!==void 0&&(x&1<<(31&E))!=0},e.prototype.serialize=function(){var E=[];return this.buckets.forEach((function(x,I){E.push((+I).toString(36)+":"+x.toString(36))})),E.join(",")},e.prototype.deserialize=function(E){var x=this;this.buckets.clear(),E.split(",").forEach((function(I){var C=I.split(":");x.buckets.set(parseInt(C[0],36),parseInt(C[1],36))}))};var t=Math.pow(2,8),i=t-1,n=~i;function s(E){var x=(function(C){return C&n})(E).toString(16),I=(function(C){return(C&n)+t-1})(E).toString(16);return"codepoint-index/plane"+(E>>16)+"/"+x+"-"+I+".json"}function o(E,x){var I=E&i,C=x.codePointAt(I/6|0);return((C=(C||48)-48)&1<<I%6)!=0}function a(E,x){var I;(I=E,I.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map((function(C){return C.split("-").map((function(_){return parseInt(_.trim(),16)}))}))).forEach((function(C){var _=C[0],S=C[1];S===void 0&&(S=_),x(_,S)}))}function l(E,x){a(E,(function(I,C){for(var _=I;_<=C;_++)x(_)}))}var c={},u={},h=new WeakMap,f="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(E){var x=h.get(E);return x||(x=new e,l(E.ranges,(function(I){return x.add(I)})),h.set(E,x)),x}var m,A=new Map;function p(E,x,I){return E[x]?x:E[I]?I:(function(C){for(var _ in C)return _})(E)}function y(E,x){var I=x;if(!E.includes(I)){I=1/0;for(var C=0;C<E.length;C++)Math.abs(E[C]-x)<Math.abs(I-x)&&(I=E[C])}return I}function v(E){return m||(m=new Set,l("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",(function(x){m.add(x)}))),m.has(E)}return r.CodePointSet=e,r.clearCache=function(){c={},u={}},r.getFontsForString=function(E,x){x===void 0&&(x={});var I,C=x.lang;C===void 0&&(C=/\p{Script=Hangul}/u.test(I=E)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(I)?"ja":"en");var _=x.category;_===void 0&&(_="sans-serif");var S=x.style;S===void 0&&(S="normal");var b=x.weight;b===void 0&&(b=400);var T=(x.dataUrl||f).replace(/\/$/g,""),R=new Map,w=new Uint8Array(E.length),B={},M={},O=new Array(E.length),U=new Map,Y=!1;function W(D){var z=A.get(D);return z||(z=fetch(T+"/"+D).then((function($){if(!$.ok)throw new Error($.statusText);return $.json().then((function(V){if(!Array.isArray(V)||V[0]!==1)throw new Error("Incorrect schema version; need 1, got "+V[0]);return V[1]}))})).catch((function($){if(T!==f)return Y||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+T+'", trying default CDN. '+$.message),Y=!0),T=f,A.delete(D),W(D);throw $})),A.set(D,z)),z}for(var N=function(D){var z=E.codePointAt(D),$=s(z);O[D]=$,c[$]||U.has($)||U.set($,W($).then((function(V){c[$]=V}))),z>65535&&(D++,K=D)},K=0;K<E.length;K++)N(K);return Promise.all(U.values()).then((function(){U.clear();for(var D=function($){var V=E.codePointAt($),P=null,G=c[O[$]],F=void 0;for(var k in G){var Z=M[k];if(Z===void 0&&(Z=M[k]=new RegExp(k).test(C||"en")),Z){for(var ne in F=k,G[k])if(o(V,G[k][ne])){P=ne;break}break}}if(!P){e:for(var X in G)if(X!==F){for(var te in G[X])if(o(V,G[X][te])){P=te;break e}}}P||(console.debug("No font coverage for U+"+V.toString(16)),P="latin"),O[$]=P,u[P]||U.has(P)||U.set(P,W("font-meta/"+P+".json").then((function(ye){u[P]=ye}))),V>65535&&($++,z=$)},z=0;z<E.length;z++)D(z);return Promise.all(U.values())})).then((function(){for(var D,z=null,$=0;$<E.length;$++){var V=E.codePointAt($);if(z&&(v(V)||d(z).has(V)))w[$]=w[$-1];else{z=u[O[$]];var P=B[z.id];if(!P){var G=z.typeforms,F=p(G,_,"sans-serif"),k=p(G[F],S,"normal"),Z=y((D=G[F])===null||D===void 0?void 0:D[k],b);P=B[z.id]=T+"/font-files/"+z.id+"/"+F+"."+k+"."+Z+".woff"}var ne=R.get(P);ne==null&&(ne=R.size,R.set(P,ne)),w[$]=ne}V>65535&&($++,w[$]=w[$-1])}return{fontUrls:Array.from(R.keys()),chars:w}}))},Object.defineProperty(r,"__esModule",{value:!0}),r})({})}function nB(r,e){const t=Object.create(null),i=Object.create(null);function n(o,a){const l=c=>{console.error(`Failure loading font ${o}`,c)};try{const c=new XMLHttpRequest;c.open("get",o,!0),c.responseType="arraybuffer",c.onload=function(){if(c.status>=400)l(new Error(c.statusText));else if(c.status>0)try{const u=r(c.response);u.src=o,a(u)}catch(u){l(u)}},c.onerror=l,c.send()}catch(c){l(c)}}function s(o,a){let l=t[o];l?a(l):i[o]?i[o].push(a):(i[o]=[a],n(o,c=>{c.src=o,t[o]=c,i[o].forEach(u=>u(c)),delete i[o]}))}return function(o,a,{lang:l,fonts:c=[],style:u="normal",weight:h="normal",unicodeFontsURL:f}={}){const d=new Uint8Array(o.length),m=[];o.length||v();const A=new Map,p=[];if(u!=="italic"&&(u="normal"),typeof h!="number"&&(h=h==="bold"?700:400),c&&!Array.isArray(c)&&(c=[c]),c=c.slice().filter(x=>!x.lang||x.lang.test(l)).reverse(),c.length){let _=0;(function S(b=0){for(let T=b,R=o.length;T<R;T++){const w=o.codePointAt(T);if(_===1&&m[d[T-1]].supportsCodePoint(w)||T>0&&/\s/.test(o[T]))d[T]=d[T-1],_===2&&(p[p.length-1][1]=T);else for(let B=d[T],M=c.length;B<=M;B++)if(B===M){const O=_===2?p[p.length-1]:p[p.length]=[T,T];O[1]=T,_=2}else{d[T]=B;const{src:O,unicodeRange:U}=c[B];if(!U||E(w,U)){const Y=t[O];if(!Y){s(O,()=>{S(T)});return}if(Y.supportsCodePoint(w)){let W=A.get(Y);typeof W!="number"&&(W=m.length,m.push(Y),A.set(Y,W)),d[T]=W,_=1;break}}}w>65535&&T+1<R&&(d[T+1]=d[T],T++,_===2&&(p[p.length-1][1]=T))}y()})()}else p.push([0,o.length-1]),y();function y(){if(p.length){const x=p.map(I=>o.substring(I[0],I[1]+1)).join(`
`);e.getFontsForString(x,{lang:l||void 0,style:u,weight:h,dataUrl:f}).then(({fontUrls:I,chars:C})=>{const _=m.length;let S=0;p.forEach(T=>{for(let R=0,w=T[1]-T[0];R<=w;R++)d[T[0]+R]=C[S++]+_;S++});let b=0;I.forEach((T,R)=>{s(T,w=>{m[R+_]=w,++b===I.length&&v()})})})}else v()}function v(){a({chars:d,fonts:m})}function E(x,I){for(let C=0;C<I.length;C++){const[_,S=_]=I[C];if(_<=x&&x<=S)return!0}return!1}}}const sB=Ga({name:"FontResolver",dependencies:[nB,tB,iB],init(r,e,t){return r(e,t())}});function rB(r,e){const i=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,n="[^\\S\\u00A0]",s=new RegExp(`${n}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function o({text:m,lang:A,fonts:p,style:y,weight:v,preResolvedFonts:E,unicodeFontsURL:x},I){const C=({chars:_,fonts:S})=>{let b,T;const R=[];for(let w=0;w<_.length;w++)_[w]!==T?(T=_[w],R.push(b={start:w,end:w,fontObj:S[_[w]]})):b.end=w;I(R)};E?C(E):r(m,C,{lang:A,fonts:p,style:y,weight:v,unicodeFontsURL:x})}function a({text:m="",font:A,lang:p,sdfGlyphSize:y=64,fontSize:v=400,fontWeight:E=1,fontStyle:x="normal",letterSpacing:I=0,lineHeight:C="normal",maxWidth:_=1/0,direction:S,textAlign:b="left",textIndent:T=0,whiteSpace:R="normal",overflowWrap:w="normal",anchorX:B=0,anchorY:M=0,metricsOnly:O=!1,unicodeFontsURL:U,preResolvedFonts:Y=null,includeCaretPositions:W=!1,chunkedBoundsSize:N=8192,colorRanges:K=null},D){const z=h(),$={fontLoad:0,typesetting:0};m.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),m=m.replace(/\r\n/g,`
`).replace(/\r/g,`
`)),v=+v,I=+I,_=+_,C=C||"normal",T=+T,o({text:m,lang:p,style:x,weight:E,fonts:typeof A=="string"?[{src:A}]:A,unicodeFontsURL:U,preResolvedFonts:Y},V=>{$.fontLoad=h()-z;const P=isFinite(_);let G=null,F=null,k=null,Z=null,ne=null,X=null,te=null,ye=null,ve=0,re=0,se=R!=="nowrap";const he=new Map,le=h();let J=T,q=0,oe=new f;const Ie=[oe];V.forEach(Me=>{const{fontObj:Ge}=Me,{ascender:Qe,descender:qe,unitsPerEm:rt,lineGap:gt,capHeight:nt,xHeight:Xe}=Ge;let je=he.get(Ge);if(!je){const pe=v/rt,at=C==="normal"?(Qe-qe+gt)*pe:C*v,ti=(at-(Qe-qe)*pe)/2,Dt=Math.min(at,(Qe-qe)*pe),yt=(Qe+qe)/2*pe+Dt/2;je={index:he.size,src:Ge.src,fontObj:Ge,fontSizeMult:pe,unitsPerEm:rt,ascender:Qe*pe,descender:qe*pe,capHeight:nt*pe,xHeight:Xe*pe,lineHeight:at,baseline:-ti-Qe*pe,caretTop:yt,caretBottom:yt-Dt},he.set(Ge,je)}const{fontSizeMult:ie}=je,be=m.slice(Me.start,Me.end+1);let Le,Ye;Ge.forEachGlyph(be,v,I,(pe,at,ti,Dt)=>{at+=q,Dt+=Me.start,Le=at,Ye=pe;const yt=m.charAt(Dt),wt=pe.advanceWidth*ie,Tt=oe.count;let lt;if("isEmpty"in pe||(pe.isWhitespace=!!yt&&new RegExp(n).test(yt),pe.canBreakAfter=!!yt&&s.test(yt),pe.isEmpty=pe.xMin===pe.xMax||pe.yMin===pe.yMax||i.test(yt)),!pe.isWhitespace&&!pe.isEmpty&&re++,se&&P&&!pe.isWhitespace&&at+wt+J>_&&Tt){if(oe.glyphAt(Tt-1).glyphObj.canBreakAfter)lt=new f,J=-at;else for(let fi=Tt;fi--;)if(fi===0&&w==="break-word"){lt=new f,J=-at;break}else if(oe.glyphAt(fi).glyphObj.canBreakAfter){lt=oe.splitAt(fi+1);const di=lt.glyphAt(0).x;J-=di;for(let _i=lt.count;_i--;)lt.glyphAt(_i).x-=di;break}lt&&(oe.isSoftWrapped=!0,oe=lt,Ie.push(oe),ve=_)}let Bt=oe.glyphAt(oe.count);Bt.glyphObj=pe,Bt.x=at+J,Bt.y=ti,Bt.width=wt,Bt.charIndex=Dt,Bt.fontData=je,yt===`
`&&(oe=new f,Ie.push(oe),J=-(at+wt+I*v)+T)}),q=Le+Ye.advanceWidth*ie+I*v});let _e=0;Ie.forEach(Me=>{let Ge=!0;for(let Qe=Me.count;Qe--;){const qe=Me.glyphAt(Qe);Ge&&!qe.glyphObj.isWhitespace&&(Me.width=qe.x+qe.width,Me.width>ve&&(ve=Me.width),Ge=!1);let{lineHeight:rt,capHeight:gt,xHeight:nt,baseline:Xe}=qe.fontData;rt>Me.lineHeight&&(Me.lineHeight=rt);const je=Xe-Me.baseline;je<0&&(Me.baseline+=je,Me.cap+=je,Me.ex+=je),Me.cap=Math.max(Me.cap,Me.baseline+gt),Me.ex=Math.max(Me.ex,Me.baseline+nt)}Me.baseline-=_e,Me.cap-=_e,Me.ex-=_e,_e+=Me.lineHeight});let Be=0,Se=0;if(B&&(typeof B=="number"?Be=-B:typeof B=="string"&&(Be=-ve*(B==="left"?0:B==="center"?.5:B==="right"?1:c(B)))),M&&(typeof M=="number"?Se=-M:typeof M=="string"&&(Se=M==="top"?0:M==="top-baseline"?-Ie[0].baseline:M==="top-cap"?-Ie[0].cap:M==="top-ex"?-Ie[0].ex:M==="middle"?_e/2:M==="bottom"?_e:M==="bottom-baseline"?-Ie[Ie.length-1].baseline:c(M)*_e)),!O){const Me=e.getEmbeddingLevels(m,S);G=new Uint16Array(re),F=new Uint8Array(re),k=new Float32Array(re*2),Z={},te=[1/0,1/0,-1/0,-1/0],ye=[],W&&(X=new Float32Array(m.length*4)),K&&(ne=new Uint8Array(re*3));let Ge=0,Qe=-1,qe=-1,rt,gt;if(Ie.forEach((nt,Xe)=>{let{count:je,width:ie}=nt;if(je>0){let be=0;for(let Dt=je;Dt--&&nt.glyphAt(Dt).glyphObj.isWhitespace;)be++;let Le=0,Ye=0;if(b==="center")Le=(ve-ie)/2;else if(b==="right")Le=ve-ie;else if(b==="justify"&&nt.isSoftWrapped){let Dt=0;for(let yt=je-be;yt--;)nt.glyphAt(yt).glyphObj.isWhitespace&&Dt++;Ye=(ve-ie)/Dt}if(Ye||Le){let Dt=0;for(let yt=0;yt<je;yt++){let wt=nt.glyphAt(yt);const Tt=wt.glyphObj;wt.x+=Le+Dt,Ye!==0&&Tt.isWhitespace&&yt<je-be&&(Dt+=Ye,wt.width+=Ye)}}const pe=e.getReorderSegments(m,Me,nt.glyphAt(0).charIndex,nt.glyphAt(nt.count-1).charIndex);for(let Dt=0;Dt<pe.length;Dt++){const[yt,wt]=pe[Dt];let Tt=1/0,lt=-1/0;for(let Bt=0;Bt<je;Bt++)if(nt.glyphAt(Bt).charIndex>=yt){let fi=Bt,di=Bt;for(;di<je;di++){let _i=nt.glyphAt(di);if(_i.charIndex>wt)break;di<je-be&&(Tt=Math.min(Tt,_i.x),lt=Math.max(lt,_i.x+_i.width))}for(let _i=fi;_i<di;_i++){const Tn=nt.glyphAt(_i);Tn.x=lt-(Tn.x+Tn.width-Tt)}break}}let at;const ti=Dt=>at=Dt;for(let Dt=0;Dt<je;Dt++){const yt=nt.glyphAt(Dt);at=yt.glyphObj;const wt=at.index,Tt=Me.levels[yt.charIndex]&1;if(Tt){const lt=e.getMirroredCharacter(m[yt.charIndex]);lt&&yt.fontData.fontObj.forEachGlyph(lt,0,0,ti)}if(W){const{charIndex:lt,fontData:Bt}=yt,fi=yt.x+Be,di=yt.x+yt.width+Be;X[lt*4]=Tt?di:fi,X[lt*4+1]=Tt?fi:di,X[lt*4+2]=nt.baseline+Bt.caretBottom+Se,X[lt*4+3]=nt.baseline+Bt.caretTop+Se;const _i=lt-Qe;_i>1&&u(X,Qe,_i),Qe=lt}if(K){const{charIndex:lt}=yt;for(;lt>qe;)qe++,K.hasOwnProperty(qe)&&(gt=K[qe])}if(!at.isWhitespace&&!at.isEmpty){const lt=Ge++,{fontSizeMult:Bt,src:fi,index:di}=yt.fontData,_i=Z[fi]||(Z[fi]={});_i[wt]||(_i[wt]={path:at.path,pathBounds:[at.xMin,at.yMin,at.xMax,at.yMax]});const Tn=yt.x+Be,bn=yt.y+nt.baseline+Se;k[lt*2]=Tn,k[lt*2+1]=bn;const ls=Tn+at.xMin*Bt,dn=bn+at.yMin*Bt,wn=Tn+at.xMax*Bt,ft=bn+at.yMax*Bt;ls<te[0]&&(te[0]=ls),dn<te[1]&&(te[1]=dn),wn>te[2]&&(te[2]=wn),ft>te[3]&&(te[3]=ft),lt%N===0&&(rt={start:lt,end:lt,rect:[1/0,1/0,-1/0,-1/0]},ye.push(rt)),rt.end++;const Hi=rt.rect;if(ls<Hi[0]&&(Hi[0]=ls),dn<Hi[1]&&(Hi[1]=dn),wn>Hi[2]&&(Hi[2]=wn),ft>Hi[3]&&(Hi[3]=ft),G[lt]=wt,F[lt]=di,K){const Js=lt*3;ne[Js]=gt>>16&255,ne[Js+1]=gt>>8&255,ne[Js+2]=gt&255}}}}}),X){const nt=m.length-Qe;nt>1&&u(X,Qe,nt)}}const Ke=[];he.forEach(({index:Me,src:Ge,unitsPerEm:Qe,ascender:qe,descender:rt,lineHeight:gt,capHeight:nt,xHeight:Xe})=>{Ke[Me]={src:Ge,unitsPerEm:Qe,ascender:qe,descender:rt,lineHeight:gt,capHeight:nt,xHeight:Xe}}),$.typesetting=h()-le,D({glyphIds:G,glyphFontIndices:F,glyphPositions:k,glyphData:Z,fontData:Ke,caretPositions:X,glyphColors:ne,chunkedBounds:ye,fontSize:v,topBaseline:Se+Ie[0].baseline,blockBounds:[Be,Se-_e,Be+ve,Se],visibleBounds:te,timings:$})})}function l(m,A){a({...m,metricsOnly:!0},p=>{const[y,v,E,x]=p.blockBounds;A({width:E-y,height:x-v})})}function c(m){let A=m.match(/^([\d.]+)%$/),p=A?parseFloat(A[1]):NaN;return isNaN(p)?0:p/100}function u(m,A,p){const y=m[A*4],v=m[A*4+1],E=m[A*4+2],x=m[A*4+3],I=(v-y)/p;for(let C=0;C<p;C++){const _=(A+C)*4;m[_]=y+I*C,m[_+1]=y+I*(C+1),m[_+2]=E,m[_+3]=x}}function h(){return(self.performance||Date).now()}function f(){this.data=[]}const d=["glyphObj","x","y","width","charIndex","fontData"];return f.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/d.length)},glyphAt(m){let A=f.flyweight;return A.data=this.data,A.index=m,A},splitAt(m){let A=new f;return A.data=this.data.splice(m*d.length),A}},f.flyweight=d.reduce((m,A,p,y)=>(Object.defineProperty(m,A,{get(){return this.data[this.index*d.length+p]},set(v){this.data[this.index*d.length+p]=v}}),m),{data:null,index:0}),{typeset:a,measure:l}}const mo=()=>(self.performance||Date).now(),ff=vx();let V1;function oB(r,e,t,i,n,s,o,a,l,c,u=!0){return u?lB(r,e,t,i,n,s,o,a,l,c).then(null,h=>(V1||(console.warn("WebGL SDF generation failed, falling back to JS",h),V1=!0),$1(r,e,t,i,n,s,o,a,l,c))):$1(r,e,t,i,n,s,o,a,l,c)}const oh=[],aB=5;let xm=0;function xx(){const r=mo();for(;oh.length&&mo()-r<aB;)oh.shift()();xm=oh.length?setTimeout(xx,0):0}const lB=(...r)=>new Promise((e,t)=>{oh.push(()=>{const i=mo();try{ff.webgl.generateIntoCanvas(...r),e({timing:mo()-i})}catch(n){t(n)}}),xm||(xm=setTimeout(xx,0))}),cB=4,uB=2e3,K1={};let hB=0;function $1(r,e,t,i,n,s,o,a,l,c){const u="TroikaTextSDFGenerator_JS_"+hB++%cB;let h=K1[u];return h||(h=K1[u]={workerModule:Ga({name:u,workerId:u,dependencies:[vx,mo],init(f,d){const m=f().javascript.generate;return function(...A){const p=d();return{textureData:m(...A),timing:d()-p}}},getTransferables(f){return[f.textureData.buffer]}}),requests:0,idleTimer:null}),h.requests++,clearTimeout(h.idleTimer),h.workerModule(r,e,t,i,n,s).then(({textureData:f,timing:d})=>{const m=mo(),A=new Uint8Array(f.length*4);for(let p=0;p<f.length;p++)A[p*4+c]=f[p];return ff.webglUtils.renderImageData(o,A,a,l,r,e,1<<3-c),d+=mo()-m,--h.requests===0&&(h.idleTimer=setTimeout(()=>{z8(u)},uB)),{timing:d}})}function fB(r){r._warm||(ff.webgl.isSupported(r),r._warm=!0)}const dB=ff.webglUtils.resizeWebGLCanvasWithoutClearing,Ql={unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},mB=new We;function Po(){return(self.performance||Date).now()}const Y1=Object.create(null);function Ix(r,e){r=gB({},r);const t=Po(),i=[];if(r.font&&i.push({label:"user",src:yB(r.font)}),r.font=i,r.text=""+r.text,r.sdfGlyphSize=r.sdfGlyphSize||Ql.sdfGlyphSize,r.unicodeFontsURL=r.unicodeFontsURL||Ql.unicodeFontsURL,r.colorRanges!=null){let f={};for(let d in r.colorRanges)if(r.colorRanges.hasOwnProperty(d)){let m=r.colorRanges[d];typeof m!="number"&&(m=mB.set(m).getHex()),f[d]=m}r.colorRanges=f}Object.freeze(r);const{textureWidth:n,sdfExponent:s}=Ql,{sdfGlyphSize:o}=r,a=n/o*4;let l=Y1[o];if(!l){const f=document.createElement("canvas");f.width=n,f.height=o*256/a,l=Y1[o]={glyphCount:0,sdfGlyphSize:o,sdfCanvas:f,sdfTexture:new tn(f,void 0,void 0,void 0,Nt,Nt),contextLost:!1,glyphsByFont:new Map},l.sdfTexture.generateMipmaps=!1,AB(l)}const{sdfTexture:c,sdfCanvas:u}=l;Sx(r).then(f=>{const{glyphIds:d,glyphFontIndices:m,fontData:A,glyphPositions:p,fontSize:y,timings:v}=f,E=[],x=new Float32Array(d.length*4);let I=0,C=0;const _=Po(),S=A.map(B=>{let M=l.glyphsByFont.get(B.src);return M||l.glyphsByFont.set(B.src,M=new Map),M});d.forEach((B,M)=>{const O=m[M],{src:U,unitsPerEm:Y}=A[O];let W=S[O].get(B);if(!W){const{path:$,pathBounds:V}=f.glyphData[U][B],P=Math.max(V[2]-V[0],V[3]-V[1])/o*(Ql.sdfMargin*o+.5),G=l.glyphCount++,F=[V[0]-P,V[1]-P,V[2]+P,V[3]+P];S[O].set(B,W={path:$,atlasIndex:G,sdfViewBox:F}),E.push(W)}const{sdfViewBox:N}=W,K=p[C++],D=p[C++],z=y/Y;x[I++]=K+N[0]*z,x[I++]=D+N[1]*z,x[I++]=K+N[2]*z,x[I++]=D+N[3]*z,d[M]=W.atlasIndex}),v.quads=(v.quads||0)+(Po()-_);const b=Po();v.sdf={};const T=u.height,R=Math.ceil(l.glyphCount/a),w=Math.pow(2,Math.ceil(Math.log2(R*o)));w>T&&(console.info(`Increasing SDF texture size ${T}->${w}`),dB(u,n,w),c.dispose()),Promise.all(E.map(B=>Cx(B,l,r.gpuAccelerateSDF).then(({timing:M})=>{v.sdf[B.atlasIndex]=M}))).then(()=>{E.length&&!l.contextLost&&(_x(l),c.needsUpdate=!0),v.sdfTotal=Po()-b,v.total=Po()-t,e(Object.freeze({parameters:r,sdfTexture:c,sdfGlyphSize:o,sdfExponent:s,glyphBounds:x,glyphAtlasIndices:d,glyphColors:f.glyphColors,caretPositions:f.caretPositions,chunkedBounds:f.chunkedBounds,ascender:f.ascender,descender:f.descender,lineHeight:f.lineHeight,capHeight:f.capHeight,xHeight:f.xHeight,topBaseline:f.topBaseline,blockBounds:f.blockBounds,visibleBounds:f.visibleBounds,timings:f.timings}))})}),Promise.resolve().then(()=>{l.contextLost||fB(u)})}function Cx({path:r,atlasIndex:e,sdfViewBox:t},{sdfGlyphSize:i,sdfCanvas:n,contextLost:s},o){if(s)return Promise.resolve({timing:-1});const{textureWidth:a,sdfExponent:l}=Ql,c=Math.max(t[2]-t[0],t[3]-t[1]),u=Math.floor(e/4),h=u%(a/i)*i,f=Math.floor(u/(a/i))*i,d=e%4;return oB(i,i,r,t,c,l,n,h,f,d,o)}function AB(r){const e=r.sdfCanvas;e.addEventListener("webglcontextlost",t=>{console.log("Context Lost",t),t.preventDefault(),r.contextLost=!0}),e.addEventListener("webglcontextrestored",t=>{console.log("Context Restored",t),r.contextLost=!1;const i=[];r.glyphsByFont.forEach(n=>{n.forEach(s=>{i.push(Cx(s,r,!0))})}),Promise.all(i).then(()=>{_x(r),r.sdfTexture.needsUpdate=!0})})}function pB({font:r,characters:e,sdfGlyphSize:t},i){let n=Array.isArray(e)?e.join(`
`):""+e;Ix({font:r,sdfGlyphSize:t,text:n},i)}function gB(r,e){for(let t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}let su;function yB(r){return su||(su=typeof document>"u"?{}:document.createElement("a")),su.href=r,su.href}function _x(r){if(typeof createImageBitmap!="function"){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:e,sdfTexture:t}=r,{width:i,height:n}=e,s=r.sdfCanvas.getContext("webgl");let o=t.image.data;(!o||o.length!==i*n*4)&&(o=new Uint8Array(i*n*4),t.image={width:i,height:n,data:o},t.flipY=!1,t.isDataTexture=!0),s.readPixels(0,0,i,n,s.RGBA,s.UNSIGNED_BYTE,o)}}const vB=Ga({name:"Typesetter",dependencies:[rB,sB,V8],init(r,e,t){return r(e,t())}}),Sx=Ga({name:"Typesetter",dependencies:[vB],init(r){return function(e){return new Promise(t=>{r.typeset(e,t)})}},getTransferables(r){const e=[];for(let t in r)r[t]&&r[t].buffer&&e.push(r[t].buffer);return e}});Sx.onMainThread;const W1={};function EB(r){let e=W1[r];return e||(e=W1[r]=new ln(1,1,r,r).translate(.5,.5,0)),e}const xB="aTroikaGlyphBounds",j1="aTroikaGlyphIndex",IB="aTroikaGlyphColor";class CB extends sA{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new hn,this.boundingBox=new Jt}computeBoundingSphere(){}computeBoundingBox(){}set detail(e){if(e!==this._detail){this._detail=e,(typeof e!="number"||e<1)&&(e=1);let t=EB(e);["position","normal","uv"].forEach(i=>{this.attributes[i]=t.attributes[i].clone()}),this.setIndex(t.getIndex().clone())}}get detail(){return this._detail}set curveRadius(e){e!==this._curveRadius&&(this._curveRadius=e,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(e,t,i,n,s){this.updateAttributeData(xB,e,4),this.updateAttributeData(j1,t,1),this.updateAttributeData(IB,s,3),this._blockBounds=i,this._chunkedBounds=n,this.instanceCount=t.length,this._updateBounds()}_updateBounds(){const e=this._blockBounds;if(e){const{curveRadius:t,boundingBox:i}=this;if(t){const{PI:n,floor:s,min:o,max:a,sin:l,cos:c}=Math,u=n/2,h=n*2,f=Math.abs(t),d=e[0]/f,m=e[2]/f,A=s((d+u)/h)!==s((m+u)/h)?-f:o(l(d)*f,l(m)*f),p=s((d-u)/h)!==s((m-u)/h)?f:a(l(d)*f,l(m)*f),y=s((d+n)/h)!==s((m+n)/h)?f*2:a(f-c(d)*f,f-c(m)*f);i.min.set(A,e[1],t<0?-y:0),i.max.set(p,e[3],t<0?0:y)}else i.min.set(e[0],e[1],0),i.max.set(e[2],e[3],0);i.getBoundingSphere(this.boundingSphere)}}applyClipRect(e){let t=this.getAttribute(j1).count,i=this._chunkedBounds;if(i)for(let n=i.length;n--;){t=i[n].end;let s=i[n].rect;if(s[1]<e.w&&s[3]>e.y&&s[0]<e.z&&s[2]>e.x)break}this.instanceCount=t}updateAttributeData(e,t,i){const n=this.getAttribute(e);t?n&&n.array.length===t.length?(n.array.set(t),n.needsUpdate=!0):(this.setAttribute(e,new oc(t,i)),delete this._maxInstanceCount,this.dispose()):n&&this.deleteAttribute(e)}}const _B=`
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform vec4 uTroikaTotalBounds;
uniform vec4 uTroikaClipRect;
uniform mat3 uTroikaOrient;
uniform bool uTroikaUseGlyphColors;
uniform float uTroikaEdgeOffset;
uniform float uTroikaBlurRadius;
uniform vec2 uTroikaPositionOffset;
uniform float uTroikaCurveRadius;
attribute vec4 aTroikaGlyphBounds;
attribute float aTroikaGlyphIndex;
attribute vec3 aTroikaGlyphColor;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec3 vTroikaGlyphColor;
varying vec2 vTroikaGlyphDimensions;
`,SB=`
vec4 bounds = aTroikaGlyphBounds;
bounds.xz += uTroikaPositionOffset.x;
bounds.yw -= uTroikaPositionOffset.y;

vec4 outlineBounds = vec4(
  bounds.xy - uTroikaEdgeOffset - uTroikaBlurRadius,
  bounds.zw + uTroikaEdgeOffset + uTroikaBlurRadius
);
vec4 clippedBounds = vec4(
  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),
  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)
);

vec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);

position.xy = mix(bounds.xy, bounds.zw, clippedXY);

uv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);

float rad = uTroikaCurveRadius;
if (rad != 0.0) {
  float angle = position.x / rad;
  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);
  normal.xz = vec2(sin(angle), cos(angle));
}
  
position = uTroikaOrient * position;
normal = uTroikaOrient * normal;

vTroikaGlyphUV = clippedXY.xy;
vTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);


float txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;
vec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;
vec2 txStartUV = txUvPerSquare * vec2(
  mod(floor(aTroikaGlyphIndex / 4.0), txCols),
  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)
);
vTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);
vTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);
`,TB=`
uniform sampler2D uTroikaSDFTexture;
uniform vec2 uTroikaSDFTextureSize;
uniform float uTroikaSDFGlyphSize;
uniform float uTroikaSDFExponent;
uniform float uTroikaEdgeOffset;
uniform float uTroikaFillOpacity;
uniform float uTroikaBlurRadius;
uniform vec3 uTroikaStrokeColor;
uniform float uTroikaStrokeWidth;
uniform float uTroikaStrokeOpacity;
uniform bool uTroikaSDFDebug;
varying vec2 vTroikaGlyphUV;
varying vec4 vTroikaTextureUVBounds;
varying float vTroikaTextureChannel;
varying vec2 vTroikaGlyphDimensions;

float troikaSdfValueToSignedDistance(float alpha) {
  // Inverse of exponential encoding in webgl-sdf-generator
  
  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);
  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;
  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);
  return signedDist;
}

float troikaGlyphUvToSdfValue(vec2 glyphUV) {
  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);
  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);
  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1
  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;
}

float troikaGlyphUvToDistance(vec2 uv) {
  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));
}

float troikaGetAADist() {
  
  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300
  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;
  #else
  return vTroikaGlyphDimensions.x / 64.0;
  #endif
}

float troikaGetFragDistValue() {
  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);
  float distance = troikaGlyphUvToDistance(clampedGlyphUV);
 
  // Extrapolate distance when outside bounds:
  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : 
    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);

  

  return distance;
}

float troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {
  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)
  float alpha = step(-distanceOffset, -distance);
  #else

  float alpha = smoothstep(
    distanceOffset + aaDist,
    distanceOffset - aaDist,
    distance
  );
  #endif

  return alpha;
}
`,bB=`
float aaDist = troikaGetAADist();
float fragDistance = troikaGetFragDistValue();
float edgeAlpha = uTroikaSDFDebug ?
  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :
  troikaGetEdgeAlpha(fragDistance, uTroikaEdgeOffset, max(aaDist, uTroikaBlurRadius));

#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)
vec4 fillRGBA = gl_FragColor;
fillRGBA.a *= uTroikaFillOpacity;
vec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);
if (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;
gl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(
  -uTroikaStrokeWidth - aaDist,
  -uTroikaStrokeWidth + aaDist,
  fragDistance
));
gl_FragColor.a *= edgeAlpha;
#endif

if (edgeAlpha == 0.0) {
  discard;
}
`;function wB(r){const e=Em(r,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new De},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new yi(0,0,0,0)},uTroikaClipRect:{value:new yi(0,0,0,0)},uTroikaEdgeOffset:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new De},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new We},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new Fn},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:_B,vertexTransform:SB,fragmentDefs:TB,fragmentColorTransform:bB,customRewriter({vertexShader:t,fragmentShader:i}){let n=/\buniform\s+vec3\s+diffuse\b/;return n.test(i)&&(i=i.replace(n,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),n.test(t)||(t=t.replace(Ex,`uniform vec3 diffuse;
$&
vTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;
`))),{vertexShader:t,fragmentShader:i}}});return e.transparent=!0,e.forceSinglePass=!0,Object.defineProperties(e,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),e}const LA=new Cs({color:16777215,side:bi,transparent:!0}),q1=8421504,X1=new we,ru=new Q,xd=new Q,yl=[],BB=new Q,Id="+x+y";function J1(r){return Array.isArray(r)?r[0]:r}let Tx=()=>{const r=new ze(new ln(1,1),LA);return Tx=()=>r,r},bx=()=>{const r=new ze(new ln(1,1,32,1),LA);return bx=()=>r,r};const RB={type:"syncstart"},DB={type:"synccomplete"},wx=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],MB=wx.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");let Bx=class extends ze{constructor(){const e=new CB;super(e,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=q1,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=Id,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(e){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(e):(this._isSyncing=!0,this.dispatchEvent(RB),Ix({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},t=>{this._isSyncing=!1,this._textRenderInfo=t,this.geometry.updateGlyphs(t.glyphBounds,t.glyphAtlasIndices,t.blockBounds,t.chunkedBounds,t.glyphColors);const i=this._queuedSyncs;i&&(this._queuedSyncs=null,this._needsSync=!0,this.sync(()=>{i.forEach(n=>n&&n())})),this.dispatchEvent(DB),e&&e()})))}onBeforeRender(e,t,i,n,s,o){this.sync(),s.isTroikaTextMaterial&&this._prepareForRender(s)}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}createDerivedMaterial(e){return wB(e)}get material(){let e=this._derivedMaterial;const t=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=LA.clone());if((!e||!e.isDerivedFrom(t))&&(e=this._derivedMaterial=this.createDerivedMaterial(t),t.addEventListener("dispose",function i(){t.removeEventListener("dispose",i),e.dispose()})),this.hasOutline()){let i=e._outlineMtl;return i||(i=e._outlineMtl=Object.create(e,{id:{value:e.id+.1}}),i.isTextOutlineMaterial=!0,i.depthWrite=!1,i.map=null,e.addEventListener("dispose",function n(){e.removeEventListener("dispose",n),i.dispose()})),[i,e]}else return e}set material(e){e&&e.isTroikaTextMaterial?(this._derivedMaterial=e,this._baseMaterial=e.baseMaterial):this._baseMaterial=e}hasOutline(){return!!(this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY)}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(e){this.geometry.detail=e}get curveRadius(){return this.geometry.curveRadius}set curveRadius(e){this.geometry.curveRadius=e}get customDepthMaterial(){return J1(this.material).getDepthMaterial()}set customDepthMaterial(e){}get customDistanceMaterial(){return J1(this.material).getDistanceMaterial()}set customDistanceMaterial(e){}_prepareForRender(e){const t=e.isTextOutlineMaterial,i=e.uniforms,n=this.textRenderInfo;if(n){const{sdfTexture:a,blockBounds:l}=n;i.uTroikaSDFTexture.value=a,i.uTroikaSDFTextureSize.value.set(a.image.width,a.image.height),i.uTroikaSDFGlyphSize.value=n.sdfGlyphSize,i.uTroikaSDFExponent.value=n.sdfExponent,i.uTroikaTotalBounds.value.fromArray(l),i.uTroikaUseGlyphColors.value=!t&&!!n.glyphColors;let c=0,u=0,h=0,f,d,m,A=0,p=0;if(t){let{outlineWidth:v,outlineOffsetX:E,outlineOffsetY:x,outlineBlur:I,outlineOpacity:C}=this;c=this._parsePercent(v)||0,u=Math.max(0,this._parsePercent(I)||0),f=C,A=this._parsePercent(E)||0,p=this._parsePercent(x)||0}else h=Math.max(0,this._parsePercent(this.strokeWidth)||0),h&&(m=this.strokeColor,i.uTroikaStrokeColor.value.set(m??q1),d=this.strokeOpacity,d==null&&(d=1)),f=this.fillOpacity;i.uTroikaEdgeOffset.value=c,i.uTroikaPositionOffset.value.set(A,p),i.uTroikaBlurRadius.value=u,i.uTroikaStrokeWidth.value=h,i.uTroikaStrokeOpacity.value=d,i.uTroikaFillOpacity.value=f??1,i.uTroikaCurveRadius.value=this.curveRadius||0;let y=this.clipRect;if(y&&Array.isArray(y)&&y.length===4)i.uTroikaClipRect.value.fromArray(y);else{const v=(this.fontSize||.1)*100;i.uTroikaClipRect.value.set(l[0]-v,l[1]-v,l[2]+v,l[3]+v)}this.geometry.applyClipRect(i.uTroikaClipRect.value)}i.uTroikaSDFDebug.value=!!this.debugSDF,e.polygonOffset=!!this.depthOffset,e.polygonOffsetFactor=e.polygonOffsetUnits=this.depthOffset||0;const s=t?this.outlineColor||0:this.color;if(s==null)delete e.color;else{const a=e.hasOwnProperty("color")?e.color:e.color=new We;(s!==a._input||typeof s=="object")&&a.set(a._input=s)}let o=this.orientation||Id;if(o!==e._orientation){let a=i.uTroikaOrient.value;o=o.replace(/[^-+xyz]/g,"");let l=o!==Id&&o.match(/^([-+])([xyz])([-+])([xyz])$/);if(l){let[,c,u,h,f]=l;ru.set(0,0,0)[u]=c==="-"?1:-1,xd.set(0,0,0)[f]=h==="-"?-1:1,X1.lookAt(BB,ru.cross(xd),xd),a.setFromMatrix4(X1)}else a.identity();e._orientation=o}}_parsePercent(e){if(typeof e=="string"){let t=e.match(/^(-?[\d.]+)%$/),i=t?parseFloat(t[1]):NaN;e=(isNaN(i)?0:i/100)*this.fontSize}return e}localPositionToTextCoords(e,t=new De){t.copy(e);const i=this.curveRadius;return i&&(t.x=Math.atan2(e.x,Math.abs(i)-Math.abs(e.z))*Math.abs(i)),t}worldPositionToTextCoords(e,t=new De){return ru.copy(e),this.localPositionToTextCoords(this.worldToLocal(ru),t)}raycast(e,t){const{textRenderInfo:i,curveRadius:n}=this;if(i){const s=i.blockBounds,o=n?bx():Tx(),a=o.geometry,{position:l,uv:c}=a.attributes;for(let u=0;u<c.count;u++){let h=s[0]+c.getX(u)*(s[2]-s[0]);const f=s[1]+c.getY(u)*(s[3]-s[1]);let d=0;n&&(d=n-Math.cos(h/n)*n,h=Math.sin(h/n)*n),l.setXYZ(u,h,f,d)}a.boundingSphere=this.geometry.boundingSphere,a.boundingBox=this.geometry.boundingBox,o.matrixWorld=this.matrixWorld,o.material.side=this.material.side,yl.length=0,o.raycast(e,yl);for(let u=0;u<yl.length;u++)yl[u].object=this,t.push(yl[u])}}copy(e){const t=this.geometry;return super.copy(e),this.geometry=t,MB.forEach(i=>{this[i]=e[i]}),this}clone(){return new this.constructor().copy(this)}};wx.forEach(r=>{const e="_private_"+r;Object.defineProperty(Bx.prototype,r,{get(){return this[e]},set(t){t!==this[e]&&(this[e]=t,this._needsSync=!0)}})});new Jt;new We;const ZO=g.forwardRef(({sdfGlyphSize:r=64,anchorX:e="center",anchorY:t="middle",font:i,fontSize:n=1,children:s,characters:o,onSync:a,...l},c)=>{const u=ae(({invalidate:m})=>m),[h]=g.useState(()=>new Bx),[f,d]=g.useMemo(()=>{const m=[];let A="";return g.Children.forEach(s,p=>{typeof p=="string"||typeof p=="number"?A+=p:m.push(p)}),[m,A]},[s]);return Er(()=>new Promise(m=>pB({font:i,characters:o},m)),["troika-text",i,o]),g.useLayoutEffect(()=>void h.sync(()=>{u(),a&&a(h)})),g.useEffect(()=>()=>h.dispose(),[h]),g.createElement("primitive",Ae({object:h,ref:c,font:i,text:d,anchorX:e,anchorY:t,fontSize:n,sdfGlyphSize:r},l),f)});let Cd=null;async function LB(r){return typeof r=="string"?await(await fetch(r)).json():r}function PB(r){return Cd||(Cd=new Ww),Cd.parse(r)}async function Rx(r){const e=await LB(r);return PB(e)}function PA(r){return Er(Rx,[r])}PA.preload=r=>T_(Rx,[r]);PA.clear=r=>Jh([r]);const FB=["string","number"],kB=r=>{let e="";const t=[];return g.Children.forEach(r,i=>{FB.includes(typeof i)?e+=i+"":t.push(i)}),[e,...t]},OB=g.forwardRef(({font:r,letterSpacing:e=0,lineHeight:t=1,size:i=1,height:n=.2,bevelThickness:s=.1,bevelSize:o=.01,bevelEnabled:a=!1,bevelOffset:l=0,bevelSegments:c=4,curveSegments:u=8,smooth:h,children:f,...d},m)=>{g.useMemo(()=>Ci({RenamedTextGeometry:Iw}),[]);const A=g.useRef(null),p=PA(r),y=g.useMemo(()=>({font:p,size:i,height:n,bevelThickness:s,bevelSize:o,bevelEnabled:a,bevelSegments:c,bevelOffset:l,curveSegments:u,letterSpacing:e,lineHeight:t}),[p,i,n,s,o,a,c,l,u,e,t]),[v,...E]=g.useMemo(()=>kB(f),[f]),x=g.useMemo(()=>[v,y],[v,y]);return g.useLayoutEffect(()=>{h&&(A.current.geometry=Eb(A.current.geometry,h),A.current.geometry.computeVertexNormals())},[x,h]),g.useImperativeHandle(m,()=>A.current,[]),g.createElement("mesh",Ae({},d,{ref:A}),g.createElement("renamedTextGeometry",{args:x}),E)}),eU=()=>{try{var r=document.createElement("canvas");return!!(window.WebGL2RenderingContext&&r.getContext("webgl2"))}catch{return!1}},tU=g.forwardRef(({children:r,multisamping:e=8,renderIndex:t=1,disableRender:i,disableGamma:n,disableRenderPass:s,depthBuffer:o=!0,stencilBuffer:a=!1,anisotropy:l=1,encoding:c,type:u,...h},f)=>{g.useMemo(()=>Ci({EffectComposer:k6,RenderPass:N6,ShaderPass:dm}),[]);const d=g.useRef(null);g.useImperativeHandle(f,()=>d.current,[]);const{scene:m,camera:A,gl:p,size:y,viewport:v}=ae(),[E]=g.useState(()=>{const I=new xi(y.width,y.height,{type:u||ui,format:Di,depthBuffer:o,stencilBuffer:a,anisotropy:l});return u===$i&&c!=null&&("colorSpace"in I?I.texture.colorSpace=c:I.texture.encoding=c),I.samples=e,I});g.useEffect(()=>{var I,C;(I=d.current)==null||I.setSize(y.width,y.height),(C=d.current)==null||C.setPixelRatio(v.dpr)},[p,y,v.dpr]),Ve(()=>{var I;i||(I=d.current)==null||I.render()},t);const x=[];return s||x.push(g.createElement("renderPass",{key:"renderpass",attach:`passes-${x.length}`,args:[m,A]})),n||x.push(g.createElement("shaderPass",{attach:`passes-${x.length}`,key:"gammapass",args:[Cw]})),g.Children.forEach(r,I=>{I&&x.push(g.cloneElement(I,{key:x.length,attach:`passes-${x.length}`}))}),g.createElement("effectComposer",Ae({ref:d,args:[p,E]},h),x)});let Z1=(function(r){return r.Linear="linear",r.Radial="radial",r})({});function iU({stops:r,colors:e,size:t=1024,width:i=16,type:n=Z1.Linear,innerCircleRadius:s=0,outerCircleRadius:o="auto",...a}){const l=ae(u=>u.gl),c=g.useMemo(()=>{const u=document.createElement("canvas"),h=u.getContext("2d");u.width=i,u.height=t;let f;if(n===Z1.Linear)f=h.createLinearGradient(0,0,0,t);else{const A=u.width/2,p=u.height/2,y=o!=="auto"?Math.abs(Number(o)):Math.sqrt(A**2+p**2);f=h.createRadialGradient(A,p,Math.abs(s),A,p,y)}const d=new We;let m=r.length;for(;m--;)f.addColorStop(r[m],d.set(e[m]).getStyle());return h.save(),h.fillStyle=f,h.fillRect(0,0,i,t),h.restore(),u},[r]);return g.createElement("canvasTexture",Ae({colorSpace:l.outputColorSpace,args:[c],attach:"map"},a))}function ws(r,e,t,i){const n=class extends Ii{constructor(o={}){const a=Object.entries(r);super({uniforms:a.reduce((l,[c,u])=>{const h=Ba.clone({[c]:{value:u}});return{...l,...h}},{}),vertexShader:e,fragmentShader:t}),this.key="",a.forEach(([l])=>Object.defineProperty(this,l,{get:()=>this.uniforms[l].value,set:c=>this.uniforms[l].value=c})),Object.assign(this,o),i&&i(this)}};return n.key=tt.generateUUID(),n}const Zl=r=>r===Object(r)&&!Array.isArray(r)&&typeof r!="function";function Io(r,e){const t=ae(s=>s.gl),i=hi(pr,Zl(r)?Object.values(r):r);return g.useLayoutEffect(()=>{e?.(i)},[e]),g.useEffect(()=>{if("initTexture"in t){let s=[];Array.isArray(i)?s=i:i instanceof tn?s=[i]:Zl(i)&&(s=Object.values(i)),s.forEach(o=>{o instanceof tn&&t.initTexture(o)})}},[t,i]),g.useMemo(()=>{if(Zl(r)){const s={};let o=0;for(const a in r)s[a]=i[o++];return s}else return i},[r,i])}Io.preload=r=>hi.preload(pr,r);Io.clear=r=>hi.clear(pr,r);const sU=({children:r,input:e,onLoad:t})=>{const i=Io(e,t);return g.createElement(g.Fragment,null,r?.(i))},UB=()=>parseInt(Kh.replace(/\D+/g,"")),sn=UB(),ey=ws({color:new We("white"),scale:new De(1,1),imageBounds:new De(1,1),resolution:1024,map:null,zoom:1,radius:0,grayscale:0,opacity:1},`
  varying vec2 vUv;
  varying vec2 vPos;
  void main() {
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
    vUv = uv;
    vPos = position.xy;
  }
`,`
  // mostly from https://gist.github.com/statico/df64c5d167362ecf7b34fca0b1459a44
  varying vec2 vUv;
  varying vec2 vPos;
  uniform vec2 scale;
  uniform vec2 imageBounds;
  uniform float resolution;
  uniform vec3 color;
  uniform sampler2D map;
  uniform float radius;
  uniform float zoom;
  uniform float grayscale;
  uniform float opacity;
  const vec3 luma = vec3(.299, 0.587, 0.114);
  vec4 toGrayscale(vec4 color, float intensity) {
    return vec4(mix(color.rgb, vec3(dot(color.rgb, luma)), intensity), color.a);
  }
  vec2 aspect(vec2 size) {
    return size / min(size.x, size.y);
  }
  
  const float PI = 3.14159265;
    
  // from https://iquilezles.org/articles/distfunctions
  float udRoundBox( vec2 p, vec2 b, float r ) {
    return length(max(abs(p)-b+r,0.0))-r;
  }

  void main() {
    vec2 s = aspect(scale);
    vec2 i = aspect(imageBounds);
    float rs = s.x / s.y;
    float ri = i.x / i.y;
    vec2 new = rs < ri ? vec2(i.x * s.y / i.y, s.y) : vec2(s.x, i.y * s.x / i.x);
    vec2 offset = (rs < ri ? vec2((new.x - s.x) / 2.0, 0.0) : vec2(0.0, (new.y - s.y) / 2.0)) / new;
    vec2 uv = vUv * s / new + offset;
    vec2 zUv = (uv - vec2(0.5, 0.5)) / zoom + vec2(0.5, 0.5);

    vec2 res = vec2(scale * resolution);
    vec2 halfRes = 0.5 * res;
    float b = udRoundBox(vUv.xy * res - halfRes, halfRes, resolution * radius);    
	  vec3 a = mix(vec3(1.0,0.0,0.0), vec3(0.0,0.0,0.0), smoothstep(0.0, 1.0, b));
    gl_FragColor = toGrayscale(texture2D(map, zUv) * vec4(color, opacity * a), grayscale);
    
    #include <tonemapping_fragment>
    #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
  }
`),Dx=g.forwardRef(({children:r,color:e,segments:t=1,scale:i=1,zoom:n=1,grayscale:s=0,opacity:o=1,radius:a=0,texture:l,toneMapped:c,transparent:u,side:h,...f},d)=>{Ci({ImageMaterial:ey});const m=g.useRef(null),A=ae(E=>E.size),p=Array.isArray(i)?[i[0],i[1]]:[i,i],y=[l.image.width,l.image.height],v=Math.max(A.width,A.height);return g.useImperativeHandle(d,()=>m.current,[]),g.useLayoutEffect(()=>{m.current.geometry.parameters&&m.current.material.scale.set(p[0]*m.current.geometry.parameters.width,p[1]*m.current.geometry.parameters.height)},[p[0],p[1]]),g.createElement("mesh",Ae({ref:m,scale:Array.isArray(i)?[...i,1]:i},f),g.createElement("planeGeometry",{args:[1,1,t,t]}),g.createElement("imageMaterial",{color:e,map:l,zoom:n,grayscale:s,opacity:o,scale:p,imageBounds:y,resolution:v,radius:a,toneMapped:c,transparent:u,side:h,key:ey.key}),r)}),NB=g.forwardRef(({url:r,...e},t)=>{const i=Io(r);return g.createElement(Dx,Ae({},e,{texture:i,ref:t}))}),GB=g.forwardRef(({url:r,...e},t)=>g.createElement(Dx,Ae({},e,{ref:t}))),rU=g.forwardRef((r,e)=>{if(r.url)return g.createElement(NB,Ae({},r,{ref:e}));if(r.texture)return g.createElement(GB,Ae({},r,{ref:e}));throw new Error("<Image /> requires a url or texture")}),QB=g.forwardRef(({threshold:r=15,geometry:e,...t},i)=>{const n=g.useRef(null);g.useImperativeHandle(i,()=>n.current,[]);const s=g.useMemo(()=>[0,0,0,1,0,0],[]),o=g.useRef(),a=g.useRef();return g.useLayoutEffect(()=>{const l=n.current.parent,c=e??l?.geometry;if(!c||o.current===c&&a.current===r)return;o.current=c,a.current=r;const h=new c_(c,r).attributes.position.array;n.current.geometry.setPositions(h),n.current.geometry.attributes.instanceStart.needsUpdate=!0,n.current.geometry.attributes.instanceEnd.needsUpdate=!0,n.current.computeLineDistances()}),g.createElement(Ws,Ae({segments:!0,points:s,ref:n,raycast:()=>null},t))}),ty=ws({screenspace:!1,color:new We("black"),opacity:1,thickness:.05,size:new De},`#include <common>
   #include <morphtarget_pars_vertex>
   #include <skinning_pars_vertex>
   #include <clipping_planes_pars_vertex>
   uniform float thickness;
   uniform bool screenspace;
   uniform vec2 size;
   void main() {
     #if defined (USE_SKINNING)
	     #include <beginnormal_vertex>
       #include <morphnormal_vertex>
       #include <skinbase_vertex>
       #include <skinnormal_vertex>
       #include <defaultnormal_vertex>
     #endif
     #include <begin_vertex>
	   #include <morphtarget_vertex>
	   #include <skinning_vertex>
     #include <project_vertex>
     #include <clipping_planes_vertex>
     vec4 tNormal = vec4(normal, 0.0);
     vec4 tPosition = vec4(transformed, 1.0);
     #ifdef USE_INSTANCING
       tNormal = instanceMatrix * tNormal;
       tPosition = instanceMatrix * tPosition;
     #endif
     if (screenspace) {
       vec3 newPosition = tPosition.xyz + tNormal.xyz * thickness;
       gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0); 
     } else {
       vec4 clipPosition = projectionMatrix * modelViewMatrix * tPosition;
       vec4 clipNormal = projectionMatrix * modelViewMatrix * tNormal;
       vec2 offset = normalize(clipNormal.xy) * thickness / size * clipPosition.w * 2.0;
       clipPosition.xy += offset;
       gl_Position = clipPosition;
     }
   }`,`uniform vec3 color;
   uniform float opacity;
   #include <clipping_planes_pars_fragment>
   void main(){
     #include <clipping_planes_fragment>
     gl_FragColor = vec4(color, opacity);
     #include <tonemapping_fragment>
     #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`);function oU({color:r="black",opacity:e=1,transparent:t=!1,screenspace:i=!1,toneMapped:n=!0,polygonOffset:s=!1,polygonOffsetFactor:o=0,renderOrder:a=0,thickness:l=.05,angle:c=Math.PI,clippingPlanes:u,...h}){const f=g.useRef(),[d]=g.useState(()=>new ty({side:Oa})),{gl:m}=ae(),A=m.getDrawingBufferSize(new De);g.useMemo(()=>Ci({OutlinesMaterial:ty}),[]);const p=g.useRef(0),y=g.useRef();return g.useLayoutEffect(()=>{const v=f.current;if(!v)return;const E=v.parent;if(E&&E.geometry&&(p.current!==c||y.current!==E.geometry)){var x;p.current=c,y.current=E.geometry;let I=(x=v.children)==null?void 0:x[0];I&&(c&&I.geometry.dispose(),v.remove(I)),E.skeleton?(I=new iA,I.material=d,I.bind(E.skeleton,E.bindMatrix),v.add(I)):E.isInstancedMesh?(I=new Zm(E.geometry,d,E.count),I.instanceMatrix=E.instanceMatrix,v.add(I)):(I=new ze,I.material=d,v.add(I)),I.geometry=c?R3(E.geometry,c):E.geometry,I.morphTargetInfluences=E.morphTargetInfluences,I.morphTargetDictionary=E.morphTargetDictionary}}),g.useLayoutEffect(()=>{const v=f.current;if(!v)return;const E=v.children[0];if(E){E.renderOrder=a;const x=v.parent;Un(E,{morphTargetInfluences:x.morphTargetInfluences,morphTargetDictionary:x.morphTargetDictionary}),Un(E.material,{transparent:t,thickness:l,color:r,opacity:e,size:A,screenspace:i,toneMapped:n,polygonOffset:s,polygonOffsetFactor:o,clippingPlanes:u,clipping:u&&u.length>0})}}),g.useEffect(()=>()=>{const v=f.current;if(!v)return;const E=v.children[0];E&&(c&&E.geometry.dispose(),v.remove(E))},[]),g.createElement("group",Ae({ref:f},h))}var zB=Object.defineProperty,HB=(r,e,t)=>e in r?zB(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,kt=(r,e,t)=>(HB(r,typeof e!="symbol"?e+"":e,t),t);function _d(r,e,t,i,n){let s;if(r=r.subarray||r.slice?r:r.buffer,t=t.subarray||t.slice?t:t.buffer,r=e?r.subarray?r.subarray(e,n&&e+n):r.slice(e,n&&e+n):r,t.set)t.set(r,i);else for(s=0;s<r.length;s++)t[s+i]=r[s];return t}function VB(r){return r instanceof Float32Array?r:r instanceof Gi?r.getAttribute("position").array:r.map(e=>{const t=Array.isArray(e);return e instanceof Q?[e.x,e.y,e.z]:e instanceof De?[e.x,e.y,0]:t&&e.length===3?[e[0],e[1],e[2]]:t&&e.length===2?[e[0],e[1],0]:e}).flat()}class KB extends Gi{constructor(){super(),kt(this,"type","MeshLine"),kt(this,"isMeshLine",!0),kt(this,"positions",[]),kt(this,"previous",[]),kt(this,"next",[]),kt(this,"side",[]),kt(this,"width",[]),kt(this,"indices_array",[]),kt(this,"uvs",[]),kt(this,"counters",[]),kt(this,"widthCallback",null),kt(this,"_attributes"),kt(this,"_points",[]),kt(this,"points"),kt(this,"matrixWorld",new we),Object.defineProperties(this,{points:{enumerable:!0,get(){return this._points},set(e){this.setPoints(e,this.widthCallback)}}})}setMatrixWorld(e){this.matrixWorld=e}setPoints(e,t){if(e=VB(e),this._points=e,this.widthCallback=t??null,this.positions=[],this.counters=[],e.length&&e[0]instanceof Q)for(let i=0;i<e.length;i++){const n=e[i],s=i/(e.length-1);this.positions.push(n.x,n.y,n.z),this.positions.push(n.x,n.y,n.z),this.counters.push(s),this.counters.push(s)}else for(let i=0;i<e.length;i+=3){const n=i/(e.length-1);this.positions.push(e[i],e[i+1],e[i+2]),this.positions.push(e[i],e[i+1],e[i+2]),this.counters.push(n),this.counters.push(n)}this.process()}compareV3(e,t){const i=e*6,n=t*6;return this.positions[i]===this.positions[n]&&this.positions[i+1]===this.positions[n+1]&&this.positions[i+2]===this.positions[n+2]}copyV3(e){const t=e*6;return[this.positions[t],this.positions[t+1],this.positions[t+2]]}process(){const e=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[];let t,i;this.compareV3(0,e-1)?i=this.copyV3(e-2):i=this.copyV3(0),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);for(let n=0;n<e;n++){if(this.side.push(1),this.side.push(-1),this.widthCallback?t=this.widthCallback(n/(e-1)):t=1,this.width.push(t),this.width.push(t),this.uvs.push(n/(e-1),0),this.uvs.push(n/(e-1),1),n<e-1){i=this.copyV3(n),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);const s=n*2;this.indices_array.push(s,s+1,s+2),this.indices_array.push(s+2,s+1,s+3)}n>0&&(i=this.copyV3(n),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]))}this.compareV3(e-1,0)?i=this.copyV3(1):i=this.copyV3(e-1),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]),!this._attributes||this._attributes.position.count!==this.counters.length?this._attributes={position:new Vt(new Float32Array(this.positions),3),previous:new Vt(new Float32Array(this.previous),3),next:new Vt(new Float32Array(this.next),3),side:new Vt(new Float32Array(this.side),1),width:new Vt(new Float32Array(this.width),1),uv:new Vt(new Float32Array(this.uvs),2),index:new Vt(new Uint16Array(this.indices_array),1),counters:new Vt(new Float32Array(this.counters),1)}:(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()}advance({x:e,y:t,z:i}){const n=this._attributes.position.array,s=this._attributes.previous.array,o=this._attributes.next.array,a=n.length;_d(n,0,s,0,a),_d(n,6,n,0,a-6),n[a-6]=e,n[a-5]=t,n[a-4]=i,n[a-3]=e,n[a-2]=t,n[a-1]=i,_d(n,6,o,0,a-6),o[a-6]=e,o[a-5]=t,o[a-4]=i,o[a-3]=e,o[a-2]=t,o[a-1]=i,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0}}const $B=`
  #include <common>
  #include <logdepthbuf_pars_vertex>
  #include <fog_pars_vertex>
  #include <clipping_planes_pars_vertex>

  attribute vec3 previous;
  attribute vec3 next;
  attribute float side;
  attribute float width;
  attribute float counters;
  
  uniform vec2 resolution;
  uniform float lineWidth;
  uniform vec3 color;
  uniform float opacity;
  uniform float sizeAttenuation;
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  vec2 fix(vec4 i, float aspect) {
    vec2 res = i.xy / i.w;
    res.x *= aspect;
    return res;
  }
  
  void main() {
    float aspect = resolution.x / resolution.y;
    vColor = vec4(color, opacity);
    vUV = uv;
    vCounters = counters;
  
    mat4 m = projectionMatrix * modelViewMatrix;
    vec4 finalPosition = m * vec4(position, 1.0) * aspect;
    vec4 prevPos = m * vec4(previous, 1.0);
    vec4 nextPos = m * vec4(next, 1.0);
  
    vec2 currentP = fix(finalPosition, aspect);
    vec2 prevP = fix(prevPos, aspect);
    vec2 nextP = fix(nextPos, aspect);
  
    float w = lineWidth * width;
  
    vec2 dir;
    if (nextP == currentP) dir = normalize(currentP - prevP);
    else if (prevP == currentP) dir = normalize(nextP - currentP);
    else {
      vec2 dir1 = normalize(currentP - prevP);
      vec2 dir2 = normalize(nextP - currentP);
      dir = normalize(dir1 + dir2);
  
      vec2 perp = vec2(-dir1.y, dir1.x);
      vec2 miter = vec2(-dir.y, dir.x);
      //w = clamp(w / dot(miter, perp), 0., 4. * lineWidth * width);
    }
  
    //vec2 normal = (cross(vec3(dir, 0.), vec3(0., 0., 1.))).xy;
    vec4 normal = vec4(-dir.y, dir.x, 0., 1.);
    normal.xy *= .5 * w;
    //normal *= projectionMatrix;
    if (sizeAttenuation == 0.) {
      normal.xy *= finalPosition.w;
      normal.xy /= (vec4(resolution, 0., 1.) * projectionMatrix).xy * aspect;
    }
  
    finalPosition.xy += normal.xy * side;
    gl_Position = finalPosition;
    #include <logdepthbuf_vertex>
    #include <fog_vertex>
    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
    #include <clipping_planes_vertex>
    #include <fog_vertex>
  }
`,YB=parseInt(Kh.replace(/\D+/g,"")),WB=YB>=154?"colorspace_fragment":"encodings_fragment",jB=`
  #include <fog_pars_fragment>
  #include <logdepthbuf_pars_fragment>
  #include <clipping_planes_pars_fragment>
  
  uniform sampler2D map;
  uniform sampler2D alphaMap;
  uniform float useGradient;
  uniform float useMap;
  uniform float useAlphaMap;
  uniform float useDash;
  uniform float dashArray;
  uniform float dashOffset;
  uniform float dashRatio;
  uniform float visibility;
  uniform float alphaTest;
  uniform vec2 repeat;
  uniform vec3 gradient[2];
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  void main() {
    #include <logdepthbuf_fragment>
    vec4 diffuseColor = vColor;
    if (useGradient == 1.) diffuseColor = vec4(mix(gradient[0], gradient[1], vCounters), 1.0);
    if (useMap == 1.) diffuseColor *= texture2D(map, vUV * repeat);
    if (useAlphaMap == 1.) diffuseColor.a *= texture2D(alphaMap, vUV * repeat).a;
    if (diffuseColor.a < alphaTest) discard;
    if (useDash == 1.) diffuseColor.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));
    diffuseColor.a *= step(vCounters, visibility);
    #include <clipping_planes_fragment>
    gl_FragColor = diffuseColor;     
    #include <fog_fragment>
    #include <tonemapping_fragment>
    #include <${WB}>
  }
`;class qB extends Ii{constructor(e){super({uniforms:{...K0.fog,lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new We(16777215)},gradient:{value:[new We(16711680),new We(65280)]},opacity:{value:1},resolution:{value:new De(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},useGradient:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new De(1,1)}},vertexShader:$B,fragmentShader:jB}),kt(this,"lineWidth"),kt(this,"map"),kt(this,"useMap"),kt(this,"alphaMap"),kt(this,"useAlphaMap"),kt(this,"color"),kt(this,"gradient"),kt(this,"resolution"),kt(this,"sizeAttenuation"),kt(this,"dashArray"),kt(this,"dashOffset"),kt(this,"dashRatio"),kt(this,"useDash"),kt(this,"useGradient"),kt(this,"visibility"),kt(this,"repeat"),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get(){return this.uniforms.lineWidth.value},set(t){this.uniforms.lineWidth.value=t}},map:{enumerable:!0,get(){return this.uniforms.map.value},set(t){this.uniforms.map.value=t}},useMap:{enumerable:!0,get(){return this.uniforms.useMap.value},set(t){this.uniforms.useMap.value=t}},alphaMap:{enumerable:!0,get(){return this.uniforms.alphaMap.value},set(t){this.uniforms.alphaMap.value=t}},useAlphaMap:{enumerable:!0,get(){return this.uniforms.useAlphaMap.value},set(t){this.uniforms.useAlphaMap.value=t}},color:{enumerable:!0,get(){return this.uniforms.color.value},set(t){this.uniforms.color.value=t}},gradient:{enumerable:!0,get(){return this.uniforms.gradient.value},set(t){this.uniforms.gradient.value=t}},opacity:{enumerable:!0,get(){return this.uniforms.opacity.value},set(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get(){return this.uniforms.resolution.value},set(t){this.uniforms.resolution.value.copy(t)}},sizeAttenuation:{enumerable:!0,get(){return this.uniforms.sizeAttenuation.value},set(t){this.uniforms.sizeAttenuation.value=t}},dashArray:{enumerable:!0,get(){return this.uniforms.dashArray.value},set(t){this.uniforms.dashArray.value=t,this.useDash=t!==0?1:0}},dashOffset:{enumerable:!0,get(){return this.uniforms.dashOffset.value},set(t){this.uniforms.dashOffset.value=t}},dashRatio:{enumerable:!0,get(){return this.uniforms.dashRatio.value},set(t){this.uniforms.dashRatio.value=t}},useDash:{enumerable:!0,get(){return this.uniforms.useDash.value},set(t){this.uniforms.useDash.value=t}},useGradient:{enumerable:!0,get(){return this.uniforms.useGradient.value},set(t){this.uniforms.useGradient.value=t}},visibility:{enumerable:!0,get(){return this.uniforms.visibility.value},set(t){this.uniforms.visibility.value=t}},alphaTest:{enumerable:!0,get(){return this.uniforms.alphaTest.value},set(t){this.uniforms.alphaTest.value=t}},repeat:{enumerable:!0,get(){return this.uniforms.repeat.value},set(t){this.uniforms.repeat.value.copy(t)}}}),this.setValues(e)}copy(e){return super.copy(e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.gradient=e.gradient,this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray=e.dashArray,this.dashOffset=e.dashOffset,this.dashRatio=e.dashRatio,this.useDash=e.useDash,this.useGradient=e.useGradient,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this}}const Mx={width:.2,length:1,decay:1,local:!1,stride:0,interval:1},XB=(r,e=1)=>(r.set(r.subarray(e)),r.fill(-1/0,-e),r);function JB(r,e){const{length:t,local:i,decay:n,interval:s,stride:o}={...Mx,...e},a=g.useRef(),[l]=g.useState(()=>new Q);g.useLayoutEffect(()=>{r&&(a.current=Float32Array.from({length:t*10*3},(h,f)=>r.position.getComponent(f%3)))},[t,r]);const c=g.useRef(new Q),u=g.useRef(0);return Ve(()=>{if(r&&a.current){if(u.current===0){let h;i?h=r.position:(r.getWorldPosition(l),h=l);const f=1*n;for(let d=0;d<f;d++)h.distanceTo(c.current)<o||(XB(a.current,3),a.current.set(h.toArray(),a.current.length-3));c.current.copy(h)}u.current++,u.current=u.current%s}}),a}const aU=g.forwardRef((r,e)=>{const{children:t}=r,{width:i,length:n,decay:s,local:o,stride:a,interval:l}={...Mx,...r},{color:c="hotpink",attenuation:u,target:h}=r,f=ae(x=>x.size),d=ae(x=>x.scene),m=g.useRef(null),[A,p]=g.useState(null),y=JB(A,{length:n,decay:s,local:o,stride:a,interval:l});g.useEffect(()=>{const x=h?.current||m.current.children.find(I=>I instanceof gi);x&&p(x)},[y,h]);const v=g.useMemo(()=>new KB,[]),E=g.useMemo(()=>{var x;const I=new qB({lineWidth:.1*i,color:c,sizeAttenuation:1,resolution:new De(f.width,f.height)});let C;if(t)if(Array.isArray(t))C=t.find(_=>{const S=_;return typeof S.type=="string"&&S.type==="meshLineMaterial"});else{const _=t;typeof _.type=="string"&&_.type==="meshLineMaterial"&&(C=_)}return typeof((x=C)==null?void 0:x.props)=="object"&&I.setValues(C.props),I},[i,c,f,t]);return g.useEffect(()=>{E.uniforms.resolution.value.set(f.width,f.height)},[f]),Ve(()=>{y.current&&v.setPoints(y.current,u)}),g.createElement("group",null,vo(g.createElement("mesh",{ref:e,geometry:v,material:E}),d),g.createElement("group",{ref:m},t))});function ZB(r,e=16,t,i,n){const[s,o]=g.useState(()=>{const a=Array.from({length:e},()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]).flat();return new oc(Float32Array.from(a),16)});return g.useLayoutEffect(()=>{if(typeof r.current>"u")return;const a=new Yb(r.current);i&&a.setWeightAttribute(i),a.build();const l=new Q,c=new Q,u=new We,h=new gi;r.current.updateMatrixWorld(!0);for(let f=0;f<e;f++)a.sample(l,c,u),typeof t=="function"?t({dummy:h,sampledMesh:r.current,position:l,normal:c,color:u},f):h.position.copy(l),h.updateMatrix(),n!=null&&n.current&&n.current.setMatrixAt(f,h.matrix),h.matrix.toArray(s.array,f*16);n!=null&&n.current&&(n.current.instanceMatrix.needsUpdate=!0),s.needsUpdate=!0,o(new oc(s.array,s.itemSize).copy(s))},[r,n,i,e,t]),s}function lU({children:r,weight:e,transform:t,instances:i,mesh:n,count:s=16,...o}){const a=g.useRef(null),l=g.useRef(null),c=g.useRef(null);return g.useLayoutEffect(()=>{var u,h;l.current=(u=i?.current)!==null&&u!==void 0?u:a.current.children.find(f=>f.hasOwnProperty("instanceMatrix")),c.current=(h=n?.current)!==null&&h!==void 0?h:a.current.children.find(f=>f.type==="Mesh")},[r,n?.current,i?.current]),ZB(c,s,t,e,l),g.createElement("group",Ae({ref:a},o),r)}const cU=({compute:r,name:e,...t})=>{const[i]=g.useState(()=>new Vt(new Float32Array(0),1)),n=g.useRef(null);return g.useLayoutEffect(()=>{if(n.current){var s;const o=(s=n.current.parent)!==null&&s!==void 0?s:n.current.__r3f.parent,a=r(o);n.current.copy(a)}},[r]),g.createElement("primitive",Ae({ref:n,object:i,attach:`attributes-${e}`},t))};function e9(r,{keys:e=["near","far","color","distance","decay","penumbra","angle","intensity","skeleton","visible","castShadow","receiveShadow","morphTargetDictionary","morphTargetInfluences","name","geometry","material","position","rotation","scale","up","userData","bindMode","bindMatrix","bindMatrixInverse","skeleton"],deep:t,inject:i,castShadow:n,receiveShadow:s}){let o={};for(const a of e)o[a]=r[a];return t&&(o.geometry&&t!=="materialsOnly"&&(o.geometry=o.geometry.clone()),o.material&&t!=="geometriesOnly"&&(o.material=o.material.clone())),i&&(typeof i=="function"?o={...o,children:i(r)}:g.isValidElement(i)?o={...o,children:i}:o={...o,...i}),r instanceof ze&&(n&&(o.castShadow=!0),s&&(o.receiveShadow=!0)),o}const Mh=g.forwardRef(({isChild:r=!1,object:e,children:t,deep:i,castShadow:n,receiveShadow:s,inject:o,keys:a,...l},c)=>{const u={keys:a,deep:i,inject:o,castShadow:n,receiveShadow:s};if(e=g.useMemo(()=>{if(r===!1&&!Array.isArray(e)){let m=!1;if(e.traverse(A=>{A.isSkinnedMesh&&(m=!0)}),m)return $b.clone(e)}return e},[e,r]),Array.isArray(e))return g.createElement("group",Ae({},l,{ref:c}),e.map(m=>g.createElement(Mh,Ae({key:m.uuid,object:m},u))),t);const{children:h,...f}=e9(e,u),d=e.type[0].toLowerCase()+e.type.slice(1);return g.createElement(d,Ae({},f,l,{ref:c}),e.children.map(m=>m.type==="Bone"?g.createElement("primitive",Ae({key:m.uuid,object:m},u)):g.createElement(Mh,Ae({key:m.uuid,object:m},u,{isChild:!0}))),t,h)}),FA=g.createContext(null),uU=g.forwardRef(({resolution:r=28,maxPolyCount:e=1e4,enableUvs:t=!1,enableColors:i=!1,children:n,...s},o)=>{const a=g.useRef(null);g.useImperativeHandle(o,()=>a.current,[]);const l=g.useMemo(()=>new Pb(r,null,t,i,e),[r,e,t,i]),c=g.useMemo(()=>({getParent:()=>a}),[]);return Ve(()=>{l.update(),l.reset()},-1),g.createElement(g.Fragment,null,g.createElement("primitive",Ae({object:l,ref:a},s),g.createElement(FA.Provider,{value:c},n)))}),hU=g.forwardRef(({strength:r=.5,subtract:e=12,color:t,...i},n)=>{const{getParent:s}=g.useContext(FA),o=g.useMemo(()=>s(),[s]),a=g.useRef(null);g.useImperativeHandle(n,()=>a.current,[]);const l=new Q;return Ve(c=>{!o.current||!a.current||(a.current.getWorldPosition(l),o.current.addBall(.5+l.x*.5,.5+l.y*.5,.5+l.z*.5,r,e,t))}),g.createElement("group",Ae({ref:a},i))}),fU=g.forwardRef(({planeType:r="x",strength:e=.5,subtract:t=12,...i},n)=>{const{getParent:s}=g.useContext(FA),o=g.useMemo(()=>s(),[s]),a=g.useRef(null);g.useImperativeHandle(n,()=>a.current,[]);const l=g.useMemo(()=>r==="x"?"addPlaneX":r==="y"?"addPlaneY":"addPlaneZ",[r]);return Ve(()=>{!o.current||!a.current||o.current[l](e,t)}),g.createElement("group",Ae({ref:a},i))});function t9(r){return Array.isArray(r)}function Sd(r=[0,0,0]){return t9(r)?r:r instanceof Q||r instanceof kn?[r.x,r.y,r.z]:[r,r,r]}const dU=g.forwardRef(function({debug:e,depthTest:t=!1,polygonOffsetFactor:i=-10,map:n,mesh:s,children:o,position:a,rotation:l,scale:c,...u},h){const f=g.useRef(null);g.useImperativeHandle(h,()=>f.current);const d=g.useRef(null),m=g.useRef({position:new Q,rotation:new kn,scale:new Q(1,1,1)});return g.useLayoutEffect(()=>{const A=s?.current||f.current.parent,p=f.current;if(!(A instanceof ze))throw new Error('Decal must have a Mesh as parent or specify its "mesh" prop');if(A){Un(m.current,{position:a,scale:c});const y=A.matrixWorld.clone();if(A.matrixWorld.identity(),!l||typeof l=="number"){const v=new gi;v.position.copy(m.current.position);const E=A.geometry.attributes.position.array;A.geometry.attributes.normal===void 0&&A.geometry.computeVertexNormals();const x=A.geometry.attributes.normal.array;let I=1/0;new Q;let C=new Q;const _=v.position.x,S=v.position.y,b=v.position.z,T=E.length;let R=-1;for(let w=0;w<T;w+=3){const B=E[w],M=E[w+1],O=E[w+2],U=B-_,Y=M-S,W=O-b,N=U*U+Y*Y+W*W;N<I&&(I=N,R=w)}C.fromArray(x,R),v.lookAt(v.position.clone().add(C)),v.rotateZ(Math.PI),v.rotateY(Math.PI),typeof l=="number"&&v.rotateZ(l),Un(m.current,{rotation:v.rotation})}else Un(m.current,{rotation:l});return p.geometry=new xw(A,m.current.position,m.current.rotation,m.current.scale),A.matrixWorld=y,()=>{p.geometry.dispose()}}},[s,...Sd(a),...Sd(c),...Sd(l)]),g.useLayoutEffect(()=>{d.current&&(Un(d.current,m.current),d.current.traverse(A=>A.raycast=()=>null))},[e]),g.createElement("mesh",Ae({ref:f,"material-transparent":!0,"material-polygonOffset":!0,"material-polygonOffsetFactor":i,"material-depthTest":t,"material-map":n},u),o,e&&g.createElement("mesh",{ref:d},g.createElement("boxGeometry",null),g.createElement("meshNormalMaterial",{wireframe:!0}),g.createElement("axesHelper",null)))}),mU=g.forwardRef(function({src:e,skipFill:t,skipStrokes:i,fillMaterial:n,strokeMaterial:s,fillMeshProps:o,strokeMeshProps:a,...l},c){const u=hi(md,e.startsWith("<svg")?`data:image/svg+xml;utf8,${e}`:e),h=g.useMemo(()=>i?[]:u.paths.map(d=>{var m;return((m=d.userData)==null?void 0:m.style.stroke)===void 0||d.userData.style.stroke==="none"?null:d.subPaths.map(A=>md.pointsToStroke(A.getPoints(),d.userData.style))}),[u,i]);g.useEffect(()=>()=>h.forEach(d=>d&&d.map(m=>m.dispose())),[h]);let f=0;return g.createElement("object3D",Ae({ref:c},l),g.createElement("object3D",{scale:[1,-1,1]},u.paths.map((d,m)=>{var A,p;return g.createElement(g.Fragment,{key:m},!t&&((A=d.userData)==null?void 0:A.style.fill)!==void 0&&d.userData.style.fill!=="none"&&md.createShapes(d).map((y,v)=>g.createElement("mesh",Ae({key:v},o,{renderOrder:f++}),g.createElement("shapeGeometry",{args:[y]}),g.createElement("meshBasicMaterial",Ae({color:d.userData.style.fill,opacity:d.userData.style.fillOpacity,transparent:!0,side:bi,depthWrite:!1},n)))),!i&&((p=d.userData)==null?void 0:p.style.stroke)!==void 0&&d.userData.style.stroke!=="none"&&d.subPaths.map((y,v)=>g.createElement("mesh",Ae({key:v,geometry:h[m][v]},a,{renderOrder:f++}),g.createElement("meshBasicMaterial",Ae({color:d.userData.style.stroke,opacity:d.userData.style.strokeOpacity,transparent:!0,side:bi,depthWrite:!1},s)))))})))});let ou=null,Lx="https://www.gstatic.com/draco/versioned/decoders/1.5.5/";function Px(r=!0,e=!0,t){return i=>{t&&t(i),r&&(ou||(ou=new _8),ou.setDecoderPath(typeof r=="string"?r:Lx),i.setDRACOLoader(ou)),e&&i.setMeshoptDecoder(typeof vd=="function"?vd():vd)}}const df=(r,e,t,i)=>hi(wA,r,Px(e,t,i));df.preload=(r,e,t,i)=>hi.preload(wA,r,Px(e,t,i));df.clear=r=>hi.clear(wA,r);df.setDecoderPath=r=>{Lx=r};const AU=g.forwardRef(({src:r,useDraco:e,useMeshOpt:t,extendLoader:i,...n},s)=>{const{scene:o}=df(r,e,t,i);return g.createElement(Mh,Ae({ref:s},n,{object:o}))});function pU({renderIndex:r=1,bgColor:e="black",fgColor:t="white",characters:i=" .:-+*=%@#",invert:n=!0,color:s=!1,resolution:o=.15}){const{size:a,gl:l,scene:c,camera:u}=ae(),h=g.useMemo(()=>{const f=new bw(l,i,{invert:n,color:s,resolution:o});return f.domElement.style.position="absolute",f.domElement.style.top="0px",f.domElement.style.left="0px",f.domElement.style.pointerEvents="none",f},[i,n,s,o]);return g.useLayoutEffect(()=>{h.domElement.style.color=t,h.domElement.style.backgroundColor=e},[t,e]),g.useEffect(()=>(l.domElement.style.opacity="0",l.domElement.parentNode.appendChild(h.domElement),()=>{l.domElement.style.opacity="1",l.domElement.parentNode.removeChild(h.domElement)}),[h]),g.useEffect(()=>{h.setSize(a.width,a.height)},[h,a]),Ve(f=>{h.render(c,u)},r),g.createElement(g.Fragment,null)}const iy=ws({alphaTest:0,viewport:new De(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},`
    precision highp sampler2D;
    precision highp usampler2D;
    out vec4 vColor;
    out vec3 vPosition;
    uniform vec2 resolution;
    uniform vec2 viewport;
    uniform float focal;
    attribute uint splatIndex;
    uniform sampler2D centerAndScaleTexture;
    uniform usampler2D covAndColorTexture;    

    vec2 unpackInt16(in uint value) {
      int v = int(value);
      int v0 = v >> 16;
      int v1 = (v & 0xFFFF);
      if((v & 0x8000) != 0)
        v1 |= 0xFFFF0000;
      return vec2(float(v1), float(v0));
    }

    void main () {
      ivec2 texSize = textureSize(centerAndScaleTexture, 0);
      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));
      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);
      vec4 center = vec4(centerAndScaleData.xyz, 1);
      vec4 camspace = modelViewMatrix * center;
      vec4 pos2d = projectionMatrix * camspace;

      float bounds = 1.2 * pos2d.w;
      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds
        || pos2d.y < -bounds || pos2d.y > bounds) {
        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);
        return;
      }

      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);
      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;
      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;
      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;
      mat3 Vrk = mat3(
        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,
        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,
        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y
      );

      mat3 J = mat3(
        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),
        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),
        0., 0., 0.
      );

      mat3 W = transpose(mat3(modelViewMatrix));
      mat3 T = W * J;
      mat3 cov = transpose(T) * Vrk * T;
      vec2 vCenter = vec2(pos2d) / pos2d.w;
      float diagonal1 = cov[0][0] + 0.3;
      float offDiagonal = cov[0][1];
      float diagonal2 = cov[1][1] + 0.3;
      float mid = 0.5 * (diagonal1 + diagonal2);
      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
      float lambda1 = mid + radius;
      float lambda2 = max(mid - radius, 0.1);
      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;
      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);
      uint colorUint = covAndColorData.w;
      vColor = vec4(
        float(colorUint & uint(0xFF)) / 255.0,
        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,
        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,
        float(colorUint >> uint(24)) / 255.0
      );
      vPosition = position;

      gl_Position = vec4(
        vCenter 
          + position.x * v2 / viewport * 2.0 
          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);
    }
    `,`
    #include <alphatest_pars_fragment>
    #include <alphahash_pars_fragment>
    in vec4 vColor;
    in vec3 vPosition;
    void main () {
      float A = -dot(vPosition.xy, vPosition.xy);
      if (A < -4.0) discard;
      float B = exp(A) * vColor.a;
      vec4 diffuseColor = vec4(vColor.rgb, B);
      #include <alphatest_fragment>
      #include <alphahash_fragment>
      gl_FragColor = diffuseColor;
      #include <tonemapping_fragment>
      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `);function i9(r){let e=null,t=0;function i(n,s=!1){const o=e.length/16,a=-1e-4;let l=-1/0,c=1/0;const u=new Float32Array(o),h=new Int32Array(u.buffer),f=new Int32Array(o);let d=0;for(let v=0;v<o;v++){const E=n[0]*e[v*16+12]+n[1]*e[v*16+13]+n[2]*e[v*16+14]+n[3];(s||E<0&&e[v*16+15]>a*E)&&(u[d]=E,f[d]=v,d++,E>l&&(l=E),E<c&&(c=E))}const m=(256*256-1)/(l-c),A=new Uint32Array(256*256);for(let v=0;v<d;v++)h[v]=(u[v]-c)*m|0,A[h[v]]++;const p=new Uint32Array(256*256);for(let v=1;v<256*256;v++)p[v]=p[v-1]+A[v-1];const y=new Uint32Array(d);for(let v=0;v<d;v++)y[p[h[v]]++]=f[v];return y}r.onmessage=n=>{if(n.data.method=="push"){t===0&&(e=new Float32Array(n.data.length));const s=new Float32Array(n.data.matrices);e.set(s,t),t+=s.length}else if(n.data.method=="sort"&&e!==null){const s=i(new Float32Array(n.data.view),n.data.hashed);r.postMessage({indices:s,key:n.data.key},[s.buffer])}}}class n9 extends Yr{constructor(...e){super(...e),this.gl=null,this.chunkSize=25e3}load(e,t,i,n){const s={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",i9.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(o,a,l)=>o9(a,s,o,l),connect:o=>a9(s,o),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:i};s9(s).then(t).catch(o=>{n?.(o),s.manager.itemError(s.url)})}}async function s9(r){r.manager.itemStart(r.url);const e=await fetch(r.url);if(e.body===null)throw"Failed to fetch file";let t=e.headers.get("Content-Length");const i=t?parseInt(t):void 0;if(i==null)throw"Failed to get content length";r.stream=e.body.getReader(),r.totalDownloadBytes=i,r.numVertices=Math.floor(r.totalDownloadBytes/r.rowLength);const n=r.gl.getContext();let s=n.getParameter(n.MAX_TEXTURE_SIZE);return r.maxVertexes=s*s,r.numVertices>r.maxVertexes&&(r.numVertices=r.maxVertexes),r.bufferTextureWidth=s,r.bufferTextureHeight=Math.floor((r.numVertices-1)/s)+1,r.centerAndScaleData=new Float32Array(r.bufferTextureWidth*r.bufferTextureHeight*4),r.covAndColorData=new Uint32Array(r.bufferTextureWidth*r.bufferTextureHeight*4),r.centerAndScaleTexture=new Vr(r.centerAndScaleData,r.bufferTextureWidth,r.bufferTextureHeight,Di,ri),r.centerAndScaleTexture.needsUpdate=!0,r.covAndColorTexture=new Vr(r.covAndColorData,r.bufferTextureWidth,r.bufferTextureHeight,Eh,ho),r.covAndColorTexture.internalFormat="RGBA32UI",r.covAndColorTexture.needsUpdate=!0,r}async function r9(r){r.loading=!0;let e=0,t=0;const i=[];let n=0;const s=r.totalDownloadBytes!==0;for(;;)try{const{value:o,done:a}=await r.stream.read();if(a)break;if(e+=o.length,r.totalDownloadBytes!=null){const c=e/r.totalDownloadBytes*100;if(r.onProgress&&c-n>1){const u=new ProgressEvent("progress",{lengthComputable:s,loaded:e,total:r.totalDownloadBytes});r.onProgress(u),n=c}}i.push(o);const l=e-t;if(r.totalDownloadBytes!=null&&l>r.rowLength*r.chunkSize){let c=Math.floor(l/r.rowLength);const u=new Uint8Array(l);let h=0;for(const m of i)u.set(m,h),h+=m.length;if(i.length=0,l>c*r.rowLength){const m=new Uint8Array(l-c*r.rowLength);m.set(u.subarray(l-m.length,l),0),i.push(m)}const f=new Uint8Array(c*r.rowLength);f.set(u.subarray(0,f.byteLength),0);const d=ny(r,f.buffer,c);if(r.worker.postMessage({method:"push",src:r.url,length:r.numVertices*16,matrices:d.buffer},[d.buffer]),t+=c*r.rowLength,r.onProgress){const m=new ProgressEvent("progress",{lengthComputable:s,loaded:r.totalDownloadBytes,total:r.totalDownloadBytes});r.onProgress(m)}}}catch(o){console.error(o);break}if(e-t>0){let o=new Uint8Array(i.reduce((u,h)=>u+h.length,0)),a=0;for(const u of i)o.set(u,a),a+=u.length;let l=Math.floor(o.byteLength/r.rowLength);const c=ny(r,o.buffer,l);r.worker.postMessage({method:"push",src:r.url,length:l*16,matrices:c.buffer},[c.buffer])}r.loaded=!0,r.manager.itemEnd(r.url)}function o9(r,e,t,i){if(r.updateMatrixWorld(),e.gl.getCurrentViewport(t.viewport),t.material.viewport.x=t.viewport.z,t.material.viewport.y=t.viewport.w,t.material.focal=t.viewport.w/2*Math.abs(r.projectionMatrix.elements[5]),t.ready){if(i&&t.sorted)return;t.ready=!1;const n=new Float32Array([t.modelViewMatrix.elements[2],-t.modelViewMatrix.elements[6],t.modelViewMatrix.elements[10],t.modelViewMatrix.elements[14]]);e.worker.postMessage({method:"sort",src:e.url,key:t.uuid,view:n.buffer,hashed:i},[n.buffer]),i&&e.loaded&&(t.sorted=!0)}}function a9(r,e){r.loading||r9(r),e.ready=!1,e.pm=new we,e.vm1=new we,e.vm2=new we,e.viewport=new yi;let t=new Uint32Array(r.bufferTextureWidth*r.bufferTextureHeight);const i=new oc(t,1,!1);i.setUsage(nn);const n=e.geometry=new sA,s=new Float32Array(18),o=new Vt(s,3);n.setAttribute("position",o),o.setXYZ(2,-2,2,0),o.setXYZ(1,2,2,0),o.setXYZ(0,-2,-2,0),o.setXYZ(5,-2,-2,0),o.setXYZ(4,2,2,0),o.setXYZ(3,2,-2,0),o.needsUpdate=!0,n.setAttribute("splatIndex",i),n.instanceCount=1;function a(c){if(e&&c.data.key===e.uuid){let u=new Uint32Array(c.data.indices);n.attributes.splatIndex.set(u),n.attributes.splatIndex.needsUpdate=!0,n.instanceCount=u.length,e.ready=!0}}r.worker.addEventListener("message",a);async function l(){for(;;){const c=r.gl.properties.get(r.centerAndScaleTexture),u=r.gl.properties.get(r.covAndColorTexture);if(c!=null&&c.__webglTexture&&u!=null&&u.__webglTexture&&r.loadedVertexCount>0)break;await new Promise(h=>setTimeout(h,10))}e.ready=!0}return l(),()=>r.worker.removeEventListener("message",a)}function ny(r,e,t){const i=r.gl.getContext();if(r.loadedVertexCount+t>r.maxVertexes&&(t=r.maxVertexes-r.loadedVertexCount),t<=0)throw"Failed to parse file";const n=new Uint8Array(e),s=new Float32Array(e),o=new Float32Array(t*16),a=new Uint8Array(r.covAndColorData.buffer),l=new Int16Array(r.covAndColorData.buffer);for(let c=0;c<t;c++){const u=new st(-(n[32*c+28+1]-128)/128,(n[32*c+28+2]-128)/128,(n[32*c+28+3]-128)/128,-(n[32*c+28+0]-128)/128);u.invert();const h=new Q(s[8*c+0],s[8*c+1],-s[8*c+2]),f=new Q(s[8*c+3+0],s[8*c+3+1],s[8*c+3+2]),d=new we;d.makeRotationFromQuaternion(u),d.transpose(),d.scale(f);const m=d.clone();d.transpose(),d.premultiply(m),d.setPosition(h);const A=[0,1,2,5,6,10];let p=0;for(let E=0;E<A.length;E++)Math.abs(d.elements[A[E]])>p&&(p=Math.abs(d.elements[A[E]]));let y=r.loadedVertexCount*4+c*4;r.centerAndScaleData[y+0]=h.x,r.centerAndScaleData[y+1]=-h.y,r.centerAndScaleData[y+2]=h.z,r.centerAndScaleData[y+3]=p/32767,y=r.loadedVertexCount*8+c*4*2;for(let E=0;E<A.length;E++)l[y+E]=d.elements[A[E]]*32767/p;y=r.loadedVertexCount*16+(c*4+3)*4;const v=new We(n[32*c+24+0]/255,n[32*c+24+1]/255,n[32*c+24+2]/255);v.convertSRGBToLinear(),a[y+0]=v.r*255,a[y+1]=v.g*255,a[y+2]=v.b*255,a[y+3]=n[32*c+24+3],d.elements[15]=Math.max(f.x,f.y,f.z)*n[32*c+24+3]/255;for(let E=0;E<16;E++)o[c*16+E]=d.elements[E]}for(;t>0;){let c=0,u=0;const h=r.loadedVertexCount%r.bufferTextureWidth,f=Math.floor(r.loadedVertexCount/r.bufferTextureWidth);r.loadedVertexCount%r.bufferTextureWidth!=0?(c=Math.min(r.bufferTextureWidth,h+t)-h,u=1):Math.floor(t/r.bufferTextureWidth)>0?(c=r.bufferTextureWidth,u=Math.floor(t/r.bufferTextureWidth)):(c=t%r.bufferTextureWidth,u=1);const d=r.gl.properties.get(r.centerAndScaleTexture);i.bindTexture(i.TEXTURE_2D,d.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,c,u,i.RGBA,i.FLOAT,r.centerAndScaleData,r.loadedVertexCount*4);const m=r.gl.properties.get(r.covAndColorTexture);i.bindTexture(i.TEXTURE_2D,m.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,c,u,i.RGBA_INTEGER,i.UNSIGNED_INT,r.covAndColorData,r.loadedVertexCount*4),r.gl.resetState(),r.loadedVertexCount+=c*u,t-=c*u}return o}function gU({src:r,toneMapped:e=!1,alphaTest:t=0,alphaHash:i=!1,chunkSize:n=25e3,...s}){Ci({SplatMaterial:iy});const o=g.useRef(null),a=ae(u=>u.gl),l=ae(u=>u.camera),c=hi(n9,r,u=>{u.gl=a,u.chunkSize=n});return g.useLayoutEffect(()=>c.connect(o.current),[r]),Ve(()=>c.update(o.current,l,i)),g.createElement("mesh",Ae({ref:o,frustumCulled:!1},s),g.createElement("splatMaterial",{key:`${r}/${t}/${i}${iy.key}`,transparent:!i,depthTest:!0,alphaTest:i?0:t,centerAndScaleTexture:c.centerAndScaleTexture,covAndColorTexture:c.covAndColorTexture,depthWrite:i?!0:t>0,blending:i?u_:CE,blendSrcAlpha:IE,alphaHash:!!i,toneMapped:e}))}function In(r,e,t){const i=ae(f=>f.size),n=ae(f=>f.viewport),s=typeof r=="number"?r:i.width*n.dpr,o=typeof e=="number"?e:i.height*n.dpr,a=(typeof r=="number"?t:r)||{},{samples:l=0,depth:c,...u}=a,h=g.useMemo(()=>{const f=new xi(s,o,{minFilter:Nt,magFilter:Nt,type:ui,...u});return c&&(f.depthTexture=new jh(s,o,ri)),f.samples=l,f},[]);return g.useLayoutEffect(()=>{h.setSize(s,o),l&&(h.samples=l)},[l,h,s,o]),g.useEffect(()=>()=>h.dispose(),[]),h}const yU=({children:r,width:e,height:t,...i})=>{const n=In(e,t,i);return g.createElement(g.Fragment,null,r?.(n))},l9=r=>typeof r=="function",c9=g.forwardRef(({envMap:r,resolution:e=256,frames:t=1/0,children:i,makeDefault:n,...s},o)=>{const a=ae(({set:p})=>p),l=ae(({camera:p})=>p),c=ae(({size:p})=>p),u=g.useRef(null);g.useImperativeHandle(o,()=>u.current,[]);const h=g.useRef(null),f=In(e);g.useLayoutEffect(()=>{s.manual||u.current.updateProjectionMatrix()},[c,s]),g.useLayoutEffect(()=>{u.current.updateProjectionMatrix()}),g.useLayoutEffect(()=>{if(n){const p=l;return a(()=>({camera:u.current})),()=>a(()=>({camera:p}))}},[u,n,a]);let d=0,m=null;const A=l9(i);return Ve(p=>{A&&(t===1/0||d<t)&&(h.current.visible=!1,p.gl.setRenderTarget(f),m=p.scene.background,r&&(p.scene.background=r),p.gl.render(p.scene,u.current),p.scene.background=m,p.gl.setRenderTarget(null),h.current.visible=!0,d++)}),g.createElement(g.Fragment,null,g.createElement("orthographicCamera",Ae({left:c.width/-2,right:c.width/2,top:c.height/2,bottom:c.height/-2,ref:u},s),!A&&i),g.createElement("group",{ref:h},A&&i(f.texture)))}),u9=r=>typeof r=="function",vU=g.forwardRef(({envMap:r,resolution:e=256,frames:t=1/0,makeDefault:i,children:n,...s},o)=>{const a=ae(({set:p})=>p),l=ae(({camera:p})=>p),c=ae(({size:p})=>p),u=g.useRef(null);g.useImperativeHandle(o,()=>u.current,[]);const h=g.useRef(null),f=In(e);g.useLayoutEffect(()=>{s.manual||(u.current.aspect=c.width/c.height)},[c,s]),g.useLayoutEffect(()=>{u.current.updateProjectionMatrix()});let d=0,m=null;const A=u9(n);return Ve(p=>{A&&(t===1/0||d<t)&&(h.current.visible=!1,p.gl.setRenderTarget(f),m=p.scene.background,r&&(p.scene.background=r),p.gl.render(p.scene,u.current),p.scene.background=m,p.gl.setRenderTarget(null),h.current.visible=!0,d++)}),g.useLayoutEffect(()=>{if(i){const p=l;return a(()=>({camera:u.current})),()=>a(()=>({camera:p}))}},[u,i,a]),g.createElement(g.Fragment,null,g.createElement("perspectiveCamera",Ae({ref:u},s),!A&&n),g.createElement("group",{ref:h},A&&n(f.texture)))});function h9({resolution:r=256,near:e=.1,far:t=1e3,envMap:i,fog:n}={}){const s=ae(({gl:f})=>f),o=ae(({scene:f})=>f),a=g.useMemo(()=>{const f=new qh(r);return f.texture.type=ui,f},[r]);g.useEffect(()=>()=>{a.dispose()},[a]);const l=g.useMemo(()=>new _E(e,t,a),[e,t,a]);let c,u;const h=g.useCallback(()=>{c=o.fog,u=o.background,o.background=i||u,o.fog=n||c,l.update(s,o),o.fog=c,o.background=u},[s,o,l]);return{fbo:a,camera:l,update:h}}function EU({children:r,frames:e=1/0,resolution:t,near:i,far:n,envMap:s,fog:o,...a}){const l=g.useRef(null),{fbo:c,camera:u,update:h}=h9({resolution:t,near:i,far:n,envMap:s,fog:o});let f=0;return Ve(()=>{l.current&&(e===1/0||f<e)&&(l.current.visible=!1,h(),l.current.visible=!0,f++)}),g.createElement("group",a,g.createElement("primitive",{object:u}),g.createElement("group",{ref:l},r?.(c.texture)))}const xU=g.forwardRef((r,e)=>{const{camera:t,onChange:i,makeDefault:n,...s}=r,o=ae(f=>f.camera),a=ae(f=>f.invalidate),l=ae(f=>f.get),c=ae(f=>f.set),u=t||o,h=g.useMemo(()=>new d6(u),[u]);return g.useEffect(()=>{const f=d=>{a(),i&&i(d)};return h==null||h.addEventListener==null||h.addEventListener("change",f),()=>h==null||h.removeEventListener==null?void 0:h.removeEventListener("change",f)},[i,h,a]),Ve(()=>h?.update(),-1),g.useEffect(()=>{const f=h;return f?.connect(),()=>f?.dispose()},[h]),g.useEffect(()=>{if(n){const f=l().controls;return c({controls:h}),()=>c({controls:f})}},[n,h]),h?g.createElement("primitive",Ae({ref:e,object:h},s)):null}),IU=g.forwardRef(({domElement:r,...e},t)=>{const{onChange:i,makeDefault:n,...s}=e,o=ae(m=>m.invalidate),a=ae(m=>m.camera),l=ae(m=>m.gl),c=ae(m=>m.events),u=ae(m=>m.get),h=ae(m=>m.set),f=r||c.connected||l.domElement,d=g.useMemo(()=>new T6(a),[a]);return g.useEffect(()=>(d.connect(f),()=>void d.dispose()),[f,d,o]),g.useEffect(()=>{const m=A=>{o(),i&&i(A)};return d.addEventListener==null||d.addEventListener("change",m),()=>d.removeEventListener==null?void 0:d.removeEventListener("change",m)},[i,o]),g.useEffect(()=>{if(n){const m=u().controls;return h({controls:d}),()=>h({controls:m})}},[n,d]),Ve((m,A)=>d.update(A)),g.createElement("primitive",Ae({ref:t,object:d,args:[a,f]},s))}),CU=g.forwardRef((r={enableDamping:!0},e)=>{const{domElement:t,camera:i,makeDefault:n,onChange:s,onStart:o,onEnd:a,...l}=r,c=ae(v=>v.invalidate),u=ae(v=>v.camera),h=ae(v=>v.gl),f=ae(v=>v.events),d=ae(v=>v.set),m=ae(v=>v.get),A=t||f.connected||h.domElement,p=i||u,y=g.useMemo(()=>new E6(p),[p]);return g.useEffect(()=>{y.connect(A);const v=E=>{c(),s&&s(E)};return y.addEventListener("change",v),o&&y.addEventListener("start",o),a&&y.addEventListener("end",a),()=>{y.dispose(),y.removeEventListener("change",v),o&&y.removeEventListener("start",o),a&&y.removeEventListener("end",a)}},[s,o,a,y,c,A]),g.useEffect(()=>{if(n){const v=m().controls;return d({controls:y}),()=>d({controls:v})}},[n,y]),Ve(()=>y.update(),-1),g.createElement("primitive",Ae({ref:e,object:y,enableDamping:!0},l))}),_U=g.forwardRef(({makeDefault:r,camera:e,regress:t,domElement:i,enableDamping:n=!0,keyEvents:s=!1,onChange:o,onStart:a,onEnd:l,...c},u)=>{const h=ae(C=>C.invalidate),f=ae(C=>C.camera),d=ae(C=>C.gl),m=ae(C=>C.events),A=ae(C=>C.setEvents),p=ae(C=>C.set),y=ae(C=>C.get),v=ae(C=>C.performance),E=e||f,x=i||m.connected||d.domElement,I=g.useMemo(()=>new G3(E),[E]);return Ve(()=>{I.enabled&&I.update()},-1),g.useEffect(()=>(s&&I.connect(s===!0?x:s),I.connect(x),()=>void I.dispose()),[s,x,t,I,h]),g.useEffect(()=>{const C=b=>{h(),t&&v.regress(),o&&o(b)},_=b=>{a&&a(b)},S=b=>{l&&l(b)};return I.addEventListener("change",C),I.addEventListener("start",_),I.addEventListener("end",S),()=>{I.removeEventListener("start",_),I.removeEventListener("end",S),I.removeEventListener("change",C)}},[o,a,l,I,h,A]),g.useEffect(()=>{if(r){const C=y().controls;return p({controls:I}),()=>p({controls:C})}},[r,I]),g.createElement("primitive",Ae({ref:u,object:I,enableDamping:n},c))}),SU=g.forwardRef(({makeDefault:r,camera:e,domElement:t,regress:i,onChange:n,onStart:s,onEnd:o,...a},l)=>{const{invalidate:c,camera:u,gl:h,events:f,set:d,get:m,performance:A,viewport:p}=ae(),y=e||u,v=t||f.connected||h.domElement,E=g.useMemo(()=>new p6(y),[y]);return Ve(()=>{E.enabled&&E.update()},-1),g.useEffect(()=>(E.connect(v),()=>void E.dispose()),[v,i,E,c]),g.useEffect(()=>{const x=I=>{c(),i&&A.regress(),n&&n(I)};return E.addEventListener("change",x),s&&E.addEventListener("start",s),o&&E.addEventListener("end",o),()=>{s&&E.removeEventListener("start",s),o&&E.removeEventListener("end",o),E.removeEventListener("change",x)}},[n,s,o,E,c]),g.useEffect(()=>{E.handleResize()},[p]),g.useEffect(()=>{if(r){const x=m().controls;return d({controls:E}),()=>d({controls:x})}},[r,E]),g.createElement("primitive",Ae({ref:l,object:E},a))}),TU=g.forwardRef(({camera:r,makeDefault:e,regress:t,domElement:i,onChange:n,onStart:s,onEnd:o,...a},l)=>{const c=ae(E=>E.invalidate),u=ae(E=>E.camera),h=ae(E=>E.gl),f=ae(E=>E.events),d=ae(E=>E.set),m=ae(E=>E.get),A=ae(E=>E.performance),p=r||u,y=i||f.connected||h.domElement,v=g.useMemo(()=>new C6(p),[p]);return Ve(()=>{v.enabled&&v.update()},-1),g.useEffect(()=>(v.connect(y),()=>void v.dispose()),[y,t,v,c]),g.useEffect(()=>{const E=x=>{c(),t&&A.regress(),n&&n(x)};return v.addEventListener("change",E),s&&v.addEventListener("start",s),o&&v.addEventListener("end",o),()=>{v.removeEventListener("change",E),s&&v.removeEventListener("start",s),o&&v.removeEventListener("end",o)}},[n,s,o]),g.useEffect(()=>{if(e){const E=m().controls;return d({controls:v}),()=>d({controls:E})}},[e,v]),g.createElement("primitive",Ae({ref:l,object:v},a))}),bU=g.forwardRef(({children:r,domElement:e,onChange:t,onMouseDown:i,onMouseUp:n,onObjectChange:s,object:o,makeDefault:a,camera:l,enabled:c,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:m,space:A,size:p,showX:y,showY:v,showZ:E,...x},I)=>{const C=ae(D=>D.controls),_=ae(D=>D.gl),S=ae(D=>D.events),b=ae(D=>D.camera),T=ae(D=>D.invalidate),R=ae(D=>D.get),w=ae(D=>D.set),B=l||b,M=e||S.connected||_.domElement,O=g.useMemo(()=>new i6(B,M),[B,M]),U=g.useRef(null);g.useLayoutEffect(()=>(o?O.attach(o instanceof gi?o:o.current):U.current instanceof gi&&O.attach(U.current),()=>void O.detach()),[o,r,O]),g.useEffect(()=>{if(C){const D=z=>C.enabled=!z.value;return O.addEventListener("dragging-changed",D),()=>O.removeEventListener("dragging-changed",D)}},[O,C]);const Y=g.useRef(),W=g.useRef(),N=g.useRef(),K=g.useRef();return g.useLayoutEffect(()=>void(Y.current=t),[t]),g.useLayoutEffect(()=>void(W.current=i),[i]),g.useLayoutEffect(()=>void(N.current=n),[n]),g.useLayoutEffect(()=>void(K.current=s),[s]),g.useEffect(()=>{const D=P=>{T(),Y.current==null||Y.current(P)},z=P=>W.current==null?void 0:W.current(P),$=P=>N.current==null?void 0:N.current(P),V=P=>K.current==null?void 0:K.current(P);return O.addEventListener("change",D),O.addEventListener("mouseDown",z),O.addEventListener("mouseUp",$),O.addEventListener("objectChange",V),()=>{O.removeEventListener("change",D),O.removeEventListener("mouseDown",z),O.removeEventListener("mouseUp",$),O.removeEventListener("objectChange",V)}},[T,O]),g.useEffect(()=>{if(a){const D=R().controls;return w({controls:O}),()=>w({controls:D})}},[a,O]),g.createElement(g.Fragment,null,g.createElement("primitive",{ref:I,object:O,enabled:c,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:m,space:A,size:p,showX:y,showY:v,showZ:E}),g.createElement("group",Ae({ref:U},x),r))}),wU=g.forwardRef(({domElement:r,selector:e,onChange:t,onLock:i,onUnlock:n,enabled:s=!0,makeDefault:o,...a},l)=>{const{camera:c,...u}=a,h=ae(I=>I.setEvents),f=ae(I=>I.gl),d=ae(I=>I.camera),m=ae(I=>I.invalidate),A=ae(I=>I.events),p=ae(I=>I.get),y=ae(I=>I.set),v=c||d,E=r||A.connected||f.domElement,x=g.useMemo(()=>new u6(v),[v]);return g.useEffect(()=>{if(s){x.connect(E);const I=p().events.compute;return h({compute(C,_){const S=_.size.width/2,b=_.size.height/2;_.pointer.set(S/_.size.width*2-1,-(b/_.size.height)*2+1),_.raycaster.setFromCamera(_.pointer,_.camera)}}),()=>{x.disconnect(),h({compute:I})}}},[s,x]),g.useEffect(()=>{const I=S=>{m(),t&&t(S)};x.addEventListener("change",I),i&&x.addEventListener("lock",i),n&&x.addEventListener("unlock",n);const C=()=>x.lock(),_=e?Array.from(document.querySelectorAll(e)):[document];return _.forEach(S=>S&&S.addEventListener("click",C)),()=>{x.removeEventListener("change",I),i&&x.removeEventListener("lock",i),n&&x.removeEventListener("unlock",n),_.forEach(S=>S?S.removeEventListener("click",C):void 0)}},[t,i,n,e,x,m]),g.useEffect(()=>{if(o){const I=p().controls;return y({controls:x}),()=>y({controls:I})}},[o,x]),g.createElement("primitive",Ae({ref:l,object:x},u))}),BU=g.forwardRef(({domElement:r,makeDefault:e,...t},i)=>{const n=ae(h=>h.camera),s=ae(h=>h.gl),o=ae(h=>h.events),a=ae(h=>h.get),l=ae(h=>h.set),c=r||o.connected||s.domElement,[u]=g.useState(()=>new Zb(n,c));return g.useEffect(()=>{if(e){const h=a().controls;return l({controls:u}),()=>l({controls:h})}},[e,u]),Ve((h,f)=>{u.update(f)},-1),u?g.createElement("primitive",Ae({ref:i,object:u},t)):null});/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const mi={LEFT:1,RIGHT:2,MIDDLE:4},de=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,SCREEN_PAN:4,OFFSET:8,DOLLY:16,ZOOM:32,TOUCH_ROTATE:64,TOUCH_TRUCK:128,TOUCH_SCREEN_PAN:256,TOUCH_OFFSET:512,TOUCH_DOLLY:1024,TOUCH_ZOOM:2048,TOUCH_DOLLY_TRUCK:4096,TOUCH_DOLLY_SCREEN_PAN:8192,TOUCH_DOLLY_OFFSET:16384,TOUCH_DOLLY_ROTATE:32768,TOUCH_ZOOM_TRUCK:65536,TOUCH_ZOOM_OFFSET:131072,TOUCH_ZOOM_SCREEN_PAN:262144,TOUCH_ZOOM_ROTATE:524288}),Fo={NONE:0,IN:1,OUT:-1};function to(r){return r.isPerspectiveCamera}function Dr(r){return r.isOrthographicCamera}const ko=Math.PI*2,sy=Math.PI/2,Fx=1e-5,vl=Math.PI/180;function ys(r,e,t){return Math.max(e,Math.min(t,r))}function Zt(r,e=Fx){return Math.abs(r)<e}function Ot(r,e,t=Fx){return Zt(r-e,t)}function ry(r,e){return Math.round(r/e)*e}function El(r){return isFinite(r)?r:r<0?-Number.MAX_VALUE:Number.MAX_VALUE}function xl(r){return Math.abs(r)<Number.MAX_VALUE?r:r*(1/0)}function au(r,e,t,i,n=1/0,s){i=Math.max(1e-4,i);const o=2/i,a=o*s,l=1/(1+a+.48*a*a+.235*a*a*a);let c=r-e;const u=e,h=n*i;c=ys(c,-h,h),e=r-c;const f=(t.value+o*c)*s;t.value=(t.value-o*f)*l;let d=e+(c+f)*l;return u-r>0==d>u&&(d=u,t.value=(d-u)/s),d}function oy(r,e,t,i,n=1/0,s,o){i=Math.max(1e-4,i);const a=2/i,l=a*s,c=1/(1+l+.48*l*l+.235*l*l*l);let u=e.x,h=e.y,f=e.z,d=r.x-u,m=r.y-h,A=r.z-f;const p=u,y=h,v=f,E=n*i,x=E*E,I=d*d+m*m+A*A;if(I>x){const O=Math.sqrt(I);d=d/O*E,m=m/O*E,A=A/O*E}u=r.x-d,h=r.y-m,f=r.z-A;const C=(t.x+a*d)*s,_=(t.y+a*m)*s,S=(t.z+a*A)*s;t.x=(t.x-a*C)*c,t.y=(t.y-a*_)*c,t.z=(t.z-a*S)*c,o.x=u+(d+C)*c,o.y=h+(m+_)*c,o.z=f+(A+S)*c;const b=p-r.x,T=y-r.y,R=v-r.z,w=o.x-p,B=o.y-y,M=o.z-v;return b*w+T*B+R*M>0&&(o.x=p,o.y=y,o.z=v,t.x=(o.x-p)/s,t.y=(o.y-y)/s,t.z=(o.z-v)/s),o}function Td(r,e){e.set(0,0),r.forEach(t=>{e.x+=t.clientX,e.y+=t.clientY}),e.x/=r.length,e.y/=r.length}function bd(r,e){return Dr(r)?(console.warn(`${e} is not supported in OrthographicCamera`),!0):!1}class f9{constructor(){this._listeners={}}addEventListener(e,t){const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){const n=this._listeners[e];if(n!==void 0){const s=n.indexOf(t);s!==-1&&n.splice(s,1)}}removeAllEventListeners(e){if(!e){this._listeners={};return}Array.isArray(this._listeners[e])&&(this._listeners[e].length=0)}dispatchEvent(e){const i=this._listeners[e.type];if(i!==void 0){e.target=this;const n=i.slice(0);for(let s=0,o=n.length;s<o;s++)n[s].call(this,e)}}}var wd;const d9="2.10.1",lu=1/8,m9=/Mac/.test((wd=globalThis?.navigator)===null||wd===void 0?void 0:wd.platform);let ut,ay,cu,Bd,gn,Et,Rt,Oo,Il,Ms,Ls,io,ly,cy,Yn,Cl,Uo,uy,Rd,hy,Dd,Md,uu,Ld=class Im extends f9{static install(e){ut=e.THREE,ay=Object.freeze(new ut.Vector3(0,0,0)),cu=Object.freeze(new ut.Vector3(0,1,0)),Bd=Object.freeze(new ut.Vector3(0,0,1)),gn=new ut.Vector2,Et=new ut.Vector3,Rt=new ut.Vector3,Oo=new ut.Vector3,Il=new ut.Vector3,Ms=new ut.Vector3,Ls=new ut.Vector3,io=new ut.Vector3,ly=new ut.Vector3,cy=new ut.Vector3,Yn=new ut.Spherical,Cl=new ut.Spherical,Uo=new ut.Box3,uy=new ut.Box3,Rd=new ut.Sphere,hy=new ut.Quaternion,Dd=new ut.Quaternion,Md=new ut.Matrix4,uu=new ut.Raycaster}static get ACTION(){return de}set verticalDragToForward(e){console.warn("camera-controls: `verticalDragToForward` was removed. Use `mouseButtons.left = CameraControls.ACTION.SCREEN_PAN` instead.")}constructor(e,t){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=de.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=Fo.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new ut.Vector3,this._focalOffsetVelocity=new ut.Vector3,this._zoomVelocity={value:0},this._truckInternal=(y,v,E,x)=>{let I,C;if(to(this._camera)){const _=Et.copy(this._camera.position).sub(this._target),S=this._camera.getEffectiveFOV()*vl,b=_.length()*Math.tan(S*.5);I=this.truckSpeed*y*b/this._elementRect.height,C=this.truckSpeed*v*b/this._elementRect.height}else if(Dr(this._camera)){const _=this._camera;I=this.truckSpeed*y*(_.right-_.left)/_.zoom/this._elementRect.width,C=this.truckSpeed*v*(_.top-_.bottom)/_.zoom/this._elementRect.height}else return;x?(E?this.setFocalOffset(this._focalOffsetEnd.x+I,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(I,0,!0),this.forward(-C,!0)):E?this.setFocalOffset(this._focalOffsetEnd.x+I,this._focalOffsetEnd.y+C,this._focalOffsetEnd.z,!0):this.truck(I,C,!0)},this._rotateInternal=(y,v)=>{const E=ko*this.azimuthRotateSpeed*y/this._elementRect.height,x=ko*this.polarRotateSpeed*v/this._elementRect.height;this.rotate(E,x,!0)},this._dollyInternal=(y,v,E)=>{const x=Math.pow(.95,-y*this.dollySpeed),I=this._sphericalEnd.radius,C=this._sphericalEnd.radius*x,_=ys(C,this.minDistance,this.maxDistance),S=_-C;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(C,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(S,!0),this._dollyToNoClamp(_,!0)):this._dollyToNoClamp(_,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?C:_)-I,this._dollyControlCoord.set(v,E)),this._lastDollyDirection=Math.sign(-y)},this._zoomInternal=(y,v,E)=>{const x=Math.pow(.95,y*this.dollySpeed),I=this._zoom,C=this._zoom*x;this.zoomTo(C,!0),this.dollyToCursor&&(this._changedZoom+=C-I,this._dollyControlCoord.set(v,E))},typeof ut>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=e,this._yAxisUpSpace=new ut.Quaternion().setFromUnitVectors(this._camera.up,cu),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=de.NONE,this._target=new ut.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new ut.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new ut.Spherical().setFromVector3(Et.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new ut.Vector3,new ut.Vector3,new ut.Vector3,new ut.Vector3],this._updateNearPlaneCorners(),this._boundary=new ut.Box3(new ut.Vector3(-1/0,-1/0,-1/0),new ut.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new ut.Vector2,this.mouseButtons={left:de.ROTATE,middle:de.DOLLY,right:de.TRUCK,wheel:to(this._camera)?de.DOLLY:Dr(this._camera)?de.ZOOM:de.NONE},this.touches={one:de.TOUCH_ROTATE,two:to(this._camera)?de.TOUCH_DOLLY_TRUCK:Dr(this._camera)?de.TOUCH_ZOOM_TRUCK:de.NONE,three:de.TOUCH_TRUCK};const i=new ut.Vector2,n=new ut.Vector2,s=new ut.Vector2,o=y=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const x=this._domElement.getBoundingClientRect(),I=y.clientX/x.width,C=y.clientY/x.height;if(I<this._interactiveArea.left||I>this._interactiveArea.right||C<this._interactiveArea.top||C>this._interactiveArea.bottom)return}const v=y.pointerType!=="mouse"?null:(y.buttons&mi.LEFT)===mi.LEFT?mi.LEFT:(y.buttons&mi.MIDDLE)===mi.MIDDLE?mi.MIDDLE:(y.buttons&mi.RIGHT)===mi.RIGHT?mi.RIGHT:null;if(v!==null){const x=this._findPointerByMouseButton(v);x&&this._disposePointer(x)}if((y.buttons&mi.LEFT)===mi.LEFT&&this._lockedPointer)return;const E={pointerId:y.pointerId,clientX:y.clientX,clientY:y.clientY,deltaX:0,deltaY:0,mouseButton:v};this._activePointers.push(E),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),this._isDragging=!0,f(y)},a=y=>{y.cancelable&&y.preventDefault();const v=y.pointerId,E=this._lockedPointer||this._findPointerById(v);if(E){if(E.clientX=y.clientX,E.clientY=y.clientY,E.deltaX=y.movementX,E.deltaY=y.movementY,this._state=0,y.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(y.buttons&mi.LEFT)===mi.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(y.buttons&mi.MIDDLE)===mi.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(y.buttons&mi.RIGHT)===mi.RIGHT&&(this._state=this._state|this.mouseButtons.right);d()}},l=y=>{const v=this._findPointerById(y.pointerId);if(!(v&&v===this._lockedPointer)){if(v&&this._disposePointer(v),y.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=de.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=de.NONE;m()}};let c=-1;const u=y=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===de.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const C=this._domElement.getBoundingClientRect(),_=y.clientX/C.width,S=y.clientY/C.height;if(_<this._interactiveArea.left||_>this._interactiveArea.right||S<this._interactiveArea.top||S>this._interactiveArea.bottom)return}if(y.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===de.ROTATE||this.mouseButtons.wheel===de.TRUCK){const C=performance.now();c-C<1e3&&this._getClientRect(this._elementRect),c=C}const v=m9?-1:-3,E=y.deltaMode===1||y.ctrlKey?y.deltaY/v:y.deltaY/(v*10),x=this.dollyToCursor?(y.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,I=this.dollyToCursor?(y.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case de.ROTATE:{this._rotateInternal(y.deltaX,y.deltaY),this._isUserControllingRotate=!0;break}case de.TRUCK:{this._truckInternal(y.deltaX,y.deltaY,!1,!1),this._isUserControllingTruck=!0;break}case de.SCREEN_PAN:{this._truckInternal(y.deltaX,y.deltaY,!1,!0),this._isUserControllingTruck=!0;break}case de.OFFSET:{this._truckInternal(y.deltaX,y.deltaY,!0,!1),this._isUserControllingOffset=!0;break}case de.DOLLY:{this._dollyInternal(-E,x,I),this._isUserControllingDolly=!0;break}case de.ZOOM:{this._zoomInternal(-E,x,I),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},h=y=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===Im.ACTION.NONE){const v=y instanceof PointerEvent?y.pointerId:0,E=this._findPointerById(v);E&&this._disposePointer(E),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l);return}y.preventDefault()}},f=y=>{if(!this._enabled)return;if(Td(this._activePointers,gn),this._getClientRect(this._elementRect),i.copy(gn),n.copy(gn),this._activePointers.length>=2){const E=gn.x-this._activePointers[1].clientX,x=gn.y-this._activePointers[1].clientY,I=Math.sqrt(E*E+x*x);s.set(0,I);const C=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,_=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;n.set(C,_)}if(this._state=0,!y)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in y&&y.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(y.buttons&mi.LEFT)===mi.LEFT&&(this._state=this._state|this.mouseButtons.left),(y.buttons&mi.MIDDLE)===mi.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(y.buttons&mi.RIGHT)===mi.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&de.ROTATE)===de.ROTATE||(this._state&de.TOUCH_ROTATE)===de.TOUCH_ROTATE||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&de.TRUCK)===de.TRUCK||(this._state&de.SCREEN_PAN)===de.SCREEN_PAN||(this._state&de.TOUCH_TRUCK)===de.TOUCH_TRUCK||(this._state&de.TOUCH_SCREEN_PAN)===de.TOUCH_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&de.DOLLY)===de.DOLLY||(this._state&de.TOUCH_DOLLY)===de.TOUCH_DOLLY||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&de.ZOOM)===de.ZOOM||(this._state&de.TOUCH_ZOOM)===de.TOUCH_ZOOM||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_ZOOM_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&de.OFFSET)===de.OFFSET||(this._state&de.TOUCH_OFFSET)===de.TOUCH_OFFSET||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},d=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,Td(this._activePointers,gn);const v=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,E=v?-v.deltaX:n.x-gn.x,x=v?-v.deltaY:n.y-gn.y;if(n.copy(gn),((this._state&de.ROTATE)===de.ROTATE||(this._state&de.TOUCH_ROTATE)===de.TOUCH_ROTATE||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(E,x),this._isUserControllingRotate=!0),(this._state&de.DOLLY)===de.DOLLY||(this._state&de.ZOOM)===de.ZOOM){const I=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,C=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,_=this.dollyDragInverted?-1:1;(this._state&de.DOLLY)===de.DOLLY?(this._dollyInternal(_*x*lu,I,C),this._isUserControllingDolly=!0):(this._zoomInternal(_*x*lu,I,C),this._isUserControllingZoom=!0)}if((this._state&de.TOUCH_DOLLY)===de.TOUCH_DOLLY||(this._state&de.TOUCH_ZOOM)===de.TOUCH_ZOOM||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_ZOOM_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_ZOOM_ROTATE)===de.TOUCH_ZOOM_ROTATE){const I=gn.x-this._activePointers[1].clientX,C=gn.y-this._activePointers[1].clientY,_=Math.sqrt(I*I+C*C),S=s.y-_;s.set(0,_);const b=this.dollyToCursor?(n.x-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(n.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&de.TOUCH_DOLLY)===de.TOUCH_DOLLY||(this._state&de.TOUCH_DOLLY_ROTATE)===de.TOUCH_DOLLY_ROTATE||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET?(this._dollyInternal(S*lu,b,T),this._isUserControllingDolly=!0):(this._zoomInternal(S*lu,b,T),this._isUserControllingZoom=!0)}((this._state&de.TRUCK)===de.TRUCK||(this._state&de.TOUCH_TRUCK)===de.TOUCH_TRUCK||(this._state&de.TOUCH_DOLLY_TRUCK)===de.TOUCH_DOLLY_TRUCK||(this._state&de.TOUCH_ZOOM_TRUCK)===de.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(E,x,!1,!1),this._isUserControllingTruck=!0),((this._state&de.SCREEN_PAN)===de.SCREEN_PAN||(this._state&de.TOUCH_SCREEN_PAN)===de.TOUCH_SCREEN_PAN||(this._state&de.TOUCH_DOLLY_SCREEN_PAN)===de.TOUCH_DOLLY_SCREEN_PAN||(this._state&de.TOUCH_ZOOM_SCREEN_PAN)===de.TOUCH_ZOOM_SCREEN_PAN)&&(this._truckInternal(E,x,!1,!0),this._isUserControllingTruck=!0),((this._state&de.OFFSET)===de.OFFSET||(this._state&de.TOUCH_OFFSET)===de.TOUCH_OFFSET||(this._state&de.TOUCH_DOLLY_OFFSET)===de.TOUCH_DOLLY_OFFSET||(this._state&de.TOUCH_ZOOM_OFFSET)===de.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(E,x,!0,!1),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},m=()=>{Td(this._activePointers,gn),n.copy(gn),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",A),this._domElement.ownerDocument.addEventListener("pointerlockerror",p),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",l),f())},this.unlockPointer=()=>{var y,v,E;this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),(y=this._domElement)===null||y===void 0||y.ownerDocument.exitPointerLock(),(v=this._domElement)===null||v===void 0||v.ownerDocument.removeEventListener("pointerlockchange",A),(E=this._domElement)===null||E===void 0||E.ownerDocument.removeEventListener("pointerlockerror",p),this.cancel()};const A=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},p=()=>{this.unlockPointer()};this._addAllEventListeners=y=>{this._domElement=y,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",o),this._domElement.addEventListener("pointercancel",l),this._domElement.addEventListener("wheel",u,{passive:!1}),this._domElement.addEventListener("contextmenu",h)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",o),this._domElement.removeEventListener("pointercancel",l),this._domElement.removeEventListener("wheel",u,{passive:!1}),this._domElement.removeEventListener("contextmenu",h),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",l),this._domElement.ownerDocument.removeEventListener("pointerlockchange",A),this._domElement.ownerDocument.removeEventListener("pointerlockerror",p))},this.cancel=()=>{this._state!==de.NONE&&(this._state=de.NONE,this._activePointers.length=0,m())},t&&this.connect(t),this.update(0)}get camera(){return this._camera}set camera(e){this._camera=e,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._domElement&&(e?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(e){this._spherical.radius===e&&this._sphericalEnd.radius===e||(this._spherical.radius=e,this._sphericalEnd.radius=e,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(e){this._spherical.theta===e&&this._sphericalEnd.theta===e||(this._spherical.theta=e,this._sphericalEnd.theta=e,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(e){this._spherical.phi===e&&this._sphericalEnd.phi===e||(this._spherical.phi=e,this._sphericalEnd.phi=e,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(e){this._boundaryEnclosesCamera=e,this._needsUpdate=!0}set interactiveArea(e){this._interactiveArea.width=ys(e.width,0,1),this._interactiveArea.height=ys(e.height,0,1),this._interactiveArea.x=ys(e.x,0,1-this._interactiveArea.width),this._interactiveArea.y=ys(e.y,0,1-this._interactiveArea.height)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}rotate(e,t,i=!1){return this.rotateTo(this._sphericalEnd.theta+e,this._sphericalEnd.phi+t,i)}rotateAzimuthTo(e,t=!1){return this.rotateTo(e,this._sphericalEnd.phi,t)}rotatePolarTo(e,t=!1){return this.rotateTo(this._sphericalEnd.theta,e,t)}rotateTo(e,t,i=!1){this._isUserControllingRotate=!1;const n=ys(e,this.minAzimuthAngle,this.maxAzimuthAngle),s=ys(t,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=n,this._sphericalEnd.phi=s,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const o=!i||Ot(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ot(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(o)}dolly(e,t=!1){return this.dollyTo(this._sphericalEnd.radius-e,t)}dollyTo(e,t=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=Fo.NONE,this._changedDolly=0,this._dollyToNoClamp(ys(e,this.minDistance,this.maxDistance),t)}_dollyToNoClamp(e,t=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const o=this._collisionTest(),a=Ot(o,this._spherical.radius);if(!(i>e)&&a)return Promise.resolve();this._sphericalEnd.radius=Math.min(e,o)}else this._sphericalEnd.radius=e;this._needsUpdate=!0,t||(this._spherical.radius=this._sphericalEnd.radius);const s=!t||Ot(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(s)}dollyInFixed(e,t=!1){this._targetEnd.add(this._getCameraDirection(Il).multiplyScalar(e)),t||this._target.copy(this._targetEnd);const i=!t||Ot(this._target.x,this._targetEnd.x,this.restThreshold)&&Ot(this._target.y,this._targetEnd.y,this.restThreshold)&&Ot(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(e,t=!1){return this.zoomTo(this._zoomEnd+e,t)}zoomTo(e,t=!1){this._isUserControllingZoom=!1,this._zoomEnd=ys(e,this.minZoom,this.maxZoom),this._needsUpdate=!0,t||(this._zoom=this._zoomEnd);const i=!t||Ot(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(e,t,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(e,t,i)}truck(e,t,i=!1){this._camera.updateMatrix(),Ms.setFromMatrixColumn(this._camera.matrix,0),Ls.setFromMatrixColumn(this._camera.matrix,1),Ms.multiplyScalar(e),Ls.multiplyScalar(-t);const n=Et.copy(Ms).add(Ls),s=Rt.copy(this._targetEnd).add(n);return this.moveTo(s.x,s.y,s.z,i)}forward(e,t=!1){Et.setFromMatrixColumn(this._camera.matrix,0),Et.crossVectors(this._camera.up,Et),Et.multiplyScalar(e);const i=Rt.copy(this._targetEnd).add(Et);return this.moveTo(i.x,i.y,i.z,t)}elevate(e,t=!1){return Et.copy(this._camera.up).multiplyScalar(e),this.moveTo(this._targetEnd.x+Et.x,this._targetEnd.y+Et.y,this._targetEnd.z+Et.z,t)}moveTo(e,t,i,n=!1){this._isUserControllingTruck=!1;const s=Et.set(e,t,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,s,this.boundaryFriction),this._needsUpdate=!0,n||this._target.copy(this._targetEnd);const o=!n||Ot(this._target.x,this._targetEnd.x,this.restThreshold)&&Ot(this._target.y,this._targetEnd.y,this.restThreshold)&&Ot(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(o)}lookInDirectionOf(e,t,i,n=!1){const a=Et.set(e,t,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(a.x,a.y,a.z,n)}fitToBox(e,t,{cover:i=!1,paddingLeft:n=0,paddingRight:s=0,paddingBottom:o=0,paddingTop:a=0}={}){const l=[],c=e.isBox3?Uo.copy(e):Uo.setFromObject(e);c.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const u=ry(this._sphericalEnd.theta,sy),h=ry(this._sphericalEnd.phi,sy);l.push(this.rotateTo(u,h,t));const f=Et.setFromSpherical(this._sphericalEnd).normalize(),d=hy.setFromUnitVectors(f,Bd),m=Ot(Math.abs(f.y),1);m&&d.multiply(Dd.setFromAxisAngle(cu,u)),d.multiply(this._yAxisUpSpaceInverse);const A=uy.makeEmpty();Rt.copy(c.min).applyQuaternion(d),A.expandByPoint(Rt),Rt.copy(c.min).setX(c.max.x).applyQuaternion(d),A.expandByPoint(Rt),Rt.copy(c.min).setY(c.max.y).applyQuaternion(d),A.expandByPoint(Rt),Rt.copy(c.max).setZ(c.min.z).applyQuaternion(d),A.expandByPoint(Rt),Rt.copy(c.min).setZ(c.max.z).applyQuaternion(d),A.expandByPoint(Rt),Rt.copy(c.max).setY(c.min.y).applyQuaternion(d),A.expandByPoint(Rt),Rt.copy(c.max).setX(c.min.x).applyQuaternion(d),A.expandByPoint(Rt),Rt.copy(c.max).applyQuaternion(d),A.expandByPoint(Rt),A.min.x-=n,A.min.y-=o,A.max.x+=s,A.max.y+=a,d.setFromUnitVectors(Bd,f),m&&d.premultiply(Dd.invert()),d.premultiply(this._yAxisUpSpace);const p=A.getSize(Et),y=A.getCenter(Rt).applyQuaternion(d);if(to(this._camera)){const v=this.getDistanceToFitBox(p.x,p.y,p.z,i);l.push(this.moveTo(y.x,y.y,y.z,t)),l.push(this.dollyTo(v,t)),l.push(this.setFocalOffset(0,0,0,t))}else if(Dr(this._camera)){const v=this._camera,E=v.right-v.left,x=v.top-v.bottom,I=i?Math.max(E/p.x,x/p.y):Math.min(E/p.x,x/p.y);l.push(this.moveTo(y.x,y.y,y.z,t)),l.push(this.zoomTo(I,t)),l.push(this.setFocalOffset(0,0,0,t))}return Promise.all(l)}fitToSphere(e,t){const i=[],s="isObject3D"in e?Im.createBoundingSphere(e,Rd):Rd.copy(e);if(i.push(this.moveTo(s.center.x,s.center.y,s.center.z,t)),to(this._camera)){const o=this.getDistanceToFitSphere(s.radius);i.push(this.dollyTo(o,t))}else if(Dr(this._camera)){const o=this._camera.right-this._camera.left,a=this._camera.top-this._camera.bottom,l=2*s.radius,c=Math.min(o/l,a/l);i.push(this.zoomTo(c,t))}return i.push(this.setFocalOffset(0,0,0,t)),Promise.all(i)}setLookAt(e,t,i,n,s,o,a=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Fo.NONE,this._changedDolly=0;const l=Rt.set(n,s,o),c=Et.set(e,t,i);this._targetEnd.copy(l),this._sphericalEnd.setFromVector3(c.sub(l).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,a||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const u=!a||Ot(this._target.x,this._targetEnd.x,this.restThreshold)&&Ot(this._target.y,this._targetEnd.y,this.restThreshold)&&Ot(this._target.z,this._targetEnd.z,this.restThreshold)&&Ot(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ot(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ot(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(u)}lerpLookAt(e,t,i,n,s,o,a,l,c,u,h,f,d,m=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Fo.NONE,this._changedDolly=0;const A=Et.set(n,s,o),p=Rt.set(e,t,i);Yn.setFromVector3(p.sub(A).applyQuaternion(this._yAxisUpSpace));const y=Oo.set(u,h,f),v=Rt.set(a,l,c);Cl.setFromVector3(v.sub(y).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(A.lerp(y,d));const E=Cl.theta-Yn.theta,x=Cl.phi-Yn.phi,I=Cl.radius-Yn.radius;this._sphericalEnd.set(Yn.radius+I*d,Yn.phi+x*d,Yn.theta+E*d),this.normalizeRotations(),this._needsUpdate=!0,m||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const C=!m||Ot(this._target.x,this._targetEnd.x,this.restThreshold)&&Ot(this._target.y,this._targetEnd.y,this.restThreshold)&&Ot(this._target.z,this._targetEnd.z,this.restThreshold)&&Ot(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ot(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ot(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(C)}setPosition(e,t,i,n=!1){return this.setLookAt(e,t,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,n)}setTarget(e,t,i,n=!1){const s=this.getPosition(Et),o=this.setLookAt(s.x,s.y,s.z,e,t,i,n);return this._sphericalEnd.phi=ys(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),o}setFocalOffset(e,t,i,n=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(e,t,i),this._needsUpdate=!0,n||this._focalOffset.copy(this._focalOffsetEnd);const s=!n||Ot(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Ot(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Ot(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}setOrbitPoint(e,t,i){this._camera.updateMatrixWorld(),Ms.setFromMatrixColumn(this._camera.matrixWorldInverse,0),Ls.setFromMatrixColumn(this._camera.matrixWorldInverse,1),io.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const n=Et.set(e,t,i),s=n.distanceTo(this._camera.position),o=n.sub(this._camera.position);Ms.multiplyScalar(o.x),Ls.multiplyScalar(o.y),io.multiplyScalar(o.z),Et.copy(Ms).add(Ls).add(io),Et.z=Et.z+s,this.dollyTo(s,!1),this.setFocalOffset(-Et.x,Et.y,-Et.z,!1),this.moveTo(e,t,i,!1)}setBoundary(e){if(!e){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(e),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(e,t,i,n){if(e===null){this._viewport=null;return}this._viewport=this._viewport||new ut.Vector4,typeof e=="number"?this._viewport.set(e,t,i,n):this._viewport.copy(e)}getDistanceToFitBox(e,t,i,n=!1){if(bd(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const s=e/t,o=this._camera.getEffectiveFOV()*vl,a=this._camera.aspect;return((n?s>a:s<a)?t:e/a)*.5/Math.tan(o*.5)+i*.5}getDistanceToFitSphere(e){if(bd(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const t=this._camera.getEffectiveFOV()*vl,i=Math.atan(Math.tan(t*.5)*this._camera.aspect)*2,n=1<this._camera.aspect?t:i;return e/Math.sin(n*.5)}getTarget(e,t=!0){return(e&&e.isVector3?e:new ut.Vector3).copy(t?this._targetEnd:this._target)}getPosition(e,t=!0){return(e&&e.isVector3?e:new ut.Vector3).setFromSpherical(t?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(t?this._targetEnd:this._target)}getSpherical(e,t=!0){return(e||new ut.Spherical).copy(t?this._sphericalEnd:this._spherical)}getFocalOffset(e,t=!0){return(e&&e.isVector3?e:new ut.Vector3).copy(t?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%ko,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=ko),this._spherical.theta+=ko*Math.round((this._sphericalEnd.theta-this._spherical.theta)/ko)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(e=!1){if(!Ot(this._camera.up.x,this._cameraUp0.x)||!Ot(this._camera.up.y,this._cameraUp0.y)||!Ot(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const i=this.getPosition(Et);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}const t=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,e),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,e),this.zoomTo(this._zoom0,e)];return Promise.all(t)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,cu),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const e=Et.subVectors(this._target,this._camera.position).normalize(),t=Rt.crossVectors(e,this._camera.up);this._camera.up.crossVectors(t,e).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(Et);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(e){const t=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,n=this._sphericalEnd.radius-this._spherical.radius,s=ly.subVectors(this._targetEnd,this._target),o=cy.subVectors(this._focalOffsetEnd,this._focalOffset),a=this._zoomEnd-this._zoom;if(Zt(t))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=au(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,h,1/0,e),this._needsUpdate=!0}if(Zt(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=au(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,h,1/0,e),this._needsUpdate=!0}if(Zt(n))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const h=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=au(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,h,this.maxSpeed,e),this._needsUpdate=!0}if(Zt(s.x)&&Zt(s.y)&&Zt(s.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const h=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;oy(this._target,this._targetEnd,this._targetVelocity,h,this.maxSpeed,e,this._target),this._needsUpdate=!0}if(Zt(o.x)&&Zt(o.y)&&Zt(o.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const h=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;oy(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,h,this.maxSpeed,e,this._focalOffset),this._needsUpdate=!0}if(Zt(a))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const h=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=au(this._zoom,this._zoomEnd,this._zoomVelocity,h,1/0,e)}if(this.dollyToCursor){if(to(this._camera)&&this._changedDolly!==0){const h=this._spherical.radius-this._lastDistance,f=this._camera,d=this._getCameraDirection(Il),m=Et.copy(d).cross(f.up).normalize();m.lengthSq()===0&&(m.x=1);const A=Rt.crossVectors(m,d),p=this._sphericalEnd.radius*Math.tan(f.getEffectiveFOV()*vl*.5),v=(this._sphericalEnd.radius-h-this._sphericalEnd.radius)/this._sphericalEnd.radius,E=Oo.copy(this._targetEnd).add(m.multiplyScalar(this._dollyControlCoord.x*p*f.aspect)).add(A.multiplyScalar(this._dollyControlCoord.y*p)),x=Et.copy(this._targetEnd).lerp(E,v),I=this._lastDollyDirection===Fo.IN&&this._spherical.radius<=this.minDistance,C=this._lastDollyDirection===Fo.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(I||C)){this._sphericalEnd.radius-=h,this._spherical.radius-=h;const S=Rt.copy(d).multiplyScalar(-h);x.add(S)}this._boundary.clampPoint(x,x);const _=Rt.subVectors(x,this._targetEnd);this._targetEnd.copy(x),this._target.add(_),this._changedDolly-=h,Zt(this._changedDolly)&&(this._changedDolly=0)}else if(Dr(this._camera)&&this._changedZoom!==0){const h=this._zoom-this._lastZoom,f=this._camera,d=Et.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(f.near+f.far)/(f.near-f.far)).unproject(f),m=Rt.set(0,0,-1).applyQuaternion(f.quaternion),A=Oo.copy(d).add(m.multiplyScalar(-d.dot(f.up))),y=-(this._zoom-h-this._zoom)/this._zoom,v=this._getCameraDirection(Il),E=this._targetEnd.dot(v),x=Et.copy(this._targetEnd).lerp(A,y),I=x.dot(v),C=v.multiplyScalar(I-E);x.sub(C),this._boundary.clampPoint(x,x);const _=Rt.subVectors(x,this._targetEnd);this._targetEnd.copy(x),this._target.add(_),this._changedZoom-=h,Zt(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const l=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,l),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!Zt(this._focalOffset.x)||!Zt(this._focalOffset.y)||!Zt(this._focalOffset.z))&&(Ms.setFromMatrixColumn(this._camera.matrix,0),Ls.setFromMatrixColumn(this._camera.matrix,1),io.setFromMatrixColumn(this._camera.matrix,2),Ms.multiplyScalar(this._focalOffset.x),Ls.multiplyScalar(-this._focalOffset.y),io.multiplyScalar(this._focalOffset.z),Et.copy(Ms).add(Ls).add(io),this._camera.position.add(Et),this._camera.updateMatrixWorld()),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),Et.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const u=this._needsUpdate;return u&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):u?(this.dispatchEvent({type:"update"}),Zt(t,this.restThreshold)&&Zt(i,this.restThreshold)&&Zt(n,this.restThreshold)&&Zt(s.x,this.restThreshold)&&Zt(s.y,this.restThreshold)&&Zt(s.z,this.restThreshold)&&Zt(o.x,this.restThreshold)&&Zt(o.y,this.restThreshold)&&Zt(o.z,this.restThreshold)&&Zt(a,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!u&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=u,this._needsUpdate=!1,u}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:El(this.maxDistance),minZoom:this.minZoom,maxZoom:El(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:El(this.maxPolarAngle),minAzimuthAngle:El(this.minAzimuthAngle),maxAzimuthAngle:El(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,target:this._targetEnd.toArray(),position:Et.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(e,t=!1){const i=JSON.parse(e);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=xl(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=xl(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=xl(i.maxPolarAngle),this.minAzimuthAngle=xl(i.minAzimuthAngle),this.maxAzimuthAngle=xl(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],t),Yn.setFromVector3(Et.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(Yn.theta,Yn.phi,t),this.dollyTo(Yn.radius,t),this.zoomTo(i.zoom,t),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],t),this._needsUpdate=!0}connect(e){if(this._domElement){console.warn("camera-controls is already connected.");return}e.setAttribute("data-camera-controls-version",d9),this._addAllEventListeners(e),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(e){return e.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(e){return this._getTargetDirection(e).negate()}_findPointerById(e){return this._activePointers.find(t=>t.pointerId===e)}_findPointerByMouseButton(e){return this._activePointers.find(t=>t.mouseButton===e)}_disposePointer(e){this._activePointers.splice(this._activePointers.indexOf(e),1)}_encloseToBoundary(e,t,i){const n=t.lengthSq();if(n===0)return e;const s=Rt.copy(t).add(e),a=this._boundary.clampPoint(s,Oo).sub(s),l=a.lengthSq();if(l===0)return e.add(t);if(l===n)return e;if(i===0)return e.add(t).add(a);{const c=1+i*l/t.dot(a);return e.add(Rt.copy(t).multiplyScalar(c)).add(a.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(to(this._camera)){const e=this._camera,t=e.near,i=e.getEffectiveFOV()*vl,n=Math.tan(i*.5)*t,s=n*e.aspect;this._nearPlaneCorners[0].set(-s,-n,0),this._nearPlaneCorners[1].set(s,-n,0),this._nearPlaneCorners[2].set(s,n,0),this._nearPlaneCorners[3].set(-s,n,0)}else if(Dr(this._camera)){const e=this._camera,t=1/e.zoom,i=e.left*t,n=e.right*t,s=e.top*t,o=e.bottom*t;this._nearPlaneCorners[0].set(i,s,0),this._nearPlaneCorners[1].set(n,s,0),this._nearPlaneCorners[2].set(n,o,0),this._nearPlaneCorners[3].set(i,o,0)}}_collisionTest(){let e=1/0;if(!(this.colliderMeshes.length>=1)||bd(this._camera,"_collisionTest"))return e;const i=this._getTargetDirection(Il);Md.lookAt(ay,i,this._camera.up);for(let n=0;n<4;n++){const s=Rt.copy(this._nearPlaneCorners[n]);s.applyMatrix4(Md);const o=Oo.addVectors(this._target,s);uu.set(o,i),uu.far=this._spherical.radius+1;const a=uu.intersectObjects(this.colliderMeshes);a.length!==0&&a[0].distance<e&&(e=a[0].distance)}return e}_getClientRect(e){if(!this._domElement)return;const t=this._domElement.getBoundingClientRect();return e.x=t.left,e.y=t.top,this._viewport?(e.x+=this._viewport.x,e.y+=t.height-this._viewport.w-this._viewport.y,e.width=this._viewport.z,e.height=this._viewport.w):(e.width=t.width,e.height=t.height),e}_createOnRestPromise(e){return e?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{const i=()=>{this.removeEventListener("rest",i),t()};this.addEventListener("rest",i)}))}_addAllEventListeners(e){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(e){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(e){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(e,t=new ut.Sphere){const i=t,n=i.center;Uo.makeEmpty(),e.traverseVisible(o=>{o.isMesh&&Uo.expandByObject(o)}),Uo.getCenter(n);let s=0;return e.traverseVisible(o=>{if(!o.isMesh)return;const a=o;if(!a.geometry)return;const l=a.geometry.clone();l.applyMatrix4(a.matrixWorld);const u=l.attributes.position;for(let h=0,f=u.count;h<f;h++)Et.fromBufferAttribute(u,h),s=Math.max(s,n.distanceToSquared(Et))}),i.radius=Math.sqrt(s),i}};const RU=g.forwardRef((r,e)=>{g.useMemo(()=>{const I={Box3:Jt,MathUtils:{clamp:tt.clamp},Matrix4:we,Quaternion:st,Raycaster:$h,Sphere:hn,Spherical:wa,Vector2:De,Vector3:Q,Vector4:yi};Ld.install({THREE:I}),Ci({CameraControlsImpl:Ld})},[]);const{camera:t,domElement:i,makeDefault:n,onStart:s,onEnd:o,onChange:a,regress:l,...c}=r,u=ae(I=>I.camera),h=ae(I=>I.gl),f=ae(I=>I.invalidate),d=ae(I=>I.events),m=ae(I=>I.setEvents),A=ae(I=>I.set),p=ae(I=>I.get),y=ae(I=>I.performance),v=t||u,E=i||d.connected||h.domElement,x=g.useMemo(()=>new Ld(v),[v]);return Ve((I,C)=>{x.enabled&&x.update(C)},-1),g.useEffect(()=>(x.connect(E),()=>void x.disconnect()),[E,x]),g.useEffect(()=>{const I=S=>{f(),l&&y.regress(),a&&a(S)},C=S=>{s&&s(S)},_=S=>{o&&o(S)};return x.addEventListener("update",I),x.addEventListener("controlstart",C),x.addEventListener("controlend",_),x.addEventListener("control",I),x.addEventListener("transitionstart",I),x.addEventListener("wake",I),()=>{x.removeEventListener("update",I),x.removeEventListener("controlstart",C),x.removeEventListener("controlend",_),x.removeEventListener("control",I),x.removeEventListener("transitionstart",I),x.removeEventListener("wake",I)}},[x,s,o,f,m,l,a]),g.useEffect(()=>{if(n){const I=p().controls;return A({controls:x}),()=>A({controls:I})}},[n,x]),g.createElement("primitive",Ae({ref:e,object:x},c))}),A9=r=>r?.current instanceof gi,kx=g.createContext(null);function p9(){const r=g.useContext(kx);if(!r)throw new Error("useMotion hook must be used in a MotionPathControls component.");return r}function g9({points:r=50,color:e="black"}){const{path:t}=p9(),[i,n]=g.useState([]),s=g.useMemo(()=>new Cs({color:e}),[e]),o=g.useMemo(()=>new lE(.025,16,16),[]),a=g.useRef([]);return g.useEffect(()=>{t.curves!==a.current&&(n(t.getPoints(r)),a.current=t.curves)}),i.map((l,c)=>g.createElement("mesh",{key:c,material:s,geometry:o,position:[l.x,l.y,l.z]}))}const DU=g.forwardRef(({children:r,curves:e=[],debug:t=!1,debugColor:i="black",object:n,focus:s,loop:o=!0,offset:a=void 0,smooth:l=!1,eps:c=1e-5,damping:u=.1,focusDamping:h=.1,maxSpeed:f=1/0,...d},m)=>{const{camera:A}=ae(),p=g.useRef(null),y=g.useRef(a??0),v=g.useMemo(()=>new h_,[]),E=g.useMemo(()=>({focus:s,object:n?.current instanceof gi?n:{current:A},path:v,current:y.current,offset:y.current,point:new Q,tangent:new Q,next:new Q}),[s,n]);g.useLayoutEffect(()=>{var I,C;v.curves=[];const _=e.length>0?e:(I=(C=p.current)==null||(C=C.__r3f)==null?void 0:C.objects)!==null&&I!==void 0?I:[];for(let S=0;S<_.length;S++)v.add(_[S]);if(l){const S=v.getPoints(typeof l=="number"?l:1),b=new vE(S);v.curves=[b]}v.updateArcLengths()}),g.useImperativeHandle(m,()=>Object.assign(p.current,{motion:E}),[E]),g.useLayoutEffect(()=>{y.current=Hc.repeat(y.current,1)},[a]);const x=g.useMemo(()=>new Q,[]);return Ve((I,C)=>{const _=E.offset;if(Da.damp(y,"current",a!==void 0?a:E.current,u,C,f,void 0,c),E.offset=o?Hc.repeat(y.current,1):Hc.clamp(y.current,0,1),v.getCurveLengths().length>0){v.getPointAt(E.offset,E.point),v.getTangentAt(E.offset,E.tangent).normalize(),v.getPointAt(Hc.repeat(y.current-(_-E.offset),1),E.next);const S=n?.current instanceof gi?n.current:A;S.position.copy(E.point),s&&Da.dampLookAt(S,A9(s)?s.current.getWorldPosition(x):s,h,C,f,void 0,c)}}),g.createElement("group",Ae({ref:p},d),g.createElement(kx.Provider,{value:E},r,t&&g.createElement(g9,{color:i})))});function y9({defaultScene:r,defaultCamera:e,renderPriority:t=1}){const{gl:i,scene:n,camera:s}=ae();let o;return Ve(()=>{o=i.autoClear,t===1&&(i.autoClear=!0,i.render(r,e)),i.autoClear=!1,i.clearDepth(),i.render(n,s),i.autoClear=o},t),g.createElement("group",{onPointerOver:()=>null})}function v9({children:r,renderPriority:e=1}){const{scene:t,camera:i}=ae(),[n]=g.useState(()=>new Wr);return g.createElement(g.Fragment,null,vo(g.createElement(g.Fragment,null,r,g.createElement(y9,{defaultScene:t,defaultCamera:i,renderPriority:e})),n,{events:{priority:e+1}}))}const Ox=g.createContext({}),kA=()=>g.useContext(Ox),E9=2*Math.PI,Pd=new gi,fy=new we,[No,Fd]=[new st,new st],dy=new Q,my=new Q,x9=r=>"minPolarAngle"in r,Ay=r=>"getTarget"in r,MU=({alignment:r="bottom-right",margin:e=[80,80],renderPriority:t=1,onUpdate:i,onTarget:n,children:s})=>{const o=ae(C=>C.size),a=ae(C=>C.camera),l=ae(C=>C.controls),c=ae(C=>C.invalidate),u=g.useRef(null),h=g.useRef(null),f=g.useRef(!1),d=g.useRef(0),m=g.useRef(new Q(0,0,0)),A=g.useRef(new Q(0,0,0));g.useEffect(()=>{A.current.copy(a.up),Pd.up.copy(a.up)},[a]);const p=g.useCallback(C=>{f.current=!0,(l||n)&&(m.current=n?.()||(Ay(l)?l.getTarget(m.current):l?.target)),d.current=a.position.distanceTo(dy),No.copy(a.quaternion),my.copy(C).multiplyScalar(d.current).add(dy),Pd.lookAt(my),Fd.copy(Pd.quaternion),c()},[l,a,n,c]);Ve((C,_)=>{if(h.current&&u.current){var S;if(f.current)if(No.angleTo(Fd)<.01)f.current=!1,x9(l)&&a.up.copy(A.current);else{const b=_*E9;No.rotateTowards(Fd,b),a.position.set(0,0,1).applyQuaternion(No).multiplyScalar(d.current).add(m.current),a.up.set(0,1,0).applyQuaternion(No).normalize(),a.quaternion.copy(No),Ay(l)&&l.setPosition(a.position.x,a.position.y,a.position.z),i?i():l&&l.update(_),c()}fy.copy(a.matrix).invert(),(S=u.current)==null||S.quaternion.setFromRotationMatrix(fy)}});const y=g.useMemo(()=>({tweenCamera:p}),[p]),[v,E]=e,x=r.endsWith("-center")?0:r.endsWith("-left")?-o.width/2+v:o.width/2-v,I=r.startsWith("center-")?0:r.startsWith("top-")?o.height/2-E:-o.height/2+E;return g.createElement(v9,{renderPriority:t},g.createElement(Ox.Provider,{value:y},g.createElement(c9,{makeDefault:!0,ref:h,position:[0,0,200]}),g.createElement("group",{ref:u,position:[x,I,0]},s)))},zl={bg:"#f0f0f0",hover:"#999",text:"black",stroke:"black"},I9=["Right","Left","Top","Bottom","Front","Back"],Ux=r=>new Q(...r).multiplyScalar(.38),C9=[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].map(Ux),_9=[.25,.25,.25],Nx=[[1,1,0],[1,0,1],[1,0,-1],[1,-1,0],[0,1,1],[0,1,-1],[0,-1,1],[0,-1,-1],[-1,1,0],[-1,0,1],[-1,0,-1],[-1,-1,0]].map(Ux),S9=Nx.map(r=>r.toArray().map(e=>e==0?.5:.25)),T9=({hover:r,index:e,font:t="20px Inter var, Arial, sans-serif",faces:i=I9,color:n=zl.bg,hoverColor:s=zl.hover,textColor:o=zl.text,strokeColor:a=zl.stroke,opacity:l=1})=>{const c=ae(h=>h.gl),u=g.useMemo(()=>{const h=document.createElement("canvas");h.width=128,h.height=128;const f=h.getContext("2d");return f.fillStyle=n,f.fillRect(0,0,h.width,h.height),f.strokeStyle=a,f.strokeRect(0,0,h.width,h.height),f.font=t,f.textAlign="center",f.fillStyle=o,f.fillText(i[e].toUpperCase(),64,76),new SE(h)},[e,i,t,n,o,a]);return g.createElement("meshBasicMaterial",{map:u,"map-anisotropy":c.capabilities.getMaxAnisotropy()||1,attach:`material-${e}`,color:r?s:"white",transparent:!0,opacity:l})},b9=r=>{const{tweenCamera:e}=kA(),[t,i]=g.useState(null),n=a=>{a.stopPropagation(),i(null)},s=a=>{a.stopPropagation(),e(a.face.normal)},o=a=>{a.stopPropagation(),i(Math.floor(a.faceIndex/2))};return g.createElement("mesh",{onPointerOut:n,onPointerMove:o,onClick:r.onClick||s},[...Array(6)].map((a,l)=>g.createElement(T9,Ae({key:l,index:l,hover:t===l},r))),g.createElement("boxGeometry",null))},py=({onClick:r,dimensions:e,position:t,hoverColor:i=zl.hover})=>{const{tweenCamera:n}=kA(),[s,o]=g.useState(!1),a=u=>{u.stopPropagation(),o(!1)},l=u=>{u.stopPropagation(),o(!0)},c=u=>{u.stopPropagation(),n(t)};return g.createElement("mesh",{scale:1.01,position:t,onPointerOver:l,onPointerOut:a,onClick:r||c},g.createElement("meshBasicMaterial",{color:s?i:"white",transparent:!0,opacity:.6,visible:s}),g.createElement("boxGeometry",{args:e}))},LU=r=>g.createElement("group",{scale:[60,60,60]},g.createElement(b9,r),Nx.map((e,t)=>g.createElement(py,Ae({key:t,position:e,dimensions:S9[t]},r))),C9.map((e,t)=>g.createElement(py,Ae({key:t,position:e,dimensions:_9},r))));function kd({scale:r=[.8,.05,.05],color:e,rotation:t}){return g.createElement("group",{rotation:t},g.createElement("mesh",{position:[.4,0,0]},g.createElement("boxGeometry",{args:r}),g.createElement("meshBasicMaterial",{color:e,toneMapped:!1})))}function Go({onClick:r,font:e,disabled:t,arcStyle:i,label:n,labelColor:s,axisHeadScale:o=1,...a}){const l=ae(A=>A.gl),c=g.useMemo(()=>{const A=document.createElement("canvas");A.width=64,A.height=64;const p=A.getContext("2d");return p.beginPath(),p.arc(32,32,16,0,2*Math.PI),p.closePath(),p.fillStyle=i,p.fill(),n&&(p.font=e,p.textAlign="center",p.fillStyle=s,p.fillText(n,32,41)),new SE(A)},[i,n,s,e]),[u,h]=g.useState(!1),f=(n?1:.75)*(u?1.2:1)*o,d=A=>{A.stopPropagation(),h(!0)},m=A=>{A.stopPropagation(),h(!1)};return g.createElement("sprite",Ae({scale:f,onPointerOver:t?void 0:d,onPointerOut:t?void 0:r||m},a),g.createElement("spriteMaterial",{map:c,"map-anisotropy":l.capabilities.getMaxAnisotropy()||1,alphaTest:.3,opacity:n?1:.75,toneMapped:!1}))}const PU=({hideNegativeAxes:r,hideAxisHeads:e,disabled:t,font:i="18px Inter var, Arial, sans-serif",axisColors:n=["#ff2060","#20df80","#2080ff"],axisHeadScale:s=1,axisScale:o,labels:a=["X","Y","Z"],labelColor:l="#000",onClick:c,...u})=>{const[h,f,d]=n,{tweenCamera:m}=kA(),A={font:i,disabled:t,labelColor:l,onClick:c,axisHeadScale:s,onPointerDown:t?void 0:p=>{m(p.object.position),p.stopPropagation()}};return g.createElement("group",Ae({scale:40},u),g.createElement(kd,{color:h,rotation:[0,0,0],scale:o}),g.createElement(kd,{color:f,rotation:[0,0,Math.PI/2],scale:o}),g.createElement(kd,{color:d,rotation:[0,-Math.PI/2,0],scale:o}),!e&&g.createElement(g.Fragment,null,g.createElement(Go,Ae({arcStyle:h,position:[1,0,0],label:a[0]},A)),g.createElement(Go,Ae({arcStyle:f,position:[0,1,0],label:a[1]},A)),g.createElement(Go,Ae({arcStyle:d,position:[0,0,1],label:a[2]},A)),!r&&g.createElement(g.Fragment,null,g.createElement(Go,Ae({arcStyle:h,position:[-1,0,0]},A)),g.createElement(Go,Ae({arcStyle:f,position:[0,-1,0]},A)),g.createElement(Go,Ae({arcStyle:d,position:[0,0,-1]},A)))))},w9=ws({cellSize:.5,sectionSize:1,fadeDistance:100,fadeStrength:1,fadeFrom:1,cellThickness:.5,sectionThickness:1,cellColor:new We,sectionColor:new We,infiniteGrid:!1,followCamera:!1,worldCamProjPosition:new Q,worldPlanePosition:new Q},`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform vec3 worldPlanePosition;
    uniform float fadeDistance;
    uniform bool infiniteGrid;
    uniform bool followCamera;

    void main() {
      localPosition = position.xzy;
      if (infiniteGrid) localPosition *= 1.0 + fadeDistance;
      
      worldPosition = modelMatrix * vec4(localPosition, 1.0);
      if (followCamera) {
        worldPosition.xyz += (worldCamProjPosition - worldPlanePosition);
        localPosition = (inverse(modelMatrix) * worldPosition).xyz;
      }

      gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
  `,`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform float cellSize;
    uniform float sectionSize;
    uniform vec3 cellColor;
    uniform vec3 sectionColor;
    uniform float fadeDistance;
    uniform float fadeStrength;
    uniform float fadeFrom;
    uniform float cellThickness;
    uniform float sectionThickness;

    float getGrid(float size, float thickness) {
      vec2 r = localPosition.xz / size;
      vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
      float line = min(grid.x, grid.y) + 1.0 - thickness;
      return 1.0 - min(line, 1.0);
    }

    void main() {
      float g1 = getGrid(cellSize, cellThickness);
      float g2 = getGrid(sectionSize, sectionThickness);

      vec3 from = worldCamProjPosition*vec3(fadeFrom);
      float dist = distance(from, worldPosition.xyz);
      float d = 1.0 - min(dist / fadeDistance, 1.0);
      vec3 color = mix(cellColor, sectionColor, min(1.0, sectionThickness * g2));

      gl_FragColor = vec4(color, (g1 + g2) * pow(d, fadeStrength));
      gl_FragColor.a = mix(0.75 * gl_FragColor.a, gl_FragColor.a, g2);
      if (gl_FragColor.a <= 0.0) discard;

      #include <tonemapping_fragment>
      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `),FU=g.forwardRef(({args:r,cellColor:e="#000000",sectionColor:t="#2080ff",cellSize:i=.5,sectionSize:n=1,followCamera:s=!1,infiniteGrid:o=!1,fadeDistance:a=100,fadeStrength:l=1,fadeFrom:c=1,cellThickness:u=.5,sectionThickness:h=1,side:f=Oa,...d},m)=>{Ci({GridMaterial:w9});const A=g.useRef(null);g.useImperativeHandle(m,()=>A.current,[]);const p=new Xs,y=new Q(0,1,0),v=new Q(0,0,0);Ve(I=>{p.setFromNormalAndCoplanarPoint(y,v).applyMatrix4(A.current.matrixWorld);const C=A.current.material,_=C.uniforms.worldCamProjPosition,S=C.uniforms.worldPlanePosition;p.projectPoint(I.camera.position,_.value),S.value.set(0,0,0).applyMatrix4(A.current.matrixWorld)});const E={cellSize:i,sectionSize:n,cellColor:e,sectionColor:t,cellThickness:u,sectionThickness:h},x={fadeDistance:a,fadeStrength:l,fadeFrom:c,infiniteGrid:o,followCamera:s};return g.createElement("mesh",Ae({ref:A,frustumCulled:!1},d),g.createElement("gridMaterial",Ae({transparent:!0,"extensions-derivatives":!0,side:f},E,x)),g.createElement("planeGeometry",{args:r}))});function Gx(r,{path:e}){const[t]=hi(rA,[r],i=>i.setPath(e));return t}Gx.preload=(r,{path:e})=>hi.preload(rA,[r],t=>t.setPath(e));function kU({children:r,files:e,...t}){const i=Gx(e,{...t});return g.createElement(g.Fragment,null,r?.(i))}function OA(r){return hi(BA,r)}OA.preload=r=>hi.preload(BA,r);OA.clear=r=>hi.clear(BA,r);function OU({path:r,...e}){const i=OA(r).children[0];return g.createElement(Mh,Ae({},e,{object:i}))}const Qx="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master";function UA(r,e=`${Qx}/basis/`){const t=ae(n=>n.gl),i=hi(DA,Zl(r)?Object.values(r):r,n=>{n.detectSupport(t),n.setTranscoderPath(e)});if(g.useEffect(()=>{(Array.isArray(i)?i:[i]).forEach(t.initTexture)},[t,i]),Zl(r)){const n=Object.keys(r),s={};return n.forEach(o=>Object.assign(s,{[o]:i[n.indexOf(o)]})),s}else return i}UA.preload=(r,e=`${Qx}/basis/`)=>hi.preload(DA,r,t=>{t.setTranscoderPath(e)});UA.clear=r=>hi.clear(DA,r);const UU=({children:r,input:e,basisPath:t})=>{const i=UA(e,t);return g.createElement(g.Fragment,null,r?.(i))},He=Number.isFinite||function(r){return typeof r=="number"&&isFinite(r)},B9=Number.isSafeInteger||function(r){return typeof r=="number"&&Math.abs(r)<=R9},R9=Number.MAX_SAFE_INTEGER||9007199254740991;let Je=(function(r){return r.NETWORK_ERROR="networkError",r.MEDIA_ERROR="mediaError",r.KEY_SYSTEM_ERROR="keySystemError",r.MUX_ERROR="muxError",r.OTHER_ERROR="otherError",r})({}),ue=(function(r){return r.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",r.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",r.KEY_SYSTEM_NO_SESSION="keySystemNoSession",r.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",r.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",r.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",r.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",r.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",r.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",r.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",r.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",r.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",r.MANIFEST_LOAD_ERROR="manifestLoadError",r.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",r.MANIFEST_PARSING_ERROR="manifestParsingError",r.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",r.LEVEL_EMPTY_ERROR="levelEmptyError",r.LEVEL_LOAD_ERROR="levelLoadError",r.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",r.LEVEL_PARSING_ERROR="levelParsingError",r.LEVEL_SWITCH_ERROR="levelSwitchError",r.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",r.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",r.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",r.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",r.FRAG_LOAD_ERROR="fragLoadError",r.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",r.FRAG_DECRYPT_ERROR="fragDecryptError",r.FRAG_PARSING_ERROR="fragParsingError",r.FRAG_GAP="fragGap",r.REMUX_ALLOC_ERROR="remuxAllocError",r.KEY_LOAD_ERROR="keyLoadError",r.KEY_LOAD_TIMEOUT="keyLoadTimeOut",r.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",r.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",r.BUFFER_APPEND_ERROR="bufferAppendError",r.BUFFER_APPENDING_ERROR="bufferAppendingError",r.BUFFER_STALLED_ERROR="bufferStalledError",r.BUFFER_FULL_ERROR="bufferFullError",r.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",r.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",r.ASSET_LIST_LOAD_ERROR="assetListLoadError",r.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",r.ASSET_LIST_PARSING_ERROR="assetListParsingError",r.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",r.INTERNAL_EXCEPTION="internalException",r.INTERNAL_ABORTED="aborted",r.ATTACH_MEDIA_ERROR="attachMediaError",r.UNKNOWN="unknown",r})({}),L=(function(r){return r.MEDIA_ATTACHING="hlsMediaAttaching",r.MEDIA_ATTACHED="hlsMediaAttached",r.MEDIA_DETACHING="hlsMediaDetaching",r.MEDIA_DETACHED="hlsMediaDetached",r.MEDIA_ENDED="hlsMediaEnded",r.STALL_RESOLVED="hlsStallResolved",r.BUFFER_RESET="hlsBufferReset",r.BUFFER_CODECS="hlsBufferCodecs",r.BUFFER_CREATED="hlsBufferCreated",r.BUFFER_APPENDING="hlsBufferAppending",r.BUFFER_APPENDED="hlsBufferAppended",r.BUFFER_EOS="hlsBufferEos",r.BUFFERED_TO_END="hlsBufferedToEnd",r.BUFFER_FLUSHING="hlsBufferFlushing",r.BUFFER_FLUSHED="hlsBufferFlushed",r.MANIFEST_LOADING="hlsManifestLoading",r.MANIFEST_LOADED="hlsManifestLoaded",r.MANIFEST_PARSED="hlsManifestParsed",r.LEVEL_SWITCHING="hlsLevelSwitching",r.LEVEL_SWITCHED="hlsLevelSwitched",r.LEVEL_LOADING="hlsLevelLoading",r.LEVEL_LOADED="hlsLevelLoaded",r.LEVEL_UPDATED="hlsLevelUpdated",r.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",r.LEVELS_UPDATED="hlsLevelsUpdated",r.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",r.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",r.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",r.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",r.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",r.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",r.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",r.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",r.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",r.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",r.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",r.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",r.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",r.CUES_PARSED="hlsCuesParsed",r.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",r.INIT_PTS_FOUND="hlsInitPtsFound",r.FRAG_LOADING="hlsFragLoading",r.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",r.FRAG_LOADED="hlsFragLoaded",r.FRAG_DECRYPTED="hlsFragDecrypted",r.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",r.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",r.FRAG_PARSING_METADATA="hlsFragParsingMetadata",r.FRAG_PARSED="hlsFragParsed",r.FRAG_BUFFERED="hlsFragBuffered",r.FRAG_CHANGED="hlsFragChanged",r.FPS_DROP="hlsFpsDrop",r.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",r.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",r.ERROR="hlsError",r.DESTROYING="hlsDestroying",r.KEY_LOADING="hlsKeyLoading",r.KEY_LOADED="hlsKeyLoaded",r.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",r.BACK_BUFFER_REACHED="hlsBackBufferReached",r.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",r.ASSET_LIST_LOADING="hlsAssetListLoading",r.ASSET_LIST_LOADED="hlsAssetListLoaded",r.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",r.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",r.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",r.INTERSTITIAL_STARTED="hlsInterstitialStarted",r.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",r.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",r.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",r.INTERSTITIAL_ENDED="hlsInterstitialEnded",r.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",r.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",r.EVENT_CUE_ENTER="hlsEventCueEnter",r})({});var Ct={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},$e={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class Qo{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class D9{constructor(e,t,i,n=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Qo(e),this.fast_=new Qo(t),this.defaultTTFB_=n,this.ttfb_=new Qo(e)}update(e,t){const{slow_:i,fast_:n,ttfb_:s}=this;i.halfLife!==e&&(this.slow_=new Qo(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.fast_=new Qo(t,n.getEstimate(),n.getTotalWeight())),s.halfLife!==e&&(this.ttfb_=new Qo(e,s.getEstimate(),s.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,n=e/1e3,s=i/n;this.fast_.sample(n,s),this.slow_.sample(n,s)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function M9(r,e,t){return(e=P9(e))in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function Yt(){return Yt=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)({}).hasOwnProperty.call(t,i)&&(r[i]=t[i])}return r},Yt.apply(null,arguments)}function gy(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(r);e&&(i=i.filter(function(n){return Object.getOwnPropertyDescriptor(r,n).enumerable})),t.push.apply(t,i)}return t}function Ht(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?gy(Object(t),!0).forEach(function(i){M9(r,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):gy(Object(t)).forEach(function(i){Object.defineProperty(r,i,Object.getOwnPropertyDescriptor(t,i))})}return r}function L9(r,e){if(typeof r!="object"||!r)return r;var t=r[Symbol.toPrimitive];if(t!==void 0){var i=t.call(r,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(r)}function P9(r){var e=L9(r,"string");return typeof e=="symbol"?e:e+""}class as{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const i=`[${e}]:`;this.trace=Lr,this.debug=t.debug.bind(null,i),this.log=t.log.bind(null,i),this.warn=t.warn.bind(null,i),this.info=t.info.bind(null,i),this.error=t.error.bind(null,i)}}const Lr=function(){},F9={trace:Lr,debug:Lr,log:Lr,warn:Lr,info:Lr,error:Lr};function Cm(){return Yt({},F9)}function k9(r,e){const t=self.console[r];return t?t.bind(self.console,`${e?"["+e+"] ":""}[${r}] >`):Lr}function yy(r,e,t){return e[r]?e[r].bind(e):k9(r,t)}const _m=Cm();function O9(r,e,t){const i=Cm();if(typeof console=="object"&&r===!0||typeof r=="object"){const n=["debug","log","info","warn","error"];n.forEach(s=>{i[s]=yy(s,r,t)});try{i.log(`Debug logs enabled for "${e}" in hls.js version 1.6.14`)}catch{return Cm()}n.forEach(s=>{_m[s]=yy(s,r)})}else Yt(_m,i);return i}const Kt=_m;function yr(r=!0){return typeof self>"u"?void 0:(r||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function U9(r){return typeof self<"u"&&r===self.ManagedMediaSource}function zx(r,e){const t=Object.keys(r),i=Object.keys(e),n=t.length,s=i.length;return!n||!s||n===s&&!t.some(o=>i.indexOf(o)===-1)}function Qn(r,e=!1){if(typeof TextDecoder<"u"){const c=new TextDecoder("utf-8").decode(r);if(e){const u=c.indexOf("\0");return u!==-1?c.substring(0,u):c}return c.replace(/\0/g,"")}const t=r.length;let i,n,s,o="",a=0;for(;a<t;){if(i=r[a++],i===0&&e)return o;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(i);break;case 12:case 13:n=r[a++],o+=String.fromCharCode((i&31)<<6|n&63);break;case 14:n=r[a++],s=r[a++],o+=String.fromCharCode((i&15)<<12|(n&63)<<6|(s&63)<<0);break}}return o}function an(r){let e="";for(let t=0;t<r.length;t++){let i=r[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}function Hx(r){return Uint8Array.from(r.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function N9(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Od={exports:{}},vy;function G9(){return vy||(vy=1,(function(r,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(l,c,u){if(u=u||{},l=l.trim(),c=c.trim(),!c){if(!u.alwaysNormalize)return l;var h=a.parseURL(l);if(!h)throw new Error("Error trying to parse base URL.");return h.path=a.normalizePath(h.path),a.buildURLFromParts(h)}var f=a.parseURL(c);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=a.normalizePath(f.path),a.buildURLFromParts(f)):c;var d=a.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");if(!d.netLoc&&d.path&&d.path[0]!=="/"){var m=n.exec(d.path);d.netLoc=m[1],d.path=m[2]}d.netLoc&&!d.path&&(d.path="/");var A={scheme:d.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(A.netLoc=d.netLoc,f.path[0]!=="/"))if(!f.path)A.path=d.path,f.params||(A.params=d.params,f.query||(A.query=d.query));else{var p=d.path,y=p.substring(0,p.lastIndexOf("/")+1)+f.path;A.path=a.normalizePath(y)}return A.path===null&&(A.path=u.alwaysNormalize?a.normalizePath(f.path):f.path),a.buildURLFromParts(A)},parseURL:function(l){var c=i.exec(l);return c?{scheme:c[1]||"",netLoc:c[2]||"",path:c[3]||"",params:c[4]||"",query:c[5]||"",fragment:c[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(s,"");l.length!==(l=l.replace(o,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};r.exports=a})()})(Od)),Od.exports}var NA=G9();class mf{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var qt={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class GA{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof e=="string"&&(e={url:e}),this.base=e,Q9(this,"stats")}setByteRange(e,t){const i=e.split("@",2);let n;i.length===1?n=t?.byteRangeEndOffset||0:n=parseInt(i[1]),this._byteRange=[n,parseInt(i[0])+n]}get baseurl(){return this.base.url}get byteRange(){return this._byteRange===null?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return this._streams===null&&(this._streams={[qt.AUDIO]:null,[qt.VIDEO]:null,[qt.AUDIOVIDEO]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return this._stats!==null}get hasStreams(){return this._streams!==null}get stats(){return this._stats===null&&(this._stats=new mf),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=NA.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[qt.AUDIO]=null,e[qt.VIDEO]=null,e[qt.AUDIOVIDEO]=null}}function Ri(r){return r.sn!=="initSegment"}class ah extends GA{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange.length){const e=this.byteRange[0],t=this.byteRange[1];if(He(e)&&He(t))return t-e}return null}get bitrate(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){var e;const{levelkeys:t}=this;if(!t||t.NONE)return null;if(t.identity)this._decryptdata||(this._decryptdata=t.identity.getDecryptData(this.sn));else if(!((e=this._decryptdata)!=null&&e.keyId)){const i=Object.keys(t);if(i.length===1){const n=this._decryptdata=t[i[0]]||null;n&&(this._decryptdata=n.getDecryptData(this.sn,t))}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;const e=He(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){var t;const i=Object.keys(this.levelkeys),n=i.length;if(n>1||n===1&&(t=this.levelkeys[i[0]])!=null&&t.encrypted)return!0}return!1}get programDateTime(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){if(!He(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}get ref(){return Ri(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){const t=this.levelkeys;if(t){var i;const n=t[e];n&&!((i=this._decryptdata)!=null&&i.keyId)&&(this._decryptdata=n.getDecryptData(this.sn,t))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,n,s,o=!1){const{elementaryStreams:a}=this,l=a[e];if(!l){a[e]={startPTS:t,endPTS:i,startDTS:n,endDTS:s,partial:o};return}l.startPTS=Math.min(l.startPTS,t),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,n),l.endDTS=Math.max(l.endDTS,s)}}class Vx extends GA{constructor(e,t,i,n,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=n;const o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function Kx(r,e){const t=Object.getPrototypeOf(r);if(t){const i=Object.getOwnPropertyDescriptor(t,e);return i||Kx(t,e)}}function Q9(r,e){const t=Kx(r,e);t&&(t.enumerable=!0,Object.defineProperty(r,e,t))}const Ey=Math.pow(2,32)-1,z9=[].push,$x={video:1,audio:2,id3:3,text:4};function Oi(r){return String.fromCharCode.apply(null,r)}function Yx(r,e){const t=r[e]<<8|r[e+1];return t<0?65536+t:t}function ht(r,e){const t=Wx(r,e);return t<0?4294967296+t:t}function xy(r,e){let t=ht(r,e);return t*=Math.pow(2,32),t+=ht(r,e+4),t}function Wx(r,e){return r[e]<<24|r[e+1]<<16|r[e+2]<<8|r[e+3]}function H9(r){const e=r.byteLength;for(let t=0;t<e;){const i=ht(r,t);if(i>8&&r[t+4]===109&&r[t+5]===111&&r[t+6]===111&&r[t+7]===102)return!0;t=i>1?t+i:e}return!1}function It(r,e){const t=[];if(!e.length)return t;const i=r.byteLength;for(let n=0;n<i;){const s=ht(r,n),o=Oi(r.subarray(n+4,n+8)),a=s>1?n+s:i;if(o===e[0])if(e.length===1)t.push(r.subarray(n+8,a));else{const l=It(r.subarray(n+8,a),e.slice(1));l.length&&z9.apply(t,l)}n=a}return t}function V9(r){const e=[],t=r[0];let i=8;const n=ht(r,i);i+=4;let s=0,o=0;t===0?(s=ht(r,i),o=ht(r,i+4),i+=8):(s=xy(r,i),o=xy(r,i+8),i+=16),i+=2;let a=r.length+o;const l=Yx(r,i);i+=2;for(let c=0;c<l;c++){let u=i;const h=ht(r,u);u+=4;const f=h&2147483647;if((h&2147483648)>>>31===1)return Kt.warn("SIDX has hierarchical references (not supported)"),null;const m=ht(r,u);u+=4,e.push({referenceSize:f,subsegmentDuration:m,info:{duration:m/n,start:a,end:a+f-1}}),a+=f,u+=4,i=u}return{earliestPresentationTime:s,timescale:n,version:t,referencesCount:l,references:e}}function jx(r){const e=[],t=It(r,["moov","trak"]);for(let n=0;n<t.length;n++){const s=t[n],o=It(s,["tkhd"])[0];if(o){let a=o[0];const l=ht(o,a===0?12:20),c=It(s,["mdia","mdhd"])[0];if(c){a=c[0];const u=ht(c,a===0?12:20),h=It(s,["mdia","hdlr"])[0];if(h){const f=Oi(h.subarray(8,12)),d={soun:qt.AUDIO,vide:qt.VIDEO}[f],m=It(s,["mdia","minf","stbl","stsd"])[0],A=K9(m);d?(e[l]={timescale:u,type:d,stsd:A},e[d]=Ht({timescale:u,id:l},A)):e[l]={timescale:u,type:f,stsd:A}}}}}return It(r,["moov","mvex","trex"]).forEach(n=>{const s=ht(n,4),o=e[s];o&&(o.default={duration:ht(n,12),flags:ht(n,20)})}),e}function K9(r){const e=r.subarray(8),t=e.subarray(86),i=Oi(e.subarray(4,8));let n=i,s;const o=i==="enca"||i==="encv";if(o){const c=It(e,[i])[0].subarray(i==="enca"?28:78);It(c,["sinf"]).forEach(h=>{const f=It(h,["schm"])[0];if(f){const d=Oi(f.subarray(4,8));if(d==="cbcs"||d==="cenc"){const m=It(h,["frma"])[0];m&&(n=Oi(m))}}})}const a=n;switch(n){case"avc1":case"avc2":case"avc3":case"avc4":{const l=It(t,["avcC"])[0];l&&l.length>3&&(n+="."+fu(l[1])+fu(l[2])+fu(l[3]),s=hu(a==="avc1"?"dva1":"dvav",t));break}case"mp4a":{const l=It(e,[i])[0],c=It(l.subarray(28),["esds"])[0];if(c&&c.length>7){let u=4;if(c[u++]!==3)break;u=Ud(c,u),u+=2;const h=c[u++];if(h&128&&(u+=2),h&64&&(u+=c[u++]),c[u++]!==4)break;u=Ud(c,u);const f=c[u++];if(f===64)n+="."+fu(f);else break;if(u+=12,c[u++]!==5)break;u=Ud(c,u);const d=c[u++];let m=(d&248)>>3;m===31&&(m+=1+((d&7)<<3)+((c[u]&224)>>5)),n+="."+m}break}case"hvc1":case"hev1":{const l=It(t,["hvcC"])[0];if(l&&l.length>12){const c=l[1],u=["","A","B","C"][c>>6],h=c&31,f=ht(l,2),d=(c&32)>>5?"H":"L",m=l[12],A=l.subarray(6,12);n+="."+u+h,n+="."+$9(f).toString(16).toUpperCase(),n+="."+d+m;let p="";for(let y=A.length;y--;){const v=A[y];(v||p)&&(p="."+v.toString(16).toUpperCase()+p)}n+=p}s=hu(a=="hev1"?"dvhe":"dvh1",t);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{n=hu(n,t)||n;break}case"vp09":{const l=It(t,["vpcC"])[0];if(l&&l.length>6){const c=l[4],u=l[5],h=l[6]>>4&15;n+="."+Os(c)+"."+Os(u)+"."+Os(h)}break}case"av01":{const l=It(t,["av1C"])[0];if(l&&l.length>2){const c=l[1]>>>5,u=l[1]&31,h=l[2]>>>7?"H":"M",f=(l[2]&64)>>6,d=(l[2]&32)>>5,m=c===2&&f?d?12:10:f?10:8,A=(l[2]&16)>>4,p=(l[2]&8)>>3,y=(l[2]&4)>>2,v=l[2]&3;n+="."+c+"."+Os(u)+h+"."+Os(m)+"."+A+"."+p+y+v+"."+Os(1)+"."+Os(1)+"."+Os(1)+"."+0,s=hu("dav1",t)}break}}return{codec:n,encrypted:o,supplemental:s}}function hu(r,e){const t=It(e,["dvvC"]),i=t.length?t[0]:It(e,["dvcC"])[0];if(i){const n=i[2]>>1&127,s=i[2]<<5&32|i[3]>>3&31;return r+"."+Os(n)+"."+Os(s)}}function $9(r){let e=0;for(let t=0;t<32;t++)e|=(r>>t&1)<<31-t;return e>>>0}function Ud(r,e){const t=e+5;for(;r[e++]&128&&e<t;);return e}function fu(r){return("0"+r.toString(16).toUpperCase()).slice(-2)}function Os(r){return(r<10?"0":"")+r}function Y9(r,e){if(!r||!e)return;const t=e.keyId;t&&e.isCommonEncryption&&qx(r,(i,n)=>{const s=i.subarray(8,24);s.some(o=>o!==0)||(Kt.log(`[eme] Patching keyId in 'enc${n?"a":"v"}>sinf>>tenc' box: ${an(s)} -> ${an(t)}`),i.set(t,8))})}function W9(r){const e=[];return qx(r,t=>e.push(t.subarray(8,24))),e}function qx(r,e){It(r,["moov","trak"]).forEach(i=>{const n=It(i,["mdia","minf","stbl","stsd"])[0];if(!n)return;const s=n.subarray(8);let o=It(s,["enca"]);const a=o.length>0;a||(o=It(s,["encv"])),o.forEach(l=>{const c=a?l.subarray(28):l.subarray(78);It(c,["sinf"]).forEach(h=>{const f=Xx(h);f&&e(f,a)})})})}function Xx(r){const e=It(r,["schm"])[0];if(e){const t=Oi(e.subarray(4,8));if(t==="cbcs"||t==="cenc"){const i=It(r,["schi","tenc"])[0];if(i)return i}}}function j9(r,e,t){const i={},n=It(r,["moof","traf"]);for(let s=0;s<n.length;s++){const o=n[s],a=It(o,["tfhd"])[0],l=ht(a,4),c=e[l];if(!c)continue;i[l]||(i[l]={start:NaN,duration:0,sampleCount:0,timescale:c.timescale,type:c.type});const u=i[l],h=It(o,["tfdt"])[0];if(h){const E=h[0];let x=ht(h,4);E===1&&(x===Ey?t.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(x*=Ey+1,x+=ht(h,8))),He(x)&&(!He(u.start)||x<u.start)&&(u.start=x)}const f=c.default,d=ht(a,0)|f?.flags;let m=f?.duration||0;d&8&&(d&2?m=ht(a,12):m=ht(a,8));const A=It(o,["trun"]);let p=u.start||0,y=0,v=m;for(let E=0;E<A.length;E++){const x=A[E],I=ht(x,4),C=u.sampleCount;u.sampleCount+=I;const _=x[3]&1,S=x[3]&4,b=x[2]&1,T=x[2]&2,R=x[2]&4,w=x[2]&8;let B=8,M=I;for(_&&(B+=4),S&&I&&(!(x[B+1]&1)&&u.keyFrameIndex===void 0&&(u.keyFrameIndex=C),B+=4,b?(v=ht(x,B),B+=4):v=m,T&&(B+=4),w&&(B+=4),p+=v,y+=v,M--);M--;)b?(v=ht(x,B),B+=4):v=m,T&&(B+=4),R&&(x[B+1]&1||u.keyFrameIndex===void 0&&(u.keyFrameIndex=u.sampleCount-(M+1),u.keyFrameStart=p),B+=4),w&&(B+=4),p+=v,y+=v;!y&&m&&(y+=m*I)}u.duration+=y}if(!Object.keys(i).some(s=>i[s].duration)){let s=1/0,o=0;const a=It(r,["sidx"]);for(let l=0;l<a.length;l++){const c=V9(a[l]);if(c!=null&&c.references){s=Math.min(s,c.earliestPresentationTime/c.timescale);const u=c.references.reduce((h,f)=>h+f.info.duration||0,0);o=Math.max(o,u+c.earliestPresentationTime/c.timescale)}}o&&He(o)&&Object.keys(i).forEach(l=>{i[l].duration||(i[l].duration=o*i[l].timescale-i[l].start)})}return i}function q9(r){const e={valid:null,remainder:null},t=It(r,["moof"]);if(t.length<2)return e.remainder=r,e;const i=t[t.length-1];return e.valid=r.slice(0,i.byteOffset-8),e.remainder=r.slice(i.byteOffset-8),e}function rs(r,e){const t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function Iy(r,e){const t=[],i=e.samples,n=e.timescale,s=e.id;let o=!1;return It(i,["moof"]).map(l=>{const c=l.byteOffset-8;It(l,["traf"]).map(h=>{const f=It(h,["tfdt"]).map(d=>{const m=d[0];let A=ht(d,4);return m===1&&(A*=Math.pow(2,32),A+=ht(d,8)),A/n})[0];return f!==void 0&&(r=f),It(h,["tfhd"]).map(d=>{const m=ht(d,4),A=ht(d,0)&16777215,p=(A&1)!==0,y=(A&2)!==0,v=(A&8)!==0;let E=0;const x=(A&16)!==0;let I=0;const C=(A&32)!==0;let _=8;m===s&&(p&&(_+=8),y&&(_+=4),v&&(E=ht(d,_),_+=4),x&&(I=ht(d,_),_+=4),C&&(_+=4),e.type==="video"&&(o=Af(e.codec)),It(h,["trun"]).map(S=>{const b=S[0],T=ht(S,0)&16777215,R=(T&1)!==0;let w=0;const B=(T&4)!==0,M=(T&256)!==0;let O=0;const U=(T&512)!==0;let Y=0;const W=(T&1024)!==0,N=(T&2048)!==0;let K=0;const D=ht(S,4);let z=8;R&&(w=ht(S,z),z+=4),B&&(z+=4);let $=w+c;for(let V=0;V<D;V++){if(M?(O=ht(S,z),z+=4):O=E,U?(Y=ht(S,z),z+=4):Y=I,W&&(z+=4),N&&(b===0?K=ht(S,z):K=Wx(S,z),z+=4),e.type===qt.VIDEO){let P=0;for(;P<Y;){const G=ht(i,$);if($+=4,X9(o,i[$])){const F=i.subarray($,$+G);QA(F,o?2:1,r+K/n,t)}$+=G,P+=G+4}}r+=O/n}}))})})}),t}function Af(r){if(!r)return!1;const e=r.substring(0,4);return e==="hvc1"||e==="hev1"||e==="dvh1"||e==="dvhe"}function X9(r,e){if(r){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function QA(r,e,t,i){const n=Jx(r);let s=0;s+=e;let o=0,a=0,l=0;for(;s<n.length;){o=0;do{if(s>=n.length)break;l=n[s++],o+=l}while(l===255);a=0;do{if(s>=n.length)break;l=n[s++],a+=l}while(l===255);const c=n.length-s;let u=s;if(a<c)s+=a;else if(a>c){Kt.error(`Malformed SEI payload. ${a} is too small, only ${c} bytes left to parse.`);break}if(o===4){if(n[u++]===181){const f=Yx(n,u);if(u+=2,f===49){const d=ht(n,u);if(u+=4,d===1195456820){const m=n[u++];if(m===3){const A=n[u++],p=31&A,y=64&A,v=y?2+p*3:0,E=new Uint8Array(v);if(y){E[0]=A;for(let x=1;x<v;x++)E[x]=n[u++]}i.push({type:m,payloadType:o,pts:t,bytes:E})}}}}}else if(o===5&&a>16){const h=[];for(let m=0;m<16;m++){const A=n[u++].toString(16);h.push(A.length==1?"0"+A:A),(m===3||m===5||m===7||m===9)&&h.push("-")}const f=a-16,d=new Uint8Array(f);for(let m=0;m<f;m++)d[m]=n[u++];i.push({payloadType:o,pts:t,uuid:h.join(""),userData:Qn(d),userDataBytes:d})}}}function Jx(r){const e=r.byteLength,t=[];let i=1;for(;i<e-2;)r[i]===0&&r[i+1]===0&&r[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return r;const n=e-t.length,s=new Uint8Array(n);let o=0;for(i=0;i<n;o++,i++)o===t[0]&&(o++,t.shift()),s[i]=r[o];return s}function J9(r){const e=r[0];let t="",i="",n=0,s=0,o=0,a=0,l=0,c=0;if(e===0){for(;Oi(r.subarray(c,c+1))!=="\0";)t+=Oi(r.subarray(c,c+1)),c+=1;for(t+=Oi(r.subarray(c,c+1)),c+=1;Oi(r.subarray(c,c+1))!=="\0";)i+=Oi(r.subarray(c,c+1)),c+=1;i+=Oi(r.subarray(c,c+1)),c+=1,n=ht(r,12),s=ht(r,16),a=ht(r,20),l=ht(r,24),c=28}else if(e===1){c+=4,n=ht(r,c),c+=4;const h=ht(r,c);c+=4;const f=ht(r,c);for(c+=4,o=2**32*h+f,B9(o)||(o=Number.MAX_SAFE_INTEGER,Kt.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=ht(r,c),c+=4,l=ht(r,c),c+=4;Oi(r.subarray(c,c+1))!=="\0";)t+=Oi(r.subarray(c,c+1)),c+=1;for(t+=Oi(r.subarray(c,c+1)),c+=1;Oi(r.subarray(c,c+1))!=="\0";)i+=Oi(r.subarray(c,c+1)),c+=1;i+=Oi(r.subarray(c,c+1)),c+=1}const u=r.subarray(c,r.byteLength);return{schemeIdUri:t,value:i,timeScale:n,presentationTime:o,presentationTimeDelta:s,eventDuration:a,id:l,payload:u}}function Z9(r,...e){const t=e.length;let i=8,n=t;for(;n--;)i+=e[n].byteLength;const s=new Uint8Array(i);for(s[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=i&255,s.set(r,4),n=0,i=8;n<t;n++)s.set(e[n],i),i+=e[n].byteLength;return s}function eR(r,e,t){if(r.byteLength!==16)throw new RangeError("Invalid system id");let i,n;i=0,n=new Uint8Array;let s;i>0?(s=new Uint8Array(4),e.length>0&&new DataView(s.buffer).setUint32(0,e.length,!1)):s=new Uint8Array;const o=new Uint8Array(4);return t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),Z9([112,115,115,104],new Uint8Array([i,0,0,0]),r,s,n,o,t)}function tR(r){const e=[];if(r instanceof ArrayBuffer){const t=r.byteLength;let i=0;for(;i+32<t;){const n=new DataView(r,i),s=iR(n);e.push(s),i+=s.size}}return e}function iR(r){const e=r.getUint32(0),t=r.byteOffset,i=r.byteLength;if(i<e)return{offset:t,size:i};if(r.getUint32(4)!==1886614376)return{offset:t,size:e};const s=r.getUint32(8)>>>24;if(s!==0&&s!==1)return{offset:t,size:e};const o=r.buffer,a=an(new Uint8Array(o,t+12,16));let l=null,c=null,u=0;if(s===0)u=28;else{const f=r.getUint32(28);if(!f||i<32+f*16)return{offset:t,size:e};l=[];for(let d=0;d<f;d++)l.push(new Uint8Array(o,t+32+d*16,16));u=32+f*16}if(!u)return{offset:t,size:e};const h=r.getUint32(u);return e-32<h?{offset:t,size:e}:(c=new Uint8Array(o,t+u+4,h),{version:s,systemId:a,kids:l,data:c,offset:t,size:e})}const Zx=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Pa={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function zA(r,e){const t=Pa[e];return!!t&&!!t[r.slice(0,4)]}function pc(r,e,t=!0){return!r.split(",").some(i=>!HA(i,e,t))}function HA(r,e,t=!0){var i;const n=yr(t);return(i=n?.isTypeSupported(gc(r,e)))!=null?i:!1}function gc(r,e){return`${e}/mp4;codecs=${r}`}function Cy(r){if(r){const e=r.substring(0,4);return Pa.video[e]}return 2}function Lh(r){const e=Zx();return r.split(",").reduce((t,i)=>{const s=e&&Af(i)?9:Pa.video[i];return s?(s*2+t)/(t?3:2):(Pa.audio[i]+t)/(t?2:1)},0)}const Nd={};function nR(r,e=!0){if(Nd[r])return Nd[r];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[r];for(let n=0;n<t.length;n++){var i;if(HA(t[n],"audio",e))return Nd[r]=t[n],t[n];if(t[n]==="mp3"&&(i=yr(e))!=null&&i.isTypeSupported("audio/mpeg"))return""}return r}const sR=/flac|opus|mp4a\.40\.34/i;function Ph(r,e=!0){return r.replace(sR,t=>nR(t.toLowerCase(),e))}function rR(r,e){const t=[];if(r){const i=r.split(",");for(let n=0;n<i.length;n++)zA(i[n],"video")||t.push(i[n])}return e&&t.push(e),t.join(",")}function lh(r,e){if(r&&(r.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(r)!==-1)&&(_y(r,"audio")||_y(r,"video")))return r;if(e){const t=e.split(",");if(t.length>1){if(r){for(let i=t.length;i--;)if(t[i].substring(0,4)===r.substring(0,4))return t[i]}return t[0]}}return e||r}function _y(r,e){return zA(r,e)&&HA(r,e)}function oR(r){const e=r.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");i.length>2&&i[0]==="avc1"&&(e[t]=`avc1.${parseInt(i[1]).toString(16)}${("000"+parseInt(i[2]).toString(16)).slice(-4)}`)}return e.join(",")}function aR(r){if(r.startsWith("av01.")){const e=r.split("."),t=["0","111","01","01","01","0"];for(let i=e.length;i>4&&i<10;i++)e[i]=t[i-4];return e.join(".")}return r}function Sy(r){const e=yr(r)||{isTypeSupported:()=>!1};return{mpeg:e.isTypeSupported("audio/mpeg"),mp3:e.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:e.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Sm(r){return r.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const lR={supported:!0,powerEfficient:!0,smooth:!0},cR={supported:!1,smooth:!1,powerEfficient:!1},eI={supported:!0,configurations:[],decodingInfoResults:[lR]};function tI(r,e){return{supported:!1,configurations:e,decodingInfoResults:[cR],error:r}}function uR(r,e,t,i,n,s){const o=r.videoCodec,a=r.audioCodec?r.audioGroups:null,l=s?.audioCodec,c=s?.channels,u=c?parseInt(c):l?1/0:2;let h=null;if(a!=null&&a.length)try{a.length===1&&a[0]?h=e.groups[a[0]].channels:h=a.reduce((f,d)=>{if(d){const m=e.groups[d];if(!m)throw new Error(`Audio track group ${d} not found`);Object.keys(m.channels).forEach(A=>{f[A]=(f[A]||0)+m.channels[A]})}return f},{2:0})}catch{return!0}return o!==void 0&&(o.split(",").some(f=>Af(f))||r.width>1920&&r.height>1088||r.height>1920&&r.width>1088||r.frameRate>Math.max(i,30)||r.videoRange!=="SDR"&&r.videoRange!==t||r.bitrate>Math.max(n,8e6))||!!h&&He(u)&&Object.keys(h).some(f=>parseInt(f)>u)}function iI(r,e,t,i={}){const n=r.videoCodec;if(!n&&!r.audioCodec||!t)return Promise.resolve(eI);const s=[],o=hR(r),a=o.length,l=fR(r,e,a>0),c=l.length;for(let u=a||1*c||1;u--;){const h={type:"media-source"};if(a&&(h.video=o[u%a]),c){h.audio=l[u%c];const f=h.audio.bitrate;h.video&&f&&(h.video.bitrate-=f)}s.push(h)}if(n){const u=navigator.userAgent;if(n.split(",").some(h=>Af(h))&&Zx())return Promise.resolve(tI(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${u})`),s))}return Promise.all(s.map(u=>{const h=mR(u);return i[h]||(i[h]=t.decodingInfo(u))})).then(u=>({supported:!u.some(h=>!h.supported),configurations:s,decodingInfoResults:u})).catch(u=>({supported:!1,configurations:s,decodingInfoResults:[],error:u}))}function hR(r){var e;const t=(e=r.videoCodec)==null?void 0:e.split(","),i=nI(r),n=r.width||640,s=r.height||480,o=r.frameRate||30,a=r.videoRange.toLowerCase();return t?t.map(l=>{const c={contentType:gc(aR(l),"video"),width:n,height:s,bitrate:i,framerate:o};return a!=="sdr"&&(c.transferFunction=a),c}):[]}function fR(r,e,t){var i;const n=(i=r.audioCodec)==null?void 0:i.split(","),s=nI(r);return n&&r.audioGroups?r.audioGroups.reduce((o,a)=>{var l;const c=a?(l=e.groups[a])==null?void 0:l.tracks:null;return c?c.reduce((u,h)=>{if(h.groupId===a){const f=parseFloat(h.channels||"");n.forEach(d=>{const m={contentType:gc(d,"audio"),bitrate:t?dR(d,s):s};f&&(m.channels=""+f),u.push(m)})}return u},o):o},[]):[]}function dR(r,e){if(e<=1)return 1;let t=128e3;return r==="ec-3"?t=768e3:r==="ac-3"&&(t=64e4),Math.min(e/2,t)}function nI(r){return Math.ceil(Math.max(r.bitrate*.9,r.averageBitrate)/1e3)*1e3||1}function mR(r){let e="";const{audio:t,video:i}=r;if(i){const n=Sm(i.contentType);e+=`${n}_r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${Math.ceil(i.bitrate/1e5)}`}if(t){const n=Sm(t.contentType);e+=`${i?"_":""}${n}_c${t.channels}`}return e}const Tm=["NONE","TYPE-0","TYPE-1",null];function AR(r){return Tm.indexOf(r)>-1}const Fh=["SDR","PQ","HLG"];function pR(r){return!!r&&Fh.indexOf(r)>-1}var ec={No:"",Yes:"YES",v2:"v2"};function Ty(r){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=r,n=i<e/2;return e&&n?t?ec.v2:ec.Yes:ec.No}class bm{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Fa{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(i=>!!i).map(i=>i.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const i=(t=e.supplemental)==null?void 0:t.videoCodec;i&&i!==e.videoCodec&&(this.codecSet+=`,${i.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return by(this._audioGroups,e)}hasSubtitleGroup(e){return by(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function by(r,e){return!e||!r?!1:r.indexOf(e)!==-1}function gR(){if(typeof matchMedia=="function"){const r=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(r.media!==e.media)return r.matches===!0}return!1}function yR(r,e){let t=!1,i=[];if(r&&(t=r!=="SDR",i=[r]),e){i=e.allowedVideoRanges||Fh.slice(0);const n=i.join("")!=="SDR"&&!e.videoCodec;t=e.preferHDR!==void 0?e.preferHDR:n&&gR(),t||(i=["SDR"])}return{preferHDR:t,allowedVideoRanges:i}}const vR=r=>{const e=new WeakSet;return(t,i)=>{if(r&&(i=r(t,i)),typeof i=="object"&&i!==null){if(e.has(i))return;e.add(i)}return i}},Xt=(r,e)=>JSON.stringify(r,vR(e));function ER(r,e,t,i,n){const s=Object.keys(r),o=i?.channels,a=i?.audioCodec,l=n?.videoCodec,c=o&&parseInt(o)===2;let u=!1,h=!1,f=1/0,d=1/0,m=1/0,A=1/0,p=0,y=[];const{preferHDR:v,allowedVideoRanges:E}=yR(e,n);for(let S=s.length;S--;){const b=r[s[S]];u||(u=b.channels[2]>0),f=Math.min(f,b.minHeight),d=Math.min(d,b.minFramerate),m=Math.min(m,b.minBitrate),E.filter(R=>b.videoRanges[R]>0).length>0&&(h=!0)}f=He(f)?f:0,d=He(d)?d:0;const x=Math.max(1080,f),I=Math.max(30,d);m=He(m)?m:t,t=Math.max(m,t),h||(e=void 0);const C=s.length>1;return{codecSet:s.reduce((S,b)=>{const T=r[b];if(b===S)return S;if(y=h?E.filter(R=>T.videoRanges[R]>0):[],C){if(T.minBitrate>t)return Ps(b,`min bitrate of ${T.minBitrate} > current estimate of ${t}`),S;if(!T.hasDefaultAudio)return Ps(b,"no renditions with default or auto-select sound found"),S;if(a&&b.indexOf(a.substring(0,4))%5!==0)return Ps(b,`audio codec preference "${a}" not found`),S;if(o&&!c){if(!T.channels[o])return Ps(b,`no renditions with ${o} channel sound found (channels options: ${Object.keys(T.channels)})`),S}else if((!a||c)&&u&&T.channels[2]===0)return Ps(b,"no renditions with stereo sound found"),S;if(T.minHeight>x)return Ps(b,`min resolution of ${T.minHeight} > maximum of ${x}`),S;if(T.minFramerate>I)return Ps(b,`min framerate of ${T.minFramerate} > maximum of ${I}`),S;if(!y.some(R=>T.videoRanges[R]>0))return Ps(b,`no variants with VIDEO-RANGE of ${Xt(y)} found`),S;if(l&&b.indexOf(l.substring(0,4))%5!==0)return Ps(b,`video codec preference "${l}" not found`),S;if(T.maxScore<p)return Ps(b,`max score of ${T.maxScore} < selected max of ${p}`),S}return S&&(Lh(b)>=Lh(S)||T.fragmentError>r[S].fragmentError)?S:(A=T.minIndex,p=T.maxScore,b)},void 0),videoRanges:y,preferHDR:v,minFramerate:d,minBitrate:m,minIndex:A}}function Ps(r,e){Kt.log(`[abr] start candidates with "${r}" ignored because ${e}`)}function sI(r){return r.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const n=t.channels||"2";return i.channels[n]=(i.channels[n]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function xR(r,e,t,i){return r.slice(t,i+1).reduce((n,s,o)=>{if(!s.codecSet)return n;const a=s.audioGroups;let l=n[s.codecSet];l||(n[s.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:o,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!a,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,s.bitrate);const c=Math.min(s.height,s.width);return l.minHeight=Math.min(l.minHeight,c),l.minFramerate=Math.min(l.minFramerate,s.frameRate),l.minIndex=Math.min(l.minIndex,o),l.maxScore=Math.max(l.maxScore,s.score),l.fragmentError+=s.fragmentError,l.videoRanges[s.videoRange]=(l.videoRanges[s.videoRange]||0)+1,a&&a.forEach(u=>{if(!u)return;const h=e.groups[u];h&&(l.hasDefaultAudio=l.hasDefaultAudio||e.hasDefaultAudio?h.hasDefault:h.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(h.channels).forEach(f=>{l.channels[f]=(l.channels[f]||0)+h.channels[f]}))}),n},{})}function wy(r){if(!r)return r;const{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:s}=r;return{lang:e,assocLang:t,characteristics:i,channels:n,audioCodec:s}}function Ks(r,e,t){if("attrs"in r){const i=e.indexOf(r);if(i!==-1)return i}for(let i=0;i<e.length;i++){const n=e[i];if(Ao(r,n,t))return i}return-1}function Ao(r,e,t){const{groupId:i,name:n,lang:s,assocLang:o,default:a}=r,l=r.forced;return(i===void 0||e.groupId===i)&&(n===void 0||e.name===n)&&(s===void 0||IR(s,e.lang))&&(s===void 0||e.assocLang===o)&&(a===void 0||e.default===a)&&(l===void 0||e.forced===l)&&(!("characteristics"in r)||CR(r.characteristics||"",e.characteristics))&&(t===void 0||t(r,e))}function IR(r,e="--"){return r.length===e.length?r===e:r.startsWith(e)||e.startsWith(r)}function CR(r,e=""){const t=r.split(","),i=e.split(",");return t.length===i.length&&!t.some(n=>i.indexOf(n)===-1)}function oo(r,e){const{audioCodec:t,channels:i}=r;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function _R(r,e,t,i,n){const s=e[i],a=e.reduce((f,d,m)=>{const A=d.uri;return(f[A]||(f[A]=[])).push(m),f},{})[s.uri];a.length>1&&(i=Math.max.apply(Math,a));const l=s.videoRange,c=s.frameRate,u=s.codecSet.substring(0,4),h=By(e,i,f=>{if(f.videoRange!==l||f.frameRate!==c||f.codecSet.substring(0,4)!==u)return!1;const d=f.audioGroups,m=t.filter(A=>!d||d.indexOf(A.groupId)!==-1);return Ks(r,m,n)>-1});return h>-1?h:By(e,i,f=>{const d=f.audioGroups,m=t.filter(A=>!d||d.indexOf(A.groupId)!==-1);return Ks(r,m,n)>-1})}function By(r,e,t){for(let i=e;i>-1;i--)if(t(r[i]))return i;for(let i=e+1;i<r.length;i++)if(t(r[i]))return i;return-1}function kh(r,e){var t;return!!r&&r!==((t=e.loadLevelObj)==null?void 0:t.uri)}class rI extends as{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=t=>{var i;const{fragCurrent:n,partCurrent:s,hls:o}=this,{autoLevelEnabled:a,media:l}=o;if(!n||!l)return;const c=performance.now(),u=s?s.stats:n.stats,h=s?s.duration:n.duration,f=c-u.loading.start,d=o.minAutoLevel,m=n.level,A=this._nextAutoLevel;if(u.aborted||u.loaded&&u.loaded===u.total||m<=d){this.clearTimer(),this._nextAutoLevel=-1;return}if(!a)return;const p=A>-1&&A!==m,y=!!t||p;if(!y&&(l.paused||!l.playbackRate||!l.readyState))return;const v=o.mainForwardBufferInfo;if(!y&&v===null)return;const E=this.bwEstimator.getEstimateTTFB(),x=Math.abs(l.playbackRate);if(f<=Math.max(E,1e3*(h/(x*2))))return;const I=v?v.len/x:0,C=u.loading.first?u.loading.first-u.loading.start:-1,_=u.loaded&&C>-1,S=this.getBwEstimate(),b=o.levels,T=b[m],R=Math.max(u.loaded,Math.round(h*(n.bitrate||T.averageBitrate)/8));let w=_?f-C:f;w<1&&_&&(w=Math.min(f,u.loaded*8/S));const B=_?u.loaded*1e3/w:0,M=E/1e3,O=B?(R-u.loaded)/B:R*8/S+M;if(O<=I)return;const U=B?B*8:S,Y=((i=t?.details||this.hls.latestLevelDetails)==null?void 0:i.live)===!0,W=this.hls.config.abrBandWidthUpFactor;let N=Number.POSITIVE_INFINITY,K;for(K=m-1;K>d;K--){const V=b[K].maxBitrate,P=!b[K].details||Y;if(N=this.getTimeToLoadFrag(M,U,h*V,P),N<Math.min(I,h+M))break}if(N>=O||N>h*10)return;_?this.bwEstimator.sample(f-Math.min(E,C),u.loaded):this.bwEstimator.sampleTTFB(f);const D=b[K].maxBitrate;this.getBwEstimate()*W>D&&this.resetEstimator(D);const z=this.findBestLevel(D,d,K,0,I,1,1);z>-1&&(K=z),this.warn(`Fragment ${n.sn}${s?" part "+s.index:""} of level ${m} is loading too slowly;
      Fragment duration: ${n.duration.toFixed(3)}
      Time to underbuffer: ${I.toFixed(3)} s
      Estimated load time for current fragment: ${O.toFixed(3)} s
      Estimated load time for down switch fragment: ${N.toFixed(3)} s
      TTFB estimate: ${C|0} ms
      Current BW estimate: ${He(S)?S|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${K} @ ${D|0} bps`),o.nextLoadLevel=o.nextAutoLevel=K,this.clearTimer();const $=()=>{if(this.clearTimer(),this.fragCurrent===n&&this.hls.loadLevel===K&&K>0){const V=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${K>0?"and switching down":""}
      Fragment duration: ${n.duration.toFixed(3)} s
      Time to underbuffer: ${V.toFixed(3)} s`),n.abortRequests(),this.fragCurrent=this.partCurrent=null,K>d){let P=this.findBestLevel(this.hls.levels[d].bitrate,d,K,0,V,1,1);P===-1&&(P=d),this.hls.nextLoadLevel=this.hls.nextAutoLevel=P,this.resetEstimator(this.hls.levels[P].bitrate)}}};p||O>N*2?$():this.timer=self.setInterval($,N*1e3),o.trigger(L.FRAG_LOAD_EMERGENCY_ABORTED,{frag:n,part:s,stats:u})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new D9(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.FRAG_LOADING,this.onFragLoading,this),e.on(L.FRAG_LOADED,this.onFragLoaded,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this),e.on(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.FRAG_LOADING,this.onFragLoading,this),e.off(L.FRAG_LOADED,this.onFragLoaded,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this),e.off(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(L.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var n;this.fragCurrent=i,this.partCurrent=(n=t.part)!=null?n:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case ue.BUFFER_ADD_CODEC_ERROR:case ue.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case ue.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:n,partCurrent:s}=this;if(i&&n&&i.sn===n.sn&&i.level===n.level){const o=performance.now(),a=s?s.stats:i.stats,l=o-a.loading.start,c=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&c>-1){const h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(l-Math.min(h,c),a.loaded)}else this.bwEstimator.sampleTTFB(l)}break}}}getTimeToLoadFrag(e,t,i,n){const s=e+i/t,o=n?e+this.lastLevelLoadSec:0;return s+o}onLevelLoaded(e,t){const i=this.hls.config,{loading:n}=t.stats,s=n.end-n.first;He(s)&&(this.lastLevelLoadSec=s/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:i}){const n=i?i.stats:t.stats;if(t.type===$e.MAIN&&this.bwEstimator.sampleTTFB(n.loading.first-n.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const s=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+n.loaded,l=(o.loaded?o.loaded.duration:0)+s;o.loaded={bytes:a,duration:l},o.realBitrate=Math.round(8*a/l)}if(t.bitrateTest){const s={stats:n,frag:t,part:i,id:t.type};this.onFragBuffered(L.FRAG_BUFFERED,s),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:n}=t,s=n!=null&&n.stats.loaded?n.stats:i.stats;if(s.aborted||this.ignoreFragment(i))return;const o=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==$e.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),n=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,t,e,0,n,1,1);if(s>-1)return s;const o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),n=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!n||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const s=i&&n?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const o=this.hls.levels;if(o.length>Math.max(e,s)&&o[e].loadError<=o[s].loadError)return e}return this._nextAutoLevel=s,this.nextAutoLevelKey=this.getAutoLevelKey(),s}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this;if(i.levels.length<=1)return i.loadLevel;const{maxAutoLevel:n,config:s,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,l=this.getBwEstimate(),c=this.getStarvationDelay();let u=s.abrBandWidthFactor,h=s.abrBandWidthUpFactor;if(c){const p=this.findBestLevel(l,o,n,c,0,u,h);if(p>=0)return this.rebufferNotice=-1,p}let f=a?Math.min(a,s.maxStarvationDelay):s.maxStarvationDelay;if(!c){const p=this.bitrateTestDelay;p&&(f=(a?Math.min(a,s.maxLoadingDelay):s.maxLoadingDelay)-p,this.info(`bitrate test took ${Math.round(1e3*p)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=h=1)}const d=this.findBestLevel(l,o,n,c,f,u,h);if(this.rebufferNotice!==d&&(this.rebufferNotice=d,this.info(`${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${d}`)),d>-1)return d;const m=i.levels[o],A=i.loadLevelObj;return A&&m?.bitrate<A.bitrate?o:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,n,s,o,a){var l;const c=n+s,u=this.lastLoadedFragLevel,h=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:d}=this,{levels:m,allAudioTracks:A,loadLevel:p,config:y}=this.hls;if(m.length===1)return 0;const v=m[h],E=!!((l=this.hls.latestLevelDetails)!=null&&l.live),x=p===-1||u===-1;let I,C="SDR",_=v?.frameRate||0;const{audioPreference:S,videoPreference:b}=y,T=this.audioTracksByGroup||(this.audioTracksByGroup=sI(A));let R=-1;if(x){if(this.firstSelection!==-1)return this.firstSelection;const U=this.codecTiers||(this.codecTiers=xR(m,T,t,i)),Y=ER(U,C,e,S,b),{codecSet:W,videoRanges:N,minFramerate:K,minBitrate:D,minIndex:z,preferHDR:$}=Y;R=z,I=W,C=$?N[N.length-1]:N[0],_=K,e=Math.max(e,D),this.log(`picked start tier ${Xt(Y)}`)}else I=v?.codecSet,C=v?.videoRange;const w=d?d.duration:f?f.duration:0,B=this.bwEstimator.getEstimateTTFB()/1e3,M=[];for(let U=i;U>=t;U--){var O;const Y=m[U],W=U>h;if(!Y)continue;if(y.useMediaCapabilities&&!Y.supportedResult&&!Y.supportedPromise){const P=navigator.mediaCapabilities;typeof P?.decodingInfo=="function"&&uR(Y,T,C,_,e,S)?(Y.supportedPromise=iI(Y,T,P,this.supportedCache),Y.supportedPromise.then(G=>{if(!this.hls)return;Y.supportedResult=G;const F=this.hls.levels,k=F.indexOf(Y);G.error?this.warn(`MediaCapabilities decodingInfo error: "${G.error}" for level ${k} ${Xt(G)}`):G.supported?G.decodingInfoResults.some(Z=>Z.smooth===!1||Z.powerEfficient===!1)&&this.log(`MediaCapabilities decodingInfo for level ${k} not smooth or powerEfficient: ${Xt(G)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${k} ${Xt(G)}`),k>-1&&F.length>1&&(this.log(`Removing unsupported level ${k}`),this.hls.removeLevel(k),this.hls.loadLevel===-1&&(this.hls.nextLoadLevel=0)))}).catch(G=>{this.warn(`Error handling MediaCapabilities decodingInfo: ${G}`)})):Y.supportedResult=eI}if((I&&Y.codecSet!==I||C&&Y.videoRange!==C||W&&_>Y.frameRate||!W&&_>0&&_<Y.frameRate||(O=Y.supportedResult)!=null&&(O=O.decodingInfoResults)!=null&&O.some(P=>P.smooth===!1))&&(!x||U!==R)){M.push(U);continue}const N=Y.details,K=(d?N?.partTarget:N?.averagetargetduration)||w;let D;W?D=a*e:D=o*e;const z=w&&n>=w*2&&s===0?Y.averageBitrate:Y.maxBitrate,$=this.getTimeToLoadFrag(B,D,z*K,N===void 0);if(D>=z&&(U===u||Y.loadError===0&&Y.fragmentError===0)&&($<=B||!He($)||E&&!this.bitrateTestDelay||$<c)){const P=this.forcedAutoLevel;return U!==p&&(P===-1||P!==p)&&(M.length&&this.trace(`Skipped level(s) ${M.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${m[M[0]].codecs}" ${m[M[0]].videoRange}; not compatible with "${I}" ${C}`),this.info(`switch candidate:${h}->${U} adjustedbw(${Math.round(D)})-bitrate=${Math.round(D-z)} ttfb:${B.toFixed(1)} avgDuration:${K.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${$.toFixed(1)} firstSelection:${x} codecSet:${Y.codecSet} videoRange:${Y.videoRange} hls.loadLevel:${p}`)),x&&(this.firstSelection=U),U}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls;return Math.min(Math.max(e,i),t)}}const oI={search:function(r,e){let t=0,i=r.length-1,n=null,s=null;for(;t<=i;){n=(t+i)/2|0,s=r[n];const o=e(s);if(o>0)t=n+1;else if(o<0)i=n-1;else return s}return null}};function SR(r,e,t){if(e===null||!Array.isArray(r)||!r.length||!He(e))return null;const i=r[0].programDateTime;if(e<(i||0))return null;const n=r[r.length-1].endProgramDateTime;if(e>=(n||0))return null;for(let s=0;s<r.length;++s){const o=r[s];if(bR(e,t,o))return o}return null}function yo(r,e,t=0,i=0,n=.005){let s=null;if(r){s=e[1+r.sn-e[0].sn]||null;const a=r.endDTS-t;a>0&&a<15e-7&&(t+=15e-7),s&&r.level!==s.level&&s.end<=r.end&&(s=e[2+r.sn-e[0].sn]||null)}else t===0&&e[0].start===0&&(s=e[0]);if(s&&((!r||r.level===s.level)&&Ry(t,i,s)===0||TR(s,r,Math.min(n,i))))return s;const o=oI.search(e,Ry.bind(null,t,i));return o&&(o!==r||!s)?o:s}function TR(r,e,t){if(e&&e.start===0&&e.level<r.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((n,s)=>(s[0]==="INF"&&(n+=parseFloat(s[1])),n),t);return r.start<=i}return!1}function Ry(r=0,e=0,t){if(t.start<=r&&t.start+t.duration>r)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=r?1:t.start-i>r&&t.start?-1:0}function bR(r,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>r}function aI(r,e,t){if(r&&r.startCC<=e&&r.endCC>=e){let i=r.fragments;const{fragmentHint:n}=r;n&&(i=i.concat(n));let s;return oI.search(i,o=>o.cc<e?1:o.cc>e?-1:(s=o,o.end<=t?1:o.start>t?-1:0)),s||null}return null}function Oh(r){switch(r.details){case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_TIMEOUT:case ue.LEVEL_LOAD_TIMEOUT:case ue.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function lI(r){return r.details.startsWith("key")}function cI(r){return lI(r)&&!!r.frag&&!r.frag.decryptdata}function Dy(r,e){const t=Oh(e);return r.default[`${t?"timeout":"error"}Retry`]}function VA(r,e){const t=r.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*r.retryDelayMs,r.maxRetryDelayMs)}function My(r){return Ht(Ht({},r),{errorRetry:null,timeoutRetry:null})}function Uh(r,e,t,i){if(!r)return!1;const n=i?.code,s=e<r.maxNumRetry&&(wR(n)||!!t);return r.shouldRetry?r.shouldRetry(r,e,t,i,s):s}function wR(r){return wm(r)||!!r&&(r<400||r>499)}function wm(r){return r===0&&navigator.onLine===!1}var Ui={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},En={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,MoveAllAlternatesMatchingKey:4,SwitchToSDR:8};class uI extends as{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(L.ERROR,this.onError,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(L.ERROR,this.onError,this),e.off(L.ERROR,this.onErrorOut,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return e?.type===$e.MAIN?e.level:this.getVariantIndex()}getVariantIndex(){var e;const t=this.hls,i=t.currentLevel;return(e=t.loadLevelObj)!=null&&e.details||i===-1?t.loadLevel:i}variantHasKey(e,t){if(e){var i;if((i=e.details)!=null&&i.hasKey(t))return!0;const n=e.audioGroups;if(n)return this.hls.allAudioTracks.filter(o=>n.indexOf(o.groupId)>=0).some(o=>{var a;return(a=o.details)==null?void 0:a.hasKey(t)})}return!1}onManifestLoading(){this.playlistError=0}onLevelUpdated(){this.playlistError=0}onError(e,t){var i;if(t.fatal)return;const n=this.hls,s=t.context;switch(t.details){case ue.FRAG_LOAD_ERROR:case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_ERROR:case ue.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case ue.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=_a();return}case ue.FRAG_GAP:case ue.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=Ui.SendAlternateToPenaltyBox;return}case ue.LEVEL_EMPTY_ERROR:case ue.LEVEL_PARSING_ERROR:{var o;const l=t.parent===$e.MAIN?t.level:n.loadLevel;t.details===ue.LEVEL_EMPTY_ERROR&&((o=t.context)!=null&&(o=o.levelDetails)!=null&&o.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,l):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,l))}return;case ue.LEVEL_LOAD_ERROR:case ue.LEVEL_LOAD_TIMEOUT:typeof s?.level=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.level));return;case ue.AUDIO_TRACK_LOAD_ERROR:case ue.AUDIO_TRACK_LOAD_TIMEOUT:case ue.SUBTITLE_LOAD_ERROR:case ue.SUBTITLE_TRACK_LOAD_TIMEOUT:if(s){const l=n.loadLevelObj;if(l&&(s.type===Ct.AUDIO_TRACK&&l.hasAudioGroup(s.groupId)||s.type===Ct.SUBTITLE_TRACK&&l.hasSubtitleGroup(s.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.loadLevel),t.errorAction.action=Ui.SendAlternateToPenaltyBox,t.errorAction.flags=En.MoveAllAlternatesMatchingHost;return}}return;case ue.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:t.errorAction={action:Ui.SendAlternateToPenaltyBox,flags:En.MoveAllAlternatesMatchingHDCP};return;case ue.KEY_SYSTEM_SESSION_UPDATE_FAILED:case ue.KEY_SYSTEM_STATUS_INTERNAL_ERROR:case ue.KEY_SYSTEM_NO_SESSION:t.errorAction={action:Ui.SendAlternateToPenaltyBox,flags:En.MoveAllAlternatesMatchingKey};return;case ue.BUFFER_ADD_CODEC_ERROR:case ue.REMUX_ALLOC_ERROR:case ue.BUFFER_APPEND_ERROR:if(!t.errorAction){var a;t.errorAction=this.getLevelSwitchAction(t,(a=t.level)!=null?a:n.loadLevel)}return;case ue.INTERNAL_EXCEPTION:case ue.BUFFER_APPENDING_ERROR:case ue.BUFFER_FULL_ERROR:case ue.LEVEL_SWITCH_ERROR:case ue.BUFFER_STALLED_ERROR:case ue.BUFFER_SEEK_OVER_HOLE:case ue.BUFFER_NUDGE_ON_STALL:t.errorAction=_a();return}t.type===Je.KEY_SYSTEM_ERROR&&(t.levelRetry=!1,t.errorAction=_a())}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,n=Dy(i.config.playlistLoadPolicy,e),s=this.playlistError++;if(Uh(n,s,Oh(e),e.response))return{action:Ui.RetryRequest,flags:En.None,retryConfig:n,retryCount:s};const a=this.getLevelSwitchAction(e,t);return n&&(a.retryConfig=n,a.retryCount=s),a}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),n=t.levels[i],{fragLoadPolicy:s,keyLoadPolicy:o}=t.config,a=Dy(lI(e)?o:s,e),l=t.levels.reduce((u,h)=>u+h.fragmentError,0);if(n&&(e.details!==ue.FRAG_GAP&&n.fragmentError++,!cI(e)&&Uh(a,l,Oh(e),e.response)))return{action:Ui.RetryRequest,flags:En.None,retryConfig:a,retryCount:l};const c=this.getLevelSwitchAction(e,i);return a&&(c.retryConfig=a,c.retryCount=l),c}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const n=this.hls.levels[t];if(n){var s,o;const c=e.details;n.loadError++,c===ue.BUFFER_APPEND_ERROR&&n.fragmentError++;let u=-1;const{levels:h,loadLevel:f,minAutoLevel:d,maxAutoLevel:m}=i;!i.autoLevelEnabled&&!i.config.preserveManualLevelOnError&&(i.loadLevel=-1);const A=(s=e.frag)==null?void 0:s.type,y=(A===$e.AUDIO&&c===ue.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(c===ue.BUFFER_ADD_CODEC_ERROR||c===ue.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:C})=>n.audioCodec!==C),E=e.sourceBufferName==="video"&&(c===ue.BUFFER_ADD_CODEC_ERROR||c===ue.BUFFER_APPEND_ERROR)&&h.some(({codecSet:C,audioCodec:_})=>n.codecSet!==C&&n.audioCodec===_),{type:x,groupId:I}=(o=e.context)!=null?o:{};for(let C=h.length;C--;){const _=(C+f)%h.length;if(_!==f&&_>=d&&_<=m&&h[_].loadError===0){var a,l;const S=h[_];if(c===ue.FRAG_GAP&&A===$e.MAIN&&e.frag){const b=h[_].details;if(b){const T=yo(e.frag,b.fragments,e.frag.start);if(T!=null&&T.gap)continue}}else{if(x===Ct.AUDIO_TRACK&&S.hasAudioGroup(I)||x===Ct.SUBTITLE_TRACK&&S.hasSubtitleGroup(I))continue;if(A===$e.AUDIO&&(a=n.audioGroups)!=null&&a.some(b=>S.hasAudioGroup(b))||A===$e.SUBTITLE&&(l=n.subtitleGroups)!=null&&l.some(b=>S.hasSubtitleGroup(b))||y&&n.audioCodec===S.audioCodec||E&&n.codecSet===S.codecSet||!y&&n.codecSet!==S.codecSet)continue}u=_;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:Ui.SendAlternateToPenaltyBox,flags:En.None,nextAutoLevel:u}}return{action:Ui.SendAlternateToPenaltyBox,flags:En.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case Ui.DoNothing:break;case Ui.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==ue.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case Ui.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:n}=i,s=i.nextAutoLevel;switch(n){case En.None:this.switchLevel(e,s);break;case En.MoveAllAlternatesMatchingHDCP:{const l=this.getVariantLevelIndex(e.frag),c=t.levels[l],u=c?.attrs["HDCP-LEVEL"];if(i.hdcpLevel=u,u==="NONE")this.warn("HDCP policy resticted output with HDCP-LEVEL=NONE");else if(u){t.maxHdcpLevel=Tm[Tm.indexOf(u)-1],i.resolved=!0,this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}}case En.MoveAllAlternatesMatchingKey:{const l=e.decryptdata;if(l){const c=this.hls.levels,u=c.length;for(let f=u;f--;)if(this.variantHasKey(c[f],l)){var o,a;this.log(`Banned key found in level ${f} (${c[f].bitrate}bps) or audio group "${(o=c[f].audioGroups)==null?void 0:o.join(",")}" (${(a=e.frag)==null?void 0:a.type} fragment) ${an(l.keyId||[])}`),c[f].fragmentError++,c[f].loadError++,this.log(`Removing level ${f} with key error (${e.error})`),this.hls.removeLevel(f)}const h=e.frag;if(this.hls.levels.length<u)i.resolved=!0;else if(h&&h.type!==$e.MAIN){const f=h.decryptdata;f&&!l.matches(f)&&(i.resolved=!0)}}break}}i.resolved||this.switchLevel(e,s)}switchLevel(e,t){if(t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===ue.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo")){const i=Sm(e.mimeType),n=this.hls.levels;for(let s=n.length;s--;)n[s][`${e.sourceBufferName}Codec`]===i&&(this.log(`Removing level ${s} for ${e.details} ("${i}" not supported)`),this.hls.removeLevel(s))}}}function _a(r){const e={action:Ui.DoNothing,flags:En.None};return r&&(e.resolved=!0),e}var Ni={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class BR{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e&&(e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.BUFFER_APPENDED,this.onBufferAppended,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this),e.on(L.FRAG_LOADED,this.onFragLoaded,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.BUFFER_APPENDED,this.onBufferAppended,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this),e.off(L.FRAG_LOADED,this.onFragLoaded,this))}destroy(){this._unregisterListeners(),this.hls=this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let n=i.length;n--;){const s=i[n];if(!s)break;if(s.start<=e&&e<=s.end&&s.loaded)return s}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,i){const{fragments:n}=this,s=Object.keys(n);for(let o=s.length;o--;){const a=n[s[o]];if(a?.body.type===t&&(!i||a.buffered)){const l=a.body;if(l.start<=e&&e<=l.end)return l}}return null}detectEvictedFragments(e,t,i,n,s){this.timeRanges&&(this.timeRanges[e]=t);const o=n?.fragment.sn||-1;Object.keys(this.fragments).forEach(a=>{const l=this.fragments[a];if(!l||o>=l.body.sn)return;if(!l.buffered&&(!l.loaded||s)){l.body.type===i&&this.removeFragment(l.body);return}const c=l.range[e];if(c){if(c.time.length===0){this.removeFragment(l.body);return}c.time.some(u=>{const h=!this.isTimeBuffered(u.startPTS,u.endPTS,t);return h&&this.removeFragment(l.body),h})}})}detectPartialFragments(e){const t=this.timeRanges;if(!t||e.frag.sn==="initSegment")return;const i=e.frag,n=zo(i),s=this.fragments[n];if(!s||s.buffered&&i.gap)return;const o=!i.relurl;Object.keys(t).forEach(a=>{const l=i.elementaryStreams[a];if(!l)return;const c=t[a],u=o||l.partial===!0;s.range[a]=this.getBufferedTimes(i,e.part,u,c)}),s.loaded=null,Object.keys(s.range).length?(s.buffered=!0,(s.body.endList=i.endList||s.body.endList)&&(this.endListFragments[s.body.type]=s),du(s)||this.removeParts(i.sn-1,i.type)):this.removeFragment(s.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=Ly(i,n=>n.fragment.sn>=e))}fragBuffered(e,t){const i=zo(e);let n=this.fragments[i];!n&&t&&(n=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),n&&(n.loaded=null,n.buffered=!0)}getBufferedTimes(e,t,i,n){const s={time:[],partial:i},o=e.start,a=e.end,l=e.minEndPTS||a,c=e.maxStartPTS||o;for(let u=0;u<n.length;u++){const h=n.start(u)-this.bufferPadding,f=n.end(u)+this.bufferPadding;if(c>=h&&l<=f){s.time.push({startPTS:Math.max(o,n.start(u)),endPTS:Math.min(a,n.end(u))});break}else if(o<f&&a>h){const d=Math.max(o,n.start(u)),m=Math.min(a,n.end(u));m>d&&(s.partial=!0,s.time.push({startPTS:d,endPTS:m}))}else if(a<=h)break}return s}getPartialFragment(e){let t=null,i,n,s,o=0;const{bufferPadding:a,fragments:l}=this;return Object.keys(l).forEach(c=>{const u=l[c];u&&du(u)&&(n=u.body.start-a,s=u.body.end+a,e>=n&&e<=s&&(i=Math.min(e-n,s-e),o<=i&&(t=u.body,o=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||du(t))}getState(e){const t=zo(e),i=this.fragments[t];return i?i.buffered?du(i)?Ni.PARTIAL:Ni.OK:Ni.APPENDING:Ni.NOT_LOADED}isTimeBuffered(e,t,i){let n,s;for(let o=0;o<i.length;o++){if(n=i.start(o)-this.bufferPadding,s=i.end(o)+this.bufferPadding,e>=n&&t<=s)return!0;if(t<=n)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if(t.frag.sn==="initSegment"||t.frag.bitrateTest)return;const i=t.frag,n=t.part?null:t,s=zo(i);this.fragments[s]={body:i,appendedPTS:null,loaded:n,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:n,timeRanges:s,type:o}=t;if(i.sn==="initSegment")return;const a=i.type;if(n){let c=this.activePartLists[a];c||(this.activePartLists[a]=c=[]),c.push(n)}this.timeRanges=s;const l=s[o];this.detectEvictedFragments(o,l,a,n)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=zo(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,i=Object.keys(t);if(!e)return i.length>0;for(let n=i.length;n--;){const s=t[i[n]];if(s?.body.type===e)return!0}return!1}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,n,s){n&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a)return;const l=a.body;l.type!==i||n&&!l.gap||l.start<t&&l.end>e&&(a.buffered||s)&&this.removeFragment(l)})}removeFragment(e){const t=zo(e);e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const n=e.sn;this.activePartLists[e.type]=Ly(i,s=>s.fragment.sn!==n)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const t=(e=this.hls)==null||(e=e.latestLevelDetails)==null?void 0:e.partList;t&&t.forEach(i=>i.clearElementaryStreamInfo())}}function du(r){var e,t,i;return r.buffered&&!!(r.body.gap||(e=r.range.video)!=null&&e.partial||(t=r.range.audio)!=null&&t.partial||(i=r.range.audiovideo)!=null&&i.partial)}function zo(r){return`${r.type}_${r.level}_${r.sn}`}function Ly(r,e){return r.filter(t=>{const i=e(t);return i||t.clearElementaryStreamInfo(),i})}var Kr={cbc:0,ctr:1};class RR{constructor(e,t,i){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=i}decrypt(e,t){switch(this.aesMode){case Kr.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case Kr.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}function DR(r){const e=r.byteLength,t=e&&new DataView(r.buffer).getUint8(e-1);return t?r.slice(0,e-t):r}class MR{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let n=0;n<4;n++)i[n]=t.getUint32(n*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,n=i[0],s=i[1],o=i[2],a=i[3],l=this.invSubMix,c=l[0],u=l[1],h=l[2],f=l[3],d=new Uint32Array(256);let m=0,A=0,p=0;for(p=0;p<256;p++)p<128?d[p]=p<<1:d[p]=p<<1^283;for(p=0;p<256;p++){let y=A^A<<1^A<<2^A<<3^A<<4;y=y>>>8^y&255^99,e[m]=y,t[y]=m;const v=d[m],E=d[v],x=d[E];let I=d[y]*257^y*16843008;n[m]=I<<24|I>>>8,s[m]=I<<16|I>>>16,o[m]=I<<8|I>>>24,a[m]=I,I=x*16843009^E*65537^v*257^m*16843008,c[y]=I<<24|I>>>8,u[y]=I<<16|I>>>16,h[y]=I<<8|I>>>24,f[y]=I,m?(m=v^d[d[d[x^v]]],A^=d[d[A]]):m=A=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,n=0;for(;n<t.length&&i;)i=t[n]===this.key[n],n++;if(i)return;this.key=t;const s=this.keySize=t.length;if(s!==4&&s!==6&&s!==8)throw new Error("Invalid aes key size="+s);const o=this.ksRows=(s+6+1)*4;let a,l;const c=this.keySchedule=new Uint32Array(o),u=this.invKeySchedule=new Uint32Array(o),h=this.sBox,f=this.rcon,d=this.invSubMix,m=d[0],A=d[1],p=d[2],y=d[3];let v,E;for(a=0;a<o;a++){if(a<s){v=c[a]=t[a];continue}E=v,a%s===0?(E=E<<8|E>>>24,E=h[E>>>24]<<24|h[E>>>16&255]<<16|h[E>>>8&255]<<8|h[E&255],E^=f[a/s|0]<<24):s>6&&a%s===4&&(E=h[E>>>24]<<24|h[E>>>16&255]<<16|h[E>>>8&255]<<8|h[E&255]),c[a]=v=(c[a-s]^E)>>>0}for(l=0;l<o;l++)a=o-l,l&3?E=c[a]:E=c[a-4],l<4||a<=4?u[l]=E:u[l]=m[h[E>>>24]]^A[h[E>>>16&255]]^p[h[E>>>8&255]]^y[h[E&255]],u[l]=u[l]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const n=this.keySize+6,s=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,l=a[0],c=a[1],u=a[2],h=a[3],f=this.uint8ArrayToUint32Array_(i);let d=f[0],m=f[1],A=f[2],p=f[3];const y=new Int32Array(e),v=new Int32Array(y.length);let E,x,I,C,_,S,b,T,R,w,B,M,O,U;const Y=this.networkToHostOrderSwap;for(;t<y.length;){for(R=Y(y[t]),w=Y(y[t+1]),B=Y(y[t+2]),M=Y(y[t+3]),_=R^s[0],S=M^s[1],b=B^s[2],T=w^s[3],O=4,U=1;U<n;U++)E=l[_>>>24]^c[S>>16&255]^u[b>>8&255]^h[T&255]^s[O],x=l[S>>>24]^c[b>>16&255]^u[T>>8&255]^h[_&255]^s[O+1],I=l[b>>>24]^c[T>>16&255]^u[_>>8&255]^h[S&255]^s[O+2],C=l[T>>>24]^c[_>>16&255]^u[S>>8&255]^h[b&255]^s[O+3],_=E,S=x,b=I,T=C,O=O+4;E=o[_>>>24]<<24^o[S>>16&255]<<16^o[b>>8&255]<<8^o[T&255]^s[O],x=o[S>>>24]<<24^o[b>>16&255]<<16^o[T>>8&255]<<8^o[_&255]^s[O+1],I=o[b>>>24]<<24^o[T>>16&255]<<16^o[_>>8&255]<<8^o[S&255]^s[O+2],C=o[T>>>24]<<24^o[_>>16&255]<<16^o[S>>8&255]<<8^o[b&255]^s[O+3],v[t]=Y(E^d),v[t+1]=Y(C^m),v[t+2]=Y(I^A),v[t+3]=Y(x^p),d=R,m=w,A=B,p=M,t=t+4}return v.buffer}}class LR{constructor(e,t,i){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=i}expandKey(){const e=PR(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}function PR(r){switch(r){case Kr.cbc:return"AES-CBC";case Kr.ctr:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${r}`)}}const FR=16;class KA{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?DR(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i,n){return this.useSoftware?new Promise((s,o)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,i,n);const l=this.flush();l?s(l.buffer):o(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i,n)}softwareDecrypt(e,t,i,n){const{currentIV:s,currentResult:o,remainderData:a}=this;if(n!==Kr.cbc||t.byteLength!==16)return Kt.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=rs(a,e),this.remainderData=null);const l=this.getValidChunk(e);if(!l.length)return null;s&&(i=s);let c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new MR),c.expandKey(t);const u=o;return this.currentResult=c.decrypt(l.buffer,0,i),this.currentIV=l.slice(-16).buffer,u||null}webCryptoDecrypt(e,t,i,n){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i,n));this.key=t,this.fastAesKey=new LR(this.subtle,t,n)}return this.fastAesKey.expandKey().then(s=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new RR(this.subtle,new Uint8Array(i),n).decrypt(e.buffer,s)):Promise.reject(new Error("web crypto not initialized"))).catch(s=>(Kt.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${s.name}: ${s.message}`),this.onWebCryptoError(e,t,i,n)))}onWebCryptoError(e,t,i,n){const s=this.enableSoftwareAES;if(s){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i,n);const o=this.flush();if(o)return o.buffer}throw new Error("WebCrypto"+(s?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%FR;return i!==e.length&&(t=e.slice(0,i),this.remainderData=e.slice(i)),t}logOnce(e){this.logEnabled&&(Kt.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const Py=Math.pow(2,17);class kR{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new ur({type:Je.NETWORK_ERROR,details:ue.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const n=this.config,s=n.fLoader,o=n.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(m=>m[0]==="GAP")){l(ky(e));return}else e.gap=!1;const c=this.loader=s?new s(n):new o(n),u=Fy(e);e.loader=c;const h=My(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Py};e.stats=c.stats;const d={onSuccess:(m,A,p,y)=>{this.resetLoader(e,c);let v=m.data;p.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(v.slice(0,16)),v=v.slice(16)),a({frag:e,part:null,payload:v,networkDetails:y})},onError:(m,A,p,y)=>{this.resetLoader(e,c),l(new ur({type:Je.NETWORK_ERROR,details:ue.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:Ht({url:i,data:void 0},m),error:new Error(`HTTP Error ${m.code} ${m.text}`),networkDetails:p,stats:y}))},onAbort:(m,A,p)=>{this.resetLoader(e,c),l(new ur({type:Je.NETWORK_ERROR,details:ue.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:p,stats:m}))},onTimeout:(m,A,p)=>{this.resetLoader(e,c),l(new ur({type:Je.NETWORK_ERROR,details:ue.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:p,stats:m}))}};t&&(d.onProgress=(m,A,p,y)=>t({frag:e,part:null,payload:p,networkDetails:y})),c.load(u,f,d)})}loadPart(e,t,i){this.abort();const n=this.config,s=n.fLoader,o=n.loader;return new Promise((a,l)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){l(ky(e,t));return}const c=this.loader=s?new s(n):new o(n),u=Fy(e,t);e.loader=c;const h=My(n.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Py};t.stats=c.stats,c.load(u,f,{onSuccess:(d,m,A,p)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const y={frag:e,part:t,payload:d.data,networkDetails:p};i(y),a(y)},onError:(d,m,A,p)=>{this.resetLoader(e,c),l(new ur({type:Je.NETWORK_ERROR,details:ue.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:Ht({url:u.url,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:A,stats:p}))},onAbort:(d,m,A)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),l(new ur({type:Je.NETWORK_ERROR,details:ue.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:A,stats:d}))},onTimeout:(d,m,A)=>{this.resetLoader(e,c),l(new ur({type:Je.NETWORK_ERROR,details:ue.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:A,stats:d}))}})})}updateStatsFromPart(e,t){const i=e.stats,n=t.stats,s=n.total;if(i.loaded+=n.loaded,s){const l=Math.round(e.duration/t.duration),c=Math.min(Math.round(i.loaded/s),l),h=(l-c)*Math.round(i.loaded/c);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);const o=i.loading,a=n.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function Fy(r,e=null){const t=e||r,i={frag:r,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},n=t.byteRangeStartOffset,s=t.byteRangeEndOffset;if(He(n)&&He(s)){var o;let a=n,l=s;if(r.sn==="initSegment"&&OR((o=r.decryptdata)==null?void 0:o.method)){const c=s-n;c%16&&(l=s+(16-c%16)),n!==0&&(i.resetIV=!0,a=n-16)}i.rangeStart=a,i.rangeEnd=l}return i}function ky(r,e){const t=new Error(`GAP ${r.gap?"tag":"attribute"} found`),i={type:Je.MEDIA_ERROR,details:ue.FRAG_GAP,fatal:!1,frag:r,error:t,networkDetails:null};return e&&(i.part=e),(e||r).stats.aborted=!0,new ur(i)}function OR(r){return r==="AES-128"||r==="AES-256"}class ur extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class hI extends as{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class pf{constructor(e,t,i,n=0,s=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=mu(),this.buffering={audio:mu(),video:mu(),audiovideo:mu()},this.level=e,this.sn=t,this.id=i,this.size=n,this.part=s,this.partial=o}}function mu(){return{start:0,executeStart:0,executeEnd:0,end:0}}const Oy={length:0,start:()=>0,end:()=>0};class dt{static isBuffered(e,t){if(e){const i=dt.getBuffered(e);for(let n=i.length;n--;)if(t>=i.start(n)&&t<=i.end(n))return!0}return!1}static bufferedRanges(e){if(e){const t=dt.getBuffered(e);return dt.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}static bufferInfo(e,t,i){if(e){const n=dt.bufferedRanges(e);if(n.length)return dt.bufferedInfo(n,t,i)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.length>1&&e.sort((u,h)=>u.start-h.start||h.end-u.end);let n=-1,s=[];if(i)for(let u=0;u<e.length;u++){t>=e[u].start&&t<=e[u].end&&(n=u);const h=s.length;if(h){const f=s[h-1].end;e[u].start-f<i?e[u].end>f&&(s[h-1].end=e[u].end):s.push(e[u])}else s.push(e[u])}else s=e;let o=0,a,l=t,c=t;for(let u=0;u<s.length;u++){const h=s[u].start,f=s[u].end;if(n===-1&&t>=h&&t<=f&&(n=u),t+i>=h&&t<f)l=h,c=f,o=c-t;else if(t+i<h){a=h;break}}return{len:o,start:l||0,end:c||0,nextStart:a,buffered:e,bufferedIndex:n}}static getBuffered(e){try{return e.buffered||Oy}catch(t){return Kt.log("failed to get media.buffered",t),Oy}}}const fI=/\{\$([a-zA-Z0-9-_]+)\}/g;function Uy(r){return fI.test(r)}function Bm(r,e){if(r.variableList!==null||r.hasVariableRefs){const t=r.variableList;return e.replace(fI,i=>{const n=i.substring(2,i.length-1),s=t?.[n];return s===void 0?(r.playlistParsingError||(r.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${n}"`)),i):s})}return e}function Ny(r,e,t){let i=r.variableList;i||(r.variableList=i={});let n,s;if("QUERYPARAM"in e){n=e.QUERYPARAM;try{const o=new self.URL(t).searchParams;if(o.has(n))s=o.get(n);else throw new Error(`"${n}" does not match any query parameter in URI: "${t}"`)}catch(o){r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else n=e.NAME,s=e.VALUE;n in i?r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${n}"`)):i[n]=s||""}function UR(r,e,t){const i=e.IMPORT;if(t&&i in t){let n=r.variableList;n||(r.variableList=n={}),n[i]=t[i]}else r.playlistParsingError||(r.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}const NR=/^(\d+)x(\d+)$/,Gy=/(.+?)=(".*?"|.*?)(?:,|$)/g;class li{constructor(e,t){typeof e=="string"&&(e=li.parseAttrList(e,t)),Yt(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let n=0;n<t.length/2;n++)i[n]=parseInt(t.slice(n*2,n*2+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const i=this[e];return(i?i.split(/[ ,]+/):[]).reduce((n,s)=>(n[s.toLowerCase()]=!0,n),t)}bool(e){return this[e]==="YES"}decimalResolution(e){const t=NR.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let i;const n={};for(Gy.lastIndex=0;(i=Gy.exec(e))!==null;){const o=i[1].trim();let a=i[2];const l=a.indexOf('"')===0&&a.lastIndexOf('"')===a.length-1;let c=!1;if(l)a=a.slice(1,-1);else switch(o){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":c=!0}if(t&&(l||c))a=Bm(t,a);else if(!c&&!l)switch(o){case"CLOSED-CAPTIONS":if(a==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":Kt.warn(`${e}: attribute ${o} is missing quotes`)}n[o]=a}return n}}const GR="com.apple.hls.interstitial";function QR(r){return r!=="ID"&&r!=="CLASS"&&r!=="CUE"&&r!=="START-DATE"&&r!=="DURATION"&&r!=="END-DATE"&&r!=="END-ON-NEXT"}function zR(r){return r==="SCTE35-OUT"||r==="SCTE35-IN"||r==="SCTE35-CMD"}class $A{constructor(e,t,i=0){var n;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=t?.tagAnchor||null,this.tagOrder=(n=t?.tagOrder)!=null?n:i,t){const s=t.attr;for(const o in s)if(Object.prototype.hasOwnProperty.call(e,o)&&e[o]!==s[o]){Kt.warn(`DATERANGE tag attribute: "${o}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=o;break}e=Yt(new li({}),s,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const s=t?.endDate||new Date(this.attr["END-DATE"]);He(s.getTime())&&(this._endDate=s)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return e===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return e===null||e.programDateTime===null?(Kt.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return t!==null?this._dateAtEnd=new Date(this._startDate.getTime()+t*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(He(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return this.class===GR}get isValid(){return!!this.id&&!this._badValueForSameId&&He(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}const HR=10;class dI{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1}hasKey(e){return this.encryptedFragments.some(t=>{let i=t.decryptdata;return i||(t.setKeyFormat(e.keyFormat),i=t.decryptdata),!!i&&e.matches(i)})}get hasProgramDateTime(){return this.fragments.length?He(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||HR}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){return this.fragments.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){return this.fragments.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(t!==-1){for(let i=e.length;i--;)if(e[i].index>t)return e[i].index;return t}}return 0}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function Nh(r,e){return r.length===e.length?!r.some((t,i)=>t!==e[i]):!1}function Qy(r,e){return!r&&!e?!0:!r||!e?!1:Nh(r,e)}function Sa(r){return r==="AES-128"||r==="AES-256"||r==="AES-256-CTR"}function YA(r){switch(r){case"AES-128":case"AES-256":return Kr.cbc;case"AES-256-CTR":return Kr.ctr;default:throw new Error(`invalid full segment method ${r}`)}}function WA(r){return Uint8Array.from(atob(r),e=>e.charCodeAt(0))}function Rm(r){return Uint8Array.from(unescape(encodeURIComponent(r)),e=>e.charCodeAt(0))}function VR(r){const e=Rm(r).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function mI(r){const e=function(i,n,s){const o=i[n];i[n]=i[s],i[s]=o};e(r,0,3),e(r,1,2),e(r,4,5),e(r,6,7)}function AI(r){const e=r.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),n=i[i.length-1].split(",");if(n.length===2){const s=n[0]==="base64",o=n[1];s?(i.splice(-1,1),t=WA(o)):t=VR(o)}}return t}const Gh=typeof self<"u"?self:void 0;var ci={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Wi={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function ch(r){switch(r){case Wi.FAIRPLAY:return ci.FAIRPLAY;case Wi.PLAYREADY:return ci.PLAYREADY;case Wi.WIDEVINE:return ci.WIDEVINE;case Wi.CLEARKEY:return ci.CLEARKEY}}function Gd(r){switch(r){case ci.FAIRPLAY:return Wi.FAIRPLAY;case ci.PLAYREADY:return Wi.PLAYREADY;case ci.WIDEVINE:return Wi.WIDEVINE;case ci.CLEARKEY:return Wi.CLEARKEY}}function Hl(r){const{drmSystems:e,widevineLicenseUrl:t}=r,i=e?[ci.FAIRPLAY,ci.WIDEVINE,ci.PLAYREADY,ci.CLEARKEY].filter(n=>!!e[n]):[];return!i[ci.WIDEVINE]&&t&&i.push(ci.WIDEVINE),i}const jA=(function(r){return Gh!=null&&(r=Gh.navigator)!=null&&r.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null})();function KR(r,e,t,i){let n;switch(r){case ci.FAIRPLAY:n=["cenc","sinf"];break;case ci.WIDEVINE:case ci.PLAYREADY:n=["cenc"];break;case ci.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${r}`)}return $R(n,e,t,i)}function $R(r,e,t,i){return[{initDataTypes:r,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(s=>({contentType:`audio/mp4; codecs=${s}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(s=>({contentType:`video/mp4; codecs=${s}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function YR(r){var e;return!!r&&(r.sessionType==="persistent-license"||!!((e=r.sessionTypes)!=null&&e.some(t=>t==="persistent-license")))}function pI(r){const e=new Uint16Array(r.buffer,r.byteOffset,r.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),o=new DOMParser().parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(o){const a=o.childNodes[0]?o.childNodes[0].nodeValue:o.getAttribute("VALUE");if(a){const l=WA(a).subarray(0,16);return mI(l),l}}return null}let Au={};class Qr{static clearKeyUriToKeyIdMap(){Au={}}static setKeyIdForUri(e,t){Au[e]=t}constructor(e,t,i,n=[1],s=null,o){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=n,this.iv=s,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!Sa(e),o!=null&&o.startsWith("0x")&&(this.keyId=new Uint8Array(Hx(o)))}matches(e){return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&Nh(e.keyFormatVersions,this.keyFormatVersions)&&Qy(e.iv,this.iv)&&Qy(e.keyId,this.keyId)}isSupported(){if(this.method){if(Sa(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Wi.FAIRPLAY:case Wi.WIDEVINE:case Wi.PLAYREADY:case Wi.CLEARKEY:return["SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e,t){if(!this.encrypted||!this.uri)return null;if(Sa(this.method)){let s=this.iv;return s||(typeof e!="number"&&(Kt.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0),s=jR(e)),new Qr(this.method,this.uri,"identity",this.keyFormatVersions,s)}if(this.keyId){const s=Au[this.uri];if(s&&!Nh(this.keyId,s)&&Qr.setKeyIdForUri(this.uri,this.keyId),this.pssh)return this}const i=AI(this.uri);if(i)switch(this.keyFormat){case Wi.WIDEVINE:if(this.pssh=i,!this.keyId){const s=tR(i.buffer);if(s.length){var n;const o=s[0];this.keyId=(n=o.kids)!=null&&n.length?o.kids[0]:null}}this.keyId||(this.keyId=zy(t));break;case Wi.PLAYREADY:{const s=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=eR(s,null,i),this.keyId=pI(i);break}default:{let s=i.subarray(0,16);if(s.length!==16){const o=new Uint8Array(16);o.set(s,16-s.length),s=o}this.keyId=s;break}}if(!this.keyId||this.keyId.byteLength!==16){let s;s=WR(t),s||(s=zy(t),s||(s=Au[this.uri])),s&&(this.keyId=s,Qr.setKeyIdForUri(this.uri,s))}return this}}function WR(r){const e=r?.[Wi.WIDEVINE];return e?e.keyId:null}function zy(r){const e=r?.[Wi.PLAYREADY];if(e){const t=AI(e.uri);if(t)return pI(t)}return null}function jR(r){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=r>>8*(15-t)&255;return e}const Hy=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Vy=/#EXT-X-MEDIA:(.*)/g,qR=/^#EXT(?:INF|-X-TARGETDURATION):/m,Qd=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),XR=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class Ss{static findGroup(e,t){for(let i=0;i<e.length;i++){const n=e[i];if(n.id===t)return n}}static resolve(e,t){return NA.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return qR.test(e)}static parseMasterPlaylist(e,t){const i=Uy(e),n={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},s=[];if(Hy.lastIndex=0,!e.startsWith("#EXTM3U"))return n.playlistParsingError=new Error("no EXTM3U delimiter"),n;let o;for(;(o=Hy.exec(e))!=null;)if(o[1]){var a;const c=new li(o[1],n),u=Bm(n,o[2]),h={attrs:c,bitrate:c.decimalInteger("BANDWIDTH")||c.decimalInteger("AVERAGE-BANDWIDTH"),name:c.NAME,url:Ss.resolve(u,t)},f=c.decimalResolution("RESOLUTION");f&&(h.width=f.width,h.height=f.height),Yy(c.CODECS,h);const d=c["SUPPLEMENTAL-CODECS"];d&&(h.supplemental={},Yy(d,h.supplemental)),(a=h.unknownCodecs)!=null&&a.length||s.push(h),n.levels.push(h)}else if(o[3]){const c=o[3],u=o[4];switch(c){case"SESSION-DATA":{const h=new li(u,n),f=h["DATA-ID"];f&&(n.sessionData===null&&(n.sessionData={}),n.sessionData[f]=h);break}case"SESSION-KEY":{const h=Ky(u,t,n);h.encrypted&&h.isSupported()?(n.sessionKeys===null&&(n.sessionKeys=[]),n.sessionKeys.push(h)):Kt.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${u}"`);break}case"DEFINE":{{const h=new li(u,n);Ny(n,h,t)}break}case"CONTENT-STEERING":{const h=new li(u,n);n.contentSteering={uri:Ss.resolve(h["SERVER-URI"],t),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{n.startTimeOffset=$y(u);break}}}const l=s.length>0&&s.length<n.levels.length;return n.levels=l?s:n.levels,n.levels.length===0&&(n.playlistParsingError=new Error("no levels found in manifest")),n}static parseMasterPlaylistMedia(e,t,i){let n;const s={},o=i.levels,a={AUDIO:o.map(c=>({id:c.attrs.AUDIO,audioCodec:c.audioCodec})),SUBTITLES:o.map(c=>({id:c.attrs.SUBTITLES,textCodec:c.textCodec})),"CLOSED-CAPTIONS":[]};let l=0;for(Vy.lastIndex=0;(n=Vy.exec(e))!==null;){const c=new li(n[1],i),u=c.TYPE;if(u){const h=a[u],f=s[u]||[];s[u]=f;const d=c.LANGUAGE,m=c["ASSOC-LANGUAGE"],A=c.CHANNELS,p=c.CHARACTERISTICS,y=c["INSTREAM-ID"],v={attrs:c,bitrate:0,id:l++,groupId:c["GROUP-ID"]||"",name:c.NAME||d||"",type:u,default:c.bool("DEFAULT"),autoselect:c.bool("AUTOSELECT"),forced:c.bool("FORCED"),lang:d,url:c.URI?Ss.resolve(c.URI,t):""};if(m&&(v.assocLang=m),A&&(v.channels=A),p&&(v.characteristics=p),y&&(v.instreamId=y),h!=null&&h.length){const E=Ss.findGroup(h,v.groupId)||h[0];Wy(v,E,"audioCodec"),Wy(v,E,"textCodec")}f.push(v)}}return s}static parseLevelPlaylist(e,t,i,n,s,o){var a;const l={url:t},c=new dI(t),u=c.fragments,h=[];let f=null,d=0,m=0,A=0,p=0,y=0,v=null,E=new ah(n,l),x,I,C,_=-1,S=!1,b=null,T;if(Qd.lastIndex=0,c.m3u8=e,c.hasVariableRefs=Uy(e),((a=Qd.exec(e))==null?void 0:a[0])!=="#EXTM3U")return c.playlistParsingError=new Error("Missing format identifier #EXTM3U"),c;for(;(x=Qd.exec(e))!==null;){S&&(S=!1,E=new ah(n,l),E.playlistOffset=A,E.setStart(A),E.sn=d,E.cc=p,y&&(E.bitrate=y),E.level=i,f&&(E.initSegment=f,f.rawProgramDateTime&&(E.rawProgramDateTime=f.rawProgramDateTime,f.rawProgramDateTime=null),b&&(E.setByteRange(b),b=null)));const M=x[1];if(M){E.duration=parseFloat(M);const O=(" "+x[2]).slice(1);E.title=O||null,E.tagList.push(O?["INF",M,O]:["INF",M])}else if(x[3]){if(He(E.duration)){E.playlistOffset=A,E.setStart(A),C&&qy(E,C,c),E.sn=d,E.level=i,E.cc=p,u.push(E);const O=(" "+x[3]).slice(1);E.relurl=Bm(c,O),Dm(E,v,h),v=E,A+=E.duration,d++,m=0,S=!0}}else{if(x=x[0].match(XR),!x){Kt.warn("No matches on slow regex match for level playlist!");continue}for(I=1;I<x.length&&x[I]===void 0;I++);const O=(" "+x[I]).slice(1),U=(" "+x[I+1]).slice(1),Y=x[I+2]?(" "+x[I+2]).slice(1):null;switch(O){case"BYTERANGE":v?E.setByteRange(U,v):E.setByteRange(U);break;case"PROGRAM-DATE-TIME":E.rawProgramDateTime=U,E.tagList.push(["PROGRAM-DATE-TIME",U]),_===-1&&(_=u.length);break;case"PLAYLIST-TYPE":c.type&&sr(c,O,x),c.type=U.toUpperCase();break;case"MEDIA-SEQUENCE":c.startSN!==0?sr(c,O,x):u.length>0&&Xy(c,O,x),d=c.startSN=parseInt(U);break;case"SKIP":{c.skippedSegments&&sr(c,O,x);const W=new li(U,c),N=W.decimalInteger("SKIPPED-SEGMENTS");if(He(N)){c.skippedSegments+=N;for(let D=N;D--;)u.push(null);d+=N}const K=W.enumeratedString("RECENTLY-REMOVED-DATERANGES");K&&(c.recentlyRemovedDateranges=(c.recentlyRemovedDateranges||[]).concat(K.split("	")));break}case"TARGETDURATION":c.targetduration!==0&&sr(c,O,x),c.targetduration=Math.max(parseInt(U),1);break;case"VERSION":c.version!==null&&sr(c,O,x),c.version=parseInt(U);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":c.live||sr(c,O,x),c.live=!1;break;case"#":(U||Y)&&E.tagList.push(Y?[U,Y]:[U]);break;case"DISCONTINUITY":p++,E.tagList.push(["DIS"]);break;case"GAP":E.gap=!0,E.tagList.push([O]);break;case"BITRATE":E.tagList.push([O,U]),y=parseInt(U)*1e3,He(y)?E.bitrate=y:y=0;break;case"DATERANGE":{const W=new li(U,c),N=new $A(W,c.dateRanges[W.ID],c.dateRangeTagCount);c.dateRangeTagCount++,N.isValid||c.skippedSegments?c.dateRanges[N.id]=N:Kt.warn(`Ignoring invalid DATERANGE tag: "${U}"`),E.tagList.push(["EXT-X-DATERANGE",U]);break}case"DEFINE":{{const W=new li(U,c);"IMPORT"in W?UR(c,W,o):Ny(c,W,t)}break}case"DISCONTINUITY-SEQUENCE":c.startCC!==0?sr(c,O,x):u.length>0&&Xy(c,O,x),c.startCC=p=parseInt(U);break;case"KEY":{const W=Ky(U,t,c);if(W.isSupported()){if(W.method==="NONE"){C=void 0;break}C||(C={});const N=C[W.keyFormat];N!=null&&N.matches(W)||(N&&(C=Yt({},C)),C[W.keyFormat]=W)}else Kt.warn(`[Keys] Ignoring unsupported EXT-X-KEY tag: "${U}"`);break}case"START":c.startTimeOffset=$y(U);break;case"MAP":{const W=new li(U,c);if(E.duration){const N=new ah(n,l);jy(N,W,i,C),f=N,E.initSegment=f,f.rawProgramDateTime&&!E.rawProgramDateTime&&(E.rawProgramDateTime=f.rawProgramDateTime)}else{const N=E.byteRangeEndOffset;if(N){const K=E.byteRangeStartOffset;b=`${N-K}@${K}`}else b=null;jy(E,W,i,C),f=E,S=!0}f.cc=p;break}case"SERVER-CONTROL":{T&&sr(c,O,x),T=new li(U),c.canBlockReload=T.bool("CAN-BLOCK-RELOAD"),c.canSkipUntil=T.optionalFloat("CAN-SKIP-UNTIL",0),c.canSkipDateRanges=c.canSkipUntil>0&&T.bool("CAN-SKIP-DATERANGES"),c.partHoldBack=T.optionalFloat("PART-HOLD-BACK",0),c.holdBack=T.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{c.partTarget&&sr(c,O,x);const W=new li(U);c.partTarget=W.decimalFloatingPoint("PART-TARGET");break}case"PART":{let W=c.partList;W||(W=c.partList=[]);const N=m>0?W[W.length-1]:void 0,K=m++,D=new li(U,c),z=new Vx(D,E,l,K,N);W.push(z),E.duration+=z.duration;break}case"PRELOAD-HINT":{const W=new li(U,c);c.preloadHint=W;break}case"RENDITION-REPORT":{const W=new li(U,c);c.renditionReports=c.renditionReports||[],c.renditionReports.push(W);break}default:Kt.warn(`line parsed but not handled: ${x}`);break}}}v&&!v.relurl?(u.pop(),A-=v.duration,c.partList&&(c.fragmentHint=v)):c.partList&&(Dm(E,v,h),E.cc=p,c.fragmentHint=E,C&&qy(E,C,c)),c.targetduration||(c.playlistParsingError=new Error("Missing Target Duration"));const R=u.length,w=u[0],B=u[R-1];if(A+=c.skippedSegments*c.targetduration,A>0&&R&&B){c.averagetargetduration=A/R;const M=B.sn;c.endSN=M!=="initSegment"?M:0,c.live||(B.endList=!0),_>0&&(ZR(u,_),w&&h.unshift(w))}return c.fragmentHint&&(A+=c.fragmentHint.duration),c.totalduration=A,h.length&&c.dateRangeTagCount&&w&&gI(h,c),c.endCC=p,c}}function gI(r,e){let t=r.length;if(!t)if(e.hasProgramDateTime){const a=e.fragments[e.fragments.length-1];r.push(a),t++}else return;const i=r[t-1],n=e.live?1/0:e.totalduration,s=Object.keys(e.dateRanges);for(let a=s.length;a--;){const l=e.dateRanges[s[a]],c=l.startDate.getTime();l.tagAnchor=i.ref;for(let u=t;u--;){var o;if(((o=r[u])==null?void 0:o.sn)<e.startSN)break;const h=JR(e,c,r,u,n);if(h!==-1){l.tagAnchor=e.fragments[h].ref;break}}}}function JR(r,e,t,i,n){const s=t[i];if(s){const a=s.programDateTime;if(e>=a||i===0){var o;const l=(((o=t[i+1])==null?void 0:o.start)||n)-s.start;if(e<=a+l*1e3){const c=t[i].sn-r.startSN;if(c<0)return-1;const u=r.fragments;if(u.length>t.length){const f=(t[i+1]||u[u.length-1]).sn-r.startSN;for(let d=f;d>c;d--){const m=u[d].programDateTime;if(e>=m&&e<m+u[d].duration*1e3)return d}}return c}}}return-1}function Ky(r,e,t){var i,n;const s=new li(r,t),o=(i=s.METHOD)!=null?i:"",a=s.URI,l=s.hexadecimalInteger("IV"),c=s.KEYFORMATVERSIONS,u=(n=s.KEYFORMAT)!=null?n:"identity";a&&s.IV&&!l&&Kt.error(`Invalid IV: ${s.IV}`);const h=a?Ss.resolve(a,e):"",f=(c||"1").split("/").map(Number).filter(Number.isFinite);return new Qr(o,h,u,f,l,s.KEYID)}function $y(r){const t=new li(r).decimalFloatingPoint("TIME-OFFSET");return He(t)?t:null}function Yy(r,e){let t=(r||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const n=t.filter(s=>zA(s,i));n.length&&(e[`${i}Codec`]=n.map(s=>s.split("/")[0]).join(","),t=t.filter(s=>n.indexOf(s)===-1))}),e.unknownCodecs=t}function Wy(r,e,t){const i=e[t];i&&(r[t]=i)}function ZR(r,e){let t=r[e];for(let i=e;i--;){const n=r[i];if(!n)return;n.programDateTime=t.programDateTime-n.duration*1e3,t=n}}function Dm(r,e,t){r.rawProgramDateTime?t.push(r):e!=null&&e.programDateTime&&(r.programDateTime=e.endProgramDateTime)}function jy(r,e,t,i){r.relurl=e.URI,e.BYTERANGE&&r.setByteRange(e.BYTERANGE),r.level=t,r.sn="initSegment",i&&(r.levelkeys=i),r.initSegment=null}function qy(r,e,t){r.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(n=>e[n].isCommonEncryption)&&i.push(r)}function sr(r,e,t){r.playlistParsingError=new Error(`#EXT-X-${e} must not appear more than once (${t[0]})`)}function Xy(r,e,t){r.playlistParsingError=new Error(`#EXT-X-${e} must appear before the first Media Segment (${t[0]})`)}function zd(r,e){const t=e.startPTS;if(He(t)){let i=0,n;e.sn>r.sn?(i=t-r.start,n=r):(i=r.start-t,n=e),n.duration!==i&&n.setDuration(i)}else e.sn>r.sn?r.cc===e.cc&&r.minEndPTS?e.setStart(r.start+(r.minEndPTS-r.start)):e.setStart(r.start+r.duration):e.setStart(Math.max(r.start-e.duration,0))}function yI(r,e,t,i,n,s,o){i-t<=0&&(o.warn("Fragment should have a positive duration",e),i=t+e.duration,s=n+e.duration);let l=t,c=i;const u=e.startPTS,h=e.endPTS;if(He(u)){const y=Math.abs(u-t);r&&y>r.totalduration?o.warn(`media timestamps and playlist times differ by ${y}s for level ${e.level} ${r.url}`):He(e.deltaPTS)?e.deltaPTS=Math.max(y,e.deltaPTS):e.deltaPTS=y,l=Math.max(t,u),t=Math.min(t,u),n=e.startDTS!==void 0?Math.min(n,e.startDTS):n,c=Math.min(i,h),i=Math.max(i,h),s=e.endDTS!==void 0?Math.max(s,e.endDTS):s}const f=t-e.start;e.start!==0&&e.setStart(t),e.setDuration(i-e.start),e.startPTS=t,e.maxStartPTS=l,e.startDTS=n,e.endPTS=i,e.minEndPTS=c,e.endDTS=s;const d=e.sn;if(!r||d<r.startSN||d>r.endSN)return 0;let m;const A=d-r.startSN,p=r.fragments;for(p[A]=e,m=A;m>0;m--)zd(p[m],p[m-1]);for(m=A;m<p.length-1;m++)zd(p[m],p[m+1]);return r.fragmentHint&&zd(p[p.length-1],r.fragmentHint),r.PTSKnown=r.alignedSliding=!0,f}function e7(r,e,t){if(r===e)return;let i=null;const n=r.fragments;for(let u=n.length-1;u>=0;u--){const h=n[u].initSegment;if(h){i=h;break}}r.fragmentHint&&delete r.fragmentHint.endPTS;let s;n7(r,e,(u,h,f,d)=>{if((!e.startCC||e.skippedSegments)&&h.cc!==u.cc){const m=u.cc-h.cc;for(let A=f;A<d.length;A++)d[A].cc+=m;e.endCC=d[d.length-1].cc}He(u.startPTS)&&He(u.endPTS)&&(h.setStart(h.startPTS=u.startPTS),h.startDTS=u.startDTS,h.maxStartPTS=u.maxStartPTS,h.endPTS=u.endPTS,h.endDTS=u.endDTS,h.minEndPTS=u.minEndPTS,h.setDuration(u.endPTS-u.startPTS),h.duration&&(s=h),e.PTSKnown=e.alignedSliding=!0),u.hasStreams&&(h.elementaryStreams=u.elementaryStreams),h.loader=u.loader,u.hasStats&&(h.stats=u.stats),u.initSegment&&(h.initSegment=u.initSegment,i=u.initSegment)});const o=e.fragments,a=e.fragmentHint?o.concat(e.fragmentHint):o;if(i&&a.forEach(u=>{var h;u&&(!u.initSegment||u.initSegment.relurl===((h=i)==null?void 0:h.relurl))&&(u.initSegment=i)}),e.skippedSegments){if(e.deltaUpdateFailed=o.some(u=>!u),e.deltaUpdateFailed){t.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let u=e.skippedSegments;u--;)o.shift();e.startSN=o[0].sn}else{e.canSkipDateRanges&&(e.dateRanges=t7(r.dateRanges,e,t));const u=r.fragments.filter(h=>h.rawProgramDateTime);if(r.hasProgramDateTime&&!e.hasProgramDateTime)for(let h=1;h<a.length;h++)a[h].programDateTime===null&&Dm(a[h],a[h-1],u);gI(u,e)}e.endCC=o[o.length-1].cc}if(!e.startCC){var l;const u=xI(r,e.startSN-1);e.startCC=(l=u?.cc)!=null?l:o[0].cc}i7(r.partList,e.partList,(u,h)=>{h.elementaryStreams=u.elementaryStreams,h.stats=u.stats}),s?yI(e,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS,t):vI(r,e),o.length&&(e.totalduration=e.edge-o[0].start),e.driftStartTime=r.driftStartTime,e.driftStart=r.driftStart;const c=e.advancedDateTime;if(e.advanced&&c){const u=e.edge;e.driftStart||(e.driftStartTime=c,e.driftStart=u),e.driftEndTime=c,e.driftEnd=u}else e.driftEndTime=r.driftEndTime,e.driftEnd=r.driftEnd,e.advancedDateTime=r.advancedDateTime;e.requestScheduled===-1&&(e.requestScheduled=r.requestScheduled)}function t7(r,e,t){const{dateRanges:i,recentlyRemovedDateranges:n}=e,s=Yt({},r);n&&n.forEach(l=>{delete s[l]});const a=Object.keys(s).length;return a?(Object.keys(i).forEach(l=>{const c=s[l],u=new $A(i[l].attr,c);u.isValid?(s[l]=u,c||(u.tagOrder+=a)):t.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${Xt(i[l].attr)}"`)}),s):i}function i7(r,e,t){if(r&&e){let i=0;for(let n=0,s=r.length;n<=s;n++){const o=r[n],a=e[n+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function n7(r,e,t){const i=e.skippedSegments,n=Math.max(r.startSN,e.startSN)-e.startSN,s=(r.fragmentHint?1:0)+(i?e.endSN:Math.min(r.endSN,e.endSN))-e.startSN,o=e.startSN-r.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,l=r.fragmentHint?r.fragments.concat(r.fragmentHint):r.fragments;for(let c=n;c<=s;c++){const u=l[o+c];let h=a[c];if(i&&!h&&u&&(h=e.fragments[c]=u),u&&h){t(u,h,c,a);const f=u.relurl,d=h.relurl;if(f&&s7(f,d)){e.playlistParsingError=Jy(`media sequence mismatch ${h.sn}:`,r,e,u,h);return}else if(u.cc!==h.cc){e.playlistParsingError=Jy(`discontinuity sequence mismatch (${u.cc}!=${h.cc})`,r,e,u,h);return}}}}function Jy(r,e,t,i,n){return new Error(`${r} ${n.url}
Playlist starting @${e.startSN}
${e.m3u8}

Playlist starting @${t.startSN}
${t.m3u8}`)}function vI(r,e,t=!0){const i=e.startSN+e.skippedSegments-r.startSN,n=r.fragments,s=i>=0;let o=0;if(s&&i<n.length)o=n[i].start;else if(s&&e.startSN===r.endSN+1)o=r.fragmentEnd;else if(s&&t)o=r.fragmentStart+i*e.levelTargetDuration;else if(!e.skippedSegments&&e.fragmentStart===0)o=r.fragmentStart;else return;Mm(e,o)}function Mm(r,e){if(e){const t=r.fragments;for(let i=r.skippedSegments;i<t.length;i++)t[i].addStart(e);r.fragmentHint&&r.fragmentHint.addStart(e)}}function EI(r,e=1/0){let t=1e3*r.targetduration;if(r.updated){const i=r.fragments;if(i.length&&t*4>e){const s=i[i.length-1].duration*1e3;s<t&&(t=s)}}else t/=2;return Math.round(t)}function xI(r,e,t){if(!r)return null;let i=r.fragments[e-r.startSN];return i||(i=r.fragmentHint,i&&i.sn===e)?i:e<r.startSN&&t&&t.sn===e?t:null}function Zy(r,e,t){return r?II(r.partList,e,t):null}function II(r,e,t){if(r)for(let i=r.length;i--;){const n=r[i];if(n.index===t&&n.fragment.sn===e)return n}return null}function CI(r){r.forEach((e,t)=>{var i;(i=e.details)==null||i.fragments.forEach(n=>{n.level=t,n.initSegment&&(n.initSegment.level=t)})})}function s7(r,e){return r!==e&&e?e2(r)!==e2(e):!1}function e2(r){return r.replace(/\?[^?]*$/,"")}function tc(r,e){for(let i=0,n=r.length;i<n;i++){var t;if(((t=r[i])==null?void 0:t.cc)===e)return r[i]}return null}function r7(r,e){return!!(r&&e.startCC<r.endCC&&e.endCC>r.startCC)}function t2(r,e){const t=r.start+e;r.startPTS=t,r.setStart(t),r.endPTS=t+r.duration}function _I(r,e){const t=e.fragments;for(let i=0,n=t.length;i<n;i++)t2(t[i],r);e.fragmentHint&&t2(e.fragmentHint,r),e.alignedSliding=!0}function o7(r,e){r&&(SI(e,r),e.alignedSliding||Qh(e,r),!e.alignedSliding&&!e.skippedSegments&&vI(r,e,!1))}function SI(r,e){if(!r7(e,r))return;const t=Math.min(e.endCC,r.endCC),i=tc(e.fragments,t),n=tc(r.fragments,t);if(!i||!n)return;Kt.log(`Aligning playlist at start of dicontinuity sequence ${t}`);const s=i.start-n.start;_I(s,r)}function Qh(r,e){if(!r.hasProgramDateTime||!e.hasProgramDateTime)return;const t=r.fragments,i=e.fragments;if(!t.length||!i.length)return;let n,s;const o=Math.min(e.endCC,r.endCC);e.startCC<o&&r.startCC<o&&(n=tc(i,o),s=tc(t,o)),(!n||!s)&&(n=i[Math.floor(i.length/2)],s=tc(t,n.cc)||t[Math.floor(t.length/2)]);const a=n.programDateTime,l=s.programDateTime;if(!a||!l)return;const c=(l-a)/1e3-(s.start-n.start);_I(c,r)}function un(r,e,t){Cn(r,e,t),r.addEventListener(e,t)}function Cn(r,e,t){r.removeEventListener(e,t)}const a7={toString:function(r){let e="";const t=r.length;for(let i=0;i<t;i++)e+=`[${r.start(i).toFixed(3)}-${r.end(i).toFixed(3)}]`;return e}},Te={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class gf extends hI{constructor(e,t,i,n,s){super(n,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=Te.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:o,fragCurrent:a,media:l,mediaBuffer:c,state:u}=this,h=l?l.currentTime:0,f=dt.bufferInfo(c||l,h,o.maxBufferHole),d=!f.len;if(this.log(`Media seeking to ${He(h)?h.toFixed(3):h}, state: ${u}, ${d?"out of":"in"} buffer`),this.state===Te.ENDED)this.resetLoadingState();else if(a){const m=o.maxFragLookUpTolerance,A=a.start-m,p=a.start+a.duration+m;if(d||p<f.start||A>f.end){const y=h>p;(h<A||y)&&(y&&a.loader&&(this.log(`Cancelling fragment load for seek (sn: ${a.sn})`),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(l){this.fragmentTracker.removeFragmentsInRange(h,1/0,this.playlistType,!0);const m=this.lastCurrentTime;if(h>m&&(this.lastCurrentTime=h),!this.loadingParts){const A=Math.max(f.end,h),p=this.shouldLoadParts(this.getLevelDetails(),A);p&&(this.log(`LL-Part loading ON after seeking to ${h.toFixed(2)} with buffer @${A.toFixed(2)}`),this.loadingParts=p)}}this.hls.hasEnoughToStart||(this.log(`Setting ${d?"startPosition":"nextLoadPosition"} to ${h} for seek without enough to start`),this.nextLoadPosition=h,d&&(this.startPosition=h)),d&&this.state===Te.IDLE&&this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=s,this.hls=e,this.fragmentLoader=new kR(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new KA(e.config)}registerListeners(){const{hls:e}=this;e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===Te.STOPPED)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=Te.STOPPED}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return t===-1&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const i=e.end||0,n=this.config.timelineOffset||0;if(i<=n)return!1;const s=e.buffered;this.config.maxBufferHole&&s&&s.length>1&&(e=dt.bufferedInfo(s,e.start,0));const o=e.nextStart;if(o&&o>n&&o<t.edge||this.media.currentTime<e.start)return!1;const l=t.partList;if(l!=null&&l.length){const u=l[l.length-1];return dt.isBuffered(this.media,u.start+u.duration/2)}const c=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(c)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null)return this.levelLastLoaded.details}get timelineOffset(){const e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;un(i,"seeking",this.onMediaSeeking),un(i,"ended",this.onMediaEnded);const n=this.config;this.levels&&n.autoStartLoad&&this.state===Te.STOPPED&&this.startLoad(n.startPosition)}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(n!==null){if(n.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),Cn(n,"seeking",this.onMediaSeeking),Cn(n,"ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=Te.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const n=s=>{const o=s.frag;if(this.fragContextChanged(o)){this.warn(`${o.type} sn: ${o.sn}${s.part?" part: "+s.part.index:""} of ${this.fragInfo(o,!1,s.part)}) was dropped during download.`),this.fragmentTracker.removeFragment(o);return}o.stats.chunkCount++,this._handleFragmentLoadProgress(s)};this._doFragLoad(e,t,i,n).then(s=>{if(!s)return;const o=this.state,a=s.frag;if(this.fragContextChanged(a)){(o===Te.FRAG_LOADING||!this.fragCurrent&&o===Te.PARSING)&&(this.fragmentTracker.removeFragment(a),this.state=Te.IDLE);return}"payload"in s&&(this.log(`Loaded ${a.type} sn: ${a.sn} of ${this.playlistLabel()} ${a.level}`),this.hls.trigger(L.FRAG_LOADED,s)),this._handleFragmentLoadComplete(s)}).catch(s=>{this.state===Te.STOPPED||this.state===Te.ERROR||(this.warn(`Frag error: ${s?.message||s}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===Ni.APPENDING){const s=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,s),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),l=this.backtrackFragment;((l?e.sn-l.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===Ni.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return t?.live&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const n={startOffset:e,endOffset:t,type:i};this.hls.trigger(L.BUFFER_FLUSHING,n)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{const n=i?.frag;if(!n||this.fragContextChanged(n)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:n}=this,{frag:s,payload:o}=i,a=s.decryptdata;if(o&&o.byteLength>0&&a!=null&&a.key&&a.iv&&Sa(a.method)){const l=self.performance.now();return this.decrypter.decrypt(new Uint8Array(o),a.key.buffer,a.iv.buffer,YA(a.method)).catch(c=>{throw n.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.FRAG_DECRYPT_ERROR,fatal:!1,error:c,reason:c.message,frag:s}),c}).then(c=>{const u=self.performance.now();return n.trigger(L.FRAG_DECRYPTED,{frag:s,payload:c,stats:{tstart:l,tdecrypt:u}}),i.payload=c,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===Te.STOPPED||this.state===Te.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state!==Te.STOPPED&&(this.state=Te.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}unhandledEncryptionError(e,t){var i,n;const s=e.tracks;if(s&&!t.encrypted&&((i=s.audio)!=null&&i.encrypted||(n=s.video)!=null&&n.encrypted)&&(!this.config.emeEnabled||!this.keyLoader.emeController)){const o=this.media,a=new Error(`Encrypted track with no key in ${this.fragInfo(t)} (media ${o?"attached mediaKeys: "+o.mediaKeys:"detached"})`);return this.warn(a.message),!o||o.mediaKeys?!1:(this.hls.trigger(L.ERROR,{type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_KEYS,fatal:!1,error:a,frag:t}),this.resetTransmuxer(),!0)}return!1}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${i?a7.toString(dt.getBuffered(i)):"(detached)"})`),Ri(e)){var n;if(e.type!==$e.SUBTITLE){const o=e.elementaryStreams;if(!Object.keys(o).some(a=>!!o[a])){this.state=Te.IDLE;return}}const s=(n=this.levels)==null?void 0:n[e.level];s!=null&&s.fragmentError&&(this.log(`Resetting level fragment error count of ${s.fragmentError} on frag buffered`),s.fragmentError=0)}this.state=Te.IDLE}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:n,partsLoaded:s}=e,o=!s||s.length===0||s.some(l=>!l),a=new pf(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,n){var s;this.fragCurrent=e;const o=t.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;if(e.encrypted&&!((s=e.decryptdata)!=null&&s.key)){if(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=Te.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(f=>{if(!this.fragContextChanged(f.frag))return this.hls.trigger(L.KEY_LOADED,f),this.state===Te.KEY_LOADING&&(this.state=Te.IDLE),f}),this.hls.trigger(L.KEY_LOADING,{frag:e}),this.fragCurrent===null)return this.log("context changed in KEY_LOADING"),Promise.resolve(null)}else e.encrypted||(a=this.keyLoader.loadClear(e,o.encryptedFragments,this.startFragRequested),a&&this.log("[eme] blocking frag load until media-keys acquired"));const l=this.fragPrevious;if(Ri(e)&&(!l||e.sn!==l.sn)){const f=this.shouldLoadParts(t.details,e.end);f!==this.loadingParts&&(this.log(`LL-Part loading ${f?"ON":"OFF"} loading sn ${l?.sn}->${e.sn}`),this.loadingParts=f)}if(i=Math.max(e.start,i||0),this.loadingParts&&Ri(e)){const f=o.partList;if(f&&n){i>o.fragmentEnd&&o.fragmentHint&&(e=o.fragmentHint);const d=this.getNextPart(f,e,i);if(d>-1){const m=f[d];e=this.fragCurrent=m.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${m.index} (${d}/${f.length-1}) of ${this.fragInfo(e,!1,m)}) cc: ${e.cc} [${o.startSN}-${o.endSN}], target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=m.start+m.duration,this.state=Te.FRAG_LOADING;let A;return a?A=a.then(p=>!p||this.fragContextChanged(p.frag)?null:this.doFragPartsLoad(e,m,t,n)).catch(p=>this.handleFragLoadError(p)):A=this.doFragPartsLoad(e,m,t,n).catch(p=>this.handleFragLoadError(p)),this.hls.trigger(L.FRAG_LOADING,{frag:e,part:m,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):A}else if(!e.url||this.loadedEndOfParts(f,i))return Promise.resolve(null)}}if(Ri(e)&&this.loadingParts){var c;this.log(`LL-Part loading OFF after next part miss @${i.toFixed(2)} Check buffer at sn: ${e.sn} loaded parts: ${(c=o.partList)==null?void 0:c.filter(f=>f.loaded).map(f=>`[${f.start}-${f.end}]`)}`),this.loadingParts=!1}else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${"["+o.startSN+"-"+o.endSN+"]"}, target: ${parseFloat(i.toFixed(3))}`),He(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=Te.FRAG_LOADING;const u=this.config.progressive;let h;return u&&a?h=a.then(f=>!f||this.fragContextChanged(f.frag)?null:this.fragmentLoader.load(e,n)).catch(f=>this.handleFragLoadError(f)):h=Promise.all([this.fragmentLoader.load(e,u?n:void 0),a]).then(([f])=>(!u&&n&&n(f),f)).catch(f=>this.handleFragLoadError(f)),this.hls.trigger(L.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):h}doFragPartsLoad(e,t,i,n){return new Promise((s,o)=>{var a;const l=[],c=(a=i.details)==null?void 0:a.partList,u=h=>{this.fragmentLoader.loadPart(e,h,n).then(f=>{l[h.index]=f;const d=f.part;this.hls.trigger(L.FRAG_LOADED,f);const m=Zy(i.details,e.sn,h.index+1)||II(c,e.sn,h.index+1);if(m)u(m);else return s({frag:e,part:d,partsLoaded:l})}).catch(o)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;t.frag&&t.details===ue.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):t.frag&&t.type===Je.KEY_SYSTEM_ERROR?(t.frag.abortRequests(),this.resetStartWhenNotLoaded(),this.resetFragmentLoading(t.frag)):this.hls.trigger(L.ERROR,t)}else this.hls.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==Te.PARSING){!this.fragCurrent&&this.state!==Te.STOPPED&&this.state!==Te.ERROR&&(this.state=Te.IDLE);return}const{frag:i,part:n,level:s}=t,o=self.performance.now();i.stats.parsing.end=o,n&&(n.stats.parsing.end=o);const a=this.getLevelDetails(),c=a&&i.sn>a.endSN||this.shouldLoadParts(a,i.end);c!==this.loadingParts&&(this.log(`LL-Part loading ${c?"ON":"OFF"} after parsing segment ending @${i.end.toFixed(2)}`),this.loadingParts=c),this.updateLevelTiming(i,n,s,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e.partList){var i;const s=e.partList[0];if(s.fragment.type===$e.SUBTITLE)return!1;const o=s.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=o){var n;if((this.hls.hasEnoughToStart?((n=this.media)==null?void 0:n.currentTime)||this.lastCurrentTime:this.getLoadPosition())>s.start-s.fragment.duration)return!0}}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:n,sn:s,part:o}=e;if(!(t!=null&&t[n]))return this.warn(`Levels object was unset while buffering fragment ${s} of ${this.playlistLabel()} ${n}. The current chunk will not be buffered.`),null;const a=t[n],l=a.details,c=o>-1?Zy(l,s,o):null,u=c?c.fragment:xI(l,s,i);return u?(i&&i!==u&&(u.stats=i.stats),{frag:u,part:c,level:a}):null}bufferFragmentData(e,t,i,n,s){if(this.state!==Te.PARSING)return;const{data1:o,data2:a}=e;let l=o;if(a&&(l=rs(o,a)),!l.length)return;const c=this.initPTS[t.cc],u=c?-c.baseTime/c.timescale:void 0,h={type:e.type,frag:t,part:i,chunkMeta:n,offset:u,parent:t.type,data:l};if(this.hls.trigger(L.BUFFER_APPENDING,h),e.dropped&&e.independent&&!i){if(s)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!dt.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,n=dt.bufferInfo(t,i,0),s=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,s*.25),a=Math.max(Math.min(e.start-o,n.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var i;const n=this.getLoadPosition();if(!He(n))return null;const o=this.lastCurrentTime>n||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,n,t,o)}getFwdBufferInfoAtPos(e,t,i,n){const s=dt.bufferInfo(e,t,n);if(s.len===0&&s.nextStart!==void 0){const o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&(s.nextStart<=o.end||o.gap)){const a=Math.max(Math.min(s.nextStart,o.end)-t,n);return dt.bufferInfo(e,t,a)}}return s}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,n=Math.max(Math.min(e-t,i.maxBufferLength),t),s=Math.max(e-t*3,i.maxMaxBufferLength/2,n);return s>=n?(i.maxMaxBufferLength=s,this.warn(`Reduce max buffer length to ${s}s`),!0):!1}getAppendedFrag(e,t=$e.MAIN){const i=this.fragmentTracker?this.fragmentTracker.getAppendedFrag(e,t):null;return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,n=i.length;if(!n)return null;const{config:s}=this,o=i[0].start,a=s.lowLatencyMode&&!!t.partList;let l=null;if(t.live){const h=s.initialLiveManifestSize;if(n<h)return this.warn(`Not enough fragments to start playback (have: ${n}, need: ${h})`),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o){var c;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),l=this.getInitialLiveFragment(t);const f=this.hls.startPosition,d=this.hls.liveSyncPosition,m=l?(f!==-1&&f>=o?f:d)||l.start:e;this.log(`Setting startPosition to ${m} to match start frag at live edge. mainStart: ${f} liveSyncPosition: ${d} frag.start: ${(c=l)==null?void 0:c.start}`),this.startPosition=this.nextLoadPosition=m}}else e<=o&&(l=i[0]);if(!l){const h=this.loadingParts?t.partEnd:t.fragmentEnd;l=this.getFragmentAtPosition(e,h,t)}let u=this.filterReplacedPrimary(l,t);if(!u&&l){const h=l.sn-t.startSN;u=this.filterReplacedPrimary(i[h+1]||null,t)}return this.mapToInitFragWhenRequired(u)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===Ni.OK||i===Ni.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,n,s){let o=null;if(e.gap&&(o=this.getNextFragment(this.nextLoadPosition,t),o&&!o.gap&&i.nextStart)){const a=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,n,0);if(a!==null&&i.len+a.len>=s){const l=o.sn;return this.loopSn!==l&&(this.log(`buffer full after gaps in "${n}" playlist starting at sn: ${l}`),this.loopSn=l),null}}return this.loopSn=void 0,o}get primaryPrefetch(){if(i2(this.config)){var e;if((e=this.hls.interstitialsManager)==null||(e=e.playingItem)==null?void 0:e.event)return!0}return!1}filterReplacedPrimary(e,t){if(!e)return e;if(i2(this.config)&&e.type!==$e.SUBTITLE){const i=this.hls.interstitialsManager,n=i?.bufferingItem;if(n){const o=n.event;if(o){if(o.appendInPlace||Math.abs(e.start-n.start)>1||n.start===0)return null}else if(e.end<=n.start&&t?.live===!1||e.start>n.end&&n.nextEvent&&(n.nextEvent.appendInPlace||e.start-n.end>1))return null}const s=i?.playerQueue;if(s)for(let o=s.length;o--;){const a=s[o].interstitial;if(a.appendInPlace&&e.start>=a.startTime&&e.end<=a.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!e.initSegment.data&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let n=-1,s=!1,o=!0;for(let a=0,l=e.length;a<l;a++){const c=e[a];if(o=o&&!c.independent,n>-1&&i<c.start)break;const u=c.loaded;u?n=-1:(s||(c.independent||o)&&c.fragment===t)&&(c.fragment!==t&&this.warn(`Need buffer at ${i} but next unloaded part starts at ${c.start}`),n=a),s=u}return n}loadedEndOfParts(e,t){let i;for(let n=e.length;n--;){if(i=e[n],!i.loaded)return!1;if(t>i.start)return!0}return!1}getInitialLiveFragment(e){const t=e.fragments,i=this.fragPrevious;let n=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),n=SR(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const s=i.sn+1;if(s>=e.startSN&&s<=e.endSN){const o=t[s-e.startSN];i.cc===o.cc&&(n=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=aI(e,i.cc,i.end),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const s=this.hls.liveSyncPosition;s!==null&&(n=this.getFragmentAtPosition(s,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,i){const{config:n}=this;let{fragPrevious:s}=this,{fragments:o,endSN:a}=i;const{fragmentHint:l}=i,{maxFragLookUpTolerance:c}=n,u=i.partList,h=!!(this.loadingParts&&u!=null&&u.length&&l);h&&!this.bitrateTest&&u[u.length-1].fragment.sn===l.sn&&(o=o.concat(l),a=l.sn);let f;if(e<t){var d;const A=e<this.lastCurrentTime||e>t-c||(d=this.media)!=null&&d.paused||!this.startFragRequested?0:c;f=yo(s,o,e,A)}else f=o[o.length-1];if(f){const m=f.sn-i.startSN,A=this.fragmentTracker.getState(f);if((A===Ni.OK||A===Ni.PARTIAL&&f.gap)&&(s=f),s&&f.sn===s.sn&&(!h||u[0].fragment.sn>f.sn||!i.live)&&f.level===s.level){const y=o[m+1];f.sn<a&&this.fragmentTracker.getState(y)!==Ni.OK?f=y:f=null}}return f}alignPlaylists(e,t,i){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const s=e.fragmentStart,o=!t,a=e.alignedSliding&&He(s);if(o||!a&&!s){o7(i,e);const l=e.fragmentStart;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${n}`),l}return s}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;i<t&&(i=-1);const n=this.timelineOffset;if(i===-1){const s=this.startTimeOffset!==null,o=s?this.startTimeOffset:e.startTimeOffset;o!==null&&He(o)?(i=t+o,o<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Setting startPosition to ${i} for start time offset ${o} found in ${s?"multivariant":"media"} playlist`),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${i}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+n}this.nextLoadPosition=i+n}getLoadPosition(){var e;const{media:t}=this;let i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&Ri(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==Te.FRAG_LOADING_WAITING_RETRY)&&(this.state=Te.IDLE)}onFragmentOrKeyLoadError(e,t){var i;if(t.chunkMeta&&!t.frag){const y=this.getCurrentContext(t.chunkMeta);y&&(t.frag=y.frag)}const n=t.frag;if(!n||n.type!==e||!this.levels)return;if(this.fragContextChanged(n)){var s;this.warn(`Frag load error must match current frag to retry ${n.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const o=t.details===ue.FRAG_GAP;o&&this.fragmentTracker.fragBuffered(n,!0);const a=t.errorAction;if(!a){this.state=Te.ERROR;return}const{action:l,flags:c,retryCount:u=0,retryConfig:h}=a,f=!!h,d=f&&l===Ui.RetryRequest,m=f&&!a.resolved&&c===En.MoveAllAlternatesMatchingHost,A=(i=this.hls.latestLevelDetails)==null?void 0:i.live;if(!d&&m&&Ri(n)&&!n.endList&&A&&!cI(t))this.resetFragmentErrors(e),this.treatAsGap(n),a.resolved=!0;else if((d||m)&&u<h.maxNumRetry){var p;const y=wm((p=t.response)==null?void 0:p.code),v=VA(h,u);if(this.resetStartWhenNotLoaded(),this.retryDate=self.performance.now()+v,this.state=Te.FRAG_LOADING_WAITING_RETRY,a.resolved=!0,y){this.log("Waiting for connection (offline)"),this.retryDate=1/0,t.reason="offline";return}this.warn(`Fragment ${n.sn} of ${e} ${n.level} errored with ${t.details}, retrying loading ${u+1}/${h.maxNumRetry} in ${v}ms`)}else if(h)if(this.resetFragmentErrors(e),u<h.maxNumRetry)!o&&l!==Ui.RemoveAlternatePermanently&&(a.resolved=!0);else{this.warn(`${t.details} reached or exceeded max retry (${u})`);return}else l===Ui.SendAlternateToPenaltyBox?this.state=Te.WAITING_LEVEL:this.state=Te.ERROR;this.tickImmediate()}checkRetryDate(){const e=self.performance.now(),t=this.retryDate,i=t===1/0;(!t||e>=t||i&&!wm(0))&&(i&&this.log("Connection restored (online)"),this.resetStartWhenNotLoaded(),this.state=Te.IDLE)}reduceLengthAndFlushBuffer(e){if(this.state===Te.PARSING||this.state===Te.PARSED){const t=e.frag,i=e.parent,n=this.getFwdBufferInfo(this.mediaBuffer,i),s=n&&n.len>.5;s&&this.reduceMaxBufferLength(n.len,t?.duration||10);const o=!s;return o&&this.warn(`Buffer full error while media.currentTime (${this.getLoadPosition()}) is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===$e.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==Te.STOPPED&&(this.state=Te.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const n=dt.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,i),this.state===Te.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==Te.STOPPED&&(this.state=Te.IDLE)}resetStartWhenNotLoaded(){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const e=this.levelLastLoaded,t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.log(`Loading context changed while buffering sn ${e.sn} of ${this.playlistLabel()} ${e.level===-1?"<removed>":e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,n){const s=i.details;if(!s){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((l,c)=>{const u=e.elementaryStreams[c];if(u){const h=u.endPTS-u.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${e.sn} ${c} duration reliably (${h})`),l||!1;const f=n?0:yI(s,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS,this);return this.hls.trigger(L.LEVEL_PTS_UPDATED,{details:s,level:i,drift:f,type:c,frag:e,start:u.startPTS,end:u.endPTS}),!0}return l},!1)){var a;if(i.fragmentError===0&&this.treatAsGap(e,i),((a=this.transmuxer)==null?void 0:a.error)===null){const l=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(l.message),this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}}this.state=Te.PARSED,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(L.FRAG_PARSED,{frag:e,part:t})}playlistLabel(){return this.playlistType===$e.MAIN?"level":"track"}fragInfo(e,t=!0,i){var n,s;return`${this.playlistLabel()} ${e.level} (${i?"part":"frag"}:[${((n=t&&!i?e.startPTS:(i||e).start)!=null?n:NaN).toFixed(3)}-${((s=t&&!i?e.endPTS:(i||e).end)!=null?s:NaN).toFixed(3)}]${i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;(e=this.transmuxer)==null||e.reset()}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function i2(r){return!!r.interstitialsController&&r.enableInterstitialPlayback!==!1}class TI{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=l7(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function l7(r,e){const t=new Uint8Array(e);let i=0;for(let n=0;n<r.length;n++){const s=r[n];t.set(s,i),i+=s.length}return t}var Hd={exports:{}},n2;function c7(){return n2||(n2=1,(function(r){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function n(l,c,u){this.fn=l,this.context=c,this.once=u||!1}function s(l,c,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var d=new n(u,h||l,f),m=t?t+c:c;return l._events[m]?l._events[m].fn?l._events[m]=[l._events[m],d]:l._events[m].push(d):(l._events[m]=d,l._eventsCount++),l}function o(l,c){--l._eventsCount===0?l._events=new i:delete l._events[c]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var c=[],u,h;if(this._eventsCount===0)return c;for(h in u=this._events)e.call(u,h)&&c.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(u)):c},a.prototype.listeners=function(c){var u=t?t+c:c,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,d=h.length,m=new Array(d);f<d;f++)m[f]=h[f].fn;return m},a.prototype.listenerCount=function(c){var u=t?t+c:c,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(c,u,h,f,d,m){var A=t?t+c:c;if(!this._events[A])return!1;var p=this._events[A],y=arguments.length,v,E;if(p.fn){switch(p.once&&this.removeListener(c,p.fn,void 0,!0),y){case 1:return p.fn.call(p.context),!0;case 2:return p.fn.call(p.context,u),!0;case 3:return p.fn.call(p.context,u,h),!0;case 4:return p.fn.call(p.context,u,h,f),!0;case 5:return p.fn.call(p.context,u,h,f,d),!0;case 6:return p.fn.call(p.context,u,h,f,d,m),!0}for(E=1,v=new Array(y-1);E<y;E++)v[E-1]=arguments[E];p.fn.apply(p.context,v)}else{var x=p.length,I;for(E=0;E<x;E++)switch(p[E].once&&this.removeListener(c,p[E].fn,void 0,!0),y){case 1:p[E].fn.call(p[E].context);break;case 2:p[E].fn.call(p[E].context,u);break;case 3:p[E].fn.call(p[E].context,u,h);break;case 4:p[E].fn.call(p[E].context,u,h,f);break;default:if(!v)for(I=1,v=new Array(y-1);I<y;I++)v[I-1]=arguments[I];p[E].fn.apply(p[E].context,v)}}return!0},a.prototype.on=function(c,u,h){return s(this,c,u,h,!1)},a.prototype.once=function(c,u,h){return s(this,c,u,h,!0)},a.prototype.removeListener=function(c,u,h,f){var d=t?t+c:c;if(!this._events[d])return this;if(!u)return o(this,d),this;var m=this._events[d];if(m.fn)m.fn===u&&(!f||m.once)&&(!h||m.context===h)&&o(this,d);else{for(var A=0,p=[],y=m.length;A<y;A++)(m[A].fn!==u||f&&!m[A].once||h&&m[A].context!==h)&&p.push(m[A]);p.length?this._events[d]=p.length===1?p[0]:p:o(this,d)}return this},a.prototype.removeAllListeners=function(c){var u;return c?(u=t?t+c:c,this._events[u]&&o(this,u)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,r.exports=a})(Hd)),Hd.exports}var u7=c7(),qA=N9(u7);const yc="1.6.14",ka={};function h7(){return typeof __HLS_WORKER_BUNDLE__=="function"}function f7(){const r=ka[yc];if(r)return r.clientCount++,r;const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e),n={worker:new self.Worker(t),objectURL:t,clientCount:1};return ka[yc]=n,n}function d7(r){const e=ka[r];if(e)return e.clientCount++,e;const t=new self.URL(r,self.location.href).href,n={worker:new self.Worker(t),scriptURL:t,clientCount:1};return ka[r]=n,n}function m7(r){const e=ka[r||yc];if(e&&e.clientCount--===1){const{worker:i,objectURL:n}=e;delete ka[r||yc],n&&self.URL.revokeObjectURL(n),i.terminate()}}function bI(r,e){return e+10<=r.length&&r[e]===51&&r[e+1]===68&&r[e+2]===73&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function XA(r,e){return e+10<=r.length&&r[e]===73&&r[e+1]===68&&r[e+2]===51&&r[e+3]<255&&r[e+4]<255&&r[e+6]<128&&r[e+7]<128&&r[e+8]<128&&r[e+9]<128}function yf(r,e){let t=0;return t=(r[e]&127)<<21,t|=(r[e+1]&127)<<14,t|=(r[e+2]&127)<<7,t|=r[e+3]&127,t}function vc(r,e){const t=e;let i=0;for(;XA(r,e);){i+=10;const n=yf(r,e+6);i+=n,bI(r,e+10)&&(i+=10),e+=i}if(i>0)return r.subarray(t,t+i)}function A7(r,e,t,i){const n=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],s=e[t+2],o=s>>2&15;if(o>12){const d=new Error(`invalid ADTS sampling index:${o}`);r.emit(L.ERROR,L.ERROR,{type:Je.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!0,error:d,reason:d.message});return}const a=(s>>6&3)+1,l=e[t+3]>>6&3|(s&1)<<2,c="mp4a.40."+a,u=n[o];let h=o;(a===5||a===29)&&(h-=3);const f=[a<<3|(h&14)>>1,(h&1)<<7|l<<3];return Kt.log(`manifest codec:${i}, parsed codec:${c}, channels:${l}, rate:${u} (ADTS object type:${a} sampling index:${o})`),{config:f,samplerate:u,channelCount:l,codec:c,parsedCodec:c,manifestCodec:i}}function wI(r,e){return r[e]===255&&(r[e+1]&246)===240}function BI(r,e){return r[e+1]&1?7:9}function JA(r,e){return(r[e+3]&3)<<11|r[e+4]<<3|(r[e+5]&224)>>>5}function p7(r,e){return e+5<r.length}function zh(r,e){return e+1<r.length&&wI(r,e)}function g7(r,e){return p7(r,e)&&wI(r,e)&&JA(r,e)<=r.length-e}function y7(r,e){if(zh(r,e)){const t=BI(r,e);if(e+t>=r.length)return!1;const i=JA(r,e);if(i<=t)return!1;const n=e+i;return n===r.length||zh(r,n)}return!1}function RI(r,e,t,i,n){if(!r.samplerate){const s=A7(e,t,i,n);if(!s)return;Yt(r,s)}}function DI(r){return 1024*9e4/r}function v7(r,e){const t=BI(r,e);if(e+t<=r.length){const i=JA(r,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function MI(r,e,t,i,n){const s=DI(r.samplerate),o=i+n*s,a=v7(e,t);let l;if(a){const{frameLength:h,headerLength:f}=a,d=f+h,m=Math.max(0,t+d-e.length);m?(l=new Uint8Array(d-f),l.set(e.subarray(t+f,e.length),0)):l=e.subarray(t+f,t+d);const A={unit:l,pts:o};return m||r.samples.push(A),{sample:A,length:d,missing:m}}const c=e.length-t;return l=new Uint8Array(c),l.set(e.subarray(t,e.length),0),{sample:{unit:l,pts:o},length:c,missing:-1}}function E7(r,e){return XA(r,e)&&yf(r,e+6)+10<=r.length-e}function x7(r){return r instanceof ArrayBuffer?r:r.byteOffset==0&&r.byteLength==r.buffer.byteLength?r.buffer:new Uint8Array(r).buffer}function Vd(r,e=0,t=1/0){return I7(r,e,t,Uint8Array)}function I7(r,e,t,i){const n=C7(r);let s=1;"BYTES_PER_ELEMENT"in i&&(s=i.BYTES_PER_ELEMENT);const o=_7(r)?r.byteOffset:0,a=(o+r.byteLength)/s,l=(o+e)/s,c=Math.floor(Math.max(0,Math.min(l,a))),u=Math.floor(Math.min(c+Math.max(t,0),a));return new i(n,c,u-c)}function C7(r){return r instanceof ArrayBuffer?r:r.buffer}function _7(r){return r&&r.buffer instanceof ArrayBuffer&&r.byteLength!==void 0&&r.byteOffset!==void 0}function S7(r){const e={key:r.type,description:"",data:"",mimeType:null,pictureType:null},t=3;if(r.size<2)return;if(r.data[0]!==t){console.log("Ignore frame with unrecognized character encoding");return}const i=r.data.subarray(1).indexOf(0);if(i===-1)return;const n=Qn(Vd(r.data,1,i)),s=r.data[2+i],o=r.data.subarray(3+i).indexOf(0);if(o===-1)return;const a=Qn(Vd(r.data,3+i,o));let l;return n==="-->"?l=Qn(Vd(r.data,4+i+o)):l=x7(r.data.subarray(4+i+o)),e.mimeType=n,e.pictureType=s,e.description=a,e.data=l,e}function T7(r){if(r.size<2)return;const e=Qn(r.data,!0),t=new Uint8Array(r.data.subarray(e.length+1));return{key:r.type,info:e,data:t.buffer}}function b7(r){if(r.size<2)return;if(r.type==="TXXX"){let t=1;const i=Qn(r.data.subarray(t),!0);t+=i.length+1;const n=Qn(r.data.subarray(t));return{key:r.type,info:i,data:n}}const e=Qn(r.data.subarray(1));return{key:r.type,info:"",data:e}}function w7(r){if(r.type==="WXXX"){if(r.size<2)return;let t=1;const i=Qn(r.data.subarray(t),!0);t+=i.length+1;const n=Qn(r.data.subarray(t));return{key:r.type,info:i,data:n}}const e=Qn(r.data);return{key:r.type,info:"",data:e}}function B7(r){return r.type==="PRIV"?T7(r):r.type[0]==="W"?w7(r):r.type==="APIC"?S7(r):b7(r)}function R7(r){const e=String.fromCharCode(r[0],r[1],r[2],r[3]),t=yf(r,4),i=10;return{type:e,size:t,data:r.subarray(i,i+t)}}const pu=10,D7=10;function LI(r){let e=0;const t=[];for(;XA(r,e);){const i=yf(r,e+6);r[e+5]>>6&1&&(e+=pu),e+=pu;const n=e+i;for(;e+D7<n;){const s=R7(r.subarray(e)),o=B7(s);o&&t.push(o),e+=s.size+pu}bI(r,e)&&(e+=pu)}return t}function PI(r){return r&&r.key==="PRIV"&&r.info==="com.apple.streaming.transportStreamTimestamp"}function M7(r){if(r.data.byteLength===8){const e=new Uint8Array(r.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}}function ZA(r){const e=LI(r);for(let t=0;t<e.length;t++){const i=e[t];if(PI(i))return M7(i)}}let xn=(function(r){return r.audioId3="org.id3",r.dateRange="com.apple.quicktime.HLS",r.emsg="https://aomedia.org/emsg/ID3",r.misbklv="urn:misb:KLV:bin:1910.1",r})({});function Qs(r="",e=9e4){return{type:r,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class ep{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=rs(this.cachedData,e),this.cachedData=null);let i=vc(e,0),n=i?i.length:0,s;const o=this._audioTrack,a=this._id3Track,l=i?ZA(i):void 0,c=e.length;for((this.basePTS===null||this.frameIndex===0&&He(l))&&(this.basePTS=L7(l,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:xn.audioId3,duration:Number.POSITIVE_INFINITY});n<c;){if(this.canParse(e,n)){const u=this.appendFrame(o,e,n);u?(this.frameIndex++,this.lastPTS=u.sample.pts,n+=u.length,s=n):n=c}else E7(e,n)?(i=vc(e,n),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:xn.audioId3,duration:Number.POSITIVE_INFINITY}),n+=i.length,s=n):n++;if(n===c&&s!==c){const u=e.slice(s);this.cachedData?this.cachedData=rs(this.cachedData,u):this.cachedData=u}}return{audioTrack:o,videoTrack:Qs(),id3Track:a,textTrack:Qs()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Qs(),id3Track:this._id3Track,textTrack:Qs()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const L7=(r,e,t)=>{if(He(r))return r*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};let gu=null;const P7=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],F7=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],k7=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],O7=[0,1,1,4];function FI(r,e,t,i,n){if(t+24>e.length)return;const s=kI(e,t);if(s&&t+s.frameLength<=e.length){const o=s.samplesPerFrame*9e4/s.sampleRate,a=i+n*o,l={unit:e.subarray(t,t+s.frameLength),pts:a,dts:a};return r.config=[],r.channelCount=s.channelCount,r.samplerate=s.sampleRate,r.samples.push(l),{sample:l,length:s.frameLength,missing:0}}}function kI(r,e){const t=r[e+1]>>3&3,i=r[e+1]>>1&3,n=r[e+2]>>4&15,s=r[e+2]>>2&3;if(t!==1&&n!==0&&n!==15&&s!==3){const o=r[e+2]>>1&1,a=r[e+3]>>6,l=t===3?3-i:i===3?3:4,c=P7[l*14+n-1]*1e3,h=F7[(t===3?0:t===2?1:2)*3+s],f=a===3?1:2,d=k7[t][i],m=O7[i],A=d*8*m,p=Math.floor(d*c/h+o)*m;if(gu===null){const E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);gu=E?parseInt(E[1]):0}return!!gu&&gu<=87&&i===2&&c>=224e3&&a===0&&(r[e+3]=r[e+3]|128),{sampleRate:h,channelCount:f,frameLength:p,samplesPerFrame:A}}}function tp(r,e){return r[e]===255&&(r[e+1]&224)===224&&(r[e+1]&6)!==0}function OI(r,e){return e+1<r.length&&tp(r,e)}function U7(r,e){return tp(r,e)&&4<=r.length-e}function UI(r,e){if(e+1<r.length&&tp(r,e)){const i=kI(r,e);let n=4;i!=null&&i.frameLength&&(n=i.frameLength);const s=e+n;return s===r.length||OI(r,s)}return!1}class N7 extends ep{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const i=vc(e,0);let n=i?.length||0;if(UI(e,n))return!1;for(let s=e.length;n<s;n++)if(y7(e,n))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return g7(e,t)}appendFrame(e,t,i){RI(e,this.observer,t,i,e.manifestCodec);const n=MI(e,t,i,this.basePTS,this.frameIndex);if(n&&n.missing===0)return n}}const NI=(r,e)=>{let t=0,i=5;e+=i;const n=new Uint32Array(1),s=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=r[e];const a=Math.min(i,8),l=8-a;s[0]=4278190080>>>24+l<<l,n[0]=(o[0]&s[0])>>l,t=t?t<<a|n[0]:n[0],e+=1,i-=a}return t};class G7 extends ep{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const n=GI(e,t,i,this.basePTS,this.frameIndex);if(n!==-1)return{sample:e.samples[e.samples.length-1],length:n,missing:0}}static probe(e){if(!e)return!1;const t=vc(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&ZA(t)!==void 0&&NI(e,i)<16}}function GI(r,e,t,i,n){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const s=e[t+4]>>6;if(s>=3)return-1;const a=[48e3,44100,32e3][s],l=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][l*3+s]*2;if(t+u>e.length)return-1;const h=e[t+6]>>5;let f=0;h===2?f+=2:(h&1&&h!==1&&(f+=2),h&4&&(f+=2));const d=(e[t+6]<<8|e[t+7])>>12-f&1,A=[2,1,2,3,3,4,4,5][h]+d,p=e[t+5]>>3,y=e[t+5]&7,v=new Uint8Array([s<<6|p<<1|y>>2,(y&3)<<6|h<<3|d<<2|l>>4,l<<4&224]),E=1536/a*9e4,x=i+n*E,I=e.subarray(t,t+u);return r.config=v,r.channelCount=A,r.samplerate=a,r.samples.push({unit:I,pts:x}),u}class Q7 extends ep{resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=vc(e,0);let i=t?.length||0;if(t&&e[i]===11&&e[i+1]===119&&ZA(t)!==void 0&&NI(e,i)<=16)return!1;for(let n=e.length;i<n;i++)if(UI(e,i))return Kt.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return U7(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return FI(e,t,i,this.basePTS,this.frameIndex)}}const z7=/\/emsg[-/]ID3/i;class H7{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,n){const s=this.videoTrack=Qs("video",1),o=this.audioTrack=Qs("audio",1),a=this.txtTrack=Qs("text",1);if(this.id3Track=Qs("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const l=jx(e);if(l.video){const{id:c,timescale:u,codec:h,supplemental:f}=l.video;s.id=c,s.timescale=a.timescale=u,s.codec=h,s.supplemental=f}if(l.audio){const{id:c,timescale:u,codec:h}=l.audio;o.id=c,o.timescale=u,o.codec=h}a.id=$x.text,s.sampleDuration=0,s.duration=o.duration=n}resetContiguity(){this.remainderData=null}static probe(e){return H9(e)}demux(e,t){this.timeOffset=t;let i=e;const n=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=rs(this.remainderData,e));const a=q9(i);this.remainderData=a.remainder,n.samples=a.valid||new Uint8Array}else n.samples=i;const o=this.extractID3Track(n,t);return s.samples=Iy(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const n=this.extractID3Track(t,this.timeOffset);return i.samples=Iy(e,t),{videoTrack:t,audioTrack:Qs(),id3Track:n,textTrack:Qs()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const n=It(e.samples,["emsg"]);n&&n.forEach(s=>{const o=J9(s);if(z7.test(o.schemeIdUri)){const a=s2(o,t);let l=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;l<=.001&&(l=Number.POSITIVE_INFINITY);const c=o.payload;i.samples.push({data:c,len:c.byteLength,dts:a,pts:a,type:xn.emsg,duration:l})}else if(this.config.enableEmsgKLVMetadata&&o.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const a=s2(o,t);i.samples.push({data:o.payload,len:o.payload.byteLength,dts:a,pts:a,type:xn.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}}function s2(r,e){return He(r.presentationTime)?r.presentationTime/r.timeScale:e+r.presentationTimeDelta/r.timeScale}class V7{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new KA(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,Kr.cbc)}decryptAacSample(e,t,i){const n=e[t].unit;if(n.length<=16)return;const s=n.subarray(16,n.length-n.length%16),o=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(o).then(a=>{const l=new Uint8Array(a);n.set(l,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)}).catch(i)}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let n=0;for(let s=32;s<e.length-16;s+=160,n+=16)i.set(e.subarray(s,s+16),n);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let n=0;for(let s=32;s<e.length-16;s+=160,n+=16)e.set(i.subarray(n,n+16),s);return e}decryptAvcSample(e,t,i,n,s){const o=Jx(s.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(l=>{s.data=this.getAvcDecryptedUnit(o,l),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,n)}).catch(n)}decryptAvcSamples(e,t,i,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){n();return}const s=e[t].units;for(;!(i>=s.length);i++){const o=s[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,n,o),!this.decrypter.isSync()))return}}}}class QI{constructor(){this.VideoSample=null}createVideoSample(e,t,i){return{key:e,frame:!1,pts:t,dts:i,units:[],length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,n;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const s=i.units;n=s[s.length-1]}return n}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,n=i.length;if(n){const s=i[n-1];e.pts=s.pts,e.dts=s.dts}else{t.dropped++;return}}t.samples.push(e)}}parseNALu(e,t,i){const n=t.byteLength;let s=e.naluState||0;const o=s,a=[];let l=0,c,u,h,f=-1,d=0;for(s===-1&&(f=0,d=this.getNALuType(t,0),s=0,l=1);l<n;){if(c=t[l++],!s){s=c?0:1;continue}if(s===1){s=c?0:2;continue}if(!c)s=3;else if(c===1){if(u=l-s-1,f>=0){const m={data:t.subarray(f,u),type:d};a.push(m)}else{const m=this.getLastNalUnit(e.samples);m&&(o&&l<=4-o&&m.state&&(m.data=m.data.subarray(0,m.data.byteLength-o)),u>0&&(m.data=rs(m.data,t.subarray(0,u)),m.state=0))}l<n?(h=this.getNALuType(t,l),f=l,d=h,s=0):s=-1}else s=0}if(f>=0&&s>=0){const m={data:t.subarray(f,n),type:d,state:s};a.push(m)}if(a.length===0){const m=this.getLastNalUnit(e.samples);m&&(m.data=rs(m.data,t))}return e.naluState=s,a}}class ic{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,n=new Uint8Array(4),s=Math.min(4,t);if(s===0)throw new Error("no bytes available");n.set(e.subarray(i,i+s)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=s*8,this.bytesAvailable-=s}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&Kt.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if((this.word&2147483648>>>e)!==0)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class K7 extends QI{parsePES(e,t,i,n){const s=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,l=!1;i.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),s.forEach(c=>{var u,h;switch(c.type){case 1:{let A=!1;a=!0;const p=c.data;if(l&&p.length>4){const y=this.readSliceType(p);(y===2||y===4||y===7||y===9)&&(A=!0)}if(A){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.frame=!0,o.key=A;break}case 5:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 6:{a=!0,QA(c.data,1,i.pts,t.samples);break}case 7:{var d,m;a=!0,l=!0;const A=c.data,p=this.readSPS(A);if(!e.sps||e.width!==p.width||e.height!==p.height||((d=e.pixelRatio)==null?void 0:d[0])!==p.pixelRatio[0]||((m=e.pixelRatio)==null?void 0:m[1])!==p.pixelRatio[1]){e.width=p.width,e.height=p.height,e.pixelRatio=p.pixelRatio,e.sps=[A];const y=A.subarray(1,4);let v="avc1.";for(let E=0;E<3;E++){let x=y[E].toString(16);x.length<2&&(x="0"+x),v+=x}e.codec=v}break}case 8:a=!0,e.pps=[c.data];break;case 9:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;case 12:a=!0;break;default:a=!1;break}o&&a&&o.units.push(c)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}getNALuType(e,t){return e[t]&31}readSliceType(e){const t=new ic(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let i=8,n=8,s;for(let o=0;o<e;o++)n!==0&&(s=t.readEG(),n=(i+s+256)%256),i=n===0?i:n}readSPS(e){const t=new ic(e);let i=0,n=0,s=0,o=0,a,l,c;const u=t.readUByte.bind(t),h=t.readBits.bind(t),f=t.readUEG.bind(t),d=t.readBoolean.bind(t),m=t.skipBits.bind(t),A=t.skipEG.bind(t),p=t.skipUEG.bind(t),y=this.skipScalingList.bind(this);u();const v=u();if(h(5),m(3),u(),p(),v===100||v===110||v===122||v===244||v===44||v===83||v===86||v===118||v===128){const S=f();if(S===3&&m(1),p(),p(),m(1),d())for(l=S!==3?8:12,c=0;c<l;c++)d()&&(c<6?y(16,t):y(64,t))}p();const E=f();if(E===0)f();else if(E===1)for(m(1),A(),A(),a=f(),c=0;c<a;c++)A();p(),m(1);const x=f(),I=f(),C=h(1);C===0&&m(1),m(1),d()&&(i=f(),n=f(),s=f(),o=f());let _=[1,1];if(d()&&d())switch(u()){case 1:_=[1,1];break;case 2:_=[12,11];break;case 3:_=[10,11];break;case 4:_=[16,11];break;case 5:_=[40,33];break;case 6:_=[24,11];break;case 7:_=[20,11];break;case 8:_=[32,11];break;case 9:_=[80,33];break;case 10:_=[18,11];break;case 11:_=[15,11];break;case 12:_=[64,33];break;case 13:_=[160,99];break;case 14:_=[4,3];break;case 15:_=[3,2];break;case 16:_=[2,1];break;case 255:{_=[u()<<8|u(),u()<<8|u()];break}}return{width:Math.ceil((x+1)*16-i*2-n*2),height:(2-C)*(I+1)*16-(C?2:4)*(s+o),pixelRatio:_}}}class $7 extends QI{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,i,n){const s=this.parseNALu(e,i.data,n);let o=this.VideoSample,a,l=!1;i.data=null,o&&s.length&&!e.audFound&&(this.pushAccessUnit(o,e),o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),s.forEach(c=>{var u,h;switch(c.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),o.frame=!0,a=!0;break;case 16:case 17:case 18:case 21:if(a=!0,l){var f;(f=o)!=null&&f.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null)}o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 19:case 20:a=!0,(u=o)!=null&&u.frame&&!o.key&&(this.pushAccessUnit(o,e),o=this.VideoSample=null),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0,o.frame=!0;break;case 39:a=!0,QA(c.data,2,i.pts,t.samples);break;case 32:a=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=Yt(e.params,this.readVPS(c.data)),this.initVPS=c.data),e.vps=[c.data];break;case 33:if(a=!0,l=!0,e.vps!==void 0&&e.vps[0]!==this.initVPS&&e.sps!==void 0&&!this.matchSPS(e.sps[0],c.data)&&(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const d=this.readSPS(c.data);e.width=d.width,e.height=d.height,e.pixelRatio=d.pixelRatio,e.codec=d.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(const m in d.params)e.params[m]=d.params[m]}this.pushParameterSet(e.sps,c.data,e.vps),o||(o=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts)),o.key=!0;break;case 34:if(a=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];const d=this.readPPS(c.data);for(const m in d)e.params[m]=d[m]}this.pushParameterSet(e.pps,c.data,e.vps)}break;case 35:a=!0,e.audFound=!0,(h=o)!=null&&h.frame&&(this.pushAccessUnit(o,e),o=null),o||(o=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts));break;default:a=!1;break}o&&a&&o.units.push(c)}),n&&o&&(this.pushAccessUnit(o,e),this.VideoSample=null)}pushParameterSet(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)}getNALuType(e,t){return(e[t]&126)>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let i=0;for(let n=0;n<e.byteLength;n++)n>=2&&e[n]===3&&e[n-1]===0&&e[n-2]===0||(t[i]=e[n],i++);return new Uint8Array(t.buffer,0,i)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new ic(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);const i=t.readBits(3),n=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:n}}readSPS(e){const t=new ic(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const i=t.readBits(3);t.readBoolean();const n=t.readBits(2),s=t.readBoolean(),o=t.readBits(5),a=t.readUByte(),l=t.readUByte(),c=t.readUByte(),u=t.readUByte(),h=t.readUByte(),f=t.readUByte(),d=t.readUByte(),m=t.readUByte(),A=t.readUByte(),p=t.readUByte(),y=t.readUByte(),v=[],E=[];for(let se=0;se<i;se++)v.push(t.readBoolean()),E.push(t.readBoolean());if(i>0)for(let se=i;se<8;se++)t.readBits(2);for(let se=0;se<i;se++)v[se]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),E[se]&&t.readUByte();t.readUEG();const x=t.readUEG();x==3&&t.skipBits(1);const I=t.readUEG(),C=t.readUEG(),_=t.readBoolean();let S=0,b=0,T=0,R=0;_&&(S+=t.readUEG(),b+=t.readUEG(),T+=t.readUEG(),R+=t.readUEG());const w=t.readUEG(),B=t.readUEG(),M=t.readUEG(),O=t.readBoolean();for(let se=O?0:i;se<=i;se++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let he=0;he<4;he++)for(let le=0;le<(he===3?2:6);le++)if(!t.readBoolean())t.readUEG();else{const q=Math.min(64,1<<4+(he<<1));he>1&&t.readEG();for(let oe=0;oe<q;oe++)t.readEG()}t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const W=t.readUEG();let N=0;for(let se=0;se<W;se++){let he=!1;if(se!==0&&(he=t.readBoolean()),he){se===W&&t.readUEG(),t.readBoolean(),t.readUEG();let le=0;for(let J=0;J<=N;J++){const q=t.readBoolean();let oe=!1;q||(oe=t.readBoolean()),(q||oe)&&le++}N=le}else{const le=t.readUEG(),J=t.readUEG();N=le+J;for(let q=0;q<le;q++)t.readUEG(),t.readBoolean();for(let q=0;q<J;q++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const se=t.readUEG();for(let he=0;he<se;he++){for(let le=0;le<M+4;le++)t.readBits(1);t.readBits(1)}}let D=0,z=1,$=1,V=!0,P=1,G=0;t.readBoolean(),t.readBoolean();let F=!1;if(t.readBoolean()){if(t.readBoolean()){const Ie=t.readUByte(),_e=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],Be=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Ie>0&&Ie<16?(z=_e[Ie-1],$=Be[Ie-1]):Ie===255&&(z=t.readBits(16),$=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),F=t.readBoolean(),F&&(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG()),t.readBoolean()&&(P=t.readBits(32),G=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const Be=t.readBoolean(),Se=t.readBoolean();let Ke=!1;(Be||Se)&&(Ke=t.readBoolean(),Ke&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),Ke&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let Me=0;Me<=i;Me++){V=t.readBoolean();const Ge=V||t.readBoolean();let Qe=!1;Ge?t.readEG():Qe=t.readBoolean();const qe=Qe?1:t.readUEG()+1;if(Be)for(let rt=0;rt<qe;rt++)t.readUEG(),t.readUEG(),Ke&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(Se)for(let rt=0;rt<qe;rt++)t.readUEG(),t.readUEG(),Ke&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),D=t.readUEG())}let Z=I,ne=C;if(_){let se=1,he=1;x===1?se=he=2:x==2&&(se=2),Z=I-se*b-se*S,ne=C-he*R-he*T}const X=n?["A","B","C"][n]:"",te=a<<24|l<<16|c<<8|u;let ye=0;for(let se=0;se<32;se++)ye=(ye|(te>>se&1)<<31-se)>>>0;let ve=ye.toString(16);return o===1&&ve==="2"&&(ve="6"),{codecString:`hvc1.${X}${o}.${ve}.${s?"H":"L"}${y}.B0`,params:{general_tier_flag:s,general_profile_idc:o,general_profile_space:n,general_profile_compatibility_flags:[a,l,c,u],general_constraint_indicator_flags:[h,f,d,m,A,p],general_level_idc:y,bit_depth:w+8,bit_depth_luma_minus8:w,bit_depth_chroma_minus8:B,min_spatial_segmentation_idc:D,chroma_format_idc:x,frame_rate:{fixed:V,fps:G/P}},width:Z,height:ne,pixelRatio:[z,$]}}readPPS(e){const t=new ic(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const n=t.readBoolean(),s=t.readBoolean();let o=1;return s&&n?o=0:s?o=3:n&&(o=2),{parallelismType:o}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Ki=188;class Pr{constructor(e,t,i,n){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.logger=n,this.videoParser=null}static probe(e,t){const i=Pr.syncOffset(e);return i>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${i}`),i!==-1}static syncOffset(e){const t=e.length;let i=Math.min(Ki*5,t-Ki)+1,n=0;for(;n<i;){let s=!1,o=-1,a=0;for(let l=n;l<t;l+=Ki)if(e[l]===71&&(t-l===Ki||e[l+Ki]===71)){if(a++,o===-1&&(o=l,o!==0&&(i=Math.min(o+Ki*99,e.length-Ki)+1)),s||(s=Lm(e,l)===0),s&&a>1&&(o===0&&a>2||l+Ki>i))return o}else{if(a)return-1;break}n++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:$x[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,n){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Pr.createTrack("video"),this._videoTrack.duration=n,this._audioTrack=Pr.createTrack("audio",n),this._id3Track=Pr.createTrack("id3"),this._txtTrack=Pr.createTrack("text"),this._audioTrack.segmentCodec="aac",this.videoParser=null,this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,n=!1){i||(this.sampleAes=null);let s;const o=this._videoTrack,a=this._audioTrack,l=this._id3Track,c=this._txtTrack;let u=o.pid,h=o.pesData,f=a.pid,d=l.pid,m=a.pesData,A=l.pesData,p=null,y=this.pmtParsed,v=this._pmtId,E=e.length;if(this.remainderData&&(e=rs(this.remainderData,e),E=e.length,this.remainderData=null),E<Ki&&!n)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:l,textTrack:c};const x=Math.max(0,Pr.syncOffset(e));E-=(E-x)%Ki,E<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,E,e.buffer.byteLength-E));let I=0;for(let _=x;_<E;_+=Ki)if(e[_]===71){const S=!!(e[_+1]&64),b=Lm(e,_),T=(e[_+3]&48)>>4;let R;if(T>1){if(R=_+5+e[_+4],R===_+Ki)continue}else R=_+4;switch(b){case u:S&&(h&&(s=Ho(h,this.logger))&&(this.readyVideoParser(o.segmentCodec),this.videoParser!==null&&this.videoParser.parsePES(o,c,s,!1)),h={data:[],size:0}),h&&(h.data.push(e.subarray(R,_+Ki)),h.size+=_+Ki-R);break;case f:if(S){if(m&&(s=Ho(m,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,s);break;case"mp3":this.parseMPEGPES(a,s);break;case"ac3":this.parseAC3PES(a,s);break}m={data:[],size:0}}m&&(m.data.push(e.subarray(R,_+Ki)),m.size+=_+Ki-R);break;case d:S&&(A&&(s=Ho(A,this.logger))&&this.parseID3PES(l,s),A={data:[],size:0}),A&&(A.data.push(e.subarray(R,_+Ki)),A.size+=_+Ki-R);break;case 0:S&&(R+=e[R]+1),v=this._pmtId=Y7(e,R);break;case v:{S&&(R+=e[R]+1);const w=W7(e,R,this.typeSupported,i,this.observer,this.logger);u=w.videoPid,u>0&&(o.pid=u,o.segmentCodec=w.segmentVideoCodec),f=w.audioPid,f>0&&(a.pid=f,a.segmentCodec=w.segmentAudioCodec),d=w.id3Pid,d>0&&(l.pid=d),p!==null&&!y&&(this.logger.warn(`MPEG-TS PMT found at ${_} after unknown PID '${p}'. Backtracking to sync byte @${x} to parse all TS packets.`),p=null,_=x-188),y=this.pmtParsed=!0;break}case 17:case 8191:break;default:p=b;break}}else I++;I>0&&Pm(this.observer,new Error(`Found ${I} TS packet/s that do not start with 0x47`),void 0,this.logger),o.pesData=h,a.pesData=m,l.pesData=A;const C={audioTrack:a,videoTrack:o,id3Track:l,textTrack:c};return n&&this.extractRemainingSamples(C),C}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:n,textTrack:s}=e,o=i.pesData,a=t.pesData,l=n.pesData;let c;if(o&&(c=Ho(o,this.logger))?(this.readyVideoParser(i.segmentCodec),this.videoParser!==null&&(this.videoParser.parsePES(i,s,c,!0),i.pesData=null)):i.pesData=o,a&&(c=Ho(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c);break}t.pesData=null}else a!=null&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;l&&(c=Ho(l,this.logger))?(this.parseID3PES(n,c),n.pesData=null):n.pesData=l}demuxSampleAes(e,t,i){const n=this.demux(e,i,!0,!this.config.progressive),s=this.sampleAes=new V7(this.observer,this.config,t);return this.decrypt(n,s)}readyVideoParser(e){this.videoParser===null&&(e==="avc"?this.videoParser=new K7:e==="hevc"&&(this.videoParser=new $7))}decrypt(e,t){return new Promise(i=>{const{audioTrack:n,videoTrack:s}=e;n.samples&&n.segmentCodec==="aac"?t.decryptAacSamples(n.samples,0,()=>{s.samples?t.decryptAvcSamples(s.samples,0,0,()=>{i(e)}):i(e)}):s.samples&&t.decryptAvcSamples(s.samples,0,0,()=>{i(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let i=0;const n=this.aacOverFlow;let s=t.data;if(n){this.aacOverFlow=null;const h=n.missing,f=n.sample.unit.byteLength;if(h===-1)s=rs(n.sample.unit,s);else{const d=f-h;n.sample.unit.set(s.subarray(0,h),d),e.samples.push(n.sample),i=n.missing}}let o,a;for(o=i,a=s.length;o<a-1&&!zh(s,o);o++);if(o!==i){let h;const f=o<a-1;if(f?h=`AAC PES did not start with ADTS header,offset:${o}`:h="No ADTS header found in AAC PES",Pm(this.observer,new Error(h),f,this.logger),!f)return}RI(e,this.observer,s,o,this.audioCodec);let l;if(t.pts!==void 0)l=t.pts;else if(n){const h=DI(e.samplerate);l=n.sample.pts+h}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let c=0,u;for(;o<a;)if(u=MI(e,s,o,l,c),o+=u.length,u.missing){this.aacOverFlow=u;break}else for(c++;o<a-1&&!zh(s,o);o++);}parseMPEGPES(e,t){const i=t.data,n=i.length;let s=0,o=0;const a=t.pts;if(a===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<n;)if(OI(i,o)){const l=FI(e,i,o,a,s);if(l)o+=l.length,s++;else break}else o++}parseAC3PES(e,t){{const i=t.data,n=t.pts;if(n===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const s=i.length;let o=0,a=0,l;for(;a<s&&(l=GI(e,i,a,n,o++))>0;)a+=l}}parseID3PES(e,t){if(t.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=Yt({},t,{type:this._videoTrack?xn.emsg:xn.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function Lm(r,e){return((r[e+1]&31)<<8)+r[e+2]}function Y7(r,e){return(r[e+10]&31)<<8|r[e+11]}function W7(r,e,t,i,n,s){const o={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(r[e+1]&15)<<8|r[e+2],l=e+3+a-4,c=(r[e+10]&15)<<8|r[e+11];for(e+=12+c;e<l;){const u=Lm(r,e),h=(r[e+3]&15)<<8|r[e+4];switch(r[e]){case 207:if(!i){Kd("ADTS AAC",s);break}case 15:o.audioPid===-1&&(o.audioPid=u);break;case 21:o.id3Pid===-1&&(o.id3Pid=u);break;case 219:if(!i){Kd("H.264",s);break}case 27:o.videoPid===-1&&(o.videoPid=u);break;case 3:case 4:!t.mpeg&&!t.mp3?s.log("MPEG audio found, not supported in this browser"):o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="mp3");break;case 193:if(!i){Kd("AC-3",s);break}case 129:t.ac3?o.audioPid===-1&&(o.audioPid=u,o.segmentAudioCodec="ac3"):s.log("AC-3 audio found, not supported in this browser");break;case 6:if(o.audioPid===-1&&h>0){let f=e+5,d=h;for(;d>2;){switch(r[f]){case 106:t.ac3!==!0?s.log("AC-3 audio found, not supported in this browser for now"):(o.audioPid=u,o.segmentAudioCodec="ac3");break}const A=r[f+1]+2;f+=A,d-=A}}break;case 194:case 135:return Pm(n,new Error("Unsupported EC-3 in M2TS found"),void 0,s),o;case 36:o.videoPid===-1&&(o.videoPid=u,o.segmentVideoCodec="hevc",s.log("HEVC in M2TS found"));break}e+=h+5}return o}function Pm(r,e,t,i){i.warn(`parsing error: ${e.message}`),r.emit(L.ERROR,L.ERROR,{type:Je.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function Kd(r,e){e.log(`${r} with AES-128-CBC encryption found in unencrypted stream`)}function Ho(r,e){let t=0,i,n,s,o,a;const l=r.data;if(!r||r.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=rs(l[0],l[1]),l.splice(1,1);if(i=l[0],(i[0]<<16)+(i[1]<<8)+i[2]===1){if(n=(i[4]<<8)+i[5],n&&n>r.size-6)return null;const u=i[7];u&192&&(o=(i[9]&14)*536870912+(i[10]&255)*4194304+(i[11]&254)*16384+(i[12]&255)*128+(i[13]&254)/2,u&64?(a=(i[14]&14)*536870912+(i[15]&255)*4194304+(i[16]&254)*16384+(i[17]&255)*128+(i[18]&254)/2,o-a>60*9e4&&(e.warn(`${Math.round((o-a)/9e4)}s delta between PTS and DTS, align them`),o=a)):a=o),s=i[8];let h=s+9;if(r.size<=h)return null;r.size-=h;const f=new Uint8Array(r.size);for(let d=0,m=l.length;d<m;d++){i=l[d];let A=i.byteLength;if(h)if(h>A){h-=A;continue}else i=i.subarray(h),A-=h,h=0;f.set(i,t),t+=A}return n&&(n-=s+3),{data:f,pts:o,dts:a,len:n}}return null}class j7{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Tr=Math.pow(2,32)-1;class ce{static init(){ce.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in ce.types)ce.types.hasOwnProperty(e)&&(ce.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);ce.HDLR_TYPES={video:t,audio:i};const n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);ce.STTS=ce.STSC=ce.STCO=s,ce.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),ce.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),ce.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),ce.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const o=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);ce.FTYP=ce.box(ce.types.ftyp,o,l,o,a),ce.DINF=ce.box(ce.types.dinf,ce.box(ce.types.dref,n))}static box(e,...t){let i=8,n=t.length;const s=n;for(;n--;)i+=t[n].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=i&255,o.set(e,4),n=0,i=8;n<s;n++)o.set(t[n],i),i+=t[n].byteLength;return o}static hdlr(e){return ce.box(ce.types.hdlr,ce.HDLR_TYPES[e])}static mdat(e){return ce.box(ce.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(Tr+1)),n=Math.floor(t%(Tr+1));return ce.box(ce.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,85,196,0,0]))}static mdia(e){return ce.box(ce.types.mdia,ce.mdhd(e.timescale||0,e.duration||0),ce.hdlr(e.type),ce.minf(e))}static mfhd(e){return ce.box(ce.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?ce.box(ce.types.minf,ce.box(ce.types.smhd,ce.SMHD),ce.DINF,ce.stbl(e)):ce.box(ce.types.minf,ce.box(ce.types.vmhd,ce.VMHD),ce.DINF,ce.stbl(e))}static moof(e,t,i){return ce.box(ce.types.moof,ce.mfhd(e),ce.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=ce.trak(e[t]);return ce.box.apply(null,[ce.types.moov,ce.mvhd(e[0].timescale||0,e[0].duration||0)].concat(i).concat(ce.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=ce.trex(e[t]);return ce.box.apply(null,[ce.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(Tr+1)),n=Math.floor(t%(Tr+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,n>>24,n>>16&255,n>>8&255,n&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return ce.box(ce.types.mvhd,s)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let n,s;for(n=0;n<t.length;n++)s=t[n].flags,i[n+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return ce.box(ce.types.sdtp,i)}static stbl(e){return ce.box(ce.types.stbl,ce.stsd(e),ce.box(ce.types.stts,ce.STTS),ce.box(ce.types.stsc,ce.STSC),ce.box(ce.types.stsz,ce.STSZ),ce.box(ce.types.stco,ce.STCO))}static avc1(e){let t=[],i=[],n,s,o;for(n=0;n<e.sps.length;n++)s=e.sps[n],o=s.byteLength,t.push(o>>>8&255),t.push(o&255),t=t.concat(Array.prototype.slice.call(s));for(n=0;n<e.pps.length;n++)s=e.pps[n],o=s.byteLength,i.push(o>>>8&255),i.push(o&255),i=i.concat(Array.prototype.slice.call(s));const a=ce.box(ce.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),l=e.width,c=e.height,u=e.pixelRatio[0],h=e.pixelRatio[1];return ce.box(ce.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,l&255,c>>8&255,c&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,ce.box(ce.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),ce.box(ce.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,h>>24,h>>16&255,h>>8&255,h&255])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return ce.box(ce.types.mp4a,ce.audioStsd(e),ce.box(ce.types.esds,ce.esds(e)))}static mp3(e){return ce.box(ce.types[".mp3"],ce.audioStsd(e))}static ac3(e){return ce.box(ce.types["ac-3"],ce.audioStsd(e),ce.box(ce.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if(e.type==="audio"){if(t==="aac")return ce.box(ce.types.stsd,ce.STSD,ce.mp4a(e));if(t==="ac3"&&e.config)return ce.box(ce.types.stsd,ce.STSD,ce.ac3(e));if(t==="mp3"&&e.codec==="mp3")return ce.box(ce.types.stsd,ce.STSD,ce.mp3(e))}else if(e.pps&&e.sps){if(t==="avc")return ce.box(ce.types.stsd,ce.STSD,ce.avc1(e));if(t==="hevc"&&e.vps)return ce.box(ce.types.stsd,ce.STSD,ce.hvc1(e))}else throw new Error("video track missing pps or sps");throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,i=(e.duration||0)*(e.timescale||0),n=e.width||0,s=e.height||0,o=Math.floor(i/(Tr+1)),a=Math.floor(i%(Tr+1));return ce.box(ce.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,n&255,0,0,s>>8&255,s&255,0,0]))}static traf(e,t){const i=ce.sdtp(e),n=e.id,s=Math.floor(t/(Tr+1)),o=Math.floor(t%(Tr+1));return ce.box(ce.types.traf,ce.box(ce.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255])),ce.box(ce.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,o>>24,o>>16&255,o>>8&255,o&255])),ce.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,ce.box(ce.types.trak,ce.tkhd(e),ce.mdia(e))}static trex(e){const t=e.id;return ce.box(ce.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],n=i.length,s=12+16*n,o=new Uint8Array(s);let a,l,c,u,h,f;for(t+=8+s,o.set([e.type==="video"?1:0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,n&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<n;a++)l=i[a],c=l.duration,u=l.size,h=l.flags,f=l.cts,o.set([c>>>24&255,c>>>16&255,c>>>8&255,c&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*a);return ce.box(ce.types.trun,o)}static initSegment(e){ce.types||ce.init();const t=ce.moov(e);return rs(ce.FTYP,t)}static hvc1(e){const t=e.params,i=[e.vps,e.sps,e.pps],n=4,s=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),n-1|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),i.length]);let o=s.length;for(let m=0;m<i.length;m+=1){o+=3;for(let A=0;A<i[m].length;A+=1)o+=2+i[m][A].length}const a=new Uint8Array(o);a.set(s,0),o=s.length;const l=i.length-1;for(let m=0;m<i.length;m+=1){a.set(new Uint8Array([32+m|(m===l?128:0),0,i[m].length]),o),o+=3;for(let A=0;A<i[m].length;A+=1)a.set(new Uint8Array([i[m][A].length>>8,i[m][A].length&255]),o),o+=2,a.set(i[m][A],o),o+=i[m][A].length}const c=ce.box(ce.types.hvcC,a),u=e.width,h=e.height,f=e.pixelRatio[0],d=e.pixelRatio[1];return ce.box(ce.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,h>>8&255,h&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c,ce.box(ce.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),ce.box(ce.types.pasp,new Uint8Array([f>>24,f>>16&255,f>>8&255,f&255,d>>24,d>>16&255,d>>8&255,d&255])))}}ce.types=void 0;ce.HDLR_TYPES=void 0;ce.STTS=void 0;ce.STSC=void 0;ce.STCO=void 0;ce.STSZ=void 0;ce.VMHD=void 0;ce.SMHD=void 0;ce.STSD=void 0;ce.FTYP=void 0;ce.DINF=void 0;const zI=9e4;function ip(r,e,t=1,i=!1){const n=r*e*t;return i?Math.round(n):n}function q7(r,e,t=1,i=!1){return ip(r,e,1/t,i)}function _l(r,e=!1){return ip(r,1e3,1/zI,e)}function X7(r,e=1){return ip(r,zI,1/e)}function r2(r){const{baseTime:e,timescale:t,trackId:i}=r;return`${e/t} (${e}/${t}) trackId: ${i}`}const J7=10*1e3,Z7=1024,eD=1152,tD=1536;let Vo=null,$d=null;function o2(r,e,t,i){return{duration:e,size:t,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:r?2:1,isNonSync:r?0:1}}}class uh extends as{constructor(e,t,i,n){if(super("mp4-remuxer",n),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,Vo===null){const o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Vo=o?parseInt(o[1]):0}if($d===null){const s=navigator.userAgent.match(/Safari\/(\d+)/i);$d=s?parseInt(s[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){const t=this._initPTS;(!t||!e||e.trackId!==t.trackId||e.baseTime!==t.baseTime||e.timescale!==t.timescale)&&this.log(`Reset initPTS: ${t&&r2(t)} > ${e&&r2(e)}`),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e[0].pts,n=e.reduce((s,o)=>{let a=o.pts,l=a-s;return l<-4294967296&&(t=!0,a=Pn(a,i),l=a-s),l>0?s:a},i);return t&&this.debug("PTS rollover detected"),n}remux(e,t,i,n,s,o,a,l){let c,u,h,f,d,m,A=s,p=s;const y=e.pid>-1,v=t.pid>-1,E=t.samples.length,x=e.samples.length>0,I=a&&E>0||E>1;if((!y||x)&&(!v||I)||this.ISGenerated||a){if(this.ISGenerated){var _,S,b,T;const M=this.videoTrackConfig;(M&&(t.width!==M.width||t.height!==M.height||((_=t.pixelRatio)==null?void 0:_[0])!==((S=M.pixelRatio)==null?void 0:S[0])||((b=t.pixelRatio)==null?void 0:b[1])!==((T=M.pixelRatio)==null?void 0:T[1]))||!M&&I||this.nextAudioTs===null&&x)&&this.resetInitSegment()}this.ISGenerated||(h=this.generateIS(e,t,s,o));const R=this.isVideoContiguous;let w=-1,B;if(I&&(w=iD(t.samples),!R&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,w>0){this.warn(`Dropped ${w} out of ${E} video samples due to a missing keyframe`);const M=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(w),t.dropped+=w,p+=(t.samples[0].pts-M)/t.inputTimeScale,B=p}else w===-1&&(this.warn(`No keyframe found out of ${E} video samples`),m=!1);if(this.ISGenerated){if(x&&I){const M=this.getVideoStartPts(t.samples),U=(Pn(e.samples[0].pts,M)-M)/t.inputTimeScale;A+=Math.max(0,U),p+=Math.max(0,-U)}if(x){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),h=this.generateIS(e,t,s,o)),u=this.remuxAudio(e,A,this.isAudioContiguous,o,v||I||l===$e.AUDIO?p:void 0),I){const M=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),h=this.generateIS(e,t,s,o)),c=this.remuxVideo(t,p,R,M)}}else I&&(c=this.remuxVideo(t,p,R,0));c&&(c.firstKeyFrame=w,c.independent=w!==-1,c.firstKeyFramePTS=B)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(d=HI(i,s,this._initPTS,this._initDTS)),n.samples.length&&(f=VI(n,s,this._initPTS))),{audio:u,video:c,initSegment:h,independent:m,text:f,id3:d}}computeInitPts(e,t,i,n){const s=Math.round(i*t);let o=Pn(e,s);if(o<s+t)for(this.log(`Adjusting PTS for rollover in timeline near ${(s-o)/t} ${n}`);o<s+t;)o+=8589934592;return o-s}generateIS(e,t,i,n){const s=e.samples,o=t.samples,a=this.typeSupported,l={},c=this._initPTS;let u=!c||n,h="audio/mp4",f,d,m,A=-1;if(u&&(f=d=1/0),e.config&&s.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(h="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}l.audio={id:"audio",container:h,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):ce.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(A=e.id,m=e.inputTimeScale,!c||m!==c.timescale?f=d=this.computeInitPts(s[0].pts,m,i,"audio"):u=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,l.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:ce.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(A=t.id,m=t.inputTimeScale,!c||m!==c.timescale){const p=this.getVideoStartPts(o),y=Pn(o[0].dts,p),v=this.computeInitPts(y,m,i,"video"),E=this.computeInitPts(p,m,i,"video");d=Math.min(d,v),f=Math.min(f,E)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(l).length)return this.ISGenerated=!0,u?(c&&this.warn(`Timestamps at playlist time: ${n?"":"~"}${i} ${f/m} != initPTS: ${c.baseTime/c.timescale} (${c.baseTime}/${c.timescale}) trackId: ${c.trackId}`),this.log(`Found initPTS at playlist time: ${i} offset: ${f/m} (${f}/${m}) trackId: ${A}`),this._initPTS={baseTime:f,timescale:m,trackId:A},this._initDTS={baseTime:d,timescale:m,trackId:A}):f=m=void 0,{tracks:l,initPTS:f,timescale:m,trackId:A}}remuxVideo(e,t,i,n){const s=e.inputTimeScale,o=e.samples,a=[],l=o.length,c=this._initPTS,u=c.baseTime*s/c.timescale;let h=this.nextVideoTs,f=8,d=this.videoSampleDuration,m,A,p=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,v=!1;if(!i||h===null){const D=u+t*s,z=o[0].pts-Pn(o[0].dts,o[0].pts);Vo&&h!==null&&Math.abs(D-z-(h+u))<15e3?i=!0:h=D-z-u}const E=h+u;for(let D=0;D<l;D++){const z=o[D];z.pts=Pn(z.pts,E),z.dts=Pn(z.dts,E),z.dts<o[D>0?D-1:D].dts&&(v=!0)}v&&o.sort(function(D,z){const $=D.dts-z.dts,V=D.pts-z.pts;return $||V}),m=o[0].dts,A=o[o.length-1].dts;const x=A-m,I=x?Math.round(x/(l-1)):d||e.inputTimeScale/30;if(i){const D=m-E,z=D>I,$=D<-1;if((z||$)&&(z?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${_l(D,!0)} ms (${D}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${_l(-D,!0)} ms (${D}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!$||E>=o[0].pts||Vo)){m=E;const V=o[0].pts-D;if(z)o[0].dts=m,o[0].pts=V;else{let P=!0;for(let G=0;G<o.length&&!(o[G].dts>V&&P);G++){const F=o[G].pts;if(o[G].dts-=D,o[G].pts-=D,G<o.length-1){const k=o[G+1].pts,Z=o[G].pts,ne=k<=Z,X=k<=F;P=ne==X}}}this.log(`Video: Initial PTS/DTS adjusted: ${_l(V,!0)}/${_l(m,!0)}, delta: ${_l(D,!0)} ms`)}}m=Math.max(0,m);let C=0,_=0,S=m;for(let D=0;D<l;D++){const z=o[D],$=z.units,V=$.length;let P=0;for(let G=0;G<V;G++)P+=$[G].data.length;_+=P,C+=V,z.length=P,z.dts<S?(z.dts=S,S+=I/4|0||1):S=z.dts,p=Math.min(z.pts,p),y=Math.max(z.pts,y)}A=o[l-1].dts;const b=_+4*C+8;let T;try{T=new Uint8Array(b)}catch(D){this.observer.emit(L.ERROR,L.ERROR,{type:Je.MUX_ERROR,details:ue.REMUX_ALLOC_ERROR,fatal:!1,error:D,bytes:b,reason:`fail allocating video mdat ${b}`});return}const R=new DataView(T.buffer);R.setUint32(0,b),T.set(ce.types.mdat,4);let w=!1,B=Number.POSITIVE_INFINITY,M=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,U=Number.NEGATIVE_INFINITY;for(let D=0;D<l;D++){const z=o[D],$=z.units;let V=0;for(let F=0,k=$.length;F<k;F++){const Z=$[F],ne=Z.data,X=Z.data.byteLength;R.setUint32(f,X),f+=4,T.set(ne,f),f+=X,V+=4+X}let P;if(D<l-1)d=o[D+1].dts-z.dts,P=o[D+1].pts-z.pts;else{const F=this.config,k=D>0?z.dts-o[D-1].dts:I;if(P=D>0?z.pts-o[D-1].pts:I,F.stretchShortVideoTrack&&this.nextAudioTs!==null){const Z=Math.floor(F.maxBufferHole*s),ne=(n?p+n*s:this.nextAudioTs+u)-z.pts;ne>Z?(d=ne-k,d<0?d=k:w=!0,this.log(`It is approximately ${ne/90} ms to the next segment; using duration ${d/90} ms for the last video frame.`)):d=k}else d=k}const G=Math.round(z.pts-z.dts);B=Math.min(B,d),O=Math.max(O,d),M=Math.min(M,P),U=Math.max(U,P),a.push(o2(z.key,d,V,G))}if(a.length){if(Vo){if(Vo<70){const D=a[0].flags;D.dependsOn=2,D.isNonSync=0}}else if($d&&U-M<O-B&&I/O<.025&&a[0].cts===0){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let D=m;for(let z=0,$=a.length;z<$;z++){const V=D+a[z].duration,P=D+a[z].cts;if(z<$-1){const G=V+a[z+1].cts;a[z].duration=G-P}else a[z].duration=z?a[z-1].duration:I;a[z].cts=0,D=V}}}d=w||!d?I:d;const Y=A+d;this.nextVideoTs=h=Y-u,this.videoSampleDuration=d,this.isVideoContiguous=!0;const K={data1:ce.moof(e.sequenceNumber++,m,Yt(e,{samples:a})),data2:T,startPTS:(p-u)/s,endPTS:(y+d-u)/s,startDTS:(m-u)/s,endDTS:h/s,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,K}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return eD;case"ac3":return tD;default:return Z7}}remuxAudio(e,t,i,n,s){const o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,l=o/a,c=this.getSamplesPerFrame(e),u=c*l,h=this._initPTS,f=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,d=[],m=s!==void 0;let A=e.samples,p=f?0:8,y=this.nextAudioTs||-1;const v=h.baseTime*o/h.timescale,E=v+t*o;if(this.isAudioContiguous=i=i||A.length&&y>0&&(n&&Math.abs(E-(y+v))<9e3||Math.abs(Pn(A[0].pts,E)-(y+v))<20*u),A.forEach(function(U){U.pts=Pn(U.pts,E)}),!i||y<0){const U=A.length;if(A=A.filter(Y=>Y.pts>=0),U!==A.length&&this.warn(`Removed ${A.length-U} of ${U} samples (initPTS ${v} / ${o})`),!A.length)return;s===0?y=0:n&&!m?y=Math.max(0,E-v):y=A[0].pts-v}if(e.segmentCodec==="aac"){const U=this.config.maxAudioFramesDrift;for(let Y=0,W=y+v;Y<A.length;Y++){const N=A[Y],K=N.pts,D=K-W,z=Math.abs(1e3*D/o);if(D<=-U*u&&m)Y===0&&(this.warn(`Audio frame @ ${(K/o).toFixed(3)}s overlaps marker by ${Math.round(1e3*D/o)} ms.`),this.nextAudioTs=y=K-v,W=K);else if(D>=U*u&&z<J7&&m){let $=Math.round(D/u);for(W=K-$*u;W<0&&$&&u;)$--,W+=u;Y===0&&(this.nextAudioTs=y=W-v),this.warn(`Injecting ${$} audio frames @ ${((W-v)/o).toFixed(3)}s due to ${Math.round(1e3*D/o)} ms gap.`);for(let V=0;V<$;V++){let P=j7.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);P||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),P=N.unit.subarray()),A.splice(Y,0,{unit:P,pts:W}),W+=u,Y++}}N.pts=W,W+=u}}let x=null,I=null,C,_=0,S=A.length;for(;S--;)_+=A[S].unit.byteLength;for(let U=0,Y=A.length;U<Y;U++){const W=A[U],N=W.unit;let K=W.pts;if(I!==null){const z=d[U-1];z.duration=Math.round((K-I)/l)}else if(i&&e.segmentCodec==="aac"&&(K=y+v),x=K,_>0){_+=p;try{C=new Uint8Array(_)}catch(z){this.observer.emit(L.ERROR,L.ERROR,{type:Je.MUX_ERROR,details:ue.REMUX_ALLOC_ERROR,fatal:!1,error:z,bytes:_,reason:`fail allocating audio mdat ${_}`});return}f||(new DataView(C.buffer).setUint32(0,_),C.set(ce.types.mdat,4))}else return;C.set(N,p);const D=N.byteLength;p+=D,d.push(o2(!0,c,D,0)),I=K}const b=d.length;if(!b)return;const T=d[d.length-1];y=I-v,this.nextAudioTs=y+l*T.duration;const R=f?new Uint8Array(0):ce.moof(e.sequenceNumber++,x/l,Yt({},e,{samples:d}));e.samples=[];const w=(x-v)/o,B=y/o,O={data1:R,data2:C,startPTS:w,endPTS:B,startDTS:w,endDTS:B,type:"audio",hasAudio:!0,hasVideo:!1,nb:b};return this.isAudioContiguous=!0,O}}function Pn(r,e){let t;if(e===null)return r;for(e<r?t=-8589934592:t=8589934592;Math.abs(r-e)>4294967296;)r+=t;return r}function iD(r){for(let e=0;e<r.length;e++)if(r[e].key)return e;return-1}function HI(r,e,t,i){const n=r.samples.length;if(!n)return;const s=r.inputTimeScale;for(let a=0;a<n;a++){const l=r.samples[a];l.pts=Pn(l.pts-t.baseTime*s/t.timescale,e*s)/s,l.dts=Pn(l.dts-i.baseTime*s/i.timescale,e*s)/s}const o=r.samples;return r.samples=[],{samples:o}}function VI(r,e,t){const i=r.samples.length;if(!i)return;const n=r.inputTimeScale;for(let o=0;o<i;o++){const a=r.samples[o];a.pts=Pn(a.pts-t.baseTime*n/t.timescale,e*n)/n}r.samples.sort((o,a)=>o.pts-a.pts);const s=r.samples;return r.samples=[],{samples:s}}class nD extends as{constructor(e,t,i,n){super("passthrough-remuxer",n),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,i,n){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(e,n),this.emitInitSegment=!0}generateInitSegment(e,t){let{audioCodec:i,videoCodec:n}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const{audio:s,video:o}=this.initData=jx(e);if(t)Y9(e,t);else{const l=s||o;l!=null&&l.encrypted&&this.warn(`Init segment with encrypted track with has no key ("${l.codec}")!`)}s&&(i=a2(s,qt.AUDIO,this)),o&&(n=a2(o,qt.VIDEO,this));const a={};s&&o?a.audiovideo={container:"video/mp4",codec:i+","+n,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:s?a.audio={container:"audio/mp4",codec:i,encrypted:s.encrypted,initSegment:e,id:"audio"}:o?a.video={container:"video/mp4",codec:n,supplemental:o.supplemental,encrypted:o.encrypted,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=a}remux(e,t,i,n,s,o){var a,l;let{initPTS:c,lastEndTime:u}=this;const h={audio:void 0,video:void 0,text:n,id3:i,initSegment:void 0};He(u)||(u=this.lastEndTime=s||0);const f=t.samples;if(!f.length)return h;const d={initPTS:void 0,timescale:void 0,trackId:void 0};let m=this.initData;if((a=m)!=null&&a.length||(this.generateInitSegment(f),m=this.initData),!((l=m)!=null&&l.length))return this.warn("Failed to generate initSegment."),h;this.emitInitSegment&&(d.tracks=this.initTracks,this.emitInitSegment=!1);const A=j9(f,m,this),p=m.audio?A[m.audio.id]:null,y=m.video?A[m.video.id]:null,v=yu(y,1/0),E=yu(p,1/0),x=yu(y,0,!0),I=yu(p,0,!0);let C=s,_=0;const S=p&&(!y||!c&&E<v||c&&c.trackId===m.audio.id),b=S?p:y;if(b){const W=b.timescale,N=b.start-s*W,K=S?m.audio.id:m.video.id;C=b.start/W,_=S?I-E:x-v,(o||!c)&&(sD(c,C,s,_)||W!==c.timescale)&&(c&&this.warn(`Timestamps at playlist time: ${o?"":"~"}${s} ${N/W} != initPTS: ${c.baseTime/c.timescale} (${c.baseTime}/${c.timescale}) trackId: ${c.trackId}`),this.log(`Found initPTS at playlist time: ${s} offset: ${C-s} (${N}/${W}) trackId: ${K}`),c=null,d.initPTS=N,d.timescale=W,d.trackId=K)}else this.warn(`No audio or video samples found for initPTS at playlist time: ${s}`);c?(d.initPTS=c.baseTime,d.timescale=c.timescale,d.trackId=c.trackId):((!d.timescale||d.trackId===void 0||d.initPTS===void 0)&&(this.warn("Could not set initPTS"),d.initPTS=C,d.timescale=1,d.trackId=-1),this.initPTS=c={baseTime:d.initPTS,timescale:d.timescale,trackId:d.trackId});const T=C-c.baseTime/c.timescale,R=T+_;_>0?this.lastEndTime=R:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const w=!!m.audio,B=!!m.video;let M="";w&&(M+="audio"),B&&(M+="video");const O=(m.audio?m.audio.encrypted:!1)||(m.video?m.video.encrypted:!1),U={data1:f,startPTS:T,startDTS:T,endPTS:R,endDTS:R,type:M,hasAudio:w,hasVideo:B,nb:1,dropped:0,encrypted:O};h.audio=w&&!B?U:void 0,h.video=B?U:void 0;const Y=y?.sampleCount;if(Y){const W=y.keyFrameIndex,N=W!==-1;U.nb=Y,U.dropped=W===0||this.isVideoContiguous?0:N?W:Y,U.independent=N,U.firstKeyFrame=W,N&&y.keyFrameStart&&(U.firstKeyFramePTS=(y.keyFrameStart-c.baseTime)/c.timescale),this.isVideoContiguous||(h.independent=N),this.isVideoContiguous||(this.isVideoContiguous=N),U.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${W}/${Y} dropped: ${U.dropped} start: ${U.firstKeyFramePTS||"NA"}`)}return h.initSegment=d,h.id3=HI(i,s,c,c),n.samples.length&&(h.text=VI(n,s,c)),h}}function yu(r,e,t=!1){return r?.start!==void 0?(r.start+(t?r.duration:0))/r.timescale:e}function sD(r,e,t,i){if(r===null)return!0;const n=Math.max(i,1),s=e-r.baseTime/r.timescale;return Math.abs(s-t)>n}function a2(r,e,t){const i=r.codec;return i&&i.length>4?i:e===qt.AUDIO?i==="ec-3"||i==="ac-3"||i==="alac"?i:i==="fLaC"||i==="Opus"?Ph(i,!1):(t.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(t.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}let hr;try{hr=self.performance.now.bind(self.performance)}catch{hr=Date.now}const hh=[{demux:H7,remux:nD},{demux:Pr,remux:uh},{demux:N7,remux:uh},{demux:Q7,remux:uh}];hh.splice(2,0,{demux:G7,remux:uh});class l2{constructor(e,t,i,n,s,o){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.id=s,this.logger=o}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,n){const s=i.transmuxing;s.executeStart=hr();let o=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:l}=this;n&&(this.currentTransmuxState=n);const{contiguous:c,discontinuity:u,trackSwitch:h,accurateTimeOffset:f,timeOffset:d,initSegmentChange:m}=n||a,{audioCodec:A,videoCodec:p,defaultInitPts:y,duration:v,initSegmentData:E}=l,x=rD(o,t);if(x&&Sa(x.method)){const S=this.getDecrypter(),b=YA(x.method);if(S.isSync()){let T=S.softwareDecrypt(o,x.key.buffer,x.iv.buffer,b);if(i.part>-1){const w=S.flush();T=w&&w.buffer}if(!T)return s.executeEnd=hr(),Yd(i);o=new Uint8Array(T)}else return this.asyncResult=!0,this.decryptionPromise=S.webCryptoDecrypt(o,x.key.buffer,x.iv.buffer,b).then(T=>{const R=this.push(T,null,i);return this.decryptionPromise=null,R}),this.decryptionPromise}const I=this.needsProbing(u,h);if(I){const S=this.configureTransmuxer(o);if(S)return this.logger.warn(`[transmuxer] ${S.message}`),this.observer.emit(L.ERROR,L.ERROR,{type:Je.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,fatal:!1,error:S,reason:S.message}),s.executeEnd=hr(),Yd(i)}(u||h||m||I)&&this.resetInitSegment(E,A,p,v,t),(u||m||I)&&this.resetInitialTimestamp(y),c||this.resetContiguity();const C=this.transmux(o,x,d,f,i);this.asyncResult=Ec(C);const _=this.currentTransmuxState;return _.contiguous=!0,_.discontinuity=!1,_.trackSwitch=!1,s.executeEnd=hr(),C}flush(e){const t=e.transmuxing;t.executeStart=hr();const{decrypter:i,currentTransmuxState:n,decryptionPromise:s}=this;if(s)return this.asyncResult=!0,s.then(()=>this.flush(e));const o=[],{timeOffset:a}=n;if(i){const h=i.flush();h&&o.push(this.push(h.buffer,null,e))}const{demuxer:l,remuxer:c}=this;if(!l||!c){t.executeEnd=hr();const h=[Yd(e)];return this.asyncResult?Promise.resolve(h):h}const u=l.flush(a);return Ec(u)?(this.asyncResult=!0,u.then(h=>(this.flushRemux(o,h,e),o))):(this.flushRemux(o,u,e),this.asyncResult?Promise.resolve(o):o)}flushRemux(e,t,i){const{audioTrack:n,videoTrack:s,id3Track:o,textTrack:a}=t,{accurateTimeOffset:l,timeOffset:c}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${i.sn}${i.part>-1?" part: "+i.part:""} of ${this.id===$e.MAIN?"level":"track"} ${i.level}`);const u=this.remuxer.remux(n,s,o,a,c,l,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=hr()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,n,s){const{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,n),a.resetInitSegment(e,t,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,n,s){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,n,s):o=this.transmuxUnencrypted(e,i,n,s),o}transmuxUnencrypted(e,t,i,n){const{audioTrack:s,videoTrack:o,id3Track:a,textTrack:l}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,o,a,l,t,i,!1,this.id),chunkMeta:n}}transmuxSampleAes(e,t,i,n,s){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,n,!1,this.id),chunkMeta:s}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:n}=this;let s;for(let h=0,f=hh.length;h<f;h++){var o;if((o=hh[h].demux)!=null&&o.probe(e,this.logger)){s=hh[h];break}}if(!s)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,l=this.remuxer,c=s.remux,u=s.demux;(!l||!(l instanceof c))&&(this.remuxer=new c(i,t,n,this.logger)),(!a||!(a instanceof u))&&(this.demuxer=new u(i,t,n,this.logger),this.probe=u.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new KA(this.config)),e}}function rD(r,e){let t=null;return r.byteLength>0&&e?.key!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Yd=r=>({remuxResult:{},chunkMeta:r});function Ec(r){return"then"in r&&r.then instanceof Function}class oD{constructor(e,t,i,n,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=n,this.defaultInitPts=s||null}}class aD{constructor(e,t,i,n,s,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=s,this.initSegmentChange=o}}let c2=0;class KI{constructor(e,t,i,n){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=c2++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=l=>{const c=l.data,u=this.hls;if(!(!u||!(c!=null&&c.event)||c.instanceNo!==this.instanceNo))switch(c.event){case"init":{var h;const f=(h=this.workerContext)==null?void 0:h.objectURL;f&&self.URL.revokeObjectURL(f);break}case"transmuxComplete":{this.handleTransmuxComplete(c.data);break}case"flush":{this.onFlush(c.data);break}case"workerLog":{u.logger[c.data.logType]&&u.logger[c.data.logType](c.data.message);break}default:{c.data=c.data||{},c.data.frag=this.frag,c.data.part=this.part,c.data.id=this.id,u.trigger(c.event,c.data);break}}},this.onWorkerError=l=>{if(!this.hls)return;const c=new Error(`${l.message}  (${l.filename}:${l.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:c})};const s=e.config;this.hls=e,this.id=t,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=n;const o=(l,c)=>{c=c||{},c.frag=this.frag||void 0,l===L.ERROR&&(c=c,c.parent=this.id,c.part=this.part,this.error=c.error),this.hls.trigger(l,c)};this.observer=new qA,this.observer.on(L.FRAG_DECRYPTED,o),this.observer.on(L.ERROR,o);const a=Sy(s.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){const l=this.hls.logger;if(s.workerPath||h7()){try{s.workerPath?(l.log(`loading Web Worker ${s.workerPath} for "${t}"`),this.workerContext=d7(s.workerPath)):(l.log(`injecting Web Worker for "${t}"`),this.workerContext=f7());const{worker:u}=this.workerContext;u.addEventListener("message",this.onWorkerMessage),u.addEventListener("error",this.onWorkerError),u.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:a,id:t,config:Xt(s)})}catch(u){l.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.terminateWorker(),this.error=null,this.transmuxer=new l2(this.observer,a,s,"",t,e.logger)}return}}this.transmuxer=new l2(this.observer,a,s,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=c2++;const t=this.hls.config,i=Sy(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:i,id:this.id,config:Xt(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),m7(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,i,n,s,o,a,l,c,u){var h,f;c.transmuxing.start=self.performance.now();const{instanceNo:d,transmuxer:m}=this,A=o?o.start:s.start,p=s.decryptdata,y=this.frag,v=!(y&&s.cc===y.cc),E=!(y&&c.level===y.level),x=y?c.sn-y.sn:-1,I=this.part?c.part-this.part.index:-1,C=x===0&&c.id>1&&c.id===y?.stats.chunkCount,_=!E&&(x===1||x===0&&(I===1||C&&I<=0)),S=self.performance.now();(E||x||s.stats.parsing.start===0)&&(s.stats.parsing.start=S),o&&(I||!_)&&(o.stats.parsing.start=S);const b=!(y&&((h=s.initSegment)==null?void 0:h.url)===((f=y.initSegment)==null?void 0:f.url)),T=new aD(v,_,l,E,A,b);if(!_||v||b){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${s.type} sn: ${c.sn}${c.part>-1?" part: "+c.part:""} ${this.id===$e.MAIN?"level":"track"}: ${c.level} id: ${c.id}
        discontinuity: ${v}
        trackSwitch: ${E}
        contiguous: ${_}
        accurateTimeOffset: ${l}
        timeOffset: ${A}
        initSegmentChange: ${b}`);const R=new oD(i,n,t,a,u);this.configureTransmuxer(R)}if(this.frag=s,this.part=o,this.workerContext)this.workerContext.worker.postMessage({instanceNo:d,cmd:"demux",data:e,decryptdata:p,chunkMeta:c,state:T},e instanceof ArrayBuffer?[e]:[]);else if(m){const R=m.push(e,p,c,T);Ec(R)?R.then(w=>{this.handleTransmuxComplete(w)}).catch(w=>{this.transmuxerError(w,c,"transmuxer-interface push error")}):this.handleTransmuxComplete(R)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:i}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(i){const n=i.flush(e);Ec(n)?n.then(s=>{this.handleFlushResult(s,e)}).catch(s=>{this.transmuxerError(s,e,"transmuxer-interface flush error")}):this.handleFlushResult(n,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:i}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):i&&i.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}const u2=100;class $I extends gf{constructor(e,t,i){super(e,t,i,"audio-stream-controller",$e.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(L.BUFFER_RESET,this.onBufferReset,this),e.on(L.BUFFER_CREATED,this.onBufferCreated,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(L.FRAG_LOADING,this.onFragLoading,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(L.BUFFER_RESET,this.onBufferReset,this),e.off(L.BUFFER_CREATED,this.onBufferCreated,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(L.FRAG_LOADING,this.onFragLoading,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s,trackId:o}){if(i===$e.MAIN){const a=t.cc,l=this.fragCurrent;if(this.initPTS[a]={baseTime:n,timescale:s,trackId:o},this.log(`InitPTS for cc: ${a} found from main: ${n/s} (${n}/${s}) trackId: ${o}`),this.mainAnchor=t,this.state===Te.WAITING_INIT_PTS){const c=this.waitingData;(!c&&!this.loadingParts||c&&c.frag.cc!==a)&&this.syncWithAnchor(t,c?.frag)}else!this.hls.hasEnoughToStart&&l&&l.cc!==a?(l.abortRequests(),this.syncWithAnchor(t,l)):this.state===Te.IDLE&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var i;const n=((i=this.mainFragLoading)==null?void 0:i.frag)||null;if(t&&n?.cc===t.cc)return;const s=(n||e).cc,o=this.getLevelDetails(),a=this.getLoadPosition(),l=aI(o,s,a);l&&(this.log(`Syncing with main frag at ${l.start} cc ${l.cc}`),this.startFragRequested=!1,this.nextLoadPosition=l.start,this.resetLoadingState(),this.state===Te.IDLE&&this.doTickIdle())}startLoad(e,t){if(!this.levels){this.startPosition=e,this.state=Te.STOPPED;return}const i=this.lastCurrentTime;this.stopLoad(),this.setInterval(u2),i>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i,this.state=Te.IDLE):this.state=Te.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case Te.IDLE:this.doTickIdle();break;case Te.WAITING_TRACK:{const{levels:e,trackId:t}=this,i=e?.[t],n=i?.details;if(n&&!this.waitForLive(i)){if(this.waitForCdnTuneIn(n))break;this.state=Te.WAITING_INIT_PTS}break}case Te.FRAG_LOADING_WAITING_RETRY:{this.checkRetryDate();break}case Te.WAITING_INIT_PTS:{const e=this.waitingData;if(e){const{frag:t,part:i,cache:n,complete:s}=e,o=this.mainAnchor;if(this.initPTS[t.cc]!==void 0){this.waitingData=null,this.state=Te.FRAG_LOADING;const a=n.flush().buffer,l={frag:t,part:i,payload:a,networkDetails:null};this._handleFragmentLoadProgress(l),s&&super._handleFragmentLoadComplete(l)}else o&&o.cc!==e.frag.cc&&this.syncWithAnchor(o,e.frag)}else this.state=Te.IDLE}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:i,media:n,trackId:s}=this,o=t.config;if(!this.buffering||!n&&!this.primaryPrefetch&&(this.startFragRequested||!o.startFragPrefetch)||!(i!=null&&i[s]))return;const a=i[s],l=a.details;if(!l||this.waitForLive(a)||this.waitForCdnTuneIn(l)){this.state=Te.WAITING_TRACK,this.startFragRequested=!1;return}const c=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&c&&(this.bufferFlushed=!1,this.afterBufferFlushed(c,qt.AUDIO,$e.AUDIO));const u=this.getFwdBufferInfo(c,$e.AUDIO);if(u===null)return;if(!this.switchingTrack&&this._streamEnded(u,l)){t.trigger(L.BUFFER_EOS,{type:"audio"}),this.state=Te.ENDED;return}const h=u.len,f=t.maxBufferLength,d=l.fragments,m=d[0].start,A=this.getLoadPosition(),p=this.flushing?A:u.end;if(this.switchingTrack&&n){const E=A;l.PTSKnown&&E<m&&(u.end>m||u.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),n.currentTime=m+.05)}if(h>=f&&!this.switchingTrack&&p<d[d.length-1].start)return;let y=this.getNextFragment(p,l);if(y&&this.isLoopLoading(y,p)&&(y=this.getNextFragmentLoopLoading(y,l,u,$e.MAIN,f)),!y){this.bufferFlushed=!0;return}let v=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&v&&Ri(y)&&!y.endList&&(!l.live||!this.loadingParts&&p<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(v)===Ni.OK&&(this.mainFragLoading=v=null),v&&Ri(v))){if(y.start>v.end){const x=this.fragmentTracker.getFragAtPos(p,$e.MAIN);x&&x.end>v.end&&(v=x,this.mainFragLoading={frag:x,targetBufferTime:null})}if(y.start>v.end)return}this.loadFragment(y,a,p)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new Fa(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:n}=this;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==Te.STOPPED&&(this.setInterval(u2),this.state=Te.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(L.AUDIO_TRACK_LOADED,i))}onAudioTrackLoaded(e,t){var i;const{levels:n}=this,{details:s,id:o,groupId:a,track:l}=t;if(!n){this.warn(`Audio tracks reset while loading track ${o} "${l.name}" of "${a}"`);return}const c=this.mainDetails;if(!c||s.endCC>c.endCC||c.expired){this.cachedTrackLoadedData=t,this.state!==Te.STOPPED&&(this.state=Te.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log(`Audio track ${o} "${l.name}" of "${a}" loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const u=n[o];let h=0;if(s.live||(i=u.details)!=null&&i.live){if(this.checkLiveUpdate(s),s.deltaUpdateFailed)return;if(u.details){var f;h=this.alignPlaylists(s,u.details,(f=this.levelLastLoaded)==null?void 0:f.details)}s.alignedSliding||(SI(s,c),s.alignedSliding||Qh(s,c),h=s.fragmentStart)}u.details=s,this.levelLastLoaded=u,this.startFragRequested||this.setStartPosition(c,h),this.hls.trigger(L.AUDIO_TRACK_UPDATED,{details:s,id:o,groupId:t.groupId}),this.state===Te.WAITING_TRACK&&!this.waitForCdnTuneIn(s)&&(this.state=Te.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:s}=e,{config:o,trackId:a,levels:l}=this;if(!l){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const c=l[a];if(!c){this.warn("Audio track is undefined on fragment load progress");return}const u=c.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const h=o.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new KI(this.hls,$e.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const d=this.initPTS[i.cc],m=(t=i.initSegment)==null?void 0:t.data;if(d!==void 0){const p=n?n.index:-1,y=p!==-1,v=new pf(i.level,i.sn,i.stats.chunkCount,s.byteLength,p,y);f.push(s,m,h,"",i,n,u.totalduration,!1,v,d)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${a}`);const{cache:A}=this.waitingData=this.waitingData||{frag:i,part:n,cache:new TI,complete:!1};A.push(new Uint8Array(s)),this.state!==Te.STOPPED&&(this.state=Te.WAITING_INIT_PTS)}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===$e.MAIN&&Ri(t.frag)&&(this.mainFragLoading=t,this.state===Te.IDLE&&this.tick())}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i.type!==$e.AUDIO){!this.audioOnly&&i.type===$e.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(Ri(i)){this.fragPrevious=i;const s=this.switchingTrack;s&&(this.bufferedTrack=s,this.switchingTrack=null,this.hls.trigger(L.AUDIO_TRACK_SWITCHED,Ht({},s)))}this.fragBufferedComplete(i,n),this.media&&this.tick()}onError(e,t){var i;if(t.fatal){this.state=Te.ERROR;return}switch(t.details){case ue.FRAG_GAP:case ue.FRAG_PARSING_ERROR:case ue.FRAG_DECRYPT_ERROR:case ue.FRAG_LOAD_ERROR:case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_ERROR:case ue.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError($e.AUDIO,t);break;case ue.AUDIO_TRACK_LOAD_ERROR:case ue.AUDIO_TRACK_LOAD_TIMEOUT:case ue.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===Te.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Ct.AUDIO_TRACK&&(this.state=Te.IDLE);break;case ue.BUFFER_ADD_CODEC_ERROR:case ue.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case ue.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case ue.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==qt.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==qt.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===Te.ENDED&&(this.state=Te.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,$e.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:n}=this,{remuxResult:s,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:l,part:c,level:u}=a,{details:h}=u,{audio:f,text:d,id3:m,initSegment:A}=s;if(this.fragContextChanged(l)||!h){this.fragmentTracker.removeFragment(l);return}if(this.state=Te.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),A!=null&&A.tracks){const p=l.initSegment||l;if(this.unhandledEncryptionError(A,l))return;this._bufferInitSegment(u,A.tracks,p,o),n.trigger(L.FRAG_PARSING_INIT_SEGMENT,{frag:p,id:i,tracks:A.tracks})}if(f){const{startPTS:p,endPTS:y,startDTS:v,endDTS:E}=f;c&&(c.elementaryStreams[qt.AUDIO]={startPTS:p,endPTS:y,startDTS:v,endDTS:E}),l.setElementaryStreamInfo(qt.AUDIO,p,y,v,E),this.bufferFragmentData(f,l,c,o)}if(m!=null&&(t=m.samples)!=null&&t.length){const p=Yt({id:i,frag:l,details:h},m);n.trigger(L.FRAG_PARSING_METADATA,p)}if(d){const p=Yt({id:i,frag:l,details:h},d);n.trigger(L.FRAG_PARSING_USERDATA,p)}}_bufferInitSegment(e,t,i,n){if(this.state!==Te.PARSING||(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio))return;const s=t.audio;s.id=$e.AUDIO;const o=e.audioCodec;this.log(`Init audio buffer, container:${s.container}, codecs[level/parsed]=[${o}/${s.codec}]`),o&&o.split(",").length===1&&(s.levelCodec=o),this.hls.trigger(L.BUFFER_CODECS,t);const a=s.initSegment;if(a!=null&&a.byteLength){const l={type:"audio",frag:i,part:null,chunkMeta:n,parent:i.type,data:a};this.hls.trigger(L.BUFFER_APPENDING,l)}this.tickImmediate()}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);if(this.switchingTrack||n===Ni.NOT_LOADED||n===Ni.PARTIAL){var s;if(!Ri(e))this._loadInitSegment(e,t);else if((s=t.details)!=null&&s.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=Te.WAITING_INIT_PTS;const o=this.mainDetails;o&&o.fragmentStart!==t.details.fragmentStart&&Qh(t.details,o)}else super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:i,assocLang:n,characteristics:s,audioCodec:o,channels:a}=this.bufferedTrack;Ao({name:t,lang:i,assocLang:n,characteristics:s,audioCodec:o,channels:a},e,oo)||(kh(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(L.AUDIO_TRACK_SWITCHED,Ht({},e))}}class vf extends as{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const n=t?.renditionReports;if(n){let s=-1;for(let o=0;o<n.length;o++){const a=n[o];let l;try{l=new self.URL(a.URI,t.url).href}catch(c){this.warn(`Could not construct new URL for Rendition Report: ${c}`),l=a.URI||""}if(l===e){s=o;break}else l===e.substring(0,l.length)&&(s=o)}if(s!==-1){const o=n[s],a=parseInt(o["LAST-MSN"])||t.lastPartSn;let l=parseInt(o["LAST-PART"])||t.lastPartIndex;if(this.hls.config.lowLatencyMode){const u=Math.min(t.age-t.partTarget,t.targetduration);l>=0&&u>t.partTarget&&(l+=1)}const c=i&&Ty(i);return new bm(a,l>=0?l:void 0,c)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn(`Could not construct new URL with HLS Delivery Directives: ${i}`)}return e}playlistLoaded(e,t,i){const{details:n,stats:s}=t,o=self.performance.now(),a=s.loading.first?Math.max(0,o-s.loading.first):0;n.advancedDateTime=Date.now()-a;const l=this.hls.config.timelineOffset;if(l!==n.appliedTimelineOffset){const u=Math.max(l||0,0);n.appliedTimelineOffset=u,n.fragments.forEach(h=>{h.setStart(h.playlistOffset+u)})}if(n.live||i!=null&&i.live){const u="levelInfo"in t?t.levelInfo:t.track;if(n.reloaded(i),i&&n.fragments.length>0){e7(i,n,this);const v=n.playlistParsingError;if(v){this.warn(v);const E=this.hls;if(!E.config.ignorePlaylistParsingErrors){var c;const{networkDetails:x}=t;E.trigger(L.ERROR,{type:Je.NETWORK_ERROR,details:ue.LEVEL_PARSING_ERROR,fatal:!1,url:n.url,error:v,reason:v.message,level:t.level||void 0,parent:(c=n.fragments[0])==null?void 0:c.type,networkDetails:x,stats:s});return}n.playlistParsingError=null}}n.requestScheduled===-1&&(n.requestScheduled=s.loading.start);const h=this.hls.mainForwardBufferInfo,f=h?h.end-h.len:0,d=(n.edge-f)*1e3,m=EI(n,d);if(n.requestScheduled+m<o?n.requestScheduled=o:n.requestScheduled+=m,this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),!this.canLoad||!n.live)return;let A,p,y;if(n.canBlockReload&&n.endSN&&n.advanced){const v=this.hls.config.lowLatencyMode,E=n.lastPartSn,x=n.endSN,I=n.lastPartIndex,C=I!==-1,_=E===x;C?_?(p=x+1,y=v?0:I):(p=E,y=v?I+1:n.maxPartIndex):p=x+1;const S=n.age,b=S+n.ageHeader;let T=Math.min(b-n.partTarget,n.targetduration*1.5);if(T>0){if(b>n.targetduration*3)this.log(`Playlist last advanced ${S.toFixed(2)}s ago. Omitting segment and part directives.`),p=void 0,y=void 0;else if(i!=null&&i.tuneInGoal&&b-n.partTarget>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${T} with playlist age: ${n.age}`),T=0;else{const R=Math.floor(T/n.targetduration);if(p+=R,y!==void 0){const w=Math.round(T%n.targetduration/n.partTarget);y+=w}this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${S.toFixed(2)}s goal: ${T} skip sn ${R} to part ${y}`)}n.tuneInGoal=T}if(A=this.getDeliveryDirectives(n,t.deliveryDirectives,p,y),v||!_){n.requestScheduled=o,this.loadingPlaylist(u,A);return}}else(n.canBlockReload||n.canSkipUntil)&&(A=this.getDeliveryDirectives(n,t.deliveryDirectives,p,y));A&&p!==void 0&&n.canBlockReload&&(n.requestScheduled=s.loading.first+Math.max(m-a*2,m/2)),this.scheduleLoading(u,A,n)}else this.clearTimer()}scheduleLoading(e,t,i){const n=i||e.details;if(!n){this.loadingPlaylist(e,t);return}const s=self.performance.now(),o=n.requestScheduled;if(s>=o){this.loadingPlaylist(e,t);return}const a=o-s;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,i,n){let s=Ty(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,n=t.part,s=ec.No),new bm(i,n,s)}checkRetry(e){const t=e.details,i=Oh(e),n=e.errorAction,{action:s,retryCount:o=0,retryConfig:a}=n||{},l=!!n&&!!a&&(s===Ui.RetryRequest||!n.resolved&&s===Ui.SendAlternateToPenaltyBox);if(l){var c;if(o>=a.maxNumRetry)return!1;if(i&&(c=e.context)!=null&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=VA(a,o);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,n.resolved=!0}return l}}function YI(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(!xc(r[t].attrs,e[t].attrs))return!1;return!0}function xc(r,e,t){const i=r["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(n=>r[n]!==e[n])}function Fm(r,e){return e.label.toLowerCase()===r.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(r.lang||"").toLowerCase())}class WI extends vf{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVEL_LOADING,this.onLevelLoading,this),e.off(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(L.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(L.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Audio track with id:${i} and group:${n} not found in active group ${o?.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||n?.length!==i?.length||i!=null&&i.some(a=>n?.indexOf(a)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(f=>f.default)&&(this.selectDefaultTrack=!1),a.forEach((f,d)=>{f.id=d});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const l=this.hls.config.audioPreference;if(!s&&l){const f=Ks(l,a,oo);if(f>-1)s=a[f];else{const d=Ks(l,this.tracks);s=this.tracks[d]}}let c=this.findTrackId(s);c===-1&&s&&(c=this.findTrackId(null));const u={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i?.join(",")}`),this.hls.trigger(L.AUDIO_TRACKS_UPDATED,u);const h=this.trackId;if(c!==-1&&h===-1)this.setAudioTrack(c);else if(a.length&&h===-1){var o;const f=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(f.message),this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}}onError(e,t){t.fatal||!t.context||t.context.type===Ct.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const n=this.currentTrack;if(n&&Ao(e,n,oo))return n;const s=Ks(e,this.tracksInGroup,oo);if(s>-1){const o=this.tracksInGroup[s];return this.setAudioTrack(s),o}else if(n){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);const a=_R(e,t.levels,i,o,oo);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const o=Ks(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e],s=n.details&&!n.details.live;if(e===this.trackId&&n===i&&s||(this.log(`Switching to audio-track ${e} "${n.name}" lang:${n.lang} group:${n.groupId} channels:${n.channels}`),this.trackId=e,this.currentTrack=n,this.hls.trigger(L.AUDIO_TRACK_SWITCHING,Ht({},n)),s))return;const o=this.switchParams(n.url,i?.details,n.details);this.loadPlaylist(o)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(!(this.selectDefaultTrack&&!n.default)&&(!e||Ao(e,n,oo)))return i}if(e){const{name:i,lang:n,assocLang:s,characteristics:o,audioCodec:a,channels:l}=e;for(let c=0;c<t.length;c++){const u=t[c];if(Ao({name:i,lang:n,assocLang:s,characteristics:o,audioCodec:a,channels:l},u,oo))return c}for(let c=0;c<t.length;c++){const u=t[c];if(xc(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return c}for(let c=0;c<t.length;c++){const u=t[c];if(xc(e.attrs,u.attrs,["LANGUAGE"]))return c}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&kh(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,s=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading audio-track ${i} "${e.name}" lang:${e.lang} group:${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${s}`),this.hls.trigger(L.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:t||null,track:e})}}class lD{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,i){if(this.queues===null||this.tracks===null)return;const n=this.queues[t];n.push(e),n.length===1&&!i&&this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const i={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(i,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const i={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(i)}})}removeBlockers(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const i=(t=e[0])==null?void 0:t.label;(i==="async-blocker"||i==="async-blocker-prepend")&&(e[0].execute(),e.splice(0,1))})}unblockAudio(e){if(this.queues===null)return;this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(this.queues===null||this.tracks===null)return;const t=this.queues[e];if(t.length){const n=t[0];try{n.execute()}catch(s){var i;if(n.onError(s),this.queues===null||this.tracks===null)return;const o=(i=this.tracks[e])==null?void 0:i.buffer;o!=null&&o.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues!==null&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return((t=this.queues)==null?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return e===null||t===null?"<destroyed>":`
${this.list("video")}
${this.list("audio")}
${this.list("audiovideo")}}`}list(e){var t,i;return(t=this.queues)!=null&&t[e]||(i=this.tracks)!=null&&i[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const i=(t=this.tracks)==null?void 0:t[e],n=i?.buffer;return n?`SourceBuffer${n.updating?" updating":""}${i.ended?" ended":""}${i.ending?" ending":""}`:"none"}listOps(e){var t;return((t=this.queues)==null?void 0:t[e].map(i=>i.label).join(", "))||""}}const h2=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,jI="HlsJsTrackRemovedError";class cD extends Error{constructor(e){super(e),this.name=jI}}class qI extends as{constructor(e,t){super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=i=>{var n;this.hls&&((n=this.mediaSource)==null?void 0:n.readyState)==="open"&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=i=>{const{media:n,mediaSource:s}=this;i&&this.log("Media source opened"),!(!n||!s)&&(s.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(L.MEDIA_ATTACHED,{media:n,mediaSource:s}),this.mediaSource!==null&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:n}=this;i!==n&&this.error(`Media element src was set while attaching MediaSource (${n} > ${i})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=U9(yr(e.config.preferManagedMediaSource)),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.BUFFER_RESET,this.onBufferReset,this),e.on(L.BUFFER_APPENDING,this.onBufferAppending,this),e.on(L.BUFFER_CODECS,this.onBufferCodecs,this),e.on(L.BUFFER_EOS,this.onBufferEos,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.FRAG_PARSED,this.onFragParsed,this),e.on(L.FRAG_CHANGED,this.onFragChanged,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.BUFFER_RESET,this.onBufferReset,this),e.off(L.BUFFER_APPENDING,this.onBufferAppending,this),e.off(L.BUFFER_CODECS,this.onBufferCodecs,this),e.off(L.BUFFER_EOS,this.onBufferEos,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.FRAG_PARSED,this.onFragParsed,this),e.off(L.FRAG_CHANGED,this.onFragChanged,this),e.off(L.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const i={};if(this.operationQueue){const s=this.isUpdating();s||this.operationQueue.removeBlockers();const o=this.isQueued();(s||o)&&this.warn(`Transfering MediaSource with${o?" operations in queue":""}${s?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const n=this.transferData;return!this.sourceBufferCount&&n&&n.mediaSource===t?Yt(i,n.tracks):this.sourceBuffers.forEach(s=>{const[o]=s;o&&(i[o]=Yt({},this.tracks[o]),this.removeBuffer(o)),s[0]=s[1]=null}),{media:e,mediaSource:t,tracks:i}}initTracks(){const e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var i;let n=2;(t.audio&&!t.video||!t.altAudio)&&(n=1),this.bufferCodecEventsTotal=n,this.log(`${n} bufferCodec event(s) expected.`),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&n&&this.bufferCreated()}onMediaAttaching(e,t){const i=this.media=t.media;this.transferData=this.overrides=void 0;const n=yr(this.appendSource);if(n){const s=!!t.mediaSource;(s||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const o=this.mediaSource=t.mediaSource||new n;if(this.assignMediaSource(o),s)this._objectUrl=i.src,this.attachTransferred();else{const a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");const l=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||l&&o instanceof l,f2(i),uD(i,a),i.load()}catch{i.src=a}else i.src=a}i.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,i;this.log(`${((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${(i=e.constructor)==null?void 0:i.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const i=this.tracks,n=t.tracks,s=n?Object.keys(n):null,o=s?s.length:0,a=()=>{Promise.resolve().then(()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()})};if(n&&s&&o){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})
required tracks: ${Xt(i,(l,c)=>l==="initSegment"?void 0:c)};
transfer tracks: ${Xt(n,(l,c)=>l==="initSegment"?void 0:c)}}`),!zx(n,i)){t.mediaSource=null,t.tracks=void 0;const l=e.currentTime,c=this.details,u=Math.max(l,c?.fragments[0].start||0);if(u-l>1){this.log(`attachTransferred: waiting for playback to reach new tracks start time ${l} -> ${u}`);return}this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(n)}"->"${Object.keys(i)}") start time: ${u} currentTime: ${l}`),this.onMediaDetaching(L.MEDIA_DETACHING,{}),this.onMediaAttaching(L.MEDIA_ATTACHING,t),e.currentTime=u;return}this.transferData=void 0,s.forEach(l=>{const c=l,u=n[c];if(u){const h=u.buffer;if(h){const f=this.fragmentTracker,d=u.id;if(f.hasFragments(d)||f.hasParts(d)){const p=dt.getBuffered(h);f.detectEvictedFragments(c,p,d,null,!0)}const m=Wd(c),A=[c,h];this.sourceBuffers[m]=A,h.updating&&this.operationQueue&&this.operationQueue.prependBlocker(c),this.trackSourceBuffer(c,u)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}onMediaDetaching(e,t){const i=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:n,mediaSource:s,_objectUrl:o}=this;if(s){if(this.log(`media source ${i?"transferring":"detaching"}`),i)this.sourceBuffers.forEach(([a])=>{a&&this.removeBuffer(a)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const a=s.readyState==="open";try{const l=s.sourceBuffers;for(let c=l.length;c--;)a&&l[c].abort(),s.removeSourceBuffer(l[c]);a&&s.endOfStream()}catch(l){this.warn(`onMediaDetaching: ${l.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}s.removeEventListener("sourceopen",this._onMediaSourceOpen),s.removeEventListener("sourceended",this._onMediaSourceEnded),s.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(s.removeEventListener("startstreaming",this._onStartStreaming),s.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}n&&(n.removeEventListener("emptied",this._onMediaEmptied),i||(o&&self.URL.revokeObjectURL(o),this.mediaSrc===o?(n.removeAttribute("src"),this.appendSource&&f2(n),n.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(L.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var n;(n=this.mediaSource)!=null&&n.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(s){this.warn(`onBufferReset ${e}`,s)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[Wd(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new lD(this.tracks)}onBufferCodecs(e,t){var i;const n=this.tracks,s=Object.keys(t);this.log(`BUFFER_CODECS: "${s}" (current SB count ${this.sourceBufferCount})`);const o="audiovideo"in t&&(n.audio||n.video)||n.audiovideo&&("audio"in t||"video"in t),a=!o&&this.sourceBufferCount&&this.media&&s.some(l=>!n[l]);if(o||a){this.warn(`Unsupported transition between "${Object.keys(n)}" and "${s}" SourceBuffers`);return}s.forEach(l=>{var c,u;const h=t[l],{id:f,codec:d,levelCodec:m,container:A,metadata:p,supplemental:y}=h;let v=n[l];const E=(c=this.transferData)==null||(c=c.tracks)==null?void 0:c[l],x=E!=null&&E.buffer?E:v,I=x?.pendingCodec||x?.codec,C=x?.levelCodec;v||(v=n[l]={buffer:void 0,listeners:[],codec:d,supplemental:y,container:A,levelCodec:m,metadata:p,id:f});const _=lh(I,C),S=_?.replace(h2,"$1");let b=lh(d,m);const T=(u=b)==null?void 0:u.replace(h2,"$1");b&&_&&S!==T&&(l.slice(0,5)==="audio"&&(b=Ph(b,this.appendSource)),this.log(`switching codec ${I} to ${b}`),b!==(v.pendingCodec||v.codec)&&(v.pendingCodec=b),v.container=A,this.appendChangeType(l,A,b))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&(this.bufferCodecEventsTotal>1&&!this.tracks.video&&!t.video&&((i=t.audio)==null?void 0:i.id)==="main"&&(this.log("Main audio-only"),this.bufferCodecEventsTotal=1),this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const i=this.tracks[t];return e[t]={id:i.id,container:i.container,codec:i.codec,levelCodec:i.levelCodec},e},{})}appendChangeType(e,t,i){const n=`${t};codecs=${i}`,s={label:`change-type=${n}`,execute:()=>{const o=this.tracks[e];if(o){const a=o.buffer;a!=null&&a.changeType&&(this.log(`changing ${e} sourceBuffer type to ${n}`),a.changeType(n),o.codec=i,o.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:o=>{this.warn(`Failed to change ${e} SourceBuffer type`,o)}};this.append(s,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const i=e.start,n=i+e.duration*.05;if(((t=this.fragmentTracker.getAppendedFrag(i,$e.MAIN))==null?void 0:t.gap)===!0)return;const o={label:"block-audio",execute:()=>{var a;const l=this.tracks.video;(this.lastVideoAppendEnd>n||l!=null&&l.buffer&&dt.isBuffered(l.buffer,n)||((a=this.fragmentTracker.getAppendedFrag(n,$e.MAIN))==null?void 0:a.gap)===!0)&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:a=>{this.warn("Error executing block-audio operation",a)}};this.blockedAudioAppend={op:o,frag:e},this.append(o,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:i}=this,{data:n,type:s,parent:o,frag:a,part:l,chunkMeta:c,offset:u}=t,h=c.buffering[s],{sn:f,cc:d}=a,m=self.performance.now();h.start=m;const A=a.stats.buffering,p=l?l.stats.buffering:null;A.start===0&&(A.start=m),p&&p.start===0&&(p.start=m);const y=i.audio;let v=!1;s==="audio"&&y?.container==="audio/mpeg"&&(v=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);const E=i.video,x=E?.buffer;if(x&&f!=="initSegment"){const _=l||a,S=this.blockedAudioAppend;if(s==="audio"&&o!=="main"&&!this.blockedAudioAppend&&!(E.ending||E.ended)){const T=_.start+_.duration*.05,R=x.buffered,w=this.currentOp("video");!R.length&&!w?this.blockAudio(_):!w&&!dt.isBuffered(x,T)&&this.lastVideoAppendEnd<T&&this.blockAudio(_)}else if(s==="video"){const b=_.end;if(S){const T=S.frag.start;(b>T||b<this.lastVideoAppendEnd||dt.isBuffered(x,T))&&this.unblockAudio()}this.lastVideoAppendEnd=b}}const I=(l||a).start,C={label:`append-${s}`,execute:()=>{var _;h.executeStart=self.performance.now();const S=(_=this.tracks[s])==null?void 0:_.buffer;S&&(v?this.updateTimestampOffset(S,I,.1,s,f,d):u!==void 0&&He(u)&&this.updateTimestampOffset(S,u,1e-6,s,f,d)),this.appendExecutor(n,s)},onStart:()=>{},onComplete:()=>{const _=self.performance.now();h.executeEnd=h.end=_,A.first===0&&(A.first=_),p&&p.first===0&&(p.first=_);const S={};this.sourceBuffers.forEach(([b,T])=>{b&&(S[b]=dt.getBuffered(T))}),this.appendErrors[s]=0,s==="audio"||s==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(L.BUFFER_APPENDED,{type:s,frag:a,part:l,chunkMeta:c,parent:a.type,timeRanges:S})},onError:_=>{var S;const b={type:Je.MEDIA_ERROR,parent:a.type,details:ue.BUFFER_APPEND_ERROR,sourceBufferName:s,frag:a,part:l,chunkMeta:c,error:_,err:_,fatal:!1},T=(S=this.media)==null?void 0:S.error;if(_.code===DOMException.QUOTA_EXCEEDED_ERR||_.name=="QuotaExceededError"||"quota"in _)b.details=ue.BUFFER_FULL_ERROR;else if(_.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!T)b.errorAction=_a(!0);else if(_.name===jI&&this.sourceBufferCount===0)b.errorAction=_a(!0);else{const R=++this.appendErrors[s];this.warn(`Failed ${R}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${s}" sourceBuffer (${T||"no media error"})`),(R>=this.hls.config.appendErrorMaxRetry||T)&&(b.fatal=!0)}this.hls.trigger(L.ERROR,b)}};this.log(`queuing "${s}" append sn: ${f}${l?" p: "+l.index:""} of ${a.type===$e.MAIN?"level":"track"} ${a.level} cc: ${d}`),this.append(C,s,this.isPending(this.tracks[s]))}getFlushOp(e,t,i){return this.log(`queuing "${e}" remove ${t}-${i}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,i)},onStart:()=>{},onComplete:()=>{this.hls.trigger(L.BUFFER_FLUSHED,{type:e})},onError:n=>{this.warn(`Failed to remove ${t}-${i} from "${e}" SourceBuffer`,n)}}}onBufferFlushing(e,t){const{type:i,startOffset:n,endOffset:s}=t;i?this.append(this.getFlushOp(i,n,s),i):this.sourceBuffers.forEach(([o])=>{o&&this.append(this.getFlushOp(o,n,s),o)})}onFragParsed(e,t){const{frag:i,part:n}=t,s=[],o=n?n.elementaryStreams:i.elementaryStreams;o[qt.AUDIOVIDEO]?s.push("audiovideo"):(o[qt.AUDIO]&&s.push("audio"),o[qt.VIDEO]&&s.push("video"));const a=()=>{const l=self.performance.now();i.stats.buffering.end=l,n&&(n.stats.buffering.end=l);const c=n?n.stats:i.stats;this.hls.trigger(L.FRAG_BUFFERED,{frag:i,part:n,stats:c,id:i.type})};s.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,s).catch(l=>{this.warn(`Fragment buffered callback ${l}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{if(e){const t=this.tracks[e];if(t)return!t.ended||t.ending}return!1})}onBufferEos(e,t){var i;this.sourceBuffers.forEach(([o])=>{if(o){const a=this.tracks[o];(!t.type||t.type===o)&&(a.ending=!0,a.ended||(a.ended=!0,this.log(`${o} buffer reached EOS`)))}});const n=((i=this.overrides)==null?void 0:i.endOfStream)!==!1;this.sourceBufferCount>0&&!this.sourceBuffers.some(([o])=>{var a;return o&&!((a=this.tracks[o])!=null&&a.ended)})?n?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:o}=this;if(!o||o.readyState!=="open"){o&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${o.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),o.endOfStream(),this.hls.trigger(L.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(L.BUFFERED_TO_END,void 0)):t.type==="video"&&this.unblockAudio()}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(e!==null){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===ue.BUFFER_APPEND_ERROR&&t.frag){var i;const n=(i=t.errorAction)==null?void 0:i.nextAutoLevel;He(n)&&n!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.sourceBufferCount)return;const n=e.config,s=i.currentTime,o=t.levelTargetDuration,a=t.live&&n.liveBackBufferLength!==null?n.liveBackBufferLength:n.backBufferLength;if(He(a)&&a>=0){const c=Math.max(a,o),u=Math.floor(s/o)*o-c;this.flushBackBuffer(s,o,u)}const l=n.frontBufferFlushThreshold;if(He(l)&&l>0){const c=Math.max(n.maxBufferLength,l),u=Math.max(c,o),h=Math.floor(s/o)*o+u;this.flushFrontBuffer(s,o,h)}}flushBackBuffer(e,t,i){this.sourceBuffers.forEach(([n,s])=>{if(s){const a=dt.getBuffered(s);if(a.length>0&&i>a.start(0)){var o;this.hls.trigger(L.BACK_BUFFER_REACHED,{bufferEnd:i});const l=this.tracks[n];if((o=this.details)!=null&&o.live)this.hls.trigger(L.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(l!=null&&l.ended){this.log(`Cannot flush ${n} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(L.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:n})}}})}flushFrontBuffer(e,t,i){this.sourceBuffers.forEach(([n,s])=>{if(s){const o=dt.getBuffered(s),a=o.length;if(a<2)return;const l=o.start(a-1),c=o.end(a-1);if(i>l||e>=l&&e<=c)return;this.hls.trigger(L.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:n})}})}getDurationAndRange(){var e;const{details:t,mediaSource:i}=this;if(!t||!this.media||i?.readyState!=="open")return null;const n=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&i.setLiveSeekableRange){const c=Math.max(0,t.fragmentStart),u=Math.max(c,n);return{duration:1/0,start:c,end:u}}return{duration:1/0}}const s=(e=this.overrides)==null?void 0:e.duration;if(s)return He(s)?{duration:s}:null;const o=this.media.duration,a=He(i.duration)?i.duration:0;return n>a&&n>o||!He(o)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:i}){const n=this.mediaSource;!this.media||!n||n.readyState!=="open"||(n.duration!==e&&(He(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),n.duration=e),t!==void 0&&i!==void 0&&(this.log(`MediaSource duration is set to ${n.duration}. Setting seekable range to ${t}-${i}.`),n.setLiveSeekableRange(t,i)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:i}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${Xt(i)}`),this.tracksReady){var n;const s=(n=this.transferData)==null?void 0:n.tracks;s&&Object.keys(s).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,i])=>{if(t){const n=this.tracks[t];e[t]={buffer:i,container:n.container,codec:n.codec,supplemental:n.supplemental,levelCodec:n.levelCodec,id:n.id,metadata:n.metadata}}}),this.hls.trigger(L.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([t])=>{this.executeNext(t)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:i}=this;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(const s in e){const o=s,a=e[o];if(this.isPending(a)){const l=this.getTrackCodec(a,o),c=`${a.container};codecs=${l}`;a.codec=l,this.log(`creating sourceBuffer(${c})${this.currentOp(o)?" Queued":""} ${Xt(a)}`);try{const u=i.addSourceBuffer(c),h=Wd(o),f=[o,u];t[h]=f,a.buffer=u}catch(u){var n;this.error(`error while trying to add sourceBuffer: ${u.message}`),this.shiftAndExecuteNext(o),(n=this.operationQueue)==null||n.removeBlockers(),delete this.tracks[o],this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:u,sourceBufferName:o,mimeType:c,parent:a.id});return}this.trackSourceBuffer(o,a)}}this.bufferCreated()}getTrackCodec(e,t){const i=e.supplemental;let n=e.codec;i&&(t==="video"||t==="audiovideo")&&pc(i,"video")&&(n=rR(n,i));const s=lh(n,e.levelCodec);return s?t.slice(0,5)==="audio"?Ph(s,this.appendSource):s:""}trackSourceBuffer(e,t){const i=t.buffer;if(!i)return;const n=this.getTrackCodec(t,e);this.tracks[e]={buffer:i,codec:n,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(s,o)=>{const a=o.removedRanges;a!=null&&a.length&&this.hls.trigger(L.BUFFER_FLUSHED,{type:s})})}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i?.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var i;const n=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${n}`,t),this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});const s=this.currentOp(e);s&&s.onError(n)}updateTimestampOffset(e,t,i,n,s,o){const a=t-e.timestampOffset;Math.abs(a)>=i&&(this.log(`Updating ${n} SourceBuffer timestampOffset to ${t} (sn: ${s} cc: ${o})`),e.timestampOffset=t)}removeExecutor(e,t,i){const{media:n,mediaSource:s}=this,o=this.tracks[e],a=o?.buffer;if(!n||!s||!a){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),this.shiftAndExecuteNext(e);return}const l=He(n.duration)?n.duration:1/0,c=He(s.duration)?s.duration:1/0,u=Math.max(0,t),h=Math.min(i,l,c);h>u&&(!o.ending||o.ended)?(o.ended=!1,this.log(`Removing [${u},${h}] from the ${e} SourceBuffer`),a.remove(u,h)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.tracks[t],n=i?.buffer;if(!n)throw new cD(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);i.ending=!1,i.ended=!1,n.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(t=>{this.warn(`SourceBuffer blocked callback ${t}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(t){this.warn(`Callback run without blocking ${this.operationQueue} ${t}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:i}=this,n=t.map(o=>this.appendBlocker(o));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(n).then(o=>{i===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(t=>{var i;const n=(i=this.tracks[t])==null?void 0:i.buffer;!n||n.updating||this.shiftAndExecuteNext(t)})}append(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,i){const n=this.tracks[e];if(!n)return;const s=n.buffer;if(!s)return;const o=i.bind(this,e);n.listeners.push({event:t,listener:o}),s.addEventListener(t,o)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const i=t.buffer;i&&(t.listeners.forEach(n=>{i.removeEventListener(n.event,n.listener)}),t.listeners.length=0)}}function f2(r){const e=r.querySelectorAll("source");[].slice.call(e).forEach(t=>{r.removeChild(t)})}function uD(r,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,r.appendChild(t)}function Wd(r){return r==="audio"?1:0}class Ef{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(L.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.BUFFER_CODECS,this.onBufferCodecs,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(L.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.BUFFER_CODECS,this.onBufferCodecs,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&He(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((n,s)=>this.isLevelAllowed(n)&&s<=e);return this.clientRect=null,Ef.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const n=(a,l)=>l?a.width!==l.width||a.height!==l.height:!0;let s=e.length-1;const o=Math.max(t,i);for(let a=0;a<e.length;a+=1){const l=e[a];if((l.width>=o||l.height>=o)&&n(l,e[a+1])){s=a;break}}return s}}const hD={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},yn=hD,fD={HLS:"h"},dD=fD;class js{constructor(e,t){Array.isArray(e)&&(e=e.map(i=>i instanceof js?i:new js(i))),this.value=e,this.params=t}}const mD="Dict";function AD(r){return Array.isArray(r)?JSON.stringify(r):r instanceof Map?"Map{}":r instanceof Set?"Set{}":typeof r=="object"?JSON.stringify(r):String(r)}function pD(r,e,t,i){return new Error(`failed to ${r} "${AD(e)}" as ${t}`,{cause:i})}function qs(r,e,t){return pD("serialize",r,e,t)}class XI{constructor(e){this.description=e}}const d2="Bare Item",gD="Boolean";function yD(r){if(typeof r!="boolean")throw qs(r,gD);return r?"?1":"?0"}function vD(r){return btoa(String.fromCharCode(...r))}const ED="Byte Sequence";function xD(r){if(ArrayBuffer.isView(r)===!1)throw qs(r,ED);return`:${vD(r)}:`}const ID="Integer";function CD(r){return r<-999999999999999||999999999999999<r}function JI(r){if(CD(r))throw qs(r,ID);return r.toString()}function _D(r){return`@${JI(r.getTime()/1e3)}`}function ZI(r,e){if(r<0)return-ZI(-r,e);const t=Math.pow(10,e);if(Math.abs(r*t%1-.5)<Number.EPSILON){const n=Math.floor(r*t);return(n%2===0?n:n+1)/t}else return Math.round(r*t)/t}const SD="Decimal";function TD(r){const e=ZI(r,3);if(Math.floor(Math.abs(e)).toString().length>12)throw qs(r,SD);const t=e.toString();return t.includes(".")?t:`${t}.0`}const bD="String",wD=/[\x00-\x1f\x7f]+/;function BD(r){if(wD.test(r))throw qs(r,bD);return`"${r.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function RD(r){return r.description||r.toString().slice(7,-1)}const DD="Token";function m2(r){const e=RD(r);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw qs(e,DD);return e}function km(r){switch(typeof r){case"number":if(!He(r))throw qs(r,d2);return Number.isInteger(r)?JI(r):TD(r);case"string":return BD(r);case"symbol":return m2(r);case"boolean":return yD(r);case"object":if(r instanceof Date)return _D(r);if(r instanceof Uint8Array)return xD(r);if(r instanceof XI)return m2(r);default:throw qs(r,d2)}}const MD="Key";function Om(r){if(/^[a-z*][a-z0-9\-_.*]*$/.test(r)===!1)throw qs(r,MD);return r}function np(r){return r==null?"":Object.entries(r).map(([e,t])=>t===!0?`;${Om(e)}`:`;${Om(e)}=${km(t)}`).join("")}function eC(r){return r instanceof js?`${km(r.value)}${np(r.params)}`:km(r)}function LD(r){return`(${r.value.map(eC).join(" ")})${np(r.params)}`}function PD(r,e={whitespace:!0}){if(typeof r!="object"||r==null)throw qs(r,mD);const t=r instanceof Map?r.entries():Object.entries(r),i=e?.whitespace?" ":"";return Array.from(t).map(([n,s])=>{s instanceof js||(s=new js(s));let o=Om(n);return s.value===!0?o+=np(s.params):(o+="=",Array.isArray(s.value)?o+=LD(s):o+=eC(s)),o}).join(`,${i}`)}function tC(r,e){return PD(r,e)}const Fs="CMCD-Object",vi="CMCD-Request",no="CMCD-Session",br="CMCD-Status",FD={br:Fs,ab:Fs,d:Fs,ot:Fs,tb:Fs,tpb:Fs,lb:Fs,tab:Fs,lab:Fs,url:Fs,pb:vi,bl:vi,tbl:vi,dl:vi,ltc:vi,mtp:vi,nor:vi,nrr:vi,rc:vi,sn:vi,sta:vi,su:vi,ttfb:vi,ttfbb:vi,ttlb:vi,cmsdd:vi,cmsds:vi,smrt:vi,df:vi,cs:vi,ts:vi,cid:no,pr:no,sf:no,sid:no,st:no,v:no,msd:no,bs:br,bsd:br,cdn:br,rtp:br,bg:br,pt:br,ec:br,e:br},kD={REQUEST:vi};function OD(r){return Object.keys(r).reduce((e,t)=>{var i;return(i=r[t])===null||i===void 0||i.forEach(n=>e[n]=t),e},{})}function UD(r,e){const t={};if(!r)return t;const i=Object.keys(r),n=e?OD(e):{};return i.reduce((s,o)=>{var a;const l=FD[o]||n[o]||kD.REQUEST,c=(a=s[l])!==null&&a!==void 0?a:s[l]={};return c[o]=r[o],s},t)}function ND(r){return["ot","sf","st","e","sta"].includes(r)}function GD(r){return typeof r=="number"?He(r):r!=null&&r!==""&&r!==!1}const iC="event";function QD(r,e){const t=new URL(r),i=new URL(e);if(t.origin!==i.origin)return r;const n=t.pathname.split("/").slice(1),s=i.pathname.split("/").slice(1,-1);for(;n[0]===s[0];)n.shift(),s.shift();for(;s.length;)s.shift(),n.unshift("..");return n.join("/")+t.search+t.hash}const fh=r=>Math.round(r),Um=(r,e)=>Array.isArray(r)?r.map(t=>Um(t,e)):r instanceof js&&typeof r.value=="string"?new js(Um(r.value,e),r.params):(e.baseUrl&&(r=QD(r,e.baseUrl)),e.version===1?encodeURIComponent(r):r),vu=r=>fh(r/100)*100,zD=(r,e)=>{let t=r;return e.version>=2&&(r instanceof js&&typeof r.value=="string"?t=new js([r]):typeof r=="string"&&(t=[r])),Um(t,e)},HD={br:fh,d:fh,bl:vu,dl:vu,mtp:vu,nor:zD,rtp:vu,tb:fh},nC="request",sC="response",sp=["ab","bg","bl","br","bs","bsd","cdn","cid","cs","df","ec","lab","lb","ltc","msd","mtp","pb","pr","pt","sf","sid","sn","st","sta","tab","tb","tbl","tpb","ts","v"],VD=["e"],KD=/^[a-zA-Z0-9-.]+-[a-zA-Z0-9-.]+$/;function xf(r){return KD.test(r)}function $D(r){return sp.includes(r)||VD.includes(r)||xf(r)}const rC=["d","dl","nor","ot","rtp","su"];function YD(r){return sp.includes(r)||rC.includes(r)||xf(r)}const WD=["cmsdd","cmsds","rc","smrt","ttfb","ttfbb","ttlb","url"];function jD(r){return sp.includes(r)||rC.includes(r)||WD.includes(r)||xf(r)}const qD=["bl","br","bs","cid","d","dl","mtp","nor","nrr","ot","pr","rtp","sf","sid","st","su","tb","v"];function XD(r){return qD.includes(r)||xf(r)}const JD={[sC]:jD,[iC]:$D,[nC]:YD};function oC(r,e={}){const t={};if(r==null||typeof r!="object")return t;const i=e.version||r.v||1,n=e.reportingMode||nC,s=i===1?XD:JD[n];let o=Object.keys(r).filter(s);const a=e.filter;typeof a=="function"&&(o=o.filter(a));const l=n===sC||n===iC;l&&!o.includes("ts")&&o.push("ts"),i>1&&!o.includes("v")&&o.push("v");const c=Yt({},HD,e.formatters),u={version:i,reportingMode:n,baseUrl:e.baseUrl};return o.sort().forEach(h=>{let f=r[h];const d=c[h];if(typeof d=="function"&&(f=d(f,u)),h==="v"){if(i===1)return;f=i}h=="pr"&&f===1||(l&&h==="ts"&&!He(f)&&(f=Date.now()),GD(f)&&(ND(h)&&typeof f=="string"&&(f=new XI(f)),t[h]=f))}),t}function ZD(r,e={}){const t={};if(!r)return t;const i=oC(r,e),n=UD(i,e?.customHeaderMap);return Object.entries(n).reduce((s,[o,a])=>{const l=tC(a,{whitespace:!1});return l&&(s[o]=l),s},t)}function eM(r,e,t){return Yt(r,ZD(e,t))}const tM="CMCD";function iM(r,e={}){return r?tC(oC(r,e),{whitespace:!1}):""}function nM(r,e={}){if(!r)return"";const t=iM(r,e);return encodeURIComponent(t)}function sM(r,e={}){if(!r)return"";const t=nM(r,e);return`${tM}=${t}`}const A2=/CMCD=[^&#]+/;function rM(r,e,t){const i=sM(e,t);if(!i)return r;if(A2.test(r))return r.replace(A2,i);const n=r.includes("?")?"&":"?";return`${r}${n}${i}`}class aC{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=n=>{try{this.apply(n,{ot:yn.MANIFEST,su:!this.initialized})}catch(s){this.hls.logger.warn("Could not generate manifest CMCD data.",s)}},this.applyFragmentData=n=>{try{const{frag:s,part:o}=n,a=this.hls.levels[s.level],l=this.getObjectType(s),c={d:(o||s).duration*1e3,ot:l};(l===yn.VIDEO||l===yn.AUDIO||l==yn.MUXED)&&(c.br=a.bitrate/1e3,c.tb=this.getTopBandwidth(l)/1e3,c.bl=this.getBufferLength(l));const u=o?this.getNextPart(o):this.getNextFrag(s);u!=null&&u.url&&u.url!==s.url&&(c.nor=u.url),this.apply(n,c)}catch(s){this.hls.logger.warn("Could not generate segment CMCD data.",s)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||e.sessionId,this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHED,this.onMediaDetached,this),e.on(L.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHED,this.onMediaDetached,this),e.off(L.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,n;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(n=t.tracks.video)==null?void 0:n.buffer}createData(){var e;return{v:1,sf:dD.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){Yt(t,this.createData());const i=t.ot===yn.INIT||t.ot===yn.VIDEO||t.ot===yn.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:n}=this;n&&(t=Object.keys(t).reduce((o,a)=>(n.includes(a)&&(o[a]=t[a]),o),{}));const s={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),eM(e.headers,t,s)):e.url=rM(e.url,t,s)}getNextFrag(e){var t;const i=(t=this.hls.levels[e.level])==null?void 0:t.details;if(i){const n=e.sn-i.startSN;return i.fragments[n+1]}}getNextPart(e){var t;const{index:i,fragment:n}=e,s=(t=this.hls.levels[n.level])==null||(t=t.details)==null?void 0:t.partList;if(s){const{sn:o}=n;for(let a=s.length-1;a>=0;a--){const l=s[a];if(l.index===i&&l.fragment.sn===o)return s[a+1]}}}getObjectType(e){const{type:t}=e;if(t==="subtitle")return yn.TIMED_TEXT;if(e.sn==="initSegment")return yn.INIT;if(t==="audio")return yn.AUDIO;if(t==="main")return this.hls.audioTracks.length?yn.VIDEO:yn.MUXED}getTopBandwidth(e){let t=0,i;const n=this.hls;if(e===yn.AUDIO)i=n.audioTracks;else{const s=n.maxAutoLevel,o=s>-1?s+1:n.levels.length;i=n.levels.slice(0,o)}return i.forEach(s=>{s.bitrate>t&&(t=s.bitrate)}),t>0?t:NaN}getBufferLength(e){const t=this.media,i=e===yn.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:dt.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,o,a){t(s),this.loader.load(s,o,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(s){this.loader=void 0,this.loader=new i(s)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(s,o,a){t(s),this.loader.load(s,o,a)}}}}const oM=3e5;class lC extends as{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if(i?.action===Ui.SendAlternateToPenaltyBox&&i.flags===En.MoveAllAlternatesMatchingHost){const n=this.levels;let s=this._pathwayPriority,o=this.pathwayId;if(t.context){const{groupId:a,pathwayId:l,type:c}=t.context;a&&n?o=this.getPathwayForGroupId(a,c,o):l&&(o=l)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!s&&n&&(s=this.pathways()),s&&s.length>1&&(this.updatePathwayPriority(s),i.resolved=this.pathwayId!==o),t.details===ue.BUFFER_APPEND_ERROR&&!t.fatal?i.resolved=!0:i.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${n&&n.length} priorities: ${Xt(s)} penalized: ${Xt(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this._pathwayPriority=e;let t;const i=this.penalizedPathways,n=performance.now();Object.keys(i).forEach(s=>{n-i[s]>oM&&delete i[s]});for(let s=0;s<e.length;s++){const o=e[s];if(o in i)continue;if(o===this.pathwayId)return;const a=this.hls.nextLoadLevel,l=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,CI(t),this.hls.trigger(L.LEVELS_UPDATED,{levels:t});const c=this.hls.levels[a];l&&c&&this.levels&&(c.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&c.bitrate!==l.bitrate&&this.log(`Unstable Pathways change from bitrate ${l.bitrate} to ${c.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const n=this.getLevelsForPathway(i).concat(this.levels||[]);for(let s=0;s<n.length;s++)if(t===Ct.AUDIO_TRACK&&n[s].hasAudioGroup(e)||t===Ct.SUBTITLE_TRACK&&n[s].hasSubtitleGroup(e))return n[s].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},n={};e.forEach(s=>{const{ID:o,"BASE-ID":a,"URI-REPLACEMENT":l}=s;if(t.some(u=>u.pathwayId===o))return;const c=this.getLevelsForPathway(a).map(u=>{const h=new li(u.attrs);h["PATHWAY-ID"]=o;const f=h.AUDIO&&`${h.AUDIO}_clone_${o}`,d=h.SUBTITLES&&`${h.SUBTITLES}_clone_${o}`;f&&(i[h.AUDIO]=f,h.AUDIO=f),d&&(n[h.SUBTITLES]=d,h.SUBTITLES=d);const m=cC(u.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",l),A=new Fa({attrs:h,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:m,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let p=1;p<u.audioGroups.length;p++)A.addGroupId("audio",`${u.audioGroups[p]}_clone_${o}`);if(u.subtitleGroups)for(let p=1;p<u.subtitleGroups.length;p++)A.addGroupId("text",`${u.subtitleGroups[p]}_clone_${o}`);return A});t.push(...c),p2(this.audioTracks,i,l,o),p2(this.subtitleTracks,n,l,o)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let n;try{n=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(n.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;n.searchParams.set("_HLS_pathway",this.pathwayId),n.searchParams.set("_HLS_throughput",""+u)}const s={responseType:"json",url:n.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},l={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},c={onSuccess:(u,h,f,d)=>{this.log(`Loaded steering manifest: "${n}"`);const m=u.data;if(m?.VERSION!==1){this.log(`Steering VERSION ${m.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=m.TTL;const{"RELOAD-URI":A,"PATHWAY-CLONES":p,"PATHWAY-PRIORITY":y}=m;if(A)try{this.uri=new self.URL(A,n).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${A}`);return}this.scheduleRefresh(this.uri||f.url),p&&this.clonePathways(p);const v={steeringManifest:m,url:n.toString()};this.hls.trigger(L.STEERING_MANIFEST_LOADED,v),y&&this.updatePathwayPriority(y)},onError:(u,h,f,d)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${h.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let m=this.timeToLoad*1e3;if(u.code===429){const A=this.loader;if(typeof A?.getResponseHeader=="function"){const p=A.getResponseHeader("Retry-After");p&&(m=parseFloat(p)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,m)},onTimeout:(u,h,f)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${n}`),this.loader.load(s,l,c)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const n=(i=this.hls)==null?void 0:i.media;if(n&&!n.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function p2(r,e,t,i){r&&Object.keys(e).forEach(n=>{const s=r.filter(o=>o.groupId===n).map(o=>{const a=Yt({},o);return a.details=void 0,a.attrs=new li(a.attrs),a.url=a.attrs.URI=cC(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[n],a.attrs["PATHWAY-ID"]=i,a});r.push(...s)})}function cC(r,e,t,i){const{HOST:n,PARAMS:s,[t]:o}=i;let a;e&&(a=o?.[e],a&&(r=a));const l=new self.URL(r);return n&&!a&&(l.host=n),s&&Object.keys(s).sort().forEach(c=>{c&&l.searchParams.set(c,s[c])}),l.href}class po extends as{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.mediaResolved=void 0,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=po.CDMCleanupPromise?[po.CDMCleanupPromise]:[],this.bannedKeyIds={},this.onMediaEncrypted=t=>{const{initDataType:i,initData:n}=t,s=`"${t.type}" event: init data type: "${i}"`;if(this.debug(s),n!==null){if(!this.keyFormatPromise){let o=Object.keys(this.keySystemAccessPromises);o.length||(o=Hl(this.config));const a=o.map(Gd).filter(l=>!!l);this.keyFormatPromise=this.getKeyFormatPromise(a)}this.keyFormatPromise.then(o=>{const a=ch(o);if(i!=="sinf"||a!==ci.FAIRPLAY){this.log(`Ignoring "${t.type}" event with init data type: "${i}" for selected key-system ${a}`);return}let l;try{const d=Oi(new Uint8Array(n)),m=WA(JSON.parse(d).sinf),A=Xx(m);if(!A)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");l=new Uint8Array(A.subarray(8,24))}catch(d){this.warn(`${s} Failed to parse sinf: ${d}`);return}const c=an(l),{keyIdToKeySessionPromise:u,mediaKeySessions:h}=this;let f=u[c];for(let d=0;d<h.length;d++){const m=h[d],A=m.decryptdata;if(!A.keyId)continue;const p=an(A.keyId);if(Nh(l,A.keyId)||A.uri.replace(/-/g,"").indexOf(c)!==-1){if(f=u[p],!f)continue;if(A.pssh)break;delete u[p],A.pssh=new Uint8Array(n),A.keyId=l,f=u[c]=f.then(()=>this.generateRequestWithPreferredKeySession(m,i,n,"encrypted-event-key-match")),f.catch(y=>this.handleError(y));break}}f||this.handleError(new Error(`Key ID ${c} not encountered in playlist. Key-system sessions ${h.length}.`))}).catch(o=>this.handleError(o))}},this.onWaitingForKey=t=>{this.log(`"${t.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null}registerListeners(){this.hls.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(L.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(L.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(L.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(L.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(L.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(L.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,n=t?.[e];if(n)return n.licenseUrl;if(e===ci.WIDEVINE&&i)return i}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t?.[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(o,a,l)=>!!o&&l.indexOf(o)===a,n=t.map(o=>o.audioCodec).filter(i),s=t.map(o=>o.videoCodec).filter(i);return n.length+s.length===0&&s.push("avc1.42e01e"),new Promise((o,a)=>{const l=c=>{const u=c.shift();this.getMediaKeysPromise(u,n,s).then(h=>o({keySystem:u,mediaKeys:h})).catch(h=>{c.length?l(c):h instanceof Ln?a(h):a(new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_ACCESS,error:h,fatal:!0},h.message))})};l(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let n=`Configured requestMediaKeySystemAccess is not a function ${i}`;return jA===null&&self.location.protocol==="http:"&&(n=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(n))}return i(e,t)}getMediaKeysPromise(e,t,i){var n;const s=KR(e,t,i,this.config.drmSystemOptions||{});let o=this.keySystemAccessPromises[e],a=(n=o)==null?void 0:n.keySystemAccess;if(!a){this.log(`Requesting encrypted media "${e}" key-system access with config: ${Xt(s)}`),a=this.requestMediaKeySystemAccess(e,s);const l=o=this.keySystemAccessPromises[e]={keySystemAccess:a};return a.catch(c=>{this.log(`Failed to obtain access to key-system "${e}": ${c}`)}),a.then(c=>{this.log(`Access for key-system "${c.keySystem}" obtained`);const u=this.fetchServerCertificate(e);this.log(`Create media-keys for "${e}"`);const h=l.mediaKeys=c.createMediaKeys().then(f=>(this.log(`Media-keys created for "${e}"`),l.hasMediaKeys=!0,u.then(d=>d?this.setMediaKeysServerCertificate(f,e,d):f)));return h.catch(f=>{this.error(`Failed to create media-keys for "${e}"}: ${f}`)}),h})}return a.then(()=>o.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${an(e.keyId||[])} keyUri: ${e.uri}`);const n=i.createSession(),s={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:n,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),n=Eu(t),s="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(i,s,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}updateKeySession(e,t){const i=e.mediaKeysSession;return this.log(`Updating key-session "${i.sessionId}" for keyId ${an(e.decryptdata.keyId||[])}
      } (data length: ${t.byteLength})`),i.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>Gd(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:t,mediaKeys:i})=>this.attemptSetMediaKeys(t,i))}selectKeySystem(e){return new Promise((t,i)=>{this.getKeySystemSelectionPromise(e).then(({keySystem:n})=>{const s=Gd(n);s?t(s):i(new Error(`Unable to find format for key-system "${n}"`))}).catch(i)})}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=Hl(this.config),i=e.map(ch).filter(n=>!!n&&t.indexOf(n)!==-1);return this.selectKeySystem(i)}getKeyStatus(e){const{mediaKeySessions:t}=this;for(let i=0;i<t.length;i++){const n=aM(e,t[i]);if(n)return n}}loadKey(e){const t=e.keyInfo.decryptdata,i=Eu(t),n=this.bannedKeyIds[i];if(n||this.getKeyStatus(t)==="internal-error"){const a=g2(n||"internal-error",t);return this.handleError(a,e.frag),Promise.reject(a)}const s=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${s}`);const o=this.keyIdToKeySessionPromise[i];if(!o){const a=this.getKeySystemForKeyPromise(t).then(({keySystem:l,mediaKeys:c})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${s}`),this.attemptSetMediaKeys(l,c).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:l,mediaKeys:c,decryptdata:t}))))).then(l=>{const c="cenc",u=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(l,c,u,"playlist-key")});return a.catch(l=>this.handleError(l,e.frag)),this.keyIdToKeySessionPromise[i]=a,a}return o.catch(a=>{if(a instanceof Ln){const l=Ht({},a.data);this.getKeyStatus(t)==="internal-error"&&(l.decryptdata=t);const c=new Ln(l,a.message);this.handleError(c,e.frag)}}),o}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e,t){if(this.hls)if(e instanceof Ln){t&&(e.data.frag=t);const i=e.data.decryptdata;this.error(`${e.message}${i?` (${an(i.keyId||[])})`:""}`),this.hls.trigger(L.ERROR,e.data)}else this.error(e.message),this.hls.trigger(L.ERROR,{type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0})}getKeySystemForKeyPromise(e){const t=Eu(e),i=this.keyIdToKeySessionPromise[t];if(!i){const n=ch(e.keyFormat),s=n?[n]:Hl(this.config);return this.attemptKeySystemAccess(s)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=Hl(this.config)),e.length===0)throw new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${Xt({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaResolved=void 0,this.mediaKeys===t)return Promise.resolve();const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const n=Promise.all(i).then(()=>this.media?this.media.setMediaKeys(t):new Promise((s,o)=>{this.mediaResolved=()=>{if(this.mediaResolved=void 0,!this.media)return o(new Error("Attempted to set mediaKeys without media element attached"));this.mediaKeys=t,this.media.setMediaKeys(t).then(s).catch(o)}}));return this.mediaKeys=t,this.setMediaKeysQueue.push(n),n.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(n),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(s=>i.indexOf(s)===-1)})}generateRequestWithPreferredKeySession(e,t,i,n){var s;const o=(s=this.config.drmSystems)==null||(s=s[e.keySystem])==null?void 0:s.generateRequest;if(o)try{const m=o.call(this.hls,t,i,e);if(!m)throw new Error("Invalid response from configured generateRequest filter");t=m.initDataType,i=m.initData?m.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(m){if(this.warn(m.message),this.hls&&this.hls.config.debug)throw m}if(i===null)return this.log(`Skipping key-session request for "${n}" (no initData)`),Promise.resolve(e);const a=Eu(e.decryptdata),l=e.decryptdata.uri;this.log(`Generating key-session request for "${n}" keyId: ${a} URI: ${l} (init data type: ${t} length: ${i.byteLength})`);const c=new qA,u=e._onmessage=m=>{const A=e.mediaKeysSession;if(!A){c.emit("error",new Error("invalid state"));return}const{messageType:p,message:y}=m;this.log(`"${p}" message event for session "${A.sessionId}" message size: ${y.byteLength}`),p==="license-request"||p==="license-renewal"?this.renewLicense(e,y).catch(v=>{c.eventNames().length?c.emit("error",v):this.handleError(v)}):p==="license-release"?e.keySystem===ci.FAIRPLAY&&this.updateKeySession(e,Rm("acknowledged")).then(()=>this.removeSession(e)).catch(v=>this.handleError(v)):this.warn(`unhandled media key message type "${p}"`)},h=(m,A)=>{A.keyStatus=m;let p;m.startsWith("usable")?c.emit("resolved"):m==="internal-error"||m==="output-restricted"||m==="output-downscaled"?p=g2(m,A.decryptdata):m==="expired"?p=new Error(`key expired (keyId: ${a})`):m==="released"?p=new Error("key released"):m==="status-pending"||this.warn(`unhandled key status change "${m}" (keyId: ${a})`),p&&(c.eventNames().length?c.emit("error",p):this.handleError(p))},f=e._onkeystatuseschange=m=>{if(!e.mediaKeysSession){c.emit("error",new Error("invalid state"));return}const p=this.getKeyStatuses(e);if(!Object.keys(p).some(x=>p[x]!=="status-pending"))return;if(p[a]==="expired"){this.log(`Expired key ${Xt(p)} in key-session "${e.mediaKeysSession.sessionId}"`),this.renewKeySession(e);return}let v=p[a];if(v)h(v,e);else{var E;e.keyStatusTimeouts||(e.keyStatusTimeouts={}),(E=e.keyStatusTimeouts)[a]||(E[a]=self.setTimeout(()=>{if(!e.mediaKeysSession||!this.mediaKeys)return;const I=this.getKeyStatus(e.decryptdata);if(I&&I!=="status-pending")return this.log(`No status for keyId ${a} in key-session "${e.mediaKeysSession.sessionId}". Using session key-status ${I} from other session.`),h(I,e);this.log(`key status for ${a} in key-session "${e.mediaKeysSession.sessionId}" timed out after 1000ms`),v="internal-error",h(v,e)},1e3)),this.log(`No status for keyId ${a} (${Xt(p)}).`)}};un(e.mediaKeysSession,"message",u),un(e.mediaKeysSession,"keystatuseschange",f);const d=new Promise((m,A)=>{c.on("error",A),c.on("resolved",m)});return e.mediaKeysSession.generateRequest(t,i).then(()=>{this.log(`Request generated for key-session "${e.mediaKeysSession.sessionId}" keyId: ${a} URI: ${l}`)}).catch(m=>{throw new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_NO_SESSION,error:m,decryptdata:e.decryptdata,fatal:!1},`Error generating key-session request: ${m}`)}).then(()=>d).catch(m=>(c.removeAllListeners(),this.removeSession(e).then(()=>{throw m}))).then(()=>(c.removeAllListeners(),e))}getKeyStatuses(e){const t={};return e.mediaKeysSession.keyStatuses.forEach((i,n)=>{if(typeof n=="string"&&typeof i=="object"){const a=n;n=i,i=a}const s="buffer"in n?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n);e.keySystem===ci.PLAYREADY&&s.length===16&&mI(s);const o=an(s);i==="internal-error"&&(this.bannedKeyIds[o]=i),this.log(`key status change "${i}" for keyStatuses keyId: ${o} key-session "${e.mediaKeysSession.sessionId}"`),t[o]=i}),t}fetchServerCertificate(e){const t=this.config,i=t.loader,n=new i(t),s=this.getServerCertificateUrl(e);return s?(this.log(`Fetching server certificate for "${e}"`),new Promise((o,a)=>{const l={responseType:"arraybuffer",url:s},c=t.certLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{o(f.data)},onError:(f,d,m,A)=>{a(new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:Ht({url:l.url,data:void 0},f)},`"${e}" certificate request failed (${s}). Status: ${f.code} (${f.text})`))},onTimeout:(f,d,m)=>{a(new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:m,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${s})`))},onAbort:(f,d,m)=>{a(new Error("aborted"))}};n.load(l,u,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((n,s)=>{e.setServerCertificate(i).then(o=>{this.log(`setServerCertificate ${o?"success":"not supported by CDM"} (${i.byteLength}) on "${t}"`),n(e)}).catch(o=>{s(new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:o,fatal:!0},o.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(n=>{throw new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_SESSION_UPDATE_FAILED,decryptdata:e.decryptdata,error:n,fatal:!1},n.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const n=new DOMParser().parseFromString(i,"application/xml"),s=n.querySelectorAll("HttpHeader");if(s.length>0){let u;for(let h=0,f=s.length;h<f;h++){var o,a;u=s[h];const d=(o=u.querySelector("name"))==null?void 0:o.textContent,m=(a=u.querySelector("value"))==null?void 0:a.textContent;d&&m&&e.setRequestHeader(d,m)}}const l=n.querySelector("Challenge"),c=l?.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return Rm(atob(c))}setupLicenseXHR(e,t,i,n){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,e,t,i,n)}).catch(o=>{if(!i.decryptdata)throw o;return e.open("POST",t,!0),s.call(this.hls,e,t,i,n)}).then(o=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:o||n})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((n,s)=>{const o=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${o}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return s(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let l=a.response;this.log(`License received ${l instanceof ArrayBuffer?l.byteLength:l}`);const c=this.config.licenseResponseCallback;if(c)try{l=c.call(this.hls,a,o,e)}catch(u){this.error(u)}n(l)}else{const l=i.errorRetry,c=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||a.status>=400&&a.status<500)s(new Ln({type:Je.KEY_SYSTEM_ERROR,details:ue.KEY_SYSTEM_LICENSE_REQUEST_FAILED,decryptdata:e.decryptdata,fatal:!0,networkDetails:a,response:{url:o,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${o}). Status: ${a.status} (${a.statusText})`));else{const u=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(n,s)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,o,e,t).then(({xhr:l,licenseChallenge:c})=>{e.keySystem==ci.PLAYREADY&&(c=this.unpackPlayReadyKeyMessage(l,c)),l.send(c)}).catch(s)})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,un(i,"encrypted",this.onMediaEncrypted),un(i,"waitingforkey",this.onWaitingForKey);const n=this.mediaResolved;n?n():this.mediaKeys=i.mediaKeys}onMediaDetached(){const e=this.media;e&&(Cn(e,"encrypted",this.onMediaEncrypted),Cn(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},this.bannedKeyIds={};const t=this.mediaResolved;if(t&&t(),!this.mediaKeys&&!this.mediaKeySessions.length)return;const i=this.media,n=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,Qr.clearKeyUriToKeyIdMap();const s=n.length;po.CDMCleanupPromise=Promise.all(n.map(o=>this.removeSession(o)).concat((i==null||(e=i.setMediaKeys(null))==null?void 0:e.catch(o=>{this.log(`Could not clear media keys: ${o}`),this.hls&&this.hls.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${o}`)})}))||Promise.resolve())).catch(o=>{this.log(`Could not close sessions and clear media keys: ${o}`),this.hls&&this.hls.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${o}`)})}).then(()=>{s&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this._clear()}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((n,s)=>(n.indexOf(s.keyFormat)===-1&&n.push(s.keyFormat),n),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i,decryptdata:n}=e;if(t){this.log(`Remove licenses and keys and close session "${t.sessionId}" keyId: ${an(n?.keyId||[])}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const s=this.mediaKeySessions.indexOf(e);s>-1&&this.mediaKeySessions.splice(s,1);const{keyStatusTimeouts:o}=e;o&&Object.keys(o).forEach(c=>self.clearTimeout(o[c]));const{drmSystemOptions:a}=this.config;return(YR(a)?new Promise((c,u)=>{self.setTimeout(()=>u(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(c).catch(u)}):Promise.resolve()).catch(c=>{this.log(`Could not remove session: ${c}`),this.hls&&this.hls.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${c}`)})}).then(()=>t.close()).catch(c=>{this.log(`Could not close session: ${c}`),this.hls&&this.hls.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${c}`)})})}return Promise.resolve()}}po.CDMCleanupPromise=void 0;function Eu(r){if(!r)throw new Error("Could not read keyId of undefined decryptdata");if(r.keyId===null)throw new Error("keyId is null");return an(r.keyId)}function aM(r,e){if(r.keyId&&e.mediaKeysSession.keyStatuses.has(r.keyId))return e.mediaKeysSession.keyStatuses.get(r.keyId);if(r.matches(e.decryptdata))return e.keyStatus}class Ln extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}function g2(r,e){const t=r==="output-restricted",i=t?ue.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:ue.KEY_SYSTEM_STATUS_INTERNAL_ERROR;return new Ln({type:Je.KEY_SYSTEM_ERROR,details:i,fatal:!1,decryptdata:e},t?"HDCP level output restricted":`key status changed to "${r}"`)}class uC{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(L.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(L.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const n=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=n,n&&typeof n.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,i){const n=performance.now();if(t){if(this.lastTime){const s=n-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,l=1e3*o/s,c=this.hls;if(c.trigger(L.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),l>0&&o>c.config.fpsDroppedMonitoringThreshold*a){let u=c.currentLevel;c.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(c.autoLevelCapping===-1||c.autoLevelCapping>=u)&&(u=u-1,c.trigger(L.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:c.currentLevel}),c.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function hC(r,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=r,e.dispatchEvent(t)}function fC(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues&&!r.cues.getCueById(e.id))try{if(r.addCue(e),!r.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){Kt.debug(`[texttrack-utils]: ${i}`);try{const n=new self.TextTrackCue(e.startTime,e.endTime,e.text);n.id=e.id,r.addCue(n)}catch(n){Kt.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${n}`)}}t==="disabled"&&(r.mode=t)}function Aa(r,e){const t=r.mode;if(t==="disabled"&&(r.mode="hidden"),r.cues)for(let i=r.cues.length;i--;)e&&r.cues[i].removeEventListener("enter",e),r.removeCue(r.cues[i]);t==="disabled"&&(r.mode=t)}function Nm(r,e,t,i){const n=r.mode;if(n==="disabled"&&(r.mode="hidden"),r.cues&&r.cues.length>0){const s=cM(r.cues,e,t);for(let o=0;o<s.length;o++)(!i||i(s[o]))&&r.removeCue(s[o])}n==="disabled"&&(r.mode=n)}function lM(r,e){if(e<=r[0].startTime)return 0;const t=r.length-1;if(e>r[t].endTime)return-1;let i=0,n=t,s;for(;i<=n;)if(s=Math.floor((n+i)/2),e<r[s].startTime)n=s-1;else if(e>r[s].startTime&&i<t)i=s+1;else return s;return r[i].startTime-e<e-r[n].startTime?i:n}function cM(r,e,t){const i=[],n=lM(r,e);if(n>-1)for(let s=n,o=r.length;s<o;s++){const a=r[s];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function dh(r){const e=[];for(let t=0;t<r.length;t++){const i=r[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(r[t])}return e}class dC extends vf{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=dh(this.media.textTracks);for(let s=0;s<i.length;s++)if(i[s].mode==="hidden")t=i[s];else if(i[s].mode==="showing"){t=i[s];break}const n=this.findTrackForTextTrack(t);this.subtitleTrack!==n&&this.setSubtitleTrack(n)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(L.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVEL_LOADING,this.onLevelLoading,this),e.off(L.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(L.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const i=this.media;if(!i)return;const n=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,n)return;dh(i.textTracks).forEach(o=>{Aa(o)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==n){this.warn(`Subtitle track with id:${i} and group:${n} not found in active group ${o?.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||n?.length!==i?.length||i!=null&&i.some(o=>n?.indexOf(o)===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(u=>u.default)&&(this.selectDefaultTrack=!1),o.forEach((u,h)=>{u.id=h});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const a=this.hls.config.subtitlePreference;if(!s&&a){this.selectDefaultTrack=!1;const u=Ks(a,o);if(u>-1)s=o[u];else{const h=Ks(a,this.tracks);s=this.tracks[h]}}let l=this.findTrackId(s);l===-1&&s&&(l=this.findTrackId(null));const c={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i?.join(",")}" group-id`),this.hls.trigger(L.SUBTITLE_TRACKS_UPDATED,c),l!==-1&&this.trackId===-1&&this.setSubtitleTrack(l)}}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let n=0;n<t.length;n++){const s=t[n];if(!(i&&!s.default||!i&&!e)&&(!e||Ao(s,e)))return n}if(e){for(let n=0;n<t.length;n++){const s=t[n];if(xc(e.attrs,s.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return n}for(let n=0;n<t.length;n++){const s=t[n];if(xc(e.attrs,s.attrs,["LANGUAGE"]))return n}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if(Fm(n,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Ct.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&Ao(e,i))return i;const n=Ks(e,this.tracksInGroup);if(n>-1){const s=this.tracksInGroup[n];return this.setSubtitleTrack(n),s}else{if(i)return null;{const s=Ks(e,t);if(s>-1)return t[s]}}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=e.id,n=e.groupId,s=this.getUrlWithDirectives(e.url,t),o=e.details,a=o?.age;this.log(`Loading subtitle ${i} "${e.name}" lang:${e.lang} group:${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${s}`),this.hls.trigger(L.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=dh(e.textTracks),i=this.currentTrack;let n;if(i&&(n=t.filter(s=>Fm(i,s))[0],n||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(s=>{s.mode!=="disabled"&&s!==n&&(s.mode="disabled")}),n){const s=this.subtitleDisplay?"showing":"hidden";n.mode!==s&&(n.mode=s)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!He(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n){this.hls.trigger(L.SUBTITLE_TRACK_SWITCH,{id:e});return}const s=!!n.details&&!n.details.live;if(e===this.trackId&&n===i&&s)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:o,groupId:a="",name:l,type:c,url:u}=n;this.hls.trigger(L.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:l,type:c,url:u});const h=this.switchParams(n.url,i?.details,n.details);this.loadPlaylist(h)}}function uM(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const s=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(n=="x"?s:s&3|8).toString(16)})}}}function nc(r){let e=5381,t=r.length;for(;t;)e=e*33^r.charCodeAt(--t);return(e>>>0).toString()}const Ta=.025;let Hh=(function(r){return r[r.Point=0]="Point",r[r.Range=1]="Range",r})({});function hM(r,e,t){return`${r.identifier}-${t+1}-${nc(e)}`}class fM{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,(e=this.assetListLoader)==null||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const i=this.playoutLimit;return e<=0||isNaN(i)?!1:i===0?!0:(((t=this.assetList[e])==null?void 0:t.startOffset)||0)>i}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return jd(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(this.startTime===0||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime,i=jd(t,e);return t-i<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=He(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return jd(e,t)}return e}get appendInPlace(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<Ta))}set appendInPlace(e){if(this.appendInPlaceStarted){this.resetOnResume=!e;return}this.appendInPlaceDisabled=!e}get timelineStart(){return this._timelineStart!==null?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return this._duration!==null?t=this._duration:this.dateRange.duration?t=this.dateRange.duration:t=this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Hh.Range:Hh.Point}get supplementsPrimary(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}get contentMayVary(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||this.assetListResponse!==null}toString(){return dM(this)}}function jd(r,e){return r-e.start<e.duration/2&&!(Math.abs(r-(e.start+e.duration))<Ta)?e.start:e.start+e.duration}function mC(r,e,t){const i=new self.URL(r,t);return i.protocol!=="data:"&&i.searchParams.set("_HLS_primary_id",e),i}function qd(r,e){for(;(t=r.assetList[++e])!=null&&t.error;)var t;return e}function dM(r){return`["${r.identifier}" ${r.cue.pre?"<pre>":r.cue.post?"<post>":""}${r.timelineStart.toFixed(2)}-${r.resumeTime.toFixed(2)}]`}function ca(r){const e=r.timelineStart,t=r.duration||0;return`["${r.identifier}" ${e.toFixed(2)}-${(e+t).toFixed(2)}]`}class mM{constructor(e,t,i,n){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls&&this.hls.trigger(L.PLAYOUT_LIMIT_REACHED,{})};const s=this.hls=new e(t);this.interstitial=i,this.assetItem=n;const o=()=>{this.hasDetails=!0};s.once(L.LEVEL_LOADED,o),s.once(L.AUDIO_TRACK_LOADED,o),s.once(L.SUBTITLE_TRACK_LOADED,o),s.on(L.MEDIA_ATTACHING,(a,{media:l})=>{this.removeMediaListeners(),this.mediaAttached=l,this.interstitial.playoutLimit&&(l.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&s.on(L.BUFFER_APPENDED,()=>{const u=this.bufferedEnd;this.reachedPlayout(u)&&(this._bufferedEosTime=u,s.trigger(L.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){return this.interstitial.appendInPlace}loadSource(){const e=this.hls;if(e)if(e.url)e.levels.length&&!e.started&&e.startLoad(-1,!0);else{let t=this.assetItem.uri;try{t=mC(t,e.config.primarySessionId||"").href}catch{}e.loadSource(t)}}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if((t=this.hls)!=null&&t.bufferedToEnd)return!0;if(!e)return!1;const i=Math.min(this._bufferedEosTime||1/0,this.duration),n=this.timelineOffset,s=dt.bufferInfo(e,n,0);return this.getAssetTime(s.end)>=i-.02}reachedPlayout(e){const i=this.interstitial.playoutLimit;return this.startOffset+e>=i}get destroyed(){var e;return!((e=this.hls)!=null&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return((e=this.hls)==null?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=dt.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){const e=this.assetItem.duration;if(!e)return 0;const t=this.interstitial.playoutLimit;if(t){const i=t-this.startOffset;if(i>0&&i<e)return i}return e}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return((e=this.hls)==null?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const i=e-t;if(Math.abs(i)>1/9e4&&this.hls){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,i=this.duration;return Math.min(Math.max(0,e-t),i)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){if(this.mediaAttached){var e;(e=this.hls)!=null&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}}destroy(){this.removeMediaListeners(),this.hls&&this.hls.destroy(),this.hls=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){var t;this.loadSource(),(t=this.hls)==null||t.attachMedia(e)}detachMedia(){var e;this.removeMediaListeners(),this.mediaAttached=null,(e=this.hls)==null||e.detachMedia()}resumeBuffering(){var e;(e=this.hls)==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.hls)==null||e.pauseBuffering()}transferMedia(){var e;return this.bufferSnapShot(),((e=this.hls)==null?void 0:e.transferMedia())||null}resetDetails(){const e=this.hls;if(e&&this.hasDetails){e.stopLoad();const t=i=>delete i.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,i){var n;(n=this.hls)==null||n.on(e,t)}once(e,t,i){var n;(n=this.hls)==null||n.once(e,t)}off(e,t,i){var n;(n=this.hls)==null||n.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${ca(this.assetItem)} ${(e=this.hls)==null?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}const y2=.033;class AM extends as{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((i,n)=>e<=n.startOffset&&t>n.startOffset?(delete n.error,i+1):i,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);const n=this.items;if(n)for(n[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(s=n[i])!=null&&s.event;){var s;i--}return i}findItemIndexAtTime(e,t){const i=this.items;if(i)for(let n=0;n<i.length;n++){let s=i[n];if(t&&t!=="primary"&&(s=s[t]),e===s.start||e>s.start&&e<s.end)return n}return-1}findJumpRestrictedIndex(e,t){const i=this.items;if(i)for(let n=e;n<=t&&i[n];n++){const s=i[n].event;if(s!=null&&s.restrictions.jump&&!s.appendInPlace)return n}return-1}findEventIndex(e){const t=this.items;if(t)for(let n=t.length;n--;){var i;if(((i=t[n].event)==null?void 0:i.identifier)===e)return n}return-1}findAssetIndex(e,t){const i=e.assetList,n=i.length;if(n>1)for(let s=0;s<n;s++){const o=i[s];if(!o.error){const a=o.timelineStart;if(t===a||t>a&&(t<a+(o.duration||0)||s===n-1))return s}}return 0}get assetIdAtEnd(){var e;const t=(e=this.items)==null||(e=e[this.length-1])==null?void 0:e.event;if(t){const i=t.assetList,n=i[i.length-1];if(n)return n.identifier}return null}parseInterstitialDateRanges(e,t){const i=e.main.details,{dateRanges:n}=i,s=this.events,o=this.parseDateRanges(n,{url:i.url},t),a=Object.keys(n),l=s?s.filter(c=>!a.includes(c.identifier)):[];o.length&&o.sort((c,u)=>{const h=c.cue.pre,f=c.cue.post,d=u.cue.pre,m=u.cue.post;if(h&&!d)return-1;if(d&&!h||f&&!m)return 1;if(m&&!f)return-1;if(!h&&!d&&!f&&!m){const A=c.startTime,p=u.startTime;if(A!==p)return A-p}return c.dateRange.tagOrder-u.dateRange.tagOrder}),this.events=o,l.forEach(c=>{this.removeEvent(c)}),this.updateSchedule(e,l)}updateSchedule(e,t=[],i=!1){const n=this.events||[];if(n.length||t.length||this.length<2){const s=this.items,o=this.parseSchedule(n,e);(i||t.length||s?.length!==o.length||o.some((l,c)=>Math.abs(l.playout.start-s[c].playout.start)>.005||Math.abs(l.playout.end-s[c].playout.end)>.005))&&(this.items=o,this.onScheduleUpdate(t,s))}}parseDateRanges(e,t,i){const n=[],s=Object.keys(e);for(let o=0;o<s.length;o++){const a=s[o],l=e[a];if(l.isInterstitial){let c=this.eventMap[a];c?c.setDateRange(l):(c=new fM(l,t),this.eventMap[a]=c,i===!1&&(c.appendInPlace=i)),n.push(c)}}return n}parseSchedule(e,t){const i=[],n=t.main.details,s=n.live?1/0:n.edge;let o=0;if(e=e.filter(l=>!l.error&&!(l.cue.once&&l.hasPlayed)),e.length){this.resolveOffsets(e,t);let l=0,c=0;if(e.forEach((u,h)=>{const f=u.cue.pre,d=u.cue.post,m=e[h-1]||null,A=u.appendInPlace,p=d?s:u.startOffset,y=u.duration,v=u.timelineOccupancy===Hh.Range?y:0,E=u.resumptionOffset,x=m?.startTime===p,I=p+u.cumulativeDuration;let C=A?I+y:p+E;if(f||!d&&p<=0){const S=c;c+=v,u.timelineStart=I;const b=o;o+=y,i.push({event:u,start:I,end:C,playout:{start:b,end:o},integrated:{start:S,end:c}})}else if(p<=s){if(!x){const T=p-l;if(T>y2){const R=l,w=c;c+=T;const B=o;o+=T;const M={previousEvent:e[h-1]||null,nextEvent:u,start:R,end:R+T,playout:{start:B,end:o},integrated:{start:w,end:c}};i.push(M)}else T>0&&m&&(m.cumulativeDuration+=T,i[i.length-1].end=p)}d&&(C=I),u.timelineStart=I;const S=c;c+=v;const b=o;o+=y,i.push({event:u,start:I,end:C,playout:{start:b,end:o},integrated:{start:S,end:c}})}else return;const _=u.resumeTime;d||_>s?l=s:l=_}),l<s){var a;const u=l,h=c,f=s-l;c+=f;const d=o;o+=f,i.push({previousEvent:((a=i[i.length-1])==null?void 0:a.event)||null,nextEvent:null,start:l,end:u+f,playout:{start:d,end:o},integrated:{start:h,end:c}})}this.setDurations(s,o,c)}else i.push({previousEvent:null,nextEvent:null,start:0,end:s,playout:{start:0,end:s},integrated:{start:0,end:s}}),this.setDurations(s,s,s);return i}setDurations(e,t,i){this.durations={primary:e,playout:t,integrated:i}}resolveOffsets(e,t){const i=t.main.details,n=i.live?1/0:i.edge;let s=0,o=-1;e.forEach((a,l)=>{const c=a.cue.pre,u=a.cue.post,h=c?0:u?n:a.startTime;this.updateAssetDurations(a),o===h?a.cumulativeDuration=s:(s=0,o=h),!u&&a.snapOptions.in&&(a.resumeAnchor=yo(null,i.fragments,a.startOffset+a.resumptionOffset,0,0)||void 0),a.appendInPlace&&!a.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(a,t)||(a.appendInPlace=!1)),!a.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<y2&&(e[l+1].appendInPlace=!1,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${a}`));const d=He(a.resumeOffset)?a.resumeOffset:a.duration;s+=d})}primaryCanResumeInPlaceAt(e,t){const i=e.resumeTime,n=e.startTime+e.resumptionOffset;return Math.abs(i-n)>Ta?(this.log(`"${e.identifier}" resumption ${i} not aligned with estimated timeline end ${n}`),!1):!Object.keys(t).some(o=>{const a=t[o].details,l=a.edge;if(i>=l)return this.log(`"${e.identifier}" resumption ${i} past ${o} playlist end ${l}`),!1;const c=yo(null,a.fragments,i);if(!c)return this.log(`"${e.identifier}" resumption ${i} does not align with any fragments in ${o} playlist (${a.fragStart}-${a.fragmentEnd})`),!0;const u=o==="audio"?.175:0;return Math.abs(c.start-i)<Ta+u||Math.abs(c.end-i)<Ta+u?!1:(this.log(`"${e.identifier}" resumption ${i} not aligned with ${o} fragment bounds (${c.start}-${c.end} sn: ${c.sn} cc: ${c.cc})`),!0)})}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let i=0,n=!1,s=!1;for(let o=0;o<e.assetList.length;o++){const a=e.assetList[o],l=t+i;a.startOffset=i,a.timelineStart=l,n||(n=a.duration===null),s||(s=!!a.error);const c=a.error?0:a.duration||0;i+=c}n&&!s?e.duration=Math.max(i,e.duration):e.duration=i}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function gs(r){return`[${r.event?'"'+r.event.identifier+'"':"primary"}: ${r.start.toFixed(2)}-${r.end.toFixed(2)}]`}class pM{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const i=e.assetListUrl;let n;try{n=mC(i,this.hls.sessionId,e.baseUrl)}catch(f){const d=this.assignAssetListError(e,ue.ASSET_LIST_LOAD_ERROR,f,i);this.hls.trigger(L.ERROR,d);return}t&&n.protocol!=="data:"&&n.searchParams.set("_HLS_start_offset",""+t);const s=this.hls.config,o=s.loader,a=new o(s),l={responseType:"json",url:n.href},c=s.interstitialAssetListLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{const p=f.data,y=p?.ASSETS;if(!Array.isArray(y)){const v=this.assignAssetListError(e,ue.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),m.url,d,A);this.hls.trigger(L.ERROR,v);return}e.assetListResponse=p,this.hls.trigger(L.ASSET_LIST_LOADED,{event:e,assetListResponse:p,networkDetails:A})},onError:(f,d,m,A)=>{const p=this.assignAssetListError(e,ue.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${f.code} ${f.text} (${d.url})`),d.url,A,m);this.hls.trigger(L.ERROR,p)},onTimeout:(f,d,m)=>{const A=this.assignAssetListError(e,ue.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${d.url})`),d.url,f,m);this.hls.trigger(L.ERROR,A)}};return a.load(l,u,h),this.hls.trigger(L.ASSET_LIST_LOADING,{event:e}),a}assignAssetListError(e,t,i,n,s,o){return e.error=i,{type:Je.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:n,error:i,networkDetails:o,stats:s}}}function v2(r){var e;r==null||(e=r.play())==null||e.catch(()=>{})}function xu(r,e){return`[${r}] Advancing timeline position to ${e}`}class gM extends as{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled||!this.schedule)return;const n=i-this.timelinePos;if(Math.abs(n)<1/7056e5)return;const o=n<=-.01;this.timelinePos=i,this.bufferedPos=i;const a=this.playingItem;if(!a){this.checkBuffer();return}if(o&&this.schedule.resetErrorsInRange(i,i-n)&&this.updateSchedule(!0),this.checkBuffer(),o&&i<a.start||i>=a.end){var l;const d=this.findItemIndex(a);let m=this.schedule.findItemIndexAtTime(i);if(m===-1&&(m=d+(o?-1:1),this.log(`seeked ${o?"back ":""}to position not covered by schedule ${i} (resolving from ${d} to ${m})`)),!this.isInterstitial(a)&&(l=this.media)!=null&&l.paused&&(this.shouldPlay=!1),!o&&m>d){const A=this.schedule.findJumpRestrictedIndex(d+1,m);if(A>d){this.setSchedulePosition(A);return}}this.setSchedulePosition(m);return}const c=this.playingAsset;if(!c){if(this.playingLastItem&&this.isInterstitial(a)){const d=a.event.assetList[0];d&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(i,d))}return}const u=c.timelineStart,h=c.duration||0;if(o&&i<u||i>=u+h){var f;(f=a.event)!=null&&f.appendInPlace&&(this.clearInterstitial(a.event,a),this.flushFrontBuffer(i)),this.setScheduleToAssetAtTime(i,c)}},this.onTimeupdate=()=>{const i=this.currentTime;if(i===void 0||this.playbackDisabled)return;if(i>this.timelinePos)this.timelinePos=i,i>this.bufferedPos&&this.checkBuffer();else return;const n=this.playingItem;if(!n||this.playingLastItem)return;if(i>=n.end){this.timelinePos=n.end;const a=this.findItemIndex(n);this.setSchedulePosition(a+1)}const s=this.playingAsset;if(!s)return;const o=s.timelineStart+(s.duration||0);i>=o&&this.setScheduleToAssetAtTime(i,s)},this.onScheduleUpdate=(i,n)=>{const s=this.schedule;if(!s)return;const o=this.playingItem,a=s.events||[],l=s.items||[],c=s.durations,u=i.map(A=>A.identifier),h=!!(a.length||u.length);(h||n)&&this.log(`INTERSTITIALS_UPDATED (${a.length}): ${a}
Schedule: ${l.map(A=>gs(A))} pos: ${this.timelinePos}`),u.length&&this.log(`Removed events ${u}`);let f=null,d=null;o&&(f=this.updateItem(o,this.timelinePos),this.itemsMatch(o,f)?this.playingItem=f:this.waitingItem=this.endedItem=null),this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const m=this.bufferingItem;if(m&&(d=this.updateItem(m,this.bufferedPos),this.itemsMatch(m,d)?this.bufferingItem=d:m.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(m.event,null))),i.forEach(A=>{A.assetList.forEach(p=>{this.clearAssetPlayer(p.identifier,null)})}),this.playerQueue.forEach(A=>{if(A.interstitial.appendInPlace){const p=A.assetItem.timelineStart,y=A.timelineOffset-p;if(y)try{A.timelineOffset=p}catch(v){Math.abs(y)>Ta&&this.warn(`${v} ("${A.assetId}" ${A.timelineOffset}->${p})`)}}}),h||n){if(this.hls.trigger(L.INTERSTITIALS_UPDATED,{events:a.slice(0),schedule:l.slice(0),durations:c,removedIds:u}),this.isInterstitial(o)&&u.includes(o.event.identifier)){this.warn(`Interstitial "${o.event.identifier}" removed while playing`),this.primaryFallback(o.event);return}o&&this.trimInPlace(f,o),m&&d!==f&&this.trimInPlace(d,m),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new pM(e),this.schedule=new AM(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e&&(e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(L.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(L.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(L.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(L.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(L.BUFFER_APPENDED,this.onBufferAppended,this),e.on(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(L.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(L.MEDIA_ENDED,this.onMediaEnded,this),e.on(L.ERROR,this.onError,this),e.on(L.DESTROYING,this.onDestroying,this))}unregisterListeners(){const e=this.hls;e&&(e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(L.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(L.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(L.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(L.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(L.BUFFER_CODECS,this.onBufferCodecs,this),e.off(L.BUFFER_APPENDED,this.onBufferAppended,this),e.off(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(L.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(L.MEDIA_ENDED,this.onMediaEnded,this),e.off(L.ERROR,this.onError,this),e.off(L.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()}pauseBuffering(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.schedule=this.manager=null,this.hls=this.HlsPlayerClass=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){Cn(e,"play",this.onPlay),Cn(e,"pause",this.onPause),Cn(e,"seeking",this.onSeeking),Cn(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const i=this.media=t.media;un(i,"seeking",this.onSeeking),un(i,"timeupdate",this.onTimeupdate),un(i,"play",this.onPlay),un(i,"pause",this.onPause)}onMediaAttached(e,t){const i=this.effectivePlayingItem,n=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!n){this.clearScheduleState();const s=this.findItemIndex(i);this.setSchedulePosition(s)}}clearScheduleState(){this.log("clear schedule state"),this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const i=!!t.transferMedia,n=this.media;if(this.media=null,!i&&(n&&this.removeMediaListeners(n),this.detachedData)){const s=this.getBufferingPlayer();s&&(this.log(`Removing schedule state for detachedData and ${s}`),this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,s.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.hls)return null;if(this.manager)return this.manager;const e=this,t=()=>e.bufferingItem||e.waitingItem,i=h=>h&&e.getAssetPlayer(h.identifier),n=(h,f,d,m,A)=>{if(h){let p=h[f].start;const y=h.event;if(y){if(f==="playout"||y.timelineOccupancy!==Hh.Point){const v=i(d);v?.interstitial===y&&(p+=v.assetItem.startOffset+v[A])}}else{const v=m==="bufferedPos"?o():e[m];p+=v-h.start}return p}return 0},s=(h,f)=>{var d;if(h!==0&&f!=="primary"&&(d=e.schedule)!=null&&d.length){var m;const A=e.schedule.findItemIndexAtTime(h),p=(m=e.schedule.items)==null?void 0:m[A];if(p){const y=p[f].start-p.start;return h+y}}return h},o=()=>{const h=e.bufferedPos;return h===Number.MAX_VALUE?a("primary"):Math.max(h,0)},a=h=>{var f,d;return(f=e.primaryDetails)!=null&&f.live?e.primaryDetails.edge:((d=e.schedule)==null?void 0:d.durations[h])||0},l=(h,f)=>{var d,m;const A=e.effectivePlayingItem;if(A!=null&&(d=A.event)!=null&&d.restrictions.skip||!e.schedule)return;e.log(`seek to ${h} "${f}"`);const p=e.effectivePlayingItem,y=e.schedule.findItemIndexAtTime(h,f),v=(m=e.schedule.items)==null?void 0:m[y],E=e.getBufferingPlayer(),x=E?.interstitial,I=x?.appendInPlace,C=p&&e.itemsMatch(p,v);if(p&&(I||C)){const _=i(e.playingAsset),S=_?.media||e.primaryMedia;if(S){const b=f==="primary"?S.currentTime:n(p,f,e.playingAsset,"timelinePos","currentTime"),T=h-b,R=(I?b:S.currentTime)+T;if(R>=0&&(!_||I||R<=_.duration)){S.currentTime=R;return}}}if(v){let _=h;if(f!=="primary"){const b=v[f].start,T=h-b;_=v.start+T}const S=!e.isInterstitial(v);if((!e.isInterstitial(p)||p.event.appendInPlace)&&(S||v.event.appendInPlace)){const b=e.media||(I?E?.media:null);b&&(b.currentTime=_)}else if(p){const b=e.findItemIndex(p);if(y>b){const R=e.schedule.findJumpRestrictedIndex(b+1,y);if(R>b){e.setSchedulePosition(R);return}}let T=0;if(S)e.timelinePos=_,e.checkBuffer();else{const R=v.event.assetList,w=h-(v[f]||v).start;for(let B=R.length;B--;){const M=R[B];if(M.duration&&w>=M.startOffset&&w<M.startOffset+M.duration){T=B;break}}}e.setSchedulePosition(y,T)}}},c=()=>{const h=e.effectivePlayingItem;if(e.isInterstitial(h))return h;const f=t();return e.isInterstitial(f)?f:null},u={get bufferedEnd(){const h=t(),f=e.bufferingItem;if(f&&f===h){var d;return n(f,"playout",e.bufferingAsset,"bufferedPos","bufferedEnd")-f.playout.start||((d=e.bufferingAsset)==null?void 0:d.startOffset)||0}return 0},get currentTime(){const h=c(),f=e.effectivePlayingItem;return f&&f===h?n(f,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-f.playout.start:0},set currentTime(h){const f=c(),d=e.effectivePlayingItem;d&&d===f&&l(h+d.playout.start,"playout")},get duration(){const h=c();return h?h.playout.end-h.playout.start:0},get assetPlayers(){var h;const f=(h=c())==null?void 0:h.event.assetList;return f?f.map(d=>e.getAssetPlayer(d.identifier)):[]},get playingIndex(){var h;const f=(h=c())==null?void 0:h.event;return f&&e.effectivePlayingAsset?f.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return c()}};return this.manager={get events(){var h;return((h=e.schedule)==null||(h=h.events)==null?void 0:h.slice(0))||[]},get schedule(){var h;return((h=e.schedule)==null||(h=h.items)==null?void 0:h.slice(0))||[]},get interstitialPlayer(){return c()?u:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const h=t();return e.findItemIndex(h)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const h=e.effectivePlayingItem;return e.findItemIndex(h)},primary:{get bufferedEnd(){return o()},get currentTime(){const h=e.timelinePos;return h>0?h:0},set currentTime(h){l(h,"primary")},get duration(){return a("primary")},get seekableStart(){var h;return((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0}},integrated:{get bufferedEnd(){return n(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return n(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(h){l(h,"integrated")},get duration(){return a("integrated")},get seekableStart(){var h;return s(((h=e.primaryDetails)==null?void 0:h.fragmentStart)||0,"integrated")}},skip:()=>{const h=e.effectivePlayingItem,f=h?.event;if(f&&!f.restrictions.skip){const d=e.findItemIndex(h);if(f.appendInPlace){const m=h.playout.start+h.event.duration;l(m+.001,"playout")}else e.advanceAfterAssetEnded(f,d,1/0)}}}}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}get playbackStarted(){return this.effectivePlayingItem!==null}get currentTime(){var e,t;if(this.mediaSelection===null)return;const i=this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&!i.event.appendInPlace)return;let n=this.media;!n&&(e=this.bufferingItem)!=null&&(e=e.event)!=null&&e.appendInPlace&&(n=this.primaryMedia);const s=(t=n)==null?void 0:t.currentTime;if(!(s===void 0||!He(s)))return s}get primaryMedia(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}isInterstitial(e){return!!(e!=null&&e.event)}retreiveMediaSource(e,t){const i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)}transferMediaFromPlayer(e,t){const i=e.interstitial.appendInPlace,n=e.media;if(i&&n===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&n){this.detachedData={media:n};return}const s=e.transferMedia();this.log(`transfer MediaSource from ${e} ${Xt(s)}`),this.detachedData=s}else t&&n&&(this.shouldPlay||(this.shouldPlay=!n.paused))}transferMediaTo(e,t){var i,n;if(e.media===t)return;let s=null;const o=this.hls,a=e!==o,l=a&&e.interstitial.appendInPlace,c=(i=this.detachedData)==null?void 0:i.mediaSource;let u;if(o.media)l&&(s=o.transferMedia(),this.detachedData=s),u="Primary";else if(c){const m=this.getBufferingPlayer();m?(s=m.transferMedia(),u=`${m}`):u="detached MediaSource"}else u="detached media";if(!s){if(c)s=this.detachedData,this.log(`using detachedData: MediaSource ${Xt(s)}`);else if(!this.detachedData||o.media===t){const m=this.playerQueue;m.length>1&&m.forEach(A=>{if(a&&A.interstitial.appendInPlace!==l){const p=A.interstitial;this.clearInterstitial(A.interstitial,null),p.appendInPlace=!1,p.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${p}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}}const h=s&&"mediaSource"in s&&((n=s.mediaSource)==null?void 0:n.readyState)!=="closed",f=h&&s?s:t;this.log(`${h?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${u} (media.currentTime: ${t.currentTime})`);const d=this.schedule;if(f===s&&d){const m=a&&e.assetId===d.assetIdAtEnd;f.overrides={duration:d.duration,endOfStream:!a||m,cueRemoval:!a}}e.attachMedia(f)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e?.events;if(!t||this.playbackDisabled||!this.media)return;this.bufferedPos===-1&&(this.bufferedPos=0);const i=this.timelinePos,n=this.effectivePlayingItem;if(i===-1){const s=this.hls.startPosition;if(this.log(xu("checkStart",s)),this.timelinePos=s,t.length&&t[0].cue.pre){const o=e.findEventIndex(t[0].identifier);this.setSchedulePosition(o)}else if(s>=0||!this.primaryLive){const o=this.timelinePos=s>0?s:0,a=e.findItemIndexAtTime(o);this.setSchedulePosition(a)}}else if(n&&!this.playingItem){const s=e.findItemIndex(n);this.setSchedulePosition(s)}}advanceAssetBuffering(e,t){const i=e.event,n=i.findAssetIndex(t),s=qd(i,n);if(!i.isAssetPastPlayoutLimit(s))this.bufferedToEvent(e,s);else if(this.schedule){var o;const a=(o=this.schedule.items)==null?void 0:o[this.findItemIndex(e)+1];a&&this.bufferedToItem(a)}}advanceAfterAssetEnded(e,t,i){const n=qd(e,i);if(e.isAssetPastPlayoutLimit(n)){if(this.schedule){const s=this.schedule.items;if(s){const o=t+1,a=s.length;if(o>=a){this.setSchedulePosition(-1);return}const l=e.resumeTime;this.timelinePos<l&&(this.log(xu("advanceAfterAssetEnded",l)),this.timelinePos=l,e.appendInPlace&&this.advanceInPlace(l),this.checkBuffer(this.bufferedPos<l)),this.setSchedulePosition(o)}}}else{if(e.appendInPlace){const s=e.assetList[n];s&&this.advanceInPlace(s.timelineStart)}this.setSchedulePosition(t,n)}}setScheduleToAssetAtTime(e,t){const i=this.schedule;if(!i)return;const n=t.parentIdentifier,s=i.getEvent(n);if(s){const o=i.findEventIndex(n),a=i.findAssetIndex(s,e);this.advanceAfterAssetEnded(s,o,a-1)}}setSchedulePosition(e,t){var i;const n=(i=this.schedule)==null?void 0:i.items;if(!n||this.playbackDisabled)return;const s=e>=0?n[e]:null;this.log(`setSchedulePosition ${e}, ${t} (${s&&gs(s)}) pos: ${this.timelinePos}`);const o=this.waitingItem||this.playingItem,a=this.playingLastItem;if(this.isInterstitial(o)){const u=o.event,h=this.playingAsset,f=h?.identifier,d=f?this.getAssetPlayer(f):null;if(d&&f&&(!this.eventItemsMatch(o,s)||t!==void 0&&f!==u.assetList[t].identifier)){var l;const m=u.findAssetIndex(h);if(this.log(`INTERSTITIAL_ASSET_ENDED ${m+1}/${u.assetList.length} ${ca(h)}`),this.endedAsset=h,this.playingAsset=null,this.hls.trigger(L.INTERSTITIAL_ASSET_ENDED,{asset:h,assetListIndex:m,event:u,schedule:n.slice(0),scheduleIndex:e,player:d}),o!==this.playingItem){this.itemsMatch(o,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(u,this.findItemIndex(this.playingItem),m);return}this.retreiveMediaSource(f,s),d.media&&!((l=this.detachedData)!=null&&l.mediaSource)&&d.detachMedia()}if(!this.eventItemsMatch(o,s)&&(this.endedItem=o,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${u} ${gs(o)}`),u.hasPlayed=!0,this.hls.trigger(L.INTERSTITIAL_ENDED,{event:u,schedule:n.slice(0),scheduleIndex:e}),u.cue.once)){var c;this.updateSchedule();const m=(c=this.schedule)==null?void 0:c.items;if(s&&m){const A=this.findItemIndex(s);this.advanceSchedule(A,m,t,o,a)}return}}this.advanceSchedule(e,n,t,o,a)}advanceSchedule(e,t,i,n,s){const o=this.schedule;if(!o)return;const a=t[e]||null,l=this.primaryMedia,c=this.playerQueue;if(c.length&&c.forEach(u=>{const h=u.interstitial,f=o.findEventIndex(h.identifier);(f<e||f>e+1)&&this.clearInterstitial(h,a)}),this.isInterstitial(a)){this.timelinePos=Math.min(Math.max(this.timelinePos,a.start),a.end);const u=a.event;if(i===void 0){i=o.findAssetIndex(u,this.timelinePos);const m=qd(u,i-1);if(u.isAssetPastPlayoutLimit(m)||u.appendInPlace&&this.timelinePos===a.end){this.advanceAfterAssetEnded(u,e,i);return}i=m}const h=this.waitingItem;this.assetsBuffered(a,l)||this.setBufferingItem(a);let f=this.preloadAssets(u,i);if(this.eventItemsMatch(a,h||n)||(this.waitingItem=a,this.log(`INTERSTITIAL_STARTED ${gs(a)} ${u.appendInPlace?"append in place":""}`),this.hls.trigger(L.INTERSTITIAL_STARTED,{event:u,schedule:t.slice(0),scheduleIndex:e})),!u.assetListLoaded){this.log(`Waiting for ASSET-LIST to complete loading ${u}`);return}if(u.assetListLoader&&(u.assetListLoader.destroy(),u.assetListLoader=void 0),!l){this.log(`Waiting for attachMedia to start Interstitial ${u}`);return}this.waitingItem=this.endedItem=null,this.playingItem=a;const d=u.assetList[i];if(!d){this.advanceAfterAssetEnded(u,e,i||0);return}if(f||(f=this.getAssetPlayer(d.identifier)),f===null||f.destroyed){const m=u.assetList.length;this.warn(`asset ${i+1}/${m} player destroyed ${u}`),f=this.createAssetPlayer(u,d,i),f.loadSource()}if(!this.eventItemsMatch(a,this.bufferingItem)&&u.appendInPlace&&this.isAssetBuffered(d))return;this.startAssetPlayer(f,i,t,e,l),this.shouldPlay&&v2(f.media)}else a?(this.resumePrimary(a,e,n),this.shouldPlay&&v2(this.hls.media)):s&&this.isInterstitial(n)&&(this.endedItem=null,this.playingItem=n,n.event.appendInPlace||this.attachPrimary(o.durations.primary,null))}get playbackDisabled(){return this.hls.config.enableInterstitialPlayback===!1}get primaryDetails(){var e;return(e=this.mediaSelection)==null?void 0:e.main.details}get primaryLive(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}resumePrimary(e,t,i){var n,s;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${gs(e)}`),!((n=this.detachedData)!=null&&n.mediaSource)){let a=this.timelinePos;(a<e.start||a>=e.end)&&(a=this.getPrimaryResumption(e,t),this.log(xu("resumePrimary",a)),this.timelinePos=a),this.attachPrimary(a,e)}if(!i)return;const o=(s=this.schedule)==null?void 0:s.items;o&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${gs(e)}`),this.hls.trigger(L.INTERSTITIALS_PRIMARY_RESUMED,{schedule:o.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const i=e.start;if(this.primaryLive){const n=this.primaryDetails;if(t===0)return this.hls.startPosition;if(n&&(i<n.fragmentStart||i>n.edge))return this.hls.liveSyncPosition||-1}return i}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return t!=null&&t.hls?t.hls.bufferedToEnd:dt.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const n=this.primaryMedia;if(!n)return;const s=this.hls;s.media?this.checkBuffer():(this.transferMediaTo(s,n),i&&this.startLoadingPrimaryAt(e,i)),i||(this.log(xu("attachPrimary",e)),this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}startLoadingPrimaryAt(e,t){var i;const n=this.hls;!n.loadingEnabled||!n.media||Math.abs((((i=n.mainForwardBufferInfo)==null?void 0:i.start)||n.media.currentTime)-e)>.5?n.startLoad(e,t):n.bufferingEnabled||n.resumeBuffering()}onManifestLoading(){var e;this.stopLoad(),(e=this.schedule)==null||e.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(L.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(L.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(t.level===-1||!this.schedule)return;const i=this.hls.levels[t.level];if(!i.details)return;const n=Ht(Ht({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=n,this.schedule.parseInterstitialDateRanges(n,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const i=this.hls.audioTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=Ht(Ht({},this.altSelection),{},{audio:i});return}const s=Ht(Ht({},n),{},{audio:i});this.mediaSelection=s}onSubtitleTrackUpdated(e,t){const i=this.hls.subtitleTracks[t.id],n=this.mediaSelection;if(!n){this.altSelection=Ht(Ht({},this.altSelection),{},{subtitles:i});return}const s=Ht(Ht({},n),{},{subtitles:i});this.mediaSelection=s}onAudioTrackSwitching(e,t){const i=wy(t);this.playerQueue.forEach(({hls:n})=>n&&(n.setAudioOption(t)||n.setAudioOption(i)))}onSubtitleTrackSwitch(e,t){const i=wy(t);this.playerQueue.forEach(({hls:n})=>n&&(n.setSubtitleOption(t)||t.id!==-1&&n.setSubtitleOption(i)))}onBufferCodecs(e,t){const i=t.tracks;i&&(this.requiredTracks=i)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){const n=this.timelinePos;this.bufferedPos=n,this.checkBuffer()}}onBufferedToEnd(e){if(!this.schedule)return;const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let n=0;n<t.length;n++){const s=t[n];if(s.cue.post){var i;const o=this.schedule.findEventIndex(s.identifier),a=(i=this.schedule.items)==null?void 0:i[o];this.isInterstitial(a)&&this.eventItemsMatch(a,this.bufferingItem)&&this.bufferedToItem(a,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1}updateItem(e,t){var i;const n=(i=this.schedule)==null?void 0:i.items;if(e&&n){const s=this.findItemIndex(e,t);return n[s]||null}return null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((s,o)=>{e.event.isAssetPastPlayoutLimit(o)&&this.clearAssetPlayer(s.identifier,null)});const i=e.end+.25,n=dt.bufferInfo(this.primaryMedia,i,0);(n.end>i||(n.nextStart||0)>i)&&(this.log(`trim buffered interstitial ${gs(e)} (was ${gs(t)})`),this.attachPrimary(i,null,!0),this.flushFrontBuffer(i))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))}findItemIndex(e,t){return e&&this.schedule?this.schedule.findItemIndex(e,t):-1}updateSchedule(e=!1){var t;const i=this.mediaSelection;i&&((t=this.schedule)==null||t.updateSchedule(i,[],e))}checkBuffer(e){var t;const i=(t=this.schedule)==null?void 0:t.items;if(!i)return;const n=dt.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=n.len<1),this.updateBufferedPos(n.end,i,e)}updateBufferedPos(e,t,i){const n=this.schedule,s=this.bufferingItem;if(this.bufferedPos>e||!n)return;if(t.length===1&&this.itemsMatch(t[0],s)){this.bufferedPos=e;return}const o=this.playingItem,a=this.findItemIndex(o);let l=n.findItemIndexAtTime(e);if(this.bufferedPos<e){var c;const u=this.findItemIndex(s),h=Math.min(u+1,t.length-1),f=t[h];if((l===-1&&s&&e>=s.end||(c=f.event)!=null&&c.appendInPlace&&e+.01>=f.start)&&(l=h),this.isInterstitial(s)){const d=s.event;if(h-a>1&&d.appendInPlace===!1||d.assetList.length===0&&d.assetListLoader)return}if(this.bufferedPos=e,l>u&&l>a)this.bufferedToItem(f);else{const d=this.primaryDetails;this.primaryLive&&d&&e>d.edge-d.targetduration&&f.start<d.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(f)&&this.preloadAssets(f.event,0)}}else i&&o&&!this.itemsMatch(o,s)&&(l===a?this.bufferedToItem(o):l===a+1&&this.bufferedToItem(t[l]))}assetsBuffered(e,t){return e.event.assetList.length===0?!1:!e.event.assetList.some(n=>{const s=this.getAssetPlayer(n.identifier);return!(s!=null&&s.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,i=this.schedule;if(!this.itemsMatch(e,t)&&i){const{items:n,events:s}=i;if(!n||!s)return t;const o=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const l=a?a.remaining:t?t.end-this.timelinePos:0;if(this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${gs(e)}`+(t?` (${l.toFixed(2)} remaining)`:"")),!this.playbackDisabled)if(o){const c=i.findAssetIndex(e.event,this.bufferedPos);e.event.assetList.forEach((u,h)=>{const f=this.getAssetPlayer(u.identifier);f&&(h===c&&f.loadSource(),f.resumeBuffering())})}else this.hls.resumeBuffering(),this.playerQueue.forEach(c=>c.pauseBuffering());this.hls.trigger(L.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:s.slice(0),schedule:n.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}else this.bufferingItem!==e&&(this.bufferingItem=e);return t}bufferedToItem(e,t=0){const i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;const n=this.detachedData;n?n.mediaSource?this.attachPrimary(e.start,e,!0):this.preloadPrimary(e):this.preloadPrimary(e)}}}preloadPrimary(e){const t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)}bufferedToEvent(e,t){const i=e.event,n=i.assetList.length===0&&!i.assetListLoader,s=i.cue.once;if(n||!s){const o=this.preloadAssets(i,t);if(o!=null&&o.interstitial.appendInPlace){const a=this.primaryMedia;a&&this.bufferAssetPlayer(o,a)}}}preloadAssets(e,t){const i=e.assetUrl,n=e.assetList.length,s=n===0&&!e.assetListLoader,o=e.cue.once;if(s){const l=e.timelineStart;if(e.appendInPlace){var a;const f=this.playingItem;!this.isInterstitial(f)&&(f==null||(a=f.nextEvent)==null?void 0:a.identifier)===e.identifier&&this.flushFrontBuffer(l+.25)}let c,u=0;if(!this.playingItem&&this.primaryLive&&(u=this.hls.startPosition,u===-1&&(u=this.hls.liveSyncPosition||0)),u&&!(e.cue.pre||e.cue.post)){const f=u-l;f>0&&(c=Math.round(f*1e3)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${i?1:n} ${e}${c?` live-start: ${u} start-offset: ${c}`:""}`),i)return this.createAsset(e,0,0,l,e.duration,i);const h=this.assetListLoader.loadAssetList(e,c);h&&(e.assetListLoader=h)}else if(!o&&n){for(let c=t;c<n;c++){const u=e.assetList[c],h=this.getAssetPlayerQueueIndex(u.identifier);(h===-1||this.playerQueue[h].destroyed)&&!u.error&&this.createAssetPlayer(e,u,c)}const l=e.assetList[t];if(l){const c=this.getAssetPlayer(l.identifier);return c&&c.loadSource(),c}}return null}flushFrontBuffer(e){const t=this.requiredTracks;if(!t)return;this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(n=>{this.hls.trigger(L.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:n})})}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t){for(let i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null}createAsset(e,t,i,n,s,o){const a={parentIdentifier:e.identifier,identifier:hM(e,o,t),duration:s,startOffset:i,timelineStart:n,uri:o};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,i){const n=this.hls,s=n.userConfig;let o=s.videoPreference;const a=n.loadLevelObj||n.levels[n.currentLevel];(o||a)&&(o=Yt({},o),a.videoCodec&&(o.videoCodec=a.videoCodec),a.videoRange&&(o.allowedVideoRanges=[a.videoRange]));const l=n.audioTracks[n.audioTrack],c=n.subtitleTracks[n.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const x=this.timelinePos-t.timelineStart;if(x>1){const I=t.duration;I&&x<I&&(u=x)}}const h=t.identifier,f=Ht(Ht({},s),{},{maxMaxBufferLength:Math.min(180,n.config.maxMaxBufferLength),autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:n.sessionId,assetPlayerId:h,abrEwmaDefaultEstimate:n.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:o,audioPreference:l||s.audioPreference,subtitlePreference:c||s.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(f.timelineOffset=t.timelineStart));const d=f.cmcd;d!=null&&d.sessionId&&d.contentId&&(f.cmcd=Yt({},d,{contentId:nc(t.uri)})),this.getAssetPlayer(h)&&this.warn(`Duplicate date range identifier ${e} and asset ${h}`);const m=new mM(this.HlsPlayerClass,f,e,t);this.playerQueue.push(m),e.assetList[i]=t;let A=!0;const p=x=>{if(x.live){var I;const S=new Error(`Interstitials MUST be VOD assets ${e}`),b={fatal:!0,type:Je.OTHER_ERROR,details:ue.INTERSTITIAL_ASSET_ITEM_ERROR,error:S},T=((I=this.schedule)==null?void 0:I.findEventIndex(e.identifier))||-1;this.handleAssetItemError(b,e,T,i,S.message);return}const C=x.edge-x.fragmentStart,_=t.duration;(A||_===null||C>_)&&(A=!1,this.log(`Interstitial asset "${h}" duration change ${_} > ${C}`),t.duration=C,this.updateSchedule())};m.on(L.LEVEL_UPDATED,(x,{details:I})=>p(I)),m.on(L.LEVEL_PTS_UPDATED,(x,{details:I})=>p(I)),m.on(L.EVENT_CUE_ENTER,()=>this.onInterstitialCueEnter());const y=(x,I)=>{const C=this.getAssetPlayer(h);if(C&&I.tracks){C.off(L.BUFFER_CODECS,y),C.tracks=I.tracks;const _=this.primaryMedia;this.bufferingAsset===C.assetItem&&_&&!C.media&&this.bufferAssetPlayer(C,_)}};m.on(L.BUFFER_CODECS,y);const v=()=>{var x;const I=this.getAssetPlayer(h);if(this.log(`buffered to end of asset ${I}`),!I||!this.schedule)return;const C=this.schedule.findEventIndex(e.identifier),_=(x=this.schedule.items)==null?void 0:x[C];this.isInterstitial(_)&&this.advanceAssetBuffering(_,t)};m.on(L.BUFFERED_TO_END,v);const E=x=>()=>{if(!this.getAssetPlayer(h)||!this.schedule)return;this.shouldPlay=!0;const C=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,C,x)};return m.once(L.MEDIA_ENDED,E(i)),m.once(L.PLAYOUT_LIMIT_REACHED,E(1/0)),m.on(L.ERROR,(x,I)=>{if(!this.schedule)return;const C=this.getAssetPlayer(h);if(I.details===ue.BUFFER_STALLED_ERROR){if(C!=null&&C.appendInPlace){this.handleInPlaceStall(e);return}this.onTimeupdate(),this.checkBuffer(!0);return}this.handleAssetItemError(I,e,this.schedule.findEventIndex(e.identifier),i,`Asset player error ${I.error} ${e}`)}),m.on(L.DESTROYING,()=>{if(!this.getAssetPlayer(h)||!this.schedule)return;const I=new Error(`Asset player destroyed unexpectedly ${h}`),C={fatal:!0,type:Je.OTHER_ERROR,details:ue.INTERSTITIAL_ASSET_ITEM_ERROR,error:I};this.handleAssetItemError(C,e,this.schedule.findEventIndex(e.identifier),i,I.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${ca(t)}`),this.hls.trigger(L.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:m}),m}clearInterstitial(e,t){e.assetList.forEach(i=>{this.clearAssetPlayer(i.identifier,t)}),e.reset()}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(t!==-1){this.log(`reset asset player "${e}" after error`);const i=this.playerQueue[t];this.transferMediaFromPlayer(i,null),i.resetDetails()}}clearAssetPlayer(e,t){const i=this.getAssetPlayerQueueIndex(e);if(i!==-1){const n=this.playerQueue[i];this.log(`clear ${n} toSegment: ${t&&gs(t)}`),this.transferMediaFromPlayer(n,t),this.playerQueue.splice(i,1),n.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,i,n,s){const{interstitial:o,assetItem:a,assetId:l}=e,c=o.assetList.length,u=this.playingAsset;this.endedAsset=null,this.playingAsset=a,(!u||u.identifier!==l)&&(u&&(this.clearAssetPlayer(u.identifier,i[n]),delete u.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${c} ${ca(a)}`),this.hls.trigger(L.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:o,schedule:i.slice(0),scheduleIndex:n,player:e})),this.bufferAssetPlayer(e,s)}bufferAssetPlayer(e,t){var i,n;if(!this.schedule)return;const{interstitial:s,assetItem:o}=e,a=this.schedule.findEventIndex(s.identifier),l=(i=this.schedule.items)==null?void 0:i[a];if(!l)return;e.loadSource(),this.setBufferingItem(l),this.bufferingAsset=o;const c=this.getBufferingPlayer();if(c===e)return;const u=s.appendInPlace;if(u&&c?.interstitial.appendInPlace===!1)return;const h=c?.tracks||((n=this.detachedData)==null?void 0:n.tracks)||this.requiredTracks;if(u&&o!==this.playingAsset){if(!e.tracks){this.log(`Waiting for track info before buffering ${e}`);return}if(h&&!zx(h,e.tracks)){const f=new Error(`Asset ${ca(o)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(h)}')`),d={fatal:!0,type:Je.OTHER_ERROR,details:ue.INTERSTITIAL_ASSET_ITEM_ERROR,error:f},m=s.findAssetIndex(o);this.handleAssetItemError(d,s,a,m,f.message);return}}this.transferMediaTo(e,t)}handleInPlaceStall(e){const t=this.schedule,i=this.primaryMedia;if(!t||!i)return;const n=i.currentTime,s=t.findAssetIndex(e,n),o=e.assetList[s];if(o){const a=this.getAssetPlayer(o.identifier);if(a){const l=a.currentTime||n-o.timelineStart,c=a.duration-l;if(this.warn(`Stalled at ${l} of ${l+c} in ${a} ${e} (media.currentTime: ${n})`),l&&(c/i.playbackRate<.5||a.bufferedInPlaceToEnd(i))&&a.hls){const u=t.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,u,s)}}}}advanceInPlace(e){const t=this.primaryMedia;t&&t.currentTime<e&&(t.currentTime=e)}handleAssetItemError(e,t,i,n,s){if(e.details===ue.BUFFER_STALLED_ERROR)return;const o=t.assetList[n]||null;if(this.warn(`INTERSTITIAL_ASSET_ERROR ${o&&ca(o)} ${e.error}`),!this.schedule)return;const a=o?.identifier||"",l=this.getAssetPlayerQueueIndex(a),c=this.playerQueue[l]||null,u=this.schedule.items,h=Yt({},e,{fatal:!1,errorAction:_a(!0),asset:o,assetListIndex:n,event:t,schedule:u,scheduleIndex:i,player:c});if(this.hls.trigger(L.INTERSTITIAL_ASSET_ERROR,h),!e.fatal)return;const f=this.playingAsset,d=this.bufferingAsset,m=new Error(s);if(o&&(this.clearAssetPlayer(a,null),o.error=m),!t.assetList.some(A=>!A.error))t.error=m;else for(let A=n;A<t.assetList.length;A++)this.resetAssetPlayer(t.assetList[A].identifier);this.updateSchedule(!0),t.error?this.primaryFallback(t):f&&f.identifier===a?this.advanceAfterAssetEnded(t,i,n):d&&d.identifier===a&&this.isInterstitial(this.bufferingItem)&&this.advanceAssetBuffering(this.bufferingItem,d)}primaryFallback(e){const t=e.timelineStart,i=this.effectivePlayingItem;if(i){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${gs(i)} error: ${e.error}`);let n=this.timelinePos;n===-1&&(n=this.hls.startPosition);const s=this.updateItem(i,n);if(this.itemsMatch(i,s)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t)),!this.schedule)return;const o=this.schedule.findItemIndexAtTime(n);this.setSchedulePosition(o)}else this.checkStart()}onAssetListLoaded(e,t){var i,n;const s=t.event,o=s.identifier,a=t.assetListResponse.ASSETS;if(!((i=this.schedule)!=null&&i.hasEvent(o)))return;const l=s.timelineStart,c=s.duration;let u=0;a.forEach((A,p)=>{const y=parseFloat(A.DURATION);this.createAsset(s,p,u,l+u,y,A.URI),u+=y}),s.duration=u,this.log(`Loaded asset-list with duration: ${u} (was: ${c}) ${s}`);const h=this.waitingItem,f=h?.event.identifier===o;this.updateSchedule();const d=(n=this.bufferingItem)==null?void 0:n.event;if(f){var m;const A=this.schedule.findEventIndex(o),p=(m=this.schedule.items)==null?void 0:m[A];if(p){if(!this.playingItem&&this.timelinePos>p.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==A){s.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${s}`),this.updateSchedule(!0),this.primaryFallback(s);return}this.setBufferingItem(p)}this.setSchedulePosition(A)}else if(d?.identifier===o){const A=s.assetList[0];if(A){const p=this.getAssetPlayer(A.identifier);if(d.appendInPlace){const y=this.primaryMedia;p&&y&&this.bufferAssetPlayer(p,y)}else p&&p.loadSource()}}}onError(e,t){if(this.schedule)switch(t.details){case ue.ASSET_LIST_PARSING_ERROR:case ue.ASSET_LIST_LOAD_ERROR:case ue.ASSET_LIST_LOAD_TIMEOUT:{const i=t.interstitial;i&&(this.updateSchedule(!0),this.primaryFallback(i));break}case ue.BUFFER_STALLED_ERROR:{const i=this.endedItem||this.waitingItem||this.playingItem;if(this.isInterstitial(i)&&i.event.appendInPlace){this.handleInPlaceStall(i.event);return}this.log(`Primary player stall @${this.timelinePos} bufferedPos: ${this.bufferedPos}`),this.onTimeupdate(),this.checkBuffer(!0);break}}}}const E2=500;class AC extends gf{constructor(e,t,i){super(e,t,i,"subtitle-stream-controller",$e.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(L.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(L.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(L.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(L.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=Te.IDLE,this.setInterval(E2),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:n}=t;if(this.fragContextChanged(i)||(Ri(i)&&(this.fragPrevious=i),this.state=Te.IDLE),!n)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let o;const a=i.start;for(let c=0;c<s.length;c++)if(a>=s[c].start&&a<=s[c].end){o=s[c];break}const l=i.start+i.duration;o?o.end=l:(o={start:a,end:l},s.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:i,endOffset:n}=t;if(i===0&&n!==Number.POSITIVE_INFINITY){const s=n-1;if(s<=0)return;t.endOffsetSubtitles=Math.max(0,s),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=s){o.shift();continue}else if(o[a].start<s)o[a].start=s;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,s,$e.SUBTITLE)}}onError(e,t){const i=t.frag;i?.type===$e.SUBTITLE&&(t.details===ue.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==Te.STOPPED&&(this.state=Te.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&YI(this.levels,t)){this.levels=t.map(i=>new Fa(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const n=new Fa(i);return this.tracksBuffered[n.id]=[],n}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,$e.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const n=this.levels[this.currentTrackId];n!=null&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.state!==Te.STOPPED&&this.setInterval(E2)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:n,levels:s}=this,{details:o,id:a}=t;if(!s){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const l=s[a];if(a>=s.length||!l)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(o.live||(i=l.details)!=null&&i.live){if(o.deltaUpdateFailed)return;const h=this.mainDetails;if(!h){this.startFragRequested=!1;return}const f=h.fragments[0];if(!l.details)o.hasProgramDateTime&&h.hasProgramDateTime?(Qh(o,h),c=o.fragmentStart):f&&(c=f.start,Mm(o,c));else{var u;c=this.alignPlaylists(o,l.details,(u=this.levelLastLoaded)==null?void 0:u.details),c===0&&f&&(c=f.start,Mm(o,c))}h&&!this.startFragRequested&&this.setStartPosition(h,c)}l.details=o,this.levelLastLoaded=l,a===n&&(this.hls.trigger(L.SUBTITLE_TRACK_UPDATED,{details:o,id:a,groupId:t.groupId}),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===Te.IDLE&&(yo(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),l.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,n=t.decryptdata,s=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&n!=null&&n.key&&n.iv&&Sa(n.method)){const o=performance.now();this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer,YA(n.method)).catch(a=>{throw s.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const l=performance.now();s.trigger(L.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:l}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=Te.IDLE})}}doTick(){if(!this.media){this.state=Te.IDLE;return}if(this.state===Te.IDLE){const{currentTrackId:e,levels:t}=this,i=t?.[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;const{config:n}=this,s=this.getLoadPosition(),o=dt.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,n.maxBufferHole),{end:a,len:l}=o,c=i.details,u=this.hls.maxBufferLength+c.levelTargetDuration;if(l>u)return;const h=c.fragments,f=h.length,d=c.edge;let m=null;const A=this.fragPrevious;if(a<d){const v=n.maxFragLookUpTolerance,E=a>d-v?0:v;m=yo(A,h,Math.max(h[0].start,a),E),!m&&A&&A.start<h[0].start&&(m=h[0])}else m=h[f-1];if(m=this.filterReplacedPrimary(m,i.details),!m)return;const p=m.sn-c.startSN,y=h[p-1];if(y&&y.cc===m.cc&&this.fragmentTracker.getState(y)===Ni.NOT_LOADED&&(m=y),this.fragmentTracker.getState(m)===Ni.NOT_LOADED){const v=this.mapToInitFragWhenRequired(m);v&&this.loadFragment(v,i,a)}}}loadFragment(e,t,i){Ri(e)?super.loadFragment(e,t,i):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new yM(this.tracksBuffered[this.currentTrackId]||[])}}class yM{constructor(e){this.buffered=void 0;const t=(i,n,s)=>{if(n=n>>>0,n>s-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${n}) is greater than the maximum bound (${s})`);return e[n][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}const vM={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},pC=r=>String.fromCharCode(vM[r]||r),Es=15,rr=100,EM={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},xM={17:2,18:4,21:6,22:8,23:10,19:13,20:15},IM={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},CM={25:2,26:4,29:6,30:8,31:10,27:13,28:15},_M=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class SM{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;Kt.log(`${this.time} [${e}] ${i}`)}}}const so=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class gC{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const n=t[i];e.hasOwnProperty(n)&&(this[n]=e[n])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class TM{constructor(){this.uchar=" ",this.penState=new gC}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class bM{constructor(e){this.chars=[],this.pos=0,this.currPenState=new gC,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<rr;t++)this.chars.push(new TM);this.logger=e}equals(e){for(let t=0;t<rr;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<rr;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<rr;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>rr&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=rr)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=pC(e);if(this.pos>=rr){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<rr;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<rr;i++){const n=this.chars[i].uchar;n!==" "&&(t=!1),e.push(n)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Xd{constructor(e){this.rows=[],this.currRow=Es-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Es;t++)this.rows.push(new bM(e));this.logger=e}reset(){for(let e=0;e<Es;e++)this.rows[e].clear();this.currRow=Es-1}equals(e){let t=!0;for(let i=0;i<Es;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<Es;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Es;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+Xt(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<Es;a++)this.rows[a].clear();const s=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){const a=o.rows[s].cueStartTime,l=this.logger.time;if(a!==null&&l!==null&&a<l)for(let c=0;c<this.nrRollUpRows;c++)this.rows[t-this.nrRollUpRows+c+1].copy(o.rows[s+c])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const s=e.indent,o=Math.max(s-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}const n={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+Xt(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",n=-1;for(let s=0;s<Es;s++){const o=this.rows[s].getTextString();o&&(n=s+1,e?t.push("Row "+n+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class x2{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Xd(i),this.nonDisplayedMemory=new Xd(i),this.lastOutputScreen=new Xd(i),this.currRollUpRow=this.displayedMemory.rows[Es-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Es-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=n[i]}this.logger.log(2,"MIDROW: "+Xt(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class I2{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=BM(),this.logger=void 0;const n=this.logger=new SM;this.channels=[null,new x2(e,t,n),new x2(e+1,i,n)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const n=t[i]&127,s=t[i+1]&127;let o=!1,a=null;if(n===0&&s===0)continue;this.logger.log(3,()=>"["+so([t[i],t[i+1]])+"] -> ("+so([n,s])+")");const l=this.cmdHistory;if(n>=16&&n<=31){if(wM(n,s,l)){Iu(null,null,l),this.logger.log(3,()=>"Repeated command ("+so([n,s])+") is dropped");continue}Iu(n,s,this.cmdHistory),o=this.parseCmd(n,s),o||(o=this.parseMidrow(n,s)),o||(o=this.parsePAC(n,s)),o||(o=this.parseBackgroundAttributes(n,s))}else Iu(null,null,l);if(!o&&(a=this.parseChars(n,s),a)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+so([n,s])+" orig: "+so([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=33&&t<=35;if(!(i||n))return!1;const s=e===20||e===21||e===23?1:2,o=this.channels[s];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=s,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const n=this.channels[i];return n?(n.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+so([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const n=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,s=(e===16||e===24)&&t>=64&&t<=95;if(!(n||s))return!1;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?EM[e]:IM[e]:i=o===1?xM[e]:CM[e];const a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const n={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,n.underline=(i&1)===1,i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=Math.floor((i-16)/2)*4,n}parseChars(e,t){let i,n=null,s=null;if(e>=25?(i=2,s=e-8):(i=1,s=e),s>=17&&s<=19){let o;s===17?o=t+80:s===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+pC(o)+"' in channel "+i),n=[o]}else e>=32&&e<=127&&(n=t===0?[e]:[e,t]);return n&&this.logger.log(3,()=>"Char codes =  "+so(n).join(",")),n}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,n=(e===23||e===31)&&t>=45&&t<=47;if(!(i||n))return!1;let s;const o={};e===16||e===24?(s=Math.floor((t-32)/2),o.background=_M[s],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}Iu(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function Iu(r,e,t){t.a=r,t.b=e}function wM(r,e,t){return t.a===r&&t.b===e}function BM(){return{a:null,b:null}}var rp=(function(){if(Gh!=null&&Gh.VTTCue)return self.VTTCue;const r=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,l){if(typeof l!="string"||!Array.isArray(a))return!1;const c=l.toLowerCase();return~a.indexOf(c)?c:!1}function i(a){return t(r,a)}function n(a){return t(e,a)}function s(a,...l){let c=1;for(;c<arguments.length;c++){const u=arguments[c];for(const h in u)a[h]=u[h]}return a}function o(a,l,c){const u=this,h={enumerable:!0};u.hasBeenReset=!1;let f="",d=!1,m=a,A=l,p=c,y=null,v="",E=!0,x="auto",I="start",C=50,_="middle",S=50,b="middle";Object.defineProperty(u,"id",s({},h,{get:function(){return f},set:function(T){f=""+T}})),Object.defineProperty(u,"pauseOnExit",s({},h,{get:function(){return d},set:function(T){d=!!T}})),Object.defineProperty(u,"startTime",s({},h,{get:function(){return m},set:function(T){if(typeof T!="number")throw new TypeError("Start time must be set to a number.");m=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",s({},h,{get:function(){return A},set:function(T){if(typeof T!="number")throw new TypeError("End time must be set to a number.");A=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",s({},h,{get:function(){return p},set:function(T){p=""+T,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",s({},h,{get:function(){return y},set:function(T){y=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",s({},h,{get:function(){return v},set:function(T){const R=i(T);if(R===!1)throw new SyntaxError("An invalid or illegal string was specified.");v=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",s({},h,{get:function(){return E},set:function(T){E=!!T,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",s({},h,{get:function(){return x},set:function(T){if(typeof T!="number"&&T!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");x=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",s({},h,{get:function(){return I},set:function(T){const R=n(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");I=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",s({},h,{get:function(){return C},set:function(T){if(T<0||T>100)throw new Error("Position must be between 0 and 100.");C=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",s({},h,{get:function(){return _},set:function(T){const R=n(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");_=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",s({},h,{get:function(){return S},set:function(T){if(T<0||T>100)throw new Error("Size must be between 0 and 100.");S=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",s({},h,{get:function(){return b},set:function(T){const R=n(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");b=R,this.hasBeenReset=!0}})),u.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o})();class RM{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function yC(r){function e(i,n,s,o){return(i|0)*3600+(n|0)*60+(s|0)+parseFloat(o||0)}const t=r.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class DM{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let n=0;n<i.length;++n)if(t===i[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function vC(r,e,t,i){const n=i?r.split(i):[r];for(const s in n){if(typeof n[s]!="string")continue;const o=n[s].split(t);if(o.length!==2)continue;const a=o[0],l=o[1];e(a,l)}}const Gm=new rp(0,0,""),Cu=Gm.align==="middle"?"middle":"center";function MM(r,e,t){const i=r;function n(){const a=yC(r);if(a===null)throw new Error("Malformed timestamp: "+i);return r=r.replace(/^[^\sa-zA-Z-]+/,""),a}function s(a,l){const c=new DM;vC(a,function(f,d){let m;switch(f){case"region":for(let A=t.length-1;A>=0;A--)if(t[A].id===d){c.set(f,t[A].region);break}break;case"vertical":c.alt(f,d,["rl","lr"]);break;case"line":m=d.split(","),c.integer(f,m[0]),c.percent(f,m[0])&&c.set("snapToLines",!1),c.alt(f,m[0],["auto"]),m.length===2&&c.alt("lineAlign",m[1],["start",Cu,"end"]);break;case"position":m=d.split(","),c.percent(f,m[0]),m.length===2&&c.alt("positionAlign",m[1],["start",Cu,"end","line-left","line-right","auto"]);break;case"size":c.percent(f,d);break;case"align":c.alt(f,d,["start",Cu,"end","left","right"]);break}},/:/,/\s/),l.region=c.get("region",null),l.vertical=c.get("vertical","");let u=c.get("line","auto");u==="auto"&&Gm.line===-1&&(u=-1),l.line=u,l.lineAlign=c.get("lineAlign","start"),l.snapToLines=c.get("snapToLines",!0),l.size=c.get("size",100),l.align=c.get("align",Cu);let h=c.get("position","auto");h==="auto"&&Gm.position===50&&(h=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=h}function o(){r=r.replace(/^\s+/,"")}if(o(),e.startTime=n(),o(),r.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);r=r.slice(3),o(),e.endTime=n(),o(),s(r,e)}function EC(r){return r.replace(/<br(?: \/)?>/gi,`
`)}class LM{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new RM,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let s=t.buffer,o=0;for(s=EC(s);o<s.length&&s[o]!=="\r"&&s[o]!==`
`;)++o;const a=s.slice(0,o);return s[o]==="\r"&&++o,s[o]===`
`&&++o,t.buffer=s.slice(o),a}function n(s){vC(s,function(o,a){},/:/)}try{let s="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;s=i();const a=s.match(/^()?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:s=i(),t.state){case"HEADER":/:/.test(s)?n(s):s||(t.state="ID");continue;case"NOTE":s||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(s)){t.state="NOTE";break}if(!s)continue;if(t.cue=new rp(0,0,""),t.state="CUE",s.indexOf("-->")===-1){t.cue.id=s;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{MM(s,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=s.indexOf("-->")!==-1;if(!s||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=s}continue;case"BADCUE":s||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const PM=/\r\n|\n\r|\n|\r/g,Jd=function(e,t,i=0){return e.slice(i,i+t.length)===t},FM=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),s=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!He(t)||!He(i)||!He(n)||!He(s))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*n,t+=3600*1e3*s,t};function op(r,e,t){return nc(r.toString())+nc(e.toString())+nc(t)}const kM=function(e,t,i){let n=e[t],s=e[n.prevCC];if(!s||!s.new&&n.new){e.ccOffset=e.presentationOffset=n.start,n.new=!1;return}for(;(o=s)!=null&&o.new;){var o;e.ccOffset+=n.start-s.start,n.new=!1,n=s,s=e[n.prevCC]}e.presentationOffset=i};function OM(r,e,t,i,n,s,o){const a=new LM,l=Qn(new Uint8Array(r)).trim().replace(PM,`
`).split(`
`),c=[],u=e?X7(e.baseTime,e.timescale):0;let h="00:00.000",f=0,d=0,m,A=!0;a.oncue=function(p){const y=t[i];let v=t.ccOffset;const E=(f-u)/9e4;if(y!=null&&y.new&&(d!==void 0?v=t.ccOffset=y.start:kM(t,i,E)),E){if(!e){m=new Error("Missing initPTS for VTT MPEGTS");return}v=E-t.presentationOffset}const x=p.endTime-p.startTime,I=Pn((p.startTime+v-d)*9e4,n*9e4)/9e4;p.startTime=Math.max(I,0),p.endTime=Math.max(I+x,0);const C=p.text.trim();p.text=decodeURIComponent(encodeURIComponent(C)),p.id||(p.id=op(p.startTime,p.endTime,C)),p.endTime>0&&c.push(p)},a.onparsingerror=function(p){m=p},a.onflush=function(){if(m){o(m);return}s(c)},l.forEach(p=>{if(A)if(Jd(p,"X-TIMESTAMP-MAP=")){A=!1,p.slice(16).split(",").forEach(y=>{Jd(y,"LOCAL:")?h=y.slice(6):Jd(y,"MPEGTS:")&&(f=parseInt(y.slice(7)))});try{d=FM(h)/1e3}catch(y){m=y}return}else p===""&&(A=!1);a.parse(p+`
`)}),a.flush()}const Zd="stpp.ttml.im1t",xC=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,IC=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,UM={left:"start",center:"center",right:"end",start:"start",end:"end"};function C2(r,e,t,i){const n=It(new Uint8Array(r),["mdat"]);if(n.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const s=n.map(a=>Qn(a)),o=q7(e.baseTime,1,e.timescale);try{s.forEach(a=>t(NM(a,o)))}catch(a){i(a)}}function NM(r,e){const n=new DOMParser().parseFromString(r,"text/xml").getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(s).reduce((h,f)=>(h[f]=n.getAttribute(`ttp:${f}`)||s[f],h),{}),a=n.getAttribute("xml:space")!=="preserve",l=_2(e0(n,"styling","style")),c=_2(e0(n,"layout","region")),u=e0(n,"body","[begin]");return[].map.call(u,h=>{const f=CC(h,a);if(!f||!h.hasAttribute("begin"))return null;const d=i0(h.getAttribute("begin"),o),m=i0(h.getAttribute("dur"),o);let A=i0(h.getAttribute("end"),o);if(d===null)throw S2(h);if(A===null){if(m===null)throw S2(h);A=d+m}const p=new rp(d-e,A-e,f);p.id=op(p.startTime,p.endTime,p.text);const y=c[h.getAttribute("region")],v=l[h.getAttribute("style")],E=GM(y,v,l),{textAlign:x}=E;if(x){const I=UM[x];I&&(p.lineAlign=I),p.align=x}return Yt(p,E),p}).filter(h=>h!==null)}function e0(r,e,t){const i=r.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function _2(r){return r.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function CC(r,e){return[].slice.call(r.childNodes).reduce((t,i,n)=>{var s;return i.nodeName==="br"&&n?t+`
`:(s=i.childNodes)!=null&&s.length?CC(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function GM(r,e,t){const i="http://www.w3.org/ns/ttml#styling";let n=null;const s=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=r!=null&&r.hasAttribute("style")?r.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(n=t[o]),s.reduce((a,l)=>{const c=t0(e,i,l)||t0(r,i,l)||t0(n,i,l);return c&&(a[l]=c),a},{})}function t0(r,e,t){return r&&r.hasAttributeNS(e,t)?r.getAttributeNS(e,t):null}function S2(r){return new Error(`Could not parse ttml timestamp ${r}`)}function i0(r,e){if(!r)return null;let t=yC(r);return t===null&&(xC.test(r)?t=QM(r,e):IC.test(r)&&(t=zM(r,e))),t}function QM(r,e){const t=xC.exec(r),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function zM(r,e){const t=IC.exec(r),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class _u{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class _C{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=b2(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(L.FRAG_LOADING,this.onFragLoading,this),e.on(L.FRAG_LOADED,this.onFragLoaded,this),e.on(L.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(L.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(L.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(L.FRAG_LOADING,this.onFragLoading,this),e.off(L.FRAG_LOADED,this.onFragLoaded,this),e.off(L.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(L.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(L.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(L.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new _u(this,"textTrack1"),t=new _u(this,"textTrack2"),i=new _u(this,"textTrack3"),n=new _u(this,"textTrack4");this.cea608Parser1=new I2(1,e,t),this.cea608Parser2=new I2(3,i,n)}addCues(e,t,i,n,s){let o=!1;for(let a=s.length;a--;){const l=s[a],c=HM(l[0],l[1],t,i);if(c>=0&&(l[0]=Math.min(l[0],t),l[1]=Math.max(l[1],i),o=!0,c/(i-t)>.5))return}if(o||s.push([t,i]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,i,n)}else{const a=this.Cues.newCue(null,t,i,n);this.hls.trigger(L.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s,trackId:o}){const{unparsedVttFrags:a}=this;i===$e.MAIN&&(this.initPTS[t.cc]={baseTime:n,timescale:s,trackId:o}),a.length&&(this.unparsedVttFrags=[],a.forEach(l=>{this.initPTS[l.frag.cc]?this.onFragLoaded(L.FRAG_LOADED,l):this.hls.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:l.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let n=0;n<i.textTracks.length;n++){const s=i.textTracks[n];if(T2(s,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return s}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:n}=this,{label:s,languageCode:o}=t[e],a=this.getExistingTrack(s,o);if(a)i[e]=a,Aa(i[e]),hC(i[e],n);else{const l=this.createTextTrack("captions",s,o);l&&(l[e]=!0,i[e]=l)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,n={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(L.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}createTextTrack(e,t,i){const n=this.media;if(n)return n.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const i=!!t.transferMedia;if(this.media=null,i)return;const{captionsTracks:n}=this;Object.keys(n).forEach(s=>{Aa(n[s]),delete n[s]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=b2(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)Aa(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],n=i.some(s=>s.textCodec===Zd);if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(YI(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const o=this.media,a=o?dh(o.textTracks):null;if(this.tracks.forEach((l,c)=>{let u;if(a){let h=null;for(let f=0;f<a.length;f++)if(a[f]&&T2(a[f],l)){h=a[f],a[f]=null;break}h&&(u=h)}if(u)Aa(u);else{const h=SC(l);u=this.createTextTrack(h,l.name,l.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),a!=null&&a.length){const l=a.filter(c=>c!==null).map(c=>c.label);l.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${l.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(L.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const n=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!n)return;const s=`textTrack${n[1]}`,o=this.captionsProperties[s];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t?.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===$e.MAIN){var i,n;const{cea608Parser1:s,cea608Parser2:o,lastSn:a}=this,{cc:l,sn:c}=t.frag,u=(i=(n=t.part)==null?void 0:n.index)!=null?i:-1;s&&o&&(c!==a+1||c===a&&u!==this.lastPartIndex+1||l!==this.lastCc)&&(s.reset(),o.reset()),this.lastCc=l,this.lastSn=c,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:n}=t;if(i.type===$e.SUBTITLE)if(n.byteLength){const s=i.decryptdata,o="stats"in t;if(s==null||!s.encrypted||o){const a=this.tracks[i.level],l=this.vttCCs;l[i.cc]||(l[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===Zd?this._parseIMSC1(i,n):this._parseVTTs(t)}}else this.hls.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;C2(t,this.initPTS[e.cc],n=>{this._appendCues(n,e.level),i.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},n=>{i.logger.log(`Failed to parse IMSC1: ${n}`),i.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:n})})}_parseVTTs(e){var t;const{frag:i,payload:n}=e,{initPTS:s,unparsedVttFrags:o}=this,a=s.length-1;if(!s[i.cc]&&a===-1){o.push(e);return}const l=this.hls,c=(t=i.initSegment)!=null&&t.data?rs(i.initSegment.data,new Uint8Array(n)).buffer:n;OM(c,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),l.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const h=u.message==="Missing initPTS for VTT MPEGTS";h?o.push(e):this._fallbackToIMSC1(i,n),l.logger.log(`Failed to parse VTT cue: ${u}`),!(h&&a>i.cc)&&l.trigger(L.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||C2(t,this.initPTS[e.cc],()=>{i.textCodec=Zd,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const n=this.textTracks[t];if(!n||n.mode==="disabled")return;e.forEach(s=>fC(n,s))}else{const n=this.tracks[t];if(!n)return;const s=n.default?"default":"subtitles"+t;i.trigger(L.CUES_PARSED,{type:"subtitles",cues:e,track:s})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===$e.SUBTITLE&&this.onFragLoaded(L.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:i,samples:n}=t;if(!(i.type===$e.MAIN&&this.closedCaptionsForLevel(i)==="NONE"))for(let s=0;s<n.length;s++){const o=n[s].bytes;if(o){this.cea608Parser1||this.initCea608Parsers();const a=this.extractCea608Data(o);this.cea608Parser1.addData(n[s].pts,a[0]),this.cea608Parser2.addData(n[s].pts,a[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:n,type:s}){const{media:o}=this;if(!(!o||o.currentTime<i)){if(!s||s==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(l=>Nm(a[l],t,i))}if(this.config.renderTextTracksNatively&&t===0&&n!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(l=>Nm(a[l],t,n))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let n=2;for(let s=0;s<i;s++){const o=e[n++],a=127&e[n++],l=127&e[n++];if(a===0&&l===0)continue;if((4&o)!==0){const u=3&o;(u===0||u===1)&&(t[u].push(a),t[u].push(l))}}return t}}function SC(r){return r.characteristics&&/transcribes-spoken-dialog/gi.test(r.characteristics)&&/describes-music-and-sound/gi.test(r.characteristics)?"captions":"subtitles"}function T2(r,e){return!!r&&r.kind===SC(e)&&Fm(e,r)}function HM(r,e,t,i){return Math.min(e,i)-Math.max(r,t)}function b2(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}const VM=/\s/,TC={newCue(r,e,t,i){const n=[];let s,o,a,l,c;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(s=i.rows[f],a=!0,l=0,c="",!s.isEmpty()){var h;for(let A=0;A<s.chars.length;A++)VM.test(s.chars[A].uchar)&&a?l++:(c+=s.chars[A].uchar,a=!1);s.cueStartTime=e,e===t&&(t+=1e-4),l>=16?l--:l++;const d=EC(c.trim()),m=op(e,t,d);r!=null&&(h=r.cues)!=null&&h.getCueById(m)||(o=new u(e,t,d),o.id=m,o.line=f+1,o.align="left",o.position=10+Math.min(80,Math.floor(l*8/32)*10),n.push(o))}return r&&n.length&&(n.sort((f,d)=>f.line==="auto"||d.line==="auto"?0:f.line>8&&d.line>8?d.line-f.line:f.line-d.line),n.forEach(f=>fC(r,f))),n}};function bC(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const KM=/(\d+)-(\d+)\/(\d+)/;class Qm{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||jM,this.controller=new self.AbortController,this.stats=new mf}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const n=this.stats;if(n.loading.start)throw new Error("Loader can only be used once.");n.loading.start=self.performance.now();const s=$M(e,this.controller.signal),o=e.responseType==="arraybuffer",a=o?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:c}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,s),self.clearTimeout(this.requestTimeout),t.timeout=l&&He(l)?l:c,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},t.timeout),(Ec(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(h=>{var f;this.response=this.loader=h;const d=Math.max(self.performance.now(),n.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=c,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},c-(d-n.loading.start)),!h.ok){const{status:A,statusText:p}=h;throw new qM(p||"fetch, bad network response",A,h)}n.loading.first=d,n.total=WM(h.headers)||n.total;const m=(f=this.callbacks)==null?void 0:f.onProgress;return m&&He(t.highWaterMark)?this.loadProgressively(h,n,e,t.highWaterMark,m):o?h.arrayBuffer():e.responseType==="json"?h.json():h.text()}).then(h=>{var f,d;const m=this.response;if(!m)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),n.loading.end=Math.max(self.performance.now(),n.loading.first);const A=h[a];A&&(n.loaded=n.total=A);const p={url:m.url,data:h,code:m.status},y=(f=this.callbacks)==null?void 0:f.onProgress;y&&!He(t.highWaterMark)&&y(n,e,h,m),(d=this.callbacks)==null||d.onSuccess(p,n,e,m)}).catch(h=>{var f;if(self.clearTimeout(this.requestTimeout),n.aborted)return;const d=h&&h.code||0,m=h?h.message:null;(f=this.callbacks)==null||f.onError({code:d,text:m},e,h?h.details:null,n)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,n=0,s){const o=new TI,a=e.body.getReader(),l=()=>a.read().then(c=>{if(c.done)return o.dataLength&&s(t,i,o.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const u=c.value,h=u.length;return t.loaded+=h,h<n||o.dataLength?(o.push(u),o.dataLength>=n&&s(t,i,o.flush().buffer,e)):s(t,i,u.buffer,e),l()}).catch(()=>Promise.reject());return l()}}function $M(r,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(Yt({},r.headers))};return r.rangeEnd&&t.headers.set("Range","bytes="+r.rangeStart+"-"+String(r.rangeEnd-1)),t}function YM(r){const e=KM.exec(r);if(e)return parseInt(e[2])-parseInt(e[1])+1}function WM(r){const e=r.get("Content-Range");if(e){const i=YM(e);if(He(i))return i}const t=r.get("Content-Length");if(t)return parseInt(t)}function jM(r,e){return new self.Request(r.url,e)}class qM extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const XM=/^age:\s*[\d.]+\s*$/im;class ap{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new mf,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0,n.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return s(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),s(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{var a;(a=this.callbacks)==null||a.onError({code:i.status,text:o.message},t,i,n)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:o}=i.loadPolicy;if(n)for(const a in n)e.setRequestHeader(a,n[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&He(s)?s:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const n=t.readyState,s=this.config;if(!i.aborted&&n>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),n===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const c=t.status,u=t.responseType==="text"?t.responseText:null;if(c>=200&&c<300){const m=u??t.response;if(m!=null){var o,a;i.loading.end=Math.max(self.performance.now(),i.loading.first);const A=t.responseType==="arraybuffer"?m.byteLength:m.length;i.loaded=i.total=A,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first);const p=(o=this.callbacks)==null?void 0:o.onProgress;p&&p(i,e,m,t);const y={url:t.responseURL,data:m,code:c};(a=this.callbacks)==null||a.onSuccess(y,i,e,t);return}}const h=s.loadPolicy.errorRetry,f=i.retry,d={url:e.url,data:void 0,code:c};if(Uh(h,f,!1,d))this.retry(h);else{var l;Kt.error(`${c} while loading ${e.url}`),(l=this.callbacks)==null||l.onError({code:c,text:t.statusText},e,t,i)}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Uh(e,t,!0))this.retry(e);else{var i;Kt.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const n=this.callbacks;n&&(this.abortInternal(),n.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=VA(e,i.retry),i.retry++,Kt.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t?.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&XM.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const JM={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},ZM=Ht(Ht({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:ap,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:rI,bufferController:qI,capLevelController:Ef,errorController:uI,fpsController:uC,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:jA,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:JM},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},eL()),{},{subtitleStreamController:AC,subtitleTrackController:dC,timelineController:_C,audioStreamController:$I,audioTrackController:WI,emeController:po,cmcdController:aC,contentSteeringController:lC,interstitialsController:gM});function eL(){return{cueHandler:TC,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function tL(r,e,t){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=zm(r),n=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return n.forEach(o=>{const a=`${o==="level"?"playlist":o}LoadPolicy`,l=e[a]===void 0,c=[];s.forEach(u=>{const h=`${o}Loading${u}`,f=e[h];if(f!==void 0&&l){c.push(h);const d=i[a].default;switch(e[a]={default:d},u){case"TimeOut":d.maxLoadTimeMs=f,d.maxTimeToFirstByteMs=f;break;case"MaxRetry":d.errorRetry.maxNumRetry=f,d.timeoutRetry.maxNumRetry=f;break;case"RetryDelay":d.errorRetry.retryDelayMs=f,d.timeoutRetry.retryDelayMs=f;break;case"MaxRetryTimeout":d.errorRetry.maxRetryDelayMs=f,d.timeoutRetry.maxRetryDelayMs=f;break}}}),c.length&&t.warn(`hls.js config: "${c.join('", "')}" setting(s) are deprecated, use "${a}": ${Xt(e[a])}`)}),Ht(Ht({},i),e)}function zm(r){return r&&typeof r=="object"?Array.isArray(r)?r.map(zm):Object.keys(r).reduce((e,t)=>(e[t]=zm(r[t]),e),{}):r}function iL(r,e){const t=r.loader;t!==Qm&&t!==ap?(e.log("[config]: Custom loader detected, cannot enable progressive streaming"),r.progressive=!1):bC()&&(r.loader=Qm,r.progressive=!0,r.enableSoftwareAES=!0,e.log("[config]: Progressive streaming enabled, using FetchLoader"))}const mh=2,nL=.1,sL=.05,rL=100;class oL extends hI{constructor(e,t){super("gap-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var i;(i=this.media)!=null&&i.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{if(this.hls){var i;this.ended=((i=this.media)==null?void 0:i.currentTime)||1,this.hls.trigger(L.MEDIA_ENDED,{stalled:!1})}},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(rL),this.mediaSource=t.mediaSource;const i=this.media=t.media;un(i,"playing",this.onMediaPlaying),un(i,"waiting",this.onMediaWaiting),un(i,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:i}=this;i&&(Cn(i,"playing",this.onMediaPlaying),Cn(i,"waiting",this.onMediaWaiting),Cn(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var i,n;const s=(i=this.hls)==null?void 0:i.config;if(!s)return;const o=this.media;if(!o)return;const{seeking:a}=o,l=this.seeking&&!a,c=!this.seeking&&a,u=o.paused&&!a||o.ended||o.playbackRate===0;if(this.seeking=a,e!==t){t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,s.nudgeOnVideoHole&&!u&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(c||l){l&&this.stallResolved(e);return}if(u){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&o.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(L.MEDIA_ENDED,{stalled:!1}));return}if(!dt.getBuffered(o).length){this.nudgeRetry=0;return}const h=dt.bufferInfo(o,e,0),f=h.nextStart||0,d=this.fragmentTracker;if(a&&d&&this.hls){const C=w2(this.hls.inFlightFragments,e),_=h.len>mh,S=!f||C||f-e>mh&&!d.getPartialFragment(e);if(_||S)return;this.moved=!1}const m=(n=this.hls)==null?void 0:n.latestLevelDetails;if(!this.moved&&this.stalled!==null&&d){if(!(h.len>0)&&!f)return;const _=Math.max(f,h.start||0)-e,b=!!(m!=null&&m.live)?m.targetduration*2:mh,T=Su(e,d);if(_>0&&(_<=b||T)){o.paused||this._trySkipBufferHole(T);return}}const A=s.detectStallWithCurrentTimeMs,p=self.performance.now(),y=this.waiting;let v=this.stalled;if(v===null)if(y>0&&p-y<A)v=this.stalled=y;else{this.stalled=p;return}const E=p-v;if(!a&&(E>=A||y)&&this.hls){var x;if(((x=this.mediaSource)==null?void 0:x.readyState)==="ended"&&!(m!=null&&m.live)&&Math.abs(e-(m?.edge||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(L.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(h),!this.media||!this.hls)return}const I=dt.bufferInfo(o,e,s.maxBufferHole);this._tryFixBufferStall(I,E,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const i=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(i)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(L.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var i;const n=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&n&&n.length>1&&e>n.end(0)){const s=dt.bufferedInfo(dt.timeRangesToArray(this.buffered.audio),e,0);if(s.len>1&&t>=s.start){const o=dt.timeRangesToArray(n),a=dt.bufferedInfo(o,t,0).bufferedIndex;if(a>-1&&a<o.length-1){const l=dt.bufferedInfo(o,e,0).bufferedIndex,c=o[a].end,u=o[a+1].start;if((l===-1||l>a)&&u-c<1&&e-c<2){const h=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${c} -> ${u} buffered index: ${l}`);this.warn(h.message),this.media.currentTime+=1e-6;let f=Su(e,this.fragmentTracker);f&&"fragment"in f?f=f.fragment:f||(f=void 0);const d=dt.bufferInfo(this.media,e,0);this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:h,reason:h.message,frag:f,buffer:d.len,bufferInfo:d})}}}}}_tryFixBufferStall(e,t,i){var n,s;const{fragmentTracker:o,media:a}=this,l=(n=this.hls)==null?void 0:n.config;if(!a||!o||!l)return;const c=(s=this.hls)==null?void 0:s.latestLevelDetails,u=Su(i,o);if((u||c!=null&&c.live&&i<c.fragmentStart)&&(this._trySkipBufferHole(u)||!this.media))return;const h=e.buffered,f=this.adjacentTraversal(e,i);(h&&h.length>1&&e.len>l.maxBufferHole||e.nextStart&&(e.nextStart-i<l.maxBufferHole||f))&&(t>l.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const i=this.fragmentTracker,n=e.nextStart;if(i&&n){const s=i.getFragAtPos(t,$e.MAIN),o=i.getFragAtPos(n,$e.MAIN);if(s&&o)return o.sn-s.sn<2}return!1}_reportStall(e){const{hls:t,media:i,stallReported:n,stalled:s}=this;if(!n&&s!==null&&i&&t){this.stallReported=!0;const o=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${Xt(e)})`);this.warn(o.message),t.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.BUFFER_STALLED_ERROR,fatal:!1,error:o,buffer:e.len,bufferInfo:e,stalled:{start:s}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:i,media:n}=this,s=(t=this.hls)==null?void 0:t.config;if(!n||!i||!s)return 0;const o=n.currentTime,a=dt.bufferInfo(n,o,0),l=o<a.start?a.start:a.nextStart;if(l&&this.hls){const u=a.len<=s.maxBufferHole,h=a.len>0&&a.len<1&&n.readyState<3,f=l-o;if(f>0&&(u||h)){if(f>s.maxBufferHole){let m=!1;if(o===0){const A=i.getAppendedFrag(0,$e.MAIN);A&&l<A.end&&(m=!0)}if(!m&&e){var c;if(!((c=this.hls.loadLevelObj)!=null&&c.details)||w2(this.hls.inFlightFragments,l))return 0;let p=!1,y=e.end;for(;y<l;){const v=Su(y,i);if(v)y+=v.duration;else{p=!0;break}}if(p)return 0}}const d=Math.max(l+sL,o+nL);if(this.warn(`skipping hole, adjusting currentTime from ${o} to ${d}`),this.moved=!0,n.currentTime=d,!(e!=null&&e.gap)){const m=new Error(`fragment loaded with buffer holes, seeking from ${o} to ${d}`),A={type:Je.MEDIA_ERROR,details:ue.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:m,reason:m.message,buffer:a.len,bufferInfo:a};e&&("fragment"in e?A.part=e:A.frag=e),this.hls.trigger(L.ERROR,A)}return d}}return 0}_tryNudgeBuffer(e){const{hls:t,media:i,nudgeRetry:n}=this,s=t?.config;if(!i||!s)return 0;const o=i.currentTime;if(this.nudgeRetry++,n<s.nudgeMaxRetry){const a=o+(n+1)*s.nudgeOffset,l=new Error(`Nudging 'currentTime' from ${o} to ${a}`);this.warn(l.message),i.currentTime=a,t.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.BUFFER_NUDGE_ON_STALL,error:l,fatal:!1,buffer:e.len,bufferInfo:e})}else{const a=new Error(`Playhead still not moving while enough data buffered @${o} after ${s.nudgeMaxRetry} nudges`);this.error(a.message),t.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.BUFFER_STALLED_ERROR,error:a,fatal:!0,buffer:e.len,bufferInfo:e})}}}function w2(r,e){const t=B2(r.main);if(t&&t.start<=e)return t;const i=B2(r.audio);return i&&i.start<=e?i:null}function B2(r){if(!r)return null;switch(r.state){case Te.IDLE:case Te.STOPPED:case Te.ENDED:case Te.ERROR:return null}return r.frag}function Su(r,e){return e.getAppendedFrag(r,$e.MAIN)||e.getPartialFragment(r)}const aL=.25;function Hm(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function n0(r,e,t,i,n){let s=new r(e,t,"");try{s.value=i,n&&(s.type=n)}catch{s=new r(e,t,Xt(n?Ht({type:n},i):i))}return s}const Tu=(()=>{const r=Hm();try{r&&new r(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class lL{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.assetCue=void 0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(L.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e&&(e.on(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}_unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(L.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this))}onMediaAttaching(e,t){var i;this.media=t.media,((i=t.overrides)==null?void 0:i.cueRemoval)===!1&&(this.removeCues=!1)}onMediaAttached(){var e;const t=(e=this.hls)==null?void 0:e.latestLevelDetails;t&&this.updateDateRangeCues(t)}onMediaDetaching(e,t){this.media=null,!t.transferMedia&&(this.id3Track&&(this.removeCues&&Aa(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return hC(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media||!this.hls)return;const{enableEmsgMetadataCues:i,enableID3MetadataCues:n}=this.hls.config;if(!i&&!n)return;const{samples:s}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=Hm();if(o)for(let a=0;a<s.length;a++){const l=s[a].type;if(l===xn.emsg&&!i||!n)continue;const c=LI(s[a].data),u=s[a].pts;let h=u+s[a].duration;h>Tu&&(h=Tu),h-u<=0&&(h=u+aL);for(let d=0;d<c.length;d++){const m=c[d];if(!PI(m)){this.updateId3CueEnds(u,l);const A=n0(o,u,h,m,l);A&&this.id3Track.addCue(A)}}}}updateId3CueEnds(e,t){var i;const n=(i=this.id3Track)==null?void 0:i.cues;if(n)for(let s=n.length;s--;){const o=n[s];o.type===t&&o.startTime<e&&o.endTime===Tu&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:n}){const{id3Track:s,hls:o}=this;if(!o)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:l}}=o;if(s&&(a||l)){let c;n==="audio"?c=u=>u.type===xn.audioId3&&l:n==="video"?c=u=>u.type===xn.emsg&&a:c=u=>u.type===xn.audioId3&&l||u.type===xn.emsg&&a,Nm(s,t,i,c)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.hls||!this.media)return;const{assetPlayerId:i,timelineOffset:n,enableDateRangeMetadataCues:s,interstitialsController:o}=this.hls.config;if(!s)return;const a=Hm();if(i&&n&&!o){const{fragmentStart:A,fragmentEnd:p}=e;let y=this.assetCue;y?(y.startTime=A,y.endTime=p):a&&(y=this.assetCue=n0(a,A,p,{assetPlayerId:this.hls.config.assetPlayerId},"hlsjs.interstitial.asset"),y&&(y.id=i,this.id3Track||(this.id3Track=this.createTrack(this.media)),this.id3Track.addCue(y),y.addEventListener("enter",this.onEventCueEnter)))}if(!e.hasProgramDateTime)return;const{id3Track:l}=this,{dateRanges:c}=e,u=Object.keys(c);let h=this.dateRangeCuesAppended;if(l&&t){var f;if((f=l.cues)!=null&&f.length){const A=Object.keys(h).filter(p=>!u.includes(p));for(let p=A.length;p--;){var d;const y=A[p],v=(d=h[y])==null?void 0:d.cues;delete h[y],v&&Object.keys(v).forEach(E=>{const x=v[E];if(x){x.removeEventListener("enter",this.onEventCueEnter);try{l.removeCue(x)}catch{}}})}}else h=this.dateRangeCuesAppended={}}const m=e.fragments[e.fragments.length-1];if(!(u.length===0||!He(m?.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(let A=0;A<u.length;A++){const p=u[A],y=c[p],v=y.startTime,E=h[p],x=E?.cues||{};let I=E?.durationKnown||!1,C=Tu;const{duration:_,endDate:S}=y;if(S&&_!==null)C=v+_,I=!0;else if(y.endOnNext&&!I){const T=u.reduce((R,w)=>{if(w!==y.id){const B=c[w];if(B.class===y.class&&B.startDate>y.startDate&&(!R||y.startDate<R.startDate))return B}return R},null);T&&(C=T.startTime,I=!0)}const b=Object.keys(y.attr);for(let T=0;T<b.length;T++){const R=b[T];if(!QR(R))continue;const w=x[R];if(w)I&&!(E!=null&&E.durationKnown)?w.endTime=C:Math.abs(w.startTime-v)>.01&&(w.startTime=v,w.endTime=C);else if(a){let B=y.attr[R];zR(R)&&(B=Hx(B));const O=n0(a,v,C,{key:R,data:B},xn.dateRange);O&&(O.id=p,this.id3Track.addCue(O),x[R]=O,o&&(R==="X-ASSET-LIST"||R==="X-ASSET-URL")&&O.addEventListener("enter",this.onEventCueEnter))}}h[p]={cues:x,dateRange:y,durationKnown:I}}}}}class cL{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:t}=this,i=this.levelDetails;if(!t||!i)return;this.currentTime=t.currentTime;const n=this.computeLatency();if(n===null)return;this._latency=n;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:o}=this.config;if(!s||o===1||!i.live)return;const a=this.targetLatency;if(a===null)return;const l=n-a,c=Math.min(this.maxLatency,a+i.targetduration);if(l<c&&l>.05&&this.forwardBufferLength>1){const h=Math.min(2,Math.max(1,o)),f=Math.round(2/(1+Math.exp(-.75*l-this.edgeStalled))*20)/20,d=Math.min(h,Math.max(1,f));this.changeMediaPlaybackRate(t,d)}else t.playbackRate!==1&&t.playbackRate!==0&&this.changeMediaPlaybackRate(t,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return((e=this.hls)==null?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(e.liveMaxLatencyDuration!==void 0)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(e===null||this.hls===null)return null;const{holdBack:t,partHoldBack:i,targetduration:n}=e,{liveSyncDuration:s,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,l=this.hls.userConfig;let c=a&&i||t;(this._targetLatencyUpdated||l.liveSyncDuration||l.liveSyncDurationCount||c===0)&&(c=s!==void 0?s:o*n);const u=n;return c+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,u)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(e===null||t===null)return null;const i=this.levelDetails;if(i===null)return null;const n=i.edge,s=e-t-this.edgeStalled,o=n-i.totalduration,a=n-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,s),a)}get drift(){const e=this.levelDetails;return e===null?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(L.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(L.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(L.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(L.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var i;t.details===ue.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(i=this.levelDetails)!=null&&i.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var i,n;e.playbackRate!==t&&((i=this.hls)==null||i.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${(n=this.targetLatency)==null?void 0:n.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}class uL extends vf{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this),e.on(L.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this),e.off(L.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,n=[],s={},o={};let a=!1,l=!1,c=!1;t.levels.forEach(u=>{const h=u.attrs;let{audioCodec:f,videoCodec:d}=u;f&&(u.audioCodec=f=Ph(f,i)||void 0),d&&(d=u.videoCodec=oR(d));const{width:m,height:A,unknownCodecs:p}=u,y=p?.length||0;if(a||(a=!!(m&&A)),l||(l=!!d),c||(c=!!f),y||f&&!this.isAudioSupported(f)||d&&!this.isVideoSupported(d)){this.log(`Some or all CODECS not supported "${h.CODECS}"`);return}const{CODECS:v,"FRAME-RATE":E,"HDCP-LEVEL":x,"PATHWAY-ID":I,RESOLUTION:C,"VIDEO-RANGE":_}=h,b=`${`${I||"."}-`}${u.bitrate}-${C}-${E}-${v}-${_}-${x}`;if(s[b])if(s[b].uri!==u.url&&!u.attrs["PATHWAY-ID"]){const T=o[b]+=1;u.attrs["PATHWAY-ID"]=new Array(T+1).join(".");const R=this.createLevel(u);s[b]=R,n.push(R)}else s[b].addGroupId("audio",h.AUDIO),s[b].addGroupId("text",h.SUBTITLES);else{const T=this.createLevel(u);s[b]=T,o[b]=1,n.push(T)}}),this.filterAndSortMediaOptions(n,t,a,l,c)}createLevel(e){const t=new Fa(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){const n=new Error(`SUPPLEMENTAL-CODECS not supported "${i.videoCodec}"`);this.log(n.message),t.supportedResult=tI(n,[])}return t}isAudioSupported(e){return pc(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return pc(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,i,n,s){var o;let a=[],l=[],c=e;const u=((o=t.stats)==null?void 0:o.parsing)||{};if((i||n)&&s&&(c=c.filter(({videoCodec:v,videoRange:E,width:x,height:I})=>(!!v||!!(x&&I))&&pR(E))),c.length===0){Promise.resolve().then(()=>{if(this.hls){let v="no level with compatible codecs found in manifest",E=v;t.levels.length&&(E=`one or more CODECS in variant not supported: ${Xt(t.levels.map(I=>I.attrs.CODECS).filter((I,C,_)=>_.indexOf(I)===C))}`,this.warn(E),v+=` (${E})`);const x=new Error(v);this.hls.trigger(L.ERROR,{type:Je.MEDIA_ERROR,details:ue.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:x,reason:E})}}),u.end=performance.now();return}t.audioTracks&&(a=t.audioTracks.filter(v=>!v.audioCodec||this.isAudioSupported(v.audioCodec)),R2(a)),t.subtitles&&(l=t.subtitles,R2(l));const h=c.slice(0);c.sort((v,E)=>{if(v.attrs["HDCP-LEVEL"]!==E.attrs["HDCP-LEVEL"])return(v.attrs["HDCP-LEVEL"]||"")>(E.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&v.height!==E.height)return v.height-E.height;if(v.frameRate!==E.frameRate)return v.frameRate-E.frameRate;if(v.videoRange!==E.videoRange)return Fh.indexOf(v.videoRange)-Fh.indexOf(E.videoRange);if(v.videoCodec!==E.videoCodec){const x=Cy(v.videoCodec),I=Cy(E.videoCodec);if(x!==I)return I-x}if(v.uri===E.uri&&v.codecSet!==E.codecSet){const x=Lh(v.codecSet),I=Lh(E.codecSet);if(x!==I)return I-x}return v.averageBitrate!==E.averageBitrate?v.averageBitrate-E.averageBitrate:0});let f=h[0];if(this.steering&&(c=this.steering.filterParsedLevels(c),c.length!==h.length)){for(let v=0;v<h.length;v++)if(h[v].pathwayId===c[0].pathwayId){f=h[v];break}}this._levels=c;for(let v=0;v<c.length;v++)if(c[v]===f){var d;this._firstLevel=v;const E=f.bitrate,x=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${c.length} level(s) found, first bitrate: ${E}`),((d=this.hls.userConfig)==null?void 0:d.abrEwmaDefaultEstimate)===void 0){const I=Math.min(E,this.hls.config.abrEwmaDefaultEstimateMax);I>x&&x===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=I)}break}const m=s&&!n,A=this.hls.config,p=!!(A.audioStreamController&&A.audioTrackController),y={levels:c,audioTracks:a,subtitleTracks:l,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:s,video:n,altAudio:p&&!m&&a.some(v=>!!v.url)};u.end=performance.now(),this.hls.trigger(L.MANIFEST_PARSED,y)}get levels(){return this._levels.length===0?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const u=new Error("invalid level idx"),h=e<0;if(this.hls.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.LEVEL_SWITCH_ERROR,level:e,fatal:h,error:u,reason:u.message}),h)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,n=this.currentLevel,s=n?n.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&n&&s===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${s?" with Pathway "+s:""}`);const l={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(L.LEVEL_SWITCHING,l);const c=o.details;if(!c||c.live){const u=this.switchParams(o.uri,n?.details,c);this.loadPlaylist(u)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),i=e.filter(n=>t.indexOf(n)!==-1);if(e.length<1){this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);return}this.steering.pathwayPriority=i}}onError(e,t){t.fatal||!t.context||t.context.type===Ct.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===$e.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(s=>!!i[s]))return;const n=this._levels[t.level];n!=null&&n.loadError&&(this.log(`Resetting level error count of ${n.loadError} on frag buffered`),n.loadError=0)}}onLevelLoaded(e,t){var i;const{level:n,details:s}=t,o=t.levelInfo;if(!o){var a;this.warn(`Invalid level index ${n}`),(a=t.deliveryDirectives)!=null&&a.skip&&(s.deltaUpdateFailed=!0);return}if(o===this.currentLevel||t.withoutMultiVariant){o.fragmentError===0&&(o.loadError=0);let l=o.details;l===t.details&&l.advanced&&(l=void 0),this.playlistLoaded(n,t,l)}else(i=t.deliveryDirectives)!=null&&i.skip&&(s.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const i=this.getUrlWithDirectives(e.uri,t),n=this.currentLevelIndex,s=e.attrs["PATHWAY-ID"],o=e.details,a=o?.age;this.log(`Loading level index ${n}${t?.msn!==void 0?" at sn "+t.msn+" part "+t.part:""}${s?" Pathway "+s:""}${a&&o.live?" age "+a.toFixed(1)+(o.type&&" "+o.type||""):""} ${i}`),this.hls.trigger(L.LEVEL_LOADING,{url:i,level:n,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(this._levels.length===1)return;const i=this._levels.filter((s,o)=>o!==e?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(a=>a.level=-1)),!1));CI(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const n=i.length-1;this._firstLevel=Math.min(this._firstLevel,n),this._startLevel&&(this._startLevel=Math.min(this._startLevel,n)),this.hls.trigger(L.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(L.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function R2(r){const e={};r.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}function wC(){return self.SourceBuffer||self.WebKitSourceBuffer}function lp(){if(!yr())return!1;const e=wC();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function BC(){if(!lp())return!1;const r=yr();return typeof r?.isTypeSupported=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>r.isTypeSupported(gc(e,"video")))||["mp4a.40.2","fLaC"].some(e=>r.isTypeSupported(gc(e,"audio"))))}function hL(){var r;const e=wC();return typeof(e==null||(r=e.prototype)==null?void 0:r.changeType)=="function"}const fL=100;class dL extends gf{constructor(e,t,i){super(e,t,i,"stream-controller",$e.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const n=this.media,s=n?n.currentTime:null;if(s===null||!He(s)||(this.log(`Media seeked to ${s.toFixed(3)}`),!this.getBufferedFrag(s)))return;const o=this.getFwdBufferInfoAtPos(n,s,$e.MAIN,0);if(o===null||o.len===0){this.warn(`Main forward buffer length at ${s} on "seeked" event ${o?o.len:"empty"})`);return}this.tick()},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(L.MANIFEST_PARSED,this.onManifestParsed,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.LEVEL_LOADED,this.onLevelLoaded,this),e.on(L.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(L.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(L.BUFFER_CREATED,this.onBufferCreated,this),e.on(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(L.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(L.MANIFEST_PARSED,this.onManifestParsed,this),e.off(L.LEVEL_LOADED,this.onLevelLoaded,this),e.off(L.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(L.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(L.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(L.BUFFER_CREATED,this.onBufferCreated,this),e.off(L.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(L.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:i,hls:n}=this;if(this.stopLoad(),this.setInterval(fL),this.level=-1,!this.startFragRequested){let s=n.startLevel;s===-1&&(n.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=n.firstAutoLevel),n.nextLoadLevel=s,this.level=n.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log(`Override startPosition with lastCurrentTime @${i.toFixed(3)}`),e=i),this.state=Te.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=Te.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case Te.WAITING_LEVEL:{const{levels:e,level:t}=this,i=e?.[t],n=i?.details;if(n&&(!n.live||this.levelLastLoaded===i&&!this.waitForLive(i))){if(this.waitForCdnTuneIn(n))break;this.state=Te.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=Te.IDLE;break}break}case Te.FRAG_LOADING_WAITING_RETRY:this.checkRetryDate();break}this.state===Te.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:n}=this;if(t===null||!n&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const s=this.buffering?e.nextLoadLevel:e.loadLevel;if(!(i!=null&&i[s]))return;const o=i[s],a=this.getMainFwdBufferInfo();if(a===null)return;const l=this.getLevelDetails();if(l&&this._streamEnded(a,l)){const A={};this.altAudio===2&&(A.type="video"),this.hls.trigger(L.BUFFER_EOS,A),this.state=Te.ENDED;return}if(!this.buffering)return;e.loadLevel!==s&&e.manualLevel===-1&&this.log(`Adapting to level ${s} from level ${this.level}`),this.level=e.nextLoadLevel=s;const c=o.details;if(!c||this.state===Te.WAITING_LEVEL||this.waitForLive(o)){this.level=s,this.state=Te.WAITING_LEVEL,this.startFragRequested=!1;return}const u=a.len,h=this.getMaxBufferLength(o.maxBitrate);if(u>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:a.end;let d=this.getNextFragment(f,c);if(this.couldBacktrack&&!this.fragPrevious&&d&&Ri(d)&&this.fragmentTracker.getState(d)!==Ni.OK){var m;const p=((m=this.backtrackFragment)!=null?m:d).sn-c.startSN,y=c.fragments[p-1];y&&d.cc===y.cc&&(d=y,this.fragmentTracker.removeFragment(y))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(d&&this.isLoopLoading(d,f)){if(!d.gap){const p=this.audioOnly&&!this.altAudio?qt.AUDIO:qt.VIDEO,y=(p===qt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;y&&this.afterBufferFlushed(y,p,$e.MAIN)}d=this.getNextFragmentLoopLoading(d,c,a,$e.MAIN,h)}d&&(d.initSegment&&!d.initSegment.data&&!this.bitrateTest&&(d=d.initSegment),this.loadFragment(d,o,f))}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);n===Ni.NOT_LOADED||n===Ni.PARTIAL?Ri(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,$e.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const n=this.getAppendedFrag(t.currentTime);n&&n.start>1&&this.flushMainBuffer(0,n.start-1);const s=this.getLevelDetails();if(s!=null&&s.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<s.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,l=e[a],c=this.fragLastKbps;c&&this.fragCurrent?i=this.fragCurrent.duration*l.maxBitrate/(1e3*c)+1:i=0}else i=0;const o=this.getBufferedFrag(t.currentTime+i);if(o){const a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();const l=a.maxStartPTS?a.maxStartPTS:a.start,c=a.duration,u=Math.max(o.end,l+Math.min(Math.max(c-this.config.maxFragLookUpTolerance,c*(this.couldBacktrack?.5:.125)),c*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(u,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case Te.KEY_LOADING:case Te.FRAG_LOADING:case Te.FRAG_LOADING_WAITING_RETRY:case Te.PARSING:case Te.PARSED:this.state=Te.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio===2?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;un(i,"playing",this.onMediaPlaying),un(i,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:i}=this;i&&(Cn(i,"playing",this.onMediaPlaying),Cn(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),!t.transferMedia&&(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(L.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let i=!1,n=!1;for(let s=0;s<t.levels.length;s++){const o=t.levels[s].audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,n=n||o.indexOf("mp4a.40.5")!==-1)}this.audioCodecSwitch=i&&n&&!hL(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==Te.IDLE)return;const n=t.levelInfo;(!n.details||n.details.live&&(this.levelLastLoaded!==n||n.details.expired)||this.waitForCdnTuneIn(n.details))&&(this.state=Te.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:n,startFragRequested:s}=this,o=t.level,a=t.details,l=a.totalduration;if(!n){this.warn(`Levels were reset while loading level ${o}`);return}this.log(`Level ${o} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${l}`);const c=t.levelInfo,u=this.fragCurrent;u&&(this.state===Te.FRAG_LOADING||this.state===Te.FRAG_LOADING_WAITING_RETRY)&&u.level!==t.level&&u.loader&&this.abortCurrentFrag();let h=0;if(a.live||(i=c.details)!=null&&i.live){var f;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;h=this.alignPlaylists(a,c.details,(f=this.levelLastLoaded)==null?void 0:f.details)}if(c.details=a,this.levelLastLoaded=c,s||this.setStartPosition(a,h),this.hls.trigger(L.LEVEL_UPDATED,{details:a,level:o}),this.state===Te.WAITING_LEVEL){if(this.waitForCdnTuneIn(a))return;this.state=Te.IDLE}s&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const n=this.hls.liveSyncPosition,s=this.getLoadPosition(),o=e.fragmentStart,a=e.edge,l=s>=o-t.maxFragLookUpTolerance&&s<=a;if(n!==null&&i.duration>n&&(s<n||!l)){const u=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!l&&i.readyState<4||s<a-u)&&(this._hasEnoughToStart||(this.nextLoadPosition=n),i.readyState))if(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${n.toFixed(3)}`),this.config.liveSyncMode==="buffered"){var c;const h=dt.bufferInfo(i,n,0);if(!((c=h.buffered)!=null&&c.length)){i.currentTime=n;return}if(h.start<=s){i.currentTime=n;return}const{nextStart:d}=dt.bufferedInfo(h.buffered,s,0);d&&(i.currentTime=d)}else i.currentTime=n}}_handleFragmentLoadProgress(e){var t;const i=e.frag,{part:n,payload:s}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const a=o[i.level];if(!a){this.warn(`Level ${i.level} not found on progress`);return}const l=a.details;if(!l){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const c=a.videoCodec,u=l.PTSKnown||!l.live,h=(t=i.initSegment)==null?void 0:t.data,f=this._getAudioCodec(a),d=this.transmuxer=this.transmuxer||new KI(this.hls,$e.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=n?n.index:-1,A=m!==-1,p=new pf(i.level,i.sn,i.stats.chunkCount,s.byteLength,m,A),y=this.initPTS[i.cc];d.push(s,h,f,c,i,n,l.totalduration,u,p,y)}onAudioTrackSwitching(e,t){const i=this.hls,n=this.altAudio===2;if(kh(t.url,i))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(n){this.fragmentTracker.removeAllFragments(),i.once(L.BUFFER_FLUSHED,()=>{this.hls&&this.hls.trigger(L.AUDIO_TRACK_SWITCHED,t)}),i.trigger(L.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}i.trigger(L.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=kh(t.url,this.hls);if(i){const n=this.videoBuffer;n&&this.mediaBuffer!==n&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=n)}this.altAudio=i?2:0,this.tick()}onBufferCreated(e,t){const i=t.tracks;let n,s,o=!1;for(const a in i){const l=i[a];if(l.id==="main"){if(s=a,n=l,a==="video"){const c=i[a];c&&(this.videoBuffer=c.buffer)}}else o=!0}o&&n?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=n.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:n}=t,s=i.type===$e.MAIN;if(s){if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===Te.PARSED&&(this.state=Te.IDLE);return}const a=n?n.stats:i.stats;this.fragLastKbps=Math.round(8*a.total/(a.buffering.end-a.loading.first)),Ri(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,n)}const o=this.media;o&&(!this._hasEnoughToStart&&dt.getBuffered(o).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),s&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var i;if(t.fatal){this.state=Te.ERROR;return}switch(t.details){case ue.FRAG_GAP:case ue.FRAG_PARSING_ERROR:case ue.FRAG_DECRYPT_ERROR:case ue.FRAG_LOAD_ERROR:case ue.FRAG_LOAD_TIMEOUT:case ue.KEY_LOAD_ERROR:case ue.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError($e.MAIN,t);break;case ue.LEVEL_LOAD_ERROR:case ue.LEVEL_LOAD_TIMEOUT:case ue.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===Te.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===Ct.LEVEL&&(this.state=Te.IDLE);break;case ue.BUFFER_ADD_CODEC_ERROR:case ue.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case ue.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&(!this.config.interstitialsController&&this.config.assetPlayerId?this._hasEnoughToStart=!0:this.flushMainBuffer(0,Number.POSITIVE_INFINITY));break;case ue.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onFragLoadEmergencyAborted(){this.state=Te.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==qt.AUDIO||!this.altAudio){const i=(t===qt.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;i&&(this.afterBufferFlushed(i,t,$e.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const n=this.timelineOffset;n&&i&&(i+=n);const s=this.getLevelDetails(),o=dt.getBuffered(e),a=o.length?o.start(0):0,l=a-i,c=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||l>0&&(l<c||this.loadingParts&&l<2*(s?.partTarget||0)))&&(this.log(`adjusting start position by ${l} to match buffer start`),i+=l,this.startPosition=i),t<i&&(this.log(`seek to target start position ${i} from current time ${t} buffer start ${a}`),e.currentTime=i)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:n}=this,s=i?.frag;if(!s||this.fragContextChanged(s))return;t.fragmentError=0,this.state=Te.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const o=s.stats;o.parsing.start=o.parsing.end=o.buffering.start=o.buffering.end=self.performance.now(),n.trigger(L.FRAG_LOADED,i),s.bitrateTest=!1}).catch(i=>{this.state===Te.STOPPED||this.state===Te.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}_handleTransmuxComplete(e){const t=this.playlistType,{hls:i}=this,{remuxResult:n,chunkMeta:s}=e,o=this.getCurrentContext(s);if(!o){this.resetWhenMissingContext(s);return}const{frag:a,part:l,level:c}=o,{video:u,text:h,id3:f,initSegment:d}=n,{details:m}=c,A=this.altAudio?void 0:n.audio;if(this.fragContextChanged(a)){this.fragmentTracker.removeFragment(a);return}if(this.state=Te.PARSING,d){const p=d.tracks;if(p){const x=a.initSegment||a;if(this.unhandledEncryptionError(d,a))return;this._bufferInitSegment(c,p,x,s),i.trigger(L.FRAG_PARSING_INIT_SEGMENT,{frag:x,id:t,tracks:p})}const y=d.initPTS,v=d.timescale,E=this.initPTS[a.cc];if(He(y)&&(!E||E.baseTime!==y||E.timescale!==v)){const x=d.trackId;this.initPTS[a.cc]={baseTime:y,timescale:v,trackId:x},i.trigger(L.INIT_PTS_FOUND,{frag:a,id:t,initPTS:y,timescale:v,trackId:x})}}if(u&&m){A&&u.type==="audiovideo"&&this.logMuxedErr(a);const p=m.fragments[a.sn-1-m.startSN],y=a.sn===m.startSN,v=!p||a.cc>p.cc;if(n.independent!==!1){const{startPTS:E,endPTS:x,startDTS:I,endDTS:C}=u;if(l)l.elementaryStreams[u.type]={startPTS:E,endPTS:x,startDTS:I,endDTS:C};else if(u.firstKeyFrame&&u.independent&&s.id===1&&!v&&(this.couldBacktrack=!0),u.dropped&&u.independent){const _=this.getMainFwdBufferInfo(),S=(_?_.end:this.getLoadPosition())+this.config.maxBufferHole,b=u.firstKeyFramePTS?u.firstKeyFramePTS:E;if(!y&&S<b-this.config.maxBufferHole&&!v){this.backtrack(a);return}else v&&(a.gap=!0);a.setElementaryStreamInfo(u.type,a.start,x,a.start,C,!0)}else y&&E-(m.appliedTimelineOffset||0)>mh&&(a.gap=!0);a.setElementaryStreamInfo(u.type,E,x,I,C),this.backtrackFragment&&(this.backtrackFragment=a),this.bufferFragmentData(u,a,l,s,y||v)}else if(y||v)a.gap=!0;else{this.backtrack(a);return}}if(A){const{startPTS:p,endPTS:y,startDTS:v,endDTS:E}=A;l&&(l.elementaryStreams[qt.AUDIO]={startPTS:p,endPTS:y,startDTS:v,endDTS:E}),a.setElementaryStreamInfo(qt.AUDIO,p,y,v,E),this.bufferFragmentData(A,a,l,s)}if(m&&f!=null&&f.samples.length){const p={id:t,frag:a,details:m,samples:f.samples};i.trigger(L.FRAG_PARSING_METADATA,p)}if(m&&h){const p={id:t,frag:a,details:m,samples:h.samples};i.trigger(L.FRAG_PARSING_USERDATA,p)}}logMuxedErr(e){this.warn(`${Ri(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,i,n){if(this.state!==Te.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));const{audio:s,video:o,audiovideo:a}=t;if(s){const c=e.audioCodec;let u=lh(s.codec,c);u==="mp4a"&&(u="mp4a.40.5");const h=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){u&&(u.indexOf("mp4a.40.5")!==-1?u="mp4a.40.2":u="mp4a.40.5");const f=s.metadata;f&&"channelCount"in f&&(f.channelCount||1)!==1&&h.indexOf("firefox")===-1&&(u="mp4a.40.5")}u&&u.indexOf("mp4a.40.5")!==-1&&h.indexOf("android")!==-1&&s.container!=="audio/mpeg"&&(u="mp4a.40.2",this.log(`Android: force audio codec to ${u}`)),c&&c!==u&&this.log(`Swapping manifest audio codec "${c}" for "${u}"`),s.levelCodec=u,s.id=$e.MAIN,this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${u||""}/${c||""}/${s.codec}]`),delete t.audiovideo}if(o){o.levelCodec=e.videoCodec,o.id=$e.MAIN;const c=o.codec;if(c?.length===4)switch(c){case"hvc1":case"hev1":o.codec="hvc1.1.6.L120.90";break;case"av01":o.codec="av01.0.04M.08";break;case"avc1":o.codec="avc1.42e01e";break}this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${c}]${o.codec!==c?" parsed-corrected="+o.codec:""}${o.supplemental?" supplemental="+o.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const l=Object.keys(t);if(l.length){if(this.hls.trigger(L.BUFFER_CODECS,t),!this.hls)return;l.forEach(c=>{const h=t[c].initSegment;h!=null&&h.byteLength&&this.hls.trigger(L.BUFFER_APPENDING,{type:c,data:h,frag:i,part:null,chunkMeta:n,parent:i.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,$e.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,i=e?.[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=Te.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(dt.isBuffered(e,i)?t=this.getAppendedFrag(i):dt.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const n=this.fragPlaying,s=t.level;(!n||t.sn!==n.sn||n.level!==s)&&(this.fragPlaying=t,this.hls.trigger(L.FRAG_CHANGED,{frag:t}),(!n||n.level!==s)&&this.hls.trigger(L.LEVEL_SWITCHED,{level:s}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return He(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(He(t)){const i=this.getLevelDetails(),n=this.currentFrag||(i?yo(null,i.fragments,t):null);if(n){const s=n.programDateTime;if(s!==null){const o=s+(t-n.start)*1e3;return new Date(o)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class mL extends as{constructor(e,t){super("key-loader",t),this.config=void 0,this.keyIdToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyIdToKeyInfo){const n=this.keyIdToKeyInfo[i].loader;if(n){var t;if(e&&e!==((t=n.context)==null?void 0:t.frag.type))return;n.abort()}}}detach(){for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyIdToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyIdToKeyInfo){const t=this.keyIdToKeyInfo[e].loader;t&&t.destroy()}this.keyIdToKeyInfo={}}createKeyLoadError(e,t=ue.KEY_LOAD_ERROR,i,n,s){return new ur({type:Je.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:s,error:i,networkDetails:n})}loadClear(e,t,i){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let n=0,s=t.length;n<s;n++){const o=t[n];if(e.cc<=o.cc&&(!Ri(e)||!Ri(o)||e.sn<o.sn)||!i&&n==s-1)return this.emeController.selectKeySystemFormat(o).then(a=>{if(!this.emeController)return;o.setKeyFormat(a);const l=ch(a);if(l)return this.emeController.getKeySystemAccess([l])})}if(this.config.requireKeySystemAccessOnStart){const n=Hl(this.config);if(n.length)return this.emeController.getKeySystemAccess(n)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,n;t&&e.setKeyFormat(t);const s=e.decryptdata;if(!s){const c=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:`Missing decryption data on fragment in onKeyLoading (emeEnabled with controller: ${this.emeController&&this.config.emeEnabled})`);return Promise.reject(this.createKeyLoadError(e,ue.KEY_LOAD_ERROR,c))}const o=s.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,ue.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));const a=s0(s);let l=this.keyIdToKeyInfo[a];if((i=l)!=null&&i.decryptdata.key)return s.key=l.decryptdata.key,Promise.resolve({frag:e,keyInfo:l});if(this.emeController&&(n=l)!=null&&n.keyLoadPromise)switch(this.emeController.getKeyStatus(l.decryptdata)){case"usable":case"usable-in-future":return l.keyLoadPromise.then(u=>{const{keyInfo:h}=u;return s.key=h.decryptdata.key,{frag:e,keyInfo:h}})}switch(this.log(`${this.keyIdToKeyInfo[a]?"Rel":"L"}oading${s.keyId?" keyId: "+an(s.keyId):""} URI: ${s.uri} from ${e.type} ${e.level}`),l=this.keyIdToKeyInfo[a]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return s.keyFormat==="identity"?this.loadKeyHTTP(l,e):this.loadKeyEME(l,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(l,e);default:return Promise.reject(this.createKeyLoadError(e,ue.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){var n;if(!e.decryptdata.keyId&&(n=t.initSegment)!=null&&n.data){const o=W9(t.initSegment.data);if(o.length){const a=o[0];a.some(l=>l!==0)&&(this.log(`Using keyId found in init segment ${an(a)}`),e.decryptdata.keyId=a,Qr.setKeyIdForUri(e.decryptdata.uri,a))}}const s=this.emeController.loadKey(i);return(e.keyLoadPromise=s.then(o=>(e.mediaKeySessionContext=o,i))).catch(o=>{throw e.keyLoadPromise=null,"data"in o&&(o.data.frag=t),o})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,n=i.loader,s=new n(i);return t.keyLoader=e.loader=s,e.keyLoadPromise=new Promise((o,a)=>{const l={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},c=i.keyLoadPolicy.default,u={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,m,A)=>{const{frag:p,keyInfo:y}=m,v=s0(y.decryptdata);if(!p.decryptdata||y!==this.keyIdToKeyInfo[v])return a(this.createKeyLoadError(p,ue.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),A));y.decryptdata.key=p.decryptdata.key=new Uint8Array(f.data),p.keyLoader=null,y.loader=null,o({frag:p,keyInfo:y})},onError:(f,d,m,A)=>{this.resetLoader(d),a(this.createKeyLoadError(t,ue.KEY_LOAD_ERROR,new Error(`HTTP Error ${f.code} loading key ${f.text}`),m,Ht({url:l.url,data:void 0},f)))},onTimeout:(f,d,m)=>{this.resetLoader(d),a(this.createKeyLoadError(t,ue.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),m))},onAbort:(f,d,m)=>{this.resetLoader(d),a(this.createKeyLoadError(t,ue.INTERNAL_ABORTED,new Error("key loading aborted"),m))}};s.load(l,u,h)})}resetLoader(e){const{frag:t,keyInfo:i,url:n}=e,s=i.loader;t.keyLoader===s&&(t.keyLoader=null,i.loader=null);const o=s0(i.decryptdata)||n;delete this.keyIdToKeyInfo[o],s&&s.destroy()}}function s0(r){if(r.keyFormat!==Wi.FAIRPLAY){const e=r.keyId;if(e)return an(e)}return r.uri}function D2(r){const{type:e}=r;switch(e){case Ct.AUDIO_TRACK:return $e.AUDIO;case Ct.SUBTITLE_TRACK:return $e.SUBTITLE;default:return $e.MAIN}}function r0(r,e){let t=r.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class AL{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(L.MANIFEST_LOADING,this.onManifestLoading,this),e.on(L.LEVEL_LOADING,this.onLevelLoading,this),e.on(L.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(L.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(L.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(L.MANIFEST_LOADING,this.onManifestLoading,this),e.off(L.LEVEL_LOADING,this.onLevelLoading,this),e.off(L.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(L.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(L.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,n=t.loader,s=i||n,o=new s(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Ct.MANIFEST,url:i,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:i,level:n,pathwayId:s,url:o,deliveryDirectives:a,levelInfo:l}=t;this.load({id:i,level:n,pathwayId:s,responseType:"text",type:Ct.LEVEL,url:o,deliveryDirectives:a,levelOrTrack:l})}onAudioTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:Ct.AUDIO_TRACK,url:s,deliveryDirectives:o,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:o,track:a}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:Ct.SUBTITLE_TRACK,url:s,deliveryDirectives:o,levelOrTrack:a})}onLevelsUpdated(e,t){const i=this.loaders[Ct.LEVEL];if(i){const n=i.context;n&&!t.levels.some(s=>s===n.levelOrTrack)&&(i.abort(),delete this.loaders[Ct.LEVEL])}}load(e){var t;const i=this.hls.config;let n=this.getInternalLoader(e);if(n){const c=this.hls.logger,u=n.context;if(u&&u.levelOrTrack===e.levelOrTrack&&(u.url===e.url||u.deliveryDirectives&&!e.deliveryDirectives)){u.url===e.url?c.log(`[playlist-loader]: ignore ${e.url} ongoing request`):c.log(`[playlist-loader]: ignore ${e.url} in favor of ${u.url}`);return}c.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),n.abort()}let s;if(e.type===Ct.MANIFEST?s=i.manifestLoadPolicy.default:s=Yt({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),n=this.createInternalLoader(e),He((t=e.deliveryDirectives)==null?void 0:t.part)){let c;if(e.type===Ct.LEVEL&&e.level!==null?c=this.hls.levels[e.level].details:e.type===Ct.AUDIO_TRACK&&e.id!==null?c=this.hls.audioTracks[e.id].details:e.type===Ct.SUBTITLE_TRACK&&e.id!==null&&(c=this.hls.subtitleTracks[e.id].details),c){const u=c.partTarget,h=c.targetduration;if(u&&h){const f=Math.max(u*3,h*.8)*1e3;s=Yt({},s,{maxTimeToFirstByteMs:Math.min(f,s.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(f,s.maxTimeToFirstByteMs)})}}}const o=s.errorRetry||s.timeoutRetry||{},a={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},l={onSuccess:(c,u,h,f)=>{const d=this.getInternalLoader(h);this.resetInternalLoader(h.type);const m=c.data;u.parsing.start=performance.now(),Ss.isMediaPlaylist(m)||h.type!==Ct.MANIFEST?this.handleTrackOrLevelPlaylist(c,u,h,f||null,d):this.handleMasterPlaylist(c,u,h,f)},onError:(c,u,h,f)=>{this.handleNetworkError(u,h,!1,c,f)},onTimeout:(c,u,h)=>{this.handleNetworkError(u,h,!0,void 0,c)}};n.load(e,a,l)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:i}=this.hls;(e||i)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,i,n){const s=this.hls,o=e.data,a=r0(e,i),l=Ss.parseMasterPlaylist(o,a);if(l.playlistParsingError){t.parsing.end=performance.now(),this.handleManifestParsingError(e,i,l.playlistParsingError,n,t);return}const{contentSteering:c,levels:u,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:m}=l;this.variableList=m,u.forEach(v=>{const{unknownCodecs:E}=v;if(E){const{preferManagedMediaSource:x}=this.hls.config;let{audioCodec:I,videoCodec:C}=v;for(let _=E.length;_--;){const S=E[_];pc(S,"audio",x)?(v.audioCodec=I=I?`${I},${S}`:S,Pa.audio[I.substring(0,4)]=2,E.splice(_,1)):pc(S,"video",x)&&(v.videoCodec=C=C?`${C},${S}`:S,Pa.video[C.substring(0,4)]=2,E.splice(_,1))}}});const{AUDIO:A=[],SUBTITLES:p,"CLOSED-CAPTIONS":y}=Ss.parseMasterPlaylistMedia(o,a,l);A.length&&!A.some(E=>!E.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),A.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new li({}),bitrate:0,url:""})),s.trigger(L.MANIFEST_LOADED,{levels:u,audioTracks:A,subtitles:p,captions:y,contentSteering:c,url:a,stats:t,networkDetails:n,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:m})}handleTrackOrLevelPlaylist(e,t,i,n,s){const o=this.hls,{id:a,level:l,type:c}=i,u=r0(e,i),h=He(l)?l:He(a)?a:0,f=D2(i),d=Ss.parseLevelPlaylist(e.data,u,h,f,0,this.variableList);if(c===Ct.MANIFEST){const m={attrs:new li({}),bitrate:0,details:d,name:"",url:u};d.requestScheduled=t.loading.start+EI(d,0),o.trigger(L.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:u,stats:t,networkDetails:n,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=d,this.handlePlaylistLoaded(d,e,t,i,n,s)}handleManifestParsingError(e,t,i,n,s){this.hls.trigger(L.ERROR,{type:Je.NETWORK_ERROR,details:ue.MANIFEST_PARSING_ERROR,fatal:t.type===Ct.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:n,stats:s})}handleNetworkError(e,t,i=!1,n,s){let o=`A network ${i?"timeout":"error"+(n?" (status "+n.code+")":"")} occurred while loading ${e.type}`;e.type===Ct.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===Ct.AUDIO_TRACK||e.type===Ct.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(o);this.hls.logger.warn(`[playlist-loader]: ${o}`);let l=ue.UNKNOWN,c=!1;const u=this.getInternalLoader(e);switch(e.type){case Ct.MANIFEST:l=i?ue.MANIFEST_LOAD_TIMEOUT:ue.MANIFEST_LOAD_ERROR,c=!0;break;case Ct.LEVEL:l=i?ue.LEVEL_LOAD_TIMEOUT:ue.LEVEL_LOAD_ERROR,c=!1;break;case Ct.AUDIO_TRACK:l=i?ue.AUDIO_TRACK_LOAD_TIMEOUT:ue.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case Ct.SUBTITLE_TRACK:l=i?ue.SUBTITLE_TRACK_LOAD_TIMEOUT:ue.SUBTITLE_LOAD_ERROR,c=!1;break}u&&this.resetInternalLoader(e.type);const h={type:Je.NETWORK_ERROR,details:l,fatal:c,url:e.url,loader:u,context:e,error:a,networkDetails:t,stats:s};if(n){const f=t?.url||e.url;h.response=Ht({url:f,data:void 0},n)}this.hls.trigger(L.ERROR,h)}handlePlaylistLoaded(e,t,i,n,s,o){const a=this.hls,{type:l,level:c,levelOrTrack:u,id:h,groupId:f,deliveryDirectives:d}=n,m=r0(t,n),A=D2(n);let p=typeof n.level=="number"&&A===$e.MAIN?c:void 0;const y=e.playlistParsingError;if(y){if(this.hls.logger.warn(`${y} ${e.url}`),!a.config.ignorePlaylistParsingErrors){a.trigger(L.ERROR,{type:Je.NETWORK_ERROR,details:ue.LEVEL_PARSING_ERROR,fatal:!1,url:m,error:y,reason:y.message,response:t,context:n,level:p,parent:A,networkDetails:s,stats:i});return}e.playlistParsingError=null}if(!e.fragments.length){const v=e.playlistParsingError=new Error("No Segments found in Playlist");a.trigger(L.ERROR,{type:Je.NETWORK_ERROR,details:ue.LEVEL_EMPTY_ERROR,fatal:!1,url:m,error:v,reason:v.message,response:t,context:n,level:p,parent:A,networkDetails:s,stats:i});return}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),l){case Ct.MANIFEST:case Ct.LEVEL:if(p){if(!u)p=0;else if(u!==a.levels[p]){const v=a.levels.indexOf(u);v>-1&&(p=v)}}a.trigger(L.LEVEL_LOADED,{details:e,levelInfo:u||a.levels[0],level:p||0,id:h||0,stats:i,networkDetails:s,deliveryDirectives:d,withoutMultiVariant:l===Ct.MANIFEST});break;case Ct.AUDIO_TRACK:a.trigger(L.AUDIO_TRACK_LOADED,{details:e,track:u,id:h||0,groupId:f||"",stats:i,networkDetails:s,deliveryDirectives:d});break;case Ct.SUBTITLE_TRACK:a.trigger(L.SUBTITLE_TRACK_LOADED,{details:e,track:u,id:h||0,groupId:f||"",stats:i,networkDetails:s,deliveryDirectives:d});break}}}class dr{static get version(){return yc}static isMSESupported(){return lp()}static isSupported(){return BC()}static getMediaSource(){return yr()}static get Events(){return L}static get MetadataSchema(){return xn}static get ErrorTypes(){return Je}static get ErrorDetails(){return ue}static get DefaultConfig(){return dr.defaultConfig?dr.defaultConfig:ZM}static set DefaultConfig(e){dr.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new qA,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=O9(e.debug||!1,"Hls instance",e.assetPlayerId),i=this.config=tL(dr.DefaultConfig,e,t);this.userConfig=e,i.progressive&&iL(i,t);const{abrController:n,bufferController:s,capLevelController:o,errorController:a,fpsController:l}=i,c=new a(this),u=this.abrController=new n(this),h=new BR(this),f=i.interstitialsController,d=f?this.interstitialsController=new f(this,dr):null,m=this.bufferController=new s(this,h),A=this.capLevelController=new o(this),p=new l(this),y=new AL(this),v=i.contentSteeringController,E=v?new v(this):null,x=this.levelController=new uL(this,E),I=new lL(this),C=new mL(this.config,this.logger),_=this.streamController=new dL(this,h,C),S=this.gapController=new oL(this,h);A.setStreamController(_),p.setStreamController(_);const b=[y,x,_];d&&b.splice(1,0,d),E&&b.splice(1,0,E),this.networkControllers=b;const T=[u,m,S,A,p,I,h];this.audioTrackController=this.createController(i.audioTrackController,b);const R=i.audioStreamController;R&&b.push(this.audioStreamController=new R(this,h,C)),this.subtitleTrackController=this.createController(i.subtitleTrackController,b);const w=i.subtitleStreamController;w&&b.push(this.subtititleStreamController=new w(this,h,C)),this.createController(i.timelineController,T),C.emeController=this.emeController=this.createController(i.emeController,T),this.cmcdController=this.createController(i.cmcdController,T),this.latencyController=this.createController(cL,T),this.coreComponents=T,b.push(c);const B=c.onErrorOut;typeof B=="function"&&this.on(L.ERROR,B,c),this.on(L.MANIFEST_LOADED,y.onManifestLoaded,y)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,n){this._emitter.off(e,t,i,n)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const n=e===L.ERROR;this.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.INTERNAL_EXCEPTION,fatal:n,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(L.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const s=new Error(`attachMedia failed: invalid argument (${e})`);this.trigger(L.ERROR,{type:Je.OTHER_ERROR,details:ue.ATTACH_MEDIA_ERROR,fatal:!0,error:s});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,i=t?e.media:e,n=t?e:{media:i};this._media=i,this.trigger(L.MEDIA_ATTACHING,n)}detachMedia(){this.logger.log("detachMedia"),this.trigger(L.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(L.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,i=this._url,n=this._url=NA.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${n}`),t&&i&&(i!==n||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(L.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let i=0;i<this.networkControllers.length&&(this.networkControllers[i].startLoad(e,t),!(!this.started||!this.networkControllers));i++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!(this.started||!this.networkControllers));e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[$e.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[$e.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[$e.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=e?.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=uM()),e}get levels(){const e=this.levelController.levels;return e||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){AR(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let n=0;n<i;n++)if(e[n].maxBitrate>=t)return n;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let n;if(t===-1&&e!=null&&e.length?n=e.length-1:n=t,i)for(let s=n;s--;){const o=e[s].attrs["HDCP-LEVEL"];if(o&&o<=i)return s}return n}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return((t=this.audioTrackController)==null?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return((t=this.subtitleTrackController)==null?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!!((e=this.bufferController)!=null&&e.bufferedToEnd)}get interstitialsManager(){var e;return((e=this.interstitialsController)==null?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){const i=sI(t);return iI(e,i,navigator.mediaCapabilities)}}dr.defaultConfig=void 0;const pL=Object.freeze(Object.defineProperty({__proto__:null,AbrController:rI,AttrList:li,AudioStreamController:$I,AudioTrackController:WI,BasePlaylistController:vf,BaseSegment:GA,BaseStreamController:gf,BufferController:qI,CMCDController:aC,CapLevelController:Ef,ChunkMetadata:pf,ContentSteeringController:lC,Cues:TC,DateRange:$A,EMEController:po,ErrorActionFlags:En,ErrorController:uI,ErrorDetails:ue,ErrorTypes:Je,Events:L,FPSController:uC,FetchLoader:Qm,Fragment:ah,Hls:dr,HlsSkip:ec,HlsUrlParameters:bm,KeySystemFormats:Wi,KeySystems:ci,Level:Fa,LevelDetails:dI,LevelKey:Qr,LoadStats:mf,M3U8Parser:Ss,MetadataSchema:xn,NetworkErrorAction:Ui,Part:Vx,PlaylistLevelType:$e,SubtitleStreamController:AC,SubtitleTrackController:dC,TimelineController:_C,XhrLoader:ap,default:dr,fetchSupported:bC,getMediaSource:yr,isMSESupported:lp,isSupported:BC,requestMediaKeySystemAccess:jA},Symbol.toStringTag,{value:"Module"})),gL=((r,e)=>typeof window<"u"&&typeof((r=window.document)==null?void 0:r.createElement)=="function"&&typeof((e=window.navigator)==null?void 0:e.userAgent)=="string")();let o0=null;async function yL(...r){var e;(e=o0)!==null&&e!==void 0||(o0=await sE(()=>Promise.resolve().then(()=>pL),void 0));const t=o0.default;return t.isSupported()?new t(...r):null}function vL(r,{unsuspend:e="loadedmetadata",start:t=!0,hls:i={},crossOrigin:n="anonymous",muted:s=!0,loop:o=!0,playsInline:a=!0,onVideoFrame:l,...c}={}){const u=ae(m=>m.gl),h=g.useRef(null),f=Er(()=>new Promise(async m=>{let A,p;typeof r=="string"?A=r:p=r;const y=Object.assign(document.createElement("video"),{src:A,srcObject:p,crossOrigin:n,loop:o,muted:s,playsInline:a,...c});if(A&&gL&&A.endsWith(".m3u8")){const E=h.current=await yL(i);E&&(E.on(L.MEDIA_ATTACHED,()=>void E.loadSource(A)),E.attachMedia(y))}const v=new f_(y);"colorSpace"in v?v.colorSpace=u.outputColorSpace:v.encoding=u.outputEncoding,y.addEventListener(e,()=>m(v))}),[r]),d=f.source.data;return EL(d,l),g.useEffect(()=>(t&&f.image.play(),()=>{h.current&&(h.current.destroy(),h.current=null)}),[f,t]),f}const cp=g.forwardRef(({children:r,src:e,...t},i)=>{const n=vL(e,t);return g.useEffect(()=>()=>void n.dispose(),[n]),g.useImperativeHandle(i,()=>n,[n]),g.createElement(g.Fragment,null,r?.(n))}),EL=(r,e)=>{g.useEffect(()=>{if(!e||!r.requestVideoFrameCallback)return;let t;const i=(...n)=>{e(...n),t=r.requestVideoFrameCallback(i)};return r.requestVideoFrameCallback(i),()=>r.cancelVideoFrameCallback(t)},[r,e])},Ah=(r,e)=>{if(Array.isArray(r))return r[0];{const t=e??Object.keys(r)[0];return r[t][0]}},xL=r=>{for(let e=3;e<r.length;e+=4)if(r[e]!==0)return!1;return!0};function up(r,e,t,i,n,s){const o=g.useRef(ae(w=>w.viewport)),a=g.useRef(null),l=g.useRef(0),c=.1,u=g.useRef(r),h=g.useRef(e),f=g.useRef(t),[d,m]=g.useState(null),[A,p]=g.useState(new tn),y=g.useMemo(()=>new pr,[]),[v,E]=g.useState(null),x=g.useCallback((w,B,M)=>{const O=B*(o.current.aspect>w/B?o.current.width/w:o.current.height/B),Y=w*(o.current.aspect>w/B?o.current.width/w:o.current.height/B)*M,W=O*M,N=1;let K=Math.min(N,Y),D=Math.min(N,W);return Y>N&&(K=N,D=W/Y*N),new Q(K,D,1)},[]),I=g.useCallback((w,B)=>{if(w.image){const M=document.createElement("canvas"),O=M.getContext("2d",s);if(!O)throw new Error("Failed to get 2d context");M.width=w.image.width,M.height=w.image.height,O.drawImage(w.image,0,0);const U=w.image.width,Y=w.image.height,W=Math.round(Math.sqrt(B*(U/Y))),N=Math.round(B/W),K=U/W,D=Y/N,z=[];for(let $=0;$<N;$++)for(let V=0;V<W;V++){if($*W+V>=B){z.push({row:$,col:V});continue}const G=O.getImageData(V*K,$*D,K,D).data;xL(G)&&z.push({row:$,col:V})}return{rows:N,columns:W,frameWidth:K,frameHeight:D,emptyFrames:z}}else return{rows:0,columns:0,frameWidth:0,frameHeight:0,emptyFrames:[]}},[s]),C=g.useCallback(w=>{const B=M=>{let O=null;for(const Y of M){const{w:W,h:N}=Y.frame,K=W*N;(!O||K>O.area)&&(O={w:W,h:N,area:K})}return M.map(Y=>{const{w:W,h:N}=Y.frame,K=W*N,D=O?K===O.area?1:Math.sqrt(K/O.area):1;return{...Y,scaleRatio:D}})};if(Array.isArray(w))return B(w);{const M={};for(const O in w)M[O]=B(w[O]);return M}},[]),_=g.useCallback(()=>{const w={},B=a.current,M=f.current;if(B)if(M&&Array.isArray(B.frames)){for(let O=0;O<M.length;O++){w[M[O]]=[];for(const U of B.frames){const Y=U.frame,W=U.sourceSize.w,N=U.sourceSize.h;typeof U.filename=="string"&&U.filename.toLowerCase().indexOf(M[O].toLowerCase())!==-1&&w[M[O]].push({...U,frame:Y,sourceSize:{w:W,h:N}})}}for(const O in w){const U=C(w[O]);Array.isArray(U)&&(w[O]=U)}return w}else if(M&&typeof B.frames=="object"){for(let O=0;O<M.length;O++){w[M[O]]=[];for(const U in B.frames){const Y=B.frames[U],W=Y.frame,N=Y.sourceSize.w,K=Y.sourceSize.h;typeof U=="string"&&U.toLowerCase().indexOf(M[O].toLowerCase())!==-1&&w[M[O]].push({...Y,frame:W,sourceSize:{w:N,h:K}})}}for(const O in w){const U=C(w[O]);Array.isArray(U)&&(w[O]=U)}return w}else{let O=[];return B!=null&&B.frames&&(Array.isArray(B.frames)?O=B.frames.map(U=>({...U,x:U.frame.x,y:U.frame.y,w:U.frame.w,h:U.frame.h})):O=Object.values(B.frames).flat().map(U=>({...U,x:U.frame.x,y:U.frame.y,w:U.frame.w,h:U.frame.h}))),C(O)}return[]},[C,a]),S=g.useCallback((w,B)=>{let M=new Q(1,1,1);if(w===null){if(B&&i){const O=B.image.width,U=B.image.height;l.current=i;const{rows:Y,columns:W,frameWidth:N,frameHeight:K,emptyFrames:D}=I(B,i),z={frames:[],meta:{version:"1.0",size:{w:O,h:U},rows:Y,columns:W,frameWidth:N,frameHeight:K,scale:"1"}};for(let $=0;$<Y;$++)for(let V=0;V<W;V++)(D??[]).some(G=>G.row===$&&G.col===V)||Array.isArray(z.frames)&&z.frames.push({frame:{x:V*N,y:$*K,w:N,h:K},scaleRatio:1,rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:N,h:K},sourceSize:{w:N,h:K}});M=x(N,K,c),a.current=z}a.current&&a.current.frames&&(a.current.frames=C(a.current.frames))}else if(B){a.current=w,a.current.frames=_(),l.current=Array.isArray(w.frames)?w.frames.length:Object.keys(w.frames).length;const{w:O,h:U}=Ah(w.frames).sourceSize;M=x(O,U,c)}m(a.current),"encoding"in B?B.encoding=3001:"colorSpace"in B&&(B.colorSpace=TE),p(B),E({spriteTexture:B,spriteData:a.current,aspect:M})},[I,i,_,x,C]),b=g.useCallback((w,B,M)=>{const O=fetch(w).then(Y=>Y.json()),U=new Promise(Y=>{y.load(B,Y)});Promise.all([O,U]).then(Y=>{M(Y[0],Y[1])})},[y]),T=g.useCallback(w=>{if(!w&&!u.current)throw new Error("Either textureUrl or input must be provided");const B=w??u.current;if(!B)throw new Error("A valid texture URL must be provided");y.load(B,M=>S(null,M))},[y,S]),R=g.useCallback((w,B)=>{B&&w?b(B,w,S):T(w)},[b,T,S]);return g.useLayoutEffect(()=>{h.current&&u.current?b(h.current,u.current,S):u.current&&T();const w=u.current;return()=>{w&&hi.clear(pr,w)}},[b,T,S]),g.useLayoutEffect(()=>{n?.(A,d??null)},[A,d,n]),{spriteObj:v,loadJsonAndTexture:R}}up.preload=r=>hi.preload(pr,r);up.clear=r=>hi.clear(pr,r);function RC(r,e,...t){const i=g.useRef(),n=ae(s=>s.scene);return g.useLayoutEffect(()=>{let s;if(r&&r!=null&&r.current&&e&&(i.current=s=new e(r.current,...t)),s)return s.traverse(o=>o.raycast=()=>null),n.add(s),()=>{i.current=void 0,n.remove(s),s.dispose==null||s.dispose()}},[n,e,r,...t]),Ve(()=>{var s;return void((s=i.current)==null||s.update==null?void 0:s.update())}),i}const QU=({type:r,args:e=[]})=>{const t=g.useRef(null),i=g.useRef(null);return g.useLayoutEffect(()=>{i.current=t.current.parent}),RC(i,r,...e),g.createElement("object3D",{ref:t})};var ph={exports:{}},IL=ph.exports,M2;function CL(){return M2||(M2=1,(function(r,e){(function(t,i){r.exports=i()})(IL,function(){var t=function(){function i(d){return o.appendChild(d.dom),d}function n(d){for(var m=0;m<o.children.length;m++)o.children[m].style.display=m===d?"block":"none";s=d}var s=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(d){d.preventDefault(),n(++s%o.children.length)},!1);var a=(performance||Date).now(),l=a,c=0,u=i(new t.Panel("FPS","#0ff","#002")),h=i(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=i(new t.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:o,addPanel:i,showPanel:n,begin:function(){a=(performance||Date).now()},end:function(){c++;var d=(performance||Date).now();if(h.update(d-a,200),d>l+1e3&&(u.update(1e3*c/(d-l),100),l=d,c=0,f)){var m=performance.memory;f.update(m.usedJSHeapSize/1048576,m.jsHeapSizeLimit/1048576)}return d},update:function(){a=this.end()},domElement:o,setMode:n}};return t.Panel=function(i,n,s){var o=1/0,a=0,l=Math.round,c=l(window.devicePixelRatio||1),u=80*c,h=48*c,f=3*c,d=2*c,m=3*c,A=15*c,p=74*c,y=30*c,v=document.createElement("canvas");v.width=u,v.height=h,v.style.cssText="width:80px;height:48px";var E=v.getContext("2d");return E.font="bold "+9*c+"px Helvetica,Arial,sans-serif",E.textBaseline="top",E.fillStyle=s,E.fillRect(0,0,u,h),E.fillStyle=n,E.fillText(i,f,d),E.fillRect(m,A,p,y),E.fillStyle=s,E.globalAlpha=.9,E.fillRect(m,A,p,y),{dom:v,update:function(x,I){o=Math.min(o,x),a=Math.max(a,x),E.fillStyle=s,E.globalAlpha=1,E.fillRect(0,0,u,A),E.fillStyle=n,E.fillText(l(x)+" "+i+" ("+l(o)+"-"+l(a)+")",f,d),E.drawImage(v,m+c,A,p-c,y,m,A,p-c,y),E.fillRect(m+p-c,A,c,y),E.fillStyle=s,E.globalAlpha=.9,E.fillRect(m+p-c,A,c,l((1-x/I)*y))}}},t})})(ph)),ph.exports}var _L=CL();const SL=rE(_L);function TL(r,e=[],t){const[i,n]=g.useState();return g.useLayoutEffect(()=>{const s=r();return n(s),()=>void 0},e),i}function zU({showPanel:r=0,className:e,parent:t}){const i=TL(()=>new SL,[]);return g.useEffect(()=>{if(i){const n=t&&t.current||document.body;i.showPanel(r),n?.appendChild(i.dom);const s=(e??"").split(" ").filter(l=>l);s.length&&i.dom.classList.add(...s);const o=aA(()=>i.begin()),a=lA(()=>i.end());return()=>{s.length&&i.dom.classList.remove(...s),n?.removeChild(i.dom),o(),a()}}},[t,i,e,r]),null}class bL{constructor(e,t,i){this.name=e,this.fg=t,this.bg=i,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const e=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let t;const i=this.fg;switch(this.fg.toLowerCase()){case"#0ff":t="#006666";break;case"#0f0":t="#006600";break;case"#ff0":t="#666600";break;case"#e1e1e1":t="#666666";break;default:t=this.bg;break}return e.addColorStop(0,t),e.addColorStop(1,i),e}initializeCanvas(){this.context&&(this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.fg,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(e,t,i,n,s=0){if(!this.context||!this.gradient)return;const o=Math.min(1/0,e),a=Math.max(i,e);n=Math.max(n,t),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(`${e.toFixed(s)} ${this.name} (${o.toFixed(s)}-${parseFloat(a.toFixed(s))})`,this.TEXT_X,this.TEXT_Y),this.context.drawImage(this.canvas,this.GRAPH_X+this.PR,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT,this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT);const l=this.GRAPH_HEIGHT-(1-t/n)*this.GRAPH_HEIGHT;l>0&&(this.context.globalAlpha=1,this.context.fillStyle=this.gradient,this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y+this.GRAPH_HEIGHT-l,this.PR,l))}}const DC=class ua{constructor({trackGPU:e=!1,logsPerSecond:t=30,samplesLog:i=60,samplesGraph:n=10,precision:s=2,minimal:o=!1,horizontal:a=!0,mode:l=0}={}){this.gl=null,this.ext=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.frames=0,this.renderCount=0,this.isRunningCPUProfiling=!1,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.totalFps=0,this.gpuPanel=null,this.gpuPanelCompute=null,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.handleClick=c=>{c.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.resizePanel(this.fpsPanel,0),this.resizePanel(this.msPanel,1),this.gpuPanel&&this.resizePanel(this.gpuPanel,2),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute,3)},this.mode=l,this.horizontal=a,this.minimal=o,this.trackGPU=e,this.samplesLog=i,this.samplesGraph=n,this.precision=s,this.logsPerSecond=t,this.dom=document.createElement("div"),this.initializeDOM(),this.beginTime=performance.now(),this.prevTime=this.beginTime,this.prevCpuTime=this.beginTime,this.fpsPanel=this.addPanel(new ua.Panel("FPS","#0ff","#002"),0),this.msPanel=this.addPanel(new ua.Panel("CPU","#0f0","#020"),1),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      opacity: 0.9;
      z-index: 10000;
      ${this.minimal?"cursor: pointer;":""}
    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}async init(e){if(!e){console.error('Stats: The "canvas" parameter is undefined.');return}this.handleThreeRenderer(e)||await this.handleWebGPURenderer(e)||this.initializeWebGL(e)}handleThreeRenderer(e){return e.isWebGLRenderer&&!this.threeRendererPatched?(this.patchThreeRenderer(e),this.gl=e.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0):!1}async handleWebGPURenderer(e){return e.isWebGPURenderer?(this.trackGPU&&(e.backend.trackTimestamp=!0,await e.hasFeatureAsync("timestamp-query")&&this.initializeWebGPUPanels()),this.info=e.info,!0):!1}initializeWebGPUPanels(){this.gpuPanel=this.addPanel(new ua.Panel("GPU","#ff0","#220"),2),this.gpuPanelCompute=this.addPanel(new ua.Panel("CPT","#e1e1e1","#212121"),3)}initializeWebGL(e){if(e instanceof WebGL2RenderingContext)this.gl=e;else if(e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas){if(this.gl=e.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}else return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&(this.gpuPanel=this.addPanel(new ua.Panel("GPU","#ff0","#220"),2)))}begin(){this.isRunningCPUProfiling||this.beginProfiling("cpu-started"),!(!this.gl||!this.ext)&&(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery))}end(){this.renderCount++,this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null)}update(){this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.updateAverages(),this.resetCounters()}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp,this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu)}resetCounters(){this.renderCount=0,this.totalCpuDuration===0&&this.beginProfiling("cpu-started"),this.totalCpuDuration=0,this.totalFps=0,this.beginTime=this.endInternal()}resizePanel(e,t){e.canvas.style.position="absolute",this.minimal?e.canvas.style.display="none":(e.canvas.style.display="block",this.horizontal?(e.canvas.style.top="0px",e.canvas.style.left=t*e.WIDTH/e.PR+"px"):(e.canvas.style.left="0px",e.canvas.style.top=t*e.HEIGHT/e.PR+"px"))}addPanel(e,t){return e.canvas&&(this.dom.appendChild(e.canvas),this.resizePanel(e,t)),e}showPanel(e){for(let t=0;t<this.dom.children.length;t++){const i=this.dom.children[t];i.style.display=t===e?"block":"none"}this.mode=e}processGpuQueries(){!this.gl||!this.ext||(this.totalGpuDuration=0,this.gpuQueries.forEach((e,t)=>{if(this.gl){const i=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT_AVAILABLE),n=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(i&&!n){const o=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT)*1e-6;this.totalGpuDuration+=o,this.gl.deleteQuery(e.query),this.gpuQueries.splice(t,1)}}}))}endInternal(){this.frames++;const e=(performance||Date).now(),t=e-this.prevTime;if(e>=this.prevCpuTime+1e3/this.logsPerSecond){const i=Math.round(this.frames*1e3/t);this.addToAverage(i,this.averageFps),this.updatePanel(this.fpsPanel,this.averageFps,0),this.updatePanel(this.msPanel,this.averageCpu,this.precision),this.updatePanel(this.gpuPanel,this.averageGpu,this.precision),this.gpuPanelCompute&&this.updatePanel(this.gpuPanelCompute,this.averageGpuCompute),this.frames=0,this.prevCpuTime=e,this.prevTime=e}return e}addToAverage(e,t){t.logs.push(e),t.logs.length>this.samplesLog&&t.logs.shift(),t.graph.push(e),t.graph.length>this.samplesGraph&&t.graph.shift()}beginProfiling(e){window.performance&&(window.performance.mark(e),this.isRunningCPUProfiling=!0)}endProfiling(e,t,i){if(window.performance&&t&&this.isRunningCPUProfiling){window.performance.mark(t);const n=performance.measure(i,e,t);this.totalCpuDuration+=n.duration,this.isRunningCPUProfiling=!1}}updatePanel(e,t,i=2){if(t.logs.length>0){let n=0,s=.01;for(let l=0;l<t.logs.length;l++)n+=t.logs[l],t.logs[l]>s&&(s=t.logs[l]);let o=0,a=.01;for(let l=0;l<t.graph.length;l++)o+=t.graph[l],t.graph[l]>a&&(a=t.graph[l]);e&&e.update(n/Math.min(t.logs.length,this.samplesLog),o/Math.min(t.graph.length,this.samplesGraph),s,a,i)}}get domElement(){return this.dom}patchThreeRenderer(e){const t=e.render,i=this;e.render=function(n,s){i.begin(),t.call(this,n,s),i.end()},this.threeRendererPatched=!0}};DC.Panel=bL;let wL=DC;const HU=g.forwardRef(function({className:e,parent:t,id:i,clearStatsGlStyle:n,...s},o){const a=ae(c=>c.gl),l=g.useMemo(()=>{const c=new wL({...s});return c.init(a),c},[a]);return g.useImperativeHandle(o,()=>l.domElement,[l]),g.useEffect(()=>{if(l){const c=t&&t.current||document.body;c?.appendChild(l.domElement),l.domElement.querySelectorAll("canvas").forEach(f=>{f.style.removeProperty("position")}),i&&(l.domElement.id=i),n&&l.domElement.removeAttribute("style"),l.domElement.removeAttribute("style");const u=(e??"").split(" ").filter(f=>f);u.length&&l.domElement.classList.add(...u);const h=lA(()=>l.update());return()=>{u.length&&l.domElement.classList.remove(...u),c?.removeChild(l.domElement),h()}}},[t,l,e,i,n]),null});function VU({size:r=256,frames:e=1/0}={}){const t=ae(u=>u.viewport.dpr),{width:i,height:n}=ae(u=>u.size),s=r||i*t,o=r||n*t,a=g.useMemo(()=>{const u=new jh(s,o);return u.format=oA,u.type=Xh,{depthTexture:u}},[s,o]);let l=0;const c=In(s,o,a);return Ve(u=>{(e===1/0||l<e)&&(u.gl.setRenderTarget(c),u.gl.render(u.scene,u.camera),u.gl.setRenderTarget(null),l++)}),c.depthTexture}function KU(r,e,t=1){const i=ae(o=>o.viewport),n=e*(i.aspect>r/e?i.width/r:i.height/e);return[r*(i.aspect>r/e?i.width/r:i.height/e)*t,n*t,1]}function $U(r,e){const t=ae(n=>n.pointer),[i]=g.useState(()=>{const n=new $h;return e&&Un(n,e,{}),function(s,o){n.setFromCamera(t,r instanceof bE?r:r.current);const a=this.constructor.prototype.raycast.bind(this);a&&a(n,o)}});return i}function a0(r,e,t,i){return new(t||(t=Promise))((function(n,s){function o(c){try{l(i.next(c))}catch(u){s(u)}}function a(c){try{l(i.throw(c))}catch(u){s(u)}}function l(c){var u;c.done?n(c.value):(u=c.value,u instanceof t?u:new t((function(h){h(u)}))).then(o,a)}l((i=i.apply(r,[])).next())}))}const BL=["geforce 320m","geforce 8600","geforce 8600m gt","geforce 8800 gs","geforce 8800 gt","geforce 9400","geforce 9400m g","geforce 9400m","geforce 9600m gt","geforce 9600m","geforce fx go5200","geforce gt 120","geforce gt 130","geforce gt 330m","geforce gtx 285","google swiftshader","intel g41","intel g45","intel gma 4500mhd","intel gma x3100","intel hd 3000","intel q45","legacy","mali-2","mali-3","mali-4","quadro fx 1500","quadro fx 4","quadro fx 5","radeon hd 2400","radeon hd 2600","radeon hd 4670","radeon hd 4850","radeon hd 4870","radeon hd 5670","radeon hd 5750","radeon hd 6290","radeon hd 6300","radeon hd 6310","radeon hd 6320","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 6770m","radeon hd 6970m","sgx 543","sgx543"];function L2(r){return r=r.toLowerCase().replace(/.*angle ?\((.+)\)(?: on vulkan [0-9.]+)?$/i,"$1").replace(/\s(\d{1,2}gb|direct3d.+$)|\(r\)| \([^)]+\)$/g,"").replace(/(?:vulkan|opengl) \d+\.\d+(?:\.\d+)?(?: \((.*)\))?/,"$1")}const MC=typeof window>"u",Us=(()=>{if(MC)return;const{userAgent:r,platform:e,maxTouchPoints:t}=window.navigator,i=/(iphone|ipod|ipad)/i.test(r),n=e==="iPad"||e==="MacIntel"&&t>0&&!window.MSStream;return{isIpad:n,isMobile:/android/i.test(r)||i||n,isSafari12:/Version\/12.+Safari/.test(r),isFirefox:/Firefox/.test(r)}})();function RL(r,e,t){if(!t)return[e];const i=(function(c){const u=`
    precision highp float;
    attribute vec3 aPosition;
    varying float vvv;
    void main() {
      vvv = 0.31622776601683794;
      gl_Position = vec4(aPosition, 1.0);
    }
  `,h=`
    precision highp float;
    varying float vvv;
    void main() {
      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * vvv;
      enc = fract(enc);
      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
      gl_FragColor = enc;
    }
  `,f=c.createShader(35633),d=c.createShader(35632),m=c.createProgram();if(!(d&&f&&m))return;c.shaderSource(f,u),c.shaderSource(d,h),c.compileShader(f),c.compileShader(d),c.attachShader(m,f),c.attachShader(m,d),c.linkProgram(m),c.detachShader(m,f),c.detachShader(m,d),c.deleteShader(f),c.deleteShader(d),c.useProgram(m);const A=c.createBuffer();c.bindBuffer(34962,A),c.bufferData(34962,new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),35044);const p=c.getAttribLocation(m,"aPosition");c.vertexAttribPointer(p,3,5126,!1,0,0),c.enableVertexAttribArray(p),c.clearColor(1,1,1,1),c.clear(16384),c.viewport(0,0,1,1),c.drawArrays(4,0,3);const y=new Uint8Array(4);return c.readPixels(0,0,1,1,6408,5121,y),c.deleteProgram(m),c.deleteBuffer(A),y.join("")})(r),n="801621810",s="8016218135",o="80162181161",a=Us?.isIpad?[["a7",o,12],["a8",s,15],["a8x",s,15],["a9",s,15],["a9x",s,15],["a10",s,15],["a10x",s,15],["a12",n,15],["a12x",n,15],["a12z",n,15],["a14",n,15],["a15",n,15],["m1",n,15],["m2",n,15]]:[["a7",o,12],["a8",s,12],["a9",s,15],["a10",s,15],["a11",n,15],["a12",n,15],["a13",n,15],["a14",n,15],["a15",n,15],["a16",n,15],["a17",n,15]];let l;return i==="80162181255"?l=a.filter((([,,c])=>c>=14)):(l=a.filter((([,c])=>c===i)),l.length||(l=a)),l.map((([c])=>`apple ${c} gpu`))}let P2=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}};const l0=[],F2=[];function DL(r,e){if(r===e)return 0;const t=r;r.length>e.length&&(r=e,e=t);let i=r.length,n=e.length;for(;i>0&&r.charCodeAt(~-i)===e.charCodeAt(~-n);)i--,n--;let s,o=0;for(;o<i&&r.charCodeAt(o)===e.charCodeAt(o);)o++;if(i-=o,n-=o,i===0)return n;let a,l,c=0,u=0,h=0;for(;u<i;)F2[u]=r.charCodeAt(o+u),l0[u]=++u;for(;h<n;)for(s=e.charCodeAt(o+h),a=h++,c=h,u=0;u<i;u++)l=s===F2[u]?a:a+1,a=l0[u],c=l0[u]=a>c?l>c?c+1:l:l>a?a+1:l;return c}function ML(r){return r!=null}const LL=({mobileTiers:r=[0,15,30,60],desktopTiers:e=[0,15,30,60],override:t={},glContext:i,failIfMajorPerformanceCaveat:n=!1,benchmarksURL:s="https://unpkg.com/detect-gpu@5.0.70/dist/benchmarks"}={})=>a0(void 0,void 0,void 0,(function*(){const o={};if(MC)return{tier:0,type:"SSR"};const{isIpad:a=!!Us?.isIpad,isMobile:l=!!Us?.isMobile,screenSize:c=window.screen,loadBenchmarks:u=(I=>a0(void 0,void 0,void 0,(function*(){const C=yield fetch(`${s}/${I}`).then((_=>_.json()));if(parseInt(C.shift().split(".")[0],10)<4)throw new P2("Detect GPU benchmark data is out of date. Please update to version 4x");return C})))}=t;let{renderer:h}=t;const f=(I,C,_,S,b)=>({device:b,fps:S,gpu:_,isMobile:l,tier:I,type:C});let d,m="";if(h)h=L2(h),d=[h];else{const I=i||(function(_,S=!1){const b={alpha:!1,antialias:!1,depth:!1,failIfMajorPerformanceCaveat:S,powerPreference:"high-performance",stencil:!1};_&&delete b.powerPreference;const T=window.document.createElement("canvas"),R=T.getContext("webgl",b)||T.getContext("experimental-webgl",b);return R??void 0})(Us?.isSafari12,n);if(!I)return f(0,"WEBGL_UNSUPPORTED");const C=Us?.isFirefox?null:I.getExtension("WEBGL_debug_renderer_info");if(h=C?I.getParameter(C.UNMASKED_RENDERER_WEBGL):I.getParameter(I.RENDERER),!h)return f(1,"FALLBACK");m=h,h=L2(h),d=(function(_,S,b){return S==="apple gpu"?RL(_,S,b):[S]})(I,h,l)}const A=(yield Promise.all(d.map((function(I){var C;return a0(this,void 0,void 0,(function*(){const _=($=>{const V=l?["adreno","apple","mali-t","mali","nvidia","powervr","samsung"]:["intel","apple","amd","radeon","nvidia","geforce","adreno"];for(const P of V)if($.includes(P))return P})(I);if(!_)return;const S=`${l?"m":"d"}-${_}${a?"-ipad":""}.json`,b=o[S]=(C=o[S])!==null&&C!==void 0?C:u(S);let T;try{T=yield b}catch($){if($ instanceof P2)throw $;return}const R=(function($){var V;const P=($=$.replace(/\([^)]+\)/,"")).match(/\d+/)||$.match(/(\W|^)([A-Za-z]{1,3})(\W|$)/g);return(V=P?.join("").replace(/\W|amd/g,""))!==null&&V!==void 0?V:""})(I);let w=T.filter((([,$])=>$===R));w.length||(w=T.filter((([$])=>$.includes(I))));const B=w.length;if(B===0)return;const M=I.split(/[.,()\[\]/\s]/g).sort().filter((($,V,P)=>V===0||$!==P[V-1])).join(" ");let O,[U,,,,Y]=B>1?w.map(($=>[$,DL(M,$[2])])).sort((([,$],[,V])=>$-V))[0][0]:w[0],W=Number.MAX_VALUE;const{devicePixelRatio:N}=window,K=c.width*N*c.height*N;for(const $ of Y){const[V,P]=$,G=V*P,F=Math.abs(K-G);F<W&&(W=F,O=$)}if(!O)return;const[,,D,z]=O;return[W,D,U,z]}))})))).filter(ML).sort((([I=Number.MAX_VALUE,C],[_=Number.MAX_VALUE,S])=>I===_?C-S:I-_));if(!A.length){const I=BL.find((C=>h.includes(C)));return I?f(0,"BLOCKLISTED",I):f(1,"FALLBACK",`${h} (${m})`)}const[,p,y,v]=A[0];if(p===-1)return f(0,"BLOCKLISTED",y,p,v);const E=l?r:e;let x=0;for(let I=0;I<E.length;I++)p>=E[I]&&(x=I);return f(x,"BENCHMARK",y,p,v)})),PL=r=>Er(()=>LL(r),["useDetectGPU"]);function WU({children:r,...e}){const t=PL(e);return g.createElement(g.Fragment,null,r?.(t))}const LC=0,FL=1,If=2,k2=2,c0=1.25,O2=1,zr=32,Cf=65535,kL=Math.pow(2,-24),u0=Symbol("SKIP_GENERATION");function PC(r){return r.index?r.index.count:r.attributes.position.count}function Qa(r){return PC(r)/3}function FC(r,e=ArrayBuffer){return r>65535?new Uint32Array(new e(4*r)):new Uint16Array(new e(2*r))}function OL(r,e){if(!r.index){const t=r.attributes.position.count,i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=FC(t,i);r.setIndex(new Vt(n,1));for(let s=0;s<t;s++)n[s]=s}}function kC(r,e){const t=Qa(r),i=e||r.drawRange,n=i.start/3,s=(i.start+i.count)/3,o=Math.max(0,n),a=Math.min(t,s)-o;return[{offset:Math.floor(o),count:Math.floor(a)}]}function OC(r,e){if(!r.groups||!r.groups.length)return kC(r,e);const t=[],i=new Set,n=e||r.drawRange,s=n.start/3,o=(n.start+n.count)/3;for(const l of r.groups){const c=l.start/3,u=(l.start+l.count)/3;i.add(Math.max(s,c)),i.add(Math.min(o,u))}const a=Array.from(i.values()).sort((l,c)=>l-c);for(let l=0;l<a.length-1;l++){const c=a[l],u=a[l+1];t.push({offset:Math.floor(c),count:Math.floor(u-c)})}return t}function UL(r,e){const t=Qa(r),i=OC(r,e).sort((o,a)=>o.offset-a.offset),n=i[i.length-1];n.count=Math.min(t-n.offset,n.count);let s=0;return i.forEach(({count:o})=>s+=o),t!==s}function h0(r,e,t,i,n){let s=1/0,o=1/0,a=1/0,l=-1/0,c=-1/0,u=-1/0,h=1/0,f=1/0,d=1/0,m=-1/0,A=-1/0,p=-1/0;for(let y=e*6,v=(e+t)*6;y<v;y+=6){const E=r[y+0],x=r[y+1],I=E-x,C=E+x;I<s&&(s=I),C>l&&(l=C),E<h&&(h=E),E>m&&(m=E);const _=r[y+2],S=r[y+3],b=_-S,T=_+S;b<o&&(o=b),T>c&&(c=T),_<f&&(f=_),_>A&&(A=_);const R=r[y+4],w=r[y+5],B=R-w,M=R+w;B<a&&(a=B),M>u&&(u=M),R<d&&(d=R),R>p&&(p=R)}i[0]=s,i[1]=o,i[2]=a,i[3]=l,i[4]=c,i[5]=u,n[0]=h,n[1]=f,n[2]=d,n[3]=m,n[4]=A,n[5]=p}function NL(r,e=null,t=null,i=null){const n=r.attributes.position,s=r.index?r.index.array:null,o=Qa(r),a=n.normalized;let l;e===null?(l=new Float32Array(o*6*4),t=0,i=o):(l=e,t=t||0,i=i||o);const c=n.array,u=n.offset||0;let h=3;n.isInterleavedBufferAttribute&&(h=n.data.stride);const f=["getX","getY","getZ"];for(let d=t;d<t+i;d++){const m=d*3,A=d*6;let p=m+0,y=m+1,v=m+2;s&&(p=s[p],y=s[y],v=s[v]),a||(p=p*h+u,y=y*h+u,v=v*h+u);for(let E=0;E<3;E++){let x,I,C;a?(x=n[f[E]](p),I=n[f[E]](y),C=n[f[E]](v)):(x=c[p+E],I=c[y+E],C=c[v+E]);let _=x;I<_&&(_=I),C<_&&(_=C);let S=x;I>S&&(S=I),C>S&&(S=C);const b=(S-_)/2,T=E*2;l[A+T+0]=_+b,l[A+T+1]=b+(Math.abs(_)+b)*kL}}return l}function Ei(r,e,t){return t.min.x=e[r],t.min.y=e[r+1],t.min.z=e[r+2],t.max.x=e[r+3],t.max.y=e[r+4],t.max.z=e[r+5],t}function U2(r){let e=-1,t=-1/0;for(let i=0;i<3;i++){const n=r[i+3]-r[i];n>t&&(t=n,e=i)}return e}function N2(r,e){e.set(r)}function G2(r,e,t){let i,n;for(let s=0;s<3;s++){const o=s+3;i=r[s],n=e[s],t[s]=i<n?i:n,i=r[o],n=e[o],t[o]=i>n?i:n}}function bu(r,e,t){for(let i=0;i<3;i++){const n=e[r+2*i],s=e[r+2*i+1],o=n-s,a=n+s;o<t[i]&&(t[i]=o),a>t[i+3]&&(t[i+3]=a)}}function Sl(r){const e=r[3]-r[0],t=r[4]-r[1],i=r[5]-r[2];return 2*(e*t+t*i+i*e)}const ar=32,GL=(r,e)=>r.candidate-e.candidate,wr=new Array(ar).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),wu=new Float32Array(6);function QL(r,e,t,i,n,s){let o=-1,a=0;if(s===LC)o=U2(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(s===FL)o=U2(r),o!==-1&&(a=zL(t,i,n,o));else if(s===If){const l=Sl(r);let c=c0*n;const u=i*6,h=(i+n)*6;for(let f=0;f<3;f++){const d=e[f],p=(e[f+3]-d)/ar;if(n<ar/4){const y=[...wr];y.length=n;let v=0;for(let x=u;x<h;x+=6,v++){const I=y[v];I.candidate=t[x+2*f],I.count=0;const{bounds:C,leftCacheBounds:_,rightCacheBounds:S}=I;for(let b=0;b<3;b++)S[b]=1/0,S[b+3]=-1/0,_[b]=1/0,_[b+3]=-1/0,C[b]=1/0,C[b+3]=-1/0;bu(x,t,C)}y.sort(GL);let E=n;for(let x=0;x<E;x++){const I=y[x];for(;x+1<E&&y[x+1].candidate===I.candidate;)y.splice(x+1,1),E--}for(let x=u;x<h;x+=6){const I=t[x+2*f];for(let C=0;C<E;C++){const _=y[C];I>=_.candidate?bu(x,t,_.rightCacheBounds):(bu(x,t,_.leftCacheBounds),_.count++)}}for(let x=0;x<E;x++){const I=y[x],C=I.count,_=n-I.count,S=I.leftCacheBounds,b=I.rightCacheBounds;let T=0;C!==0&&(T=Sl(S)/l);let R=0;_!==0&&(R=Sl(b)/l);const w=O2+c0*(T*C+R*_);w<c&&(o=f,c=w,a=I.candidate)}}else{for(let E=0;E<ar;E++){const x=wr[E];x.count=0,x.candidate=d+p+E*p;const I=x.bounds;for(let C=0;C<3;C++)I[C]=1/0,I[C+3]=-1/0}for(let E=u;E<h;E+=6){let C=~~((t[E+2*f]-d)/p);C>=ar&&(C=ar-1);const _=wr[C];_.count++,bu(E,t,_.bounds)}const y=wr[ar-1];N2(y.bounds,y.rightCacheBounds);for(let E=ar-2;E>=0;E--){const x=wr[E],I=wr[E+1];G2(x.bounds,I.rightCacheBounds,x.rightCacheBounds)}let v=0;for(let E=0;E<ar-1;E++){const x=wr[E],I=x.count,C=x.bounds,S=wr[E+1].rightCacheBounds;I!==0&&(v===0?N2(C,wu):G2(C,wu,wu)),v+=I;let b=0,T=0;v!==0&&(b=Sl(wu)/l);const R=n-v;R!==0&&(T=Sl(S)/l);const w=O2+c0*(b*v+T*R);w<c&&(o=f,c=w,a=x.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${s} used.`);return{axis:o,pos:a}}function zL(r,e,t,i){let n=0;for(let s=e,o=e+t;s<o;s++)n+=r[s*6+i*2];return n/t}class f0{constructor(){this.boundingData=new Float32Array(6)}}function HL(r,e,t,i,n,s){let o=i,a=i+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){for(let u=0;u<3;u++){let h=e[o*3+u];e[o*3+u]=e[a*3+u],e[a*3+u]=h}for(let u=0;u<6;u++){let h=t[o*6+u];t[o*6+u]=t[a*6+u],t[a*6+u]=h}o++,a--}else return o}}function VL(r,e,t,i,n,s){let o=i,a=i+n-1;const l=s.pos,c=s.axis*2;for(;;){for(;o<=a&&t[o*6+c]<l;)o++;for(;o<=a&&t[a*6+c]>=l;)a--;if(o<a){let u=r[o];r[o]=r[a],r[a]=u;for(let h=0;h<6;h++){let f=t[o*6+h];t[o*6+h]=t[a*6+h],t[a*6+h]=f}o++,a--}else return o}}function cn(r,e){return e[r+15]===65535}function _n(r,e){return e[r+6]}function Nn(r,e){return e[r+14]}function ns(r){return r+8}function Gn(r,e){return e[r+6]}function hp(r,e){return e[r+7]}let UC,Vl,gh,NC;const KL=Math.pow(2,32);function Vm(r){return"count"in r?1:1+Vm(r.left)+Vm(r.right)}function $L(r,e,t){return UC=new Float32Array(t),Vl=new Uint32Array(t),gh=new Uint16Array(t),NC=new Uint8Array(t),Km(r,e)}function Km(r,e){const t=r/4,i=r/2,n="count"in e,s=e.boundingData;for(let o=0;o<6;o++)UC[t+o]=s[o];if(n)if(e.buffer){const o=e.buffer;NC.set(new Uint8Array(o),r);for(let a=r,l=r+o.byteLength;a<l;a+=zr){const c=a/2;cn(c,gh)||(Vl[a/4+6]+=t)}return r+o.byteLength}else{const o=e.offset,a=e.count;return Vl[t+6]=o,gh[i+14]=a,gh[i+15]=Cf,r+zr}else{const o=e.left,a=e.right,l=e.splitAxis;let c;if(c=Km(r+zr,o),c/4>KL)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return Vl[t+6]=c/4,c=Km(c,a),Vl[t+7]=l,c}}function YL(r,e){const t=(r.index?r.index.count:r.attributes.position.count)/3,i=t>2**16,n=i?4:2,s=e?new SharedArrayBuffer(t*n):new ArrayBuffer(t*n),o=i?new Uint32Array(s):new Uint16Array(s);for(let a=0,l=o.length;a<l;a++)o[a]=a;return o}function WL(r,e,t,i,n){const{maxDepth:s,verbose:o,maxLeafTris:a,strategy:l,onProgress:c,indirect:u}=n,h=r._indirectBuffer,f=r.geometry,d=f.index?f.index.array:null,m=u?VL:HL,A=Qa(f),p=new Float32Array(6);let y=!1;const v=new f0;return h0(e,t,i,v.boundingData,p),x(v,t,i,p),v;function E(I){c&&c(I/A)}function x(I,C,_,S=null,b=0){if(!y&&b>=s&&(y=!0,o&&(console.warn(`MeshBVH: Max depth of ${s} reached when generating BVH. Consider increasing maxDepth.`),console.warn(f))),_<=a||b>=s)return E(C+_),I.offset=C,I.count=_,I;const T=QL(I.boundingData,S,e,C,_,l);if(T.axis===-1)return E(C+_),I.offset=C,I.count=_,I;const R=m(h,d,e,C,_,T);if(R===C||R===C+_)E(C+_),I.offset=C,I.count=_;else{I.splitAxis=T.axis;const w=new f0,B=C,M=R-C;I.left=w,h0(e,B,M,w.boundingData,p),x(w,B,M,p,b+1);const O=new f0,U=R,Y=_-M;I.right=O,h0(e,U,Y,O.boundingData,p),x(O,U,Y,p,b+1)}return I}}function jL(r,e){const t=r.geometry;e.indirect&&(r._indirectBuffer=YL(t,e.useSharedArrayBuffer),UL(t,e.range)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),r._indirectBuffer||OL(t,e);const i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,n=NL(t),s=e.indirect?kC(t,e.range):OC(t,e.range);r._roots=s.map(o=>{const a=WL(r,n,o.offset,o.count,e),l=Vm(a),c=new i(zr*l);return $L(0,a,c),c})}class vr{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let i=1/0,n=-1/0;for(let s=0,o=e.length;s<o;s++){const l=e[s][t];i=l<i?l:i,n=l>n?l:n}this.min=i,this.max=n}setFromPoints(e,t){let i=1/0,n=-1/0;for(let s=0,o=t.length;s<o;s++){const a=t[s],l=e.dot(a);i=l<i?l:i,n=l>n?l:n}this.min=i,this.max=n}isSeparated(e){return this.min>e.max||e.min>this.max}}vr.prototype.setFromBox=(function(){const r=new Q;return function(t,i){const n=i.min,s=i.max;let o=1/0,a=-1/0;for(let l=0;l<=1;l++)for(let c=0;c<=1;c++)for(let u=0;u<=1;u++){r.x=n.x*l+s.x*(1-l),r.y=n.y*c+s.y*(1-c),r.z=n.z*u+s.z*(1-u);const h=t.dot(r);o=Math.min(h,o),a=Math.max(h,a)}this.min=o,this.max=a}})();const qL=(function(){const r=new Q,e=new Q,t=new Q;return function(n,s,o){const a=n.start,l=r,c=s.start,u=e;t.subVectors(a,c),r.subVectors(n.end,n.start),e.subVectors(s.end,s.start);const h=t.dot(u),f=u.dot(l),d=u.dot(u),m=t.dot(l),p=l.dot(l)*d-f*f;let y,v;p!==0?y=(h*f-m*d)/p:y=0,v=(h+y*f)/d,o.x=y,o.y=v}})(),fp=(function(){const r=new De,e=new Q,t=new Q;return function(n,s,o,a){qL(n,s,r);let l=r.x,c=r.y;if(l>=0&&l<=1&&c>=0&&c<=1){n.at(l,o),s.at(c,a);return}else if(l>=0&&l<=1){c<0?s.at(0,a):s.at(1,a),n.closestPointToPoint(a,!0,o);return}else if(c>=0&&c<=1){l<0?n.at(0,o):n.at(1,o),s.closestPointToPoint(o,!0,a);return}else{let u;l<0?u=n.start:u=n.end;let h;c<0?h=s.start:h=s.end;const f=e,d=t;if(n.closestPointToPoint(h,!0,e),s.closestPointToPoint(u,!0,t),f.distanceToSquared(h)<=d.distanceToSquared(u)){o.copy(f),a.copy(h);return}else{o.copy(u),a.copy(d);return}}}})(),XL=(function(){const r=new Q,e=new Q,t=new Xs,i=new $s;return function(s,o){const{radius:a,center:l}=s,{a:c,b:u,c:h}=o;if(i.start=c,i.end=u,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a||(i.start=c,i.end=h,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a)||(i.start=u,i.end=h,i.closestPointToPoint(l,!0,r).distanceTo(l)<=a))return!0;const A=o.getPlane(t);if(Math.abs(A.distanceToPoint(l))<=a){const y=A.projectPoint(l,e);if(o.containsPoint(y))return!0}return!1}})(),JL=1e-15;function d0(r){return Math.abs(r)<JL}class bs extends ha{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new Q),this.satBounds=new Array(4).fill().map(()=>new vr),this.points=[this.a,this.b,this.c],this.sphere=new hn,this.plane=new Xs,this.needsUpdate=!0}intersectsSphere(e){return XL(e,this)}update(){const e=this.a,t=this.b,i=this.c,n=this.points,s=this.satAxes,o=this.satBounds,a=s[0],l=o[0];this.getNormal(a),l.setFromPoints(a,n);const c=s[1],u=o[1];c.subVectors(e,t),u.setFromPoints(c,n);const h=s[2],f=o[2];h.subVectors(t,i),f.setFromPoints(h,n);const d=s[3],m=o[3];d.subVectors(i,e),m.setFromPoints(d,n),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}bs.prototype.closestPointToSegment=(function(){const r=new Q,e=new Q,t=new $s;return function(n,s=null,o=null){const{start:a,end:l}=n,c=this.points;let u,h=1/0;for(let f=0;f<3;f++){const d=(f+1)%3;t.start.copy(c[f]),t.end.copy(c[d]),fp(t,n,r,e),u=r.distanceToSquared(e),u<h&&(h=u,s&&s.copy(r),o&&o.copy(e))}return this.closestPointToPoint(a,r),u=a.distanceToSquared(r),u<h&&(h=u,s&&s.copy(r),o&&o.copy(a)),this.closestPointToPoint(l,r),u=l.distanceToSquared(r),u<h&&(h=u,s&&s.copy(r),o&&o.copy(l)),Math.sqrt(h)}})();bs.prototype.intersectsTriangle=(function(){const r=new bs,e=new Array(3),t=new Array(3),i=new vr,n=new vr,s=new Q,o=new Q,a=new Q,l=new Q,c=new Q,u=new $s,h=new $s,f=new $s,d=new Q;function m(A,p,y){const v=A.points;let E=0,x=-1;for(let I=0;I<3;I++){const{start:C,end:_}=u;C.copy(v[I]),_.copy(v[(I+1)%3]),u.delta(o);const S=d0(p.distanceToPoint(C));if(d0(p.normal.dot(o))&&S){y.copy(u),E=2;break}const b=p.intersectLine(u,d);if(!b&&S&&d.copy(C),(b||S)&&!d0(d.distanceTo(_))){if(E<=1)(E===1?y.start:y.end).copy(d),S&&(x=E);else if(E>=2){(x===1?y.start:y.end).copy(d),E=2;break}if(E++,E===2&&x===-1)break}}return E}return function(p,y=null,v=!1){this.needsUpdate&&this.update(),p.isExtendedTriangle?p.needsUpdate&&p.update():(r.copy(p),r.update(),p=r);const E=this.plane,x=p.plane;if(Math.abs(E.normal.dot(x.normal))>1-1e-10){const I=this.satBounds,C=this.satAxes;t[0]=p.a,t[1]=p.b,t[2]=p.c;for(let b=0;b<4;b++){const T=I[b],R=C[b];if(i.setFromPoints(R,t),T.isSeparated(i))return!1}const _=p.satBounds,S=p.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let b=0;b<4;b++){const T=_[b],R=S[b];if(i.setFromPoints(R,e),T.isSeparated(i))return!1}for(let b=0;b<4;b++){const T=C[b];for(let R=0;R<4;R++){const w=S[R];if(s.crossVectors(T,w),i.setFromPoints(s,e),n.setFromPoints(s,t),i.isSeparated(n))return!1}}return y&&(v||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),y.start.set(0,0,0),y.end.set(0,0,0)),!0}else{const I=m(this,x,h);if(I===1&&p.containsPoint(h.end))return y&&(y.start.copy(h.end),y.end.copy(h.end)),!0;if(I!==2)return!1;const C=m(p,E,f);if(C===1&&this.containsPoint(f.end))return y&&(y.start.copy(f.end),y.end.copy(f.end)),!0;if(C!==2)return!1;if(h.delta(a),f.delta(l),a.dot(l)<0){let B=f.start;f.start=f.end,f.end=B}const _=h.start.dot(a),S=h.end.dot(a),b=f.start.dot(a),T=f.end.dot(a),R=S<b,w=_<T;return _!==T&&b!==S&&R===w?!1:(y&&(c.subVectors(h.start,f.start),c.dot(a)>0?y.start.copy(h.start):y.start.copy(f.start),c.subVectors(h.end,f.end),c.dot(a)<0?y.end.copy(h.end):y.end.copy(f.end)),!0)}}})();bs.prototype.distanceToPoint=(function(){const r=new Q;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}})();bs.prototype.distanceToTriangle=(function(){const r=new Q,e=new Q,t=["a","b","c"],i=new $s,n=new $s;return function(o,a=null,l=null){const c=a||l?i:null;if(this.intersectsTriangle(o,c))return(a||l)&&(a&&c.getCenter(a),l&&c.getCenter(l)),0;let u=1/0;for(let h=0;h<3;h++){let f;const d=t[h],m=o[d];this.closestPointToPoint(m,r),f=m.distanceToSquared(r),f<u&&(u=f,a&&a.copy(r),l&&l.copy(m));const A=this[d];o.closestPointToPoint(A,r),f=A.distanceToSquared(r),f<u&&(u=f,a&&a.copy(A),l&&l.copy(r))}for(let h=0;h<3;h++){const f=t[h],d=t[(h+1)%3];i.set(this[f],this[d]);for(let m=0;m<3;m++){const A=t[m],p=t[(m+1)%3];n.set(o[A],o[p]),fp(i,n,r,e);const y=r.distanceToSquared(e);y<u&&(u=y,a&&a.copy(r),l&&l.copy(e))}}return Math.sqrt(u)}})();class fn{constructor(e,t,i){this.isOrientedBox=!0,this.min=new Q,this.max=new Q,this.matrix=new we,this.invMatrix=new we,this.points=new Array(8).fill().map(()=>new Q),this.satAxes=new Array(3).fill().map(()=>new Q),this.satBounds=new Array(3).fill().map(()=>new vr),this.alignedSatBounds=new Array(3).fill().map(()=>new vr),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),i&&this.matrix.copy(i)}set(e,t,i){this.min.copy(e),this.max.copy(t),this.matrix.copy(i),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}fn.prototype.update=(function(){return function(){const e=this.matrix,t=this.min,i=this.max,n=this.points;for(let c=0;c<=1;c++)for(let u=0;u<=1;u++)for(let h=0;h<=1;h++){const f=1*c|2*u|4*h,d=n[f];d.x=c?i.x:t.x,d.y=u?i.y:t.y,d.z=h?i.z:t.z,d.applyMatrix4(e)}const s=this.satBounds,o=this.satAxes,a=n[0];for(let c=0;c<3;c++){const u=o[c],h=s[c],f=1<<c,d=n[f];u.subVectors(a,d),h.setFromPoints(u,n)}const l=this.alignedSatBounds;l[0].setFromPointsField(n,"x"),l[1].setFromPointsField(n,"y"),l[2].setFromPointsField(n,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}})();fn.prototype.intersectsBox=(function(){const r=new vr;return function(t){this.needsUpdate&&this.update();const i=t.min,n=t.max,s=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(r.min=i.x,r.max=n.x,a[0].isSeparated(r)||(r.min=i.y,r.max=n.y,a[1].isSeparated(r))||(r.min=i.z,r.max=n.z,a[2].isSeparated(r)))return!1;for(let l=0;l<3;l++){const c=o[l],u=s[l];if(r.setFromBox(c,t),u.isSeparated(r))return!1}return!0}})();fn.prototype.intersectsTriangle=(function(){const r=new bs,e=new Array(3),t=new vr,i=new vr,n=new Q;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(r.copy(o),r.update(),o=r);const a=this.satBounds,l=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let f=0;f<3;f++){const d=a[f],m=l[f];if(t.setFromPoints(m,e),d.isSeparated(t))return!1}const c=o.satBounds,u=o.satAxes,h=this.points;for(let f=0;f<3;f++){const d=c[f],m=u[f];if(t.setFromPoints(m,h),d.isSeparated(t))return!1}for(let f=0;f<3;f++){const d=l[f];for(let m=0;m<4;m++){const A=u[m];if(n.crossVectors(d,A),t.setFromPoints(n,e),i.setFromPoints(n,h),t.isSeparated(i))return!1}}return!0}})();fn.prototype.closestPointToPoint=(function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}})();fn.prototype.distanceToPoint=(function(){const r=new Q;return function(t){return this.closestPointToPoint(t,r),t.distanceTo(r)}})();fn.prototype.distanceToBox=(function(){const r=["x","y","z"],e=new Array(12).fill().map(()=>new $s),t=new Array(12).fill().map(()=>new $s),i=new Q,n=new Q;return function(o,a=0,l=null,c=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(l||c)&&(o.getCenter(n),this.closestPointToPoint(n,i),o.closestPointToPoint(i,n),l&&l.copy(i),c&&c.copy(n)),0;const u=a*a,h=o.min,f=o.max,d=this.points;let m=1/0;for(let p=0;p<8;p++){const y=d[p];n.copy(y).clamp(h,f);const v=y.distanceToSquared(n);if(v<m&&(m=v,l&&l.copy(y),c&&c.copy(n),v<u))return Math.sqrt(v)}let A=0;for(let p=0;p<3;p++)for(let y=0;y<=1;y++)for(let v=0;v<=1;v++){const E=(p+1)%3,x=(p+2)%3,I=y<<E|v<<x,C=1<<p|y<<E|v<<x,_=d[I],S=d[C];e[A].set(_,S);const T=r[p],R=r[E],w=r[x],B=t[A],M=B.start,O=B.end;M[T]=h[T],M[R]=y?h[R]:f[R],M[w]=v?h[w]:f[R],O[T]=f[T],O[R]=y?h[R]:f[R],O[w]=v?h[w]:f[R],A++}for(let p=0;p<=1;p++)for(let y=0;y<=1;y++)for(let v=0;v<=1;v++){n.x=p?f.x:h.x,n.y=y?f.y:h.y,n.z=v?f.z:h.z,this.closestPointToPoint(n,i);const E=n.distanceToSquared(i);if(E<m&&(m=E,l&&l.copy(i),c&&c.copy(n),E<u))return Math.sqrt(E)}for(let p=0;p<12;p++){const y=e[p];for(let v=0;v<12;v++){const E=t[v];fp(y,E,i,n);const x=i.distanceToSquared(n);if(x<m&&(m=x,l&&l.copy(i),c&&c.copy(n),x<u))return Math.sqrt(x)}}return Math.sqrt(m)}})();class dp{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class ZL extends dp{constructor(){super(()=>new bs)}}const ss=new ZL;class eP{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=i=>{t&&e.push(t),t=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const oi=new eP;let Nr,pa;const Ko=[],Bu=new dp(()=>new Jt);function tP(r,e,t,i,n,s){Nr=Bu.getPrimitive(),pa=Bu.getPrimitive(),Ko.push(Nr,pa),oi.setBuffer(r._roots[e]);const o=$m(0,r.geometry,t,i,n,s);oi.clearBuffer(),Bu.releasePrimitive(Nr),Bu.releasePrimitive(pa),Ko.pop(),Ko.pop();const a=Ko.length;return a>0&&(pa=Ko[a-1],Nr=Ko[a-2]),o}function $m(r,e,t,i,n=null,s=0,o=0){const{float32Array:a,uint16Array:l,uint32Array:c}=oi;let u=r*2;if(cn(u,l)){const f=_n(r,c),d=Nn(u,l);return Ei(r,a,Nr),i(f,d,!1,o,s+r,Nr)}else{let T=function(w){const{uint16Array:B,uint32Array:M}=oi;let O=w*2;for(;!cn(O,B);)w=ns(w),O=w*2;return _n(w,M)},R=function(w){const{uint16Array:B,uint32Array:M}=oi;let O=w*2;for(;!cn(O,B);)w=Gn(w,M),O=w*2;return _n(w,M)+Nn(O,B)};const f=ns(r),d=Gn(r,c);let m=f,A=d,p,y,v,E;if(n&&(v=Nr,E=pa,Ei(m,a,v),Ei(A,a,E),p=n(v),y=n(E),y<p)){m=d,A=f;const w=p;p=y,y=w,v=E}v||(v=Nr,Ei(m,a,v));const x=cn(m*2,l),I=t(v,x,p,o+1,s+m);let C;if(I===k2){const w=T(m),M=R(m)-w;C=i(w,M,!0,o+1,s+m,v)}else C=I&&$m(m,e,t,i,n,s,o+1);if(C)return!0;E=pa,Ei(A,a,E);const _=cn(A*2,l),S=t(E,_,y,o+1,s+A);let b;if(S===k2){const w=T(A),M=R(A)-w;b=i(w,M,!0,o+1,s+A,E)}else b=S&&$m(A,e,t,i,n,s,o+1);return!!b}}const Tl=new Q,m0=new Q;function iP(r,e,t={},i=0,n=1/0){const s=i*i,o=n*n;let a=1/0,l=null;if(r.shapecast({boundsTraverseOrder:u=>(Tl.copy(e).clamp(u.min,u.max),Tl.distanceToSquared(e)),intersectsBounds:(u,h,f)=>f<a&&f<o,intersectsTriangle:(u,h)=>{u.closestPointToPoint(e,Tl);const f=e.distanceToSquared(Tl);return f<a&&(m0.copy(Tl),a=f,l=h),f<s}}),a===1/0)return null;const c=Math.sqrt(a);return t.point?t.point.copy(m0):t.point=m0.clone(),t.distance=c,t.faceIndex=l,t}const $o=new Q,Yo=new Q,Wo=new Q,Ru=new De,Du=new De,Mu=new De,Q2=new Q,z2=new Q,H2=new Q,Lu=new Q;function nP(r,e,t,i,n,s,o,a){let l;if(s===Oa?l=r.intersectTriangle(i,t,e,!0,n):l=r.intersectTriangle(e,t,i,s!==bi,n),l===null)return null;const c=r.origin.distanceTo(n);return c<o||c>a?null:{distance:c,point:n.clone()}}function sP(r,e,t,i,n,s,o,a,l,c,u){$o.fromBufferAttribute(e,s),Yo.fromBufferAttribute(e,o),Wo.fromBufferAttribute(e,a);const h=nP(r,$o,Yo,Wo,Lu,l,c,u);if(h){i&&(Ru.fromBufferAttribute(i,s),Du.fromBufferAttribute(i,o),Mu.fromBufferAttribute(i,a),h.uv=ha.getInterpolation(Lu,$o,Yo,Wo,Ru,Du,Mu,new De)),n&&(Ru.fromBufferAttribute(n,s),Du.fromBufferAttribute(n,o),Mu.fromBufferAttribute(n,a),h.uv1=ha.getInterpolation(Lu,$o,Yo,Wo,Ru,Du,Mu,new De)),t&&(Q2.fromBufferAttribute(t,s),z2.fromBufferAttribute(t,o),H2.fromBufferAttribute(t,a),h.normal=ha.getInterpolation(Lu,$o,Yo,Wo,Q2,z2,H2,new Q),h.normal.dot(r.direction)>0&&h.normal.multiplyScalar(-1));const f={a:s,b:o,c:a,normal:new Q,materialIndex:0};ha.getNormal($o,Yo,Wo,f.normal),h.face=f,h.faceIndex=s}return h}function _f(r,e,t,i,n,s,o){const a=i*3;let l=a+0,c=a+1,u=a+2;const h=r.index;r.index&&(l=h.getX(l),c=h.getX(c),u=h.getX(u));const{position:f,normal:d,uv:m,uv1:A}=r.attributes,p=sP(t,f,d,m,A,l,c,u,e,s,o);return p?(p.faceIndex=i,n&&n.push(p),p):null}function Mi(r,e,t,i){const n=r.a,s=r.b,o=r.c;let a=e,l=e+1,c=e+2;t&&(a=t.getX(a),l=t.getX(l),c=t.getX(c)),n.x=i.getX(a),n.y=i.getY(a),n.z=i.getZ(a),s.x=i.getX(l),s.y=i.getY(l),s.z=i.getZ(l),o.x=i.getX(c),o.y=i.getY(c),o.z=i.getZ(c)}function rP(r,e,t,i,n,s,o,a){const{geometry:l,_indirectBuffer:c}=r;for(let u=i,h=i+n;u<h;u++)_f(l,e,t,u,s,o,a)}function oP(r,e,t,i,n,s,o){const{geometry:a,_indirectBuffer:l}=r;let c=1/0,u=null;for(let h=i,f=i+n;h<f;h++){let d;d=_f(a,e,t,h,null,s,o),d&&d.distance<c&&(u=d,c=d.distance)}return u}function aP(r,e,t,i,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let u=r,h=e+r;u<h;u++){let f;if(f=u,Mi(o,f*3,l,c),o.needsUpdate=!0,i(o,f,n,s))return!0}return!1}function lP(r,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=r.geometry,i=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const u=r._roots;for(let f=0,d=u.length;f<d;f++)s=u[f],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),h(0,c),c+=s.byteLength;function h(f,d,m=!1){const A=f*2;if(a[A+15]===Cf){const y=o[f+6],v=a[A+14];let E=1/0,x=1/0,I=1/0,C=-1/0,_=-1/0,S=-1/0;for(let b=3*y,T=3*(y+v);b<T;b++){let R=i[b];const w=n.getX(R),B=n.getY(R),M=n.getZ(R);w<E&&(E=w),w>C&&(C=w),B<x&&(x=B),B>_&&(_=B),M<I&&(I=M),M>S&&(S=M)}return l[f+0]!==E||l[f+1]!==x||l[f+2]!==I||l[f+3]!==C||l[f+4]!==_||l[f+5]!==S?(l[f+0]=E,l[f+1]=x,l[f+2]=I,l[f+3]=C,l[f+4]=_,l[f+5]=S,!0):!1}else{const y=f+8,v=o[f+6],E=y+d,x=v+d;let I=m,C=!1,_=!1;e?I||(C=e.has(E),_=e.has(x),I=!C&&!_):(C=!0,_=!0);const S=I||C,b=I||_;let T=!1;S&&(T=h(y,d,I));let R=!1;b&&(R=h(v,d,I));const w=T||R;if(w)for(let B=0;B<3;B++){const M=y+B,O=v+B,U=l[M],Y=l[M+3],W=l[O],N=l[O+3];l[f+B]=U<W?U:W,l[f+B+3]=Y>N?Y:N}return w}}}function $r(r,e,t,i,n){let s,o,a,l,c,u;const h=1/t.direction.x,f=1/t.direction.y,d=1/t.direction.z,m=t.origin.x,A=t.origin.y,p=t.origin.z;let y=e[r],v=e[r+3],E=e[r+1],x=e[r+3+1],I=e[r+2],C=e[r+3+2];return h>=0?(s=(y-m)*h,o=(v-m)*h):(s=(v-m)*h,o=(y-m)*h),f>=0?(a=(E-A)*f,l=(x-A)*f):(a=(x-A)*f,l=(E-A)*f),s>l||a>o||((a>s||isNaN(s))&&(s=a),(l<o||isNaN(o))&&(o=l),d>=0?(c=(I-p)*d,u=(C-p)*d):(c=(C-p)*d,u=(I-p)*d),s>u||c>o)?!1:((c>s||s!==s)&&(s=c),(u<o||o!==o)&&(o=u),s<=n&&o>=i)}function cP(r,e,t,i,n,s,o,a){const{geometry:l,_indirectBuffer:c}=r;for(let u=i,h=i+n;u<h;u++){let f=c?c[u]:u;_f(l,e,t,f,s,o,a)}}function uP(r,e,t,i,n,s,o){const{geometry:a,_indirectBuffer:l}=r;let c=1/0,u=null;for(let h=i,f=i+n;h<f;h++){let d;d=_f(a,e,t,l?l[h]:h,null,s,o),d&&d.distance<c&&(u=d,c=d.distance)}return u}function hP(r,e,t,i,n,s,o){const{geometry:a}=t,{index:l}=a,c=a.attributes.position;for(let u=r,h=e+r;u<h;u++){let f;if(f=t.resolveTriangleIndex(u),Mi(o,f*3,l,c),o.needsUpdate=!0,i(o,f,n,s))return!0}return!1}function fP(r,e,t,i,n,s,o){oi.setBuffer(r._roots[e]),Ym(0,r,t,i,n,s,o),oi.clearBuffer()}function Ym(r,e,t,i,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:c}=oi,u=r*2;if(cn(u,l)){const f=_n(r,c),d=Nn(u,l);rP(e,t,i,f,d,n,s,o)}else{const f=ns(r);$r(f,a,i,s,o)&&Ym(f,e,t,i,n,s,o);const d=Gn(r,c);$r(d,a,i,s,o)&&Ym(d,e,t,i,n,s,o)}}const dP=["x","y","z"];function mP(r,e,t,i,n,s){oi.setBuffer(r._roots[e]);const o=Wm(0,r,t,i,n,s);return oi.clearBuffer(),o}function Wm(r,e,t,i,n,s){const{float32Array:o,uint16Array:a,uint32Array:l}=oi;let c=r*2;if(cn(c,a)){const h=_n(r,l),f=Nn(c,a);return oP(e,t,i,h,f,n,s)}else{const h=hp(r,l),f=dP[h],m=i.direction[f]>=0;let A,p;m?(A=ns(r),p=Gn(r,l)):(A=Gn(r,l),p=ns(r));const v=$r(A,o,i,n,s)?Wm(A,e,t,i,n,s):null;if(v){const I=v.point[f];if(m?I<=o[p+h]:I>=o[p+h+3])return v}const x=$r(p,o,i,n,s)?Wm(p,e,t,i,n,s):null;return v&&x?v.distance<=x.distance?v:x:v||x||null}}const Pu=new Jt,jo=new bs,qo=new bs,bl=new we,V2=new fn,Fu=new fn;function AP(r,e,t,i){oi.setBuffer(r._roots[e]);const n=jm(0,r,t,i);return oi.clearBuffer(),n}function jm(r,e,t,i,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=oi;let l=r*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),V2.set(t.boundingBox.min,t.boundingBox.max,i),n=V2),cn(l,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,m=t.attributes.position,A=_n(r,a),p=Nn(l,o);if(bl.copy(i).invert(),t.boundsTree)return Ei(r,s,Fu),Fu.matrix.copy(bl),Fu.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>Fu.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(i),v.b.applyMatrix4(i),v.c.applyMatrix4(i),v.needsUpdate=!0;for(let E=A*3,x=(p+A)*3;E<x;E+=3)if(Mi(qo,E,h,f),qo.needsUpdate=!0,v.intersectsTriangle(qo))return!0;return!1}});for(let y=A*3,v=(p+A)*3;y<v;y+=3){Mi(jo,y,h,f),jo.a.applyMatrix4(bl),jo.b.applyMatrix4(bl),jo.c.applyMatrix4(bl),jo.needsUpdate=!0;for(let E=0,x=d.count;E<x;E+=3)if(Mi(qo,E,d,m),qo.needsUpdate=!0,jo.intersectsTriangle(qo))return!0}}else{const u=r+8,h=a[r+6];return Ei(u,s,Pu),!!(n.intersectsBox(Pu)&&jm(u,e,t,i,n)||(Ei(h,s,Pu),n.intersectsBox(Pu)&&jm(h,e,t,i,n)))}}const ku=new we,A0=new fn,wl=new fn,pP=new Q,gP=new Q,yP=new Q,vP=new Q;function EP(r,e,t,i={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),A0.set(e.boundingBox.min,e.boundingBox.max,t),A0.needsUpdate=!0;const a=r.geometry,l=a.attributes.position,c=a.index,u=e.attributes.position,h=e.index,f=ss.getPrimitive(),d=ss.getPrimitive();let m=pP,A=gP,p=null,y=null;n&&(p=yP,y=vP);let v=1/0,E=null,x=null;return ku.copy(t).invert(),wl.matrix.copy(ku),r.shapecast({boundsTraverseOrder:I=>A0.distanceToBox(I),intersectsBounds:(I,C,_)=>_<v&&_<o?(C&&(wl.min.copy(I.min),wl.max.copy(I.max),wl.needsUpdate=!0),!0):!1,intersectsRange:(I,C)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:S=>wl.distanceToBox(S),intersectsBounds:(S,b,T)=>T<v&&T<o,intersectsRange:(S,b)=>{for(let T=S,R=S+b;T<R;T++){Mi(d,3*T,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let w=I,B=I+C;w<B;w++){Mi(f,3*w,c,l),f.needsUpdate=!0;const M=f.distanceToTriangle(d,m,p);if(M<v&&(A.copy(m),y&&y.copy(p),v=M,E=w,x=T),M<s)return!0}}}});{const _=Qa(e);for(let S=0,b=_;S<b;S++){Mi(d,3*S,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=I,R=I+C;T<R;T++){Mi(f,3*T,c,l),f.needsUpdate=!0;const w=f.distanceToTriangle(d,m,p);if(w<v&&(A.copy(m),y&&y.copy(p),v=w,E=T,x=S),w<s)return!0}}}}}),ss.releasePrimitive(f),ss.releasePrimitive(d),v===1/0?null:(i.point?i.point.copy(A):i.point=A.clone(),i.distance=v,i.faceIndex=E,n&&(n.point?n.point.copy(y):n.point=y.clone(),n.point.applyMatrix4(ku),A.applyMatrix4(ku),n.distance=A.sub(n.point).length(),n.faceIndex=x),i)}function xP(r,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=r.geometry,i=t.index?t.index.array:null,n=t.attributes.position;let s,o,a,l,c=0;const u=r._roots;for(let f=0,d=u.length;f<d;f++)s=u[f],o=new Uint32Array(s),a=new Uint16Array(s),l=new Float32Array(s),h(0,c),c+=s.byteLength;function h(f,d,m=!1){const A=f*2;if(a[A+15]===Cf){const y=o[f+6],v=a[A+14];let E=1/0,x=1/0,I=1/0,C=-1/0,_=-1/0,S=-1/0;for(let b=y,T=y+v;b<T;b++){const R=3*r.resolveTriangleIndex(b);for(let w=0;w<3;w++){let B=R+w;B=i?i[B]:B;const M=n.getX(B),O=n.getY(B),U=n.getZ(B);M<E&&(E=M),M>C&&(C=M),O<x&&(x=O),O>_&&(_=O),U<I&&(I=U),U>S&&(S=U)}}return l[f+0]!==E||l[f+1]!==x||l[f+2]!==I||l[f+3]!==C||l[f+4]!==_||l[f+5]!==S?(l[f+0]=E,l[f+1]=x,l[f+2]=I,l[f+3]=C,l[f+4]=_,l[f+5]=S,!0):!1}else{const y=f+8,v=o[f+6],E=y+d,x=v+d;let I=m,C=!1,_=!1;e?I||(C=e.has(E),_=e.has(x),I=!C&&!_):(C=!0,_=!0);const S=I||C,b=I||_;let T=!1;S&&(T=h(y,d,I));let R=!1;b&&(R=h(v,d,I));const w=T||R;if(w)for(let B=0;B<3;B++){const M=y+B,O=v+B,U=l[M],Y=l[M+3],W=l[O],N=l[O+3];l[f+B]=U<W?U:W,l[f+B+3]=Y>N?Y:N}return w}}}function IP(r,e,t,i,n,s,o){oi.setBuffer(r._roots[e]),qm(0,r,t,i,n,s,o),oi.clearBuffer()}function qm(r,e,t,i,n,s,o){const{float32Array:a,uint16Array:l,uint32Array:c}=oi,u=r*2;if(cn(u,l)){const f=_n(r,c),d=Nn(u,l);cP(e,t,i,f,d,n,s,o)}else{const f=ns(r);$r(f,a,i,s,o)&&qm(f,e,t,i,n,s,o);const d=Gn(r,c);$r(d,a,i,s,o)&&qm(d,e,t,i,n,s,o)}}const CP=["x","y","z"];function _P(r,e,t,i,n,s){oi.setBuffer(r._roots[e]);const o=Xm(0,r,t,i,n,s);return oi.clearBuffer(),o}function Xm(r,e,t,i,n,s){const{float32Array:o,uint16Array:a,uint32Array:l}=oi;let c=r*2;if(cn(c,a)){const h=_n(r,l),f=Nn(c,a);return uP(e,t,i,h,f,n,s)}else{const h=hp(r,l),f=CP[h],m=i.direction[f]>=0;let A,p;m?(A=ns(r),p=Gn(r,l)):(A=Gn(r,l),p=ns(r));const v=$r(A,o,i,n,s)?Xm(A,e,t,i,n,s):null;if(v){const I=v.point[f];if(m?I<=o[p+h]:I>=o[p+h+3])return v}const x=$r(p,o,i,n,s)?Xm(p,e,t,i,n,s):null;return v&&x?v.distance<=x.distance?v:x:v||x||null}}const Ou=new Jt,Xo=new bs,Jo=new bs,Bl=new we,K2=new fn,Uu=new fn;function SP(r,e,t,i){oi.setBuffer(r._roots[e]);const n=Jm(0,r,t,i);return oi.clearBuffer(),n}function Jm(r,e,t,i,n=null){const{float32Array:s,uint16Array:o,uint32Array:a}=oi;let l=r*2;if(n===null&&(t.boundingBox||t.computeBoundingBox(),K2.set(t.boundingBox.min,t.boundingBox.max,i),n=K2),cn(l,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,m=t.attributes.position,A=_n(r,a),p=Nn(l,o);if(Bl.copy(i).invert(),t.boundsTree)return Ei(r,s,Uu),Uu.matrix.copy(Bl),Uu.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>Uu.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(i),v.b.applyMatrix4(i),v.c.applyMatrix4(i),v.needsUpdate=!0;for(let E=A,x=p+A;E<x;E++)if(Mi(Jo,3*e.resolveTriangleIndex(E),h,f),Jo.needsUpdate=!0,v.intersectsTriangle(Jo))return!0;return!1}});for(let y=A,v=p+A;y<v;y++){const E=e.resolveTriangleIndex(y);Mi(Xo,3*E,h,f),Xo.a.applyMatrix4(Bl),Xo.b.applyMatrix4(Bl),Xo.c.applyMatrix4(Bl),Xo.needsUpdate=!0;for(let x=0,I=d.count;x<I;x+=3)if(Mi(Jo,x,d,m),Jo.needsUpdate=!0,Xo.intersectsTriangle(Jo))return!0}}else{const u=r+8,h=a[r+6];return Ei(u,s,Ou),!!(n.intersectsBox(Ou)&&Jm(u,e,t,i,n)||(Ei(h,s,Ou),n.intersectsBox(Ou)&&Jm(h,e,t,i,n)))}}const Nu=new we,p0=new fn,Rl=new fn,TP=new Q,bP=new Q,wP=new Q,BP=new Q;function RP(r,e,t,i={},n={},s=0,o=1/0){e.boundingBox||e.computeBoundingBox(),p0.set(e.boundingBox.min,e.boundingBox.max,t),p0.needsUpdate=!0;const a=r.geometry,l=a.attributes.position,c=a.index,u=e.attributes.position,h=e.index,f=ss.getPrimitive(),d=ss.getPrimitive();let m=TP,A=bP,p=null,y=null;n&&(p=wP,y=BP);let v=1/0,E=null,x=null;return Nu.copy(t).invert(),Rl.matrix.copy(Nu),r.shapecast({boundsTraverseOrder:I=>p0.distanceToBox(I),intersectsBounds:(I,C,_)=>_<v&&_<o?(C&&(Rl.min.copy(I.min),Rl.max.copy(I.max),Rl.needsUpdate=!0),!0):!1,intersectsRange:(I,C)=>{if(e.boundsTree){const _=e.boundsTree;return _.shapecast({boundsTraverseOrder:S=>Rl.distanceToBox(S),intersectsBounds:(S,b,T)=>T<v&&T<o,intersectsRange:(S,b)=>{for(let T=S,R=S+b;T<R;T++){const w=_.resolveTriangleIndex(T);Mi(d,3*w,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let B=I,M=I+C;B<M;B++){const O=r.resolveTriangleIndex(B);Mi(f,3*O,c,l),f.needsUpdate=!0;const U=f.distanceToTriangle(d,m,p);if(U<v&&(A.copy(m),y&&y.copy(p),v=U,E=B,x=T),U<s)return!0}}}})}else{const _=Qa(e);for(let S=0,b=_;S<b;S++){Mi(d,3*S,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=I,R=I+C;T<R;T++){const w=r.resolveTriangleIndex(T);Mi(f,3*w,c,l),f.needsUpdate=!0;const B=f.distanceToTriangle(d,m,p);if(B<v&&(A.copy(m),y&&y.copy(p),v=B,E=T,x=S),B<s)return!0}}}}}),ss.releasePrimitive(f),ss.releasePrimitive(d),v===1/0?null:(i.point?i.point.copy(A):i.point=A.clone(),i.distance=v,i.faceIndex=E,n&&(n.point?n.point.copy(y):n.point=y.clone(),n.point.applyMatrix4(Nu),A.applyMatrix4(Nu),n.distance=A.sub(n.point).length(),n.faceIndex=x),i)}function DP(){return typeof SharedArrayBuffer<"u"}const sc=new oi.constructor,Vh=new oi.constructor,Fr=new dp(()=>new Jt),Zo=new Jt,ea=new Jt,g0=new Jt,y0=new Jt;let v0=!1;function MP(r,e,t,i){if(v0)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");v0=!0;const n=r._roots,s=e._roots;let o,a=0,l=0;const c=new we().copy(t).invert();for(let u=0,h=n.length;u<h;u++){sc.setBuffer(n[u]),l=0;const f=Fr.getPrimitive();Ei(0,sc.float32Array,f),f.applyMatrix4(c);for(let d=0,m=s.length;d<m&&(Vh.setBuffer(s[d]),o=vs(0,0,t,c,i,a,l,0,0,f),Vh.clearBuffer(),l+=s[d].length,!o);d++);if(Fr.releasePrimitive(f),sc.clearBuffer(),a+=n[u].length,o)break}return v0=!1,o}function vs(r,e,t,i,n,s=0,o=0,a=0,l=0,c=null,u=!1){let h,f;u?(h=Vh,f=sc):(h=sc,f=Vh);const d=h.float32Array,m=h.uint32Array,A=h.uint16Array,p=f.float32Array,y=f.uint32Array,v=f.uint16Array,E=r*2,x=e*2,I=cn(E,A),C=cn(x,v);let _=!1;if(C&&I)u?_=n(_n(e,y),Nn(e*2,v),_n(r,m),Nn(r*2,A),l,o+e,a,s+r):_=n(_n(r,m),Nn(r*2,A),_n(e,y),Nn(e*2,v),a,s+r,l,o+e);else if(C){const S=Fr.getPrimitive();Ei(e,p,S),S.applyMatrix4(t);const b=ns(r),T=Gn(r,m);Ei(b,d,Zo),Ei(T,d,ea);const R=S.intersectsBox(Zo),w=S.intersectsBox(ea);_=R&&vs(e,b,i,t,n,o,s,l,a+1,S,!u)||w&&vs(e,T,i,t,n,o,s,l,a+1,S,!u),Fr.releasePrimitive(S)}else{const S=ns(e),b=Gn(e,y);Ei(S,p,g0),Ei(b,p,y0);const T=c.intersectsBox(g0),R=c.intersectsBox(y0);if(T&&R)_=vs(r,S,t,i,n,s,o,a,l+1,c,u)||vs(r,b,t,i,n,s,o,a,l+1,c,u);else if(T)if(I)_=vs(r,S,t,i,n,s,o,a,l+1,c,u);else{const w=Fr.getPrimitive();w.copy(g0).applyMatrix4(t);const B=ns(r),M=Gn(r,m);Ei(B,d,Zo),Ei(M,d,ea);const O=w.intersectsBox(Zo),U=w.intersectsBox(ea);_=O&&vs(S,B,i,t,n,o,s,l,a+1,w,!u)||U&&vs(S,M,i,t,n,o,s,l,a+1,w,!u),Fr.releasePrimitive(w)}else if(R)if(I)_=vs(r,b,t,i,n,s,o,a,l+1,c,u);else{const w=Fr.getPrimitive();w.copy(y0).applyMatrix4(t);const B=ns(r),M=Gn(r,m);Ei(B,d,Zo),Ei(M,d,ea);const O=w.intersectsBox(Zo),U=w.intersectsBox(ea);_=O&&vs(b,B,i,t,n,o,s,l,a+1,w,!u)||U&&vs(b,M,i,t,n,o,s,l,a+1,w,!u),Fr.releasePrimitive(w)}}return _}const Gu=new fn,$2=new Jt,LP={strategy:LC,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class Sf{static serialize(e,t={}){t={cloneBuffers:!0,...t};const i=e.geometry,n=e._roots,s=e._indirectBuffer,o=i.getIndex();let a;return t.cloneBuffers?a={roots:n.map(l=>l.slice()),index:o?o.array.slice():null,indirectBuffer:s?s.slice():null}:a={roots:n,index:o?o.array:null,indirectBuffer:s},a}static deserialize(e,t,i={}){i={setIndex:!0,indirect:!!e.indirectBuffer,...i};const{index:n,roots:s,indirectBuffer:o}=e,a=new Sf(t,{...i,[u0]:!0});if(a._roots=s,a._indirectBuffer=o||null,i.setIndex){const l=t.getIndex();if(l===null){const c=new Vt(e.index,1,!1);t.setIndex(c)}else l.array!==n&&(l.array.set(n),l.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({...LP,[u0]:!1},t),t.useSharedArrayBuffer&&!DP())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[u0]||(jL(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new Jt))),this.resolveTriangleIndex=t.indirect?i=>this._indirectBuffer[i]:i=>i}refit(e=null){return(this.indirect?xP:lP)(this,e)}traverse(e,t=0){const i=this._roots[t],n=new Uint32Array(i),s=new Uint16Array(i);o(0);function o(a,l=0){const c=a*2,u=s[c+15]===Cf;if(u){const h=n[a+6],f=s[c+14];e(l,u,new Float32Array(i,a*4,6),h,f)}else{const h=a+zr/4,f=n[a+6],d=n[a+7];e(l,u,new Float32Array(i,a*4,6),d)||(o(h,l+1),o(f,l+1))}}}raycast(e,t=lc,i=0,n=1/0){const s=this._roots,o=this.geometry,a=[],l=t.isMaterial,c=Array.isArray(t),u=o.groups,h=l?t.side:t,f=this.indirect?IP:fP;for(let d=0,m=s.length;d<m;d++){const A=c?t[u[d].materialIndex].side:h,p=a.length;if(f(this,d,A,e,a,i,n),c){const y=u[d].materialIndex;for(let v=p,E=a.length;v<E;v++)a[v].face.materialIndex=y}}return a}raycastFirst(e,t=lc,i=0,n=1/0){const s=this._roots,o=this.geometry,a=t.isMaterial,l=Array.isArray(t);let c=null;const u=o.groups,h=a?t.side:t,f=this.indirect?_P:mP;for(let d=0,m=s.length;d<m;d++){const A=l?t[u[d].materialIndex].side:h,p=f(this,d,A,e,i,n);p!=null&&(c==null||p.distance<c.distance)&&(c=p,l&&(p.face.materialIndex=u[d].materialIndex))}return c}intersectsGeometry(e,t){let i=!1;const n=this._roots,s=this.indirect?SP:AP;for(let o=0,a=n.length;o<a&&(i=s(this,o,e,t),!i);o++);return i}shapecast(e){const t=ss.getPrimitive(),i=this.indirect?hP:aP;let{boundsTraverseOrder:n,intersectsBounds:s,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const h=o;o=(f,d,m,A,p)=>h(f,d,m,A,p)?!0:i(f,d,this,a,m,A,t)}else o||(a?o=(h,f,d,m)=>i(h,f,this,a,d,m,t):o=(h,f,d)=>d);let l=!1,c=0;const u=this._roots;for(let h=0,f=u.length;h<f;h++){const d=u[h];if(l=tP(this,h,s,o,n,c),l)break;c+=d.byteLength}return ss.releasePrimitive(t),l}bvhcast(e,t,i){let{intersectsRanges:n,intersectsTriangles:s}=i;const o=ss.getPrimitive(),a=this.geometry.index,l=this.geometry.attributes.position,c=this.indirect?m=>{const A=this.resolveTriangleIndex(m);Mi(o,A*3,a,l)}:m=>{Mi(o,m*3,a,l)},u=ss.getPrimitive(),h=e.geometry.index,f=e.geometry.attributes.position,d=e.indirect?m=>{const A=e.resolveTriangleIndex(m);Mi(u,A*3,h,f)}:m=>{Mi(u,m*3,h,f)};if(s){const m=(A,p,y,v,E,x,I,C)=>{for(let _=y,S=y+v;_<S;_++){d(_),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let b=A,T=A+p;b<T;b++)if(c(b),o.needsUpdate=!0,s(o,u,b,_,E,x,I,C))return!0}return!1};if(n){const A=n;n=function(p,y,v,E,x,I,C,_){return A(p,y,v,E,x,I,C,_)?!0:m(p,y,v,E,x,I,C,_)}}else n=m}return MP(this,e,t,n)}intersectsBox(e,t){return Gu.set(e.min,e.max,t),Gu.needsUpdate=!0,this.shapecast({intersectsBounds:i=>Gu.intersectsBox(i),intersectsTriangle:i=>Gu.intersectsTriangle(i)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,i={},n={},s=0,o=1/0){return(this.indirect?RP:EP)(this,e,t,i,n,s,o)}closestPointToPoint(e,t={},i=0,n=1/0){return iP(this,e,t,i,n)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(i=>{Ei(0,new Float32Array(i),$2),e.union($2)}),e}}function Y2(r,e,t){return r===null?null:(r.point.applyMatrix4(e.matrixWorld),r.distance=r.point.distanceTo(t.ray.origin),r.object=e,r)}const W2=d_||null,Qu=new Ua,j2=new Q,q2=new we,PP=ze.prototype.raycast,FP=W2!==null?W2.prototype.raycast:null,X2=new Q,Ji=new ze,zu=[];function GC(r,e){this.isBatchedMesh?kP.call(this,r,e):OP.call(this,r,e)}function kP(r,e){if(this.boundsTrees){const t=this.boundsTrees,i=this._drawInfo,n=this._drawRanges,s=this.matrixWorld;Ji.material=this.material,Ji.geometry=this.geometry;const o=Ji.geometry.boundsTree,a=Ji.geometry.drawRange;Ji.geometry.boundingSphere===null&&(Ji.geometry.boundingSphere=new hn);for(let l=0,c=i.length;l<c;l++){if(!this.getVisibleAt(l))continue;const u=i[l].geometryIndex;if(Ji.geometry.boundsTree=t[u],this.getMatrixAt(l,Ji.matrixWorld).premultiply(s),!Ji.geometry.boundsTree){this.getBoundingBoxAt(u,Ji.geometry.boundingBox),this.getBoundingSphereAt(u,Ji.geometry.boundingSphere);const h=n[u];Ji.geometry.setDrawRange(h.start,h.count)}Ji.raycast(r,zu);for(let h=0,f=zu.length;h<f;h++){const d=zu[h];d.object=this,d.batchId=l,e.push(d)}zu.length=0}Ji.geometry.boundsTree=o,Ji.geometry.drawRange=a,Ji.material=null,Ji.geometry=null}else FP.call(this,r,e)}function OP(r,e){if(this.geometry.boundsTree){if(this.material===void 0)return;q2.copy(this.matrixWorld).invert(),Qu.copy(r.ray).applyMatrix4(q2),X2.setFromMatrixScale(this.matrixWorld),j2.copy(Qu.direction).multiply(X2);const t=j2.length(),i=r.near/t,n=r.far/t,s=this.geometry.boundsTree;if(r.firstHitOnly===!0){const o=Y2(s.raycastFirst(Qu,this.material,i,n),this,r);o&&e.push(o)}else{const o=s.raycast(Qu,this.material,i,n);for(let a=0,l=o.length;a<l;a++){const c=Y2(o[a],this,r);c&&e.push(c)}}}else PP.call(this,r,e)}function QC(r={}){return this.boundsTree=new Sf(this,r),this.boundsTree}function zC(){this.boundsTree=null}function UP(r){switch(r){case 1:return"R";case 2:return"RG";case 3:return"RGBA";case 4:return"RGBA"}throw new Error}function NP(r){switch(r){case 1:return Vs;case 2:return fa;case 3:return Di;case 4:return Di}}function J2(r){switch(r){case 1:return m_;case 2:return BE;case 3:return Eh;case 4:return Eh}}class HC extends Vr{constructor(){super(),this.minFilter=ei,this.magFilter=ei,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(e){const t=this.overrideItemSize,i=e.itemSize,n=e.count;if(t!==null){if(i*n%t!==0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");e.itemSize=t,e.count=n*i/t}const s=e.itemSize,o=e.count,a=e.normalized,l=e.array.constructor,c=l.BYTES_PER_ELEMENT;let u=this._forcedType,h=s;if(u===null)switch(l){case Float32Array:u=ri;break;case Uint8Array:case Uint16Array:case Uint32Array:u=ho;break;case Int8Array:case Int16Array:case Int32Array:u=th;break}let f,d,m,A,p=UP(s);switch(u){case ri:m=1,d=NP(s),a&&c===1?(A=l,p+="8",l===Uint8Array?f=$i:(f=$0,p+="_SNORM")):(A=Float32Array,p+="32F",f=ri);break;case th:p+=c*8+"I",m=a?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,d=J2(s),c===1?(A=Int8Array,f=$0):c===2?(A=Int16Array,f=wE):(A=Int32Array,f=th);break;case ho:p+=c*8+"UI",m=a?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,d=J2(s),c===1?(A=Uint8Array,f=$i):c===2?(A=Uint16Array,f=Xh):(A=Uint32Array,f=ho);break}h===3&&(d===Di||d===Eh)&&(h=4);const y=Math.ceil(Math.sqrt(o))||1,v=h*y*y,E=new A(v),x=e.normalized;e.normalized=!1;for(let I=0;I<o;I++){const C=h*I;E[C]=e.getX(I)/m,s>=2&&(E[C+1]=e.getY(I)/m),s>=3&&(E[C+2]=e.getZ(I)/m,h===4&&(E[C+3]=1)),s>=4&&(E[C+3]=e.getW(I)/m)}e.normalized=x,this.internalFormat=p,this.format=d,this.type=f,this.image.width=y,this.image.height=y,this.image.data=E,this.needsUpdate=!0,this.dispose(),e.itemSize=i,e.count=n}}class GP extends HC{constructor(){super(),this._forcedType=ho}}class QP extends HC{constructor(){super(),this._forcedType=ri}}class VC{constructor(){this.index=new GP,this.position=new QP,this.bvhBounds=new Vr,this.bvhContents=new Vr,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(e){const{geometry:t}=e;if(HP(e,this.bvhBounds,this.bvhContents),this.position.updateFrom(t.attributes.position),e.indirect){const i=e._indirectBuffer;if(this._cachedIndexAttr===null||this._cachedIndexAttr.count!==i.length)if(t.index)this._cachedIndexAttr=t.index.clone();else{const n=FC(PC(t));this._cachedIndexAttr=new Vt(n,1,!1)}zP(t,i,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(t.index)}dispose(){const{index:e,position:t,bvhBounds:i,bvhContents:n}=this;e&&e.dispose(),t&&t.dispose(),i&&i.dispose(),n&&n.dispose()}}function zP(r,e,t){const i=t.array,n=r.index?r.index.array:null;for(let s=0,o=e.length;s<o;s++){const a=3*s,l=3*e[s];for(let c=0;c<3;c++)i[a+c]=n?n[l+c]:l+c}}function HP(r,e,t){const i=r._roots;if(i.length!==1)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const n=i[0],s=new Uint16Array(n),o=new Uint32Array(n),a=new Float32Array(n),l=n.byteLength/zr,c=2*Math.ceil(Math.sqrt(l/2)),u=new Float32Array(4*c*c),h=Math.ceil(Math.sqrt(l)),f=new Uint32Array(2*h*h);for(let d=0;d<l;d++){const m=d*zr/4,A=m*2,p=m;for(let y=0;y<3;y++)u[8*d+0+y]=a[p+0+y],u[8*d+4+y]=a[p+3+y];if(cn(A,s)){const y=Nn(A,s),v=_n(m,o),E=4294901760|y;f[d*2+0]=E,f[d*2+1]=v}else{const y=4*Gn(m,o)/zr,v=hp(m,o);f[d*2+0]=v,f[d*2+1]=y}}e.image.data=u,e.image.width=c,e.image.height=c,e.format=Di,e.type=ri,e.internalFormat="RGBA32F",e.minFilter=ei,e.magFilter=ei,e.generateMipmaps=!1,e.needsUpdate=!0,e.dispose(),t.image.data=f,t.image.width=h,t.image.height=h,t.format=BE,t.type=ho,t.internalFormat="RG32UI",t.minFilter=ei,t.magFilter=ei,t.generateMipmaps=!1,t.needsUpdate=!0,t.dispose()}const VP=`

// A stack of uint32 indices can can store the indices for
// a perfectly balanced tree with a depth up to 31. Lower stack
// depth gets higher performance.
//
// However not all trees are balanced. Best value to set this to
// is the trees max depth.
#ifndef BVH_STACK_DEPTH
#define BVH_STACK_DEPTH 60
#endif

#ifndef INFINITY
#define INFINITY 1e20
#endif

// Utilities
uvec4 uTexelFetch1D( usampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

ivec4 iTexelFetch1D( isampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 texelFetch1D( sampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {

	return
		barycoord.x * texelFetch1D( tex, faceIndices.x ) +
		barycoord.y * texelFetch1D( tex, faceIndices.y ) +
		barycoord.z * texelFetch1D( tex, faceIndices.z );

}

void ndcToCameraRay(
	vec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,
	out vec3 rayOrigin, out vec3 rayDirection
) {

	// get camera look direction and near plane for camera clipping
	vec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );
	vec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );
	float near = abs( nearVector.z / nearVector.w );

	// get the camera direction and position from camera matrices
	vec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );
	direction /= direction.w;
	direction = cameraWorld * direction - origin;

	// slide the origin along the ray until it sits at the near clip plane position
	origin.xyz += direction.xyz * near / dot( direction, lookDirection );

	rayOrigin = origin.xyz;
	rayDirection = direction.xyz;

}
`,KP=`

#ifndef TRI_INTERSECT_EPSILON
#define TRI_INTERSECT_EPSILON 1e-5
#endif

// Raycasting
bool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {

	// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/
	// https://tavianator.com/2011/ray_box.html
	vec3 invDir = 1.0 / rayDirection;

	// find intersection distances for each plane
	vec3 tMinPlane = invDir * ( boundsMin - rayOrigin );
	vec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );

	// get the min and max distances from each intersection
	vec3 tMinHit = min( tMaxPlane, tMinPlane );
	vec3 tMaxHit = max( tMaxPlane, tMinPlane );

	// get the furthest hit distance
	vec2 t = max( tMinHit.xx, tMinHit.yz );
	float t0 = max( t.x, t.y );

	// get the minimum hit distance
	t = min( tMaxHit.xx, tMaxHit.yz );
	float t1 = min( t.x, t.y );

	// set distance to 0.0 if the ray starts inside the box
	dist = max( t0, 0.0 );

	return t1 >= dist;

}

bool intersectsTriangle(
	vec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,
	out vec3 barycoord, out vec3 norm, out float dist, out float side
) {

	// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d
	vec3 edge1 = b - a;
	vec3 edge2 = c - a;
	norm = cross( edge1, edge2 );

	float det = - dot( rayDirection, norm );
	float invdet = 1.0 / det;

	vec3 AO = rayOrigin - a;
	vec3 DAO = cross( AO, rayDirection );

	vec4 uvt;
	uvt.x = dot( edge2, DAO ) * invdet;
	uvt.y = - dot( edge1, DAO ) * invdet;
	uvt.z = dot( AO, norm ) * invdet;
	uvt.w = 1.0 - uvt.x - uvt.y;

	// set the hit information
	barycoord = uvt.wxy; // arranged in A, B, C order
	dist = uvt.z;
	side = sign( det );
	norm = side * normalize( norm );

	// add an epsilon to avoid misses between triangles
	uvt += vec4( TRI_INTERSECT_EPSILON );

	return all( greaterThanEqual( uvt, vec4( 0.0 ) ) );

}

bool intersectTriangles(
	// geometry info and triangle range
	sampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// outputs
	inout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	bool found = false;
	vec3 localBarycoord, localNormal;
	float localDist, localSide;
	for ( uint i = offset, l = offset + count; i < l; i ++ ) {

		uvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;
		vec3 a = texelFetch1D( positionAttr, indices.x ).rgb;
		vec3 b = texelFetch1D( positionAttr, indices.y ).rgb;
		vec3 c = texelFetch1D( positionAttr, indices.z ).rgb;

		if (
			intersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )
			&& localDist < minDistance
		) {

			found = true;
			minDistance = localDist;

			faceIndices = uvec4( indices.xyz, i );
			faceNormal = localNormal;

			side = localSide;
			barycoord = localBarycoord;
			dist = localDist;

		}

	}

	return found;

}

bool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {

	uint cni2 = currNodeIndex * 2u;
	vec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;
	vec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;
	return intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );

}

// use a macro to hide the fact that we need to expand the struct into separate fields
#define	bvhIntersectFirstHit(		bvh,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)	_bvhIntersectFirstHit(		bvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)

bool _bvhIntersectFirstHit(
	// bvh info
	sampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// output variables split into separate variables due to output precision
	inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	// stack needs to be twice as long as the deepest tree we expect because
	// we push both the left and right child onto the stack every traversal
	int ptr = 0;
	uint stack[ BVH_STACK_DEPTH ];
	stack[ 0 ] = 0u;

	float triangleDistance = INFINITY;
	bool found = false;
	while ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {

		uint currNodeIndex = stack[ ptr ];
		ptr --;

		// check if we intersect the current bounds
		float boundsHitDistance;
		if (
			! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )
			|| boundsHitDistance > triangleDistance
		) {

			continue;

		}

		uvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;
		bool isLeaf = bool( boundsInfo.x & 0xffff0000u );

		if ( isLeaf ) {

			uint count = boundsInfo.x & 0x0000ffffu;
			uint offset = boundsInfo.y;

			found = intersectTriangles(
				bvh_position, bvh_index, offset, count,
				rayOrigin, rayDirection, triangleDistance,
				faceIndices, faceNormal, barycoord, side, dist
			) || found;

		} else {

			uint leftIndex = currNodeIndex + 1u;
			uint splitAxis = boundsInfo.x & 0x0000ffffu;
			uint rightIndex = boundsInfo.y;

			bool leftToRight = rayDirection[ splitAxis ] >= 0.0;
			uint c1 = leftToRight ? leftIndex : rightIndex;
			uint c2 = leftToRight ? rightIndex : leftIndex;

			// set c2 in the stack so we traverse it later. We need to keep track of a pointer in
			// the stack while we traverse. The second pointer added is the one that will be
			// traversed first
			ptr ++;
			stack[ ptr ] = c2;

			ptr ++;
			stack[ ptr ] = c1;

		}

	}

	return found;

}
`,$P=`
struct BVH {

	usampler2D index;
	sampler2D position;

	sampler2D bvhBounds;
	usampler2D bvhContents;

};
`,YP=$P,WP=`
	${VP}
	${KP}
`,Z2=r=>r.isMesh;function jU(r,e){e={strategy:If,verbose:!1,setBoundingBox:!0,maxDepth:40,maxLeafTris:10,indirect:!1,...e},g.useEffect(()=>{if(r.current){r.current.raycast=GC;const t=r.current.geometry;return t.computeBoundsTree=QC,t.disposeBoundsTree=zC,t.computeBoundsTree(e),()=>{t.boundsTree&&t.disposeBoundsTree()}}},[r,JSON.stringify(e)])}const qU=g.forwardRef(({enabled:r=!0,firstHitOnly:e=!1,children:t,strategy:i=If,verbose:n=!1,setBoundingBox:s=!0,maxDepth:o=40,maxLeafTris:a=10,indirect:l=!1,...c},u)=>{const h=g.useRef(null),f=ae(d=>d.raycaster);return g.useImperativeHandle(u,()=>h.current,[]),g.useEffect(()=>{if(r){const d={strategy:i,verbose:n,setBoundingBox:s,maxDepth:o,maxLeafTris:a,indirect:l},m=h.current;return f.firstHitOnly=e,m.traverse(A=>{Z2(A)&&!A.geometry.boundsTree&&A.raycast===ze.prototype.raycast&&(A.raycast=GC,A.geometry.computeBoundsTree=QC,A.geometry.disposeBoundsTree=zC,A.geometry.computeBoundsTree(d))}),()=>{delete f.firstHitOnly,m.traverse(A=>{Z2(A)&&A.geometry.boundsTree&&(A.geometry.disposeBoundsTree(),A.raycast=ze.prototype.raycast)})}}},[]),g.createElement("group",Ae({ref:h},c),t)});function XU(...r){const e=g.useRef([]);return e.current=r.map(t=>g.useContext(t)),g.useMemo(()=>({children:t})=>r.reduceRight((i,n,s)=>g.createElement(n.Provider,{value:e.current[s],children:i}),t),[])}function JU(r,e){const t=g.useRef(),[i]=g.useState(()=>e?e instanceof gi?{current:e}:e:t),[n]=g.useState(()=>new aE(void 0));g.useLayoutEffect(()=>{e&&(i.current=e instanceof gi?e:e.current),n._root=i.current});const s=g.useRef({}),o=g.useMemo(()=>{const a={};return r.forEach(l=>Object.defineProperty(a,l.name,{enumerable:!0,get(){if(i.current)return s.current[l.name]||(s.current[l.name]=n.clipAction(l,i.current))},configurable:!0})),{ref:i,clips:r,actions:a,names:r.map(l=>l.name),mixer:n}},[r]);return Ve((a,l)=>n.update(l)),g.useEffect(()=>{const a=i.current;return()=>{s.current={},n.stopAllAction(),Object.values(o.actions).forEach(l=>{a&&n.uncacheAction(l,a)})}},[r]),o}function jP(r){const e=g.useRef(null),t=g.useRef(!1),i=g.useRef(!1),n=g.useRef(r);return g.useLayoutEffect(()=>void(n.current=r),[r]),g.useEffect(()=>{const s=e.current;if(s){const o=aA(()=>(t.current=!1,!0)),a=s.onBeforeRender;s.onBeforeRender=()=>t.current=!0;const l=lA(()=>(t.current!==i.current&&(n.current==null||n.current(i.current=t.current)),!0));return()=>{s.onBeforeRender=a,o(),l()}}},[]),e}const qP=`
#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )
  vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );
  #ifdef BOX_PROJECTED_ENV_MAP
    vWorldPosition = worldPosition.xyz;
  #endif
#endif
`,XP=`
#ifdef BOX_PROJECTED_ENV_MAP
  uniform vec3 envMapSize;
  uniform vec3 envMapPosition;
  varying vec3 vWorldPosition;
    
  vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {
    vec3 nDir = normalize( v );
    vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbminmax;
    rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;
    rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;
    rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;
    float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );
    vec3 boxIntersection = vWorldPosition + nDir * correction;    
    return boxIntersection - cubePos;
  }
#endif
`,JP=`
#ifdef BOX_PROJECTED_ENV_MAP
  worldNormal = parallaxCorrectNormal( worldNormal, envMapSize, envMapPosition );
#endif
`,ZP=`
#ifdef BOX_PROJECTED_ENV_MAP
  reflectVec = parallaxCorrectNormal( reflectVec, envMapSize, envMapPosition );
#endif
`;function eF(r,e,t){r.defines.BOX_PROJECTED_ENV_MAP=!0,r.uniforms.envMapPosition={value:e},r.uniforms.envMapSize={value:t},r.vertexShader=`
  varying vec3 vWorldPosition;
  ${r.vertexShader.replace("#include <worldpos_vertex>",qP)}`,r.fragmentShader=`
    ${XP}
    ${r.fragmentShader.replace("#include <envmap_physical_pars_fragment>",ma.envmap_physical_pars_fragment).replace("vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );",`vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
         ${JP}
         `).replace("reflectVec = inverseTransformDirection( reflectVec, viewMatrix );",`reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
         ${ZP}
        `)}`}function ZU(r=new Q,e=new Q){const[t]=g.useState(()=>({position:new Q,size:new Q}));Un(t,{position:r,size:e});const i=g.useRef(null),n=g.useMemo(()=>({ref:i,onBeforeCompile:s=>eF(s,t.position,t.size),customProgramCacheKey:()=>JSON.stringify(t.position.toArray())+JSON.stringify(t.size.toArray())}),[...t.position.toArray(),...t.size.toArray()]);return g.useLayoutEffect(()=>void(i.current.needsUpdate=!0),[t]),n}const ev=new Jt,Hu=new Q,eN=({anchor:r,...e})=>{const t=g.useRef(null),i=g.useRef(null);return g.useEffect(()=>{var n;(n=t.current)!=null&&(n=n.parent)!=null&&n.parent&&(i.current=t.current.parent,t.current.parent.parent.add(t.current))},[]),Ve(()=>{i.current&&(ev.setFromObject(i.current),ev.getSize(Hu),t.current.position.set(i.current.position.x+Hu.x*(Array.isArray(r)?r[0]:r.x)/2,i.current.position.y+Hu.y*(Array.isArray(r)?r[1]:r.y)/2,i.current.position.z+Hu.z*(Array.isArray(r)?r[2]:r.z)/2))}),g.createElement("group",Ae({ref:t},e))};function tF(r,e,t=.9){return e*t+r*(1-t)}const iF=r=>Math.sqrt(1-Math.pow(r-1,2));class nF{constructor({size:e=256,maxAge:t=750,radius:i=.3,intensity:n=.2,interpolate:s=0,smoothing:o=0,minForce:a=.3,blend:l="screen",ease:c=iF}={}){this.size=e,this.maxAge=t,this.radius=i,this.intensity=n,this.ease=c,this.interpolate=s,this.smoothing=o,this.minForce=a,this.blend=l,this.trail=[],this.force=0,this.initTexture()}initTexture(){this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=this.size;const e=this.canvas.getContext("2d");if(e===null)throw new Error("2D not available");this.ctx=e,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.texture=new tn(this.canvas),this.canvas.id="touchTexture",this.canvas.style.width=this.canvas.style.height=`${this.canvas.width}px`}update(e){this.clear(),this.trail.forEach((t,i)=>{t.age+=e*1e3,t.age>this.maxAge&&this.trail.splice(i,1)}),this.trail.length||(this.force=0),this.trail.forEach(t=>{this.drawTouch(t)}),this.texture.needsUpdate=!0}clear(){this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}addTouch(e){const t=this.trail[this.trail.length-1];if(t){const i=t.x-e.x,n=t.y-e.y,s=i*i+n*n,o=Math.max(this.minForce,Math.min(s*1e4,1));if(this.force=tF(o,this.force,this.smoothing),this.interpolate){const a=Math.ceil(s/Math.pow(this.radius*.5/this.interpolate,2));if(a>1)for(let l=1;l<a;l++)this.trail.push({x:t.x-i/a*l,y:t.y-n/a*l,age:0,force:o})}}this.trail.push({x:e.x,y:e.y,age:0,force:this.force})}drawTouch(e){const t={x:e.x*this.size,y:(1-e.y)*this.size};let i=1;e.age<this.maxAge*.3?i=this.ease(e.age/(this.maxAge*.3)):i=this.ease(1-(e.age-this.maxAge*.3)/(this.maxAge*.7)),i*=e.force,this.ctx.globalCompositeOperation=this.blend;const n=this.size*this.radius*i,s=this.ctx.createRadialGradient(t.x,t.y,Math.max(0,n*.25),t.x,t.y,Math.max(0,n));s.addColorStop(0,`rgba(255, 255, 255, ${this.intensity})`),s.addColorStop(1,"rgba(0, 0, 0, 0.0)"),this.ctx.beginPath(),this.ctx.fillStyle=s,this.ctx.arc(t.x,t.y,Math.max(0,n),0,Math.PI*2),this.ctx.fill()}}function sF(r={}){const{size:e,maxAge:t,radius:i,intensity:n,interpolate:s,smoothing:o,minForce:a,blend:l,ease:c}=r,u=g.useMemo(()=>new nF(r),[e,t,i,n,s,o,a,l,c]);Ve((f,d)=>void u.update(d));const h=g.useCallback(f=>u.addTouch(f.uv),[u]);return[u.texture,h]}const tN=({children:r,...e})=>{const t=sF(e);return g.createElement(g.Fragment,null,r?.(t))},KC=g.forwardRef(function({children:e,disable:t,disableX:i,disableY:n,disableZ:s,left:o,right:a,top:l,bottom:c,front:u,back:h,onCentered:f,precise:d=!0,cacheKey:m=0,...A},p){const y=g.useRef(null),v=g.useRef(null),E=g.useRef(null);return g.useLayoutEffect(()=>{v.current.matrixWorld.identity();const x=new Jt().setFromObject(E.current,d),I=new Q,C=new hn,_=x.max.x-x.min.x,S=x.max.y-x.min.y,b=x.max.z-x.min.z;x.getCenter(I),x.getBoundingSphere(C);const T=l?S/2:c?-S/2:0,R=o?-_/2:a?_/2:0,w=u?b/2:h?-b/2:0;v.current.position.set(t||i?0:-I.x+R,t||n?0:-I.y+T,t||s?0:-I.z+w),typeof f<"u"&&f({parent:y.current.parent,container:y.current,width:_,height:S,depth:b,boundingBox:x,boundingSphere:C,center:I,verticalAlignment:T,horizontalAlignment:R,depthAlignment:w})},[m,f,l,o,u,t,i,n,s,d,a,c,h]),g.useImperativeHandle(p,()=>y.current,[]),g.createElement("group",Ae({ref:y},A),g.createElement("group",{ref:v},g.createElement("group",{ref:E},e)))}),iN=g.forwardRef(({font:r,color:e="#cbcbcb",bevelSize:t=.04,debug:i=!1,children:n,...s},o)=>{const[a,l]=g.useState(0),c=g.useCallback((f=1)=>l(a+f),[a]),u=g.useCallback((f=1)=>l(a-f),[a]),h=g.useMemo(()=>({incr:c,decr:u}),[c,u]);return g.useImperativeHandle(o,()=>h,[h]),g.createElement("group",s,g.createElement(g.Suspense,{fallback:null},g.createElement(KC,{top:!0,cacheKey:JSON.stringify({counter:a,font:r})},g.createElement(OB,{bevelEnabled:!0,bevelSize:t,font:r},i?g.createElement("meshNormalMaterial",{wireframe:!0}):g.createElement("meshStandardMaterial",{color:e}),a))),n)});function $C(r){return YC(r.children,r.components)}$C.propTypes={children:ja.func.isRequired,components:ja.arrayOf(ja.oneOfType([ja.element,ja.func])).isRequired};function YC(r,e,t){if(t=t||[],!e[0])return r(t);function i(n){return YC(r,e.slice(1),t.concat([n]))}return typeof e[0]=="function"?e[0]({results:t,render:i}):g.cloneElement(e[0],{children:i})}const rc=(r,e)=>{"updateRanges"in r?r.updateRanges[0]=e:r.updateRange=e},rF=3e3,oF=3001;function aF(r){return typeof r=="function"}const tv=new we,iv=new we,Vu=[],Dl=new ze;class lF extends mr{constructor(){super(),this.color=new We("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){const i=this.instance.current;if(!i||!i.geometry||!i.material)return;Dl.geometry=i.geometry;const n=i.matrixWorld,s=i.userData.instances.indexOf(this.instanceKey);if(!(s===-1||s>i.count)){i.getMatrixAt(s,tv),iv.multiplyMatrices(n,tv),Dl.matrixWorld=iv,i.material instanceof eh?Dl.material.side=i.material.side:Dl.material.side=i.material[0].side,Dl.raycast(e,Vu);for(let o=0,a=Vu.length;o<a;o++){const l=Vu[o];l.instanceId=s,l.object=this,t.push(l)}Vu.length=0}}}const WC=g.createContext(null),nv=new we,sv=new we,cF=new we,rv=new Q,ov=new st,av=new Q,uF=r=>r.isInstancedBufferAttribute,mp=g.forwardRef(({context:r,children:e,...t},i)=>{g.useMemo(()=>Ci({PositionMesh:lF}),[]);const n=g.useRef();g.useImperativeHandle(i,()=>n.current,[]);const{subscribe:s,getParent:o}=g.useContext(r||WC);return g.useLayoutEffect(()=>s(n),[]),g.createElement("positionMesh",Ae({instance:o(),instanceKey:n,ref:n},t),e)}),Ap=g.forwardRef(({context:r,children:e,range:t,limit:i=1e3,frames:n=1/0,...s},o)=>{const[{localContext:a,instance:l}]=g.useState(()=>{const v=g.createContext(null);return{localContext:v,instance:g.forwardRef((E,x)=>g.createElement(mp,Ae({context:v},E,{ref:x})))}}),c=g.useRef(null);g.useImperativeHandle(o,()=>c.current,[]);const[u,h]=g.useState([]),[[f,d]]=g.useState(()=>{const v=new Float32Array(i*16);for(let E=0;E<i;E++)cF.identity().toArray(v,E*16);return[v,new Float32Array([...new Array(i*3)].map(()=>1))]});g.useEffect(()=>{c.current.instanceMatrix.needsUpdate=!0});let m=0,A=0;const p=g.useRef([]);g.useLayoutEffect(()=>{p.current=Object.entries(c.current.geometry.attributes).filter(([v,E])=>uF(E))}),Ve(()=>{if(n===1/0||m<n){c.current.updateMatrix(),c.current.updateMatrixWorld(),nv.copy(c.current.matrixWorld).invert(),A=Math.min(i,t!==void 0?t:i,u.length),c.current.count=A,rc(c.current.instanceMatrix,{offset:0,count:A*16}),rc(c.current.instanceColor,{offset:0,count:A*3});for(let v=0;v<u.length;v++){const E=u[v].current;E.matrixWorld.decompose(rv,ov,av),sv.compose(rv,ov,av).premultiply(nv),sv.toArray(f,v*16),c.current.instanceMatrix.needsUpdate=!0,E.color.toArray(d,v*3),c.current.instanceColor.needsUpdate=!0}m++}});const y=g.useMemo(()=>({getParent:()=>c,subscribe:v=>(h(E=>[...E,v]),()=>h(E=>E.filter(x=>x.current!==v.current)))}),[]);return g.createElement("instancedMesh",Ae({userData:{instances:u,limit:i,frames:n},matrixAutoUpdate:!1,ref:c,args:[null,null,0],raycast:()=>null},s),g.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:f.length/16,array:f,itemSize:16,usage:nn}),g.createElement("instancedBufferAttribute",{attach:"instanceColor",count:d.length/3,array:d,itemSize:3,usage:nn}),aF(e)?g.createElement(a.Provider,{value:y},e(l)):r?g.createElement(r.Provider,{value:y},e):g.createElement(WC.Provider,{value:y},e))}),nN=g.forwardRef(function({meshes:e,children:t,...i},n){const s=Array.isArray(e);if(!s)for(const o of Object.keys(e))e[o].isMesh||delete e[o];return g.createElement("group",{ref:n},g.createElement($C,{components:(s?e:Object.values(e)).map(({geometry:o,material:a})=>g.createElement(Ap,Ae({key:o.uuid,geometry:o,material:a},i)))},o=>s?t(...o):t(Object.keys(e).filter(a=>e[a].isMesh).reduce((a,l,c)=>({...a,[l]:o[c]}),{}))))});function sN(){const r=g.createContext(null);return[g.forwardRef((e,t)=>g.createElement(Ap,Ae({ref:t,context:r},e))),g.forwardRef((e,t)=>g.createElement(mp,Ae({ref:t,context:r},e)))]}const rN=g.forwardRef(({name:r,defaultValue:e,normalized:t,usage:i=nn},n)=>{const s=g.useRef(null);g.useImperativeHandle(n,()=>s.current,[]),g.useLayoutEffect(()=>{const a=s.current.__r3f.parent;a.geometry.attributes[r]=s.current;const l=Array.isArray(e)?e:[e],c=Array.from({length:a.userData.limit},()=>l).flat();return s.current.array=new Float32Array(c),s.current.itemSize=l.length,s.current.count=c.length/s.current.itemSize,()=>{delete a.geometry.attributes[r]}},[r]);let o=0;return Ve(()=>{const a=s.current.__r3f.parent;if(a.userData.frames===1/0||o<a.userData.frames){for(let l=0;l<a.userData.instances.length;l++){const u=a.userData.instances[l].current[r];u!==void 0&&(s.current.set(Array.isArray(u)?u:typeof u.toArray=="function"?u.toArray():[u],l*s.current.itemSize),s.current.needsUpdate=!0)}o++}}),g.createElement("instancedBufferAttribute",{ref:s,usage:i,normalized:t})}),jC=g.createContext(null);function oN(){return g.useContext(jC)}function hF(r){return r!==null&&"meta"in r&&"frames"in r}const lv=new ln(1,1),aN=g.forwardRef(({startFrame:r=0,endFrame:e,fps:t=30,frameName:i="",textureDataURL:n,textureImageURL:s,loop:o=!1,numberOfFrames:a=1,autoPlay:l=!0,animationNames:c,onStart:u,onEnd:h,onLoopEnd:f,onFrame:d,play:m,pause:A=!1,flipX:p=!1,alphaTest:y=0,children:v,asSprite:E=!1,offset:x,playBackwards:I=!1,resetOnEnd:C=!1,maxItems:_=1,instanceItems:S=[[0,0,0]],spriteDataset:b,canvasRenderingContext2DSettings:T,roundFramePosition:R=!1,meshProps:w={},...B},M)=>{const O=g.useRef(new mr),U=g.useRef(null),Y=g.useRef(null),W=g.useRef(null),N=g.useRef(window.performance.now()),K=g.useRef(r),D=g.useRef(i),z=t>0?1e3/t:0,[$,V]=g.useState(new tn),P=g.useRef(0),[G,F]=g.useState(new Q(1,1,1)),k=p?-1:1,Z=g.useRef(A),ne=g.useRef(x),X=g.useRef(!1),{spriteObj:te,loadJsonAndTexture:ye}=up(null,null,c,a,void 0,T),ve=g.useRef(i),re=g.useCallback((Ie,_e)=>{if(_e===null)a&&(P.current=a,I&&(K.current=a-1),U.current=_e);else{var Be,Se;U.current=_e,U.current&&Array.isArray(U.current.frames)?P.current=U.current.frames.length:U.current&&typeof U.current=="object"&&ve.current?P.current=U.current.frames[ve.current].length:P.current=0,I&&(K.current=P.current-1);const{w:Ke,h:Me}=Ah((Be=(Se=U.current)==null?void 0:Se.frames)!==null&&Be!==void 0?Be:[],ve.current).sourceSize,Ge=le(Ke,Me);F(Ge),Y.current&&(Y.current.map=Ie)}V(Ie)},[a,I]),se=g.useCallback(()=>{if(!U.current)return;const{meta:{size:Ie},frames:_e}=U.current,{w:Be,h:Se}=Array.isArray(_e)?_e[0].sourceSize:i?_e[i]?_e[i][0].sourceSize:{w:0,h:0}:{w:0,h:0};Y.current&&Y.current.map&&(Y.current.map.wrapS=Y.current.map.wrapT=zn,Y.current.map.center.set(0,0),Y.current.map.repeat.set(1*k/(Ie.w/Be),1/(Ie.h/Se)));const Me=1/((Ie.h-1)/Se);Y.current&&Y.current.map&&(Y.current.map.offset.x=0,Y.current.map.offset.y=1-Me),u&&u({currentFrameName:i??"",currentFrame:K.current})},[k,i,u]),he=g.useMemo(()=>({current:ne.current,offset:ne.current,imageUrl:s,hasEnded:!1,ref:M}),[s,M]);g.useImperativeHandle(M,()=>O.current,[]),g.useLayoutEffect(()=>{ne.current=x},[x]);const le=(Ie,_e)=>{var Be;const Se=new Q,Ke=_e/Ie;return Se.set(1,Ke,1),(Be=W.current)==null||Be.scale.copy(Se),Se};g.useEffect(()=>{if(b){var Ie;re(b==null||(Ie=b.spriteTexture)==null?void 0:Ie.clone(),b.spriteData)}else s&&n&&ye(s,n)},[ye,b,n,s,re]),g.useEffect(()=>{if(te){var Ie;re(te==null||(Ie=te.spriteTexture)==null?void 0:Ie.clone(),te?.spriteData)}},[te,re]),g.useEffect(()=>{if(he.hasEnded=!1,U.current&&I===!0){var Ie;K.current=((Ie=U.current.frames.length)!==null&&Ie!==void 0?Ie:0)-1}else K.current=0},[I,he]),g.useLayoutEffect(()=>{se()},[$,p,se]),g.useEffect(()=>{l&&(Z.current=!1)},[l]),g.useLayoutEffect(()=>{if(D.current!==i&&i&&(K.current=0,D.current=i,he.hasEnded=!1,z<=0&&(K.current=e||r||0),U.current)){const{w:Ie,h:_e}=Ah(U.current.frames,i).sourceSize,Be=le(Ie,_e);F(Be)}},[i,z,he,e,r]);const J=()=>{if(!hF(U.current))return;const{meta:{size:Ie},frames:_e}=U.current,{w:Be,h:Se}=Ah(_e,i).sourceSize,Ke=Array.isArray(_e)?_e:i?_e[i]:[],Me=e||Ke.length-1;var Ge=x===void 0?he.current:x;if(z<=0){K.current=e||r||0,q(Be,Se,Ie,Ke);return}const Qe=window.performance.now(),qe=Qe-N.current;if(!(qe<=z)){var rt=I?K.current<0:K.current>Me,gt=I?K.current===Me:K.current===0,nt=I?K.current<0:K.current>=Me;if(rt){if(K.current=o?r??0:0,I&&(K.current=Me),o?f?.({currentFrameName:i??"",currentFrame:K.current}):(h?.({currentFrameName:i??"",currentFrame:K.current}),he.hasEnded=!C,C&&(Z.current=!0)),!o)return}else gt&&u?.({currentFrameName:i??"",currentFrame:K.current});Ge!==void 0&&nt?X.current===!1&&(h?.({currentFrameName:i??"",currentFrame:K.current}),X.current=!0):X.current=!1,!(qe<=z)&&(N.current=Qe-qe%z,q(Be,Se,Ie,Ke))}},q=(Ie,_e,Be,Se)=>{var Ke=x===void 0?he.current:x;const Me=K.current;let Ge=0,Qe=0;le(Ie,_e);const qe=R?Math.round((Be.w-1)/Ie):(Be.w-1)/Ie,rt=R?Math.round((Be.h-1)/_e):(Be.h-1)/_e;if(!Se[Me])return;const{frame:{x:gt,y:nt},sourceSize:{w:Xe,h:je}}=Se[Me],ie=1/qe,be=1/rt;if(Y.current&&Y.current.map&&(Ge=k>0?ie*(gt/Xe):ie*(gt/Xe)-Y.current.map.repeat.x,Qe=Math.abs(1-be)-be*(nt/je),Y.current.map.offset.x=Ge,Y.current.map.offset.y=Qe),Ke!=null){let Le=Math.floor(Ke*Se.length);Le=Math.max(0,Math.min(Le,Se.length-1)),isNaN(Le)&&(Le=0),K.current=Le}else I?K.current-=1:K.current+=1};Ve((Ie,_e)=>{var Be,Se;!((Be=U.current)!=null&&Be.frames)||!((Se=Y.current)!=null&&Se.map)||Z.current||!he.hasEnded&&(l||m)&&(J(),d?.({currentFrameName:D.current,currentFrame:K.current}))});function oe(Ie=new Q(1,1,1),_e=1){if(typeof _e=="number")return Ie.multiplyScalar(_e);if(Array.isArray(_e))return Ie.multiply(new Q(..._e));if(_e instanceof Q)return Ie.multiply(_e)}return g.createElement("group",Ae({},B,{ref:O,scale:oe(G,B.scale)}),g.createElement(jC.Provider,{value:he},E&&g.createElement(R8,null,g.createElement("mesh",Ae({ref:W,scale:1,geometry:lv},w),g.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:bi,ref:Y,map:$,transparent:!0,alphaTest:y??0}))),!E&&g.createElement(Ap,Ae({geometry:lv,limit:_??1},w),g.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:bi,ref:Y,map:$,transparent:!0,alphaTest:y??0}),(S??[0]).map((Ie,_e)=>g.createElement(mp,Ae({key:_e,ref:S?.length===1?W:null,position:Ie,scale:1},w)))),v))}),lN=g.forwardRef(({children:r,curve:e},t)=>{const[i]=g.useState(()=>new Wr),[n,s]=g.useState(),o=g.useRef(null);return g.useLayoutEffect(()=>{o.current=new vb(i.children[0]),s(o.current.object3D)},[r]),g.useEffect(()=>{var a;e&&((a=o.current)==null||a.updateCurve(0,e))},[e]),g.useImperativeHandle(t,()=>o.current),g.createElement(g.Fragment,null,vo(r,i),n&&g.createElement("primitive",{object:n}))});var fF=`#define GLSLIFY 1
vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`;class dF extends os{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._distort={value:.4},this._radius={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.radius=this._radius,e.uniforms.distort=this._distort,e.vertexShader=`
      uniform float time;
      uniform float radius;
      uniform float distort;
      ${fF}
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`
        float updateTime = time / 50.0;
        float noise = snoise(vec3(position / 2.0 + updateTime * 5.0));
        vec3 transformed = vec3(position * (noise * pow(distort, 2.0) + radius));
        `)}get time(){return this._time.value}set time(e){this._time.value=e}get distort(){return this._distort.value}set distort(e){this._distort.value=e}get radius(){return this._radius.value}set radius(e){this._radius.value=e}}const cN=g.forwardRef(({speed:r=1,...e},t)=>{const[i]=g.useState(()=>new dF);return Ve(n=>i&&(i.time=n.clock.elapsedTime*r)),g.createElement("primitive",Ae({object:i,ref:t,attach:"material"},e))});class mF extends Yh{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._factor={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.factor=this._factor,e.vertexShader=`
      uniform float time;
      uniform float factor;
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`float theta = sin( time + position.y ) / 2.0 * factor;
        float c = cos( theta );
        float s = sin( theta );
        mat3 m = mat3( c, 0, s, 0, 1, 0, -s, 0, c );
        vec3 transformed = vec3( position ) * m;
        vNormal = vNormal * m;`)}get time(){return this._time.value}set time(e){this._time.value=e}get factor(){return this._factor.value}set factor(e){this._factor.value=e}}const uN=g.forwardRef(({speed:r=1,...e},t)=>{const[i]=g.useState(()=>new mF);return Ve(n=>i&&(i.time=n.clock.elapsedTime*r)),g.createElement("primitive",Ae({object:i,ref:t,attach:"material"},e))});class AF extends Ii{constructor(e=new De){super({uniforms:{inputBuffer:new Dn(null),depthBuffer:new Dn(null),resolution:new Dn(new De),texelSize:new Dn(new De),halfTexelSize:new Dn(new De),kernel:new Dn(0),scale:new Dn(1),cameraNear:new Dn(0),cameraFar:new Dn(1),minDepthThreshold:new Dn(0),maxDepthThreshold:new Dn(1),depthScale:new Dn(0),depthToBlurRatioBias:new Dn(.25)},fragmentShader:`#include <common>
        #include <dithering_pars_fragment>      
        uniform sampler2D inputBuffer;
        uniform sampler2D depthBuffer;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          float depthFactor = 0.0;
          
          #ifdef USE_DEPTH
            vec4 depth = texture2D(depthBuffer, vUv);
            depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
            depthFactor *= depthScale;
            depthFactor = max(0.0, min(1.0, depthFactor + 0.25));
          #endif
          
          vec4 sum = texture2D(inputBuffer, mix(vUv0, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv1, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv2, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv3, vUv, depthFactor));
          gl_FragColor = sum * 0.25 ;

          #include <dithering_fragment>
          #include <tonemapping_fragment>
          #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
        }`,vertexShader:`uniform vec2 texelSize;
        uniform vec2 halfTexelSize;
        uniform float kernel;
        uniform float scale;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          vec2 uv = position.xy * 0.5 + 0.5;
          vUv = uv;

          vec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;
          vUv0 = vec2(uv.x - dUv.x, uv.y + dUv.y);
          vUv1 = vec2(uv.x + dUv.x, uv.y + dUv.y);
          vUv2 = vec2(uv.x + dUv.x, uv.y - dUv.y);
          vUv3 = vec2(uv.x - dUv.x, uv.y - dUv.y);

          gl_Position = vec4(position.xy, 1.0, 1.0);
        }`,blending:tA,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernel=new Float32Array([0,1,2,2,3])}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}setResolution(e){this.uniforms.resolution.value.copy(e)}}class qC{constructor({gl:e,resolution:t,width:i=500,height:n=500,minDepthThreshold:s=0,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:l=.25}){this.renderToScreen=!1,this.renderTargetA=new xi(t,t,{minFilter:Nt,magFilter:Nt,stencilBuffer:!1,depthBuffer:!1,type:ui}),this.renderTargetB=this.renderTargetA.clone(),this.convolutionMaterial=new AF,this.convolutionMaterial.setTexelSize(1/i,1/n),this.convolutionMaterial.setResolution(new De(i,n)),this.scene=new Wr,this.camera=new bE,this.convolutionMaterial.uniforms.minDepthThreshold.value=s,this.convolutionMaterial.uniforms.maxDepthThreshold.value=o,this.convolutionMaterial.uniforms.depthScale.value=a,this.convolutionMaterial.uniforms.depthToBlurRatioBias.value=l,this.convolutionMaterial.defines.USE_DEPTH=a>0;const c=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),u=new Float32Array([0,0,2,0,0,2]),h=new Gi;h.setAttribute("position",new Vt(c,3)),h.setAttribute("uv",new Vt(u,2)),this.screen=new ze(h,this.convolutionMaterial),this.screen.frustumCulled=!1,this.scene.add(this.screen)}render(e,t,i){const n=this.scene,s=this.camera,o=this.renderTargetA,a=this.renderTargetB;let l=this.convolutionMaterial,c=l.uniforms;c.depthBuffer.value=t.depthTexture;const u=l.kernel;let h=t,f,d,m;for(d=0,m=u.length-1;d<m;++d)f=(d&1)===0?o:a,c.kernel.value=u[d],c.inputBuffer.value=h.texture,e.setRenderTarget(f),e.render(n,s),h=f;c.kernel.value=u[d],c.inputBuffer.value=h.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(n,s)}}let XC=class extends Yh{constructor(e={}){super(e),this._tDepth={value:null},this._distortionMap={value:null},this._tDiffuse={value:null},this._tDiffuseBlur={value:null},this._textureMatrix={value:null},this._hasBlur={value:!1},this._mirror={value:0},this._mixBlur={value:0},this._blurStrength={value:.5},this._minDepthThreshold={value:.9},this._maxDepthThreshold={value:1},this._depthScale={value:0},this._depthToBlurRatioBias={value:.25},this._distortion={value:1},this._mixContrast={value:1},this.setValues(e)}onBeforeCompile(e){var t;(t=e.defines)!=null&&t.USE_UV||(e.defines.USE_UV=""),e.uniforms.hasBlur=this._hasBlur,e.uniforms.tDiffuse=this._tDiffuse,e.uniforms.tDepth=this._tDepth,e.uniforms.distortionMap=this._distortionMap,e.uniforms.tDiffuseBlur=this._tDiffuseBlur,e.uniforms.textureMatrix=this._textureMatrix,e.uniforms.mirror=this._mirror,e.uniforms.mixBlur=this._mixBlur,e.uniforms.mixStrength=this._blurStrength,e.uniforms.minDepthThreshold=this._minDepthThreshold,e.uniforms.maxDepthThreshold=this._maxDepthThreshold,e.uniforms.depthScale=this._depthScale,e.uniforms.depthToBlurRatioBias=this._depthToBlurRatioBias,e.uniforms.distortion=this._distortion,e.uniforms.mixContrast=this._mixContrast,e.vertexShader=`
        uniform mat4 textureMatrix;
        varying vec4 my_vUv;
      ${e.vertexShader}`,e.vertexShader=e.vertexShader.replace("#include <project_vertex>",`#include <project_vertex>
        my_vUv = textureMatrix * vec4( position, 1.0 );
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );`),e.fragmentShader=`
        uniform sampler2D tDiffuse;
        uniform sampler2D tDiffuseBlur;
        uniform sampler2D tDepth;
        uniform sampler2D distortionMap;
        uniform float distortion;
        uniform float cameraNear;
			  uniform float cameraFar;
        uniform bool hasBlur;
        uniform float mixBlur;
        uniform float mirror;
        uniform float mixStrength;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float mixContrast;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec4 my_vUv;
        ${e.fragmentShader}`,e.fragmentShader=e.fragmentShader.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>

      float distortionFactor = 0.0;
      #ifdef USE_DISTORTION
        distortionFactor = texture2D(distortionMap, vUv).r * distortion;
      #endif

      vec4 new_vUv = my_vUv;
      new_vUv.x += distortionFactor;
      new_vUv.y += distortionFactor;

      vec4 base = texture2DProj(tDiffuse, new_vUv);
      vec4 blur = texture2DProj(tDiffuseBlur, new_vUv);

      vec4 merge = base;

      #ifdef USE_NORMALMAP
        vec2 normal_uv = vec2(0.0);
        vec4 normalColor = texture2D(normalMap, vUv * normalScale);
        vec3 my_normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );
        vec3 coord = new_vUv.xyz / new_vUv.w;
        normal_uv = coord.xy + coord.z * my_normal.xz * 0.05;
        vec4 base_normal = texture2D(tDiffuse, normal_uv);
        vec4 blur_normal = texture2D(tDiffuseBlur, normal_uv);
        merge = base_normal;
        blur = blur_normal;
      #endif

      float depthFactor = 0.0001;
      float blurFactor = 0.0;

      #ifdef USE_DEPTH
        vec4 depth = texture2DProj(tDepth, new_vUv);
        depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
        depthFactor *= depthScale;
        depthFactor = max(0.0001, min(1.0, depthFactor));

        #ifdef USE_BLUR
          blur = blur * min(1.0, depthFactor + depthToBlurRatioBias);
          merge = merge * min(1.0, depthFactor + 0.5);
        #else
          merge = merge * depthFactor;
        #endif

      #endif

      float reflectorRoughnessFactor = roughness;
      #ifdef USE_ROUGHNESSMAP
        vec4 reflectorTexelRoughness = texture2D( roughnessMap, vUv );
        reflectorRoughnessFactor *= reflectorTexelRoughness.g;
      #endif

      #ifdef USE_BLUR
        blurFactor = min(1.0, mixBlur * reflectorRoughnessFactor);
        merge = mix(merge, blur, blurFactor);
      #endif

      vec4 newMerge = vec4(0.0, 0.0, 0.0, 1.0);
      newMerge.r = (merge.r - 0.5) * mixContrast + 0.5;
      newMerge.g = (merge.g - 0.5) * mixContrast + 0.5;
      newMerge.b = (merge.b - 0.5) * mixContrast + 0.5;

      diffuseColor.rgb = diffuseColor.rgb * ((1.0 - min(1.0, mirror)) + newMerge.rgb * mixStrength);
      `)}get tDiffuse(){return this._tDiffuse.value}set tDiffuse(e){this._tDiffuse.value=e}get tDepth(){return this._tDepth.value}set tDepth(e){this._tDepth.value=e}get distortionMap(){return this._distortionMap.value}set distortionMap(e){this._distortionMap.value=e}get tDiffuseBlur(){return this._tDiffuseBlur.value}set tDiffuseBlur(e){this._tDiffuseBlur.value=e}get textureMatrix(){return this._textureMatrix.value}set textureMatrix(e){this._textureMatrix.value=e}get hasBlur(){return this._hasBlur.value}set hasBlur(e){this._hasBlur.value=e}get mirror(){return this._mirror.value}set mirror(e){this._mirror.value=e}get mixBlur(){return this._mixBlur.value}set mixBlur(e){this._mixBlur.value=e}get mixStrength(){return this._blurStrength.value}set mixStrength(e){this._blurStrength.value=e}get minDepthThreshold(){return this._minDepthThreshold.value}set minDepthThreshold(e){this._minDepthThreshold.value=e}get maxDepthThreshold(){return this._maxDepthThreshold.value}set maxDepthThreshold(e){this._maxDepthThreshold.value=e}get depthScale(){return this._depthScale.value}set depthScale(e){this._depthScale.value=e}get depthToBlurRatioBias(){return this._depthToBlurRatioBias.value}set depthToBlurRatioBias(e){this._depthToBlurRatioBias.value=e}get distortion(){return this._distortion.value}set distortion(e){this._distortion.value=e}get mixContrast(){return this._mixContrast.value}set mixContrast(e){this._mixContrast.value=e}};const fN=g.forwardRef(({mixBlur:r=0,mixStrength:e=1,resolution:t=256,blur:i=[0,0],minDepthThreshold:n=.9,maxDepthThreshold:s=1,depthScale:o=0,depthToBlurRatioBias:a=.25,mirror:l=0,distortion:c=1,mixContrast:u=1,distortionMap:h,reflectorOffset:f=0,...d},m)=>{Ci({MeshReflectorMaterialImpl:XC});const A=ae(({gl:D})=>D),p=ae(({camera:D})=>D),y=ae(({scene:D})=>D);i=Array.isArray(i)?i:[i,i];const v=i[0]+i[1]>0,E=g.useRef(null);g.useImperativeHandle(m,()=>E.current,[]);const[x]=g.useState(()=>new Xs),[I]=g.useState(()=>new Q),[C]=g.useState(()=>new Q),[_]=g.useState(()=>new Q),[S]=g.useState(()=>new we),[b]=g.useState(()=>new Q(0,0,-1)),[T]=g.useState(()=>new yi),[R]=g.useState(()=>new Q),[w]=g.useState(()=>new Q),[B]=g.useState(()=>new yi),[M]=g.useState(()=>new we),[O]=g.useState(()=>new jt),U=g.useCallback(()=>{var D;const z=E.current.parent||((D=E.current)==null?void 0:D.__r3f.parent);if(!z||(C.setFromMatrixPosition(z.matrixWorld),_.setFromMatrixPosition(p.matrixWorld),S.extractRotation(z.matrixWorld),I.set(0,0,1),I.applyMatrix4(S),C.addScaledVector(I,f),R.subVectors(C,_),R.dot(I)>0))return;R.reflect(I).negate(),R.add(C),S.extractRotation(p.matrixWorld),b.set(0,0,-1),b.applyMatrix4(S),b.add(_),w.subVectors(C,b),w.reflect(I).negate(),w.add(C),O.position.copy(R),O.up.set(0,1,0),O.up.applyMatrix4(S),O.up.reflect(I),O.lookAt(w),O.far=p.far,O.updateMatrixWorld(),O.projectionMatrix.copy(p.projectionMatrix),M.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),M.multiply(O.projectionMatrix),M.multiply(O.matrixWorldInverse),M.multiply(z.matrixWorld),x.setFromNormalAndCoplanarPoint(I,C),x.applyMatrix4(O.matrixWorldInverse),T.set(x.normal.x,x.normal.y,x.normal.z,x.constant);const $=O.projectionMatrix;B.x=(Math.sign(T.x)+$.elements[8])/$.elements[0],B.y=(Math.sign(T.y)+$.elements[9])/$.elements[5],B.z=-1,B.w=(1+$.elements[10])/$.elements[14],T.multiplyScalar(2/T.dot(B)),$.elements[2]=T.x,$.elements[6]=T.y,$.elements[10]=T.z+1,$.elements[14]=T.w},[p,f]),[Y,W,N,K]=g.useMemo(()=>{const D={minFilter:Nt,magFilter:Nt,type:ui},z=new xi(t,t,D);z.depthBuffer=!0,z.depthTexture=new jh(t,t),z.depthTexture.format=oA,z.depthTexture.type=Xh;const $=new xi(t,t,D),V=new qC({gl:A,resolution:t,width:i[0],height:i[1],minDepthThreshold:n,maxDepthThreshold:s,depthScale:o,depthToBlurRatioBias:a}),P={mirror:l,textureMatrix:M,mixBlur:r,tDiffuse:z.texture,tDepth:z.depthTexture,tDiffuseBlur:$.texture,hasBlur:v,mixStrength:e,minDepthThreshold:n,maxDepthThreshold:s,depthScale:o,depthToBlurRatioBias:a,distortion:c,distortionMap:h,mixContrast:u,"defines-USE_BLUR":v?"":void 0,"defines-USE_DEPTH":o>0?"":void 0,"defines-USE_DISTORTION":h?"":void 0};return[z,$,V,P]},[A,i,M,t,l,v,r,e,n,s,o,a,c,h,u]);return Ve(()=>{var D;const z=E.current.parent||((D=E.current)==null?void 0:D.__r3f.parent);if(!z)return;z.visible=!1;const $=A.xr.enabled,V=A.shadowMap.autoUpdate;U(),A.xr.enabled=!1,A.shadowMap.autoUpdate=!1,A.setRenderTarget(Y),A.state.buffers.depth.setMask(!0),A.autoClear||A.clear(),A.render(y,O),v&&N.render(A,Y,W),A.xr.enabled=$,A.shadowMap.autoUpdate=V,z.visible=!0,A.setRenderTarget(null)}),g.createElement("meshReflectorMaterialImpl",Ae({attach:"material",key:"key"+K["defines-USE_BLUR"]+K["defines-USE_DEPTH"]+K["defines-USE_DISTORTION"],ref:E},K,d))}),pF=ws({envMap:null,bounces:3,ior:2.4,correctMips:!0,aberrationStrength:.01,fresnel:0,bvh:new VC,color:new We("white"),opacity:1,resolution:new De,viewMatrixInverse:new we,projectionMatrixInverse:new we},`
  uniform mat4 viewMatrixInverse;

  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_vertex>

  void main() {
    #include <color_vertex>

    vec4 transformedNormal = vec4(normal, 0.0);
    vec4 transformedPosition = vec4(position, 1.0);
    #ifdef USE_INSTANCING
      transformedNormal = instanceMatrix * transformedNormal;
      transformedPosition = instanceMatrix * transformedPosition;
    #endif

    #ifdef USE_INSTANCING
      vModelMatrixInverse = inverse(modelMatrix * instanceMatrix);
    #else
      vModelMatrixInverse = inverse(modelMatrix);
    #endif

    vWorldPosition = (modelMatrix * transformedPosition).xyz;
    vNormal = normalize((viewMatrixInverse * vec4(normalMatrix * transformedNormal.xyz, 0.0)).xyz);
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * transformedPosition;
  }`,`
  #define ENVMAP_TYPE_CUBE_UV
  precision highp isampler2D;
  precision highp usampler2D;
  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    uniform samplerCube envMap;
  #else
    uniform sampler2D envMap;
  #endif

  uniform float bounces;
  ${YP}
  ${WP}
  uniform BVH bvh;
  uniform float ior;
  uniform bool correctMips;
  uniform vec2 resolution;
  uniform float fresnel;
  uniform mat4 modelMatrix;
  uniform mat4 projectionMatrixInverse;
  uniform mat4 viewMatrixInverse;
  uniform float aberrationStrength;
  uniform vec3 color;
  uniform float opacity;

  float fresnelFunc(vec3 viewDirection, vec3 worldNormal) {
    return pow( 1.0 + dot( viewDirection, worldNormal), 10.0 );
  }

  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 normal, float ior, mat4 modelMatrixInverse) {
    vec3 rayOrigin = ro;
    vec3 rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = vWorldPosition + rayDirection * 0.001;
    rayOrigin = (modelMatrixInverse * vec4(rayOrigin, 1.0)).xyz;
    rayDirection = normalize((modelMatrixInverse * vec4(rayDirection, 0.0)).xyz);
    for(float i = 0.0; i < bounces; i++) {
      uvec4 faceIndices = uvec4( 0u );
      vec3 faceNormal = vec3( 0.0, 0.0, 1.0 );
      vec3 barycoord = vec3( 0.0 );
      float side = 1.0;
      float dist = 0.0;
      bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );
      vec3 hitPos = rayOrigin + rayDirection * max(dist - 0.001, 0.0);
      vec3 tempDir = refract(rayDirection, faceNormal, ior);
      if (length(tempDir) != 0.0) {
        rayDirection = tempDir;
        break;
      }
      rayDirection = reflect(rayDirection, faceNormal);
      rayOrigin = hitPos + rayDirection * 0.01;
    }
    rayDirection = normalize((modelMatrix * vec4(rayDirection, 0.0)).xyz);
    return rayDirection;
  }

  #include <common>
  #include <cube_uv_reflection_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    vec4 textureGradient(samplerCube envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      return textureGrad(envMap, rayDirection, dFdx(correctMips ? directionCamPerfect: rayDirection), dFdy(correctMips ? directionCamPerfect: rayDirection));
    }
  #else
    vec4 textureGradient(sampler2D envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      vec2 uvv = equirectUv( rayDirection );
      vec2 smoothUv = equirectUv( directionCamPerfect );
      return textureGrad(envMap, uvv, dFdx(correctMips ? smoothUv : uvv), dFdy(correctMips ? smoothUv : uvv));
    }
  #endif

  void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 directionCamPerfect = (projectionMatrixInverse * vec4(uv * 2.0 - 1.0, 0.0, 1.0)).xyz;
    directionCamPerfect = (viewMatrixInverse * vec4(directionCamPerfect, 0.0)).xyz;
    directionCamPerfect = normalize(directionCamPerfect);
    vec3 normal = vNormal;
    vec3 rayOrigin = cameraPosition;
    vec3 rayDirection = normalize(vWorldPosition - cameraPosition);

    vec4 diffuseColor = vec4(color, opacity);
    #include <color_fragment>

    #ifdef CHROMATIC_ABERRATIONS
      vec3 rayDirectionG = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      #ifdef FAST_CHROMA
        vec3 rayDirectionR = normalize(rayDirectionG + 1.0 * vec3(aberrationStrength / 2.0));
        vec3 rayDirectionB = normalize(rayDirectionG - 1.0 * vec3(aberrationStrength / 2.0));
      #else
        vec3 rayDirectionR = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 - aberrationStrength), 1.0), vModelMatrixInverse);
        vec3 rayDirectionB = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 + aberrationStrength), 1.0), vModelMatrixInverse);
      #endif
      float finalColorR = textureGradient(envMap, rayDirectionR, directionCamPerfect).r;
      float finalColorG = textureGradient(envMap, rayDirectionG, directionCamPerfect).g;
      float finalColorB = textureGradient(envMap, rayDirectionB, directionCamPerfect).b;
      diffuseColor.rgb *= vec3(finalColorR, finalColorG, finalColorB);
    #else
      rayDirection = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      diffuseColor.rgb *= textureGradient(envMap, rayDirection, directionCamPerfect).rgb;
    #endif

    vec3 viewDirection = normalize(vWorldPosition - cameraPosition);
    float nFresnel = fresnelFunc(viewDirection, normal) * fresnel;
    gl_FragColor = vec4(mix(diffuseColor.rgb, vec3(1.0), nFresnel), diffuseColor.a);

    #include <tonemapping_fragment>
    #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
  }`),gF=r=>r&&r.isCubeTexture;function dN({aberrationStrength:r=0,fastChroma:e=!0,envMap:t,...i}){Ci({MeshRefractionMaterial:pF});const n=g.useRef(),{size:s}=ae(),o=g.useMemo(()=>{var a,l;const c={},u=gF(t),f=((a=u?(l=t.image[0])==null?void 0:l.width:t.image.width)!==null&&a!==void 0?a:1024)/4,d=Math.floor(Math.log2(f)),m=Math.pow(2,d),A=3*Math.max(m,112),p=4*m;return u&&(c.ENVMAP_TYPE_CUBEM=""),c.CUBEUV_TEXEL_WIDTH=`${1/A}`,c.CUBEUV_TEXEL_HEIGHT=`${1/p}`,c.CUBEUV_MAX_MIP=`${d}.0`,r>0&&(c.CHROMATIC_ABERRATIONS=""),e&&(c.FAST_CHROMA=""),c},[r,e]);return g.useLayoutEffect(()=>{var a;const l=(a=n.current)==null||(a=a.__r3f)==null||(a=a.parent)==null?void 0:a.geometry;l&&(n.current.bvh=new VC,n.current.bvh.updateFrom(new Sf(l.clone().toNonIndexed(),{strategy:If})))},[]),Ve(({camera:a})=>{n.current.viewMatrixInverse=a.matrixWorld,n.current.projectionMatrixInverse=a.projectionMatrixInverse}),g.createElement("meshRefractionMaterial",Ae({key:JSON.stringify(o),defines:o,ref:n,resolution:[s.width,s.height],aberrationStrength:r,envMap:t},i))}const pp=ws({},"void main() { }","void main() { gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); discard;  }");class yF extends os{constructor(e=6,t=!1){super(),this.uniforms={chromaticAberration:{value:.05},transmission:{value:0},_transmission:{value:1},transmissionMap:{value:null},roughness:{value:0},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:1/0},attenuationColor:{value:new We("white")},anisotropicBlur:{value:.1},time:{value:0},distortion:{value:0},distortionScale:{value:.5},temporalDistortion:{value:0},buffer:{value:null}},this.onBeforeCompile=i=>{i.uniforms={...i.uniforms,...this.uniforms},this.anisotropy>0&&(i.defines.USE_ANISOTROPY=""),t?i.defines.USE_SAMPLER="":i.defines.USE_TRANSMISSION="",i.fragmentShader=`
      uniform float chromaticAberration;         
      uniform float anisotropicBlur;      
      uniform float time;
      uniform float distortion;
      uniform float distortionScale;
      uniform float temporalDistortion;
      uniform sampler2D buffer;

      vec3 random3(vec3 c) {
        float j = 4096.0*sin(dot(c,vec3(17.0, 59.4, 15.0)));
        vec3 r;
        r.z = fract(512.0*j);
        j *= .125;
        r.x = fract(512.0*j);
        j *= .125;
        r.y = fract(512.0*j);
        return r-0.5;
      }

      uint hash( uint x ) {
        x += ( x << 10u );
        x ^= ( x >>  6u );
        x += ( x <<  3u );
        x ^= ( x >> 11u );
        x += ( x << 15u );
        return x;
      }

      // Compound versions of the hashing algorithm I whipped together.
      uint hash( uvec2 v ) { return hash( v.x ^ hash(v.y)                         ); }
      uint hash( uvec3 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z)             ); }
      uint hash( uvec4 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z) ^ hash(v.w) ); }

      // Construct a float with half-open range [0:1] using low 23 bits.
      // All zeroes yields 0.0, all ones yields the next smallest representable value below 1.0.
      float floatConstruct( uint m ) {
        const uint ieeeMantissa = 0x007FFFFFu; // binary32 mantissa bitmask
        const uint ieeeOne      = 0x3F800000u; // 1.0 in IEEE binary32
        m &= ieeeMantissa;                     // Keep only mantissa bits (fractional part)
        m |= ieeeOne;                          // Add fractional part to 1.0
        float  f = uintBitsToFloat( m );       // Range [1:2]
        return f - 1.0;                        // Range [0:1]
      }

      // Pseudo-random value in half-open range [0:1].
      float randomBase( float x ) { return floatConstruct(hash(floatBitsToUint(x))); }
      float randomBase( vec2  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec3  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec4  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float rand(float seed) {
        float result = randomBase(vec3(gl_FragCoord.xy, seed));
        return result;
      }

      const float F3 =  0.3333333;
      const float G3 =  0.1666667;

      float snoise(vec3 p) {
        vec3 s = floor(p + dot(p, vec3(F3)));
        vec3 x = p - s + dot(s, vec3(G3));
        vec3 e = step(vec3(0.0), x - x.yzx);
        vec3 i1 = e*(1.0 - e.zxy);
        vec3 i2 = 1.0 - e.zxy*(1.0 - e);
        vec3 x1 = x - i1 + G3;
        vec3 x2 = x - i2 + 2.0*G3;
        vec3 x3 = x - 1.0 + 3.0*G3;
        vec4 w, d;
        w.x = dot(x, x);
        w.y = dot(x1, x1);
        w.z = dot(x2, x2);
        w.w = dot(x3, x3);
        w = max(0.6 - w, 0.0);
        d.x = dot(random3(s), x);
        d.y = dot(random3(s + i1), x1);
        d.z = dot(random3(s + i2), x2);
        d.w = dot(random3(s + 1.0), x3);
        w *= w;
        w *= w;
        d *= w;
        return dot(d, vec4(52.0));
      }

      float snoiseFractal(vec3 m) {
        return 0.5333333* snoise(m)
              +0.2666667* snoise(2.0*m)
              +0.1333333* snoise(4.0*m)
              +0.0666667* snoise(8.0*m);
      }
`+i.fragmentShader,i.fragmentShader=i.fragmentShader.replace("#include <transmission_pars_fragment>",`
        #ifdef USE_TRANSMISSION
          // Transmission code is based on glTF-Sampler-Viewer
          // https://github.com/KhronosGroup/glTF-Sample-Viewer
          uniform float _transmission;
          uniform float thickness;
          uniform float attenuationDistance;
          uniform vec3 attenuationColor;
          #ifdef USE_TRANSMISSIONMAP
            uniform sampler2D transmissionMap;
          #endif
          #ifdef USE_THICKNESSMAP
            uniform sampler2D thicknessMap;
          #endif
          uniform vec2 transmissionSamplerSize;
          uniform sampler2D transmissionSamplerMap;
          uniform mat4 modelMatrix;
          uniform mat4 projectionMatrix;
          varying vec3 vWorldPosition;
          vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
            // Direction of refracted light.
            vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
            // Compute rotation-independant scaling of the model matrix.
            vec3 modelScale;
            modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
            modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
            modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
            // The thickness is specified in local space.
            return normalize( refractionVector ) * thickness * modelScale;
          }
          float applyIorToRoughness( const in float roughness, const in float ior ) {
            // Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and
            // an IOR of 1.5 results in the default amount of microfacet refraction.
            return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
          }
          vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
            float framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );            
            #ifdef USE_SAMPLER
              #ifdef texture2DLodEXT
                return texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #else
                return texture2D(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #endif
            #else
              return texture2D(buffer, fragCoord.xy);
            #endif
          }
          vec3 applyVolumeAttenuation( const in vec3 radiance, const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
            if ( isinf( attenuationDistance ) ) {
              // Attenuation distance is +, i.e. the transmitted color is not attenuated at all.
              return radiance;
            } else {
              // Compute light attenuation using Beer's law.
              vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
              vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance ); // Beer's law
              return transmittance * radiance;
            }
          }
          vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
            const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
            const in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,
            const in vec3 attenuationColor, const in float attenuationDistance ) {
            vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
            vec3 refractedRayExit = position + transmissionRay;
            // Project refracted vector on the framebuffer, while mapping to normalized device coordinates.
            vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
            vec2 refractionCoords = ndcPos.xy / ndcPos.w;
            refractionCoords += 1.0;
            refractionCoords /= 2.0;
            // Sample framebuffer to get pixel the refracted ray hits.
            vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
            vec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );
            // Get the specular component.
            vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
            return vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );
          }
        #endif
`),i.fragmentShader=i.fragmentShader.replace("#include <transmission_fragment>",`  
        // Improve the refraction to use the world pos
        material.transmission = _transmission;
        material.transmissionAlpha = 1.0;
        material.thickness = thickness;
        material.attenuationDistance = attenuationDistance;
        material.attenuationColor = attenuationColor;
        #ifdef USE_TRANSMISSIONMAP
          material.transmission *= texture2D( transmissionMap, vUv ).r;
        #endif
        #ifdef USE_THICKNESSMAP
          material.thickness *= texture2D( thicknessMap, vUv ).g;
        #endif
        
        vec3 pos = vWorldPosition;
        float runningSeed = 0.0;
        vec3 v = normalize( cameraPosition - pos );
        vec3 n = inverseTransformDirection( normal, viewMatrix );
        vec3 transmission = vec3(0.0);
        float transmissionR, transmissionB, transmissionG;
        float randomCoords = rand(runningSeed++);
        float thickness_smear = thickness * max(pow(roughnessFactor, 0.33), anisotropicBlur);
        vec3 distortionNormal = vec3(0.0);
        vec3 temporalOffset = vec3(time, -time, -time) * temporalDistortion;
        if (distortion > 0.0) {
          distortionNormal = distortion * vec3(snoiseFractal(vec3((pos * distortionScale + temporalOffset))), snoiseFractal(vec3(pos.zxy * distortionScale - temporalOffset)), snoiseFractal(vec3(pos.yxz * distortionScale + temporalOffset)));
        }
        for (float i = 0.0; i < ${e}.0; i ++) {
          vec3 sampleNorm = normalize(n + roughnessFactor * roughnessFactor * 2.0 * normalize(vec3(rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5)) * pow(rand(runningSeed++), 0.33) + distortionNormal);
          transmissionR = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness  + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).r;
          transmissionG = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior  * (1.0 + chromaticAberration * (i + randomCoords) / float(${e})) , material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).g;
          transmissionB = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior * (1.0 + 2.0 * chromaticAberration * (i + randomCoords) / float(${e})), material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).b;
          transmission.r += transmissionR;
          transmission.g += transmissionG;
          transmission.b += transmissionB;
        }
        transmission /= ${e}.0;
        totalDiffuse = mix( totalDiffuse, transmission.rgb, material.transmission );
`)},Object.keys(this.uniforms).forEach(i=>Object.defineProperty(this,i,{get:()=>this.uniforms[i].value,set:n=>this.uniforms[i].value=n}))}}const mN=g.forwardRef(({buffer:r,transmissionSampler:e=!1,backside:t=!1,side:i=lc,transmission:n=1,thickness:s=0,backsideThickness:o=0,backsideEnvMapIntensity:a=1,samples:l=10,resolution:c,backsideResolution:u,background:h,anisotropy:f,anisotropicBlur:d,...m},A)=>{Ci({MeshTransmissionMaterial:yF});const p=g.useRef(null),[y]=g.useState(()=>new pp),v=In(u||c),E=In(c);let x,I,C,_;return Ve(S=>{p.current.time=S.clock.elapsedTime,p.current.buffer===E.texture&&!e&&(_=p.current.__r3f.parent,_&&(C=S.gl.toneMapping,x=S.scene.background,I=p.current.envMapIntensity,S.gl.toneMapping=A_,h&&(S.scene.background=h),_.material=y,t&&(S.gl.setRenderTarget(v),S.gl.render(S.scene,S.camera),_.material=p.current,_.material.buffer=v.texture,_.material.thickness=o,_.material.side=Oa,_.material.envMapIntensity=a),S.gl.setRenderTarget(E),S.gl.render(S.scene,S.camera),_.material=p.current,_.material.thickness=s,_.material.side=i,_.material.buffer=E.texture,_.material.envMapIntensity=I,S.scene.background=x,S.gl.setRenderTarget(null),S.gl.toneMapping=C))}),g.useImperativeHandle(A,()=>p.current,[]),g.createElement("meshTransmissionMaterial",Ae({args:[l,e],ref:p},m,{buffer:r||E.texture,_transmission:n,anisotropicBlur:d??f,transmission:e?n:0,thickness:s,side:i}))}),AN=g.forwardRef((r,e)=>(Ci({DiscardMaterialImpl:pp}),g.createElement("discardMaterialImpl",Ae({ref:e},r))));function pN(r){const e=g.useRef(null);return g.useLayoutEffect(()=>{var t;const i=(t=e.current)==null?void 0:t.parent,n=i?.geometry;if(n){const s=i.material;i.material=e.current.__r3f.objects;const o=[...n.groups];return n.clearGroups(),i.material.forEach((a,l)=>{l<i.material.length-1&&(a.depthWrite=!1),n.addGroup(0,1/0,l)}),()=>{i.material=s,n.groups=o}}}),g.createElement("group",Ae({ref:e},r))}const E0=sn>=154?"opaque_fragment":"output_fragment";class vF extends hE{constructor(e){super(e),this.onBeforeCompile=(t,i)=>{const{isWebGL2:n}=i.capabilities;t.fragmentShader=t.fragmentShader.replace(`#include <${E0}>`,`
        ${n?`#include <${E0}>`:`#extension GL_OES_standard_derivatives : enable
#include <${E0}>`}
      vec2 cxy = 2.0 * gl_PointCoord - 1.0;
      float r = dot(cxy, cxy);
      float delta = fwidth(r);     
      float mask = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);
      gl_FragColor = vec4(gl_FragColor.rgb, mask * gl_FragColor.a );
      #include <tonemapping_fragment>
      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
      `)}}}const gN=g.forwardRef((r,e)=>{const[t]=g.useState(()=>new vF(null));return g.createElement("primitive",Ae({},r,{object:t,ref:e,attach:"material"}))}),EF=({focus:r=0,size:e=25,samples:t=10}={})=>`
#define PENUMBRA_FILTER_SIZE float(${e})
#define RGB_NOISE_FUNCTION(uv) (randRGB(uv))
vec3 randRGB(vec2 uv) {
  return vec3(
    fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),
    fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),
    fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)
  );
}

vec3 lowPassRandRGB(vec2 uv) {
  // 3x3 convolution (average)
  // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9
  vec3 result = vec3(0);
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));
  result *= 0.111111111; // 1.0 / 9.0
  return result;
}
vec3 highPassRandRGB(vec2 uv) {
  // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal
  // hp(x) = x - lp(x)
  return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;
}


vec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {
  const float goldenAngle = 2.399963f; // radians
  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));
  float theta = float(sampleIndex) * goldenAngle + angle;
  float sine = sin(theta);
  float cosine = cos(theta);
  return vec2(cosine, sine) * r;
}
float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
  return (zReceiver - zBlocker) / zBlocker;
}
float findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float blockerDepthSum = float(${r});
  float blockers = 0.0;

  int j = 0;
  vec2 offset = vec2(0.);
  float depth = 0.;

  #pragma unroll_loop_start
  for(int i = 0; i < ${t}; i ++) {
    offset = (vogelDiskSample(j, ${t}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;
    depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));
    if (depth < compare) {
      blockerDepthSum += depth;
      blockers++;
    }
    j++;
  }
  #pragma unroll_loop_end

  if (blockers > 0.0) {
    return blockerDepthSum / blockers;
  }
  return -1.0;
}

        
float vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float shadow = 0.0f;
  int j = 0;
  vec2 vogelSample = vec2(0.0);
  vec2 offset = vec2(0.0);
  #pragma unroll_loop_start
  for (int i = 0; i < ${t}; i++) {
    vogelSample = vogelDiskSample(j, ${t}, angle) * texelSize;
    offset = vogelSample * (1.0 + filterRadius * float(${e}));
    shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );
    j++;
  }
  #pragma unroll_loop_end
  return shadow * 1.0 / ${t}.0;
}

float PCSS (sampler2D shadowMap, vec4 coords) {
  vec2 uv = coords.xy;
  float zReceiver = coords.z; // Assumed to be eye-space z in this code
  float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;
  float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);
  if (avgBlockerDepth == -1.0) {
    return 1.0;
  }
  float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);
  return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);
}`;function cv(r,e,t){e.traverse(i=>{i.material&&(r.properties.remove(i.material),i.material.dispose==null||i.material.dispose())}),r.info.programs.length=0,r.compile(e,t)}function yN({focus:r=0,samples:e=10,size:t=25}){const i=ae(o=>o.gl),n=ae(o=>o.scene),s=ae(o=>o.camera);return g.useEffect(()=>{const o=ma.shadowmap_pars_fragment;return ma.shadowmap_pars_fragment=ma.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP",`#ifdef USE_SHADOWMAP
`+EF({size:t,samples:e,focus:r})).replace("#if defined( SHADOWMAP_TYPE_PCF )",`
return PCSS(shadowMap, shadowCoord);
#if defined( SHADOWMAP_TYPE_PCF )`),cv(i,n,s),()=>{ma.shadowmap_pars_fragment=o,cv(i,n,s)}},[r,t,e]),null}function zi(r,e){const t=r+"Geometry";return g.forwardRef(({args:i,children:n,...s},o)=>{const a=g.useRef(null);return g.useImperativeHandle(o,()=>a.current),g.useLayoutEffect(()=>void e?.(a.current)),g.createElement("mesh",Ae({ref:a},s),g.createElement(t,{attach:"geometry",args:i}),n)})}const vN=zi("box"),EN=zi("circle"),xN=zi("cone"),IN=zi("cylinder"),CN=zi("sphere"),_N=zi("plane"),SN=zi("tube"),TN=zi("torus"),bN=zi("torusKnot"),wN=zi("tetrahedron"),BN=zi("ring"),RN=zi("polyhedron"),DN=zi("icosahedron"),MN=zi("octahedron"),LN=zi("dodecahedron"),PN=zi("extrude"),FN=zi("lathe"),kN=zi("capsule"),ON=zi("shape",({geometry:r})=>{const e=r.attributes.position,t=new Jt().setFromBufferAttribute(e),i=new Q;t.getSize(i);const n=[];let s=0,o=0,a=0,l=0;for(let c=0;c<e.count;c++)s=e.getX(c),o=e.getY(c),a=(s-t.min.x)/i.x,l=(o-t.min.y)/i.y,n.push(a,l);r.setAttribute("uv",new Yi(n,2))}),ks=1e-5;function xF(r,e,t){const i=new yE,n=t-ks;return i.absarc(ks,ks,ks,-Math.PI/2,-Math.PI,!0),i.absarc(ks,e-n*2,ks,Math.PI,Math.PI/2,!0),i.absarc(r-n*2,e-n*2,ks,Math.PI/2,0,!0),i.absarc(r-n*2,ks,ks,0,-Math.PI/2,!0),i}const UN=g.forwardRef(function({args:[e=1,t=1,i=1]=[],radius:n=.05,steps:s=1,smoothness:o=4,bevelSegments:a=4,creaseAngle:l=.4,children:c,...u},h){const f=g.useMemo(()=>xF(e,t,n),[e,t,n]),d=g.useMemo(()=>({depth:i-n*2,bevelEnabled:!0,bevelSegments:a*2,steps:s,bevelSize:n-ks,bevelThickness:n,curveSegments:o}),[i,n,o]),m=g.useRef(null);return g.useLayoutEffect(()=>{m.current&&(m.current.center(),R3(m.current,l))},[f,d]),g.createElement("mesh",Ae({ref:h},u),g.createElement("extrudeGeometry",{ref:m,args:[f,d]}),c)});function IF(){const r=new Gi,e=new Float32Array([-1,-1,3,-1,-1,3]);return r.boundingSphere=new hn,r.boundingSphere.set(new Q,1/0),r.setAttribute("position",new Vt(e,2)),r}const NN=g.forwardRef(function({children:e,...t},i){const n=g.useMemo(IF,[]);return g.createElement("mesh",Ae({ref:i,geometry:n,frustumCulled:!1},t),e)}),GN=g.forwardRef(({children:r,width:e,height:t,depth:i,box3:n,precise:s=!0,...o},a)=>{const l=g.useRef(null),c=g.useRef(null),u=g.useRef(null);return g.useLayoutEffect(()=>{c.current.matrixWorld.identity();let h=n||new Jt().setFromObject(u.current,s);const f=h.max.x-h.min.x,d=h.max.y-h.min.y,m=h.max.z-h.min.z;let A=Math.max(f,d,m);e&&(A=f),t&&(A=d),i&&(A=m),c.current.scale.setScalar(1/A)},[e,t,i,n,s]),g.useImperativeHandle(a,()=>l.current,[]),g.createElement("group",Ae({ref:l},o),g.createElement("group",{ref:c},g.createElement("group",{ref:u},r)))});var jn=(function(r){return r[r.NONE=0]="NONE",r[r.START=1]="START",r[r.ACTIVE=2]="ACTIVE",r})(jn||{});const ta=r=>r&&r.isOrthographicCamera,CF=r=>r&&r.isBox3,_F=r=>1-Math.exp(-5*r)+.007*r,JC=g.createContext(null);function SF({children:r,maxDuration:e=1,margin:t=1.2,observe:i,fit:n,clip:s,interpolateFunc:o=_F,onFit:a}){const l=g.useRef(null),{camera:c,size:u,invalidate:h}=ae(),f=ae(I=>I.controls),d=g.useRef(a);d.current=a;const m=g.useRef({camPos:new Q,camRot:new st,camZoom:1}),A=g.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),p=g.useRef(jn.NONE),y=g.useRef(0),[v]=g.useState(()=>new Jt),E=g.useMemo(()=>{function I(){const C=v.getSize(new Q),_=v.getCenter(new Q),S=Math.max(C.x,C.y,C.z),b=ta(c)?S*4:S/(2*Math.atan(Math.PI*c.fov/360)),T=ta(c)?S*4:b/c.aspect,R=t*Math.max(b,T);return{box:v,size:C,center:_,distance:R}}return{getSize:I,refresh(C){if(CF(C))v.copy(C);else{const _=C||l.current;if(!_)return this;_.updateWorldMatrix(!0,!0),v.setFromObject(_)}if(v.isEmpty()){const _=c.position.length()||10;v.setFromCenterAndSize(new Q,new Q(_,_,_))}return m.current.camPos.copy(c.position),m.current.camRot.copy(c.quaternion),ta(c)&&(m.current.camZoom=c.zoom),A.current.camPos=void 0,A.current.camRot=void 0,A.current.camZoom=void 0,A.current.camUp=void 0,A.current.target=void 0,this},reset(){const{center:C,distance:_}=I(),S=c.position.clone().sub(C).normalize();A.current.camPos=C.clone().addScaledVector(S,_),A.current.target=C.clone();const b=new we().lookAt(A.current.camPos,A.current.target,c.up);return A.current.camRot=new st().setFromRotationMatrix(b),p.current=jn.START,y.current=0,this},moveTo(C){return A.current.camPos=Array.isArray(C)?new Q(...C):C.clone(),p.current=jn.START,y.current=0,this},lookAt({target:C,up:_}){A.current.target=Array.isArray(C)?new Q(...C):C.clone(),_?A.current.camUp=Array.isArray(_)?new Q(..._):_.clone():A.current.camUp=c.up.clone();const S=new we().lookAt(A.current.camPos||c.position,A.current.target,A.current.camUp);return A.current.camRot=new st().setFromRotationMatrix(S),p.current=jn.START,y.current=0,this},to({position:C,target:_}){return this.moveTo(C).lookAt({target:_})},fit(){if(!ta(c))return this.reset();let C=0,_=0;const S=[new Q(v.min.x,v.min.y,v.min.z),new Q(v.min.x,v.max.y,v.min.z),new Q(v.min.x,v.min.y,v.max.z),new Q(v.min.x,v.max.y,v.max.z),new Q(v.max.x,v.max.y,v.max.z),new Q(v.max.x,v.max.y,v.min.z),new Q(v.max.x,v.min.y,v.max.z),new Q(v.max.x,v.min.y,v.min.z)],b=A.current.camPos||c.position,T=A.current.target||f?.target,R=A.current.camUp||c.up,w=T?new we().lookAt(b,T,R).setPosition(b).invert():c.matrixWorldInverse;for(const O of S)O.applyMatrix4(w),C=Math.max(C,Math.abs(O.y)),_=Math.max(_,Math.abs(O.x));C*=2,_*=2;const B=(c.top-c.bottom)/C,M=(c.right-c.left)/_;return A.current.camZoom=Math.min(B,M)/t,p.current=jn.START,y.current=0,d.current&&d.current(this.getSize()),this},clip(){const{distance:C}=I();return c.near=C/100,c.far=C*100,c.updateProjectionMatrix(),f&&(f.maxDistance=C*10,f.update()),h(),this}}},[v,c,f,t,h]);g.useLayoutEffect(()=>{if(f){const I=()=>{if(f&&A.current.target&&p.current!==jn.NONE){const C=new Q().setFromMatrixColumn(c.matrix,2),_=m.current.camPos.distanceTo(f.target),S=(A.current.camPos||m.current.camPos).distanceTo(A.current.target),b=(1-y.current)*_+y.current*S;f.target.copy(c.position).addScaledVector(C,-b),f.update()}p.current=jn.NONE};return f.addEventListener("start",I),()=>f.removeEventListener("start",I)}},[f]);const x=g.useRef(0);return g.useLayoutEffect(()=>{(i||x.current++===0)&&(E.refresh(),n&&E.reset().fit(),s&&E.clip())},[u,s,n,i,c,f]),Ve((I,C)=>{if(p.current===jn.START)p.current=jn.ACTIVE,h();else if(p.current===jn.ACTIVE){if(y.current+=C/e,y.current>=1)A.current.camPos&&c.position.copy(A.current.camPos),A.current.camRot&&c.quaternion.copy(A.current.camRot),A.current.camUp&&c.up.copy(A.current.camUp),A.current.camZoom&&ta(c)&&(c.zoom=A.current.camZoom),c.updateMatrixWorld(),c.updateProjectionMatrix(),f&&A.current.target&&(f.target.copy(A.current.target),f.update()),p.current=jn.NONE;else{const _=o(y.current);A.current.camPos&&c.position.lerpVectors(m.current.camPos,A.current.camPos,_),A.current.camRot&&c.quaternion.slerpQuaternions(m.current.camRot,A.current.camRot,_),A.current.camUp&&c.up.set(0,1,0).applyQuaternion(c.quaternion),A.current.camZoom&&ta(c)&&(c.zoom=(1-_)*m.current.camZoom+_*A.current.camZoom),c.updateMatrixWorld(),c.updateProjectionMatrix()}h()}}),g.createElement("group",{ref:l},g.createElement(JC.Provider,{value:E},r))}function TF(){return g.useContext(JC)}const QN=g.forwardRef(({intensity:r=1,decay:e,decayRate:t=.65,maxYaw:i=.1,maxPitch:n=.1,maxRoll:s=.1,yawFrequency:o=.1,pitchFrequency:a=.1,rollFrequency:l=.1},c)=>{const u=ae(v=>v.camera),h=ae(v=>v.controls),f=g.useRef(r),d=g.useRef(u.rotation.clone()),[m]=g.useState(()=>new Jf),[A]=g.useState(()=>new Jf),[p]=g.useState(()=>new Jf),y=()=>{(f.current<0||f.current>1)&&(f.current=f.current<0?0:1)};return g.useImperativeHandle(c,()=>({getIntensity:()=>f.current,setIntensity:v=>{f.current=v,y()}}),[]),g.useEffect(()=>{if(h){const v=()=>void(d.current=u.rotation.clone());return h.addEventListener("change",v),v(),()=>void h.removeEventListener("change",v)}},[u,h]),Ve((v,E)=>{const x=Math.pow(f.current,2),I=i*x*m.noise(v.clock.elapsedTime*o,1),C=n*x*A.noise(v.clock.elapsedTime*a,1),_=s*x*p.noise(v.clock.elapsedTime*l,1);u.rotation.set(d.current.x+C,d.current.y+I,d.current.z+_),e&&f.current>0&&(f.current-=t*E,y())}),null}),zN=g.forwardRef(({children:r,enabled:e=!0,speed:t=1,rotationIntensity:i=1,floatIntensity:n=1,floatingRange:s=[-.1,.1],autoInvalidate:o=!1,...a},l)=>{const c=g.useRef(null);g.useImperativeHandle(l,()=>c.current,[]);const u=g.useRef(Math.random()*1e4);return Ve(h=>{var f,d;if(!e||t===0)return;o&&h.invalidate();const m=u.current+h.clock.elapsedTime;c.current.rotation.x=Math.cos(m/4*t)/8*i,c.current.rotation.y=Math.sin(m/4*t)/8*i,c.current.rotation.z=Math.sin(m/4*t)/20*i;let A=Math.sin(m/4*t)/10;A=tt.mapLinear(A,-.1,.1,(f=s?.[0])!==null&&f!==void 0?f:-.1,(d=s?.[1])!==null&&d!==void 0?d:.1),c.current.position.y=A*n,c.current.updateMatrix()}),g.createElement("group",a,g.createElement("group",{ref:c,matrixAutoUpdate:!1},r))}),ZC=(r,e,t)=>{let i;switch(r){case $i:i=new Uint8ClampedArray(e*t*4);break;case ui:i=new Uint16Array(e*t*4);break;case ho:i=new Uint32Array(e*t*4);break;case $0:i=new Int8Array(e*t*4);break;case wE:i=new Int16Array(e*t*4);break;case th:i=new Int32Array(e*t*4);break;case ri:i=new Float32Array(e*t*4);break;default:throw new Error("Unsupported data type")}return i};let Ku;const bF=(r,e,t,i)=>{if(Ku!==void 0)return Ku;const n=new xi(1,1,i);e.setRenderTarget(n);const s=new ze(new ln,new Cs({color:16777215}));e.render(s,t),e.setRenderTarget(null);const o=ZC(r,n.width,n.height);return e.readRenderTargetPixels(n,0,0,n.width,n.height,o),n.dispose(),s.geometry.dispose(),s.material.dispose(),Ku=o[0]!==0,Ku};class gp{constructor(e){var t,i,n,s,o,a,l,c,u,h,f,d,m,A,p,y;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(E){throw this._renderer.setRenderTarget(null),E}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;const v={format:Di,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:((t=e.renderTargetOptions)===null||t===void 0?void 0:t.anisotropy)!==void 0?(i=e.renderTargetOptions)===null||i===void 0?void 0:i.anisotropy:1,generateMipmaps:((n=e.renderTargetOptions)===null||n===void 0?void 0:n.generateMipmaps)!==void 0?(s=e.renderTargetOptions)===null||s===void 0?void 0:s.generateMipmaps:!1,magFilter:((o=e.renderTargetOptions)===null||o===void 0?void 0:o.magFilter)!==void 0?(a=e.renderTargetOptions)===null||a===void 0?void 0:a.magFilter:Nt,minFilter:((l=e.renderTargetOptions)===null||l===void 0?void 0:l.minFilter)!==void 0?(c=e.renderTargetOptions)===null||c===void 0?void 0:c.minFilter:Nt,samples:((u=e.renderTargetOptions)===null||u===void 0?void 0:u.samples)!==void 0?(h=e.renderTargetOptions)===null||h===void 0?void 0:h.samples:void 0,wrapS:((f=e.renderTargetOptions)===null||f===void 0?void 0:f.wrapS)!==void 0?(d=e.renderTargetOptions)===null||d===void 0?void 0:d.wrapS:On,wrapT:((m=e.renderTargetOptions)===null||m===void 0?void 0:m.wrapT)!==void 0?(A=e.renderTargetOptions)===null||A===void 0?void 0:A.wrapT:On};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=gp.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new Wr,this._camera=new Ai,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!bF(this._type,this._renderer,this._camera,v)){let E;switch(this._type){case ui:E=this._renderer.extensions.has("EXT_color_buffer_float")?ri:void 0;break}E!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${ri}`),this._type=E):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new ze(new ln,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new xi(this.width,this.height,v),this._renderTarget.texture.mapping=((p=e.renderTargetOptions)===null||p===void 0?void 0:p.mapping)!==void 0?(y=e.renderTargetOptions)===null||y===void 0?void 0:y.mapping:xh}static instantiateRenderer(){const e=new p_;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const e=ZC(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){const t=new Vr(this.toArray(),this.width,this.height,Di,this._type,e?.mapping||xh,e?.wrapS||On,e?.wrapT||On,e?.magFilter||Nt,e?.minFilter||Nt,e?.anisotropy||1,Y0);return t.generateMipmaps=e?.generateMipmaps!==void 0?e?.generateMipmaps:!1,t}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof Ii&&Object.values(this.material.uniforms).forEach(t=>{t.value instanceof tn&&t.value.dispose()}),Object.values(this.material).forEach(t=>{t instanceof tn&&t.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}const wF=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,BF=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class RF extends Ii{constructor({gamma:e,offsetHdr:t,offsetSdr:i,gainMapMin:n,gainMapMax:s,maxDisplayBoost:o,hdrCapacityMin:a,hdrCapacityMax:l,sdr:c,gainMap:u}){super({name:"GainMapDecoderMaterial",vertexShader:wF,fragmentShader:BF,uniforms:{sdr:{value:c},gainMap:{value:u},gamma:{value:new Q(1/e[0],1/e[1],1/e[2])},offsetHdr:{value:new Q().fromArray(t)},offsetSdr:{value:new Q().fromArray(i)},gainMapMin:{value:new Q().fromArray(n)},gainMapMax:{value:new Q().fromArray(s)},weightFactor:{value:(Math.log2(o)-a)/(l-a)}},blending:tA,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=o,this._hdrCapacityMin=a,this._hdrCapacityMax=l,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(e){this.uniforms.sdr.value=e}get gainMap(){return this.uniforms.gainMap.value}set gainMap(e){this.uniforms.gainMap.value=e}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(e){this.uniforms.offsetHdr.value.fromArray(e)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(e){this.uniforms.offsetSdr.value.fromArray(e)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(e){this.uniforms.gainMapMin.value.fromArray(e)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(e){this.uniforms.gainMapMax.value.fromArray(e)}get gamma(){const e=this.uniforms.gamma.value;return[1/e.x,1/e.y,1/e.z]}set gamma(e){const t=this.uniforms.gamma.value;t.x=1/e[0],t.y=1/e[1],t.z=1/e[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(e){this._hdrCapacityMin=e,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(e){this._hdrCapacityMax=e,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(e){this._maxDisplayBoost=Math.max(1,Math.min(65504,e)),this.calculateWeight()}calculateWeight(){const e=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,e))}}class e4 extends Error{}class t4 extends Error{}const Ml=(r,e,t)=>{const i=new RegExp(`${e}="([^"]*)"`,"i").exec(r);if(i)return i[1];const n=new RegExp(`<${e}[^>]*>([\\s\\S]*?)</${e}>`,"i").exec(r);if(n){const s=n[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return s&&s.length===3?s.map(o=>o.replace(/<\/?rdf:li>/g,"")):n[1].trim()}if(t!==void 0)return t;throw new Error(`Can't find ${e} in gainmap metadata`)},DF=r=>{let e;typeof TextDecoder<"u"?e=new TextDecoder().decode(r):e=r.toString();let t=e.indexOf("<x:xmpmeta");for(;t!==-1;){const i=e.indexOf("x:xmpmeta>",t),n=e.slice(t,i+10);try{const s=Ml(n,"hdrgm:GainMapMin","0"),o=Ml(n,"hdrgm:GainMapMax"),a=Ml(n,"hdrgm:Gamma","1"),l=Ml(n,"hdrgm:OffsetSDR","0.015625"),c=Ml(n,"hdrgm:OffsetHDR","0.015625"),u=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(n),h=u?u[1]:"0",f=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(n);if(!f)throw new Error("Incomplete gainmap metadata");const d=f[1];return{gainMapMin:Array.isArray(s)?s.map(m=>parseFloat(m)):[parseFloat(s),parseFloat(s),parseFloat(s)],gainMapMax:Array.isArray(o)?o.map(m=>parseFloat(m)):[parseFloat(o),parseFloat(o),parseFloat(o)],gamma:Array.isArray(a)?a.map(m=>parseFloat(m)):[parseFloat(a),parseFloat(a),parseFloat(a)],offsetSdr:Array.isArray(l)?l.map(m=>parseFloat(m)):[parseFloat(l),parseFloat(l),parseFloat(l)],offsetHdr:Array.isArray(c)?c.map(m=>parseFloat(m)):[parseFloat(c),parseFloat(c),parseFloat(c)],hdrCapacityMin:parseFloat(h),hdrCapacityMax:parseFloat(d)}}catch{}t=e.indexOf("<x:xmpmeta",i)}};class MF{constructor(e){this.options={debug:e&&e.debug!==void 0?e.debug:!1,extractFII:e&&e.extractFII!==void 0?e.extractFII:!0,extractNonFII:e&&e.extractNonFII!==void 0?e.extractNonFII:!0}}extract(e){return new Promise((t,i)=>{const n=this.options.debug,s=new DataView(e.buffer);if(s.getUint16(0)!==65496){i(new Error("Not a valid jpeg"));return}const o=s.byteLength;let a=2,l=0,c;for(;a<o;){if(++l>250){i(new Error(`Found no marker after ${l} loops `));return}if(s.getUint8(a)!==255){i(new Error(`Not a valid marker at offset 0x${a.toString(16)}, found: 0x${s.getUint8(a).toString(16)}`));return}if(c=s.getUint8(a+1),n&&console.log(`Marker: ${c.toString(16)}`),c===226){n&&console.log("Found APP2 marker (0xffe2)");const u=a+4;if(s.getUint32(u)===1297106432){const h=u+4;let f;if(s.getUint16(h)===18761)f=!1;else if(s.getUint16(h)===19789)f=!0;else{i(new Error("No valid endianness marker found in TIFF header"));return}if(s.getUint16(h+2,!f)!==42){i(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const d=s.getUint32(h+4,!f);if(d<8){i(new Error("Not valid TIFF data! (First offset less than 8)"));return}const m=h+d,A=s.getUint16(m,!f),p=m+2;let y=0;for(let I=p;I<p+12*A;I+=12)s.getUint16(I,!f)===45057&&(y=s.getUint32(I+8,!f));const E=m+2+A*12+4,x=[];for(let I=E;I<E+y*16;I+=16){const C={MPType:s.getUint32(I,!f),size:s.getUint32(I+4,!f),dataOffset:s.getUint32(I+8,!f),dependantImages:s.getUint32(I+12,!f),start:-1,end:-1,isFII:!1};C.dataOffset?(C.start=h+C.dataOffset,C.isFII=!1):(C.start=0,C.isFII=!0),C.end=C.start+C.size,x.push(C)}if(this.options.extractNonFII&&x.length){const I=new Blob([s]),C=[];for(const _ of x){if(_.isFII&&!this.options.extractFII)continue;const S=I.slice(_.start,_.end+1,"image/jpeg");C.push(S)}t(C)}}}a+=2+s.getUint16(a+2)}})}}const LF=async r=>{const e=DF(r);if(!e)throw new t4("Gain map XMP metadata not found");const i=await new MF({extractFII:!0,extractNonFII:!0}).extract(r);if(i.length!==2)throw new e4("Gain map recovery image not found");return{sdr:new Uint8Array(await i[0].arrayBuffer()),gainMap:new Uint8Array(await i[1].arrayBuffer()),metadata:e}},uv=r=>new Promise((e,t)=>{const i=document.createElement("img");i.onload=()=>{e(i)},i.onerror=n=>{t(n)},i.src=URL.createObjectURL(r)});class i4 extends Yr{constructor(e,t){super(t),e&&(this._renderer=e),this._internalLoadingManager=new g_}setRenderer(e){return this._renderer=e,this}setRenderTargetOptions(e){return this._renderTargetOptions=e,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: An existing WebGL Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const e=new RF({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new tn,sdr:new tn});return new gp({width:16,height:16,type:ui,colorSpace:Y0,material:e,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async render(e,t,i,n){const s=n?new Blob([n],{type:"image/jpeg"}):void 0,o=new Blob([i],{type:"image/jpeg"});let a,l,c=!1;if(typeof createImageBitmap>"u"){const f=await Promise.all([s?uv(s):Promise.resolve(void 0),uv(o)]);l=f[0],a=f[1],c=!0}else{const f=await Promise.all([s?createImageBitmap(s,{imageOrientation:"flipY"}):Promise.resolve(void 0),createImageBitmap(o,{imageOrientation:"flipY"})]);l=f[0],a=f[1]}const u=new tn(l||new ImageData(2,2),xh,On,On,Nt,Gp,Di,$i,1,Y0);u.flipY=c,u.needsUpdate=!0;const h=new tn(a,xh,On,On,Nt,Gp,Di,$i,1,TE);h.flipY=c,h.needsUpdate=!0,e.width=a.width,e.height=a.height,e.material.gainMap=u,e.material.sdr=h,e.material.gainMapMin=t.gainMapMin,e.material.gainMapMax=t.gainMapMax,e.material.offsetHdr=t.offsetHdr,e.material.offsetSdr=t.offsetSdr,e.material.gamma=t.gamma,e.material.hdrCapacityMin=t.hdrCapacityMin,e.material.hdrCapacityMax=t.hdrCapacityMax,e.material.maxDisplayBoost=Math.pow(2,t.hdrCapacityMax),e.material.needsUpdate=!0,e.render()}}class PF extends i4{load([e,t,i],n,s,o){const a=this.prepareQuadRenderer();let l,c,u;const h=async()=>{if(l&&c&&u){try{await this.render(a,u,l,c)}catch(b){this.manager.itemError(e),this.manager.itemError(t),this.manager.itemError(i),typeof o=="function"&&o(b),a.disposeOnDemandRenderer();return}typeof n=="function"&&n(a),this.manager.itemEnd(e),this.manager.itemEnd(t),this.manager.itemEnd(i),a.disposeOnDemandRenderer()}};let f=!0,d=0,m=0,A=!0,p=0,y=0,v=!0,E=0,x=0;const I=()=>{if(typeof s=="function"){const b=d+p+E,T=m+y+x,R=f&&A&&v;s(new ProgressEvent("progress",{lengthComputable:R,loaded:T,total:b}))}};this.manager.itemStart(e),this.manager.itemStart(t),this.manager.itemStart(i);const C=new Sn(this._internalLoadingManager);C.setResponseType("arraybuffer"),C.setRequestHeader(this.requestHeader),C.setPath(this.path),C.setWithCredentials(this.withCredentials),C.load(e,async b=>{if(typeof b=="string")throw new Error("Invalid sdr buffer");l=b,await h()},b=>{f=b.lengthComputable,m=b.loaded,d=b.total,I()},b=>{this.manager.itemError(e),typeof o=="function"&&o(b)});const _=new Sn(this._internalLoadingManager);_.setResponseType("arraybuffer"),_.setRequestHeader(this.requestHeader),_.setPath(this.path),_.setWithCredentials(this.withCredentials),_.load(t,async b=>{if(typeof b=="string")throw new Error("Invalid gainmap buffer");c=b,await h()},b=>{A=b.lengthComputable,y=b.loaded,p=b.total,I()},b=>{this.manager.itemError(t),typeof o=="function"&&o(b)});const S=new Sn(this._internalLoadingManager);return S.setRequestHeader(this.requestHeader),S.setPath(this.path),S.setWithCredentials(this.withCredentials),S.load(i,async b=>{if(typeof b!="string")throw new Error("Invalid metadata string");u=JSON.parse(b),await h()},b=>{v=b.lengthComputable,x=b.loaded,E=b.total,I()},b=>{this.manager.itemError(i),typeof o=="function"&&o(b)}),a}}class FF extends i4{load(e,t,i,n){const s=this.prepareQuadRenderer(),o=new Sn(this._internalLoadingManager);return o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setPath(this.path),o.setWithCredentials(this.withCredentials),this.manager.itemStart(e),o.load(e,async a=>{if(typeof a=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const l=new Uint8Array(a);let c,u,h;try{const f=await LF(l);c=f.sdr,u=f.gainMap,h=f.metadata}catch(f){if(f instanceof t4||f instanceof e4)console.warn(`Failure to reconstruct an HDR image from ${e}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),h={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},c=l;else throw f}try{await this.render(s,h,c,u)}catch(f){this.manager.itemError(e),typeof n=="function"&&n(f),s.disposeOnDemandRenderer();return}typeof t=="function"&&t(s),this.manager.itemEnd(e),s.disposeOnDemandRenderer()},i,a=>{this.manager.itemError(e),typeof n=="function"&&n(a)}),s}}const Ic={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},n4="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",ba=r=>Array.isArray(r),yp=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function Tf({files:r=yp,path:e="",preset:t=void 0,encoding:i=void 0,extensions:n}={}){let s=null,o=!1;t&&(vp(t),r=Ic[t],e=n4),o=ba(r);const{extension:a,isCubemap:l}=Ep(r);if(s=xp(a),!s)throw new Error("useEnvironment: Unrecognized file extension: "+r);const c=ae(d=>d.gl);g.useLayoutEffect(()=>{if(a!=="webp"&&a!=="jpg"&&a!=="jpeg")return;function d(){hi.clear(s,o?[r]:r)}c.domElement.addEventListener("webglcontextlost",d,{once:!0})},[r,c.domElement]);const u=hi(s,o?[r]:r,d=>{(a==="webp"||a==="jpg"||a==="jpeg")&&d.setRenderer(c),d.setPath==null||d.setPath(e),n&&n(d)});let h=o?u[0]:u;if(a==="jpg"||a==="jpeg"||a==="webp"){var f;h=(f=h.renderTarget)==null?void 0:f.texture}return h.mapping=l?pE:AE,"colorSpace"in h?h.colorSpace=i??l?"srgb":"srgb-linear":h.encoding=i??l?oF:rF,h}const kF={files:yp,path:"",preset:void 0,extensions:void 0};Tf.preload=r=>{const e={...kF,...r};let{files:t,path:i=""}=e;const{preset:n,extensions:s}=e;n&&(vp(n),t=Ic[n],i=n4);const{extension:o}=Ep(t);if(o==="webp"||o==="jpg"||o==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const a=xp(o);if(!a)throw new Error("useEnvironment: Unrecognized file extension: "+t);hi.preload(a,ba(t)?[t]:t,l=>{l.setPath==null||l.setPath(i),s&&s(l)})};const OF={files:yp,preset:void 0};Tf.clear=r=>{const e={...OF,...r};let{files:t}=e;const{preset:i}=e;i&&(vp(i),t=Ic[i]);const{extension:n}=Ep(t),s=xp(n);if(!s)throw new Error("useEnvironment: Unrecognized file extension: "+t);hi.clear(s,ba(t)?[t]:t)};function vp(r){if(!(r in Ic))throw new Error("Preset must be one of: "+Object.keys(Ic).join(", "))}function Ep(r){var e;const t=ba(r)&&r.length===6,i=ba(r)&&r.length===3&&r.some(o=>o.endsWith("json")),n=ba(r)?r[0]:r;return{extension:t?"cube":i?"webp":n.startsWith("data:application/exr")?"exr":n.startsWith("data:application/hdr")?"hdr":n.startsWith("data:image/jpeg")?"jpg":(e=n.split(".").pop())==null||(e=e.split("?"))==null||(e=e.shift())==null?void 0:e.toLowerCase(),isCubemap:t,isGainmap:i}}function xp(r){return r==="cube"?rA:r==="hdr"?x8:r==="exr"?I8:r==="jpg"||r==="jpeg"?FF:r==="webp"?PF:null}const UF=r=>r.current&&r.current.isScene,NF=r=>UF(r)?r.current:r;function Ip(r,e,t,i,n={}){var s,o,a,l;n={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...n};const c=NF(e||t),u=c.background,h=c.environment,f={backgroundBlurriness:c.backgroundBlurriness,backgroundIntensity:c.backgroundIntensity,backgroundRotation:(s=(o=c.backgroundRotation)==null||o.clone==null?void 0:o.clone())!==null&&s!==void 0?s:[0,0,0],environmentIntensity:c.environmentIntensity,environmentRotation:(a=(l=c.environmentRotation)==null||l.clone==null?void 0:l.clone())!==null&&a!==void 0?a:[0,0,0]};return r!=="only"&&(c.environment=i),r&&(c.background=i),Un(c,n),()=>{r!=="only"&&(c.environment=h),r&&(c.background=u),Un(c,f)}}function Cp({scene:r,background:e=!1,map:t,...i}){const n=ae(s=>s.scene);return g.useLayoutEffect(()=>{if(t)return Ip(e,r,n,t,i)}),null}function s4({background:r=!1,scene:e,blur:t,backgroundBlurriness:i,backgroundIntensity:n,backgroundRotation:s,environmentIntensity:o,environmentRotation:a,...l}){const c=Tf(l),u=ae(h=>h.scene);return g.useLayoutEffect(()=>Ip(r,e,u,c,{backgroundBlurriness:t??i,backgroundIntensity:n,backgroundRotation:s,environmentIntensity:o,environmentRotation:a})),g.useEffect(()=>()=>{c.dispose()},[c]),null}function GF({children:r,near:e=.1,far:t=1e3,resolution:i=256,frames:n=1,map:s,background:o=!1,blur:a,backgroundBlurriness:l,backgroundIntensity:c,backgroundRotation:u,environmentIntensity:h,environmentRotation:f,scene:d,files:m,path:A,preset:p=void 0,extensions:y}){const v=ae(S=>S.gl),E=ae(S=>S.scene),x=g.useRef(null),[I]=g.useState(()=>new Wr),C=g.useMemo(()=>{const S=new qh(i);return S.texture.type=ui,S},[i]);g.useEffect(()=>()=>{C.dispose()},[C]),g.useLayoutEffect(()=>{if(n===1){const S=v.autoClear;v.autoClear=!0,x.current.update(v,I),v.autoClear=S}return Ip(o,d,E,C.texture,{backgroundBlurriness:a??l,backgroundIntensity:c,backgroundRotation:u,environmentIntensity:h,environmentRotation:f})},[r,I,C.texture,d,E,o,n,v]);let _=1;return Ve(()=>{if(n===1/0||_<n){const S=v.autoClear;v.autoClear=!0,x.current.update(v,I),v.autoClear=S,_++}}),g.createElement(g.Fragment,null,vo(g.createElement(g.Fragment,null,r,g.createElement("cubeCamera",{ref:x,args:[e,t,C]}),m||p?g.createElement(s4,{background:!0,files:m,preset:p,path:A,extensions:y}):s?g.createElement(Cp,{background:!0,map:s,extensions:y}):null),I))}function QF(r){var e,t,i,n;const s=Tf(r),o=r.map||s;g.useMemo(()=>Ci({GroundProjectedEnvImpl:zb}),[]),g.useEffect(()=>()=>{s.dispose()},[s]);const a=g.useMemo(()=>[o],[o]),l=(e=r.ground)==null?void 0:e.height,c=(t=r.ground)==null?void 0:t.radius,u=(i=(n=r.ground)==null?void 0:n.scale)!==null&&i!==void 0?i:1e3;return g.createElement(g.Fragment,null,g.createElement(Cp,Ae({},r,{map:o})),g.createElement("groundProjectedEnvImpl",{args:a,scale:u,height:l,radius:c}))}function zF(r){return r.ground?g.createElement(QF,r):r.map?g.createElement(Cp,r):r.children?g.createElement(GF,r):g.createElement(s4,r)}const HF=g.forwardRef(({scale:r=10,frames:e=1/0,opacity:t=1,width:i=1,height:n=1,blur:s=1,near:o=0,far:a=10,resolution:l=512,smooth:c=!0,color:u="#000000",depthWrite:h=!1,renderOrder:f,...d},m)=>{const A=g.useRef(null),p=ae(M=>M.scene),y=ae(M=>M.gl),v=g.useRef(null);i=i*(Array.isArray(r)?r[0]:r||1),n=n*(Array.isArray(r)?r[1]:r||1);const[E,x,I,C,_,S,b]=g.useMemo(()=>{const M=new xi(l,l),O=new xi(l,l);O.texture.generateMipmaps=M.texture.generateMipmaps=!1;const U=new ln(i,n).rotateX(Math.PI/2),Y=new ze(U),W=new EE;W.depthTest=W.depthWrite=!1,W.onBeforeCompile=D=>{D.uniforms={...D.uniforms,ucolor:{value:new We(u)}},D.fragmentShader=D.fragmentShader.replace("void main() {",`uniform vec3 ucolor;
           void main() {
          `),D.fragmentShader=D.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const N=new Ii(_w),K=new Ii(Sw);return K.depthTest=N.depthTest=!1,[M,U,W,Y,N,K,O]},[l,i,n,r,u]),T=M=>{C.visible=!0,C.material=_,_.uniforms.tDiffuse.value=E.texture,_.uniforms.h.value=M*1/256,y.setRenderTarget(b),y.render(C,v.current),C.material=S,S.uniforms.tDiffuse.value=b.texture,S.uniforms.v.value=M*1/256,y.setRenderTarget(E),y.render(C,v.current),C.visible=!1};let R=0,w,B;return Ve(()=>{v.current&&(e===1/0||R<e)&&(R++,w=p.background,B=p.overrideMaterial,A.current.visible=!1,p.background=null,p.overrideMaterial=I,y.setRenderTarget(E),y.render(p,v.current),T(s),c&&T(s*.4),y.setRenderTarget(null),A.current.visible=!0,p.overrideMaterial=B,p.background=w)}),g.useImperativeHandle(m,()=>A.current,[]),g.createElement("group",Ae({"rotation-x":Math.PI/2},d,{ref:A}),g.createElement("mesh",{renderOrder:f,geometry:x,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},g.createElement("meshBasicMaterial",{transparent:!0,map:E.texture,opacity:t,depthWrite:h})),g.createElement("orthographicCamera",{ref:v,args:[-i/2,i/2,n/2,-n/2,o,a]}))});function VF(r){return r.isLight}function KF(r){return!!r.geometry}const r4=g.createContext(null),$F=ws({color:new We,blend:2,alphaTest:.75,opacity:0,map:null},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vUv = uv;
   }`,`varying vec2 vUv;
   uniform sampler2D map;
   uniform vec3 color;
   uniform float opacity;
   uniform float alphaTest;
   uniform float blend;
   void main() {
     vec4 sampledDiffuseColor = texture2D(map, vUv);
     gl_FragColor = vec4(color * sampledDiffuseColor.r * blend, max(0.0, (1.0 - (sampledDiffuseColor.r + sampledDiffuseColor.g + sampledDiffuseColor.b) / alphaTest)) * opacity);
     #include <tonemapping_fragment>
     #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),YF=g.forwardRef(({children:r,temporal:e,frames:t=40,limit:i=1/0,blend:n=20,scale:s=10,opacity:o=1,alphaTest:a=.75,color:l="black",colorBlend:c=2,resolution:u=1024,toneMapped:h=!0,...f},d)=>{Ci({SoftShadowMaterial:$F});const m=ae(C=>C.gl),A=ae(C=>C.scene),p=ae(C=>C.camera),y=ae(C=>C.invalidate),v=g.useRef(null),E=g.useRef(null),[x]=g.useState(()=>new jF(m,A,u));g.useLayoutEffect(()=>{x.configure(v.current)},[]);const I=g.useMemo(()=>({lights:new Map,temporal:!!e,frames:Math.max(2,t),blend:Math.max(2,t===1/0?n:t),count:0,getMesh:()=>v.current,reset:()=>{x.clear();const C=v.current.material;C.opacity=0,C.alphaTest=0,I.count=0},update:(C=1)=>{const _=v.current.material;I.temporal?(_.opacity=Math.min(o,_.opacity+o/I.blend),_.alphaTest=Math.min(a,_.alphaTest+a/I.blend)):(_.opacity=o,_.alphaTest=a),E.current.visible=!0,x.prepare();for(let S=0;S<C;S++)I.lights.forEach(b=>b.update()),x.update(p,I.blend);E.current.visible=!1,x.finish()}}),[x,p,A,e,t,n,o,a]);return g.useLayoutEffect(()=>{I.reset(),!I.temporal&&I.frames!==1/0&&I.update(I.blend)}),g.useImperativeHandle(d,()=>I,[I]),Ve(()=>{(I.temporal||I.frames===1/0)&&I.count<I.frames&&I.count<i&&(y(),I.update(),I.count++)}),g.createElement("group",f,g.createElement("group",{traverse:()=>null,ref:E},g.createElement(r4.Provider,{value:I},r)),g.createElement("mesh",{receiveShadow:!0,ref:v,scale:s,rotation:[-Math.PI/2,0,0]},g.createElement("planeGeometry",null),g.createElement("softShadowMaterial",{transparent:!0,depthWrite:!1,toneMapped:h,color:l,blend:c,map:x.progressiveLightMap2.texture})))}),WF=g.forwardRef(({castShadow:r=!0,bias:e=.001,mapSize:t=512,size:i=5,near:n=.5,far:s=500,frames:o=1,position:a=[0,0,0],radius:l=1,amount:c=8,intensity:u=sn>=155?Math.PI:1,ambient:h=.5,...f},d)=>{const m=g.useRef(null),A=new Q(...a).length(),p=g.useContext(r4),y=g.useCallback(()=>{let E;if(m.current)for(let x=0;x<m.current.children.length;x++)if(E=m.current.children[x],Math.random()>h)E.position.set(a[0]+tt.randFloatSpread(l),a[1]+tt.randFloatSpread(l),a[2]+tt.randFloatSpread(l));else{let I=Math.acos(2*Math.random()-1)-Math.PI/2,C=2*Math.PI*Math.random();E.position.set(Math.cos(I)*Math.cos(C)*A,Math.abs(Math.cos(I)*Math.sin(C)*A),Math.sin(I)*A)}},[l,h,A,...a]),v=g.useMemo(()=>({update:y}),[y]);return g.useImperativeHandle(d,()=>v,[v]),g.useLayoutEffect(()=>{var E;const x=m.current;return p&&((E=p.lights)==null||E.set(x.uuid,v)),()=>{var I;return void(p==null||(I=p.lights)==null?void 0:I.delete(x.uuid))}},[p,v]),g.createElement("group",Ae({ref:m},f),Array.from({length:c},(E,x)=>g.createElement("directionalLight",{key:x,castShadow:r,"shadow-bias":e,"shadow-mapSize":[t,t],intensity:u/c},g.createElement("orthographicCamera",{attach:"shadow-camera",args:[-i,i,i,-i,n,s]}))))});class jF{constructor(e,t,i=1024){this.renderer=e,this.res=i,this.scene=t,this.buffer1Active=!1,this.lights=[],this.meshes=[],this.object=null,this.clearColor=new We,this.clearAlpha=0;const n={type:ui,magFilter:ei,minFilter:ei};this.progressiveLightMap1=new xi(this.res,this.res,n),this.progressiveLightMap2=new xi(this.res,this.res,n),this.discardMat=new pp,this.targetMat=new nA({fog:!1}),this.previousShadowMap={value:this.progressiveLightMap1.texture},this.averagingWindow={value:100},this.targetMat.onBeforeCompile=s=>{s.vertexShader=`varying vec2 vUv;
`+s.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const o=s.fragmentShader.indexOf("void main() {");s.fragmentShader=`varying vec2 vUv;
`+s.fragmentShader.slice(0,o)+`uniform sampler2D previousShadowMap;
	uniform float averagingWindow;
`+s.fragmentShader.slice(o-1,-1)+`
vec3 texelOld = texture2D(previousShadowMap, vUv).rgb;
        gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);
      }`,s.uniforms.previousShadowMap=this.previousShadowMap,s.uniforms.averagingWindow=this.averagingWindow}}clear(){this.renderer.getClearColor(this.clearColor),this.clearAlpha=this.renderer.getClearAlpha(),this.renderer.setClearColor("black",1),this.renderer.setRenderTarget(this.progressiveLightMap1),this.renderer.clear(),this.renderer.setRenderTarget(this.progressiveLightMap2),this.renderer.clear(),this.renderer.setRenderTarget(null),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.lights=[],this.meshes=[],this.scene.traverse(e=>{KF(e)?this.meshes.push({object:e,material:e.material}):VF(e)&&this.lights.push({object:e,intensity:e.intensity})})}prepare(){this.lights.forEach(e=>e.object.intensity=0),this.meshes.forEach(e=>e.object.material=this.discardMat)}finish(){this.lights.forEach(e=>e.object.intensity=e.intensity),this.meshes.forEach(e=>e.object.material=e.material)}configure(e){this.object=e}update(e,t=100){if(!this.object)return;this.averagingWindow.value=t,this.object.material=this.targetMat;const i=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,n=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1,s=this.scene.background;this.scene.background=null,this.renderer.setRenderTarget(i),this.previousShadowMap.value=n.texture,this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.scene.background=s}}const qF={rembrandt:{main:[1,2,1],fill:[-2,-.5,-2]},portrait:{main:[-1,2,.5],fill:[-1,.5,-1.5]},upfront:{main:[0,2,1],fill:[-1,.5,-1.5]},soft:{main:[-2,4,4],fill:[-1,.5,-1.5]}};function XF({radius:r,adjustCamera:e}){const t=TF();return g.useEffect(()=>{e&&t.refresh().clip().fit()},[r,e]),null}function HN({children:r,center:e,adjustCamera:t=!0,intensity:i=.5,shadows:n="contact",environment:s="city",preset:o="rembrandt",...a}){var l,c,u,h,f,d,m,A;const p=typeof o=="string"?qF[o]:o,[{radius:y,height:v},E]=g.useState({radius:0,width:0,height:0,depth:0}),x=(l=n?.bias)!==null&&l!==void 0?l:-1e-4,I=(c=n?.normalBias)!==null&&c!==void 0?c:0,C=(u=n?.size)!==null&&u!==void 0?u:1024,_=(h=n?.offset)!==null&&h!==void 0?h:0,S=n==="contact"||n?.type==="contact",b=n==="accumulative"||n?.type==="accumulative",T={...typeof n=="object"?n:{}},R=s?typeof s=="string"?{preset:s}:s:null,w=g.useCallback(B=>{const{width:M,height:O,depth:U,boundingSphere:Y}=B;E({radius:Y.radius,width:M,height:O,depth:U}),e!=null&&e.onCentered&&e.onCentered(B)},[]);return g.createElement(g.Fragment,null,g.createElement("ambientLight",{intensity:i/3}),g.createElement("spotLight",{penumbra:1,position:[p.main[0]*y,p.main[1]*y,p.main[2]*y],intensity:i*2,castShadow:!!n,"shadow-bias":x,"shadow-normalBias":I,"shadow-mapSize":C}),g.createElement("pointLight",{position:[p.fill[0]*y,p.fill[1]*y,p.fill[2]*y],intensity:i}),g.createElement(SF,Ae({fit:!!t,clip:!!t,margin:Number(t),observe:!0},a),g.createElement(XF,{radius:y,adjustCamera:t}),g.createElement(KC,Ae({},e,{position:[0,_/2,0],onCentered:w}),r)),g.createElement("group",{position:[0,-v/2-_/2,0]},S&&g.createElement(HF,Ae({scale:y*4,far:y,blur:2},T)),b&&g.createElement(YF,Ae({temporal:!0,frames:100,alphaTest:.9,toneMapped:!0,scale:y*4},T),g.createElement(WF,{amount:(f=T.amount)!==null&&f!==void 0?f:8,radius:(d=T.radius)!==null&&d!==void 0?d:y,ambient:(m=T.ambient)!==null&&m!==void 0?m:.5,intensity:(A=T.intensity)!==null&&A!==void 0?A:1,position:[p.main[0]*y,p.main[1]*y,p.main[2]*y],size:y*4,bias:-x,mapSize:C}))),s&&g.createElement(zF,R))}const JF=r=>r===0?0:Math.pow(2,10*r-10);function VN({children:r,floor:e=.25,segments:t=20,receiveShadow:i,...n}){const s=g.useRef(null);return g.useLayoutEffect(()=>{let o=0;const a=t/t/2,l=s.current.attributes.position;for(let c=0;c<t+1;c++)for(let u=0;u<t+1;u++)l.setXYZ(o++,c/t-a+(c===0?-e:0),u/t-a,JF(c/t));l.needsUpdate=!0,s.current.computeVertexNormals()},[t,e]),g.createElement("group",n,g.createElement("mesh",{receiveShadow:i,rotation:[-Math.PI/2,0,Math.PI/2]},g.createElement("planeGeometry",{ref:s,args:[1,1,t,t]}),r))}const KN=g.forwardRef(({fog:r=!1,renderOrder:e,depthWrite:t=!1,colorStop:i=0,color:n="black",opacity:s=.5,...o},a)=>{const l=g.useMemo(()=>{const c=document.createElement("canvas");c.width=128,c.height=128;const u=c.getContext("2d"),h=u.createRadialGradient(c.width/2,c.height/2,0,c.width/2,c.height/2,c.width/2);return h.addColorStop(i,new We(n).getStyle()),h.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=h,u.fillRect(0,0,c.width,c.height),c},[n,i]);return g.createElement("mesh",Ae({renderOrder:e,ref:a,"rotation-x":-Math.PI/2},o),g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,opacity:s,fog:r,depthWrite:t,side:bi},g.createElement("canvasTexture",{attach:"map",args:[l]})))});function hv(r=lc){const e={value:new we};return Object.assign(new E_({side:r}),{viewMatrix:e,onBeforeCompile:t=>{t.uniforms.viewMatrix=e,t.fragmentShader=`vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
           return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
         }
`+t.fragmentShader.replace("#include <normal_fragment_maps>",`#include <normal_fragment_maps>
           normal = inverseTransformDirection( normal, viewMatrix );
`)}})}const ZF=ws({causticsTexture:null,causticsTextureB:null,color:new We,lightProjMatrix:new we,lightViewMatrix:new we},`varying vec3 vWorldPosition;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vec4 worldPosition = modelMatrix * vec4(position, 1.);
     vWorldPosition = worldPosition.xyz;
   }`,`varying vec3 vWorldPosition;
  uniform vec3 color;
  uniform sampler2D causticsTexture;
  uniform sampler2D causticsTextureB;
  uniform mat4 lightProjMatrix;
  uniform mat4 lightViewMatrix;
   void main() {
    // Apply caustics
    vec4 lightSpacePos = lightProjMatrix * lightViewMatrix * vec4(vWorldPosition, 1.0);
    lightSpacePos.xyz /= lightSpacePos.w;
    lightSpacePos.xyz = lightSpacePos.xyz * 0.5 + 0.5;
    vec3 front = texture2D(causticsTexture, lightSpacePos.xy).rgb;
    vec3 back = texture2D(causticsTextureB, lightSpacePos.xy).rgb;
    gl_FragColor = vec4((front + back) * color, 1.0);
    #include <tonemapping_fragment>
    #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),ek=ws({cameraMatrixWorld:new we,cameraProjectionMatrixInv:new we,normalTexture:null,depthTexture:null,lightDir:new Q(0,1,0),lightPlaneNormal:new Q(0,1,0),lightPlaneConstant:0,near:.1,far:100,modelMatrix:new we,worldRadius:1/40,ior:1.1,bounces:0,resolution:1024,size:10,intensity:.5},`
  varying vec2 vUv;
  void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }`,`
  uniform mat4 cameraMatrixWorld;
  uniform mat4 cameraProjectionMatrixInv;
  uniform vec3 lightDir;
  uniform vec3 lightPlaneNormal;
  uniform float lightPlaneConstant;
  uniform float near;
  uniform float far;
  uniform float time;
  uniform float worldRadius;
  uniform float resolution;
  uniform float size;
  uniform float intensity;
  uniform float ior;
  precision highp isampler2D;
  precision highp usampler2D;
  uniform sampler2D normalTexture;
  uniform sampler2D depthTexture;
  uniform float bounces;
  varying vec2 vUv;
  vec3 WorldPosFromDepth(float depth, vec2 coord) {
    float z = depth * 2.0 - 1.0;
    vec4 clipSpacePosition = vec4(coord * 2.0 - 1.0, z, 1.0);
    vec4 viewSpacePosition = cameraProjectionMatrixInv * clipSpacePosition;
    // Perspective division
    viewSpacePosition /= viewSpacePosition.w;
    vec4 worldSpacePosition = cameraMatrixWorld * viewSpacePosition;
    return worldSpacePosition.xyz;
  }
  float sdPlane( vec3 p, vec3 n, float h ) {
    // n must be normalized
    return dot(p,n) + h;
  }
  float planeIntersect( vec3 ro, vec3 rd, vec4 p ) {
    return -(dot(ro,p.xyz)+p.w)/dot(rd,p.xyz);
  }
  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 pos, vec3 normal, float ior, out vec3 rayOrigin, out vec3 rayDirection) {
    rayOrigin = ro;
    rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = pos + rayDirection * 0.1;
    return rayDirection;
  }
  void main() {
    // Each sample consists of random offset in the x and y direction
    float caustic = 0.0;
    float causticTexelSize = (1.0 / resolution) * size * 2.0;
    float texelsNeeded = worldRadius / causticTexelSize;
    float sampleRadius = texelsNeeded / resolution;
    float sum = 0.0;
    if (texture2D(depthTexture, vUv).x == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec2 offset1 = vec2(-0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset2 = vec2(-0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset3 = vec2(0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset4 = vec2(0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 uv1 = vUv + offset1 * sampleRadius;
    vec2 uv2 = vUv + offset2 * sampleRadius;
    vec2 uv3 = vUv + offset3 * sampleRadius;
    vec2 uv4 = vUv + offset4 * sampleRadius;
    vec3 normal1 = texture2D(normalTexture, uv1, -10.0).rgb * 2.0 - 1.0;
    vec3 normal2 = texture2D(normalTexture, uv2, -10.0).rgb * 2.0 - 1.0;
    vec3 normal3 = texture2D(normalTexture, uv3, -10.0).rgb * 2.0 - 1.0;
    vec3 normal4 = texture2D(normalTexture, uv4, -10.0).rgb * 2.0 - 1.0;
    float depth1 = texture2D(depthTexture, uv1, -10.0).x;
    float depth2 = texture2D(depthTexture, uv2, -10.0).x;
    float depth3 = texture2D(depthTexture, uv3, -10.0).x;
    float depth4 = texture2D(depthTexture, uv4, -10.0).x;
    // Sanity check the depths
    if (depth1 == 1.0 || depth2 == 1.0 || depth3 == 1.0 || depth4 == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec3 pos1 = WorldPosFromDepth(depth1, uv1);
    vec3 pos2 = WorldPosFromDepth(depth2, uv2);
    vec3 pos3 = WorldPosFromDepth(depth3, uv3);
    vec3 pos4 = WorldPosFromDepth(depth4, uv4);
    vec3 originPos1 = WorldPosFromDepth(0.0, uv1);
    vec3 originPos2 = WorldPosFromDepth(0.0, uv2);
    vec3 originPos3 = WorldPosFromDepth(0.0, uv3);
    vec3 originPos4 = WorldPosFromDepth(0.0, uv4);
    vec3 endPos1, endPos2, endPos3, endPos4;
    vec3 endDir1, endDir2, endDir3, endDir4;
    totalInternalReflection(originPos1, lightDir, pos1, normal1, ior, endPos1, endDir1);
    totalInternalReflection(originPos2, lightDir, pos2, normal2, ior, endPos2, endDir2);
    totalInternalReflection(originPos3, lightDir, pos3, normal3, ior, endPos3, endDir3);
    totalInternalReflection(originPos4, lightDir, pos4, normal4, ior, endPos4, endDir4);
    float lightPosArea = length(cross(originPos2 - originPos1, originPos3 - originPos1)) + length(cross(originPos3 - originPos1, originPos4 - originPos1));
    float t1 = planeIntersect(endPos1, endDir1, vec4(lightPlaneNormal, lightPlaneConstant));
    float t2 = planeIntersect(endPos2, endDir2, vec4(lightPlaneNormal, lightPlaneConstant));
    float t3 = planeIntersect(endPos3, endDir3, vec4(lightPlaneNormal, lightPlaneConstant));
    float t4 = planeIntersect(endPos4, endDir4, vec4(lightPlaneNormal, lightPlaneConstant));
    vec3 finalPos1 = endPos1 + endDir1 * t1;
    vec3 finalPos2 = endPos2 + endDir2 * t2;
    vec3 finalPos3 = endPos3 + endDir3 * t3;
    vec3 finalPos4 = endPos4 + endDir4 * t4;
    float finalArea = length(cross(finalPos2 - finalPos1, finalPos3 - finalPos1)) + length(cross(finalPos3 - finalPos1, finalPos4 - finalPos1));
    caustic += intensity * (lightPosArea / finalArea);
    // Calculate the area of the triangle in light spaces
    gl_FragColor = vec4(vec3(max(caustic, 0.0)), 1.0);
  }`),fv={depth:!0,minFilter:Nt,magFilter:Nt,type:$i},dv={minFilter:Cc,magFilter:Nt,type:ri,generateMipmaps:!0},$N=g.forwardRef(({debug:r,children:e,frames:t=1,ior:i=1.1,color:n="white",causticsOnly:s=!1,backside:o=!1,backsideIOR:a=1.1,worldRadius:l=.3125,intensity:c=.05,resolution:u=2024,lightSource:h=[5,5,5],...f},d)=>{Ci({CausticsProjectionMaterial:ZF});const m=g.useRef(null),A=g.useRef(null),p=g.useRef(null),y=g.useRef(null),v=ae(G=>G.gl),E=RC(r&&A,y_),x=In(u,u,fv),I=In(u,u,fv),C=In(u,u,dv),_=In(u,u,dv),[S]=g.useState(()=>hv()),[b]=g.useState(()=>hv(Oa)),[T]=g.useState(()=>new ek),[R]=g.useState(()=>new fr(T));g.useLayoutEffect(()=>{m.current.updateWorldMatrix(!1,!0)});let w=0;const B=new Q,M=new mE,O=new we,U=new Xs,Y=new Q,W=new Q,N=new Jt,K=new Q,D=[],z=[],$=[],V=[],P=new Q;for(let G=0;G<8;G++)D.push(new Q),z.push(new Q),$.push(new Q),V.push(new Q);return Ve(()=>{if(t===1/0||w++<t){var G,F;Array.isArray(h)?Y.fromArray(h).normalize():Y.copy(m.current.worldToLocal(h.current.getWorldPosition(B)).normalize()),W.copy(Y).multiplyScalar(-1),(G=p.current.parent)==null||G.matrixWorld.identity(),N.setFromObject(p.current,!0),D[0].set(N.min.x,N.min.y,N.min.z),D[1].set(N.min.x,N.min.y,N.max.z),D[2].set(N.min.x,N.max.y,N.min.z),D[3].set(N.min.x,N.max.y,N.max.z),D[4].set(N.max.x,N.min.y,N.min.z),D[5].set(N.max.x,N.min.y,N.max.z),D[6].set(N.max.x,N.max.y,N.min.z),D[7].set(N.max.x,N.max.y,N.max.z);for(let J=0;J<8;J++)z[J].copy(D[J]);N.getCenter(K),D.map(J=>J.sub(K));const k=U.set(W,0);D.map((J,q)=>k.projectPoint(J,$[q]));const Z=$.reduce((J,q)=>J.add(q),B.set(0,0,0)).divideScalar($.length),ne=$.map(J=>J.distanceTo(Z)).reduce((J,q)=>Math.max(J,q)),X=D.map(J=>J.dot(Y)).reduce((J,q)=>Math.max(J,q));A.current.position.copy(P.copy(Y).multiplyScalar(X).add(K)),A.current.lookAt(p.current.localToWorld(K));const te=O.lookAt(A.current.position,K,B.set(0,1,0));A.current.left=-ne,A.current.right=ne,A.current.top=ne,A.current.bottom=-ne;const ye=B.set(0,ne,0).applyMatrix4(te),ve=(A.current.position.y+ye.y)/Y.y;A.current.near=.1,A.current.far=ve,A.current.updateProjectionMatrix(),A.current.updateMatrixWorld();const re=z.map((J,q)=>J.add(V[q].copy(Y).multiplyScalar(-J.y/Y.y))),se=re.reduce((J,q)=>J.add(q),B.set(0,0,0)).divideScalar(re.length),he=2*re.map(J=>Math.hypot(J.x-se.x,J.z-se.z)).reduce((J,q)=>Math.max(J,q));y.current.scale.setScalar(he),y.current.position.copy(se),r&&((F=E.current)==null||F.update()),b.viewMatrix.value=S.viewMatrix.value=A.current.matrixWorldInverse;const le=M.setFromProjectionMatrix(O.multiplyMatrices(A.current.projectionMatrix,A.current.matrixWorldInverse)).planes[4];T.cameraMatrixWorld=A.current.matrixWorld,T.cameraProjectionMatrixInv=A.current.projectionMatrixInverse,T.lightDir=W,T.lightPlaneNormal=le.normal,T.lightPlaneConstant=le.constant,T.near=A.current.near,T.far=A.current.far,T.resolution=u,T.size=ne,T.intensity=c,T.worldRadius=l,p.current.visible=!0,v.setRenderTarget(x),v.clear(),p.current.overrideMaterial=S,v.render(p.current,A.current),v.setRenderTarget(I),v.clear(),o&&(p.current.overrideMaterial=b,v.render(p.current,A.current)),p.current.overrideMaterial=null,T.ior=i,y.current.material.lightProjMatrix=A.current.projectionMatrix,y.current.material.lightViewMatrix=A.current.matrixWorldInverse,T.normalTexture=x.texture,T.depthTexture=x.depthTexture,v.setRenderTarget(C),v.clear(),R.render(v),T.ior=a,T.normalTexture=I.texture,T.depthTexture=I.depthTexture,v.setRenderTarget(_),v.clear(),o&&R.render(v),v.setRenderTarget(null),s&&(p.current.visible=!1)}}),g.useImperativeHandle(d,()=>m.current,[]),g.createElement("group",Ae({ref:m},f),g.createElement("scene",{ref:p},g.createElement("orthographicCamera",{ref:A,up:[0,1,0]}),e),g.createElement("mesh",{renderOrder:2,ref:y,"rotation-x":-Math.PI/2},g.createElement("planeGeometry",null),g.createElement("causticsProjectionMaterial",{transparent:!0,color:n,causticsTexture:C.texture,causticsTextureB:_.texture,blending:CE,blendSrc:IE,blendDst:v_,depthWrite:!1}),r&&g.createElement(QB,null,g.createElement("lineBasicMaterial",{color:"#ffff00",toneMapped:!1}))))}),YN=g.forwardRef(({mixBlur:r=0,mixStrength:e=.5,resolution:t=256,blur:i=[0,0],args:n=[1,1],minDepthThreshold:s=.9,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:l=.25,mirror:c=0,children:u,debug:h=0,distortion:f=1,mixContrast:d=1,distortionMap:m,...A},p)=>{Ci({MeshReflectorMaterial:XC}),g.useEffect(()=>{console.warn("Reflector has been deprecated and will be removed next major. Replace it with <MeshReflectorMaterial />!")},[]);const y=ae(({gl:$})=>$),v=ae(({camera:$})=>$),E=ae(({scene:$})=>$);i=Array.isArray(i)?i:[i,i];const x=i[0]+i[1]>0,I=g.useRef(null);g.useImperativeHandle(p,()=>I.current,[]);const[C]=g.useState(()=>new Xs),[_]=g.useState(()=>new Q),[S]=g.useState(()=>new Q),[b]=g.useState(()=>new Q),[T]=g.useState(()=>new we),[R]=g.useState(()=>new Q(0,0,-1)),[w]=g.useState(()=>new yi),[B]=g.useState(()=>new Q),[M]=g.useState(()=>new Q),[O]=g.useState(()=>new yi),[U]=g.useState(()=>new we),[Y]=g.useState(()=>new jt),W=g.useCallback(()=>{if(S.setFromMatrixPosition(I.current.matrixWorld),b.setFromMatrixPosition(v.matrixWorld),T.extractRotation(I.current.matrixWorld),_.set(0,0,1),_.applyMatrix4(T),B.subVectors(S,b),B.dot(_)>0)return;B.reflect(_).negate(),B.add(S),T.extractRotation(v.matrixWorld),R.set(0,0,-1),R.applyMatrix4(T),R.add(b),M.subVectors(S,R),M.reflect(_).negate(),M.add(S),Y.position.copy(B),Y.up.set(0,1,0),Y.up.applyMatrix4(T),Y.up.reflect(_),Y.lookAt(M),Y.far=v.far,Y.updateMatrixWorld(),Y.projectionMatrix.copy(v.projectionMatrix),U.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),U.multiply(Y.projectionMatrix),U.multiply(Y.matrixWorldInverse),U.multiply(I.current.matrixWorld),C.setFromNormalAndCoplanarPoint(_,S),C.applyMatrix4(Y.matrixWorldInverse),w.set(C.normal.x,C.normal.y,C.normal.z,C.constant);const $=Y.projectionMatrix;O.x=(Math.sign(w.x)+$.elements[8])/$.elements[0],O.y=(Math.sign(w.y)+$.elements[9])/$.elements[5],O.z=-1,O.w=(1+$.elements[10])/$.elements[14],w.multiplyScalar(2/w.dot(O)),$.elements[2]=w.x,$.elements[6]=w.y,$.elements[10]=w.z+1,$.elements[14]=w.w},[]),[N,K,D,z]=g.useMemo(()=>{const $={type:ui,minFilter:Nt,magFilter:Nt},V=new xi(t,t,$);V.depthBuffer=!0,V.depthTexture=new jh(t,t),V.depthTexture.format=oA,V.depthTexture.type=Xh;const P=new xi(t,t,$),G=new qC({gl:y,resolution:t,width:i[0],height:i[1],minDepthThreshold:s,maxDepthThreshold:o,depthScale:a,depthToBlurRatioBias:l}),F={mirror:c,textureMatrix:U,mixBlur:r,tDiffuse:V.texture,tDepth:V.depthTexture,tDiffuseBlur:P.texture,hasBlur:x,mixStrength:e,minDepthThreshold:s,maxDepthThreshold:o,depthScale:a,depthToBlurRatioBias:l,transparent:!0,debug:h,distortion:f,distortionMap:m,mixContrast:d,"defines-USE_BLUR":x?"":void 0,"defines-USE_DEPTH":a>0?"":void 0,"defines-USE_DISTORTION":m?"":void 0};return[V,P,G,F]},[y,i,U,t,c,x,r,e,s,o,a,l,h,f,m,d]);return Ve(()=>{if(!(I!=null&&I.current))return;I.current.visible=!1;const $=y.xr.enabled,V=y.shadowMap.autoUpdate;W(),y.xr.enabled=!1,y.shadowMap.autoUpdate=!1,y.setRenderTarget(N),y.state.buffers.depth.setMask(!0),y.autoClear||y.clear(),y.render(E,Y),x&&D.render(y,N,K),y.xr.enabled=$,y.shadowMap.autoUpdate=V,I.current.visible=!0,y.setRenderTarget(null)}),g.createElement("mesh",Ae({ref:I},A),g.createElement("planeGeometry",{args:n}),u?u("meshReflectorMaterial",z):g.createElement("meshReflectorMaterial",z))});class tk extends Ii{constructor(){super({uniforms:{depth:{value:null},opacity:{value:1},attenuation:{value:2.5},anglePower:{value:12},spotPosition:{value:new Q(0,0,0)},lightColor:{value:new We("white")},cameraNear:{value:0},cameraFar:{value:1},resolution:{value:new De(0,0)}},transparent:!0,depthWrite:!1,vertexShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;
        uniform vec3 spotPosition;
        uniform float attenuation;

        #include <common>
        #include <logdepthbuf_pars_vertex>

        void main() {
          // compute intensity
          vNormal = normalize(normalMatrix * normal);
          vec4 worldPosition = modelMatrix * vec4(position, 1);
          vec4 viewPosition = viewMatrix * worldPosition;
          vViewZ = viewPosition.z;

          vIntensity = 1.0 - saturate(distance(worldPosition.xyz, spotPosition) / attenuation);

          gl_Position = projectionMatrix * viewPosition;

          #include <logdepthbuf_vertex>
        }
      `,fragmentShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;

        uniform vec3 lightColor;
        uniform float anglePower;
        uniform sampler2D depth;
        uniform vec2 resolution;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float opacity;

        #include <packing>
        #include <logdepthbuf_pars_fragment>

        float readDepth(sampler2D depthSampler, vec2 uv) {
          float fragCoordZ = texture(depthSampler, uv).r;

          // https://github.com/mrdoob/three.js/issues/23072
          #ifdef USE_LOGDEPTHBUF
            float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));
          #else
            float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);
          #endif

          return viewZ;
        }

        void main() {
          #include <logdepthbuf_fragment>

          vec3 normal = vec3(vNormal.x, vNormal.y, abs(vNormal.z));
          float angleIntensity = pow(dot(normal, vec3(0, 0, 1)), anglePower);
          float intensity = vIntensity * angleIntensity;

          // fades when z is close to sampled depth, meaning the cone is intersecting existing geometry
          bool isSoft = resolution[0] > 0.0 && resolution[1] > 0.0;
          if (isSoft) {
            vec2 uv = gl_FragCoord.xy / resolution;
            intensity *= smoothstep(0.0, 1.0, vViewZ - readDepth(depth, uv));
          }

          gl_FragColor = vec4(lightColor, intensity * opacity);

          #include <tonemapping_fragment>
          #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}}var ik=`#define GLSLIFY 1
varying vec2 vUv;uniform sampler2D uShadowMap;uniform float uTime;void main(){vec3 color=texture2D(uShadowMap,vUv).xyz;gl_FragColor=vec4(color,1.);}`;const nk=r=>r?.isSpotLight;function sk({opacity:r=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:s=5,angle:o=.15,attenuation:a=5,anglePower:l=5}){const c=g.useRef(null),u=ae(p=>p.size),h=ae(p=>p.camera),f=ae(p=>p.viewport.dpr),[d]=g.useState(()=>new tk),[m]=g.useState(()=>new Q);e=e===void 0?.1:e,t=t===void 0?o*7:t,Ve(()=>{d.uniforms.spotPosition.value.copy(c.current.getWorldPosition(m)),c.current.lookAt(c.current.parent.target.getWorldPosition(m))});const A=g.useMemo(()=>{const p=new Wn(e,t,s,128,64,!0);return p.applyMatrix4(new we().makeTranslation(0,-s/2,0)),p.applyMatrix4(new we().makeRotationX(-Math.PI/2)),p},[s,e,t]);return g.createElement(g.Fragment,null,g.createElement("mesh",{ref:c,geometry:A,raycast:()=>null},g.createElement("primitive",{object:d,attach:"material","uniforms-opacity-value":r,"uniforms-lightColor-value":n,"uniforms-attenuation-value":a,"uniforms-anglePower-value":l,"uniforms-depth-value":i,"uniforms-cameraNear-value":h.near,"uniforms-cameraFar-value":h.far,"uniforms-resolution-value":i?[u.width*f,u.height*f]:[0,0]})))}function o4(r,e,t,i,n){const[[s,o]]=g.useState(()=>[new Q,new Q]);g.useLayoutEffect(()=>{if(nk(r.current))r.current.shadow.mapSize.set(t,i),r.current.shadow.needsUpdate=!0;else throw new Error("SpotlightShadow must be a child of a SpotLight")},[r,t,i]),Ve(()=>{if(!r.current)return;const a=r.current.position,l=r.current.target.position;o.copy(l).sub(a);var c=o.length();o.normalize().multiplyScalar(c*n),s.copy(a).add(o),e.current.position.copy(s),e.current.lookAt(r.current.target.position)})}function rk({distance:r=.4,alphaTest:e=.5,map:t,shader:i=ik,width:n=512,height:s=512,scale:o=1,children:a,...l}){const c=g.useRef(null),u=l.spotlightRef,h=l.debug;o4(u,c,n,s,r);const f=g.useMemo(()=>new xi(n,s,{format:Di,stencilBuffer:!1}),[n,s]),d=g.useRef({uShadowMap:{value:t},uTime:{value:0}});g.useEffect(()=>void(d.current.uShadowMap.value=t),[t]);const m=g.useMemo(()=>new fr(new Ii({uniforms:d.current,vertexShader:`
          varying vec2 vUv;

          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
          `,fragmentShader:i})),[i]);return g.useEffect(()=>()=>{m.material.dispose(),m.dispose()},[m]),g.useEffect(()=>()=>f.dispose(),[f]),Ve(({gl:A},p)=>{d.current.uTime.value+=p,A.setRenderTarget(f),m.render(A),A.setRenderTarget(null)}),g.createElement(g.Fragment,null,g.createElement("mesh",{ref:c,scale:o,castShadow:!0},g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,side:bi,alphaTest:e,alphaMap:f.texture,"alphaMap-wrapS":zn,"alphaMap-wrapT":zn,opacity:h?1:0},a)))}function ok({distance:r=.4,alphaTest:e=.5,map:t,width:i=512,height:n=512,scale:s,children:o,...a}){const l=g.useRef(null),c=a.spotlightRef,u=a.debug;return o4(c,l,i,n,r),g.createElement(g.Fragment,null,g.createElement("mesh",{ref:l,scale:s,castShadow:!0},g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,side:bi,alphaTest:e,alphaMap:t,"alphaMap-wrapS":zn,"alphaMap-wrapT":zn,opacity:u?1:0},o)))}function WN(r){return r.shader?g.createElement(rk,r):g.createElement(ok,r)}const jN=g.forwardRef(({opacity:r=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n="white",distance:s=5,angle:o=.15,attenuation:a=5,anglePower:l=5,volumetric:c=!0,debug:u=!1,children:h,...f},d)=>{const m=g.useRef(null);return g.useImperativeHandle(d,()=>m.current,[]),g.createElement("group",null,u&&m.current&&g.createElement("spotLightHelper",{args:[m.current]}),g.createElement("spotLight",Ae({ref:m,angle:o,color:n,distance:s,castShadow:!0},f),c&&g.createElement(sk,{debug:u,opacity:r,radiusTop:e,radiusBottom:t,depthBuffer:i,color:n,distance:s,angle:o,attenuation:a,anglePower:l})),h&&g.cloneElement(h,{spotlightRef:m,debug:u}))}),qN=g.forwardRef(({light:r,args:e,map:t,toneMapped:i=!1,color:n="white",form:s="rect",intensity:o=1,scale:a=1,target:l=[0,0,0],children:c,...u},h)=>{const f=g.useRef(null);return g.useImperativeHandle(h,()=>f.current,[]),g.useLayoutEffect(()=>{!c&&!u.material&&(Un(f.current.material,{color:n}),f.current.material.color.multiplyScalar(o))},[n,o,c,u.material]),g.useLayoutEffect(()=>{u.rotation||f.current.quaternion.identity(),l&&!u.rotation&&(typeof l=="boolean"?f.current.lookAt(0,0,0):f.current.lookAt(Array.isArray(l)?new Q(...l):l))},[l,u.rotation]),a=Array.isArray(a)&&a.length===2?[a[0],a[1],1]:a,g.createElement("mesh",Ae({ref:f,scale:a},u),s==="circle"?g.createElement("ringGeometry",{args:e||[0,.5,64]}):s==="ring"?g.createElement("ringGeometry",{args:e||[.25,.5,64]}):s==="rect"||s==="plane"?g.createElement("planeGeometry",{args:e||[1,1]}):s==="box"?g.createElement("boxGeometry",{args:e||[1,1,1]}):g.createElement(s,{args:e}),c||g.createElement("meshBasicMaterial",{toneMapped:i,map:t,side:bi}),r&&g.createElement("pointLight",Ae({castShadow:!0},r)))});function ak(r,e,t=new Q){const i=Math.PI*(r-.5),n=2*Math.PI*(e-.5);return t.x=Math.cos(n),t.y=Math.sin(i),t.z=Math.sin(n),t}const XN=g.forwardRef(({inclination:r=.6,azimuth:e=.1,distance:t=1e3,mieCoefficient:i=.005,mieDirectionalG:n=.8,rayleigh:s=.5,turbidity:o=10,sunPosition:a=ak(r,e),...l},c)=>{const u=g.useMemo(()=>new Q().setScalar(t),[t]),[h]=g.useState(()=>new Gb);return g.createElement("primitive",Ae({object:h,ref:c,"material-uniforms-mieCoefficient-value":i,"material-uniforms-mieDirectionalG-value":n,"material-uniforms-rayleigh-value":s,"material-uniforms-sunPosition-value":a,"material-uniforms-turbidity-value":o,scale:u},l))});class lk extends Ii{constructor(){super({uniforms:{time:{value:0},fade:{value:1}},vertexShader:`
      uniform float time;
      attribute float size;
      varying vec3 vColor;
      void main() {
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position, 0.5);
        gl_PointSize = size * (30.0 / -mvPosition.z) * (3.0 + sin(time + 100.0));
        gl_Position = projectionMatrix * mvPosition;
      }`,fragmentShader:`
      uniform sampler2D pointTexture;
      uniform float fade;
      varying vec3 vColor;
      void main() {
        float opacity = 1.0;
        if (fade == 1.0) {
          float d = distance(gl_PointCoord, vec2(0.5, 0.5));
          opacity = 1.0 / (1.0 + exp(16.0 * (d - 0.25)));
        }
        gl_FragColor = vec4(vColor, opacity);

        #include <tonemapping_fragment>
	      #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
      }`})}}const ck=r=>new Q().setFromSpherical(new wa(r,Math.acos(1-Math.random()*2),Math.random()*2*Math.PI)),JN=g.forwardRef(({radius:r=100,depth:e=50,count:t=5e3,saturation:i=0,factor:n=4,fade:s=!1,speed:o=1},a)=>{const l=g.useRef(),[c,u,h]=g.useMemo(()=>{const d=[],m=[],A=Array.from({length:t},()=>(.5+.5*Math.random())*n),p=new We;let y=r+e;const v=e/t;for(let E=0;E<t;E++)y-=v*Math.random(),d.push(...ck(y).toArray()),p.setHSL(E/t,i,.9),m.push(p.r,p.g,p.b);return[new Float32Array(d),new Float32Array(m),new Float32Array(A)]},[t,e,n,r,i]);Ve(d=>l.current&&(l.current.uniforms.time.value=d.clock.elapsedTime*o));const[f]=g.useState(()=>new lk);return g.createElement("points",{ref:a},g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",args:[c,3]}),g.createElement("bufferAttribute",{attach:"attributes-color",args:[u,3]}),g.createElement("bufferAttribute",{attach:"attributes-size",args:[h,1]})),g.createElement("primitive",{ref:l,object:f,attach:"material",blending:x_,"uniforms-fade-value":s,depthWrite:!1,transparent:!0,vertexColors:!0}))}),uk="https://rawcdn.githack.com/pmndrs/drei-assets/9225a9f1fbd449d9411125c2f419b843d0308c9f/cloud.png",mv=new we,$u=new Q,Yu=new st,Av=new Q,pv=new st,Ll=new Q,_p=g.createContext(null),hk=g.forwardRef(({children:r,material:e=nA,texture:t=uk,range:i,limit:n=200,frustumCulled:s,...o},a)=>{var l,c;const u=g.useMemo(()=>class extends e{constructor(){super();const S=parseInt(Kh.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=b=>{b.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+b.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),b.fragmentShader=`varying float vOpacity;
              `+b.fragmentShader.replace(`#include <${S}>`,`#include <${S}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}},[e]);Ci({CloudMaterial:u});const h=g.useRef(null),f=g.useRef([]),d=g.useMemo(()=>new Float32Array(Array.from({length:n},()=>1)),[n]),m=g.useMemo(()=>new Float32Array(Array.from({length:n},()=>[1,1,1]).flat()),[n]),A=Io(t);let p=0,y=0,v;const E=new st,x=new Q(0,0,1),I=new Q;Ve((S,b)=>{for(p=S.clock.elapsedTime,mv.copy(h.current.matrixWorld).invert(),S.camera.matrixWorld.decompose(Av,pv,Ll),y=0;y<f.current.length;y++)v=f.current[y],v.ref.current.matrixWorld.decompose($u,Yu,Ll),$u.add(I.copy(v.position).applyQuaternion(Yu).multiply(Ll)),Yu.copy(pv).multiply(E.setFromAxisAngle(x,v.rotation+=b*v.rotationFactor)),Ll.multiplyScalar(v.volume+(1+Math.sin(p*v.density*v.speed))/2*v.growth),v.matrix.compose($u,Yu,Ll).premultiply(mv),v.dist=$u.distanceTo(Av);for(f.current.sort((T,R)=>R.dist-T.dist),y=0;y<f.current.length;y++)v=f.current[y],d[y]=v.opacity*(v.dist<v.fade-1?v.dist/v.fade:1),h.current.setMatrixAt(y,v.matrix),h.current.setColorAt(y,v.color);h.current.geometry.attributes.cloudOpacity.needsUpdate=!0,h.current.instanceMatrix.needsUpdate=!0,h.current.instanceColor&&(h.current.instanceColor.needsUpdate=!0)}),g.useLayoutEffect(()=>{const S=Math.min(n,i!==void 0?i:n,f.current.length);h.current.count=S,rc(h.current.instanceMatrix,{offset:0,count:S*16}),h.current.instanceColor&&rc(h.current.instanceColor,{offset:0,count:S*3}),rc(h.current.geometry.attributes.cloudOpacity,{offset:0,count:S})});let C=[(l=A.image.width)!==null&&l!==void 0?l:1,(c=A.image.height)!==null&&c!==void 0?c:1];const _=Math.max(C[0],C[1]);return C=[C[0]/_,C[1]/_],g.createElement("group",Ae({ref:a},o),g.createElement(_p.Provider,{value:f},r,g.createElement("instancedMesh",{matrixAutoUpdate:!1,ref:h,args:[null,null,n],frustumCulled:s},g.createElement("instancedBufferAttribute",{usage:nn,attach:"instanceColor",args:[m,3]}),g.createElement("planeGeometry",{args:[...C]},g.createElement("instancedBufferAttribute",{usage:nn,attach:"attributes-cloudOpacity",args:[d,1]})),g.createElement("cloudMaterial",{key:e.name,map:A,transparent:!0,depthWrite:!1}))))}),gv=g.forwardRef(({opacity:r=1,speed:e=0,bounds:t=[5,1,1],segments:i=20,color:n="#ffffff",fade:s=10,volume:o=6,smallestVolume:a=.25,distribute:l=null,growth:c=4,concentrate:u="inside",seed:h=Math.random(),...f},d)=>{function m(){const E=Math.sin(h++)*1e4;return E-Math.floor(E)}const A=g.useContext(_p),p=g.useRef(null),y=g.useId(),v=g.useMemo(()=>[...new Array(i)].map((E,x)=>({segments:i,bounds:new Q(1,1,1),position:new Q,uuid:y,index:x,ref:p,dist:0,matrix:new we,color:new We,rotation:x*(Math.PI/i)})),[i,y]);return g.useLayoutEffect(()=>{v.forEach((E,x)=>{Un(E,{volume:o,color:n,speed:e,growth:c,opacity:r,fade:s,bounds:t,density:Math.max(.5,m()),rotationFactor:Math.max(.2,.5*m())*e});const I=l?.(E,x);if(I||i>1){var C;E.position.copy(E.bounds).multiply((C=I?.point)!==null&&C!==void 0?C:{x:m()*2-1,y:m()*2-1,z:m()*2-1})}const _=Math.abs(E.position.x),S=Math.abs(E.position.y),b=Math.abs(E.position.z),T=Math.max(_,S,b);E.length=1,_===T&&(E.length-=_/E.bounds.x),S===T&&(E.length-=S/E.bounds.y),b===T&&(E.length-=b/E.bounds.z),E.volume=(I?.volume!==void 0?I.volume:Math.max(Math.max(0,a),u==="random"?m():u==="inside"?E.length:1-E.length))*o})},[u,t,s,n,r,c,o,h,i,e]),g.useLayoutEffect(()=>{const E=v;return A.current=[...A.current,...E],()=>{A.current=A.current.filter(x=>x.uuid!==y)}},[v]),g.useImperativeHandle(d,()=>p.current,[]),g.createElement("group",Ae({ref:p},f))}),ZN=g.forwardRef((r,e)=>g.useContext(_p)?g.createElement(gv,Ae({ref:e},r)):g.createElement(hk,null,g.createElement(gv,Ae({ref:e},r))));class fk extends Ii{constructor(){super({uniforms:{time:{value:0},pixelRatio:{value:1}},vertexShader:`
        uniform float pixelRatio;
        uniform float time;
        attribute float size;  
        attribute float speed;  
        attribute float opacity;
        attribute vec3 noise;
        attribute vec3 color;
        varying vec3 vColor;
        varying float vOpacity;

        void main() {
          vec4 modelPosition = modelMatrix * vec4(position, 1.0);
          modelPosition.y += sin(time * speed + modelPosition.x * noise.x * 100.0) * 0.2;
          modelPosition.z += cos(time * speed + modelPosition.x * noise.y * 100.0) * 0.2;
          modelPosition.x += cos(time * speed + modelPosition.x * noise.z * 100.0) * 0.2;
          vec4 viewPosition = viewMatrix * modelPosition;
          vec4 projectionPostion = projectionMatrix * viewPosition;
          gl_Position = projectionPostion;
          gl_PointSize = size * 25. * pixelRatio;
          gl_PointSize *= (1.0 / - viewPosition.z);
          vColor = color;
          vOpacity = opacity;
        }
      `,fragmentShader:`
        varying vec3 vColor;
        varying float vOpacity;
        void main() {
          float distanceToCenter = distance(gl_PointCoord, vec2(0.5));
          float strength = 0.05 / distanceToCenter - 0.1;
          gl_FragColor = vec4(vColor, strength * vOpacity);
          #include <tonemapping_fragment>
          #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}get time(){return this.uniforms.time.value}set time(e){this.uniforms.time.value=e}get pixelRatio(){return this.uniforms.pixelRatio.value}set pixelRatio(e){this.uniforms.pixelRatio.value=e}}const a4=r=>r&&r.constructor===Float32Array,dk=r=>[r.r,r.g,r.b],l4=r=>r instanceof De||r instanceof Q||r instanceof yi,c4=r=>Array.isArray(r)?r:l4(r)?r.toArray():[r,r,r];function Pl(r,e,t){return g.useMemo(()=>{if(e!==void 0){if(a4(e))return e;if(e instanceof We){const i=Array.from({length:r*3},()=>dk(e)).flat();return Float32Array.from(i)}else if(l4(e)||Array.isArray(e)){const i=Array.from({length:r*3},()=>c4(e)).flat();return Float32Array.from(i)}return Float32Array.from({length:r},()=>e)}return Float32Array.from({length:r},t)},[e])}const eG=g.forwardRef(({noise:r=1,count:e=100,speed:t=1,opacity:i=1,scale:n=1,size:s,color:o,children:a,...l},c)=>{g.useMemo(()=>Ci({SparklesImplMaterial:fk}),[]);const u=g.useRef(null),h=ae(E=>E.viewport.dpr),f=c4(n),d=g.useMemo(()=>Float32Array.from(Array.from({length:e},()=>f.map(tt.randFloatSpread)).flat()),[e,...f]),m=Pl(e,s,Math.random),A=Pl(e,i),p=Pl(e,t),y=Pl(e*3,r),v=Pl(o===void 0?e*3:e,a4(o)?o:new We(o),()=>1);return Ve(E=>{u.current&&u.current.material&&(u.current.material.time=E.clock.elapsedTime)}),g.useImperativeHandle(c,()=>u.current,[]),g.createElement("points",Ae({key:`particle-${e}-${JSON.stringify(n)}`},l,{ref:u}),g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",args:[d,3]}),g.createElement("bufferAttribute",{attach:"attributes-size",args:[m,1]}),g.createElement("bufferAttribute",{attach:"attributes-opacity",args:[A,1]}),g.createElement("bufferAttribute",{attach:"attributes-speed",args:[p,1]}),g.createElement("bufferAttribute",{attach:"attributes-color",args:[v,3]}),g.createElement("bufferAttribute",{attach:"attributes-noise",args:[y,3]})),a||g.createElement("sparklesImplMaterial",{transparent:!0,pixelRatio:h,depthWrite:!1}))});function mk(r){switch(r){case 64:return"-64px";case 128:return"-128px";case 256:return"-256px";case 512:return"-512px";default:return""}}const Ak="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/matcaps.json",pk="https://rawcdn.githack.com/emmelleppi/matcaps/9b36ccaaf0a24881a39062d05566c9e92be4aa0d";function gk(r=0,e=1024,t){const i=Er(()=>fetch(Ak).then(u=>u.json()),["matcapList"]),n=i[0],s=g.useMemo(()=>Object.keys(i).length,[]),a=`${g.useMemo(()=>typeof r=="string"?r:typeof r=="number"?i[r]:null,[r])||n}${mk(e)}.png`,l=`${pk}/${e}/${a}`;return[Io(l,t),l,s]}const tG=({children:r,id:e,format:t,onLoad:i})=>{const n=gk(e,t,i);return g.createElement(g.Fragment,null,r?.(n))},yk="https://rawcdn.githack.com/pmndrs/drei-assets/7a3104997e1576f83472829815b00880d88b32fb",vk="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/normals/normals.json";function Ek(r=0,e={},t){const{repeat:i=[1,1],anisotropy:n=1,offset:s=[0,0]}=e,o=Er(()=>fetch(vk).then(f=>f.json()),["normalsList"]),a=g.useMemo(()=>Object.keys(o).length,[]),l=o[0],c=o[r]||l,u=`${yk}/normals/${c}`,h=Io(u,t);return g.useLayoutEffect(()=>{h&&(h.wrapS=h.wrapT=zn,h.repeat=new De(i[0],i[1]),h.offset=new De(s[0],s[1]),h.anisotropy=n)},[h,n,i,s]),[h,u,a]}const iG=({children:r,id:e,onLoad:t,...i})=>{const n=Ek(e,i,t);return g.createElement(g.Fragment,null,r?.(n))},Hr={uniforms:{strokeOpacity:1,fillOpacity:.25,fillMix:0,thickness:.05,colorBackfaces:!1,dashInvert:!0,dash:!1,dashRepeats:4,dashLength:.5,squeeze:!1,squeezeMin:.2,squeezeMax:1,stroke:new We("#ff0000"),backfaceStroke:new We("#0000ff"),fill:new We("#00ff00")},vertex:`
	  attribute vec3 barycentric;
	
		varying vec3 v_edges_Barycentric;
		varying vec3 v_edges_Position;

		void initWireframe() {
			v_edges_Barycentric = barycentric;
			v_edges_Position = position.xyz;
		}
	  `,fragment:`
		#ifndef PI
	  	#define PI 3.1415926535897932384626433832795
		#endif
  
	  varying vec3 v_edges_Barycentric;
	  varying vec3 v_edges_Position;
  
	  uniform float strokeOpacity;
	  uniform float fillOpacity;
	  uniform float fillMix;
	  uniform float thickness;
	  uniform bool colorBackfaces;
  
	  // Dash
	  uniform bool dashInvert;
	  uniform bool dash;
	  uniform bool dashOnly;
	  uniform float dashRepeats;
	  uniform float dashLength;
  
	  // Squeeze
	  uniform bool squeeze;
	  uniform float squeezeMin;
	  uniform float squeezeMax;
  
	  // Colors
	  uniform vec3 stroke;
	  uniform vec3 backfaceStroke;
	  uniform vec3 fill;
  
	  // This is like
	  float wireframe_aastep(float threshold, float dist) {
		  float afwidth = fwidth(dist) * 0.5;
		  return smoothstep(threshold - afwidth, threshold + afwidth, dist);
	  }
  
	  float wireframe_map(float value, float min1, float max1, float min2, float max2) {
		  return min2 + (value - min1) * (max2 - min2) / (max1 - min1);
	  }
  
	  float getWireframe() {
			vec3 barycentric = v_edges_Barycentric;
		
			// Distance from center of each triangle to its edges.
			float d = min(min(barycentric.x, barycentric.y), barycentric.z);

			// for dashed rendering, we can use this to get the 0 .. 1 value of the line length
			float positionAlong = max(barycentric.x, barycentric.y);
			if (barycentric.y < barycentric.x && barycentric.y < barycentric.z) {
				positionAlong = 1.0 - positionAlong;
			}

			// the thickness of the stroke
			float computedThickness = wireframe_map(thickness, 0.0, 1.0, 0.0, 0.34);

			// if we want to shrink the thickness toward the center of the line segment
			if (squeeze) {
				computedThickness *= mix(squeezeMin, squeezeMax, (1.0 - sin(positionAlong * PI)));
			}

			// Create dash pattern
			if (dash) {
				// here we offset the stroke position depending on whether it
				// should overlap or not
				float offset = 1.0 / dashRepeats * dashLength / 2.0;
				if (!dashInvert) {
					offset += 1.0 / dashRepeats / 2.0;
				}

				// if we should animate the dash or not
				// if (dashAnimate) {
				// 	offset += time * 0.22;
				// }

				// create the repeating dash pattern
				float pattern = fract((positionAlong + offset) * dashRepeats);
				computedThickness *= 1.0 - wireframe_aastep(dashLength, pattern);
			}

			// compute the anti-aliased stroke edge  
			float edge = 1.0 - wireframe_aastep(computedThickness, d);

			return edge;
	  }
	  `},xk=ws(Hr.uniforms,Hr.vertex+`
  	void main() {
		initWireframe();
		gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
	}
  `,Hr.fragment+`
  void main () {
		// Compute color

		float edge = getWireframe();
		vec4 colorStroke = vec4(stroke, edge);

		#ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		#endif
    
		vec4 colorFill = vec4(fill, fillOpacity);
		vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		gl_FragColor = outColor;
	}
  `);function Ik(r,e){r.onBeforeCompile=t=>{t.uniforms={...t.uniforms,...e},t.vertexShader=t.vertexShader.replace("void main() {",`
		  ${Hr.vertex}
		  void main() {
			initWireframe();
		`),t.fragmentShader=t.fragmentShader.replace("void main() {",`
		  ${Hr.fragment}
		  void main() {
		`),t.fragmentShader=t.fragmentShader.replace("#include <color_fragment>",`
		  #include <color_fragment>
			  float edge = getWireframe();
		  vec4 colorStroke = vec4(stroke, edge);
		  #ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		  #endif
		  vec4 colorFill = vec4(mix(diffuseColor.rgb, fill, fillMix), mix(diffuseColor.a, fillOpacity, fillMix));
		  vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		  diffuseColor.rgb = outColor.rgb;
		  diffuseColor.a *= outColor.a;
		`)},r.side=bi,r.transparent=!0}function Ck(r,e){g.useEffect(()=>{var t;return void(r.fillOpacity.value=(t=e.fillOpacity)!==null&&t!==void 0?t:r.fillOpacity.value)},[e.fillOpacity]),g.useEffect(()=>{var t;return void(r.fillMix.value=(t=e.fillMix)!==null&&t!==void 0?t:r.fillMix.value)},[e.fillMix]),g.useEffect(()=>{var t;return void(r.strokeOpacity.value=(t=e.strokeOpacity)!==null&&t!==void 0?t:r.strokeOpacity.value)},[e.strokeOpacity]),g.useEffect(()=>{var t;return void(r.thickness.value=(t=e.thickness)!==null&&t!==void 0?t:r.thickness.value)},[e.thickness]),g.useEffect(()=>void(r.colorBackfaces.value=!!e.colorBackfaces),[e.colorBackfaces]),g.useEffect(()=>void(r.dash.value=!!e.dash),[e.dash]),g.useEffect(()=>void(r.dashInvert.value=!!e.dashInvert),[e.dashInvert]),g.useEffect(()=>{var t;return void(r.dashRepeats.value=(t=e.dashRepeats)!==null&&t!==void 0?t:r.dashRepeats.value)},[e.dashRepeats]),g.useEffect(()=>{var t;return void(r.dashLength.value=(t=e.dashLength)!==null&&t!==void 0?t:r.dashLength.value)},[e.dashLength]),g.useEffect(()=>void(r.squeeze.value=!!e.squeeze),[e.squeeze]),g.useEffect(()=>{var t;return void(r.squeezeMin.value=(t=e.squeezeMin)!==null&&t!==void 0?t:r.squeezeMin.value)},[e.squeezeMin]),g.useEffect(()=>{var t;return void(r.squeezeMax.value=(t=e.squeezeMax)!==null&&t!==void 0?t:r.squeezeMax.value)},[e.squeezeMax]),g.useEffect(()=>void(r.stroke.value=e.stroke?new We(e.stroke):r.stroke.value),[e.stroke]),g.useEffect(()=>void(r.fill.value=e.fill?new We(e.fill):r.fill.value),[e.fill]),g.useEffect(()=>void(r.backfaceStroke.value=e.backfaceStroke?new We(e.backfaceStroke):r.backfaceStroke.value),[e.backfaceStroke])}function _k(r){return!!(r!=null&&r.geometry)}function Sk(r){return!!(r!=null&&r.isBufferGeometry)}function Tk(r){return!!(r!=null&&r.current)}function yv(r){return r?.current!==void 0}function vv(r){return r.type==="WireframeGeometry"}function bk(){const r={};for(const e in Hr.uniforms)r[e]={value:Hr.uniforms[e]};return r}function wk(r,e){const i=r.getAttribute("position").count,n=[];for(let s=0;s<i;s++){const o=s%2===0,a=e?1:0;o?n.push(0,0,1,0,1,0,1,0,a):n.push(0,1,0,0,0,1,1,0,a)}return new Vt(Float32Array.from(n),3)}function u4(r){const e=Tk(r)?r.current:r;if(Sk(e))return e;{if(vv(e))throw new Error("Wireframe: WireframeGeometry is not supported.");const t=e.parent;if(_k(t)){if(vv(t.geometry))throw new Error("Wireframe: WireframeGeometry is not supported.");return t.geometry}}}function h4(r,e){if(r.index){console.warn("Wireframe: Requires non-indexed geometry, converting to non-indexed geometry.");const i=r.toNonIndexed();r.copy(i),r.setIndex(null)}const t=wk(r,e);r.setAttribute("barycentric",t)}function Bk({geometry:r,simplify:e=!1,...t}){Ci({MeshWireframeMaterial:xk});const[i,n]=g.useState(null);g.useLayoutEffect(()=>{const o=u4(r);if(!o)throw new Error("Wireframe: geometry prop must be a BufferGeometry or a ref to a BufferGeometry.");h4(o,e),yv(r)&&n(o)},[e,r]);const s=yv(r)?i:r;return g.createElement(g.Fragment,null,s&&g.createElement("mesh",{geometry:s},g.createElement("meshWireframeMaterial",Ae({attach:"material",transparent:!0,side:bi,polygonOffset:!0,polygonOffsetFactor:-4},t,{extensions:{derivatives:!0,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1}}))))}function Rk({simplify:r=!1,...e}){const t=g.useRef(null),i=g.useMemo(()=>bk(),[Hr.uniforms]);return Ck(i,e),g.useLayoutEffect(()=>{const n=u4(t);if(!n)throw new Error("Wireframe: Must be a child of a Mesh, Line or Points object or specify a geometry prop.");const s=n.clone();return h4(n,r),()=>{n.copy(s),s.dispose()}},[r]),g.useLayoutEffect(()=>{const n=t.current.parent,s=n.material.clone();return Ik(n.material,i),()=>{n.material.dispose(),n.material=s}},[]),g.createElement("object3D",{ref:t})}function nG({geometry:r,...e}){return r?g.createElement(Bk,Ae({geometry:r},e)):g.createElement(Rk,e)}function sG({opacity:r,alphaMap:e}){const t=g.useRef(null),i=g.useRef(null),n=g.useRef({value:1}),s=g.useRef({value:null}),o=g.useRef({value:!1});return g.useLayoutEffect(()=>{t.current.onBeforeCompile=i.current.onBeforeCompile=a=>{const l=a.fragmentShader.indexOf("void main");let c="",u,h=l;for(;u!==`
`&&h<l+100;)u=a.fragmentShader.charAt(h),c+=u,h++;c=c.trim(),a.vertexShader=a.vertexShader.replace("void main() {",`
        varying vec2 custom_vUv;

        void main() {
          custom_vUv = uv;
          
        `),a.fragmentShader=a.fragmentShader.replace(c,`
          uniform float uShadowOpacity;
          uniform sampler2D uAlphaMap;
          uniform bool uHasAlphaMap;

          varying vec2 custom_vUv;
  
          float bayerDither2x2( vec2 v ) {
            return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );
          }
    
          float bayerDither4x4( vec2 v ) {
            vec2 P1 = mod( v, 2.0 );
            vec2 P2 = mod( floor( 0.5  * v ), 2.0 );
            return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );
          }
  
          void main() {
            float alpha = 
              uHasAlphaMap ? 
                uShadowOpacity * texture2D(uAlphaMap, custom_vUv).x
              : uShadowOpacity;

            if( ( bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) ) ) / 16.0 >= alpha ) discard;
            
          `),a.uniforms.uShadowOpacity=n.current,a.uniforms.uAlphaMap=s.current,a.uniforms.uHasAlphaMap=o.current}},[]),Ve(()=>{var a;const l=(a=t.current.__r3f)==null?void 0:a.parent;if(l){const c=l.material;c&&(n.current.value=r??c.opacity,e===!1?(s.current.value=null,o.current.value=!1):(s.current.value=e||c.alphaMap,o.current.value=!!s.current.value))}}),g.createElement(g.Fragment,null,g.createElement("meshDepthMaterial",{ref:t,attach:"customDepthMaterial",depthPacking:xE}),g.createElement("meshDistanceMaterial",{ref:i,attach:"customDistanceMaterial"}))}const Ev=new we,x0=new Ua,xv=new hn,Dk=new Q;class Mk extends mr{constructor(){super(),this.size=0,this.color=new We("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){var i,n;const s=this.instance.current;if(!s||!s.geometry)return;const o=s.userData.instances.indexOf(this.instanceKey);if(o===-1||o>s.geometry.drawRange.count)return;const a=(i=(n=e.params.Points)==null?void 0:n.threshold)!==null&&i!==void 0?i:1;if(xv.set(this.getWorldPosition(Dk),a),e.ray.intersectsSphere(xv)===!1)return;Ev.copy(s.matrixWorld).invert(),x0.copy(e.ray).applyMatrix4(Ev);const l=a/((this.scale.x+this.scale.y+this.scale.z)/3),c=l*l,u=x0.distanceSqToPoint(this.position);if(u<c){const h=new Q;x0.closestPointToPoint(this.position,h),h.applyMatrix4(this.matrixWorld);const f=e.ray.origin.distanceTo(h);if(f<e.near||f>e.far)return;t.push({distance:f,distanceToRay:Math.sqrt(u),point:h,index:o,face:null,object:this})}}}let ro,Fl;const f4=g.createContext(null),Iv=new we,Cv=new Q,Lk=g.forwardRef(({children:r,range:e,limit:t=1e3,...i},n)=>{const s=g.useRef(null);g.useImperativeHandle(n,()=>s.current,[]);const[o,a]=g.useState([]),[[l,c,u]]=g.useState(()=>[new Float32Array(t*3),Float32Array.from({length:t*3},()=>1),Float32Array.from({length:t},()=>1)]);g.useEffect(()=>{s.current.geometry.attributes.position.needsUpdate=!0}),Ve(()=>{for(s.current.updateMatrix(),s.current.updateMatrixWorld(),Iv.copy(s.current.matrixWorld).invert(),s.current.geometry.drawRange.count=Math.min(t,e!==void 0?e:t,o.length),ro=0;ro<o.length;ro++)Fl=o[ro].current,Fl.getWorldPosition(Cv).applyMatrix4(Iv),Cv.toArray(l,ro*3),s.current.geometry.attributes.position.needsUpdate=!0,Fl.matrixWorldNeedsUpdate=!0,Fl.color.toArray(c,ro*3),s.current.geometry.attributes.color.needsUpdate=!0,u.set([Fl.size],ro),s.current.geometry.attributes.size.needsUpdate=!0});const h=g.useMemo(()=>({getParent:()=>s,subscribe:f=>(a(d=>[...d,f]),()=>a(d=>d.filter(m=>m.current!==f.current)))}),[]);return g.createElement("points",Ae({userData:{instances:o},matrixAutoUpdate:!1,ref:s,raycast:()=>null},i),g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",count:l.length/3,array:l,itemSize:3,usage:nn}),g.createElement("bufferAttribute",{attach:"attributes-color",count:c.length/3,array:c,itemSize:3,usage:nn}),g.createElement("bufferAttribute",{attach:"attributes-size",count:u.length,array:u,itemSize:1,usage:nn})),g.createElement(f4.Provider,{value:h},r))}),rG=g.forwardRef(({children:r,...e},t)=>{g.useMemo(()=>Ci({PositionPoint:Mk}),[]);const i=g.useRef(null);g.useImperativeHandle(t,()=>i.current,[]);const{subscribe:n,getParent:s}=g.useContext(f4);return g.useLayoutEffect(()=>n(i),[]),g.createElement("positionPoint",Ae({instance:s(),instanceKey:i,ref:i},e),r)}),Pk=g.forwardRef(({children:r,positions:e,colors:t,sizes:i,stride:n=3,...s},o)=>{const a=g.useRef(null);return g.useImperativeHandle(o,()=>a.current,[]),Ve(()=>{const l=a.current.geometry.attributes;l.position.needsUpdate=!0,t&&(l.color.needsUpdate=!0),i&&(l.size.needsUpdate=!0)}),g.createElement("points",Ae({ref:a},s),g.createElement("bufferGeometry",null,g.createElement("bufferAttribute",{attach:"attributes-position",count:e.length/n,array:e,itemSize:n,usage:nn}),t&&g.createElement("bufferAttribute",{attach:"attributes-color",count:t.length/n,array:t,itemSize:3,usage:nn}),i&&g.createElement("bufferAttribute",{attach:"attributes-size",count:i.length/n,array:i,itemSize:1,usage:nn})),r)}),oG=g.forwardRef((r,e)=>r.positions instanceof Float32Array?g.createElement(Pk,Ae({},r,{ref:e})):g.createElement(Lk,Ae({},r,{ref:e}))),d4=g.createContext(null),aG=g.forwardRef((r,e)=>{g.useMemo(()=>Ci({SegmentObject:Fk}),[]);const{limit:t=1e3,lineWidth:i=1,children:n,...s}=r,[o,a]=g.useState([]),[l]=g.useState(()=>new px),[c]=g.useState(()=>new hf),[u]=g.useState(()=>new uf),[h]=g.useState(()=>new De(512,512)),[f]=g.useState(()=>Array(t*6).fill(0)),[d]=g.useState(()=>Array(t*6).fill(0)),m=g.useMemo(()=>({subscribe:A=>(a(p=>[...p,A]),()=>a(p=>p.filter(y=>y.current!==A.current)))}),[]);return Ve(()=>{for(let p=0;p<t;p++){var A;const y=(A=o[p])==null?void 0:A.current;y&&(f[p*6+0]=y.start.x,f[p*6+1]=y.start.y,f[p*6+2]=y.start.z,f[p*6+3]=y.end.x,f[p*6+4]=y.end.y,f[p*6+5]=y.end.z,d[p*6+0]=y.color.r,d[p*6+1]=y.color.g,d[p*6+2]=y.color.b,d[p*6+3]=y.color.r,d[p*6+4]=y.color.g,d[p*6+5]=y.color.b)}u.setColors(d),u.setPositions(f),l.computeLineDistances()}),g.createElement("primitive",{object:l,ref:e},g.createElement("primitive",{object:u,attach:"geometry"}),g.createElement("primitive",Ae({object:c,attach:"material",vertexColors:!0,resolution:h,linewidth:i},s)),g.createElement(d4.Provider,{value:m},n))});class Fk{constructor(){this.color=new We("white"),this.start=new Q(0,0,0),this.end=new Q(0,0,0)}}const _v=r=>r instanceof Q?r:new Q(...typeof r=="number"?[r,r,r]:r),lG=g.forwardRef(({color:r,start:e,end:t},i)=>{const n=g.useContext(d4);if(!n)throw"Segment must used inside Segments component.";const s=g.useRef(null);return g.useImperativeHandle(i,()=>s.current,[]),g.useLayoutEffect(()=>n.subscribe(s),[]),g.createElement("segmentObject",{ref:s,color:r,start:_v(e),end:_v(t)})}),cG=g.forwardRef(({children:r,hysteresis:e=0,distances:t,...i},n)=>{const s=g.useRef(null);return g.useImperativeHandle(n,()=>s.current,[]),g.useLayoutEffect(()=>{const{current:o}=s;o.levels.length=0,o.children.forEach((a,l)=>o.levels.push({object:a,hysteresis:e,distance:t[l]}))}),Ve(o=>{var a;return(a=s.current)==null?void 0:a.update(o.camera)}),g.createElement("lOD",Ae({ref:s},i),r)});function uG({all:r,scene:e,camera:t}){const i=ae(({gl:o})=>o),n=ae(({camera:o})=>o),s=ae(({scene:o})=>o);return g.useLayoutEffect(()=>{const o=[];r&&(e||s).traverse(c=>{c.visible===!1&&(o.push(c),c.visible=!0)}),i.compile(e||s,t||n);const a=new qh(128);new _E(.01,1e5,a).update(i,e||s),a.dispose(),o.forEach(c=>c.visible=!1)},[]),null}function hG(){const r=ae(e=>e.gl);return g.useEffect(()=>(r.shadowMap.autoUpdate=!1,r.shadowMap.needsUpdate=!0,()=>{r.shadowMap.autoUpdate=r.shadowMap.needsUpdate=!0}),[r.shadowMap]),null}const Sv=new we,Tv=new Ua,I0=new hn,C0=new Q;function fG(r,e){const t=this.geometry,i=this.material,n=this.matrixWorld;i!==void 0&&(t.boundingSphere===null&&t.computeBoundingSphere(),I0.copy(t.boundingSphere),I0.applyMatrix4(n),r.ray.intersectsSphere(I0)!==!1&&(Sv.copy(n).invert(),Tv.copy(r.ray).applyMatrix4(Sv),!(t.boundingBox!==null&&Tv.intersectBox(t.boundingBox,C0)===null)&&e.push({distance:C0.distanceTo(r.ray.origin),point:C0.clone(),object:this})))}function dG({pixelated:r}){const e=ae(o=>o.gl),t=ae(o=>o.internal.active),i=ae(o=>o.performance.current),n=ae(o=>o.viewport.initialDpr),s=ae(o=>o.setDpr);return g.useEffect(()=>{const o=e.domElement;return()=>{t&&s(n),r&&o&&(o.style.imageRendering="auto")}},[]),g.useEffect(()=>{s(i*n),r&&e.domElement&&(e.domElement.style.imageRendering=i===1?"auto":"pixelated")},[i]),null}function mG(){const r=ae(i=>i.get),e=ae(i=>i.setEvents),t=ae(i=>i.performance.current);return g.useEffect(()=>{const i=r().events.enabled;return()=>e({enabled:i})},[]),g.useEffect(()=>e({enabled:t===1}),[t]),null}const m4=g.createContext(null);function AG({iterations:r=10,ms:e=250,threshold:t=.75,step:i=.1,factor:n=.5,flipflops:s=1/0,bounds:o=f=>f>100?[60,100]:[40,60],onIncline:a,onDecline:l,onChange:c,onFallback:u,children:h}){const f=Math.pow(10,0),[d,m]=g.useState(()=>({fps:0,index:0,factor:n,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:p=>{const y=Symbol();return d.subscriptions.set(y,p.current),()=>void d.subscriptions.delete(y)}}));let A=0;return Ve(()=>{const{frames:p,averages:y}=d;if(!d.fallback&&y.length<r){p.push(performance.now());const v=p[p.length-1]-p[0];if(v>=e){if(d.fps=Math.round(p.length/v*1e3*f)/f,d.refreshrate=Math.max(d.refreshrate,d.fps),y[d.index++%r]=d.fps,y.length===r){const[E,x]=o(d.refreshrate),I=y.filter(_=>_>=x),C=y.filter(_=>_<E);I.length>r*t&&(d.factor=Math.min(1,d.factor+i),d.flipped++,a&&a(d),d.subscriptions.forEach(_=>_.onIncline&&_.onIncline(d))),C.length>r*t&&(d.factor=Math.max(0,d.factor-i),d.flipped++,l&&l(d),d.subscriptions.forEach(_=>_.onDecline&&_.onDecline(d))),A!==d.factor&&(A=d.factor,c&&c(d),d.subscriptions.forEach(_=>_.onChange&&_.onChange(d))),d.flipped>s&&!d.fallback&&(d.fallback=!0,u&&u(d),d.subscriptions.forEach(_=>_.onFallback&&_.onFallback(d))),d.averages=[]}d.frames=[]}}}),g.createElement(m4.Provider,{value:d},h)}function pG({onIncline:r,onDecline:e,onChange:t,onFallback:i}){const n=g.useContext(m4),s=g.useRef({onIncline:r,onDecline:e,onChange:t,onFallback:i});g.useLayoutEffect(()=>{s.current.onIncline=r,s.current.onDecline=e,s.current.onChange=t,s.current.onFallback=i},[r,e,t,i]),g.useLayoutEffect(()=>n.subscribe(s),[n])}const kk=g.forwardRef(({children:r,compute:e,width:t,height:i,samples:n=8,renderPriority:s=0,eventPriority:o=0,frames:a=1/0,stencilBuffer:l=!1,depthBuffer:c=!0,generateMipmaps:u=!1,...h},f)=>{const{size:d,viewport:m}=ae(),A=In((t||d.width)*m.dpr,(i||d.height)*m.dpr,{samples:n,stencilBuffer:l,depthBuffer:c,generateMipmaps:u}),[p]=g.useState(()=>new Wr),y=g.useCallback((v,E,x)=>{var I,C;let _=(I=A.texture)==null?void 0:I.__r3f.parent;for(;_&&!(_ instanceof gi);)_=_.__r3f.parent;if(!_)return!1;x.raycaster.camera||x.events.compute(v,x,(C=x.previousRoot)==null?void 0:C.getState());const[S]=x.raycaster.intersectObject(_);if(!S)return!1;const b=S.uv;if(!b)return!1;E.raycaster.setFromCamera(E.pointer.set(b.x*2-1,b.y*2-1),E.camera)},[]);return g.useImperativeHandle(f,()=>A.texture,[A]),g.createElement(g.Fragment,null,vo(g.createElement(Ok,{renderPriority:s,frames:a,fbo:A},r,g.createElement("group",{onPointerOver:()=>null})),p,{events:{compute:e||y,priority:o}}),g.createElement("primitive",Ae({object:A.texture},h)))});function Ok({frames:r,renderPriority:e,children:t,fbo:i}){let n=0,s,o,a,l;return Ve(c=>{(r===1/0||n<r)&&(s=c.gl.autoClear,o=c.gl.xr.enabled,a=c.gl.getRenderTarget(),l=c.gl.xr.isPresenting,c.gl.autoClear=!0,c.gl.xr.enabled=!1,c.gl.xr.isPresenting=!1,c.gl.setRenderTarget(i),c.gl.render(c.scene,c.camera),c.gl.setRenderTarget(a),c.gl.autoClear=s,c.gl.xr.enabled=o,c.gl.xr.isPresenting=l,n++)},e),g.createElement(g.Fragment,null,t)}const Uk=g.forwardRef(({children:r,compute:e,renderPriority:t=-1,eventPriority:i=0,frames:n=1/0,stencilBuffer:s=!1,depthBuffer:o=!0,generateMipmaps:a=!1,resolution:l=896,near:c=.1,far:u=1e3,flip:h=!1,position:f,rotation:d,scale:m,quaternion:A,matrix:p,matrixAutoUpdate:y,...v},E)=>{const{size:x,viewport:I}=ae(),C=g.useRef(null),_=g.useMemo(()=>{const b=new qh(Math.max((l||x.width)*I.dpr,(l||x.height)*I.dpr),{stencilBuffer:s,depthBuffer:o,generateMipmaps:a});return b.texture.isRenderTargetTexture=!h,b.texture.flipY=!0,b.texture.type=ui,b},[l,h]);g.useEffect(()=>()=>_.dispose(),[_]);const[S]=g.useState(()=>new Wr);return g.useImperativeHandle(E,()=>({scene:S,fbo:_,camera:C.current}),[_]),g.createElement(g.Fragment,null,vo(g.createElement(Nk,{renderPriority:t,frames:n,camera:C},r,g.createElement("group",{onPointerOver:()=>null})),S,{events:{compute:e,priority:i}}),g.createElement("primitive",Ae({object:_.texture},v)),g.createElement("cubeCamera",{ref:C,args:[c,u,_],position:f,rotation:d,scale:m,quaternion:A,matrix:p,matrixAutoUpdate:y}))});function Nk({frames:r,renderPriority:e,children:t,camera:i}){let n=0;return Ve(s=>{(r===1/0||n<r)&&(i.current.update(s.gl,s.scene),n++)},e),g.createElement(g.Fragment,null,t)}const gG=g.forwardRef(({id:r=1,colorWrite:e=!1,depthWrite:t=!1,...i},n)=>{const s=g.useRef(null),o=g.useMemo(()=>({colorWrite:e,depthWrite:t,stencilWrite:!0,stencilRef:r,stencilFunc:I_,stencilFail:Gf,stencilZFail:Gf,stencilZPass:Gf}),[r,e,t]);return g.useLayoutEffect(()=>{Object.assign(s.current.material,o)}),g.useImperativeHandle(n,()=>s.current,[]),g.createElement("mesh",Ae({ref:s,renderOrder:-r},i))});function yG(r,e=!1){return{stencilWrite:!0,stencilRef:r,stencilFunc:e?C_:__,stencilFail:Qf,stencilZFail:Qf,stencilZPass:Qf}}function vG({renderPriority:r=1,zoom:e=0,segments:t=64,children:i,resolution:n=896,...s}){const o=g.useRef(null),a=g.useRef(null),{width:l,height:c}=ae(p=>p.size),[u]=g.useState(()=>new Ai);g.useLayoutEffect(()=>{u.position.set(0,0,100),u.zoom=100,u.left=l/-2,u.right=l/2,u.top=c/2,u.bottom=c/-2,u.updateProjectionMatrix()},[l,c]);const h=Math.sqrt(l*l+c*c)/100*(.5+e/2),f=new Q,d=new hn(new Q,h),m=new Fn,A=g.useCallback((p,y,v)=>{if(y.pointer.set(p.offsetX/y.size.width*2-1,-(p.offsetY/y.size.height)*2+1),y.raycaster.setFromCamera(y.pointer,u),y.raycaster.ray.intersectSphere(d,f))f.normalize();else return;m.getNormalMatrix(a.current.camera.matrixWorld),a.current.camera.getWorldPosition(y.raycaster.ray.origin),y.raycaster.ray.direction.set(0,0,1).reflect(f),y.raycaster.ray.direction.x*=-1,y.raycaster.ray.direction.applyNormalMatrix(m).multiplyScalar(-1)},[]);return Ve(p=>{r&&p.gl.render(o.current,u)},r),g.createElement(g.Fragment,null,g.createElement("mesh",Ae({ref:o},s,{scale:h}),g.createElement("sphereGeometry",{args:[1,t,t]}),g.createElement("meshBasicMaterial",null,g.createElement(Uk,{compute:A,attach:"envMap",flip:!0,resolution:n,ref:a},i,g.createElement(Gk,{api:a})))))}function Gk({api:r}){const e=new Q,t=new st,i=new Q,n=new kn(0,Math.PI,0);return Ve(s=>{s.camera.matrixWorld.decompose(e,t,i),r.current.camera.position.copy(e),r.current.camera.quaternion.setFromEuler(n).premultiply(t)}),null}const Qk=ws({blur:0,map:null,sdf:null,blend:0,size:0,resolution:new De},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
     vUv = uv;
   }`,`uniform sampler2D sdf;
   uniform sampler2D map;
   uniform float blur;
   uniform float size;
   uniform float time;
   uniform vec2 resolution;
   varying vec2 vUv;
   #include <packing>
   void main() {
     vec2 uv = gl_FragCoord.xy / resolution.xy;
     vec4 t = texture2D(map, uv);
     float k = blur;
     float d = texture2D(sdf, vUv).r/size;
     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));
     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);
     #include <tonemapping_fragment>
     #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),EG=g.forwardRef(({children:r,events:e=void 0,blur:t=0,eventPriority:i=0,renderPriority:n=0,worldUnits:s=!1,resolution:o=512,...a},l)=>{Ci({PortalMaterialImpl:Qk});const c=g.useRef(null),{scene:u,gl:h,size:f,viewport:d,setEvents:m}=ae(),A=In(o,o),[p,y]=g.useState(0);Ve(()=>{const C=c.current.blend>0?Math.max(1,n):0;p!==C&&y(C)}),g.useEffect(()=>{e!==void 0&&m({enabled:!e})},[e]);const[v,E]=g.useState(!0),x=jP(E);g.useLayoutEffect(()=>{var C;x.current=(C=c.current)==null?void 0:C.__r3f.parent},[]),g.useLayoutEffect(()=>{if(x.current&&t&&c.current.sdf===null){const C=new ze(x.current.geometry,new Cs),_=new Jt().setFromBufferAttribute(C.geometry.attributes.position),S=new Ai(_.min.x*(1+2/o),_.max.x*(1+2/o),_.max.y*(1+2/o),_.min.y*(1+2/o),.1,1e3);S.position.set(0,0,1),S.lookAt(0,0,0),h.setRenderTarget(A),h.render(C,S);const T=Hk(o,o,h)(A.texture),R=new Float32Array(o*o);h.readRenderTargetPixels(T,0,0,o,o,R);let w=1/0;for(let B=0;B<R.length;B++)R[B]<w&&(w=R[B]);w=-w,c.current.size=w,c.current.sdf=T.texture,h.setRenderTarget(null)}},[o,t]),g.useImperativeHandle(l,()=>c.current);const I=g.useCallback((C,_,S)=>{var b;if(!x.current)return!1;if(_.pointer.set(C.offsetX/_.size.width*2-1,-(C.offsetY/_.size.height)*2+1),_.raycaster.setFromCamera(_.pointer,_.camera),((b=c.current)==null?void 0:b.blend)===0){const[T]=_.raycaster.intersectObject(x.current);if(!T)return _.raycaster.camera=void 0,!1}},[]);return g.createElement("portalMaterialImpl",Ae({ref:c,blur:t,blend:0,resolution:[f.width*d.dpr,f.height*d.dpr],attach:"material"},a),g.createElement(kk,{attach:"map",frames:v?1/0:0,eventPriority:i,renderPriority:n,compute:I},r,g.createElement(zk,{events:e,rootScene:u,priority:p,material:c,worldUnits:s})))});function zk({events:r=void 0,rootScene:e,material:t,priority:i,worldUnits:n}){const s=ae(h=>h.scene),o=ae(h=>h.setEvents),a=In(),l=In();g.useLayoutEffect(()=>{s.matrixAutoUpdate=!1},[]),g.useEffect(()=>{r!==void 0&&o({enabled:r})},[r]);const[c,u]=g.useMemo(()=>{const h={value:0};return[new fr(new Ii({uniforms:{a:{value:a.texture},b:{value:l.texture},blend:h},vertexShader:`
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
          }`,fragmentShader:`
          uniform sampler2D a;
          uniform sampler2D b;
          uniform float blend;
          varying vec2 vUv;
          #include <packing>
          void main() {
            vec4 ta = texture2D(a, vUv);
            vec4 tb = texture2D(b, vUv);
            gl_FragColor = mix(tb, ta, blend);
            #include <tonemapping_fragment>
            #include <${sn>=154?"colorspace_fragment":"encodings_fragment"}>
          }`})),h]},[]);return Ve(h=>{var f;let d=t==null||(f=t.current)==null?void 0:f.__r3f.parent;if(d){if(n)s.matrixWorld.identity();else{var m;i&&((m=t.current)==null?void 0:m.blend)===1&&d.updateWorldMatrix(!0,!1),s.matrixWorld.copy(d.matrixWorld)}if(i){var A,p,y;((A=t.current)==null?void 0:A.blend)>0&&((p=t.current)==null?void 0:p.blend)<1?(u.value=t.current.blend,h.gl.setRenderTarget(a),h.gl.render(s,h.camera),h.gl.setRenderTarget(l),h.gl.render(e,h.camera),h.gl.setRenderTarget(null),c.render(h.gl)):((y=t.current)==null?void 0:y.blend)===1&&h.gl.render(s,h.camera)}}},i),g.createElement(g.Fragment,null)}const Hk=(r,e,t)=>{let i=new xi(r,e,{minFilter:Cc,magFilter:Nt,type:ri,format:Vs,generateMipmaps:!0}),n=new xi(r,e,{minFilter:ei,magFilter:ei}),s=new xi(r,e,{minFilter:ei,magFilter:ei}),o=new xi(r,e,{minFilter:ei,magFilter:ei}),a=new xi(r,e,{minFilter:ei,magFilter:ei}),l=new xi(r,e,{minFilter:ei,magFilter:ei,type:ri,format:Vs}),c=new xi(r,e,{minFilter:ei,magFilter:ei,type:ri,format:Vs});const u=new fr(new Ii({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (round(texture2D(tex, vUv).x)));
        }`})),h=new fr(new Ii({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (1.0 - round(texture2D(tex, vUv).x)));
        }`})),f=new fr(new Ii({uniforms:{tex:{value:null},offset:{value:0},level:{value:0},maxSteps:{value:0}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform float offset;
        uniform float level;
        uniform float maxSteps;
        #include <packing>
        void main() {
          float closestDist = 9999999.9;
          vec2 closestPos = vec2(0.0);
          for (float x = -1.0; x <= 1.0; x += 1.0) {
            for (float y = -1.0; y <= 1.0; y += 1.0) {
              vec2 voffset = vUv;
              voffset += vec2(x, y) * vec2(${1/r}, ${1/e}) * offset;
              vec2 pos = unpackRGBATo2Half(texture2D(tex, voffset));
              float dist = distance(pos.xy, vUv);
              if(pos.x != 0.0 && pos.y != 0.0 && dist < closestDist) {
                closestDist = dist;
                closestPos = pos;
              }
            }
          }
          gl_FragColor = pack2HalfToRGBA(closestPos);
        }`})),d=new fr(new Ii({uniforms:{tex:{value:null},size:{value:new De(r,e)}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform vec2 size;
        #include <packing>
        void main() {
          gl_FragColor = vec4(distance(size * unpackRGBATo2Half(texture2D(tex, vUv)), size * vUv), 0.0, 0.0, 0.0);
        }`})),m=new fr(new Ii({uniforms:{inside:{value:c.texture},outside:{value:l.texture},tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D inside;
        uniform sampler2D outside;
        uniform sampler2D tex;
        #include <packing>
        void main() {
          float i = texture2D(inside, vUv).x;
          float o =texture2D(outside, vUv).x;
          if (texture2D(tex, vUv).x == 0.0) {
            gl_FragColor = vec4(o, 0.0, 0.0, 0.0);
          } else {
            gl_FragColor = vec4(-i, 0.0, 0.0, 0.0);
          }
        }`}));return A=>{let p=i;A.minFilter=ei,A.magFilter=ei,u.material.uniforms.tex.value=A,t.setRenderTarget(n),u.render(t);const y=Math.ceil(Math.log(Math.max(r,e))/Math.log(2));let v=n,E=null;for(let x=0;x<y;x++){const I=Math.pow(2,y-x-1);E=v===n?o:n,f.material.uniforms.level.value=x,f.material.uniforms.maxSteps.value=y,f.material.uniforms.offset.value=I,f.material.uniforms.tex.value=v.texture,t.setRenderTarget(E),f.render(t),v=E}t.setRenderTarget(l),d.material.uniforms.tex.value=E.texture,d.render(t),h.material.uniforms.tex.value=A,t.setRenderTarget(s),h.render(t),v=s;for(let x=0;x<y;x++){const I=Math.pow(2,y-x-1);E=v===s?a:s,f.material.uniforms.level.value=x,f.material.uniforms.maxSteps.value=y,f.material.uniforms.offset.value=I,f.material.uniforms.tex.value=v.texture,t.setRenderTarget(E),f.render(t),v=E}return t.setRenderTarget(c),d.material.uniforms.tex.value=E.texture,d.render(t),t.setRenderTarget(p),m.material.uniforms.tex.value=A,m.render(t),t.setRenderTarget(null),p}},Vk={},bv=r=>{let e;const t=new Set,i=(u,h)=>{const f=typeof u=="function"?u(e):u;if(!Object.is(f,e)){const d=e;e=h??(typeof f!="object"||f===null)?f:Object.assign({},e,f),t.forEach(m=>m(e,d))}},n=()=>e,l={setState:i,getState:n,getInitialState:()=>c,subscribe:u=>(t.add(u),()=>t.delete(u)),destroy:()=>{(Vk?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},c=e=r(i,n,l);return l},Kk=r=>r?bv(r):bv;var _0={exports:{}},S0={};/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var wv;function $k(){if(wv)return S0;wv=1;var r=C4(),e=_4();function t(c,u){return c===u&&(c!==0||1/c===1/u)||c!==c&&u!==u}var i=typeof Object.is=="function"?Object.is:t,n=e.useSyncExternalStore,s=r.useRef,o=r.useEffect,a=r.useMemo,l=r.useDebugValue;return S0.useSyncExternalStoreWithSelector=function(c,u,h,f,d){var m=s(null);if(m.current===null){var A={hasValue:!1,value:null};m.current=A}else A=m.current;m=a(function(){function y(C){if(!v){if(v=!0,E=C,C=f(C),d!==void 0&&A.hasValue){var _=A.value;if(d(_,C))return x=_}return x=C}if(_=x,i(E,C))return _;var S=f(C);return d!==void 0&&d(_,S)?(E=C,_):(E=C,x=S)}var v=!1,E,x,I=h===void 0?null:h;return[function(){return y(u())},I===null?void 0:function(){return y(I())}]},[u,h,f,d]);var p=n(c,m[0],m[1]);return o(function(){A.hasValue=!0,A.value=p},[p]),l(p),p},S0}var Bv;function Yk(){return Bv||(Bv=1,_0.exports=$k()),_0.exports}var Wk=Yk();const jk=rE(Wk),A4={},{useDebugValue:qk}=ts,{useSyncExternalStoreWithSelector:Xk}=jk;let Rv=!1;const Jk=r=>r;function Zk(r,e=Jk,t){(A4?"production":void 0)!=="production"&&t&&!Rv&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Rv=!0);const i=Xk(r.subscribe,r.getState,r.getServerState||r.getInitialState,e,t);return qk(i),i}const Dv=r=>{(A4?"production":void 0)!=="production"&&typeof r!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const e=typeof r=="function"?Kk(r):r,t=(i,n)=>Zk(e,i,n);return Object.assign(t,e),t},eO=r=>r?Dv(r):Dv;var Mv,Lv;const Pv=typeof window<"u"&&((Mv=window.document)!=null&&Mv.createElement||((Lv=window.navigator)==null?void 0:Lv.product)==="ReactNative")?ts.useLayoutEffect:ts.useEffect;function tO(){const r=eO(e=>({current:new Array,version:0,set:e}));return{In:({children:e})=>{const t=r(n=>n.set),i=r(n=>n.version);return Pv(()=>{t(n=>({version:n.version+1}))},[]),Pv(()=>(t(({current:n})=>({current:[...n,e]})),()=>t(({current:n})=>({current:n.filter(s=>s!==e)}))),[e,i]),null},Out:()=>{const e=r(t=>t.current);return ts.createElement(ts.Fragment,null,e)}}}const iO=r=>r&&r.isOrthographicCamera,Fv=new We,p4=tO();function g4(r){return"top"in r}function T0(r,e){const{right:t,top:i,left:n,bottom:s,width:o,height:a}=e,l=e.bottom<0||i>r.height||t<0||e.left>r.width;if(g4(r)){const h=r.top+r.height-s,f=n-r.left;return{position:{width:o,height:a,left:f,top:i,bottom:h,right:t},isOffscreen:l}}const c=r.height-s;return{position:{width:o,height:a,top:i,left:n,bottom:c,right:t},isOffscreen:l}}function b0(r,{left:e,bottom:t,width:i,height:n}){let s;const o=i/n;return iO(r.camera)?r.camera.manual?r.camera.updateProjectionMatrix():(r.camera.left!==i/-2||r.camera.right!==i/2||r.camera.top!==n/2||r.camera.bottom!==n/-2)&&(Object.assign(r.camera,{left:i/-2,right:i/2,top:n/2,bottom:n/-2}),r.camera.updateProjectionMatrix()):r.camera.aspect!==o&&(r.camera.aspect=o,r.camera.updateProjectionMatrix()),s=r.gl.autoClear,r.gl.autoClear=!1,r.gl.setViewport(e,t,i,n),r.gl.setScissor(e,t,i,n),r.gl.setScissorTest(!0),s}function w0(r,e){r.gl.setScissorTest(!1),r.gl.autoClear=e}function kv(r){r.gl.getClearColor(Fv),r.gl.setClearColor(Fv,r.gl.getClearAlpha()),r.gl.clear(!0,!0)}function nO({visible:r=!0,canvasSize:e,scene:t,index:i,children:n,frames:s,rect:o,track:a}){const l=ae(),[c,u]=g.useState(!1);let h=0;return Ve(f=>{if(s===1/0||h<=s){var d;a&&(o.current=(d=a.current)==null?void 0:d.getBoundingClientRect()),h++}if(o.current){const{position:m,isOffscreen:A}=T0(e,o.current);if(c!==A&&u(A),r&&!c&&o.current){const p=b0(f,m);f.gl.render(n?f.scene:t,f.camera),w0(f,p)}}},i),g.useLayoutEffect(()=>{const f=o.current;if(f&&(!r||!c)){const{position:d}=T0(e,f),m=b0(l,d);kv(l),w0(l,m)}},[r,c]),g.useEffect(()=>{if(!a)return;const f=o.current,d=l.get().events.connected;return l.setEvents({connected:a.current}),()=>{if(f){const{position:m}=T0(e,f),A=b0(l,m);kv(l),w0(l,A)}l.setEvents({connected:d})}},[a]),g.useEffect(()=>{g4(e)||console.warn(`Detected @react-three/fiber canvas size does not include position information. <View /> may not work as expected. Upgrade to @react-three/fiber ^8.1.0 for support.
 See https://github.com/pmndrs/drei/issues/944`)},[]),g.createElement(g.Fragment,null,n,g.createElement("group",{onPointerOver:()=>null}))}const y4=g.forwardRef(({track:r,visible:e=!0,index:t=1,id:i,style:n,className:s,frames:o=1/0,children:a,...l},c)=>{var u,h,f,d;const m=g.useRef(null),{size:A,scene:p}=ae(),[y]=g.useState(()=>new Wr),[v,E]=g.useReducer(()=>!0,!1),x=g.useCallback((I,C)=>{if(m.current&&r&&r.current&&I.target===r.current){const{width:_,height:S,left:b,top:T}=m.current,R=I.clientX-b,w=I.clientY-T;C.pointer.set(R/_*2-1,-(w/S)*2+1),C.raycaster.setFromCamera(C.pointer,C.camera)}},[m,r]);return g.useEffect(()=>{var I;r&&(m.current=(I=r.current)==null?void 0:I.getBoundingClientRect()),E()},[r]),g.createElement("group",Ae({ref:c},l),v&&vo(g.createElement(nO,{visible:e,canvasSize:A,frames:o,scene:p,track:r,rect:m,index:t},a),y,{events:{compute:x,priority:t},size:{width:(u=m.current)==null?void 0:u.width,height:(h=m.current)==null?void 0:h.height,top:(f=m.current)==null?void 0:f.top,left:(d=m.current)==null?void 0:d.left}}))}),sO=g.forwardRef(({as:r="div",id:e,visible:t,className:i,style:n,index:s=1,track:o,frames:a=1/0,children:l,...c},u)=>{const h=g.useId(),f=g.useRef(null);return g.useImperativeHandle(u,()=>f.current),g.createElement(g.Fragment,null,g.createElement(r,Ae({ref:f,id:e,className:i,style:n},c)),g.createElement(p4.In,null,g.createElement(y4,{visible:t,key:h,track:f,frames:a,index:s},l)))}),xG=(()=>{const r=g.forwardRef((e,t)=>g.useContext(W0)?g.createElement(y4,Ae({ref:t},e)):g.createElement(sO,Ae({ref:t},e)));return r.Port=()=>g.createElement(p4.Out,null),r})(),Mc=g.createContext(null),Wu=new Q,Ov=new Q,rO=(r,e,t,i)=>{const n=e.dot(e),s=e.dot(r)-e.dot(t),o=e.dot(i);return o===0?-s/n:(Wu.copy(i).multiplyScalar(n/o).sub(e),Ov.copy(i).multiplyScalar(s/o).add(t).sub(r),-Wu.dot(Ov)/Wu.dot(Wu))},oO=new Q(0,1,0),Uv=new we,B0=({direction:r,axis:e})=>{const{translation:t,translationLimits:i,annotations:n,annotationsClass:s,depthTest:o,scale:a,lineWidth:l,fixed:c,axisColors:u,hoveredColor:h,opacity:f,onDragStart:d,onDrag:m,onDragEnd:A,userData:p}=g.useContext(Mc),y=ae(Y=>Y.controls),v=g.useRef(null),E=g.useRef(null),x=g.useRef(null),I=g.useRef(0),[C,_]=g.useState(!1),S=g.useCallback(Y=>{n&&(v.current.innerText=`${t.current[e].toFixed(2)}`,v.current.style.display="block"),Y.stopPropagation();const W=new we().extractRotation(E.current.matrixWorld),N=Y.point.clone(),K=new Q().setFromMatrixPosition(E.current.matrixWorld),D=r.clone().applyMatrix4(W).normalize();x.current={clickPoint:N,dir:D},I.current=t.current[e],d({component:"Arrow",axis:e,origin:K,directions:[D]}),y&&(y.enabled=!1),Y.target.setPointerCapture(Y.pointerId)},[n,r,y,d,t,e]),b=g.useCallback(Y=>{if(Y.stopPropagation(),C||_(!0),x.current){const{clickPoint:W,dir:N}=x.current,[K,D]=i?.[e]||[void 0,void 0];let z=rO(W,N,Y.ray.origin,Y.ray.direction);K!==void 0&&(z=Math.max(z,K-I.current)),D!==void 0&&(z=Math.min(z,D-I.current)),t.current[e]=I.current+z,n&&(v.current.innerText=`${t.current[e].toFixed(2)}`),Uv.makeTranslation(N.x*z,N.y*z,N.z*z),m(Uv)}},[n,m,C,t,i,e]),T=g.useCallback(Y=>{n&&(v.current.style.display="none"),Y.stopPropagation(),x.current=null,A(),y&&(y.enabled=!0),Y.target.releasePointerCapture(Y.pointerId)},[n,y,A]),R=g.useCallback(Y=>{Y.stopPropagation(),_(!1)},[]),{cylinderLength:w,coneWidth:B,coneLength:M,matrixL:O}=g.useMemo(()=>{const Y=c?l/a*1.6:a/20,W=c?.2:a/5,N=c?1-W:a-W,K=new st().setFromUnitVectors(oO,r.clone().normalize()),D=new we().makeRotationFromQuaternion(K);return{cylinderLength:N,coneWidth:Y,coneLength:W,matrixL:D}},[r,a,l,c]),U=C?h:u[e];return g.createElement("group",{ref:E},g.createElement("group",{matrix:O,matrixAutoUpdate:!1,onPointerDown:S,onPointerMove:b,onPointerUp:T,onPointerOut:R},n&&g.createElement(Zh,{position:[0,-M,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:v})),g.createElement("mesh",{visible:!1,position:[0,(w+M)/2,0],userData:p},g.createElement("cylinderGeometry",{args:[B*1.4,B*1.4,w+M,8,1]})),g.createElement(Ws,{transparent:!0,raycast:()=>null,depthTest:o,points:[0,0,0,0,w,0],lineWidth:l,side:bi,color:U,opacity:f,polygonOffset:!0,renderOrder:1,polygonOffsetFactor:-10,fog:!1}),g.createElement("mesh",{raycast:()=>null,position:[0,w+M/2,0],renderOrder:500},g.createElement("coneGeometry",{args:[B,M,24,1]}),g.createElement("meshBasicMaterial",{transparent:!0,depthTest:o,color:U,opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))))},R0=new Q,D0=new Q,M0=r=>r*180/Math.PI,aO=r=>r*Math.PI/180,lO=(r,e,t,i,n)=>{R0.copy(r).sub(t),D0.copy(e).sub(t);const s=i.dot(i),o=n.dot(n),a=R0.dot(i)/s,l=R0.dot(n)/o,c=D0.dot(i)/s,u=D0.dot(n)/o,h=Math.atan2(l,a);return Math.atan2(u,c)-h},cO=(r,e)=>{let t=Math.floor(r/e);return t=t<0?t+1:t,r-t*e},Nv=r=>{let e=cO(r,2*Math.PI);return Math.abs(e)<1e-6?0:(e<0&&(e+=2*Math.PI),e)},ju=new we,Gv=new Q,qu=new Ua,L0=new Q,P0=({dir1:r,dir2:e,axis:t})=>{const{rotationLimits:i,annotations:n,annotationsClass:s,depthTest:o,scale:a,lineWidth:l,fixed:c,axisColors:u,hoveredColor:h,opacity:f,onDragStart:d,onDrag:m,onDragEnd:A,userData:p}=g.useContext(Mc),y=ae(U=>U.controls),v=g.useRef(null),E=g.useRef(null),x=g.useRef(0),I=g.useRef(0),C=g.useRef(null),[_,S]=g.useState(!1),b=g.useCallback(U=>{n&&(v.current.innerText=`${M0(I.current).toFixed(0)}`,v.current.style.display="block"),U.stopPropagation();const Y=U.point.clone(),W=new Q().setFromMatrixPosition(E.current.matrixWorld),N=new Q().setFromMatrixColumn(E.current.matrixWorld,0).normalize(),K=new Q().setFromMatrixColumn(E.current.matrixWorld,1).normalize(),D=new Q().setFromMatrixColumn(E.current.matrixWorld,2).normalize(),z=new Xs().setFromNormalAndCoplanarPoint(D,W);C.current={clickPoint:Y,origin:W,e1:N,e2:K,normal:D,plane:z},d({component:"Rotator",axis:t,origin:W,directions:[N,K,D]}),y&&(y.enabled=!1),U.target.setPointerCapture(U.pointerId)},[n,y,d,t]),T=g.useCallback(U=>{if(U.stopPropagation(),_||S(!0),C.current){const{clickPoint:Y,origin:W,e1:N,e2:K,normal:D,plane:z}=C.current,[$,V]=i?.[t]||[void 0,void 0];qu.copy(U.ray),qu.intersectPlane(z,L0),qu.direction.negate(),qu.intersectPlane(z,L0);let P=lO(Y,L0,W,N,K),G=M0(P);U.shiftKey&&(G=Math.round(G/10)*10,P=aO(G)),$!==void 0&&V!==void 0&&V-$<2*Math.PI?(P=Nv(P),P=P>Math.PI?P-2*Math.PI:P,P=tt.clamp(P,$-x.current,V-x.current),I.current=x.current+P):(I.current=Nv(x.current+P),I.current=I.current>Math.PI?I.current-2*Math.PI:I.current),n&&(G=M0(I.current),v.current.innerText=`${G.toFixed(0)}`),ju.makeRotationAxis(D,P),Gv.copy(W).applyMatrix4(ju).sub(W).negate(),ju.setPosition(Gv),m(ju)}},[n,m,_,i,t]),R=g.useCallback(U=>{n&&(v.current.style.display="none"),U.stopPropagation(),x.current=I.current,C.current=null,A(),y&&(y.enabled=!0),U.target.releasePointerCapture(U.pointerId)},[n,y,A]),w=g.useCallback(U=>{U.stopPropagation(),S(!1)},[]),B=g.useMemo(()=>{const U=r.clone().normalize(),Y=e.clone().normalize();return new we().makeBasis(U,Y,U.clone().cross(Y))},[r,e]),M=c?.65:a*.65,O=g.useMemo(()=>{const Y=[];for(let W=0;W<=32;W++){const N=W*(Math.PI/2)/32;Y.push(new Q(Math.cos(N)*M,Math.sin(N)*M,0))}return Y},[M]);return g.createElement("group",{ref:E,onPointerDown:b,onPointerMove:T,onPointerUp:R,onPointerOut:w,matrix:B,matrixAutoUpdate:!1},n&&g.createElement(Zh,{position:[M,M,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:v})),g.createElement(Ws,{points:O,lineWidth:l*4,visible:!1,userData:p}),g.createElement(Ws,{transparent:!0,raycast:()=>null,depthTest:o,points:O,lineWidth:l,side:bi,color:_?h:u[t],opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))},uO=(r,e,t)=>{const i=Math.abs(r.x)>=Math.abs(r.y)&&Math.abs(r.x)>=Math.abs(r.z)?0:Math.abs(r.y)>=Math.abs(r.x)&&Math.abs(r.y)>=Math.abs(r.z)?1:2,n=[0,1,2].sort((m,A)=>Math.abs(e.getComponent(A))-Math.abs(e.getComponent(m))),s=i===n[0]?n[1]:n[0],o=r.getComponent(i),a=r.getComponent(s),l=e.getComponent(i),c=e.getComponent(s),u=t.getComponent(i),f=(t.getComponent(s)-u*(a/o))/(c-l*(a/o));return[(u-f*l)/o,f]},Xu=new Ua,Ju=new Q,Qv=new we,F0=({dir1:r,dir2:e,axis:t})=>{const{translation:i,translationLimits:n,annotations:s,annotationsClass:o,depthTest:a,scale:l,lineWidth:c,fixed:u,axisColors:h,hoveredColor:f,opacity:d,onDragStart:m,onDrag:A,onDragEnd:p,userData:y}=g.useContext(Mc),v=ae(N=>N.controls),E=g.useRef(null),x=g.useRef(null),I=g.useRef(null),C=g.useRef(0),_=g.useRef(0),[S,b]=g.useState(!1),T=g.useCallback(N=>{s&&(E.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`,E.current.style.display="block"),N.stopPropagation();const K=N.point.clone(),D=new Q().setFromMatrixPosition(x.current.matrixWorld),z=new Q().setFromMatrixColumn(x.current.matrixWorld,0).normalize(),$=new Q().setFromMatrixColumn(x.current.matrixWorld,1).normalize(),V=new Q().setFromMatrixColumn(x.current.matrixWorld,2).normalize(),P=new Xs().setFromNormalAndCoplanarPoint(V,D);I.current={clickPoint:K,e1:z,e2:$,plane:P},C.current=i.current[(t+1)%3],_.current=i.current[(t+2)%3],m({component:"Slider",axis:t,origin:D,directions:[z,$,V]}),v&&(v.enabled=!1),N.target.setPointerCapture(N.pointerId)},[s,v,m,t]),R=g.useCallback(N=>{if(N.stopPropagation(),S||b(!0),I.current){const{clickPoint:K,e1:D,e2:z,plane:$}=I.current,[V,P]=n?.[(t+1)%3]||[void 0,void 0],[G,F]=n?.[(t+2)%3]||[void 0,void 0];Xu.copy(N.ray),Xu.intersectPlane($,Ju),Xu.direction.negate(),Xu.intersectPlane($,Ju),Ju.sub(K);let[k,Z]=uO(D,z,Ju);V!==void 0&&(k=Math.max(k,V-C.current)),P!==void 0&&(k=Math.min(k,P-C.current)),G!==void 0&&(Z=Math.max(Z,G-_.current)),F!==void 0&&(Z=Math.min(Z,F-_.current)),i.current[(t+1)%3]=C.current+k,i.current[(t+2)%3]=_.current+Z,s&&(E.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`),Qv.makeTranslation(k*D.x+Z*z.x,k*D.y+Z*z.y,k*D.z+Z*z.z),A(Qv)}},[s,A,S,i,n,t]),w=g.useCallback(N=>{s&&(E.current.style.display="none"),N.stopPropagation(),I.current=null,p(),v&&(v.enabled=!0),N.target.releasePointerCapture(N.pointerId)},[s,v,p]),B=g.useCallback(N=>{N.stopPropagation(),b(!1)},[]),M=g.useMemo(()=>{const N=r.clone().normalize(),K=e.clone().normalize();return new we().makeBasis(N,K,N.clone().cross(K))},[r,e]),O=u?1/7:l/7,U=u?.225:l*.225,Y=S?f:h[t],W=g.useMemo(()=>[new Q(0,0,0),new Q(0,U,0),new Q(U,U,0),new Q(U,0,0),new Q(0,0,0)],[U]);return g.createElement("group",{ref:x,matrix:M,matrixAutoUpdate:!1},s&&g.createElement(Zh,{position:[0,0,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:o,ref:E})),g.createElement("group",{position:[O*1.7,O*1.7,0]},g.createElement("mesh",{visible:!0,onPointerDown:T,onPointerMove:R,onPointerUp:w,onPointerOut:B,scale:U,userData:y},g.createElement("planeGeometry",null),g.createElement("meshBasicMaterial",{transparent:!0,depthTest:a,color:Y,polygonOffset:!0,polygonOffsetFactor:-10,side:bi,fog:!1})),g.createElement(Ws,{position:[-U/2,-U/2,0],transparent:!0,depthTest:a,points:W,lineWidth:c,color:Y,opacity:d,polygonOffset:!0,polygonOffsetFactor:-10,userData:y,fog:!1})))},Kl=new Q,zv=new Q,hO=(r,e,t,i)=>{const n=e.dot(e),s=e.dot(r)-e.dot(t),o=e.dot(i);return o===0?-s/n:(Kl.copy(i).multiplyScalar(n/o).sub(e),zv.copy(i).multiplyScalar(s/o).add(t).sub(r),-Kl.dot(zv)/Kl.dot(Kl))},fO=new Q(0,1,0),kl=new Q,Hv=new we,k0=({direction:r,axis:e})=>{const{scaleLimits:t,annotations:i,annotationsClass:n,depthTest:s,scale:o,lineWidth:a,fixed:l,axisColors:c,hoveredColor:u,opacity:h,onDragStart:f,onDrag:d,onDragEnd:m,userData:A}=g.useContext(Mc),p=ae(W=>W.size),y=ae(W=>W.controls),v=g.useRef(null),E=g.useRef(null),x=g.useRef(null),I=g.useRef(1),C=g.useRef(1),_=g.useRef(null),[S,b]=g.useState(!1),T=l?1.2:1.2*o,R=g.useCallback(W=>{i&&(v.current.innerText=`${C.current.toFixed(2)}`,v.current.style.display="block"),W.stopPropagation();const N=new we().extractRotation(E.current.matrixWorld),K=W.point.clone(),D=new Q().setFromMatrixPosition(E.current.matrixWorld),z=r.clone().applyMatrix4(N).normalize(),$=E.current.matrixWorld.clone(),V=$.clone().invert(),P=l?1/MA(E.current.getWorldPosition(Kl),o,W.camera,p):1;_.current={clickPoint:K,dir:z,mPLG:$,mPLGInv:V,offsetMultiplier:P},f({component:"Sphere",axis:e,origin:D,directions:[z]}),y&&(y.enabled=!1),W.target.setPointerCapture(W.pointerId)},[i,y,r,f,e,l,o,p]),w=g.useCallback(W=>{if(W.stopPropagation(),S||b(!0),_.current){const{clickPoint:N,dir:K,mPLG:D,mPLGInv:z,offsetMultiplier:$}=_.current,[V,P]=t?.[e]||[1e-5,void 0],F=hO(N,K,W.ray.origin,W.ray.direction)*$,k=l?F:F/o;let Z=Math.pow(2,k*.2);W.shiftKey&&(Z=Math.round(Z*10)/10),Z=Math.max(Z,V/I.current),P!==void 0&&(Z=Math.min(Z,P/I.current)),C.current=I.current*Z,x.current.position.set(0,T+F,0),i&&(v.current.innerText=`${C.current.toFixed(2)}`),kl.set(1,1,1),kl.setComponent(e,Z),Hv.makeScale(kl.x,kl.y,kl.z).premultiply(D).multiply(z),d(Hv)}},[i,T,d,S,t,e]),B=g.useCallback(W=>{i&&(v.current.style.display="none"),W.stopPropagation(),I.current=C.current,_.current=null,x.current.position.set(0,T,0),m(),y&&(y.enabled=!0),W.target.releasePointerCapture(W.pointerId)},[i,y,m,T]),M=g.useCallback(W=>{W.stopPropagation(),b(!1)},[]),{radius:O,matrixL:U}=g.useMemo(()=>{const W=l?a/o*1.8:o/22.5,N=new st().setFromUnitVectors(fO,r.clone().normalize()),K=new we().makeRotationFromQuaternion(N);return{radius:W,matrixL:K}},[r,o,a,l]),Y=S?u:c[e];return g.createElement("group",{ref:E},g.createElement("group",{matrix:U,matrixAutoUpdate:!1,onPointerDown:R,onPointerMove:w,onPointerUp:B,onPointerOut:M},i&&g.createElement(Zh,{position:[0,T/2,0]},g.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:n,ref:v})),g.createElement("mesh",{ref:x,position:[0,T,0],renderOrder:500,userData:A},g.createElement("sphereGeometry",{args:[O,12,12]}),g.createElement("meshBasicMaterial",{transparent:!0,depthTest:s,color:Y,opacity:h,polygonOffset:!0,polygonOffsetFactor:-10}))))},Vv=new we,Kv=new we,$v=new we,Zu=new we,O0=new we,ia=new we,Yv=new we,Wv=new we,jv=new we,na=new Jt,U0=new Jt,qv=new Q,Xv=new Q,Jv=new Q,Zv=new Q,Ol=new Q,sa=new Q(1,0,0),ra=new Q(0,1,0),oa=new Q(0,0,1),IG=g.forwardRef(({enabled:r=!0,matrix:e,onDragStart:t,onDrag:i,onDragEnd:n,autoTransform:s=!0,anchor:o,disableAxes:a=!1,disableSliders:l=!1,disableRotations:c=!1,disableScaling:u=!1,activeAxes:h=[!0,!0,!0],offset:f=[0,0,0],rotation:d=[0,0,0],scale:m=1,lineWidth:A=4,fixed:p=!1,translationLimits:y,rotationLimits:v,scaleLimits:E,depthTest:x=!0,axisColors:I=["#ff2060","#20df80","#2080ff"],hoveredColor:C="#ffff40",annotations:_=!1,annotationsClass:S,opacity:b=1,visible:T=!0,userData:R,children:w,...B},M)=>{const O=ae(P=>P.invalidate),U=g.useRef(null),Y=g.useRef(null),W=g.useRef(null),N=g.useRef(null),K=g.useRef([0,0,0]),D=g.useRef(new Q(1,1,1)),z=g.useRef(new Q(1,1,1));g.useLayoutEffect(()=>{o&&(N.current.updateWorldMatrix(!0,!0),Zu.copy(N.current.matrixWorld).invert(),na.makeEmpty(),N.current.traverse(P=>{P.geometry&&(P.geometry.boundingBox||P.geometry.computeBoundingBox(),ia.copy(P.matrixWorld).premultiply(Zu),U0.copy(P.geometry.boundingBox),U0.applyMatrix4(ia),na.union(U0))}),qv.copy(na.max).add(na.min).multiplyScalar(.5),Xv.copy(na.max).sub(na.min).multiplyScalar(.5),Jv.copy(Xv).multiply(new Q(...o)).add(qv),Zv.set(...f).add(Jv),W.current.position.copy(Zv),O())});const $=g.useMemo(()=>({onDragStart:P=>{Vv.copy(Y.current.matrix),Kv.copy(Y.current.matrixWorld),t&&t(P),O()},onDrag:P=>{$v.copy(U.current.matrixWorld),Zu.copy($v).invert(),O0.copy(Kv).premultiply(P),ia.copy(O0).premultiply(Zu),Yv.copy(Vv).invert(),Wv.copy(ia).multiply(Yv),s&&Y.current.matrix.copy(ia),i&&i(ia,Wv,O0,P),O()},onDragEnd:()=>{n&&n(),O()},translation:K,translationLimits:y,rotationLimits:v,axisColors:I,hoveredColor:C,opacity:b,scale:m,lineWidth:A,fixed:p,depthTest:x,userData:R,annotations:_,annotationsClass:S}),[t,i,n,K,y,v,E,x,m,A,p,...I,C,b,R,s,_,S]),V=new Q;return Ve(P=>{if(p){const G=MA(W.current.getWorldPosition(V),m,P.camera,P.size);D.current.setScalar(G)}e&&e instanceof we&&(Y.current.matrix=e),Y.current.updateWorldMatrix(!0,!0),jv.makeRotationFromEuler(W.current.rotation).setPosition(W.current.position).premultiply(Y.current.matrixWorld),z.current.setFromMatrixScale(jv),Ol.copy(D.current).divide(z.current),(Math.abs(W.current.scale.x-Ol.x)>1e-4||Math.abs(W.current.scale.y-Ol.y)>1e-4||Math.abs(W.current.scale.z-Ol.z)>1e-4)&&(W.current.scale.copy(Ol),P.invalidate())}),g.useImperativeHandle(M,()=>Y.current,[]),g.createElement(Mc.Provider,{value:$},g.createElement("group",{ref:U},g.createElement("group",Ae({ref:Y,matrix:e,matrixAutoUpdate:!1},B),g.createElement("group",{visible:T,ref:W,position:f,rotation:d},r&&g.createElement(g.Fragment,null,!a&&h[0]&&g.createElement(B0,{axis:0,direction:sa}),!a&&h[1]&&g.createElement(B0,{axis:1,direction:ra}),!a&&h[2]&&g.createElement(B0,{axis:2,direction:oa}),!l&&h[0]&&h[1]&&g.createElement(F0,{axis:2,dir1:sa,dir2:ra}),!l&&h[0]&&h[2]&&g.createElement(F0,{axis:1,dir1:oa,dir2:sa}),!l&&h[2]&&h[1]&&g.createElement(F0,{axis:0,dir1:ra,dir2:oa}),!c&&h[0]&&h[1]&&g.createElement(P0,{axis:2,dir1:sa,dir2:ra}),!c&&h[0]&&h[2]&&g.createElement(P0,{axis:1,dir1:oa,dir2:sa}),!c&&h[2]&&h[1]&&g.createElement(P0,{axis:0,dir1:ra,dir2:oa}),!u&&h[0]&&g.createElement(k0,{axis:0,direction:sa}),!u&&h[1]&&g.createElement(k0,{axis:1,direction:ra}),!u&&h[2]&&g.createElement(k0,{axis:2,direction:oa}))),g.createElement("group",{ref:N},w))))}),CG=g.forwardRef(({options:r={video:!0},...e},t)=>{const i=Er(()=>navigator.mediaDevices.getDisplayMedia(r),[]);return g.useEffect(()=>()=>{i?.getTracks().forEach(n=>n.stop()),Jh([])},[i]),g.createElement(cp,Ae({ref:t},e,{src:i}))}),dO=g.forwardRef(({constraints:r={audio:!1,video:{facingMode:"user"}},...e},t)=>{const i=Er(()=>navigator.mediaDevices.getUserMedia(r),[]);return g.useEffect(()=>()=>{i?.getTracks().forEach(n=>n.stop()),Jh([])},[i]),g.createElement(cp,Ae({ref:t},e,{src:i}))}),mO=new Q(0,0,-1),AO=(function(){const r=new Q,e=new Q,t=new Q,i=new Q,n=new Q;return function(s,o,a,l){return r.copy(s),e.copy(o),t.copy(a),i.copy(e).sub(r),n.copy(t).sub(r),l.crossVectors(n,i).normalize()}})();function pO(r,e){return r.clone().add(e).multiplyScalar(.5)}const gO=g.forwardRef(({points:r=N0.SAMPLE_FACELANDMARKER_RESULT.faceLandmarks[0],face:e,facialTransformationMatrix:t,faceBlendshapes:i,offset:n,offsetScalar:s=80,width:o,height:a,depth:l=1,verticalTri:c=[159,386,152],origin:u,eyes:h=!0,eyesAsOrigin:f=!1,debug:d=!1,children:m,...A},p)=>{var y;e&&(r=e.keypoints,console.warn("Facemesh `face` prop is deprecated: use `points` instead"));const v=g.useRef(null),E=g.useRef(null),x=g.useRef(null),I=g.useRef(null),C=g.useRef(null),_=g.useRef(null),S=g.useRef(null),[b]=g.useState(()=>new Q),[T]=g.useState(()=>new gi),[R]=g.useState(()=>new st),[w]=g.useState(()=>new Q),{invalidate:B}=ae();g.useEffect(()=>{var N;(N=C.current)==null||N.geometry.setIndex(N0.TRIANGULATION)},[]);const[M]=g.useState(()=>new Q);g.useEffect(()=>{var N,K;const D=(N=C.current)==null?void 0:N.geometry;if(!D)return;if(D.setFromPoints(r),D.setDrawRange(0,N0.TRIANGULATION.length),t)if(T.matrix.fromArray(t.data),T.matrix.decompose(T.position,T.quaternion,T.scale),T.rotation.y*=-1,T.rotation.z*=-1,R.setFromEuler(T.rotation),n){var z;T.position.y*=-1,T.position.z*=-1,(z=v.current)==null||z.position.copy(T.position.divideScalar(s))}else{var $;($=v.current)==null||$.position.set(0,0,0)}else AO(r[c[0]],r[c[1]],r[c[2]],b),R.setFromUnitVectors(mO,b);const V=R.clone().invert();if(D.computeBoundingBox(),d&&B(),D.center(),D.applyQuaternion(V),(K=I.current)==null||K.setRotationFromQuaternion(R),h){if(!i)console.warn("Facemesh `eyes` option only works if `faceBlendshapes` is provided: skipping.");else if(_.current&&S.current&&x.current)if(f){const P=_.current._computeSphere(D),G=S.current._computeSphere(D);u=pO(P.center,G.center).negate(),_.current._update(D,i,P),S.current._update(D,i,G)}else _.current._update(D,i),S.current._update(D,i)}if(x.current){if(u!==void 0)if(typeof u=="number"){const P=D.getAttribute("position");w.set(-P.getX(u),-P.getY(u),-P.getZ(u))}else u.isVector3&&w.copy(u);else w.setScalar(0);x.current.position.copy(w)}if(E.current){let P=1;(o||a||l)&&(D.boundingBox.getSize(M),o&&(P=o/M.x),a&&(P=a/M.y),l&&(P=l/M.z)),E.current.scale.setScalar(P!==1?P:1)}D.computeVertexNormals(),D.attributes.position.needsUpdate=!0},[r,t,i,T,n,s,o,a,l,c,u,h,d,B,b,R,M,w]);const O=g.useMemo(()=>({outerRef:I,meshRef:C,eyeRightRef:_,eyeLeftRef:S}),[]);g.useImperativeHandle(p,()=>O,[O]);const[U]=g.useState(()=>new Q),Y=(y=C.current)==null?void 0:y.geometry.boundingBox,W=Y?.getSize(U).z||1;return g.createElement("group",A,g.createElement("group",{ref:v},g.createElement("group",{ref:I},g.createElement("group",{ref:E},d?g.createElement(g.Fragment,null,g.createElement("axesHelper",{args:[W]}),g.createElement(Ws,{points:[[0,0,0],[0,0,-W]],color:65535})):null,g.createElement("group",{ref:x},h&&i&&g.createElement("group",{name:"eyes"},g.createElement(eE,{side:"left",ref:_,debug:d}),g.createElement(eE,{side:"right",ref:S,debug:d})),g.createElement("mesh",{ref:C,name:"face"},m,d?g.createElement(g.Fragment,null,Y&&g.createElement("box3Helper",{args:[Y]})):null))))))}),Ul={contourLandmarks:{right:[33,133,159,145,153],left:[263,362,386,374,380]},blendshapes:{right:[14,16,18,12],left:[13,15,17,11]},color:{right:"red",left:"#00ff00"},fov:{horizontal:100,vertical:90}},eE=g.forwardRef(({side:r,debug:e=!0},t)=>{const i=g.useRef(null),n=g.useRef(null),[s]=g.useState(()=>new hn),o=g.useCallback(h=>{const f=h.getAttribute("position"),m=Ul.contourLandmarks[r].map(A=>new Q(f.getX(A),f.getY(A),f.getZ(A)));return s.center.set(0,0,0),m.forEach(A=>s.center.add(A)),s.center.divideScalar(m.length),s.radius=m[0].sub(m[1]).length()/2,s},[s,r]),[a]=g.useState(()=>new kn),l=g.useCallback((h,f,d)=>{if(i.current){var m;(m=d)!==null&&m!==void 0||(d=o(h)),i.current.position.copy(d.center),i.current.scale.setScalar(d.radius)}if(f&&n.current){const A=Ul.blendshapes[r],p=f.categories[A[0]].score,y=f.categories[A[1]].score,v=f.categories[A[2]].score,E=f.categories[A[3]].score,x=Ul.fov.horizontal*tt.DEG2RAD,I=Ul.fov.vertical*tt.DEG2RAD,C=x*.5*(E-v),_=I*.5*(p-y)*(r==="left"?1:-1);a.set(C,_,0),n.current.setRotationFromEuler(a)}},[o,r,a]),c=g.useMemo(()=>({eyeMeshRef:i,irisDirRef:n,_computeSphere:o,_update:l}),[o,l]);g.useImperativeHandle(t,()=>c,[c]);const u=Ul.color[r];return g.createElement("group",null,g.createElement("group",{ref:i},e&&g.createElement("axesHelper",null),g.createElement("group",{ref:n},g.createElement(g.Fragment,null,e&&g.createElement(Ws,{points:[[0,0,0],[0,0,-2]],lineWidth:1,color:u})))))}),N0={TRIANGULATION:[127,34,139,11,0,37,232,231,120,72,37,39,128,121,47,232,121,128,104,69,67,175,171,148,157,154,155,118,50,101,73,39,40,9,151,108,48,115,131,194,204,211,74,40,185,80,42,183,40,92,186,230,229,118,202,212,214,83,18,17,76,61,146,160,29,30,56,157,173,106,204,194,135,214,192,203,165,98,21,71,68,51,45,4,144,24,23,77,146,91,205,50,187,201,200,18,91,106,182,90,91,181,85,84,17,206,203,36,148,171,140,92,40,39,193,189,244,159,158,28,247,246,161,236,3,196,54,68,104,193,168,8,117,228,31,189,193,55,98,97,99,126,47,100,166,79,218,155,154,26,209,49,131,135,136,150,47,126,217,223,52,53,45,51,134,211,170,140,67,69,108,43,106,91,230,119,120,226,130,247,63,53,52,238,20,242,46,70,156,78,62,96,46,53,63,143,34,227,173,155,133,123,117,111,44,125,19,236,134,51,216,206,205,154,153,22,39,37,167,200,201,208,36,142,100,57,212,202,20,60,99,28,158,157,35,226,113,160,159,27,204,202,210,113,225,46,43,202,204,62,76,77,137,123,116,41,38,72,203,129,142,64,98,240,49,102,64,41,73,74,212,216,207,42,74,184,169,170,211,170,149,176,105,66,69,122,6,168,123,147,187,96,77,90,65,55,107,89,90,180,101,100,120,63,105,104,93,137,227,15,86,85,129,102,49,14,87,86,55,8,9,100,47,121,145,23,22,88,89,179,6,122,196,88,95,96,138,172,136,215,58,172,115,48,219,42,80,81,195,3,51,43,146,61,171,175,199,81,82,38,53,46,225,144,163,110,246,33,7,52,65,66,229,228,117,34,127,234,107,108,69,109,108,151,48,64,235,62,78,191,129,209,126,111,35,143,163,161,246,117,123,50,222,65,52,19,125,141,221,55,65,3,195,197,25,7,33,220,237,44,70,71,139,122,193,245,247,130,33,71,21,162,153,158,159,170,169,150,188,174,196,216,186,92,144,160,161,2,97,167,141,125,241,164,167,37,72,38,12,145,159,160,38,82,13,63,68,71,226,35,111,158,153,154,101,50,205,206,92,165,209,198,217,165,167,97,220,115,218,133,112,243,239,238,241,214,135,169,190,173,133,171,208,32,125,44,237,86,87,178,85,86,179,84,85,180,83,84,181,201,83,182,137,93,132,76,62,183,61,76,184,57,61,185,212,57,186,214,207,187,34,143,156,79,239,237,123,137,177,44,1,4,201,194,32,64,102,129,213,215,138,59,166,219,242,99,97,2,94,141,75,59,235,24,110,228,25,130,226,23,24,229,22,23,230,26,22,231,112,26,232,189,190,243,221,56,190,28,56,221,27,28,222,29,27,223,30,29,224,247,30,225,238,79,20,166,59,75,60,75,240,147,177,215,20,79,166,187,147,213,112,233,244,233,128,245,128,114,188,114,217,174,131,115,220,217,198,236,198,131,134,177,132,58,143,35,124,110,163,7,228,110,25,356,389,368,11,302,267,452,350,349,302,303,269,357,343,277,452,453,357,333,332,297,175,152,377,384,398,382,347,348,330,303,304,270,9,336,337,278,279,360,418,262,431,304,408,409,310,415,407,270,409,410,450,348,347,422,430,434,313,314,17,306,307,375,387,388,260,286,414,398,335,406,418,364,367,416,423,358,327,251,284,298,281,5,4,373,374,253,307,320,321,425,427,411,421,313,18,321,405,406,320,404,405,315,16,17,426,425,266,377,400,369,322,391,269,417,465,464,386,257,258,466,260,388,456,399,419,284,332,333,417,285,8,346,340,261,413,441,285,327,460,328,355,371,329,392,439,438,382,341,256,429,420,360,364,394,379,277,343,437,443,444,283,275,440,363,431,262,369,297,338,337,273,375,321,450,451,349,446,342,467,293,334,282,458,461,462,276,353,383,308,324,325,276,300,293,372,345,447,382,398,362,352,345,340,274,1,19,456,248,281,436,427,425,381,256,252,269,391,393,200,199,428,266,330,329,287,273,422,250,462,328,258,286,384,265,353,342,387,259,257,424,431,430,342,353,276,273,335,424,292,325,307,366,447,345,271,303,302,423,266,371,294,455,460,279,278,294,271,272,304,432,434,427,272,407,408,394,430,431,395,369,400,334,333,299,351,417,168,352,280,411,325,319,320,295,296,336,319,403,404,330,348,349,293,298,333,323,454,447,15,16,315,358,429,279,14,15,316,285,336,9,329,349,350,374,380,252,318,402,403,6,197,419,318,319,325,367,364,365,435,367,397,344,438,439,272,271,311,195,5,281,273,287,291,396,428,199,311,271,268,283,444,445,373,254,339,263,466,249,282,334,296,449,347,346,264,447,454,336,296,299,338,10,151,278,439,455,292,407,415,358,371,355,340,345,372,390,249,466,346,347,280,442,443,282,19,94,370,441,442,295,248,419,197,263,255,359,440,275,274,300,383,368,351,412,465,263,467,466,301,368,389,380,374,386,395,378,379,412,351,419,436,426,322,373,390,388,2,164,393,370,462,461,164,0,267,302,11,12,374,373,387,268,12,13,293,300,301,446,261,340,385,384,381,330,266,425,426,423,391,429,355,437,391,327,326,440,457,438,341,382,362,459,457,461,434,430,394,414,463,362,396,369,262,354,461,457,316,403,402,315,404,403,314,405,404,313,406,405,421,418,406,366,401,361,306,408,407,291,409,408,287,410,409,432,436,410,434,416,411,264,368,383,309,438,457,352,376,401,274,275,4,421,428,262,294,327,358,433,416,367,289,455,439,462,370,326,2,326,370,305,460,455,254,449,448,255,261,446,253,450,449,252,451,450,256,452,451,341,453,452,413,464,463,441,413,414,258,442,441,257,443,442,259,444,443,260,445,444,467,342,445,459,458,250,289,392,290,290,328,460,376,433,435,250,290,392,411,416,433,341,463,464,453,464,465,357,465,412,343,412,399,360,363,440,437,399,456,420,456,363,401,435,288,372,383,353,339,255,249,448,261,255,133,243,190,133,155,112,33,246,247,33,130,25,398,384,286,362,398,414,362,463,341,263,359,467,263,249,255,466,467,260,75,60,166,238,239,79,162,127,139,72,11,37,121,232,120,73,72,39,114,128,47,233,232,128,103,104,67,152,175,148,173,157,155,119,118,101,74,73,40,107,9,108,49,48,131,32,194,211,184,74,185,191,80,183,185,40,186,119,230,118,210,202,214,84,83,17,77,76,146,161,160,30,190,56,173,182,106,194,138,135,192,129,203,98,54,21,68,5,51,4,145,144,23,90,77,91,207,205,187,83,201,18,181,91,182,180,90,181,16,85,17,205,206,36,176,148,140,165,92,39,245,193,244,27,159,28,30,247,161,174,236,196,103,54,104,55,193,8,111,117,31,221,189,55,240,98,99,142,126,100,219,166,218,112,155,26,198,209,131,169,135,150,114,47,217,224,223,53,220,45,134,32,211,140,109,67,108,146,43,91,231,230,120,113,226,247,105,63,52,241,238,242,124,46,156,95,78,96,70,46,63,116,143,227,116,123,111,1,44,19,3,236,51,207,216,205,26,154,22,165,39,167,199,200,208,101,36,100,43,57,202,242,20,99,56,28,157,124,35,113,29,160,27,211,204,210,124,113,46,106,43,204,96,62,77,227,137,116,73,41,72,36,203,142,235,64,240,48,49,64,42,41,74,214,212,207,183,42,184,210,169,211,140,170,176,104,105,69,193,122,168,50,123,187,89,96,90,66,65,107,179,89,180,119,101,120,68,63,104,234,93,227,16,15,85,209,129,49,15,14,86,107,55,9,120,100,121,153,145,22,178,88,179,197,6,196,89,88,96,135,138,136,138,215,172,218,115,219,41,42,81,5,195,51,57,43,61,208,171,199,41,81,38,224,53,225,24,144,110,105,52,66,118,229,117,227,34,234,66,107,69,10,109,151,219,48,235,183,62,191,142,129,126,116,111,143,7,163,246,118,117,50,223,222,52,94,19,141,222,221,65,196,3,197,45,220,44,156,70,139,188,122,245,139,71,162,145,153,159,149,170,150,122,188,196,206,216,92,163,144,161,164,2,167,242,141,241,0,164,37,11,72,12,144,145,160,12,38,13,70,63,71,31,226,111,157,158,154,36,101,205,203,206,165,126,209,217,98,165,97,237,220,218,237,239,241,210,214,169,140,171,32,241,125,237,179,86,178,180,85,179,181,84,180,182,83,181,194,201,182,177,137,132,184,76,183,185,61,184,186,57,185,216,212,186,192,214,187,139,34,156,218,79,237,147,123,177,45,44,4,208,201,32,98,64,129,192,213,138,235,59,219,141,242,97,97,2,141,240,75,235,229,24,228,31,25,226,230,23,229,231,22,230,232,26,231,233,112,232,244,189,243,189,221,190,222,28,221,223,27,222,224,29,223,225,30,224,113,247,225,99,60,240,213,147,215,60,20,166,192,187,213,243,112,244,244,233,245,245,128,188,188,114,174,134,131,220,174,217,236,236,198,134,215,177,58,156,143,124,25,110,7,31,228,25,264,356,368,0,11,267,451,452,349,267,302,269,350,357,277,350,452,357,299,333,297,396,175,377,381,384,382,280,347,330,269,303,270,151,9,337,344,278,360,424,418,431,270,304,409,272,310,407,322,270,410,449,450,347,432,422,434,18,313,17,291,306,375,259,387,260,424,335,418,434,364,416,391,423,327,301,251,298,275,281,4,254,373,253,375,307,321,280,425,411,200,421,18,335,321,406,321,320,405,314,315,17,423,426,266,396,377,369,270,322,269,413,417,464,385,386,258,248,456,419,298,284,333,168,417,8,448,346,261,417,413,285,326,327,328,277,355,329,309,392,438,381,382,256,279,429,360,365,364,379,355,277,437,282,443,283,281,275,363,395,431,369,299,297,337,335,273,321,348,450,349,359,446,467,283,293,282,250,458,462,300,276,383,292,308,325,283,276,293,264,372,447,346,352,340,354,274,19,363,456,281,426,436,425,380,381,252,267,269,393,421,200,428,371,266,329,432,287,422,290,250,328,385,258,384,446,265,342,386,387,257,422,424,430,445,342,276,422,273,424,306,292,307,352,366,345,268,271,302,358,423,371,327,294,460,331,279,294,303,271,304,436,432,427,304,272,408,395,394,431,378,395,400,296,334,299,6,351,168,376,352,411,307,325,320,285,295,336,320,319,404,329,330,349,334,293,333,366,323,447,316,15,315,331,358,279,317,14,316,8,285,9,277,329,350,253,374,252,319,318,403,351,6,419,324,318,325,397,367,365,288,435,397,278,344,439,310,272,311,248,195,281,375,273,291,175,396,199,312,311,268,276,283,445,390,373,339,295,282,296,448,449,346,356,264,454,337,336,299,337,338,151,294,278,455,308,292,415,429,358,355,265,340,372,388,390,466,352,346,280,295,442,282,354,19,370,285,441,295,195,248,197,457,440,274,301,300,368,417,351,465,251,301,389,385,380,386,394,395,379,399,412,419,410,436,322,387,373,388,326,2,393,354,370,461,393,164,267,268,302,12,386,374,387,312,268,13,298,293,301,265,446,340,380,385,381,280,330,425,322,426,391,420,429,437,393,391,326,344,440,438,458,459,461,364,434,394,428,396,262,274,354,457,317,316,402,316,315,403,315,314,404,314,313,405,313,421,406,323,366,361,292,306,407,306,291,408,291,287,409,287,432,410,427,434,411,372,264,383,459,309,457,366,352,401,1,274,4,418,421,262,331,294,358,435,433,367,392,289,439,328,462,326,94,2,370,289,305,455,339,254,448,359,255,446,254,253,449,253,252,450,252,256,451,256,341,452,414,413,463,286,441,414,286,258,441,258,257,442,257,259,443,259,260,444,260,467,445,309,459,250,305,289,290,305,290,460,401,376,435,309,250,392,376,411,433,453,341,464,357,453,465,343,357,412,437,343,399,344,360,440,420,437,456,360,420,363,361,401,288,265,372,353,390,339,249,339,448,255],SAMPLE_FACE:{keypoints:[{x:356.2804412841797,y:295.1960563659668,z:-23.786449432373047,name:"lips"},{x:354.8859405517578,y:264.69520568847656,z:-36.718435287475586},{x:355.2180862426758,y:275.3360366821289,z:-21.183712482452393},{x:347.349853515625,y:242.4400234222412,z:-25.093655586242676},{x:354.40135955810547,y:256.67933464050293,z:-38.23572635650635},{x:353.7689971923828,y:247.54886627197266,z:-34.5475435256958},{x:352.1288299560547,y:227.34312057495117,z:-13.095386028289795},{x:303.5013198852539,y:234.67002868652344,z:12.500141859054565,name:"rightEye"},{x:351.09378814697266,y:211.87547206878662,z:-6.413471698760986},{x:350.7115936279297,y:202.1251630783081,z:-6.413471698760986},{x:348.33667755126953,y:168.7741756439209,z:6.483500003814697,name:"faceOval"},{x:356.4806365966797,y:299.2995357513428,z:-23.144519329071045},{x:356.5511703491211,y:302.66146659851074,z:-21.020312309265137},{x:356.6239547729492,y:304.1536331176758,z:-18.137459754943848,name:"lips"},{x:356.5807342529297,y:305.1840591430664,z:-18.767719268798828,name:"lips"},{x:356.8241500854492,y:308.25711250305176,z:-20.16829490661621},{x:357.113037109375,y:312.26277351379395,z:-22.10575819015503},{x:357.34962463378906,y:317.1123218536377,z:-21.837315559387207,name:"lips"},{x:357.6658630371094,y:325.51036834716797,z:-16.27002477645874},{x:355.0201416015625,y:269.36279296875,z:-33.73054027557373},{x:348.5237503051758,y:270.33411026000977,z:-24.93025302886963},{x:279.97331619262695,y:213.24176788330078,z:47.759642601013184,name:"faceOval"},{x:322.66529083251953,y:238.5027265548706,z:5.535193085670471},{x:316.0983657836914,y:239.94489669799805,z:5.777376294136047},{x:309.9431610107422,y:240.24518966674805,z:7.510589361190796},{x:301.31994247436523,y:237.86138534545898,z:13.118728399276733},{x:328.14266204833984,y:235.80496788024902,z:6.646900177001953},{x:313.7326431274414,y:222.11161136627197,z:3.9887237548828125},{x:320.45196533203125,y:221.87729358673096,z:4.601476192474365},{x:307.35679626464844,y:223.63793849945068,z:5.932023525238037},{x:303.0031204223633,y:226.3743782043457,z:8.479321002960205},{x:296.80023193359375,y:242.94299125671387,z:15.931552648544312},{x:332.2352981567383,y:340.77341079711914,z:-10.165848731994629},{x:301.38587951660156,y:233.46447944641113,z:14.764405488967896,name:"rightEye"},{x:279.0147018432617,y:244.37155723571777,z:45.77549457550049},{x:289.60548400878906,y:239.1807460784912,z:23.191204071044922},{x:320.32257080078125,y:267.1292781829834,z:-4.954537749290466},{x:347.64583587646484,y:294.4955062866211,z:-23.062820434570312,name:"lips"},{x:349.28138732910156,y:303.1095886230469,z:-20.238323211669922},{x:338.9453125,y:298.19186210632324,z:-19.456336498260498,name:"lips"},{x:333.36788177490234,y:302.6706790924072,z:-14.776077270507812,name:"lips"},{x:342.89188385009766,y:304.3561363220215,z:-17.752301692962646},{x:337.7375030517578,y:306.0098361968994,z:-13.410515785217285},{x:325.6159210205078,y:316.22995376586914,z:-6.681914925575256},{x:349.0104675292969,y:264.9818515777588,z:-36.274919509887695},{x:347.7138900756836,y:257.5664806365967,z:-37.67549514770508},{x:291.79357528686523,y:218.88171672821045,z:11.578094959259033,name:"rightEyebrow"},{x:332.2689437866211,y:247.56946563720703,z:-3.3730539679527283},{x:332.0074462890625,y:267.1201229095459,z:-19.969879388809204},{x:331.27952575683594,y:263.6967658996582,z:-17.47218608856201},{x:301.04373931884766,y:269.56552505493164,z:3.61815482378006},{x:347.4863815307617,y:249.0706443786621,z:-32.633421421051025},{x:307.26118087768555,y:208.2646894454956,z:1.1591226607561111,name:"rightEyebrow"},{x:297.91919708251953,y:212.22604751586914,z:5.914516448974609,name:"rightEyebrow"},{x:285.1651382446289,y:197.98450469970703,z:36.391637325286865,name:"faceOval"},{x:337.04097747802734,y:211.25229835510254,z:-4.548954665660858},{x:326.5912628173828,y:223.16698551177979,z:6.670243740081787},{x:320.05664825439453,y:309.5834255218506,z:-4.055835008621216},{x:289.6866226196289,y:314.617395401001,z:53.875489234924316,name:"faceOval"},{x:337.4256896972656,y:270.8755302429199,z:-17.67060160636902},{x:343.69922637939453,y:273.0000400543213,z:-18.756048679351807},{x:327.4242401123047,y:309.22399520874023,z:-4.703601002693176,name:"lips"},{x:330.37220001220703,y:308.3323001861572,z:-6.442649960517883},{x:293.87027740478516,y:207.7961826324463,z:9.821539521217346,name:"rightEyebrow"},{x:332.11437225341797,y:271.22812271118164,z:-16.64351224899292},{x:320.1197814941406,y:207.40366458892822,z:-2.48164564371109,name:"rightEyebrow"},{x:318.59575271606445,y:201.07443809509277,z:-3.110446035861969,name:"rightEyebrow"},{x:310.72303771972656,y:175.75075149536133,z:13.328815698623657,name:"faceOval"},{x:289.67578887939453,y:202.29835510253906,z:21.370456218719482},{x:315.30879974365234,y:187.35260009765625,z:5.0304025411605835},{x:287.8936767578125,y:216.54793739318848,z:17.81065821647644,name:"rightEyebrow"},{x:283.9391899108887,y:215.01142501831055,z:32.04984903335571},{x:348.35330963134766,y:299.4155788421631,z:-22.47924566268921},{x:341.1790466308594,y:301.8221855163574,z:-18.977805376052856},{x:335.69713592529297,y:304.4266891479492,z:-14.682706594467163},{x:339.4615173339844,y:272.3654365539551,z:-16.38674020767212},{x:328.99600982666016,y:308.86685371398926,z:-5.616893768310547},{x:332.00313568115234,y:309.1875743865967,z:-10.335084199905396},{x:331.0068130493164,y:307.9274368286133,z:-6.681914925575256,name:"lips"},{x:341.13792419433594,y:266.4876937866211,z:-26.56425952911377},{x:339.02950286865234,y:305.6663703918457,z:-12.33674168586731,name:"lips"},{x:344.22935485839844,y:304.9452781677246,z:-15.161235332489014,name:"lips"},{x:350.1844024658203,y:304.374303817749,z:-17.5305438041687,name:"lips"},{x:348.52630615234375,y:325.9562301635742,z:-16.164982318878174},{x:348.6581802368164,y:317.1624183654785,z:-21.510512828826904,name:"lips"},{x:348.9766311645508,y:312.1923065185547,z:-21.708929538726807},{x:349.2427444458008,y:308.0660820007324,z:-19.643079042434692},{x:349.67491149902344,y:305.42747497558594,z:-18.16080331802368,name:"lips"},{x:337.95589447021484,y:306.6535949707031,z:-12.803598642349243,name:"lips"},{x:337.06878662109375,y:307.63169288635254,z:-14.274203777313232},{x:335.77449798583984,y:309.8449516296387,z:-15.698124170303345},{x:334.6099090576172,y:312.7997016906738,z:-14.764405488967896,name:"lips"},{x:327.2330856323242,y:293.80866050720215,z:-11.864047050476074},{x:280.97679138183594,y:279.79928970336914,z:68.90834331512451,name:"faceOval"},{x:355.13843536376953,y:271.7875671386719,z:-25.350427627563477},{x:334.7235870361328,y:307.4656391143799,z:-9.302158951759338,name:"lips"},{x:333.5293960571289,y:307.89782524108887,z:-10.200862884521484},{x:346.29688262939453,y:276.4256286621094,z:-19.748122692108154},{x:335.16246795654297,y:276.22097969055176,z:-12.313398122787476},{x:345.09132385253906,y:274.7082996368408,z:-19.304605722427368},{x:325.4267883300781,y:252.95130729675293,z:-1.6661019623279572},{x:315.347843170166,y:259.05200958251953,z:-.25604281574487686},{x:330.44933319091797,y:267.7570152282715,z:-14.017432928085327},{x:294.96768951416016,y:185.26001930236816,z:23.903164863586426,name:"faceOval"},{x:299.63531494140625,y:192.7913761138916,z:12.640198469161987},{x:304.5452117919922,y:202.4142837524414,z:3.244667649269104,name:"rightEyebrow"},{x:331.6915512084961,y:320.0467872619629,z:-10.632705688476562},{x:334.5911407470703,y:201.27566814422607,z:-6.133356094360352,name:"rightEyebrow"},{x:331.4815902709961,y:185.44180870056152,z:.6627205014228821},{x:328.05816650390625,y:170.8385467529297,z:7.358860373497009,name:"faceOval"},{x:304.49764251708984,y:239.76297855377197,z:10.387605428695679},{x:290.6382179260254,y:248.85257720947266,z:19.03616428375244},{x:331.5682601928711,y:233.20727348327637,z:7.837390303611755},{x:295.5115509033203,y:228.9834451675415,z:14.41426157951355},{x:336.94332122802734,y:241.8259334564209,z:-5.27842104434967},{x:336.2792205810547,y:262.7049922943115,z:-26.12074375152588},{x:284.4102478027344,y:255.3262710571289,z:25.467140674591064},{x:295.1420593261719,y:253.02655220031738,z:12.430112361907959},{x:303.5196113586426,y:254.20703887939453,z:6.139191389083862},{x:315.73450088500977,y:251.64799690246582,z:3.3788898587226868},{x:324.69661712646484,y:247.56494522094727,z:2.3328344523906708},{x:331.57970428466797,y:243.02241325378418,z:1.1423448473215103},{x:345.6210708618164,y:229.9976634979248,z:-10.825285911560059},{x:286.26644134521484,y:270.37991523742676,z:21.708929538726807},{x:290.2525520324707,y:228.4921360015869,z:17.71728754043579},{x:351.65367126464844,y:269.3400764465332,z:-33.450424671173096},{x:333.1378936767578,y:253.88388633728027,z:-7.230473756790161},{x:277.8318977355957,y:246.95331573486328,z:68.20805549621582,name:"faceOval"},{x:336.6680908203125,y:238.10003757476807,z:.7688578963279724},{x:329.95800018310547,y:269.18323516845703,z:-7.207130789756775},{x:299.17491912841797,y:234.13324356079102,z:15.95489501953125},{x:335.61729431152344,y:258.71752738952637,z:-23.016133308410645},{x:284.1079330444336,y:297.0343494415283,z:63.25934886932373,name:"faceOval"},{x:331.44542694091797,y:230.6892442703247,z:9.92658257484436,name:"rightEye"},{x:341.41536712646484,y:253.01264762878418,z:-29.038610458374023},{x:303.5472869873047,y:327.5896739959717,z:16.725212335586548},{x:304.7756576538086,y:337.4389457702637,z:27.38126277923584,name:"faceOval"},{x:280.80501556396484,y:275.32050132751465,z:45.0752067565918},{x:295.43582916259766,y:318.4501647949219,z:26.2608003616333},{x:281.4303207397461,y:228.7355661392212,z:40.94350814819336},{x:331.2549591064453,y:349.4216537475586,z:-7.376367449760437},{x:352.4247741699219,y:271.7330074310303,z:-24.953596591949463},{x:327.5672912597656,y:260.41900634765625,z:-5.456410646438599},{x:284.5432472229004,y:241.7647933959961,z:29.668869972229004},{x:310,y:235.66174507141113,z:8.502663969993591,name:"rightEye"},{x:315.7071113586426,y:235.7572603225708,z:6.938687562942505,name:"rightEye"},{x:330.41088104248047,y:311.04143142700195,z:-9.325502514839172,name:"lips"},{x:288.5377502441406,y:285.31983375549316,z:21.837315559387207},{x:344.55039978027344,y:359.4300842285156,z:-6.705257892608643,name:"faceOval"},{x:323.41880798339844,y:351.67362213134766,z:7.802375555038452,name:"faceOval"},{x:314.64088439941406,y:346.11894607543945,z:16.36339783668518,name:"faceOval"},{x:349.4945526123047,y:184.8434829711914,z:-.21847527474164963},{x:359.24694061279297,y:359.8348903656006,z:-8.403456211090088,name:"faceOval"},{x:321.26182556152344,y:234.64492321014404,z:6.90950870513916,name:"rightEye"},{x:326.318359375,y:232.90250301361084,z:8.029969334602356,name:"rightEye"},{x:329.6211624145508,y:231.6195774078369,z:9.722331762313843,name:"rightEye"},{x:285.9398078918457,y:228.2351303100586,z:24.650139808654785},{x:325.79288482666016,y:227.88007736206055,z:7.469738721847534,name:"rightEye"},{x:320.1699447631836,y:227.5934886932373,z:6.168370842933655,name:"rightEye"},{x:314.85408782958984,y:227.85282611846924,z:6.2675780057907104,name:"rightEye"},{x:309.3084907531738,y:229.1516876220703,z:7.7031683921813965,name:"rightEye"},{x:305.5621337890625,y:230.92366218566895,z:9.722331762313843,name:"rightEye"},{x:277.8681945800781,y:228.5354232788086,z:59.71122741699219,name:"faceOval"},{x:306.1444664001465,y:235.1954698562622,z:10.603528022766113,name:"rightEye"},{x:355.4478454589844,y:281.96210861206055,z:-20.565123558044434},{x:333.02661895751953,y:288.0105400085449,z:-14.72939133644104},{x:337.15728759765625,y:269.2059516906738,z:-19.8414945602417},{x:345.9898376464844,y:283.5453128814697,z:-20.4834246635437},{x:351.48963928222656,y:219.98916149139404,z:-7.0378947257995605},{x:312.39574432373047,y:336.50628089904785,z:8.671900033950806},{x:321.32152557373047,y:343.1755256652832,z:.9067271649837494},{x:343.78379821777344,y:353.2975959777832,z:-14.355905055999756},{x:296.8791389465332,y:327.91497230529785,z:41.01353645324707,name:"faceOval"},{x:329.6939468383789,y:229.27897453308105,z:8.934508562088013,name:"rightEye"},{x:341.6905212402344,y:241.4073657989502,z:-14.589333534240723},{x:359.03079986572266,y:353.48859786987305,z:-15.803166627883911},{x:333.1861877441406,y:356.43213272094727,z:-1.0234417766332626,name:"faceOval"},{x:283.97483825683594,y:291.4318656921387,z:41.94725513458252},{x:343.33770751953125,y:305.830135345459,z:-15.756480693817139,name:"lips"},{x:342.40283966064453,y:307.7453899383545,z:-17.4021577835083},{x:341.53621673583984,y:311.0595703125,z:-19.047834873199463},{x:340.9107208251953,y:315.4837703704834,z:-18.5576331615448,name:"lips"},{x:339.1478729248047,y:323.42233657836914,z:-14.367576837539673},{x:333.3201599121094,y:307.4406337738037,z:-9.617288708686829},{x:331.2411117553711,y:306.9811820983887,z:-9.669809937477112},{x:329.23255920410156,y:306.0508346557617,z:-9.582273960113525,name:"lips"},{x:322.4586486816406,y:301.33323669433594,z:-7.720675468444824},{x:297.1712112426758,y:286.9552803039551,z:8.240055441856384},{x:341.3060760498047,y:235.4432201385498,z:-7.504753470420837},{x:336.9318389892578,y:224.3451976776123,z:5.829898118972778},{x:332.65323638916016,y:226.70403957366943,z:8.105834126472473},{x:334.67357635498047,y:306.4397621154785,z:-8.981193900108337,name:"lips"},{x:297.4601936340332,y:306.29210472106934,z:15.476365089416504},{x:342.9119110107422,y:222.37077713012695,z:-2.754466235637665},{x:335.4629898071289,y:332.20250129699707,z:-11.823196411132812},{x:353.2412338256836,y:240.56339263916016,z:-27.147831916809082},{x:346.3080596923828,y:236.41446590423584,z:-18.452589511871338},{x:352.6475143432617,y:234.1420555114746,z:-19.748122692108154},{x:337.3209762573242,y:253.39937210083008,z:-16.024924516677856},{x:358.6122131347656,y:344.90861892700195,z:-18.592647314071655},{x:358.1117248535156,y:334.64990615844727,z:-17.49552845954895},{x:346.4450454711914,y:335.0321102142334,z:-16.32838249206543},{x:319.17640686035156,y:320.2833938598633,z:-3.276764452457428},{x:325.2540588378906,y:276.2369728088379,z:-6.460157036781311},{x:326.7214584350586,y:327.3939514160156,z:-7.417217493057251},{x:310.7190132141113,y:277.2265148162842,z:-3.5452082753181458},{x:319.78355407714844,y:284.8238182067871,z:-6.4543211460113525},{x:305.773983001709,y:290.83580017089844,z:.06907138042151928},{x:344.4001770019531,y:344.85408782958984,z:-16.946970224380493},{x:333.1879425048828,y:258.74256134033203,z:-11.90489649772644},{x:313.80598068237305,y:327.08919525146484,z:2.2277912497520447},{x:322.9637908935547,y:334.6819496154785,z:-3.3643004298210144},{x:313.4055519104004,y:311.2166690826416,z:-1.1175429821014404},{x:291.0865783691406,y:298.2831001281738,z:22.467575073242188},{x:305.6580924987793,y:313.3707904815674,z:5.561453700065613},{x:288.23760986328125,y:305.9941864013672,z:36.765122413635254},{x:315.10692596435547,y:296.26991271972656,z:-4.604393839836121},{x:337.50518798828125,y:247.5944423675537,z:-10.597691535949707},{x:338.8450622558594,y:265.47778129577637,z:-27.778091430664062},{x:334.25254821777344,y:269.0671920776367,z:-20.938611030578613},{x:341.64512634277344,y:259.6387195587158,z:-32.189905643463135},{x:331.44081115722656,y:219.0976095199585,z:4.207563698291779},{x:320.56339263916016,y:216.49658203125,z:2.930997312068939},{x:311.21912002563477,y:216.57853603363037,z:2.9674705862998962},{x:303.46256256103516,y:218.54614734649658,z:5.357203483581543},{x:297.99999237060547,y:222.505202293396,z:9.325502514839172},{x:294.93839263916016,y:236.39654159545898,z:18.534289598464966},{x:278.87489318847656,y:259.7095584869385,z:45.68212032318115},{x:300.3782653808594,y:245.38593292236328,z:12.278382778167725},{x:307.06348419189453,y:246.36857986450195,z:8.164191246032715},{x:315.5229187011719,y:245.3949737548828,z:5.503097176551819},{x:323.71395111083984,y:242.75178909301758,z:4.6335723996162415},{x:330.2785873413086,y:239.34658527374268,z:4.937030673027039},{x:334.6982192993164,y:236.0460376739502,z:4.823233783245087},{x:279.3412208557129,y:263.5196113586426,z:70.91583728790283,name:"faceOval"},{x:334.65972900390625,y:271.6648578643799,z:-17.775644063949585},{x:342.05677032470703,y:246.99846267700195,z:-20.84523916244507},{x:344.0357971191406,y:264.5701503753662,z:-32.936880588531494},{x:348.25531005859375,y:268.6645030975342,z:-30.695960521697998},{x:344.12227630615234,y:266.34212493896484,z:-29.808926582336426},{x:337.12318420410156,y:274.2556858062744,z:-15.768152475357056},{x:349.49047088623047,y:269.071683883667,z:-32.51670837402344},{x:350.1683044433594,y:271.4691352844238,z:-24.93025302886963},{x:333.9634704589844,y:230.56639194488525,z:8.89949381351471},{x:338.2147979736328,y:231.4807891845703,z:4.6715047955513},{x:340.4712677001953,y:231.74463272094727,z:-.34996166825294495},{x:303.28975677490234,y:232.24980354309082,z:11.916568279266357,name:"rightEye"},{x:299.4649124145508,y:229.53842639923096,z:12.325069904327393},{x:359.09618377685547,y:241.77349090576172,z:-24.650139808654785},{x:399.46216583251953,y:229.89503860473633,z:15.919880867004395,name:"leftEye"},{x:361.38919830322266,y:269.6129894256592,z:-24.510080814361572},{x:416.9973373413086,y:206.0895538330078,z:53.26857566833496,name:"faceOval"},{x:381.32179260253906,y:235.5476474761963,z:7.6214683055877686},{x:387.8068542480469,y:236.25958442687988,z:8.345099091529846},{x:393.95751953125,y:235.8660364151001,z:10.475142002105713},{x:401.84600830078125,y:232.77019500732422,z:16.760226488113403},{x:375.70568084716797,y:233.48456382751465,z:8.234220147132874},{x:388.17752838134766,y:218.94717693328857,z:6.810300946235657},{x:381.64928436279297,y:219.2656660079956,z:6.711093783378601},{x:394.4760513305664,y:219.66821193695068,z:9.173773527145386},{x:398.8843536376953,y:221.8837022781372,z:12.03328251838684},{x:406.5454864501953,y:237.12156772613525,z:19.7131085395813},{x:383.87447357177734,y:337.6932907104492,z:-8.631049990653992},{x:401.2682342529297,y:228.5916566848755,z:18.359217643737793,name:"leftEye"},{x:422.0449447631836,y:236.73934936523438,z:51.16771221160889},{x:412.69153594970703,y:232.80198097229004,z:27.52131938934326},{x:387.3497772216797,y:263.298397064209,z:-2.8609684109687805},{x:364.5124053955078,y:293.39221000671387,z:-22.397546768188477,name:"lips"},{x:363.62987518310547,y:302.1291446685791,z:-19.643079042434692},{x:373.2334518432617,y:295.8647060394287,z:-18.125789165496826,name:"lips"},{x:378.83365631103516,y:299.5177745819092,z:-13.153743743896484,name:"lips"},{x:369.91477966308594,y:302.5704002380371,z:-16.65518283843994},{x:374.9167251586914,y:303.5416603088379,z:-11.963253021240234},{x:387.58888244628906,y:312.2716999053955,z:-4.680258631706238},{x:360.6635284423828,y:264.31986808776855,z:-35.94811677932739},{x:361.04564666748047,y:256.8225860595703,z:-37.278664112091064},{x:408.3855438232422,y:213.52088928222656,z:15.756480693817139,name:"leftEyebrow"},{x:373.2946014404297,y:245.38101196289062,z:-1.9316278398036957},{x:376.83860778808594,y:264.3721103668213,z:-18.510947227478027},{x:376.9546127319336,y:261.0010528564453,z:-15.989909172058105},{x:406.1498260498047,y:263.5030174255371,z:7.072908878326416},{x:360.07205963134766,y:248.3631706237793,z:-32.16656446456909},{x:393.11119079589844,y:205.10473251342773,z:3.7786373496055603,name:"leftEyebrow"},{x:402.12791442871094,y:207.89000988006592,z:9.383859634399414,name:"leftEyebrow"},{x:410.8693313598633,y:191.6182279586792,z:41.27030849456787,name:"faceOval"},{x:364.9509811401367,y:210.40483474731445,z:-3.758212625980377},{x:375.94444274902344,y:221.1331844329834,z:8.368442058563232},{x:392.1904754638672,y:305.0360298156738,z:-1.752179116010666},{x:419.50225830078125,y:307.25592613220215,z:58.96425247192383,name:"faceOval"},{x:372.0027160644531,y:268.7212657928467,z:-16.631840467453003},{x:366.1614227294922,y:271.6237449645996,z:-18.219159841537476},{x:385.00938415527344,y:305.3863334655762,z:-2.567722797393799},{x:381.99771881103516,y:304.9723720550537,z:-4.575215280056},{x:405.078125,y:203.21216583251953,z:13.713973760604858,name:"leftEyebrow"},{x:377.13207244873047,y:268.4710121154785,z:-15.266278982162476},{x:380.9713363647461,y:205.36980628967285,z:-.7250899076461792,name:"leftEyebrow"},{x:381.7788314819336,y:198.9268398284912,z:-1.184653863310814,name:"leftEyebrow"},{x:385.5204772949219,y:172.1484375,z:16.04826807975769,name:"faceOval"},{x:407.94189453125,y:196.76236152648926,z:25.723915100097656},{x:383.03890228271484,y:184.5157527923584,z:7.393874526023865},{x:411.61781311035156,y:210.79241752624512,z:22.315845489501953,name:"leftEyebrow"},{x:414.30870056152344,y:208.4643030166626,z:37.021894454956055},{x:364.28722381591797,y:298.35777282714844,z:-21.86065673828125},{x:371.3682556152344,y:299.78848457336426,z:-17.834001779556274},{x:376.88201904296875,y:301.6696071624756,z:-13.153743743896484},{x:370.2193832397461,y:270.49095153808594,z:-15.569736957550049},{x:383.5081100463867,y:305.2726364135742,z:-3.673594295978546},{x:380.73760986328125,y:305.96869468688965,z:-8.660228252410889},{x:381.2334442138672,y:304.63574409484863,z:-4.820316135883331,name:"lips"},{x:368.1698989868164,y:264.8884963989258,z:-25.653886795043945},{x:373.5087203979492,y:303.4233856201172,z:-10.95950722694397,name:"lips"},{x:368.4544372558594,y:303.29601287841797,z:-14.169161319732666,name:"lips"},{x:362.76554107666016,y:303.5735607147217,z:-16.911956071853638,name:"lips"},{x:366.60980224609375,y:324.8870658874512,z:-15.616422891616821},{x:365.7067108154297,y:315.95678329467773,z:-20.903596878051758,name:"lips"},{x:365.0083923339844,y:311.2232208251953,z:-21.066999435424805},{x:364.1508102416992,y:307.0583438873291,z:-18.907777070999146},{x:363.37512969970703,y:304.5721435546875,z:-17.42550015449524,name:"lips"},{x:374.580078125,y:304.3059539794922,z:-11.40302300453186,name:"lips"},{x:375.55362701416016,y:305.0998020172119,z:-12.861957550048828},{x:377.2437286376953,y:307.1674346923828,z:-14.215847253799438},{x:378.68587493896484,y:309.9015712738037,z:-13.223772048950195,name:"lips"},{x:383.8992691040039,y:290.29629707336426,z:-9.97326910495758},{x:423.3871841430664,y:271.91688537597656,z:74.37058925628662,name:"faceOval"},{x:377.68043518066406,y:304.62209701538086,z:-7.603961229324341,name:"lips"},{x:379.00428771972656,y:304.9314594268799,z:-8.57852816581726},{x:364.00279998779297,y:275.2813911437988,z:-19.25792098045349},{x:374.68231201171875,y:273.82555961608887,z:-11.28047227859497},{x:365.0354766845703,y:273.4548568725586,z:-18.791062831878662},{x:380.61901092529297,y:249.8848056793213,z:.15501167625188828},{x:391.14158630371094,y:254.7934627532959,z:2.0906515419483185},{x:378.1761169433594,y:264.9612236022949,z:-12.605184316635132},{x:400.9540557861328,y:179.99592304229736,z:27.82477855682373,name:"faceOval"},{x:398.0038833618164,y:188.50656509399414,z:16.094952821731567},{x:394.8717498779297,y:199.0359592437744,z:6.226727366447449,name:"leftEyebrow"},{x:382.10926055908203,y:316.83926582336426,z:-8.946179747581482},{x:366.51588439941406,y:200.32583713531494,z:-5.24632453918457,name:"leftEyebrow"},{x:367.4893569946289,y:183.87210845947266,z:1.9039081037044525},{x:368.6243438720703,y:168.8127565383911,z:8.736093044281006,name:"faceOval"},{x:398.96175384521484,y:234.9675178527832,z:13.713973760604858},{x:412.9645538330078,y:242.23042488098145,z:23.272905349731445},{x:372.05257415771484,y:231.41919136047363,z:9.226294755935669},{x:406.0722351074219,y:223.58965873718262,z:18.370890617370605},{x:368.27442169189453,y:240.2039337158203,z:-4.166713654994965},{x:372.3575210571289,y:260.66442489624023,z:-24.976940155029297},{x:419.2244338989258,y:247.9079246520996,z:30.299127101898193},{x:409.43885803222656,y:246.60913467407227,z:16.398411989212036},{x:401.69139862060547,y:248.76328468322754,z:9.395531415939331},{x:389.7608184814453,y:247.56915092468262,z:5.841569304466248},{x:380.5461883544922,y:244.55984115600586,z:4.263003468513489},{x:373.25817108154297,y:240.80214500427246,z:2.5356262922286987},{x:358.77086639404297,y:229.35615062713623,z:-10.387605428695679},{x:419.5793914794922,y:262.8478717803955,z:26.5175724029541},{x:410.8808898925781,y:222.51372814178467,z:22.199130058288574},{x:358.45714569091797,y:268.91467094421387,z:-33.17030906677246},{x:373.4129333496094,y:251.6385841369629,z:-5.771540403366089},{x:422.5408172607422,y:239.23919677734375,z:74.04378890991211,name:"faceOval"},{x:367.8171920776367,y:236.58040523529053,z:1.820748895406723},{x:378.51959228515625,y:266.2532329559326,z:-5.74819803237915},{x:403.3472442626953,y:229.05112266540527,z:19.689764976501465},{x:372.34840393066406,y:256.6451168060303,z:-21.872329711914062},{x:422.54566192626953,y:289.1587829589844,z:68.67491245269775,name:"faceOval"},{x:371.9297409057617,y:228.90116214752197,z:11.432201862335205,name:"leftEye"},{x:366.21360778808594,y:251.6158962249756,z:-28.19826364517212},{x:409.1571807861328,y:321.3156223297119,z:20.2266526222229},{x:408.52943420410156,y:331.44238471984863,z:31.09278917312622,name:"faceOval"},{x:424.2788314819336,y:267.1992301940918,z:50.467424392700195},{x:415.60352325439453,y:311.6528606414795,z:30.579242706298828},{x:418.12793731689453,y:221.59927368164062,z:46.26569747924805},{x:385.68286895751953,y:346.0184955596924,z:-5.70151150226593},{x:357.82936096191406,y:271.3758373260498,z:-24.836881160736084},{x:379.588623046875,y:257.5071716308594,z:-3.755294680595398},{x:417.4592590332031,y:234.71948146820068,z:34.5475435256958},{x:393.4684371948242,y:231.58967971801758,z:11.408859491348267,name:"leftEye"},{x:387.8864288330078,y:232.14245796203613,z:9.51808214187622,name:"leftEye"},{x:382.4981689453125,y:307.5654888153076,z:-7.522260546684265,name:"lips"},{x:419.00169372558594,y:277.8332805633545,z:26.424202919006348},{x:373.62953186035156,y:357.6375102996826,z:-5.75986921787262,name:"faceOval"},{x:392.8708267211914,y:347.72446632385254,z:10.154176950454712,name:"faceOval"},{x:400.3953552246094,y:341.0005187988281,z:19.39797878265381,name:"faceOval"},{x:382.25440979003906,y:231.66935920715332,z:8.998700976371765,name:"leftEye"},{x:377.14550018310547,y:230.4228687286377,z:9.804032444953918,name:"leftEye"},{x:373.8358688354492,y:229.64950561523438,z:11.292144060134888,name:"leftEye"},{x:414.5794677734375,y:221.67891025543213,z:29.412097930908203},{x:377.00672149658203,y:225.66201210021973,z:9.360517263412476,name:"leftEye"},{x:382.29530334472656,y:224.8431158065796,z:8.32175612449646,name:"leftEye"},{x:387.5133514404297,y:224.49507236480713,z:8.917000889778137,name:"leftEye"},{x:393.15906524658203,y:225.24795055389404,z:10.737749338150024,name:"leftEye"},{x:397.05554962158203,y:226.55359268188477,z:13.002015352249146,name:"leftEye"},{x:420.5299377441406,y:221.014666557312,z:65.40690422058105,name:"faceOval"},{x:397.06920623779297,y:230.6661558151245,z:13.807345628738403,name:"leftEye"},{x:377.94647216796875,y:285.1647090911865,z:-13.305472135543823},{x:372.1118927001953,y:267.1267318725586,z:-18.83774757385254},{x:364.9968719482422,y:282.24411964416504,z:-19.818150997161865},{x:401.973876953125,y:331.20131492614746,z:11.566424369812012},{x:394.3083190917969,y:338.86693954467773,z:3.142542541027069},{x:373.9820861816406,y:351.4504623413086,z:-13.50388765335083},{x:414.3888854980469,y:321.24735832214355,z:45.51872253417969,name:"faceOval"},{x:373.44234466552734,y:227.33163356781006,z:10.626870393753052,name:"leftEye"},{x:364.0731430053711,y:240.31539916992188,z:-13.807345628738403},{x:384.2658233642578,y:353.3793067932129,z:.7385850697755814,name:"faceOval"},{x:423.20526123046875,y:283.5176181793213,z:47.152724266052246},{x:369.42798614501953,y:304.0898895263672,z:-14.647691249847412,name:"lips"},{x:370.63812255859375,y:305.90051651000977,z:-16.211668252944946},{x:371.91192626953125,y:309.0167713165283,z:-17.84567356109619},{x:373.0583953857422,y:313.3545398712158,z:-17.378815412521362,name:"lips"},{x:375.39905548095703,y:321.09289169311523,z:-13.118728399276733},{x:379.2567825317383,y:304.3582534790039,z:-7.924926280975342},{x:381.18797302246094,y:303.7031364440918,z:-7.843226194381714},{x:383.0918502807617,y:302.4884605407715,z:-7.6506465673446655,name:"lips"},{x:389.09461975097656,y:297.1475315093994,z:-5.5497825145721436},{x:411.6408920288086,y:280.24898529052734,z:12.02161192893982},{x:363.3110809326172,y:234.27620887756348,z:-6.775286793708801},{x:366.0474395751953,y:223.29872131347656,z:6.827808618545532},{x:370.34427642822266,y:225.1457118988037,z:9.558931589126587},{x:377.5371551513672,y:303.60079765319824,z:-7.358860373497009,name:"lips"},{x:412.9557800292969,y:299.53579902648926,z:19.39797878265381},{x:360.0810241699219,y:221.72012329101562,z:-2.153385728597641},{x:379.82784271240234,y:329.47723388671875,z:-10.48097848892212},{x:359.08477783203125,y:235.7911491394043,z:-18.079102039337158},{x:369.6688461303711,y:251.5407943725586,z:-14.962821006774902},{x:369.5555114746094,y:333.5307312011719,z:-15.67478060722351},{x:394.0193176269531,y:315.6973171234131,z:-.9920747578144073},{x:383.78997802734375,y:272.7268695831299,z:-4.689012169837952},{x:387.67765045166016,y:323.6722755432129,z:-5.640236139297485},{x:397.8769302368164,y:272.1331214904785,z:-.9395531564950943},{x:389.87476348876953,y:280.5630111694336,z:-4.29218202829361},{x:403.83888244628906,y:285.1167869567871,z:3.0229100584983826},{x:372.5467300415039,y:343.1070327758789,z:-16.153310537338257},{x:374.1112518310547,y:256.3721466064453,z:-10.574349164962769},{x:399.73785400390625,y:321.77515983581543,z:4.849494695663452},{x:392.03365325927734,y:330.56447982788086,z:-1.3407598435878754},{x:398.59134674072266,y:305.93902587890625,z:1.517290621995926},{x:417.95997619628906,y:290.9716987609863,z:26.89105987548828},{x:406.04541778564453,y:307.35154151916504,z:8.666064143180847},{x:420.75328826904297,y:298.40752601623535,z:41.78385257720947},{x:395.4522705078125,y:291.4153575897217,z:-2.1752697229385376},{x:368.6452102661133,y:245.8882999420166,z:-9.453888535499573},{x:370.34900665283203,y:263.56690406799316,z:-26.75100326538086},{x:374.98477935791016,y:266.6126346588135,z:-19.77146625518799},{x:366.99840545654297,y:258.12140464782715,z:-31.372904777526855},{x:371.00616455078125,y:217.63479709625244,z:5.60522198677063},{x:381.30577087402344,y:214.14087295532227,z:4.983716309070587},{x:390.1496124267578,y:213.38221549987793,z:5.593550801277161},{x:397.7696990966797,y:214.3659782409668,z:8.57852816581726},{x:403.1652069091797,y:217.65509605407715,z:13.013685941696167},{x:407.3551940917969,y:230.72525024414062,z:22.444231510162354},{x:424.0876770019531,y:251.7839241027832,z:51.16771221160889},{x:403.50196838378906,y:239.88757610321045,z:15.803166627883911},{x:397.31719970703125,y:241.49806022644043,z:11.233787536621094},{x:388.99425506591797,y:241.4366912841797,z:7.948269248008728},{x:380.7804489135742,y:239.78078842163086,z:6.600214838981628},{x:374.01336669921875,y:237.11946487426758,z:6.349278092384338},{x:369.39125061035156,y:234.35351371765137,z:5.987462401390076},{x:422.9730987548828,y:255.76455116271973,z:76.61150932312012,name:"faceOval"},{x:374.73915100097656,y:269.24214363098145,z:-16.608498096466064},{x:364.61681365966797,y:245.71088790893555,z:-20.02823829650879},{x:365.3834533691406,y:263.34174156188965,z:-32.32996463775635},{x:361.58252716064453,y:267.8273677825928,z:-30.345816612243652},{x:365.37208557128906,y:265.0249671936035,z:-29.178667068481445},{x:372.72605895996094,y:272.05135345458984,z:-14.834434986114502},{x:360.48614501953125,y:268.34827423095703,z:-32.189905643463135},{x:359.9516296386719,y:270.8049201965332,z:-24.650139808654785},{x:369.5049285888672,y:229.01945114135742,z:10.107489824295044},{x:365.5447769165039,y:230.24096488952637,z:5.593550801277161},{x:363.50669860839844,y:230.6208372116089,z:.43622106313705444},{x:399.3529510498047,y:227.65677452087402,z:15.35965085029602,name:"leftEye"},{x:402.5693130493164,y:224.60190296173096,z:15.931552648544312}],box:{xMin:277.8318977355957,yMin:168.7741756439209,xMax:424.2788314819336,yMax:359.8348903656006,width:146.4469337463379,height:191.0607147216797}},SAMPLE_FACELANDMARKER_RESULT:{faceLandmarks:[[{x:.5760777592658997,y:.8639070391654968,z:-.030997956171631813},{x:.572094738483429,y:.7886289358139038,z:-.07189624011516571},{x:.5723551511764526,y:.8075382709503174,z:-.03578168898820877},{x:.5548420548439026,y:.7188365459442139,z:-.057787876576185226},{x:.5706077814102173,y:.7674974799156189,z:-.07740399986505508},{x:.5681378245353699,y:.7387768030166626,z:-.07356284558773041},{x:.5621535181999207,y:.6681165099143982,z:-.04189874976873398},{x:.46613582968711853,y:.6679812073707581,z:.011289681307971478},{x:.5579932928085327,y:.6174106597900391,z:-.03502821549773216},{x:.5563451647758484,y:.5905600190162659,z:-.03928658738732338},{x:.5487832427024841,y:.4900572597980499,z:-.029898937791585922},{x:.5765544176101685,y:.8692144751548767,z:-.02831427752971649},{x:.5771114230155945,y:.873644232749939,z:-.02345779910683632},{x:.5771905779838562,y:.877016007900238,z:-.016658689826726913},{x:.5778058767318726,y:.8770116567611694,z:-.014505492523312569},{x:.5783766508102417,y:.8835000991821289,z:-.015996402129530907},{x:.5792440176010132,y:.8913810849189758,z:-.01924579218029976},{x:.5796768069267273,y:.8996334671974182,z:-.018261712044477463},{x:.5817288160324097,y:.9255813956260681,z:-.007126849144697189},{x:.5726592540740967,y:.7992473244667053,z:-.0643521398305893},{x:.5579419136047363,y:.7996989488601685,z:-.04566684365272522},{x:.4216199815273285,y:.5958762764930725,z:.06776496022939682},{x:.5052269697189331,y:.6796539425849915,z:-.0010737782577052712},{x:.49243026971817017,y:.6838865876197815,z:-.0005227324436418712},{x:.4796970784664154,y:.6856290102005005,z:.002684245817363262},{x:.4618356227874756,y:.6764569878578186,z:.013439622707664967},{x:.5160380601882935,y:.6737282276153564,z:-17607348127057776e-21},{x:.48070961236953735,y:.6255870461463928,z:-.008339674212038517},{x:.49719780683517456,y:.6256808042526245,z:-.008027955889701843},{x:.46674346923828125,y:.6317623853683472,z:-.004460199736058712},{x:.4582492709159851,y:.641118049621582,z:.0011905613355338573},{x:.45408669114112854,y:.6911458969116211,z:.020514748990535736},{x:.535312294960022,y:.9619986414909363,z:.012499462813138962},{x:.4608460068702698,y:.6628725528717041,z:.01517564244568348},{x:.4206731915473938,y:.6828458309173584,z:.07848648726940155},{x:.4390624463558197,y:.6796106696128845,z:.03283142298460007},{x:.5029968619346619,y:.7701570391654968,z:-.009734481573104858},{x:.5595027208328247,y:.8607323169708252,z:-.030043255537748337},{x:.5621269941329956,y:.8738374710083008,z:-.021709579974412918},{x:.5451499819755554,y:.865527331829071,z:-.022014077752828598},{x:.5351184010505676,y:.8705098032951355,z:-.011602800339460373},{x:.5495014190673828,y:.8744956254959106,z:-.016490943729877472},{x:.5395170450210571,y:.8759440779685974,z:-.007333362940698862},{x:.5183624029159546,y:.8959754705429077,z:.010520773939788342},{x:.5604349374771118,y:.7895449995994568,z:-.07082037627696991},{x:.557381272315979,y:.7687489986419678,z:-.07590588927268982},{x:.4432901442050934,y:.6308897733688354,z:.0027153254486620426},{x:.5258325338363647,y:.7151225805282593,z:-.014676518738269806},{x:.5271827578544617,y:.7833116054534912,z:-.037643320858478546},{x:.5257382988929749,y:.7717816233634949,z:-.03401920944452286},{x:.46516409516334534,y:.7705106735229492,z:.0065747760236263275},{x:.5558893084526062,y:.7420997619628906,z:-.0694495290517807},{x:.4720408320426941,y:.6066038608551025,z:-.021204356104135513},{x:.45432573556900024,y:.6158540844917297,z:-.011054684408009052},{x:.4305151402950287,y:.5608053803443909,z:.0396830290555954},{x:.5310865640640259,y:.6157484650611877,z:-.03081176057457924},{x:.5114666223526001,y:.6329749226570129,z:-.00335998204536736},{x:.506435751914978,y:.8786543607711792,z:.012980876490473747},{x:.4480472207069397,y:.8640613555908203,z:.12569651007652283},{x:.5372058153152466,y:.7942581176757812,z:-.03168361634016037},{x:.5488379597663879,y:.8001630306243896,z:-.03280917927622795},{x:.5213388204574585,y:.8794381618499756,z:.011892606504261494},{x:.5242055654525757,y:.8789222240447998,z:.008370225317776203},{x:.4477175176143646,y:.6039950251579285,z:-.0050799972377717495},{x:.526964008808136,y:.7916748523712158,z:-.02968614175915718},{x:.4971255660057068,y:.6050706505775452,z:-.028175678104162216},{x:.4938119053840637,y:.5882453918457031,z:-.03210941329598427},{x:.4757143557071686,y:.5094879865646362,z:-.01300730835646391},{x:.43947282433509827,y:.5816648006439209,z:.01415177434682846},{x:.485664039850235,y:.5477864146232605,z:-.023685332387685776},{x:.43635931611061096,y:.6226438283920288,z:.013606148771941662},{x:.42910251021385193,y:.6102726459503174,z:.03926564007997513},{x:.5605402588844299,y:.8680099248886108,z:-.027318159118294716},{x:.5474816560745239,y:.8702861070632935,z:-.019686367362737656},{x:.5373021364212036,y:.8728838562965393,z:-.010484928265213966},{x:.540735125541687,y:.7979167103767395,z:-.029073253273963928},{x:.5228585004806519,y:.87913578748703,z:.009915109723806381},{x:.530497670173645,y:.8815253973007202,z:.0020524784922599792},{x:.5259912610054016,y:.8790552616119385,z:.007895970717072487},{x:.5433906316757202,y:.7882310748100281,z:-.05121905356645584},{x:.541388213634491,y:.8777219653129578,z:-.00466804439201951},{x:.5515822172164917,y:.8767023086547852,z:-.010475946590304375},{x:.5637003779411316,y:.877059817314148,z:-.015273625031113625},{x:.5640299320220947,y:.9263423085212708,z:-.00658724969252944},{x:.5642300248146057,y:.8993074893951416,z:-.017653480172157288},{x:.5637336373329163,y:.8910360932350159,z:-.01852807030081749},{x:.5637134313583374,y:.8837276697158813,z:-.01482592523097992},{x:.564205527305603,y:.8768964409828186,z:-.01331155002117157},{x:.5419867634773254,y:.8778373599052429,z:-.0037720394320786},{x:.5404468774795532,y:.880696177482605,z:-.005610354244709015},{x:.5392338633537292,y:.8845721483230591,z:-.007352025713771582},{x:.538469672203064,y:.8891173601150513,z:-.005154991988092661},{x:.5189250111579895,y:.8452741503715515,z:-.009755070321261883},{x:.4258975088596344,y:.7662280797958374,z:.1387351155281067},{x:.5725725293159485,y:.8041572570800781,z:-.04583907872438431},{x:.5342061519622803,y:.8785833120346069,z:.002659974154084921},{x:.5324031114578247,y:.8804071545600891,z:.0017832003068178892},{x:.5538818836212158,y:.8078407645225525,z:-.03254539892077446},{x:.5325431823730469,y:.8026832938194275,z:-.019140373915433884},{x:.5514076948165894,y:.8043903112411499,z:-.03313535451889038},{x:.5131856203079224,y:.7284771800041199,z:-.009399853646755219},{x:.49331504106521606,y:.7443980574607849,z:-.005225230939686298},{x:.5239617824554443,y:.7807451486587524,z:-.025881027802824974},{x:.4473606050014496,y:.5315827131271362,z:.011164786294102669},{x:.45718759298324585,y:.5604941248893738,z:-.005943301599472761},{x:.4670005738735199,y:.5909327268600464,z:-.019681761041283607},{x:.5311570167541504,y:.9076261520385742,z:.00389476353302598},{x:.5249923467636108,y:.5893563628196716,z:-.037981919944286346},{x:.5166932344436646,y:.5429551005363464,z:-.03319704160094261},{x:.5085030198097229,y:.49676206707954407,z:-.02691275253891945},{x:.4687720239162445,y:.6834565997123718,z:.008113506250083447},{x:.4426414966583252,y:.7069531679153442,z:.028577271848917007},{x:.5230373740196228,y:.6675713658332825,z:.001773772411979735},{x:.4481240212917328,y:.6527872085571289,z:.012414850294589996},{x:.5339856743812561,y:.7012367844581604,z:-.020220188423991203},{x:.5347223281860352,y:.7761190533638,z:-.05141595005989075},{x:.4315067231655121,y:.7211957573890686,z:.04381405934691429},{x:.45203351974487305,y:.7206180095672607,z:.017288070172071457},{x:.46892452239990234,y:.7265436053276062,z:.005602988880127668},{x:.49314674735069275,y:.7202282547950745,z:-.0006408205372281373},{x:.5104925632476807,y:.7091827392578125,z:-.00362918758764863},{x:.5232142210006714,y:.698553740978241,z:-.00787867046892643},{x:.5497883558273315,y:.6743605136871338,z:-.036349106580019},{x:.43658503890037537,y:.7627100348472595,z:.042555369436740875},{x:.4397648870944977,y:.6528646349906921,z:.017956094816327095},{x:.5653332471847534,y:.7992802858352661,z:-.06365057826042175},{x:.5285563468933105,y:.736810564994812,z:-.018836988136172295},{x:.4180678725242615,y:.6792560815811157,z:.12284679710865021},{x:.5328429937362671,y:.6865872144699097,z:-.010484723374247551},{x:.5230283141136169,y:.7809416055679321,z:-.011922398582100868},{x:.4551771283149719,y:.6650775074958801,z:.01774493046104908},{x:.5337203741073608,y:.7618928551673889,z:-.04697106033563614},{x:.43463975191116333,y:.8133478164672852,z:.1354849934577942},{x:.5225707292556763,y:.6605283617973328,z:.004980515688657761},{x:.5441933870315552,y:.7497199773788452,z:-.06091512367129326},{x:.4774007797241211,y:.9159183502197266,z:.059622734785079956},{x:.48068761825561523,y:.9364941716194153,z:.08404944837093353},{x:.4268292486667633,y:.7657528519630432,z:.09051097184419632},{x:.46051913499832153,y:.8880485892295837,z:.0738474428653717},{x:.4243420660495758,y:.6434382200241089,z:.06230505183339119},{x:.5342157483100891,y:.9835634231567383,z:.021662971004843712},{x:.5668109655380249,y:.8042187094688416,z:-.044937074184417725},{x:.5176341533660889,y:.7530587315559387,z:-.012967454269528389},{x:.430206298828125,y:.6835605502128601,z:.04612284153699875},{x:.4794231951236725,y:.6732114553451538,z:.003970044665038586},{x:.49073347449302673,y:.6722435355186462,z:.0008692514384165406},{x:.5294116139411926,y:.884677529335022,z:.004413890186697245},{x:.4430122375488281,y:.80235356092453,z:.04987282305955887},{x:.5603825449943542,y:1.0092442035675049,z:.026417359709739685},{x:.5186598300933838,y:.9828659892082214,z:.0513598807156086},{x:.5010536909103394,y:.9640932679176331,z:.06591596454381943},{x:.5524769425392151,y:.539441704750061,z:-.035816047340631485},{x:.5879997611045837,y:1.0091472864151,z:.02285068854689598},{x:.5016193985939026,y:.6684437990188599,z:.00028415941051207483},{x:.511952817440033,y:.6642197370529175,z:.0021144719794392586},{x:.5194343328475952,y:.6623469591140747,z:.004674181342124939},{x:.4321230351924896,y:.6496355533599854,z:.03124697133898735},{x:.508686363697052,y:.6479565501213074,z:-.00044765998609364033},{x:.4963986277580261,y:.6431032419204712,z:-.0032507688738405704},{x:.4845542013645172,y:.6430778503417969,z:-.002903624437749386},{x:.4733612537384033,y:.647506833076477,z:.00023347247042693198},{x:.4668654501438141,y:.653346598148346,z:.004762572236359119},{x:.41815051436424255,y:.633708119392395,z:.09809435904026031},{x:.47159942984580994,y:.6711485385894775,z:.007849935442209244},{x:.5734396576881409,y:.8256140351295471,z:-.03155219927430153},{x:.5306524038314819,y:.8337990641593933,z:-.018351426348090172},{x:.5371729135513306,y:.7910830974578857,z:-.037286680191755295},{x:.5549534559249878,y:.8275275826454163,z:-.030664825811982155},{x:.5597432255744934,y:.6418541669845581,z:-.03318847343325615},{x:.4958484172821045,y:.9429569244384766,z:.048340678215026855},{x:.5140507817268372,y:.9634028077125549,z:.03589847311377525},{x:.5587693452835083,y:.9951097369194031,z:.00908728688955307},{x:.46411189436912537,y:.9051855206489563,z:.10601935535669327},{x:.5181609392166138,y:.6554316878318787,z:.002546071307733655},{x:.5436590909957886,y:.7085841298103333,z:-.03844436630606651},{x:.5872187614440918,y:.9960382580757141,z:.0063423276878893375},{x:.5379653573036194,y:.9989125728607178,z:.03636329993605614},{x:.4350326955318451,y:.8088565468788147,z:.09147704392671585},{x:.5523084998130798,y:.8773422837257385,z:-.009068487212061882},{x:.5510149598121643,y:.8816931843757629,z:-.011043853126466274},{x:.5503793954849243,y:.88776695728302,z:-.01348799467086792},{x:.5501549243927002,y:.8954370617866516,z:-.012142189778387547},{x:.546072781085968,y:.9192524552345276,z:-.003157563041895628},{x:.5314661860466003,y:.8771666884422302,z:.0005075141089037061},{x:.5293324589729309,y:.8762547969818115,z:.00039177737198770046},{x:.5275698900222778,y:.8750609755516052,z:47732755774632096e-21},{x:.5104271173477173,y:.8607332110404968,z:.0012934643309563398},{x:.45938700437545776,y:.8134918212890625,z:.023569690063595772},{x:.5418947339057922,y:.6864100694656372,z:-.027333909645676613},{x:.531914234161377,y:.6456130743026733,z:-.005434140563011169},{x:.523697018623352,y:.647885262966156,z:-.0002466466394253075},{x:.5338191390037537,y:.8783687353134155,z:.002268768846988678},{x:.46226605772972107,y:.8610277771949768,z:.04718952998518944},{x:.5434442758560181,y:.6456181406974792,z:-.02327350154519081},{x:.5399754643440247,y:.940219521522522,z:.005075343884527683},{x:.5661457777023315,y:.71457839012146,z:-.06242101639509201},{x:.5523148775100708,y:.6974870562553406,z:-.04863070324063301},{x:.5639959573745728,y:.6923378109931946,z:-.05180761218070984},{x:.5367592573165894,y:.7423217296600342,z:-.03623027727007866},{x:.5853689908981323,y:.9752064943313599,z:-.002361974213272333},{x:.5835235118865967,y:.9493685960769653,z:-.003941743168979883},{x:.5615018606185913,y:.949194610118866,z:-.0015953965485095978},{x:.5068561434745789,y:.9048219323158264,z:.01862684078514576},{x:.5134067535400391,y:.7971825003623962,z:-.008485661819577217},{x:.5223897099494934,y:.925589919090271,z:.01249657291918993},{x:.48500555753707886,y:.7959478497505188,z:-.0032065745908766985},{x:.5037734508514404,y:.8184596300125122,z:-.004932103678584099},{x:.4766361117362976,y:.828806459903717,z:.01027688942849636},{x:.5589827299118042,y:.974656343460083,z:.0009666886180639267},{x:.5294582843780518,y:.7541216611862183,z:-.025603046640753746},{x:.4973002076148987,y:.9208990931510925,z:.031931452453136444},{x:.5163551568984985,y:.9432790875434875,z:.024321340024471283},{x:.49399662017822266,y:.8814862370491028,z:.018687399104237556},{x:.44948166608810425,y:.836137592792511,z:.05702034756541252},{x:.47898444533348083,y:.8836610913276672,z:.03150695189833641},{x:.4454479217529297,y:.8499438166618347,z:.08868525922298431},{x:.49572959542274475,y:.8452823758125305,z:.0036111653316766024},{x:.5362502336502075,y:.7222585678100586,z:-.027912352234125137},{x:.5393770337104797,y:.7850722074508667,z:-.05415399745106697},{x:.531399667263031,y:.7898418307304382,z:-.03883346915245056},{x:.5451627373695374,y:.7717036604881287,z:-.06480253487825394},{x:.5206395983695984,y:.6287745833396912,z:-.010521138086915016},{x:.4974782466888428,y:.6191938519477844,z:-.014098240062594414},{x:.4774145185947418,y:.6193130612373352,z:-.013643337413668633},{x:.4616098403930664,y:.6259890198707581,z:-.008448202162981033},{x:.4516478478908539,y:.6368461847305298,z:9050309745362028e-20},{x:.4485096037387848,y:.6719120740890503,z:.022984720766544342},{x:.42177659273147583,y:.7240667343139648,z:.08511673659086227},{x:.4616215229034424,y:.6988231539726257,z:.014238474890589714},{x:.4755798876285553,y:.7034608721733093,z:.00625590980052948},{x:.4924992024898529,y:.7005885243415833,z:.0009391739731654525},{x:.5082254409790039,y:.693384051322937,z:-.0009464038303121924},{x:.5203112959861755,y:.6849707961082458,z:-.0022114769089967012},{x:.52867591381073,y:.6779075860977173,z:-.002962538506835699},{x:.4213953912258148,y:.7219811677932739,z:.1350894570350647},{x:.5320829749107361,y:.794858992099762,z:-.03181503340601921},{x:.5452795028686523,y:.7286570072174072,z:-.04771539941430092},{x:.5496407747268677,y:.7866933345794678,z:-.06452003121376038},{x:.557040274143219,y:.7962084412574768,z:-.05837344378232956},{x:.549176812171936,y:.7895247936248779,z:-.057761140167713165},{x:.5362890362739563,y:.8005836606025696,z:-.026903774589300156},{x:.560200035572052,y:.7983731031417847,z:-.06172555685043335},{x:.5616944432258606,y:.8022753596305847,z:-.045200999826192856},{x:.5273328423500061,y:.6611284017562866,z:.0029021520167589188},{x:.534850537776947,y:.6660012006759644,z:-.005215510260313749},{x:.5394860506057739,y:.6701375246047974,z:-.014931917190551758},{x:.4634307324886322,y:.658291757106781,z:.009295716881752014},{x:.4538393020629883,y:.6519932150840759,z:.00930330716073513},{x:.5776031613349915,y:.7159298658370972,z:-.057365912944078445},{x:.6504855155944824,y:.6461779475212097,z:.014184834435582161},{x:.5860154032707214,y:.7962266206741333,z:-.04522843658924103},{x:.6842049360275269,y:.5631637573242188,z:.07207967340946198},{x:.6152560710906982,y:.6674962639808655,z:.0007529259892180562},{x:.6280948519706726,y:.6684326529502869,z:.0016892586136236787},{x:.6408625245094299,y:.6663892269134521,z:.005331226624548435},{x:.6557814478874207,y:.6534678936004639,z:.01646413467824459},{x:.6035663485527039,y:.6639701724052429,z:.0013799630105495453},{x:.6329053044319153,y:.608010470867157,z:-.006195899099111557},{x:.6167260408401489,y:.6117533445358276,z:-.006319951266050339},{x:.6471013426780701,y:.6112449765205383,z:-.0017843559617176652},{x:.6560901999473572,y:.6185776591300964,z:.004047257360070944},{x:.6666946411132812,y:.6651176810264587,z:.023647578433156013},{x:.6311345100402832,y:.9495396018028259,z:.014004078693687916},{x:.6544655561447144,y:.6397901773452759,z:.01809609681367874},{x:.6965808868408203,y:.6482675075531006,z:.08304904401302338},{x:.679817259311676,y:.650188148021698,z:.03632688894867897},{x:.6336516737937927,y:.7541458010673523,z:-.007742783520370722},{x:.5921701192855835,y:.8567668199539185,z:-.029399123042821884},{x:.591663658618927,y:.870215654373169,z:-.02103729173541069},{x:.6068367958068848,y:.8584195375442505,z:-.020668085664510727},{x:.6176617741584778,y:.860965371131897,z:-.009790095500648022},{x:.6040634512901306,y:.8686612844467163,z:-.015289564616978168},{x:.6143736839294434,y:.8671170473098755,z:-.005712216719985008},{x:.6373105049133301,y:.8815656900405884,z:.012672550976276398},{x:.5832505822181702,y:.7866312861442566,z:-.07051534950733185},{x:.5836675763130188,y:.7658692598342896,z:-.07566110789775848},{x:.6709531545639038,y:.604898989200592,z:.005951565690338612},{x:.6029891967773438,y:.705652117729187,z:-.013388276100158691},{x:.6131622195243835,y:.7728396058082581,z:-.036248479038476944},{x:.6123163104057312,y:.7612020373344421,z:-.03264721855521202},{x:.6696187853813171,y:.744706928730011,z:.009673702530562878},{x:.5803102254867554,y:.7385968565940857,z:-.0689152330160141},{x:.6404349207878113,y:.5877999663352966,z:-.01929756999015808},{x:.6588467955589294,y:.5929454565048218,z:-.008487257175147533},{x:.6720337867736816,y:.530631422996521,z:.043437421321868896},{x:.584305465221405,y:.6099005341529846,z:-.030301367864012718},{x:.6034283638000488,y:.6217452883720398,z:-.001970183802768588},{x:.6460927724838257,y:.8608663082122803,z:.015541625209152699},{x:.6957815289497375,y:.8326103091239929,z:.13015234470367432},{x:.6043362617492676,y:.7861682772636414,z:-.030476901680231094},{x:.594293475151062,y:.7942103147506714,z:-.032218821346759796},{x:.6324057579040527,y:.8665139675140381,z:.014255806803703308},{x:.6296147704124451,y:.8667733669281006,z:.010388285852968693},{x:.663644552230835,y:.5798642635345459,z:-.0022301070857793093},{x:.6140630841255188,y:.7809288501739502,z:-.02835679054260254},{x:.615908145904541,y:.5921698212623596,z:-.026804860681295395},{x:.617181122303009,y:.5748661756515503,z:-.03060605563223362},{x:.6222207546234131,y:.49137672781944275,z:-.011151673272252083},{x:.6669357419013977,y:.5541607141494751,z:.017466170713305473},{x:.6182981729507446,y:.5320425629615784,z:-.021793590858578682},{x:.6760554313659668,y:.595052182674408,z:.017115700989961624},{x:.6801463961601257,y:.5800720453262329,z:.043127160519361496},{x:.5922210812568665,y:.8644017577171326,z:-.02662893570959568},{x:.6054555177688599,y:.8637874722480774,z:-.018363753333687782},{x:.6161889433860779,y:.8641164898872375,z:-.008808949030935764},{x:.6017249822616577,y:.7901403307914734,z:-.028126630932092667},{x:.631446123123169,y:.8664817810058594,z:.012112865224480629},{x:.6249198913574219,y:.8716511130332947,z:.003882825840264559},{x:.6281915903091431,y:.867301881313324,z:.009891441091895103},{x:.5986843109130859,y:.7813931703567505,z:-.050227612257003784},{x:.6126407384872437,y:.869275689125061,z:-.0031255714129656553},{x:.6027271151542664,y:.8711842894554138,z:-.009324162267148495},{x:.59088134765625,y:.8742044568061829,z:-.014608660712838173},{x:.5984604358673096,y:.9216185212135315,z:-.005981989670544863},{x:.5950398445129395,y:.8964707255363464,z:-.01703473925590515},{x:.5941568613052368,y:.8882410526275635,z:-.017784785479307175},{x:.5928806662559509,y:.8803883194923401,z:-.014153128489851952},{x:.5909661054611206,y:.8748103976249695,z:-.012609979137778282},{x:.6128016710281372,y:.8702545762062073,z:-.0022550546564161777},{x:.6150846481323242,y:.8726804256439209,z:-.00414019962772727},{x:.6173093914985657,y:.8770190477371216,z:-.005970994010567665},{x:.619335412979126,y:.8814800977706909,z:-.0036864024586975574},{x:.6292637586593628,y:.8314558267593384,z:-.007714875973761082},{x:.702275276184082,y:.7320667505264282,z:.1433621346950531},{x:.6204835176467896,y:.8689177632331848,z:.0044869170524179935},{x:.6223508715629578,y:.8704851269721985,z:.00352082890458405},{x:.590448260307312,y:.8029727935791016,z:-.03200828656554222},{x:.6097423434257507,y:.7933741211891174,z:-.018042555078864098},{x:.59229576587677,y:.7993767261505127,z:-.032564569264650345},{x:.6171364188194275,y:.7153720259666443,z:-.007672437466681004},{x:.6389747858047485,y:.726390540599823,z:-.002999067772179842},{x:.6151940226554871,y:.769412100315094,z:-.024427521973848343},{x:.6526776552200317,y:.505868136882782,z:.01412637997418642},{x:.6475822329521179,y:.5375454425811768,z:-.0033899128902703524},{x:.6433356404304504,y:.5714520215988159,z:-.017428796738386154},{x:.626949667930603,y:.8962116837501526,z:.005602736957371235},{x:.5868416428565979,y:.5829002261161804,z:-.03727729618549347},{x:.5877229571342468,y:.5345035791397095,z:-.032396964728832245},{x:.5887066125869751,y:.48655083775520325,z:-.025856535881757736},{x:.6507197618484497,y:.6612282991409302,z:.011114613153040409},{x:.6803066730499268,y:.677992045879364,z:.032125361263751984},{x:.5963194370269775,y:.6598632335662842,z:.002976928371936083},{x:.667536199092865,y:.6274255514144897,z:.015618261881172657},{x:.5930740833282471,y:.6940041780471802,z:-.019217798486351967},{x:.6053346395492554,y:.7676517963409424,z:-.050308309495449066},{x:.6934473514556885,y:.6884298920631409,z:.04794462397694588},{x:.6738007664680481,y:.6934011578559875,z:.020697161555290222},{x:.6588084697723389,y:.7033141851425171,z:.008462334051728249},{x:.6346072554588318,y:.7029502391815186,z:.001542167621664703},{x:.6157816648483276,y:.6966525912284851,z:-.002009218093007803},{x:.6015574336051941,y:.688928484916687,z:-.006588225718587637},{x:.5746836066246033,y:.6711069345474243,z:-.03597589209675789},{x:.6947521567344666,y:.7309479117393494,z:.046707939356565475},{x:.6759101152420044,y:.6249120831489563,z:.021654341369867325},{x:.5794773101806641,y:.7971615195274353,z:-.06339326500892639},{x:.6041849851608276,y:.727514922618866,z:-.017512541264295578},{x:.6968844532966614,y:.6440950036048889,z:.12727996706962585},{x:.5910853147506714,y:.679325520992279,z:-.009497715160250664},{x:.6157375574111938,y:.7695677280426025,z:-.010624290443956852},{x:.6606494784355164,y:.6410489678382874,z:.0208158977329731},{x:.6040687561035156,y:.7531470656394958,z:-.045887019485235214},{x:.7012156248092651,y:.780247151851654,z:.14028730988502502},{x:.595149576663971,y:.6527782678604126,z:.006308757700026035},{x:.5925500392913818,y:.7436665892601013,z:-.060151755809783936},{x:.6780198812484741,y:.8905693888664246,z:.0626060739159584},{x:.676746666431427,y:.9113880395889282,z:.08726003766059875},{x:.7030686140060425,y:.7312687635421753,z:.09529774636030197},{x:.688987135887146,y:.8588417172431946,z:.07752864807844162},{x:.6883691549301147,y:.6109960675239563,z:.06669612973928452},{x:.6358906030654907,y:.9702065587043762,z:.023120900616049767},{x:.5781539678573608,y:.8023634552955627,z:-.044763918966054916},{x:.6170316934585571,y:.7408350706100464,z:-.011375460773706436},{x:.688542366027832,y:.6516284346580505,z:.050206027925014496},{x:.6385149359703064,y:.6540714502334595,z:.006462941411882639},{x:.6279382109642029,y:.6563615798950195,z:.003062846139073372},{x:.6268895268440247,y:.8736732006072998,z:.00627936702221632},{x:.6944946050643921,y:.7709181308746338,z:.053824134171009064},{x:.614617109298706,y:1.0022112131118774,z:.02719894051551819},{x:.6493719220161438,y:.9665167927742004,z:.053563784807920456},{x:.6624587178230286,y:.943530797958374,z:.068605437874794},{x:.6162528991699219,y:.6558693051338196,z:.002187855076044798},{x:.6058168411254883,y:.654328465461731,z:.0036193584091961384},{x:.5987918972969055,y:.6536934971809387,z:.006134530063718557},{x:.6831037402153015,y:.6195642948150635,z:.03511790186166763},{x:.6062582731246948,y:.6356398463249207,z:.001280312892049551},{x:.6174948811531067,y:.62776118516922,z:-.0013642468256875873},{x:.6297246217727661,y:.6253792643547058,z:-.0007034156005829573},{x:.6407091617584229,y:.627578616142273,z:.0028144705574959517},{x:.6479622721672058,y:.6322650909423828,z:.00750273372977972},{x:.6915091276168823,y:.5990704298019409,z:.10270945727825165},{x:.6457163095474243,y:.6504453420639038,z:.010696077719330788},{x:.6164222955703735,y:.8231936097145081,z:-.016772059723734856},{x:.6042401194572449,y:.7830976843833923,z:-.03630910441279411},{x:.5922216773033142,y:.8228387236595154,z:-.029992375522851944},{x:.6646111011505127,y:.92097008228302,z:.050967294722795486},{x:.651232898235321,y:.9460107088088989,z:.038000158965587616},{x:.6140977144241333,y:.9882472157478333,z:.009882091544568539},{x:.6870781183242798,y:.8768675327301025,z:.10980932414531708},{x:.5986856818199158,y:.6456438899040222,z:.003999010659754276},{x:.585981547832489,y:.7034481763839722,z:-.0377722829580307},{x:.6342031359672546,y:.9867448806762695,z:.03786521404981613},{x:.7013950943946838,y:.776049017906189,z:.09598205983638763},{x:.6030206680297852,y:.8719133138656616,z:-.007931148633360863},{x:.6050592064857483,y:.8767156004905701,z:-.009791925549507141},{x:.6073468923568726,y:.8831382393836975,z:-.012361008673906326},{x:.6087977290153503,y:.890143632888794,z:-.01098148338496685},{x:.6147705316543579,y:.9110084772109985,z:-.0018823575228452682},{x:.622577965259552,y:.8670604825019836,z:.002609190298244357},{x:.6241236329078674,y:.8651344180107117,z:.0025534380692988634},{x:.6257084608078003,y:.8638408184051514,z:.0023300074972212315},{x:.639931321144104,y:.8449671268463135,z:.0038123116828501225},{x:.6810906529426575,y:.7856625318527222,z:.02717764675617218},{x:.583532452583313,y:.6811994910240173,z:-.026588857173919678},{x:.5855660438537598,y:.6393819451332092,z:-.004512844607234001},{x:.5932201743125916,y:.6398029327392578,z:.0008020466193556786},{x:.6200879812240601,y:.8683351874351501,z:.00417016725987196},{x:.6842559576034546,y:.8330534100532532,z:.050836317241191864},{x:.5754412412643433,y:.6418221592903137,z:-.022838059812784195},{x:.6232790350914001,y:.9295297265052795,z:.006339520215988159},{x:.5764067769050598,y:.694546639919281,z:-.04825803264975548},{x:.59778892993927,y:.7343927621841431,z:-.035004377365112305},{x:.6042810678482056,y:.9441440105438232,z:-.0010970570147037506},{x:.6496372222900391,y:.8869078159332275,z:.021036235615611076},{x:.6274012327194214,y:.7830310463905334,z:-.006658440921455622},{x:.637792706489563,y:.9104999899864197,z:.014290250837802887},{x:.6549934148788452,y:.7748609185218811,z:-.0006672973395325243},{x:.6404005289077759,y:.801220715045929,z:-.0026642554439604282},{x:.6671456694602966,y:.8045546412467957,z:.013180811889469624},{x:.6107483506202698,y:.9680658578872681,z:.001778992242179811},{x:.6060343980789185,y:.744587242603302,z:-.024382334202528},{x:.6602751612663269,y:.8998945355415344,z:.0344940721988678},{x:.6463775038719177,y:.9262562394142151,z:.02617623284459114},{x:.6579852104187012,y:.8602304458618164,z:.021586716175079346},{x:.6926165223121643,y:.8053340315818787,z:.061075080186128616},{x:.6724731922149658,y:.8594399690628052,z:.03457934781908989},{x:.6975721716880798,y:.8183245062828064,z:.09300774335861206},{x:.6512877941131592,y:.8258221745491028,z:.006324059329926968},{x:.594887375831604,y:.7148372530937195,z:-.026898479089140892},{x:.6017440557479858,y:.7773507833480835,z:-.05312420800328255},{x:.6096571683883667,y:.7806998491287231,z:-.037646256387233734},{x:.5952993035316467,y:.7654367685317993,z:-.06398405134677887},{x:.5950021147727966,y:.6201304793357849,z:-.009297547861933708},{x:.6165438890457153,y:.6052900552749634,z:-.012455573305487633},{x:.6362661719322205,y:.6015968918800354,z:-.011649220250546932},{x:.6522727608680725,y:.6046400666236877,z:-.005903332494199276},{x:.6625409722328186,y:.6128141283988953,z:.0030042496509850025},{x:.6688099503517151,y:.6457712054252625,z:.026322703808546066},{x:.7013440728187561,y:.6893666386604309,z:.08984331786632538},{x:.6608623266220093,y:.6749406456947327,z:.0172116681933403},{x:.6482325196266174,y:.6823726296424866,z:.008881398476660252},{x:.6313265562057495,y:.6842025518417358,z:.0031308617908507586},{x:.6147016286849976,y:.6809731721878052,z:.0007630771724507213},{x:.6018834114074707,y:.6755372285842896,z:-.0008834321051836014},{x:.5925027132034302,y:.670681357383728,z:-.001968748401850462},{x:.700127363204956,y:.6871103644371033,z:.13980500400066376},{x:.6095665693283081,y:.7853189706802368,z:-.03074747882783413},{x:.5880423784255981,y:.7229287028312683,z:-.04691500961780548},{x:.5930182337760925,y:.7811514139175415,z:-.06398335844278336},{x:.5867722034454346,y:.7922660112380981,z:-.05794971063733101},{x:.5933279991149902,y:.7842848896980286,z:-.05714067071676254},{x:.6063535809516907,y:.7920218706130981,z:-.02590685710310936},{x:.5839452743530273,y:.794978141784668,z:-.0615212507545948},{x:.5828126072883606,y:.8000800013542175,z:-.0449722595512867},{x:.5909603834152222,y:.6541213393211365,z:.003991890233010054},{x:.5852181911468506,y:.6602938771247864,z:-.004428438376635313},{x:.5825737714767456,y:.6651063561439514,z:-.014345290139317513},{x:.6517343521118164,y:.6362385153770447,z:.012151890434324741},{x:.6615052819252014,y:.6281577944755554,z:.0123682152479887},{x:.4856873154640198,y:.6568945646286011,z:.000720038078725338},{x:.49988406896591187,y:.6547410488128662,z:.0006949726957827806},{x:.48438939452171326,y:.6392973065376282,z:.000705525919329375},{x:.47143134474754333,y:.6589511632919312,z:.0006980331381782889},{x:.48704618215560913,y:.6752797961235046,z:.0006921177846379578},{x:.6243702173233032,y:.640461802482605,z:-6592126737814397e-20},{x:.6390967965126038,y:.6385173797607422,z:-.00016105435497593135},{x:.6230536699295044,y:.6224825382232666,z:-.00016136496560648084},{x:.6095397472381592,y:.641917884349823,z:-.0001803556369850412},{x:.6250996589660645,y:.6586247682571411,z:-.0001785515050869435}]],faceBlendshapes:[{categories:[{index:0,score:5187174338061595e-21,categoryName:"_neutral",displayName:""},{index:1,score:.24521504342556,categoryName:"browDownLeft",displayName:""},{index:2,score:.1987743377685547,categoryName:"browDownRight",displayName:""},{index:3,score:.013400448486208916,categoryName:"browInnerUp",displayName:""},{index:4,score:.012361560948193073,categoryName:"browOuterUpLeft",displayName:""},{index:5,score:.019305096939206123,categoryName:"browOuterUpRight",displayName:""},{index:6,score:28426356948330067e-21,categoryName:"cheekPuff",displayName:""},{index:7,score:34500112633395474e-23,categoryName:"cheekSquintLeft",displayName:""},{index:8,score:483789051486383e-21,categoryName:"cheekSquintRight",displayName:""},{index:9,score:.07650448381900787,categoryName:"eyeBlinkLeft",displayName:""},{index:10,score:.05070012807846069,categoryName:"eyeBlinkRight",displayName:""},{index:11,score:.13978900015354156,categoryName:"eyeLookDownLeft",displayName:""},{index:12,score:.14198613166809082,categoryName:"eyeLookDownRight",displayName:""},{index:13,score:.2177766114473343,categoryName:"eyeLookInLeft",displayName:""},{index:14,score:.014739357866346836,categoryName:"eyeLookInRight",displayName:""},{index:15,score:.02361512929201126,categoryName:"eyeLookOutLeft",displayName:""},{index:16,score:.19679604470729828,categoryName:"eyeLookOutRight",displayName:""},{index:17,score:.04874616861343384,categoryName:"eyeLookUpLeft",displayName:""},{index:18,score:.049392376095056534,categoryName:"eyeLookUpRight",displayName:""},{index:19,score:.34944331645965576,categoryName:"eyeSquintLeft",displayName:""},{index:20,score:.2939716875553131,categoryName:"eyeSquintRight",displayName:""},{index:21,score:.005955042317509651,categoryName:"eyeWideLeft",displayName:""},{index:22,score:.006776117719709873,categoryName:"eyeWideRight",displayName:""},{index:23,score:16942436559475027e-21,categoryName:"jawForward",displayName:""},{index:24,score:.0045165494084358215,categoryName:"jawLeft",displayName:""},{index:25,score:.07803940027952194,categoryName:"jawOpen",displayName:""},{index:26,score:2090057751047425e-20,categoryName:"jawRight",displayName:""},{index:27,score:.06032035872340202,categoryName:"mouthClose",displayName:""},{index:28,score:.00228882092051208,categoryName:"mouthDimpleLeft",displayName:""},{index:29,score:.00781762320548296,categoryName:"mouthDimpleRight",displayName:""},{index:30,score:.0017093931091949344,categoryName:"mouthFrownLeft",displayName:""},{index:31,score:.0019319106359034777,categoryName:"mouthFrownRight",displayName:""},{index:32,score:8485237776767462e-20,categoryName:"mouthFunnel",displayName:""},{index:33,score:.0009051355300471187,categoryName:"mouthLeft",displayName:""},{index:34,score:.0003630454302765429,categoryName:"mouthLowerDownLeft",displayName:""},{index:35,score:.00017601238505449146,categoryName:"mouthLowerDownRight",displayName:""},{index:36,score:.12865161895751953,categoryName:"mouthPressLeft",displayName:""},{index:37,score:.20137207210063934,categoryName:"mouthPressRight",displayName:""},{index:38,score:.0022203284315764904,categoryName:"mouthPucker",displayName:""},{index:39,score:.0009096377179957926,categoryName:"mouthRight",displayName:""},{index:40,score:.34189721941947937,categoryName:"mouthRollLower",displayName:""},{index:41,score:.11409689486026764,categoryName:"mouthRollUpper",displayName:""},{index:42,score:.17172536253929138,categoryName:"mouthShrugLower",displayName:""},{index:43,score:.004038424696773291,categoryName:"mouthShrugUpper",displayName:""},{index:44,score:.00023205230536404997,categoryName:"mouthSmileLeft",displayName:""},{index:45,score:.00019313619122840464,categoryName:"mouthSmileRight",displayName:""},{index:46,score:.0018571305554360151,categoryName:"mouthStretchLeft",displayName:""},{index:47,score:.0023813238367438316,categoryName:"mouthStretchRight",displayName:""},{index:48,score:24323100660694763e-21,categoryName:"mouthUpperUpLeft",displayName:""},{index:49,score:3161552012898028e-20,categoryName:"mouthUpperUpRight",displayName:""},{index:50,score:108198406678639e-21,categoryName:"noseSneerLeft",displayName:""},{index:51,score:12652527630052646e-22,categoryName:"noseSneerRight",displayName:""}],headIndex:-1,headName:""}],facialTransformationMatrixes:[{rows:4,columns:4,data:[.9947517514228821,.10230544209480286,.0013679931871592999,0,-.10230997204780579,.9947447776794434,.003816320328041911,0,-.000970348424743861,-.0039362297393381596,.9999914169311523,0,2.8888821601867676,-7.808934211730957,-30.52109146118164,1]}]}},v4=g.createContext({}),tE={basePath:"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.17/wasm",options:{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},runningMode:"VIDEO",outputFaceBlendshapes:!0,outputFacialTransformationMatrixes:!0}},_G=g.forwardRef(({basePath:r=tE.basePath,options:e=tE.options,children:t},i)=>{const n=JSON.stringify(e),s=Er(async()=>{const{FilesetResolver:o,FaceLandmarker:a}=await sE(async()=>{const{FilesetResolver:c,FaceLandmarker:u}=await import("./vision_bundle-DX0dWqEa.js");return{FilesetResolver:c,FaceLandmarker:u}},[]),l=await o.forVisionTasks(r);return a.createFromOptions(l,e)},[r,n]);return g.useEffect(()=>()=>{s?.close(),Jh([r,n])},[s,r,n]),g.useImperativeHandle(i,()=>s,[s]),g.createElement(v4.Provider,{value:s},t)});function yO(){return g.useContext(v4)}function iE(r,e){return r.clone().add(e).multiplyScalar(.5)}function aa(r,e,t){const i=r.localToWorld(e);return t.worldToLocal(i)}const E4=g.createContext({}),SG=g.forwardRef(({camera:r,videoTexture:e={start:!0},manualDetect:t=!1,faceLandmarkerResult:i,manualUpdate:n=!1,makeDefault:s,smoothTime:o=.25,offset:a=!0,offsetScalar:l=80,eyes:c=!1,eyesAsOrigin:u=!0,depth:h=.15,debug:f=!1,facemesh:d},m)=>{var A,p;const y=ae(G=>G.scene),v=ae(G=>G.camera),E=ae(G=>G.set),x=ae(G=>G.get),I=r||v,C=g.useRef(null),[_]=g.useState(()=>new gi),[S]=g.useState(()=>new Q),[b]=g.useState(()=>new Q),[T]=g.useState(()=>new Q),[R]=g.useState(()=>new Q),w=g.useCallback(()=>{_.parent=I.parent;const G=C.current;if(G){const{outerRef:F,eyeRightRef:k,eyeLeftRef:Z}=G;if(k.current&&Z.current){const{irisDirRef:ne}=k.current,{irisDirRef:X}=Z.current;ne.current&&X.current&&F.current&&(S.copy(aa(ne.current,new Q(0,0,0),F.current)),b.copy(aa(X.current,new Q(0,0,0),F.current)),_.position.copy(aa(F.current,iE(S,b),I.parent||y)),T.copy(aa(ne.current,new Q(0,0,1),F.current)),R.copy(aa(X.current,new Q(0,0,1),F.current)),_.lookAt(F.current.localToWorld(iE(T,R))))}else F.current&&(_.position.copy(aa(F.current,new Q(0,0,0),I.parent||y)),_.lookAt(F.current.localToWorld(new Q(0,0,1))))}return _},[I,b,R,S,T,y,_]),[B]=g.useState(()=>new gi),M=g.useCallback(function(G,F){if(I){var k;(k=F)!==null&&k!==void 0||(F=w()),o>0?(Da.damp3(B.position,F.position,o,G,void 0,void 0,1e-9),Da.dampE(B.rotation,F.rotation,o,G,void 0,void 0,1e-9)):(B.position.copy(F.position),B.rotation.copy(F.rotation)),I.position.copy(B.position),I.rotation.copy(B.rotation)}},[I,w,o,B.position,B.rotation]);Ve((G,F)=>{n||M(F)});const O=g.useRef(null),[U,Y]=g.useState(),W=yO(),N=g.useCallback((G,F)=>{const k=O.current;if(!k)return;const Z=k.source.data,ne=W?.detectForVideo(Z,G);Y(ne)},[W]),K=g.useMemo(()=>Object.assign(Object.create(S_.prototype),{computeTarget:w,update:M,facemeshApiRef:C}),[w,M]);g.useImperativeHandle(m,()=>K,[K]),g.useEffect(()=>{if(s){const G=x().controls;return E({controls:K}),()=>E({controls:G})}},[s,K,x,E]);const D=i??U,z=D?.faceLandmarks[0],$=D==null||(A=D.facialTransformationMatrixes)==null?void 0:A[0],V=D==null||(p=D.faceBlendshapes)==null?void 0:p[0],P={onVideoFrame:N,...e};return g.createElement(E4.Provider,{value:K},!t&&g.createElement(g.Suspense,{fallback:null},"src"in P?g.createElement(cp,Ae({ref:O},P)):g.createElement(dO,Ae({ref:O},P))),g.createElement(gO,Ae({ref:C,children:g.createElement("meshNormalMaterial",{side:bi})},d,{points:z,depth:h,facialTransformationMatrix:$,faceBlendshapes:V,eyes:c,eyesAsOrigin:u,offset:a,offsetScalar:l,debug:f,"rotation-z":Math.PI,visible:f})))}),TG=()=>g.useContext(E4);export{YF as AccumulativeShadows,dG as AdaptiveDpr,mG as AdaptiveEvents,TU as ArcballControls,pU as AsciiRenderer,eN as BBAnchor,VN as Backdrop,hG as BakeShadows,R8 as Billboard,SF as Bounds,vN as Box,qU as Bvh,RU as CameraControls,QN as CameraShake,kN as Capsule,qO as CatmullRomLine,$N as Caustics,KC as Center,EN as Circle,Mh as Clone,ZN as Cloud,gv as CloudInstance,hk as Clouds,cU as ComputedAttribute,xN as Cone,HF as ContactShadows,EU as CubeCamera,kU as CubeTexture,jO as CubicBezierLine,lN as CurveModifier,IO as CycleRaycast,IN as Cylinder,dU as Decal,cG as Detailed,WU as DetectGPU,xU as DeviceOrientationControls,LN as Dodecahedron,bO as DragControls,QB as Edges,tU as Effects,zF as Environment,s4 as EnvironmentCube,Cp as EnvironmentMap,GF as EnvironmentPortal,iN as Example,PN as Extrude,SG as FaceControls,_G as FaceLandmarker,tE as FaceLandmarkerDefaults,gO as Facemesh,N0 as FacemeshDatas,eE as FacemeshEye,Ul as FacemeshEyeDefaults,yU as Fbo,OU as Fbx,BU as FirstPersonControls,vG as Fisheye,zN as Float,IU as FlyControls,MU as GizmoHelper,LU as GizmoViewcube,PU as GizmoViewport,AU as Gltf,iU as GradientTexture,Z1 as GradientType,FU as Grid,QU as Helper,Zh as Html,v9 as Hud,DN as Icosahedron,rU as Image,mp as Instance,rN as InstancedAttribute,Ap as Instances,Zl as IsObject,DO as KeyboardControls,UU as Ktx2,FN as Lathe,qN as Lightformer,Ws as Line,SO as Loader,CU as MapControls,hU as MarchingCube,uU as MarchingCubes,fU as MarchingPlane,gG as Mask,tG as MatcapTexture,nN as Merged,AN as MeshDiscardMaterial,cN as MeshDistortMaterial,EG as MeshPortalMaterial,fN as MeshReflectorMaterial,dN as MeshRefractionMaterial,mN as MeshTransmissionMaterial,uN as MeshWobbleMaterial,DU as MotionPathControls,pN as MultiMaterial,iG as NormalTexture,MN as Octahedron,_U as OrbitControls,c9 as OrthographicCamera,oU as Outlines,AG as PerformanceMonitor,vU as PerspectiveCamera,IG as PivotControls,_N as Plane,rG as Point,gN as PointMaterial,vF as PointMaterialImpl,wU as PointerLockControls,oG as Points,Pk as PointsBuffer,RN as Polyhedron,lF as PositionMesh,Mk as PositionPoint,XO as PositionalAudio,uG as Preload,RO as PresentationControls,_O as Progress,WO as QuadraticBezierLine,WF as RandomizedLight,YN as Reflector,Uk as RenderCubeTexture,kk as RenderTexture,GN as Resize,BN as Ring,UN as RoundedBox,lU as Sampler,NN as ScreenQuad,YO as ScreenSizer,$O as ScreenSpace,CG as ScreenVideoTexture,BO as Scroll,wO as ScrollControls,lG as Segment,Fk as SegmentObject,aG as Segments,VO as Select,KN as Shadow,sG as ShadowAlpha,ON as Shape,XN as Sky,yN as SoftShadows,eG as Sparkles,CN as Sphere,gU as Splat,jN as SpotLight,WN as SpotLightShadow,aN as SpriteAnimator,HN as Stage,JN as Stars,zU as Stats,HU as StatsGl,mU as Svg,wN as Tetrahedron,ZO as Text,OB as Text3D,sU as Texture,TN as Torus,bN as TorusKnot,SU as TrackballControls,aU as Trail,tN as TrailTexture,bU as TransformControls,SN as Tube,cp as VideoTexture,xG as View,dO as WebcamVideoTexture,nG as Wireframe,r4 as accumulativeContext,ak as calcPosFromAngles,MA as calculateScaleFactor,xL as checkIfFrameIsEmpty,sN as createInstances,Ah as getFirstFrame,eU as isWebGL2Available,fG as meshBounds,ws as shaderMaterial,JU as useAnimations,KU as useAspect,jU as useBVH,TF as useBounds,ZU as useBoxProjectedEnv,$U as useCamera,XU as useContextBridge,h9 as useCubeCamera,Gx as useCubeTexture,CO as useCursor,VU as useDepthBuffer,PL as useDetectGPU,Tf as useEnvironment,In as useFBO,OA as useFBX,TG as useFaceControls,yO as useFaceLandmarker,PA as useFont,df as useGLTF,kA as useGizmoContext,RC as useHelper,jP as useIntersect,UA as useKTX2,MO as useKeyboardControls,yG as useMask,gk as useMatcapTexture,p9 as useMotion,Ek as useNormalTexture,pG as usePerformanceMonitor,ME as useProgress,JE as useScroll,KO as useSelect,oN as useSpriteAnimator,up as useSpriteLoader,ZB as useSurfaceSampler,Io as useTexture,JB as useTrail,sF as useTrailTexture,vL as useVideoTexture};
